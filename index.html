
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RankForge Pro 9.0 â€” SEO Automation Suite</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
/* ScrapeBox aesthetic: Windows XP/7 era dark desktop app */
:root {
  --win-bg: #1a1a1a;
  --win-panel: #242424;
  --win-panel2: #2c2c2c;
  --win-panel3: #333333;
  --win-border: #404040;
  --win-border2: #555555;
  --win-border-hi: #666666;
  --win-titlebar: linear-gradient(180deg, #3a3a3a 0%, #252525 100%);
  --win-btn: linear-gradient(180deg, #3d3d3d 0%, #2a2a2a 100%);
  --win-btn-hover: linear-gradient(180deg, #4a4a4a 0%, #333333 100%);
  --win-btn-active: linear-gradient(180deg, #222222 0%, #333333 100%);
  --green: #39d353;
  --green2: #2ab040;
  --green-dim: #1d6b28;
  --green-glow: rgba(57,211,83,.12);
  --red: #e05252;
  --yellow: #e8b84b;
  --blue: #4a9ede;
  --orange: #e07a30;
  --purple: #9b72d8;
  --cyan: #3ecfcf;
  --text: #d4d4d4;
  --text2: #aaaaaa;
  --text3: #777777;
  --text-hi: #ffffff;
  --sel-bg: #2d5a87;
  --mono: 'Courier New', Courier, monospace;
  --ui: Tahoma, 'Segoe UI', Arial, sans-serif;
  --nav-w: 188px;
  --log-w: 260px;
  --topbar-h: 26px;
  --menubar-h: 22px;
  --toolbar-h: 36px;
  --statusbar-h: 22px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
body{font-family:var(--ui);font-size:11px;background:var(--win-bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden;line-height:1.3}

/* â”â”â”â”â”â”â”â”â”â” TITLE BAR â”â”â”â”â”â”â”â”â”â” */
#titlebar{
  height:var(--topbar-h);background:linear-gradient(180deg,#2a6a2a 0%,#1a4a1a 50%,#0e3a0e 100%);
  display:flex;align-items:center;padding:0 8px;flex-shrink:0;
  border-bottom:1px solid #0a2a0a;user-select:none;
}
.tb-icon{width:16px;height:16px;margin-right:6px;flex-shrink:0;background:var(--green);border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:9px}
.tb-title{font-size:11px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.8)}
.tb-subtitle{font-size:10px;color:rgba(255,255,255,.55);margin-left:8px}
.tb-winbtn{margin-left:auto;display:flex;gap:2px}
.tb-winbtn span{width:14px;height:14px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:9px;cursor:pointer;font-weight:700}
.tb-min{background:#5a5a00;color:#eeee00}.tb-max{background:#003a00;color:#00ee00}.tb-cls{background:#5a0000;color:#ee0000}
.tb-min:hover{background:#8a8a00}.tb-max:hover{background:#005a00}.tb-cls:hover{background:#8a0000}

/* â”â”â”â”â”â”â”â”â”â” MENU BAR â”â”â”â”â”â”â”â”â”â” */
#menubar{
  height:var(--menubar-h);background:var(--win-panel);border-bottom:1px solid var(--win-border);
  display:flex;align-items:center;padding:0 4px;flex-shrink:0;user-select:none;
}
.mi{padding:2px 8px;font-size:11px;color:var(--text2);cursor:pointer;border-radius:2px;border:1px solid transparent}
.mi:hover{background:var(--sel-bg);color:#fff;border-color:var(--blue)}
.mi-sep{width:1px;height:14px;background:var(--win-border2);margin:0 2px}
.mi-right{margin-left:auto;display:flex;align-items:center;gap:6px}
.pulsedot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);animation:pdot 2s infinite}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
.ver-tag{font-family:var(--mono);font-size:9px;color:var(--text3);background:var(--win-panel2);border:1px solid var(--win-border);padding:1px 5px;border-radius:2px}
.global-status{font-family:var(--mono);font-size:10px;color:var(--green);font-weight:700}

/* â”â”â”â”â”â”â”â”â”â” LAYOUT â”â”â”â”â”â”â”â”â”â” */
#app-body{display:flex;flex:1;overflow:hidden}

/* â”â”â”â”â”â”â”â”â”â” SIDEBAR / TREEVIEW â”â”â”â”â”â”â”â”â”â” */
#sidebar{
  width:var(--nav-w);background:var(--win-panel);border-right:2px solid var(--win-border);
  display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;
}
#sidebar::-webkit-scrollbar{width:8px;background:var(--win-panel2)}
#sidebar::-webkit-scrollbar-thumb{background:var(--win-border2);border:1px solid var(--win-border)}
#sidebar::-webkit-scrollbar-thumb:hover{background:var(--win-border-hi)}

.nav-group{padding:4px 0 0}
.nav-group-lbl{
  padding:3px 8px 3px 6px;font-size:10px;font-weight:700;color:var(--text3);
  background:linear-gradient(90deg,var(--win-panel2),var(--win-panel));
  border-top:1px solid var(--win-border);border-bottom:1px solid #1a1a1a;
  letter-spacing:.04em;text-transform:uppercase;display:flex;align-items:center;gap:4px;
}
.nav-group-lbl::before{content:'â–¶';font-size:7px;color:var(--green-dim)}
.nav-item{
  display:flex;align-items:center;gap:6px;padding:4px 6px 4px 14px;
  cursor:pointer;color:var(--text2);font-size:11px;border-bottom:1px solid #1e1e1e;
  border-left:3px solid transparent;white-space:nowrap;transition:none;
}
.nav-item:hover{background:var(--win-panel3);color:var(--text)}
.nav-item.active{
  background:var(--sel-bg);color:#fff;border-left-color:var(--green);
}
.nav-item .ni{width:14px;text-align:center;flex-shrink:0;font-size:11px}
.nav-badge{margin-left:auto;font-family:var(--mono);font-size:8px;padding:1px 4px;border-radius:2px;font-weight:700;background:var(--green-dim);color:var(--green)}
.sidebar-footer{margin-top:auto;border-top:2px solid var(--win-border);padding:6px}
.thread-box{background:var(--win-panel2);border:1px solid var(--win-border2);padding:6px 8px;border-radius:2px}
.thread-lbl{font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:4px;display:flex;justify-content:space-between;align-items:center}
.thread-lbl span{color:var(--yellow);font-weight:700;font-size:11px}
input[type=range]{width:100%;cursor:pointer;height:4px;accent-color:var(--green)}

/* â”â”â”â”â”â”â”â”â”â” MAIN â”â”â”â”â”â”â”â”â”â” */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”â”â”â”â”â”â”â”â”â” TOOLBAR â”â”â”â”â”â”â”â”â”â” */
#toolbar{
  height:var(--toolbar-h);background:var(--win-panel);border-bottom:2px solid var(--win-border);
  display:flex;align-items:center;padding:0 6px;gap:3px;flex-shrink:0;
}
.tbtn{
  display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:2px;
  font-family:var(--ui);font-size:11px;font-weight:700;cursor:pointer;
  border:1px solid var(--win-border2);background:var(--win-btn);color:var(--text2);
  transition:background .08s;white-space:nowrap;user-select:none;
}
.tbtn:hover{background:var(--win-btn-hover);color:var(--text-hi);border-color:var(--win-border-hi)}
.tbtn:active{background:var(--win-btn-active);transform:translateY(1px)}
.tbtn.go{background:linear-gradient(180deg,#2d7a2d,#1a5a1a);color:#7dff7d;border-color:#1a5a1a}
.tbtn.go:hover{background:linear-gradient(180deg,#3a8a3a,#226022)}
.tbtn.stop{background:linear-gradient(180deg,#7a2020,#5a1010);color:#ff8080;border-color:#5a1010}
.tbtn.stop:hover{background:linear-gradient(180deg,#8a2828,#6a1818)}
.tbtn:disabled{opacity:.35;cursor:not-allowed}
.tb-sep{width:1px;height:24px;background:var(--win-border2);margin:0 3px}
.tb-grp{display:flex;align-items:center;gap:3px;padding:0 4px;border:1px solid var(--win-border);border-radius:2px;background:rgba(0,0,0,.15)}
.tb-lbl{font-size:10px;color:var(--text3);margin-right:-2px;padding:0 3px}
.tb-prog-area{margin-left:auto;display:flex;align-items:center;gap:6px}
#prog-bar-wrap{width:180px;height:14px;background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px;overflow:hidden;position:relative}
#prog-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--green-dim),var(--green));transition:width .2s;position:relative}
#prog-bar::after{content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent,transparent 6px,rgba(255,255,255,.05) 6px,rgba(255,255,255,.05) 12px)}
#prog-text{font-family:var(--mono);font-size:10px;color:var(--text3);min-width:60px;text-align:right}

/* â”â”â”â”â”â”â”â”â”â” WORKSPACE â”â”â”â”â”â”â”â”â”â” */
#workspace{flex:1;display:flex;overflow:hidden}
#page-area{flex:1;overflow-y:auto;padding:10px;background:var(--win-bg)}
#page-area::-webkit-scrollbar{width:10px;background:var(--win-panel2)}
#page-area::-webkit-scrollbar-thumb{background:var(--win-border2);border:1px solid var(--win-border)}
#page-area::-webkit-scrollbar-thumb:hover{background:var(--win-border-hi)}

/* â”â”â”â”â”â”â”â”â”â” LOG PANEL â”â”â”â”â”â”â”â”â”â” */
#log-panel{
  width:var(--log-w);border-left:2px solid var(--win-border);
  background:var(--win-panel);display:flex;flex-direction:column;flex-shrink:0;
}
#log-header{
  padding:4px 8px;border-bottom:1px solid var(--win-border);
  display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:10px;
  color:var(--text2);background:var(--win-panel2);
}
#log-body{
  flex:1;overflow-y:auto;padding:4px;font-family:var(--mono);font-size:10px;line-height:1.6;
  background:#111111;
}
#log-body::-webkit-scrollbar{width:8px;background:#111}
#log-body::-webkit-scrollbar-thumb{background:var(--win-border)}
.log-line{display:flex;gap:5px;padding:0}
.log-time{color:#444;flex-shrink:0;font-size:9px;padding-top:1px}
.log-ok{color:var(--green)}
.log-err{color:var(--red)}
.log-warn{color:var(--yellow)}
.log-info{color:var(--cyan)}
#log-footer{padding:4px 8px;border-top:1px solid var(--win-border);display:flex;justify-content:space-between;align-items:center;background:var(--win-panel2)}

/* â”â”â”â”â”â”â”â”â”â” STATUS BAR â”â”â”â”â”â”â”â”â”â” */
#statusbar{
  height:var(--statusbar-h);background:var(--win-panel);border-top:2px solid var(--win-border);
  display:flex;align-items:center;padding:0;flex-shrink:0;
}
.sb-seg{display:flex;align-items:center;gap:4px;padding:0 10px;height:100%;border-right:1px solid var(--win-border);font-size:10px;color:var(--text3)}
.sb-seg:last-child{border-right:none;margin-left:auto}
.sb-val{color:var(--text);font-family:var(--mono);font-weight:700}
.sb-val.g{color:var(--green)}.sb-val.r{color:var(--red)}.sb-val.y{color:var(--yellow)}

/* â”â”â”â”â”â”â”â”â”â” PANELS â”â”â”â”â”â”â”â”â”â” */
.panel{
  background:var(--win-panel);border:1px solid var(--win-border2);
  border-radius:2px;margin-bottom:8px;overflow:hidden;
}
.panel-head{
  padding:5px 10px;border-bottom:1px solid var(--win-border2);
  display:flex;align-items:center;gap:6px;
  background:linear-gradient(180deg,var(--win-panel3),var(--win-panel2));
  font-size:11px;font-weight:700;color:var(--text);user-select:none;
}
.panel-head .ph-r{margin-left:auto;display:flex;gap:4px;align-items:center}
.panel-body{padding:10px}

/* â”â”â”â”â”â”â”â”â”â” FORMS â”â”â”â”â”â”â”â”â”â” */
.fg{margin-bottom:8px}
.lbl{display:block;font-size:10px;font-weight:700;color:var(--text3);margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em}
input[type=text],input[type=url],input[type=number],input[type=email],input[type=password],select,textarea{
  width:100%;padding:4px 7px;border:1px solid var(--win-border2);border-radius:2px;
  font-family:var(--ui);font-size:11px;background:var(--win-panel2);color:var(--text);outline:none;
  transition:border-color .1s;
}
input:focus,select:focus,textarea:focus{border-color:var(--green);box-shadow:inset 0 0 0 1px rgba(57,211,83,.15)}
textarea{resize:vertical;min-height:60px;font-family:var(--mono);font-size:10px;line-height:1.6;background:#111}
select option{background:var(--win-panel2)}
input[type=checkbox]{width:auto!important;accent-color:var(--green)}

/* â”â”â”â”â”â”â”â”â”â” TABLES â”â”â”â”â”â”â”â”â”â” */
.tbl-wrap{overflow-x:auto;border:1px solid var(--win-border);border-radius:2px}
table{width:100%;border-collapse:collapse;font-size:10px}
th{
  text-align:left;padding:5px 8px;font-size:9px;font-weight:700;color:var(--text3);
  background:var(--win-panel2);border-bottom:1px solid var(--win-border2);
  text-transform:uppercase;letter-spacing:.05em;white-space:nowrap;
}
td{padding:4px 8px;border-bottom:1px solid #1e1e1e;color:var(--text2);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:nth-child(even) td{background:rgba(255,255,255,.02)}
tr:hover td{background:rgba(45,90,135,.3)}

/* â”â”â”â”â”â”â”â”â”â” BADGES â”â”â”â”â”â”â”â”â”â” */
.badge{font-family:var(--mono);font-size:9px;font-weight:700;padding:1px 5px;border-radius:2px;display:inline-block;white-space:nowrap}
.bg{background:#0a2a0a;color:var(--green);border:1px solid var(--green-dim)}
.br{background:#2a0a0a;color:var(--red);border:1px solid #5a1a1a}
.by{background:#2a1e00;color:var(--yellow);border:1px solid #5a4a00}
.bb{background:#0a1a2a;color:var(--blue);border:1px solid #1a3a5a}
.bp{background:#1a0a2a;color:var(--purple);border:1px solid #3a1a5a}
.bo{background:#2a1000;color:var(--orange);border:1px solid #5a2a00}
.bgray{background:var(--win-panel2);color:var(--text3);border:1px solid var(--win-border)}

/* â”â”â”â”â”â”â”â”â”â” GRIDS â”â”â”â”â”â”â”â”â”â” */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.g5{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
@media(max-width:1100px){.g5{grid-template-columns:repeat(3,1fr)}.g4{grid-template-columns:repeat(2,1fr)}}

/* â”â”â”â”â”â”â”â”â”â” STAT CARDS â”â”â”â”â”â”â”â”â”â” */
.stat{
  background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px;
  padding:10px 12px;position:relative;overflow:hidden;
}
.stat::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent-c,var(--green))}
.stat-v{font-family:var(--mono);font-size:22px;font-weight:700;line-height:1;margin-bottom:3px}
.stat-l{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em}
.sv-g{color:var(--green);--accent-c:var(--green)}
.sv-r{color:var(--red);--accent-c:var(--red)}
.sv-y{color:var(--yellow);--accent-c:var(--yellow)}
.sv-b{color:var(--blue);--accent-c:var(--blue)}
.sv-p{color:var(--purple);--accent-c:var(--purple)}
.sv-o{color:var(--orange);--accent-c:var(--orange)}

/* â”â”â”â”â”â”â”â”â”â” PROGRESS â”â”â”â”â”â”â”â”â”â” */
.prog-wrap{background:var(--win-panel2);border:1px solid var(--win-border2);height:8px;overflow:hidden;margin-top:6px;border-radius:2px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--green-dim),var(--green));transition:width .2s;border-radius:1px}

/* â”â”â”â”â”â”â”â”â”â” NOTICES â”â”â”â”â”â”â”â”â”â” */
.notice{padding:6px 10px;border-radius:2px;font-size:10px;line-height:1.5;border:1px solid;margin-bottom:6px;font-family:var(--mono)}
.ni-g{background:rgba(57,211,83,.04);border-color:rgba(57,211,83,.2);color:var(--green)}
.ni-y{background:rgba(232,184,75,.04);border-color:rgba(232,184,75,.2);color:var(--yellow)}
.ni-r{background:rgba(224,82,82,.04);border-color:rgba(224,82,82,.2);color:var(--red)}
.ni-b{background:rgba(74,158,222,.04);border-color:rgba(74,158,222,.2);color:var(--blue)}

/* â”â”â”â”â”â”â”â”â”â” CHIPS â”â”â”â”â”â”â”â”â”â” */
.chip{display:inline-flex;align-items:center;padding:2px 7px;border-radius:2px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--win-border2);background:var(--win-panel2);color:var(--text3);user-select:none;font-family:var(--mono)}
.chip.on{background:#0a2a0a;color:var(--green);border-color:var(--green-dim)}

/* â”â”â”â”â”â”â”â”â”â” MISC â”â”â”â”â”â”â”â”â”â” */
.flex{display:flex}.aic{align-items:center}.jb{justify-content:space-between}.g6{gap:6px}.g8{gap:8px}.mt6{margin-top:6px}.mt8{margin-top:8px}.mt10{margin-top:10px}
.mono{font-family:var(--mono)}.tm{color:var(--text3)}.xs{font-size:10px}
a{color:var(--blue);text-decoration:none}a:hover{text-decoration:underline}
.page{display:none}.page.active{display:block}
.list-stats{display:flex;flex-wrap:wrap;gap:10px;padding:4px 8px;background:var(--win-panel2);border:1px solid var(--win-border);font-family:var(--mono);font-size:9px;color:var(--text3);margin-top:4px;border-radius:2px}
.list-stats span{color:var(--text2);font-weight:700}
#url-list-ta{font-family:var(--mono);font-size:10px;line-height:1.6;min-height:200px;width:100%}

/* â”â”â”â”â”â”â”â”â”â” HELP SYSTEM â”â”â”â”â”â”â”â”â”â” */
/* Quick Tips Bar â€” inline collapsible at top of each section */
.help-tips-bar {
  background: linear-gradient(135deg, rgba(57,211,83,.06) 0%, rgba(74,158,222,.06) 100%);
  border: 1px solid rgba(57,211,83,.2);
  border-radius: 2px;
  margin-bottom: 8px;
  overflow: hidden;
  transition: all .15s ease;
}
.help-tips-bar.collapsed .help-tips-body { display: none; }
.help-tips-header {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 10px; cursor: pointer; user-select: none;
  font-size: 10px; font-weight: 700; color: var(--cyan);
  background: linear-gradient(90deg, rgba(57,211,83,.05), transparent);
}
.help-tips-header:hover { background: rgba(57,211,83,.08); }
.help-tips-toggle { margin-left: auto; font-size: 9px; color: var(--text3); }
.help-tips-body {
  padding: 8px 10px 10px;
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 6px;
}
.help-tip {
  display: flex; gap: 7px; align-items: flex-start;
  font-size: 10px; color: var(--text2); line-height: 1.5;
}
.help-tip-icon { flex-shrink: 0; font-size: 12px; margin-top: 1px; }
.help-tip strong { color: var(--text); }

/* Help button on panel headers */
.ph-help {
  display: inline-flex; align-items: center; justify-content: center;
  width: 16px; height: 16px; border-radius: 50%;
  background: rgba(74,158,222,.15); border: 1px solid rgba(74,158,222,.3);
  color: var(--blue); font-size: 9px; font-weight: 700;
  cursor: pointer; user-select: none; flex-shrink: 0;
  transition: background .1s;
}
.ph-help:hover { background: rgba(74,158,222,.3); color: #fff; }

/* Help Drawer (slides in from right side of page-area) */
#help-drawer {
  position: fixed; top: 0; right: -360px; bottom: 0; width: 340px;
  background: var(--win-panel); border-left: 2px solid var(--win-border2);
  display: flex; flex-direction: column; z-index: 9999;
  transition: right .2s cubic-bezier(.4,0,.2,1);
  box-shadow: -6px 0 24px rgba(0,0,0,.5);
}
#help-drawer.open { right: 0; }
#help-drawer-header {
  padding: 8px 12px; background: linear-gradient(90deg, #0d3a2a, #0d2a3a);
  border-bottom: 1px solid var(--win-border2);
  display: flex; align-items: center; gap: 8px; flex-shrink: 0;
}
#help-drawer-title { font-size: 12px; font-weight: 700; color: #fff; }
#help-drawer-close {
  margin-left: auto; width: 20px; height: 20px; border-radius: 2px;
  background: #5a0000; color: #ee0000; display: flex; align-items: center;
  justify-content: center; cursor: pointer; font-size: 10px; font-weight: 700;
  border: 1px solid #3a0000;
}
#help-drawer-close:hover { background: #8a0000; }
#help-drawer-body {
  flex: 1; overflow-y: auto; padding: 12px;
  font-size: 11px; color: var(--text2); line-height: 1.6;
}
#help-drawer-body::-webkit-scrollbar { width: 8px; background: var(--win-panel2); }
#help-drawer-body::-webkit-scrollbar-thumb { background: var(--win-border2); }
.hd-section { margin-bottom: 14px; }
.hd-section-title {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .06em; color: var(--cyan); margin-bottom: 6px;
  padding-bottom: 4px; border-bottom: 1px solid var(--win-border);
}
.hd-item {
  display: flex; gap: 8px; margin-bottom: 8px;
  padding: 6px 8px; background: var(--win-panel2);
  border-radius: 2px; border-left: 3px solid var(--green-dim);
}
.hd-item.warn { border-left-color: #5a4a00; }
.hd-item.info { border-left-color: #1a3a5a; }
.hd-item-icon { font-size: 14px; flex-shrink: 0; }
.hd-item-text strong { color: var(--text); display: block; margin-bottom: 2px; font-size: 10px; }
.hd-item-text span { font-size: 10px; }
.hd-shortcut-grid { display: grid; grid-template-columns: auto 1fr; gap: 3px 10px; }
.hd-kbd {
  font-family: var(--mono); font-size: 9px; padding: 1px 5px;
  background: #1a1a1a; border: 1px solid var(--win-border2);
  border-radius: 2px; color: var(--yellow); white-space: nowrap;
  display: inline-block;
}

/* Workflow indicator â€” step badges at top of section */
.help-workflow {
  display: flex; align-items: center; gap: 0;
  margin-bottom: 8px; flex-wrap: wrap;
}
.help-wf-step {
  display: flex; align-items: center; gap: 6px;
  background: var(--win-panel2); border: 1px solid var(--win-border2);
  padding: 4px 10px; font-size: 10px; color: var(--text2);
  position: relative;
}
.help-wf-step:not(:last-child)::after {
  content: 'â–¶'; color: var(--green-dim); font-size: 8px;
  margin-left: 6px;
}
.help-wf-step .wf-num {
  width: 16px; height: 16px; border-radius: 50%;
  background: var(--green-dim); color: var(--green);
  font-family: var(--mono); font-size: 9px; font-weight: 700;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.help-wf-step:first-child { border-radius: 2px 0 0 2px; }
.help-wf-step:last-child { border-radius: 0 2px 2px 0; border-right: 1px solid var(--win-border2); }

/* Help overlay backdrop */
#help-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,.4);
  z-index: 9998; display: none;
}
#help-backdrop.open { display: block; }
</style>
</head>
<body>

<!-- TITLE BAR -->
<div id="titlebar">
  <div class="tb-icon">âš¡</div>
  <div class="tb-title">RankForge Pro 8.0</div>
  <div class="tb-subtitle">â€” SEO Automation Suite (Campaign Engine v2.0)</div>
  <div class="tb-winbtn">
    <span class="tb-min">â€”</span>
    <span class="tb-max">â–¡</span>
    <span class="tb-cls">âœ•</span>
  </div>
</div>

<!-- MENU BAR -->
<div id="menubar">
  <div class="mi" onclick="switchPage('dashboard')">Dashboard</div>
  <div class="mi" onclick="switchPage('url_scraper')">Scraper</div>
  <div class="mi" onclick="switchPage('commenter')">Commenter</div>
  <div class="mi" onclick="switchPage('link_builder')">Links</div>
  <div class="mi" onclick="switchPage('content_gen')">Content</div>
  <div class="mi-sep"></div>
  <div class="mi" onclick="switchPage('proxy_manager')">Proxies</div>
  <div class="mi" onclick="switchPage('settings')">Settings</div>
  <div class="mi" onclick="helpDrawerOpen(APP.currentPage)" title="Open help for current section" style="color:var(--cyan)">ğŸ’¡ Help</div>
  <div class="mi-sep"></div>
  <div class="mi-right">
    <div class="pulsedot"></div>
    <div class="global-status" id="global-status">READY</div>
    <div class="ver-tag">v8.0</div>
  </div>
</div>

<div id="app-body">
  <!-- SIDEBAR -->
  <nav id="sidebar">
    <div class="nav-group">
      <div class="nav-group-lbl">Scrapers</div>
      <div class="nav-item active" onclick="switchPage('url_scraper')" id="nav-url_scraper"><span class="ni">ğŸ”</span> URL Scraper</div>
      <div class="nav-item" onclick="switchPage('serp_scraper')" id="nav-serp_scraper"><span class="ni">ğŸŒ</span> SERP Scraper</div>
      <div class="nav-item" onclick="switchPage('keyword_harvester')" id="nav-keyword_harvester"><span class="ni">ğŸŒ±</span> Keyword Harvester</div>
      <div class="nav-item" onclick="switchPage('sitemap_scraper')" id="nav-sitemap_scraper"><span class="ni">ğŸ—º</span> Sitemap Scraper</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-lbl">Analysis</div>
      <div class="nav-item" onclick="switchPage('da_checker')" id="nav-da_checker"><span class="ni">ğŸ“Š</span> DA/PA Checker</div>
      <div class="nav-item" onclick="switchPage('domain_age')" id="nav-domain_age"><span class="ni">ğŸ“…</span> Domain Age</div>
      <div class="nav-item" onclick="switchPage('robots_checker')" id="nav-robots_checker"><span class="ni">ğŸ¤–</span> Robots.txt</div>
      <div class="nav-item" onclick="switchPage('link_alive')" id="nav-link_alive"><span class="ni">ğŸ’“</span> Link Alive</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-lbl">Campaigns</div>
      <div class="nav-item" onclick="switchPage('campaign')" id="nav-campaign"><span class="ni">ğŸš€</span> Campaigns</div>
      <div class="nav-item" onclick="switchPage('commenter')" id="nav-commenter"><span class="ni">ğŸ’¬</span> Blog Commenter</div>
      <div class="nav-item" onclick="switchPage('link_builder')" id="nav-link_builder"><span class="ni">ğŸ”—</span> Link Builder</div>
      <div class="nav-item" onclick="switchPage('content_gen')" id="nav-content_gen"><span class="ni">âœ</span> Content Gen</div>
      <div class="nav-item" onclick="switchPage('spinner')" id="nav-spinner"><span class="ni">ğŸ”„</span> Article Spinner</div>
      <div class="nav-item" onclick="switchPage('account_creator')" id="nav-account_creator"><span class="ni">ğŸ‘¤</span> Account Creator</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-lbl">Indexing</div>
      <div class="nav-item" onclick="switchPage('link_indexer')" id="nav-link_indexer"><span class="ni">ğŸ“¡</span> Link Indexer</div>
      <div class="nav-item" onclick="switchPage('ping_submitter')" id="nav-ping_submitter"><span class="ni">ğŸ“</span> Ping Submitter</div>
      <div class="nav-item" onclick="switchPage('gsc_inspector')" id="nav-gsc_inspector"><span class="ni">ğŸ”¬</span> GSC Inspector</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-lbl">Tools</div>
      <div class="nav-item" onclick="switchPage('list_manager')" id="nav-list_manager"><span class="ni">ğŸ“‹</span> List Manager</div>
      <div class="nav-item" onclick="switchPage('footprint_builder')" id="nav-footprint_builder"><span class="ni">ğŸ‘£</span> Footprint Builder</div>
      <div class="nav-item" onclick="switchPage('pdf_parasite')" id="nav-pdf_parasite"><span class="ni">ğŸ“„</span> PDF Parasite</div>
      <div class="nav-item" onclick="switchPage('content_rebuild')" id="nav-content_rebuild"><span class="ni">ğŸ¤–</span> Content Rebuild</div>
      <div class="nav-item" onclick="switchPage('anchor_text')" id="nav-anchor_text"><span class="ni">âš“</span> Anchor Text</div>
      <div class="nav-item" onclick="switchPage('tiered_links')" id="nav-tiered_links"><span class="ni">ğŸ—</span> Tiered Links</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-lbl">Analytics</div>
      <div class="nav-item" onclick="switchPage('analytics')" id="nav-analytics"><span class="ni">ğŸ“Š</span> Analytics Hub</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-lbl">Infrastructure</div>
      <div class="nav-item" onclick="switchPage('proxy_manager')" id="nav-proxy_manager"><span class="ni">ğŸ”€</span> Proxy Manager</div>
      <div class="nav-item" onclick="switchPage('captcha_solver')" id="nav-captcha_solver"><span class="ni">ğŸ›¡</span> Captcha Solver</div>
      <div class="nav-item" onclick="switchPage('platform_manager')" id="nav-platform_manager"><span class="ni">ğŸŒ</span> Platforms</div>
    </div>
    <div class="sidebar-footer">
      <div class="thread-box">
        <div class="thread-lbl">Threads <span id="thread-val">5</span></div>
        <input type="range" min="1" max="50" value="5" oninput="document.getElementById('thread-val').textContent=this.value;APP.threads=parseInt(this.value)">
      </div>
    </div>
  </nav>

  <!-- MAIN AREA -->
  <div id="main">
    <!-- TOOLBAR -->
    <div id="toolbar">
      <div class="tb-grp">
        <button class="tbtn go" id="btn-start" onclick="toolbarStart()">â–¶ Start</button>
        <button class="tbtn stop" id="btn-stop" onclick="toolbarStop()">â–  Stop</button>
      </div>
      <div class="tb-sep"></div>
      <button class="tbtn" onclick="exportResults()">ğŸ“¥ Export</button>
      <button class="tbtn" onclick="clearResults()">ğŸ—‘ Clear</button>
      <div class="tb-sep"></div>
      <div class="tb-grp">
        <span class="tb-lbl">LIST:</span>
        <button class="tbtn" onclick="loadFromListManager()">ğŸ“‹ Load URLs</button>
        <button class="tbtn" onclick="saveToListManager()">ğŸ’¾ Save to List</button>
      </div>
      <div class="tb-prog-area">
        <div id="prog-bar-wrap"><div id="prog-bar"></div></div>
        <div id="prog-text" class="mono xs tm">0 / 0</div>
      </div>
    </div>

    <div id="workspace">
      <div id="page-area"><!-- Pages injected dynamically --></div>

      <!-- LOG PANEL -->
      <div id="log-panel">
        <div id="log-header">
          â–¶ Activity Log
          <div style="margin-left:auto">
            <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="clearLog()">Clear</button>
          </div>
        </div>
        <div id="log-body"></div>
        <div id="log-footer">
          <div class="mono" style="font-size:9px;color:var(--text3)" id="log-count">0 entries</div>
          <div class="mono" style="font-size:9px;color:var(--text3)" id="log-time"></div>
        </div>
      </div>
    </div>

    <!-- STATUS BAR -->
    <div id="statusbar">
      <div class="sb-seg">Status: <span class="sb-val" id="sb-status">Idle</span></div>
      <div class="sb-seg">Processed: <span class="sb-val g" id="sb-processed">0</span></div>
      <div class="sb-seg">Success: <span class="sb-val g" id="sb-success">0</span></div>
      <div class="sb-seg">Failed: <span class="sb-val r" id="sb-failed">0</span></div>
      <div class="sb-seg">Threads: <span class="sb-val y" id="sb-threads">5</span></div>
      <div class="sb-seg">URL List: <span class="sb-val" id="sb-list">0 URLs</span></div>
      <div class="sb-seg" style="margin-left:auto;border-right:none">RankForge Pro v9.0</div>
    </div>
  </div>
</div>

<!-- HELP DRAWER -->
<div id="help-backdrop" onclick="helpDrawerClose()"></div>
<div id="help-drawer">
  <div id="help-drawer-header">
    <span>ğŸ’¡</span>
    <span id="help-drawer-title">Help & Tips</span>
    <div id="help-drawer-close" onclick="helpDrawerClose()">âœ•</div>
  </div>
  <div id="help-drawer-body"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP = {
  threads: 5, running: false, currentPage: 'url_scraper', stopFlag: false,
  stats: { processed: 0, success: 0, failed: 0 },
  urlList: [], results: [], campaigns: [], proxies: [],
  comments: [], links: [], accounts: [],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE BACKEND INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _supabaseClient = null;

function sbInit() {
  const url = localStorage.getItem('rf_sb_url');
  const key = localStorage.getItem('rf_sb_anon');
  if (url && key && typeof supabase !== 'undefined') {
    try {
      _supabaseClient = supabase.createClient(url, key);
      log('Supabase: connected âœ“', 'ok');
      sbSyncFromCloud(); // pull cloud data on connect
      return true;
    } catch(e) {
      log('Supabase: init error â€” ' + e.message, 'err');
      _supabaseClient = null;
      return false;
    }
  }
  return false;
}

// Push a key/value to Supabase kv_store table
async function sbPush(k, v) {
  if (!_supabaseClient) return;
  try {
    const { error } = await _supabaseClient
      .from('rf_kv_store')
      .upsert({ key: k, value: JSON.stringify(v), updated_at: new Date().toISOString() }, { onConflict: 'key' });
    if (error) console.warn('sbPush error:', error.message);
  } catch(e) { console.warn('sbPush failed:', e.message); }
}

// Pull all keys from Supabase and sync to localStorage
async function sbSyncFromCloud() {
  if (!_supabaseClient) return;
  try {
    const { data, error } = await _supabaseClient.from('rf_kv_store').select('key, value');
    if (error) { log('Supabase sync error: ' + error.message, 'warn'); return; }
    if (!data || !data.length) { log('Supabase: no cloud data found (first time setup?)', 'info'); return; }
    data.forEach(row => {
      try { localStorage.setItem(row.key, row.value); } catch(e) {}
    });
    log(`Supabase: synced ${data.length} keys from cloud âœ“`, 'ok');
    updateStats();
    const pg = document.getElementById('page-' + APP.currentPage);
    if (pg) { const fn = window['render_' + APP.currentPage]; if (fn) fn(pg); }
  } catch(e) { log('Supabase sync failed: ' + e.message, 'err'); }
}

// Push ALL localStorage keys to Supabase (full backup)
async function sbPushAll() {
  if (!_supabaseClient) { log('Supabase not configured â€” add URL and anon key in Settings', 'warn'); return; }
  const rows = [];
  const now = new Date().toISOString();
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (!k || !k.startsWith('rf_')) continue;
    rows.push({ key: k, value: localStorage.getItem(k), updated_at: now });
  }
  if (!rows.length) { log('Supabase: nothing to push (no rf_ keys found)', 'warn'); return; }
  try {
    const { error } = await _supabaseClient.from('rf_kv_store').upsert(rows, { onConflict: 'key' });
    if (error) { log('Supabase push error: ' + error.message, 'err'); return; }
    log(`Supabase: pushed ${rows.length} keys to cloud âœ“`, 'ok');
  } catch(e) { log('Supabase push failed: ' + e.message, 'err'); }
}

// Check connection status
async function sbStatus() {
  if (!_supabaseClient) return 'disconnected';
  try {
    const { error } = await _supabaseClient.from('rf_kv_store').select('key').limit(1);
    return error ? 'error: ' + error.message : 'connected';
  } catch(e) { return 'error: ' + e.message; }
}

const SS = {
  get(k, def=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(e){ return def; } },
  set(k, v){
    try{
      localStorage.setItem(k, JSON.stringify(v));
      // Auto-sync important keys to Supabase (non-blocking)
      if (_supabaseClient && k.startsWith('rf_')) sbPush(k, v);
    }catch(e){}
  },
  raw(k, def=''){ try{ return localStorage.getItem(k)||def; }catch(e){ return def; } },
  rawSet(k, v){
    try{
      localStorage.setItem(k, v);
      // Auto-sync string keys to Supabase (non-blocking)
      if (_supabaseClient && k.startsWith('rf_')) {
        if (!_supabaseClient) return;
        _supabaseClient.from('rf_kv_store')
          .upsert({ key: k, value: v, updated_at: new Date().toISOString() }, { onConflict: 'key' })
          .then(({error}) => { if(error) console.warn('sbRawSet:', error.message); });
      }
    }catch(e){}
  }
};

// â”€â”€â”€ PROXY ROTATION ENGINE v2.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _proxyIdx = 0;
// Global rotation strategy: 'round-robin' | 'random' | 'least-used' | 'geo-match' | 'freshest'
if(!window.PRX_STRATEGY) window.PRX_STRATEGY = localStorage.getItem('rf_prx_strategy')||'round-robin';
// Per-tool pool assignments: {scraper:'pool-a', commenter:'pool-b', ...}
if(!window.PRX_TOOL_POOLS) window.PRX_TOOL_POOLS = JSON.parse(localStorage.getItem('rf_prx_tool_pools')||'{}');
// Domainâ†’proxy history: {domain: [{addr, ts}]} â€” prevent reuse within 24h
if(!window.PRX_DOMAIN_HIST) window.PRX_DOMAIN_HIST = JSON.parse(localStorage.getItem('rf_prx_domain_hist')||'{}');
// Per-proxy consecutive fail count
if(!window.PRX_FAIL_COUNTS) window.PRX_FAIL_COUNTS = JSON.parse(localStorage.getItem('rf_prx_fail_counts')||'{}');
// Auto-remove threshold
const PRX_AUTO_REMOVE_AFTER = () => parseInt(localStorage.getItem('rf_prx_auto_remove')||'3');
// Retire after X uses
const PRX_RETIRE_AFTER = () => parseInt(localStorage.getItem('rf_prx_retire_after')||'50');
// Ban detection patterns (HTTP responses indicating IP ban vs generic error)
const PRX_BAN_PATTERNS = [/captcha/i,/blocked/i,/forbidden/i,/banned/i,/access denied/i,/rate limit/i,/your ip/i,/unusual traffic/i];

function _prxPool(tool){
  // Get pool tag for a tool, or 'all' if unassigned
  return window.PRX_TOOL_POOLS[tool]||'all';
}

function _prxEligible(pool, opts={}){
  const retireAfter = PRX_RETIRE_AFTER();
  let proxies = APP.proxies.filter(p=>{
    if(p.status!=='live') return false;
    if((p.useCount||0)>=retireAfter) return false; // retired
    if(pool!=='all'&&p.pool&&p.pool!==pool) return false;
    return true;
  });
  // Domain history filter â€” skip if used against same domain within 24h
  if(opts.domain){
    const hist = window.PRX_DOMAIN_HIST[opts.domain]||[];
    const cutoff = Date.now()-86400000;
    const recentAddrs = new Set(hist.filter(e=>e.ts>cutoff).map(e=>e.addr));
    proxies = proxies.filter(p=>!recentAddrs.has(p.addr));
  }
  // Protocol filter
  if(opts.protocol){
    proxies = proxies.filter(p=>(p.type||'HTTP').toUpperCase()===opts.protocol.toUpperCase()||(p.type||'').toLowerCase().startsWith(opts.protocol.toLowerCase()));
  }
  return proxies;
}

function getNextProxy(pool, opts={}){
  // pool: pool tag string or 'geo' (legacy compat) or undefined
  // opts: {domain, geo, protocol, tool, tier}

  // Resolve tool pool
  if(opts.tool&&!pool) pool=_prxPool(opts.tool);
  if(!pool||pool==='any') pool='all';

  // Legacy 'geo' from tiered_links compat
  const wantGeo = pool==='geo'||opts.geo;
  if(pool==='geo') pool='all';

  let candidates = _prxEligible(pool, opts);
  if(!candidates.length) candidates = APP.proxies.filter(p=>p.status==='live'); // fallback to any live

  if(!candidates.length) return null;

  // Geo match
  if(wantGeo||opts.geo){
    const geo = opts.geo||null;
    const geoMatch = geo?candidates.filter(p=>p.country===geo):null;
    if(geoMatch&&geoMatch.length) candidates=geoMatch;
    else{
      // Geo-diverse: rotate by country
      const countries=[...new Set(candidates.map(p=>p.country||'US'))];
      const country=countries[_proxyIdx%countries.length];
      candidates=candidates.filter(p=>(p.country||'US')===country)||candidates;
    }
  }

  // Tier priority: T1 gets freshest proxies
  if(opts.tier==='1'||opts.fresh){
    candidates.sort((a,b)=>(a.useCount||0)-(b.useCount||0));
  }

  let p;
  const strategy = window.PRX_STRATEGY;
  if(strategy==='random'){
    p=candidates[rand(0,candidates.length-1)];
  } else if(strategy==='least-used'){
    p=candidates.slice().sort((a,b)=>(a.useCount||0)-(b.useCount||0))[0];
  } else if(strategy==='freshest'){
    p=candidates.slice().sort((a,b)=>(a.useCount||0)-(b.useCount||0))[0];
  } else if(strategy==='geo-match'&&opts.geo){
    const gm=candidates.filter(c=>c.country===opts.geo);
    p=gm.length?gm[rand(0,gm.length-1)]:candidates[_proxyIdx%candidates.length];
  } else {
    // round-robin (default)
    p=candidates[_proxyIdx%candidates.length];
  }

  if(!p) return null;

  // Record use
  p.useCount=(p.useCount||0)+1;
  p.lastUsed=Date.now();
  if(!p.useHistory) p.useHistory=[];
  p.useHistory.push(Date.now());
  if(p.useHistory.length>100) p.useHistory=p.useHistory.slice(-100);

  // Domain history
  if(opts.domain){
    if(!window.PRX_DOMAIN_HIST[opts.domain]) window.PRX_DOMAIN_HIST[opts.domain]=[];
    window.PRX_DOMAIN_HIST[opts.domain].push({addr:p.addr,ts:Date.now()});
    // Trim old entries
    window.PRX_DOMAIN_HIST[opts.domain]=window.PRX_DOMAIN_HIST[opts.domain].filter(e=>Date.now()-e.ts<86400000*7);
    localStorage.setItem('rf_prx_domain_hist',JSON.stringify(window.PRX_DOMAIN_HIST));
  }

  // Auto-retire check
  if(p.useCount>=PRX_RETIRE_AFTER()){
    p.status='retired';
    log(`Proxy ${p.addr} retired after ${p.useCount} uses`,'warn');
  }

  _proxyIdx++;
  SS.set('rf_proxies',APP.proxies);
  return p;
}

function proxyLabel(p){
  if(!p) return 'No proxy';
  return `${(p.type||'HTTP').toLowerCase()}://${p.addr}`;
}

// Record proxy failure â€” auto-remove after N consecutive fails
function prx_recordFailure(p, responseText){
  if(!p) return;
  const addr=p.addr;
  window.PRX_FAIL_COUNTS[addr]=(window.PRX_FAIL_COUNTS[addr]||0)+1;
  localStorage.setItem('rf_prx_fail_counts',JSON.stringify(window.PRX_FAIL_COUNTS));

  // Ban detection
  const isBan = responseText&&PRX_BAN_PATTERNS.some(rx=>rx.test(responseText));
  if(isBan){
    p.status='banned';
    p.banDetected=true;
    log(`â›” IP Ban detected on ${addr} â€” marked banned`,'err');
  } else if(window.PRX_FAIL_COUNTS[addr]>=PRX_AUTO_REMOVE_AFTER()){
    p.status='dead';
    log(`ğŸ’€ ${addr} auto-removed after ${window.PRX_FAIL_COUNTS[addr]} consecutive failures`,'warn');
  }
  SS.set('rf_proxies',APP.proxies);
}

// Record proxy success â€” reset fail counter
function prx_recordSuccess(p){
  if(!p) return;
  window.PRX_FAIL_COUNTS[p.addr]=0;
  if(!p.successHistory) p.successHistory=[];
  p.successHistory.push(Date.now());
  if(p.successHistory.length>200) p.successHistory=p.successHistory.slice(-200);
  // Compute uptime %
  const total=(p.useHistory||[]).length;
  const successes=(p.successHistory||[]).length;
  p.uptimePct=total>0?Math.round((successes/total)*100):100;
  SS.set('rf_proxies',APP.proxies);
}

// Proxy score: composite of speed + uptime + freshness
function prx_score(p){
  const speedScore = p.speed?Math.max(0,100-Math.round(p.speed/100)):50;
  const uptime = p.uptimePct||50;
  const freshness = Math.max(0,100-Math.round((p.useCount||0)/Math.max(1,PRX_RETIRE_AFTER())*100));
  return Math.round((speedScore*0.3)+(uptime*0.5)+(freshness*0.2));
}

// â”€â”€â”€ CAPTCHA SOLVER ENGINE v2.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Token cache: { key: siteKey+url, val: token, exp: timestamp }
const CAP_TOKEN_CACHE = new Map();
// Per-campaign cost tracking: { campaignId: { cost, solved, failed } }
const CAP_CAMPAIGN_COSTS = new Map();
// Per-service latency tracking: { svc: [ms, ms, ...] }
const CAP_LATENCY = {};
// Balance alert state
let CAP_BALANCE_WARNED = false;

function capTrackLatency(svc, ms) {
  if (!CAP_LATENCY[svc]) CAP_LATENCY[svc] = [];
  CAP_LATENCY[svc].push(ms);
  if (CAP_LATENCY[svc].length > 20) CAP_LATENCY[svc].shift();
}
function capAvgLatency(svc) {
  const arr = CAP_LATENCY[svc] || [];
  if (!arr.length) return null;
  return Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
}

// Detect captcha type on page HTML
function detectCaptchaType(html) {
  if (!html) return null;
  if (/hcaptcha\.com|data-sitekey.*hcaptcha/i.test(html)) return 'hcaptcha';
  if (/challenges\.cloudflare\.com|cf-turnstile/i.test(html)) return 'turnstile';
  if (/recaptcha.*\/v3\/|grecaptcha\.execute/i.test(html)) return 'recaptchav3';
  if (/recaptcha|g-recaptcha/i.test(html)) return 'recaptchav2';
  if (/<img[^>]*captcha/i.test(html)) return 'image';
  return null;
}

// Check if page actually needs captcha before solving
function pageHasCaptcha(html) {
  return !!detectCaptchaType(html);
}

// Determine service based on tier
function capServiceForTier(tier, cfg) {
  if (tier === 1 || tier === 2) return cfg.service || '2captcha'; // premium
  return cfg.cheapService || cfg.service || '2captcha'; // T3 uses cheaper
}

async function solveCaptchaFull({ siteKey, pageUrl, type='recaptchav2', imageBase64=null, campaignId=null, tier=2, pageHtml=null }) {
  const cfg = SS.get('rf_captcha', {});

  // Skip if page has no captcha
  if (pageHtml && !pageHasCaptcha(pageHtml)) {
    log('Captcha: no captcha detected on page â€” skipping solve', 'info');
    return '__skip__';
  }

  // Auto-detect type from page html
  if (pageHtml) {
    const detected = detectCaptchaType(pageHtml);
    if (detected) type = detected;
  }

  // Token cache check
  const cacheKey = (siteKey||type) + '|' + pageUrl;
  const cached = CAP_TOKEN_CACHE.get(cacheKey);
  if (cached && Date.now() < cached.exp) {
    log('Captcha: reusing cached token âœ“', 'ok');
    return cached.val;
  }

  const primarySvc = capServiceForTier(tier, cfg);
  const fallbackSvc = cfg.backup || null;
  const maxRetries = cfg.maxRetries || 3;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    const svc = (attempt <= 2) ? primarySvc : (fallbackSvc || primarySvc);
    const apiKey = (svc === cfg.service || !cfg.backupKey) ? (cfg.key || SS.raw('rf_captcha_key')) : cfg.backupKey;
    if (!apiKey) { log('Captcha: no API key configured', 'warn'); return null; }

    // Balance alert
    const s = SS.get('rf_captcha', {});
    if (cfg.balanceAlert && (s.balance||0) < cfg.balanceAlert && !CAP_BALANCE_WARNED) {
      log(`âš  Captcha balance low ($${(s.balance||0).toFixed(2)} < alert $${cfg.balanceAlert})`, 'warn');
      CAP_BALANCE_WARNED = true;
    }

    if (attempt > 1) log(`Captcha: retry attempt ${attempt}/${maxRetries} via ${svc}...`, 'warn');
    else log(`Captcha: submitting ${type} task via ${svc}...`, 'info');

    try {
      const t0 = Date.now();
      let taskId = null;

      // â”€â”€ Build task payload per type & service â”€â”€
      const payload = buildCaptchaPayload(svc, apiKey, type, siteKey, pageUrl, imageBase64);
      const submitUrl = getSubmitUrl(svc);
      const r = await fetch(submitUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: AbortSignal.timeout(15000) });
      const d = await r.json();
      taskId = extractTaskId(svc, d);
      if (!taskId) throw new Error(d.error_text || d.errorDescription || 'No task ID');

      log(`Captcha: task ${taskId} submitted, polling...`, 'info');
      const timeout = (cfg.timeout || 120) * 1000;
      const start = Date.now();
      while (Date.now() - start < timeout) {
        await sleep(5000);
        const token = await pollCaptchaResult(svc, apiKey, taskId, type);
        if (token) {
          capTrackLatency(svc, Date.now() - t0);
          // Cache token (valid ~110s)
          CAP_TOKEN_CACHE.set(cacheKey, { val: token, exp: Date.now() + 110000 });
          // Track stats & cost
          const costMap = { '2captcha':0.001, 'anticaptcha':0.0008, 'capsolver':0.0009, 'deathbycaptcha':0.0013 };
          const cost = costMap[svc] || 0.001;
          const st = SS.get('rf_captcha', {});
          st.solved = (st.solved||0)+1;
          st.cost = ((st.cost||0)+cost);
          st.rate = Math.round(st.solved/Math.max(1,st.solved+(st.failed||0))*100)+'%';
          SS.set('rf_captcha', st);
          // Campaign cost tracking
          if (campaignId) {
            const cc = CAP_CAMPAIGN_COSTS.get(campaignId) || {cost:0,solved:0,failed:0};
            cc.cost += cost; cc.solved++; CAP_CAMPAIGN_COSTS.set(campaignId, cc);
          }
          log(`Captcha: solved âœ“ [${svc}, ${Math.round((Date.now()-t0)/1000)}s, $${cost}]`, 'ok');
          return token;
        }
      }
      throw new Error('Timeout');
    } catch(e) {
      if (attempt === maxRetries || (attempt === 2 && !fallbackSvc)) {
        const st = SS.get('rf_captcha', {}); st.failed = (st.failed||0)+1; SS.set('rf_captcha', st);
        if (campaignId) { const cc = CAP_CAMPAIGN_COSTS.get(campaignId)||{cost:0,solved:0,failed:0}; cc.failed++; CAP_CAMPAIGN_COSTS.set(campaignId, cc); }
        log(`Captcha: all retries exhausted â€” ${e.message}`, 'err');
        return null;
      }
      log(`Captcha: attempt ${attempt} failed (${e.message}) â€” retrying...`, 'warn');
      if (attempt === 2 && fallbackSvc) log(`Captcha: failing over from ${primarySvc} â†’ ${fallbackSvc}`, 'warn');
    }
  }
  return null;
}

function buildCaptchaPayload(svc, apiKey, type, siteKey, pageUrl, imageBase64) {
  if (svc === '2captcha') {
    if (type === 'hcaptcha')   return { key:apiKey, method:'hcaptcha', sitekey:siteKey, pageurl:pageUrl, json:1 };
    if (type === 'turnstile')  return { key:apiKey, method:'turnstile', sitekey:siteKey, pageurl:pageUrl, json:1 };
    if (type === 'recaptchav3') return { key:apiKey, method:'userrecaptcha', version:'v3', googlekey:siteKey, pageurl:pageUrl, score:0.3, json:1 };
    if (type === 'image')      return { key:apiKey, method:'base64', body:imageBase64, json:1 };
    return { key:apiKey, method:'userrecaptcha', googlekey:siteKey, pageurl:pageUrl, json:1 };
  }
  if (svc === 'anticaptcha') {
    if (type === 'hcaptcha')   return { clientKey:apiKey, task:{ type:'HCaptchaTaskProxyless', websiteURL:pageUrl, websiteKey:siteKey } };
    if (type === 'image')      return { clientKey:apiKey, task:{ type:'ImageToTextTask', body:imageBase64 } };
    if (type === 'recaptchav3') return { clientKey:apiKey, task:{ type:'RecaptchaV3TaskProxyless', websiteURL:pageUrl, websiteKey:siteKey, minScore:0.3, pageAction:'submit' } };
    return { clientKey:apiKey, task:{ type:'RecaptchaV2TaskProxyless', websiteURL:pageUrl, websiteKey:siteKey } };
  }
  if (svc === 'capsolver') {
    if (type === 'hcaptcha')   return { clientKey:apiKey, task:{ type:'HCaptchaTaskProxyLess', websiteURL:pageUrl, websiteKey:siteKey } };
    if (type === 'turnstile')  return { clientKey:apiKey, task:{ type:'AntiTurnstileTaskProxyLess', websiteURL:pageUrl, websiteKey:siteKey } };
    if (type === 'recaptchav3') return { clientKey:apiKey, task:{ type:'ReCaptchaV3TaskProxyLess', websiteURL:pageUrl, websiteKey:siteKey, pageAction:'submit', minScore:0.3 } };
    if (type === 'image')      return { clientKey:apiKey, task:{ type:'ImageToTextTask', body:imageBase64 } };
    return { clientKey:apiKey, task:{ type:'ReCaptchaV2TaskProxyLess', websiteURL:pageUrl, websiteKey:siteKey } };
  }
  return {};
}
function getSubmitUrl(svc) {
  if (svc==='2captcha')    return 'https://2captcha.com/in.php';
  if (svc==='anticaptcha') return 'https://api.anti-captcha.com/createTask';
  if (svc==='capsolver')   return 'https://api.capsolver.com/createTask';
  return 'https://2captcha.com/in.php';
}
function extractTaskId(svc, d) {
  if (svc==='2captcha')    return d.status===1 ? d.request : null;
  if (svc==='anticaptcha') return d.errorId===0 ? d.taskId : null;
  if (svc==='capsolver')   return !d.errorId ? d.taskId : null;
  return null;
}
async function pollCaptchaResult(svc, apiKey, taskId, type) {
  try {
    if (svc==='2captcha') {
      const r = await fetch(`https://2captcha.com/res.php?key=${apiKey}&action=get&id=${taskId}&json=1`, {signal:AbortSignal.timeout(8000)});
      const d = await r.json();
      if (d.status===1) return d.request; // text for image captcha, token for others
    } else if (svc==='anticaptcha') {
      const r = await fetch('https://api.anti-captcha.com/getTaskResult', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clientKey:apiKey,taskId}),signal:AbortSignal.timeout(8000)});
      const d = await r.json();
      if (d.status==='ready') return d.solution?.gRecaptchaResponse || d.solution?.token || d.solution?.text;
    } else if (svc==='capsolver') {
      const r = await fetch('https://api.capsolver.com/getTaskResult', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clientKey:apiKey,taskId}),signal:AbortSignal.timeout(8000)});
      const d = await r.json();
      if (d.status==='ready') return d.solution?.gRecaptchaResponse || d.solution?.token || d.solution?.text;
    }
  } catch(e) {}
  return null;
}

// Batch pre-solve captchas before a run
async function capPreSolveBatch(urls, siteKey, count=5) {
  log(`Captcha: pre-solving ${Math.min(count, urls.length)} tokens in batch...`, 'info');
  const tokens = [];
  for (let i=0; i<Math.min(count,urls.length); i++) {
    const t = await solveCaptchaFull({siteKey, pageUrl:urls[i], type:'recaptchav2'});
    if (t) tokens.push({url:urls[i], token:t});
  }
  log(`Captcha: pre-solved ${tokens.length} tokens`, 'ok');
  return tokens;
}

// Legacy wrapper
async function solveCaptcha(siteKey, pageUrl) {
  return solveCaptchaFull({siteKey, pageUrl, type:'recaptchav2'});
}

APP.urlList = SS.get('rf_urllist', []);
APP.campaigns = SS.get('rf_campaigns', []);
APP.proxies = SS.get('rf_proxies', []);
APP.comments = SS.get('rf_comments', []);
APP.links = SS.get('rf_links', []);
APP.accounts = SS.get('rf_accounts', []);

const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const fmtNum = n => Number(n).toLocaleString();
const now = () => new Date().toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
const today = () => new Date().toLocaleDateString();

function setProgress(pct, text=''){
  document.getElementById('prog-bar').style.width = pct+'%';
  if(text) document.getElementById('prog-text').textContent = text;
}
function setStatus(txt){
  document.getElementById('sb-status').textContent = txt;
  document.getElementById('global-status').textContent = txt.toUpperCase();
}
function updateStats(){
  document.getElementById('sb-processed').textContent = APP.stats.processed;
  document.getElementById('sb-success').textContent = APP.stats.success;
  document.getElementById('sb-failed').textContent = APP.stats.failed;
  document.getElementById('sb-threads').textContent = APP.threads;
  document.getElementById('sb-list').textContent = APP.urlList.length + ' URLs';
}

// LOG
let logCount = 0;
function log(msg, type='info'){
  const body = document.getElementById('log-body');
  const cls = {ok:'log-ok', err:'log-err', warn:'log-warn', info:'log-info'}[type]||'log-info';
  const div = document.createElement('div');
  div.className = 'log-line';
  div.innerHTML = `<span class="log-time">${now()}</span><span class="${cls}">${esc(msg)}</span>`;
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
  logCount++;
  document.getElementById('log-count').textContent = logCount + ' entries';
  document.getElementById('log-time').textContent = now();
}
function clearLog(){ document.getElementById('log-body').innerHTML=''; logCount=0; document.getElementById('log-count').textContent='0 entries'; }

// NAVIGATION
const PAGE_IDS = ['url_scraper','serp_scraper','keyword_harvester','sitemap_scraper','da_checker','domain_age','robots_checker','link_alive','campaign','commenter','link_builder','content_gen','spinner','account_creator','link_indexer','ping_submitter','gsc_inspector','list_manager','footprint_builder','anchor_text','tiered_links','proxy_manager','captcha_solver','platform_manager','settings','dashboard','analytics','pdf_parasite','content_rebuild'];

(function(){
  const area = document.getElementById('page-area');
  PAGE_IDS.forEach(id => {
    const d = document.createElement('div');
    d.id = 'page-'+id; d.className = 'page'; area.appendChild(d);
  });
})();

function switchPage(id){
  if(!PAGE_IDS.includes(id)) return;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg = document.getElementById('page-'+id);
  if(pg) pg.classList.add('active');
  const nav = document.getElementById('nav-'+id);
  if(nav) nav.classList.add('active');
  APP.currentPage = id;
  pageStateSave();
  // Remove previous help wrapper if present (re-render clears it)
  const existingHelp = document.getElementById('help-wrapper-'+id);
  if(existingHelp) existingHelp.remove();
  const fn = window['render_'+id];
  if(typeof fn==='function') fn(pg);
  // Inject help tips bar at top of page after render
  if(pg && typeof HELP_CONTENT !== 'undefined' && HELP_CONTENT[id]){
    const helpEl = document.createElement('div');
    helpEl.id = 'help-wrapper-'+id;
    helpEl.innerHTML = helpBuildWorkflow((HELP_CONTENT[id]||{}).workflow) + helpBuildTipsBar(id);
    pg.insertBefore(helpEl, pg.firstChild);
  }
  updateStats();
}

function toolbarStart(){
  const fn = window['start_'+APP.currentPage];
  if(typeof fn === 'function') fn();
  else log('No start action for this page', 'warn');
}
let _runStartTs = 0;
function toolbarStart_trackStart(){ _runStartTs = Date.now(); }
function toolbarStop(){
  APP.stopFlag = true; APP.running = false; setStatus('Stopped'); log('Stopped by user','warn');
  sessionStateClear();
  tabLockRelease(APP.currentPage);
  if(_runStartTs>0){
    runHistoryAdd(APP.currentPage, APP.stats.processed, APP.stats.success, APP.stats.failed, {duration:Date.now()-_runStartTs});
    webhookSend(APP.currentPage,'tool_stopped',{duration:Date.now()-_runStartTs});
    _runStartTs=0;
  }
}
function exportResults(){
  const fn = window['export_'+APP.currentPage];
  if(typeof fn === 'function') fn();
  else { if(APP.results.length){ dlCSV(APP.results.map(r=>typeof r==='object'?Object.values(r).join(','):r).join('\n'), 'export.csv'); } else log('Nothing to export','warn'); }
}
function clearResults(){
  APP.results = [];
  const fn = window['clear_'+APP.currentPage];
  if(typeof fn === 'function') fn();
  else { const pg = document.getElementById('page-'+APP.currentPage); if(pg){ const fn2=window['render_'+APP.currentPage]; if(fn2) fn2(pg); } }
  setProgress(0,'0 / 0'); log('Results cleared','warn');
}
function loadFromListManager(){ log('Loaded '+APP.urlList.length+' URLs from List Manager','ok'); updateStats(); }
function saveToListManager(){ log('Saved '+APP.results.length+' results to List Manager','ok'); APP.urlList=[...new Set([...APP.urlList,...APP.results.map(r=>r.url||r).filter(Boolean)])]; SS.set('rf_urllist',APP.urlList); updateStats(); }

function dlCSV(content, filename){
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(content);
  a.download = filename; a.click();
}
function dlTxt(content, filename){
  const a = document.createElement('a');
  a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
  a.download = filename; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_dashboard(el){
  const keysConfigured=[SS.raw('rf_claude_key'),SS.raw('rf_opr_key'),SS.raw('rf_serpapi_key'),SS.raw('rf_whois_key')].filter(Boolean).length;
  el.innerHTML = `
  <div style="padding:4px 0 10px;display:flex;align-items:center;gap:10px">
    <div style="font-family:var(--mono);font-size:20px;font-weight:700;color:var(--green)">âš¡ RankForge Pro 3.0</div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--text3)">SEO Automation Suite â€” Real API Edition</div>
    <div style="margin-left:auto"><span class="badge ${keysConfigured>=2?'bg':keysConfigured===1?'by':'br'}">${keysConfigured}/4 APIs configured</span> <button class="tbtn" onclick="switchPage('settings')" style="padding:2px 8px;font-size:10px">âš™ Settings</button></div>
  </div>
  ${keysConfigured===0?`<div class="notice ni-y" style="margin-bottom:10px">âš  No API keys configured yet. Go to <a href="#" onclick="switchPage('settings')">Settings</a> to add your keys and unlock real functionality. All tools show what keys they need.</div>`:''}
  <div class="g5" style="margin-bottom:10px">
    <div class="stat"><div class="stat-v sv-g">${APP.urlList.length}</div><div class="stat-l">URL List</div></div>
    <div class="stat"><div class="stat-v sv-b">${APP.campaigns.length}</div><div class="stat-l">Campaigns</div></div>
    <div class="stat"><div class="stat-v sv-p">${APP.comments.length}</div><div class="stat-l">Comments</div></div>
    <div class="stat"><div class="stat-v sv-o">${APP.links.length}</div><div class="stat-l">Links Built</div></div>
    <div class="stat"><div class="stat-v sv-y">${APP.proxies.filter(p=>p.status==='live').length}</div><div class="stat-l">Live Proxies</div></div>
  </div>
  <div class="g3">
    ${[
      ['url_scraper','ğŸ” URL Scraper','Scrape blog/site URLs via sitemap, RSS & page links. No API key needed.','bg'],
      ['serp_scraper','ğŸŒ SERP Scraper','Scrape Google SERPs. Free via DuckDuckGo, or use SerpAPI key for Google.','by'],
      ['da_checker','ğŸ“Š DA/PA Checker','Real Domain Authority via Open PageRank API. Free key at openpagerank.com.','by'],
      ['content_gen','âœ Content Generator','Generate real SEO content via Claude AI API. Add Claude key in Settings.','by'],
      ['link_indexer','ğŸ“¡ Link Indexer','Submit to IndexNow + Google/Bing ping. Works immediately, key optional.','bg'],
      ['gsc_inspector','ğŸ”¬ GSC Inspector','Live Google Search Console inspection via GSC API + OAuth token.','by'],
    ].map(([id,title,desc,badge])=>`
    <div class="panel" style="cursor:pointer" onclick="switchPage('${id}')">
      <div class="panel-head">${title} <span class="badge ${badge}" style="font-size:8px">${badge==='bg'?'FREE':'API KEY'}</span></div>
      <div class="panel-body" style="font-size:11px;color:var(--text3);line-height:1.5">${desc}</div>
    </div>`).join('')}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL SCRAPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ URL Scraper v3 state â”€â”€
let _usSortCol = 'score', _usSortDir = -1, _usFilterText = '', _usDedupeDisplay = false;

function render_url_scraper(el){
  const saved = SS.get('rf_url_scraper_results', []);
  const seen_all = SS.get('rf_url_scraper_seen', {});
  const okCount = saved.filter(r=>r.status==='ok').length;
  const cmtCount = saved.filter(r=>r.commentEnabled).length;
  const dedupCount = Object.keys(seen_all).length;
  const clCount = saved.filter(r=>r.commentSystem==='CommentLuv').length;
  const canonIssues = saved.filter(r=>r.hasCanonical).length;
  const loginBlocked = saved.filter(r=>r.loginRequired).length;
  const avgScore = saved.length ? Math.round(saved.reduce((a,r)=>a+(r.score||0),0)/saved.length) : 0;

  // Sort + filter display rows
  let rows = [...saved];
  if(_usFilterText){
    const ft = _usFilterText.toLowerCase();
    rows = rows.filter(r=>(r.url||'').toLowerCase().includes(ft)||(r.title||'').toLowerCase().includes(ft)||(r.cms||'').toLowerCase().includes(ft)||(r.commentSystem||'').toLowerCase().includes(ft));
  }
  if(_usDedupeDisplay){
    const seen = {}; rows = rows.filter(r=>{ const d=r.source||r.url.split('/')[2]; if(seen[d]) return false; seen[d]=1; return true; });
  }
  rows.sort((a,b)=>{
    const av = a[_usSortCol]??'', bv = b[_usSortCol]??'';
    if(typeof av==='number') return _usSortDir*(av-bv);
    return _usSortDir*String(av).localeCompare(String(bv));
  });
  const displayRows = rows.slice(0,300);

  const thSort = (col,lbl) => `<th style="cursor:pointer;user-select:none" onclick="usSetSort('${col}')">${lbl}${_usSortCol===col?(_usSortDir===1?' â–²':' â–¼'):''}</th>`;

  el.innerHTML = `
  <!-- â”€â”€ STAT STRIP â”€â”€ -->
  ${saved.length?`<div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
    <div class="stat sv-g" style="flex:1;min-width:90px;padding:7px 10px"><div class="stat-v" style="font-size:16px">${okCount}</div><div class="stat-l">OK URLs</div></div>
    <div class="stat sv-b" style="flex:1;min-width:90px;padding:7px 10px"><div class="stat-v" style="font-size:16px">${cmtCount}</div><div class="stat-l">Comment-Enabled</div></div>
    <div class="stat sv-p" style="flex:1;min-width:90px;padding:7px 10px"><div class="stat-v" style="font-size:16px">${clCount}</div><div class="stat-l">CommentLuv</div></div>
    <div class="stat sv-y" style="flex:1;min-width:90px;padding:7px 10px"><div class="stat-v" style="font-size:16px">${avgScore}</div><div class="stat-l">Avg Score</div></div>
    <div class="stat sv-r" style="flex:1;min-width:90px;padding:7px 10px"><div class="stat-v" style="font-size:16px">${loginBlocked}</div><div class="stat-l">Login-Walled</div></div>
    <div class="stat" style="flex:1;min-width:90px;padding:7px 10px;--accent-c:var(--orange)"><div class="stat-v sv-o" style="font-size:16px">${canonIssues}</div><div class="stat-l">Canonical Issues</div></div>
    <div class="stat" style="flex:1;min-width:90px;padding:7px 10px"><div class="stat-v" style="font-size:16px">${dedupCount}</div><div class="stat-l">Seen Cache</div></div>
  </div>`:''}

  <div class="panel">
    <div class="panel-head">ğŸ” URL Scraper v3.0
      <div class="ph-r">
        <span class="badge bg">${saved.length} results</span>
        <span class="badge bb" style="margin-left:4px">${[...new Set(saved.map(r=>r.source).filter(Boolean))].length} domains</span>
      </div>
    </div>
    <div class="panel-body">

      <!-- â”€â”€ TAB STRIP â”€â”€ -->
      <div id="us-tabs" style="display:flex;gap:2px;margin-bottom:10px;border-bottom:1px solid var(--win-border2);padding-bottom:6px">
        ${['Discovery','Filters','Enrichment','Concurrency','Options'].map((t,i)=>`<button class="tbtn${i===0?' on':''}" id="us-tab-${i}" onclick="usTabSwitch(${i})">${t}</button>`).join('')}
      </div>

      <!-- â”€â”€ TAB 0: DISCOVERY â”€â”€ -->
      <div id="us-panel-0">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">Seed URLs / Domains (one per line)</label>
              <textarea id="us-seeds" rows="7" placeholder="wordpress.com&#10;blogger.com&#10;https://example.com/blog/&#10;&#10;Footprints also supported:&#10;inurl:blog &quot;write for us&quot;&#10;&quot;powered by WordPress&quot; &quot;leave a comment&quot;"></textarea>
            </div>
            <div class="fg"><label class="lbl">Scrape Method</label>
              <select id="us-method">
                <option value="auto">ğŸ¤– Auto-Detect (Sitemap â†’ RSS â†’ Links)</option>
                <option value="sitemap">Sitemap Crawler (sitemap.xml + index)</option>
                <option value="sitemap_index">Sitemap Index Deep Crawler</option>
                <option value="rss">RSS Feed (autodiscover)</option>
                <option value="links">Page Link Extraction</option>
                <option value="pagination">Pagination Follower (/page/N/)</option>
                <option value="comment_feed">Comment Feed (WP ?feed=comments-rss2)</option>
                <option value="footprint">Footprint Expansion</option>
              </select>
            </div>
            <div class="g2">
              <div class="fg"><label class="lbl">Max URLs / Domain</label>
                <input type="number" id="us-max" value="50" min="1" max="1000"/></div>
              <div class="fg"><label class="lbl">Crawl Depth</label>
                <input type="number" id="us-depth" value="1" min="1" max="5" title="Follow internal links N levels deep"/></div>
            </div>
            <div class="g2">
              <div class="fg"><label class="lbl">Min Path Depth (segments)</label>
                <input type="number" id="us-min-path" value="1" min="0" max="10" title="Min URL path segments â€” e.g. 2 = /year/slug/"/></div>
              <div class="fg"><label class="lbl">Max Path Depth (segments)</label>
                <input type="number" id="us-max-path" value="6" min="1" max="20" title="Max URL path segments to accept"/></div>
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Footprint Template</label>
              <select id="us-footprint-tpl" onchange="us_applyFootprintTpl()">
                <option value="">â€” Choose footprint template â€”</option>
                <option value='inurl:blog "leave a comment"'>WP: Leave a Comment</option>
                <option value='"powered by WordPress" "leave a reply"'>WP: Leave a Reply</option>
                <option value='inurl:blog "add comment" -nofollow'>WP: Add Comment (dofollow)</option>
                <option value='"CommentLuv" inurl:blog'>CommentLuv Blogs</option>
                <option value='"This site uses Disqus" inurl:post'>Disqus-Enabled Posts</option>
                <option value='"powered by Ghost" inurl:blog'>Ghost CMS Blogs</option>
                <option value='inurl:blog "write for us" "guest post"'>Guest Post Targets</option>
                <option value='inurl:forum "reply" "register"'>Forum Post Targets</option>
                <option value='"Powered by Blogger" "Post a Comment"'>Blogger Comment Targets</option>
                <option value='inurl:blog "submit a comment" wordpress'>WP Submit Comment</option>
              </select>
            </div>
            <div class="fg"><label class="lbl">Published Within (days, 0=any)</label>
              <input type="number" id="us-pub-days" value="0" min="0" title="Only keep pages published within N days (requires date extraction)"/></div>
            <div class="fg"><label class="lbl">Min Word Count (0=any)</label>
              <input type="number" id="us-min-words" value="0" min="0" title="Minimum word count â€” filters thin/stub pages"/></div>
            <div class="fg"><label class="lbl">Crawl Rate (req/min/domain)</label>
              <input type="number" id="us-rate" value="30" min="1" max="120"/></div>
            <div class="fg"><label class="lbl">Min Domain Age (days)</label>
              <input type="number" id="us-minage" value="0" min="0"/></div>
            <div class="notice ni-b" style="font-size:10px;margin-top:4px">
              Auto-detect tries sitemap index â†’ sitemap.xml â†’ /feed/ (autodiscovered) â†’ link extraction in sequence. Footprint expansion converts Google operators into seed domains.
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 1: FILTERS â”€â”€ -->
      <div id="us-panel-1" style="display:none">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">URL Filter â€” Keyword OR Regex</label>
              <input type="text" id="us-filter" placeholder="blog|post|article  or  /\\/blog\\/\\d{4}\\//  (wrap regex in /)"/></div>
            <div class="fg"><label class="lbl">Domain Whitelist (one per line, blank=all)</label>
              <textarea id="us-whitelist" rows="4" placeholder="wordpress.com&#10;blogger.com"></textarea></div>
            <div class="fg"><label class="lbl">Domain Blacklist (one per line)</label>
              <textarea id="us-blacklist" rows="4" placeholder="spam.com&#10;example-bad.net"></textarea></div>
          </div>
          <div>
            <div class="fg"><label class="lbl">URL Scoring Rules (one per line)</label>
              <textarea id="us-score-rules" rows="5" placeholder="/blog/ +2&#10;/post/ +2&#10;/article/ +2&#10;/tag/ -1&#10;/category/ -1&#10;/author/ -1&#10;/page/ -1&#10;/archive/ -1"></textarea>
            </div>
            <div class="fg"><label class="lbl">Block Extensions (comma-separated)</label>
              <input type="text" id="us-block-ext" value=".xml,.css,.js,.png,.jpg,.jpeg,.gif,.svg,.ico,.woff,.woff2,.ttf,.pdf,.zip,.mp4,.mp3,.webm,.exe,.docx,.xlsx,.ppt"/></div>
            <div class="fg"><label class="lbl">Block Query Params (strip from URLs)</label>
              <input type="text" id="us-strip-params" value="utm_source,utm_medium,utm_campaign,utm_content,utm_term,fbclid,gclid,ref,source,via,page,p,start,offset,sid,sessionid"/></div>
            <div class="notice ni-y" style="font-size:10px">
              Scoring: paths matching rules get +/- points. Results sorted by score descending by default. Login-walled and canonical-mismatch pages are flagged but not removed.
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 2: ENRICHMENT â”€â”€ -->
      <div id="us-panel-2" style="display:none">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">Metadata Extraction</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-title" checked style="width:auto;accent-color:var(--green)"><span>Page title</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-meta-desc" checked style="width:auto;accent-color:var(--green)"><span>Meta description</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-og-tags" checked style="width:auto;accent-color:var(--green)"><span>Open Graph tags (og:type, og:title, og:site_name)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-pub-date" checked style="width:auto;accent-color:var(--green)"><span>Published date (article:published_time, JSON-LD)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-word-count" checked style="width:auto;accent-color:var(--green)"><span>Estimated word count</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-canonical-check" checked style="width:auto;accent-color:var(--green)"><span>Canonical URL check (flag mismatches)</span></label>
              </div>
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">CMS & Comment Detection</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-detect-cmt" checked style="width:auto;accent-color:var(--green)"><span>Detect comment-enabled pages</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-comment-system" checked style="width:auto;accent-color:var(--green)"><span>Identify comment system (WP native / Disqus / CommentLuv / Livefyre / Hyvor)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-detect-cms" checked style="width:auto;accent-color:var(--green)"><span>CMS fingerprint (WP/Blogger/Ghost/Drupal/Joomla/Wix)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-cms-version" checked style="width:auto;accent-color:var(--green)"><span>CMS version (WP generator tag)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-login-detect" checked style="width:auto;accent-color:var(--green)"><span>Login-wall detection (flag gated pages)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-http-check" style="width:auto;accent-color:var(--green)"><span>HTTP status check inline (HEAD per URL)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-robots-check" checked style="width:auto;accent-color:var(--green)"><span>Respect robots.txt (cache per domain)</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 3: CONCURRENCY â”€â”€ -->
      <div id="us-panel-3" style="display:none">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">Parallel Domain Workers</label>
              <input type="number" id="us-parallel" value="3" min="1" max="10" title="Number of domains scraped concurrently"/></div>
            <div class="fg"><label class="lbl">Per-URL Retries (exponential backoff)</label>
              <input type="number" id="us-retries" value="2" min="0" max="5"/></div>
            <div class="fg"><label class="lbl">Error Circuit Breaker (errors before skip domain)</label>
              <input type="number" id="us-circuit-break" value="3" min="1" max="10"/></div>
            <div class="fg"><label class="lbl">Fetch Timeout (seconds)</label>
              <input type="number" id="us-timeout" value="10" min="3" max="60"/></div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Proxy Rotation</label>
              <select id="us-proxy-mode">
                <option value="none">No proxies</option>
                <option value="round_robin">Round-robin (rotate per request)</option>
                <option value="per_domain">Per domain (1 proxy assigned per domain)</option>
                <option value="random">Random per request</option>
              </select>
            </div>
            <div class="notice ni-b" style="font-size:10px;margin-top:6px">
              <b>Circuit Breaker:</b> if N consecutive errors hit a domain, that domain is skipped and flagged.<br><br>
              <b>Backoff:</b> retry 1 = 1s delay, retry 2 = 3s delay.<br><br>
              <b>Parallel Workers:</b> each worker manages its own rate limit independently. Higher values increase speed but also detection risk.
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ TAB 4: OPTIONS â”€â”€ -->
      <div id="us-panel-4" style="display:none">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">URL Normalization</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-dedup" checked style="width:auto;accent-color:var(--green)"><span>Cross-session dedup (${dedupCount} seen URLs remembered)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-canon" checked style="width:auto;accent-color:var(--green)"><span>Canonicalize (strip www, UTM, trailing slashes)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-strip-qs-paged" checked style="width:auto;accent-color:var(--green)"><span>Strip pagination query strings (?page=, ?p=, ?start=)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-strip-session" checked style="width:auto;accent-color:var(--green)"><span>Strip session tokens (?sid=, ?sessionid=)</span></label>
              </div>
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Output Behavior</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-score-sort" checked style="width:auto;accent-color:var(--green)"><span>Auto-sort by score after scrape</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-skip-login" checked style="width:auto;accent-color:var(--green)"><span>Exclude login-walled pages from URL List export</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-skip-canonical" style="width:auto;accent-color:var(--green)"><span>Exclude canonical-mismatch pages from URL List export</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="us-append-mode" checked style="width:auto;accent-color:var(--green)"><span>Append to existing results (uncheck to overwrite)</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- â”€â”€ ACTIONS â”€â”€ -->
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_url_scraper()">â–¶ Start Scraping</button>
        <button class="tbtn stop" onclick="APP.stopFlag=true;log('Stop requested','warn')">â–  Stop</button>
        <div class="tb-sep"></div>
        <button class="tbtn" onclick="us_saveToList()">ğŸ’¾ â†’ URL List</button>
        <button class="tbtn" onclick="us_saveToList('commentluv')">â­ â†’ CommentLuv Only</button>
        <button class="tbtn" onclick="us_saveTaggedToList()">ğŸ· â†’ By Tag/CMS</button>
        <div class="tb-sep"></div>
        <button class="tbtn" onclick="us_export('txt')">ğŸ“¥ TXT</button>
        <button class="tbtn" onclick="us_export('csv')">ğŸ“Š CSV</button>
        <button class="tbtn" onclick="us_export('json')">ğŸ“¦ JSON</button>
        <div class="tb-sep"></div>
        <button class="tbtn" onclick="us_filterComments()">ğŸ’¬ Comment Pages</button>
        <button class="tbtn" onclick="us_clearSeen()">ğŸ—‘ Clear Cache</button>
        <button class="tbtn" onclick="us_clear()">ğŸ—‘ Clear All</button>
      </div>
      <div class="prog-wrap mt6"><div class="prog-fill" id="us-prog"></div></div>

      <!-- â”€â”€ NOTICES â”€â”€ -->
      ${cmtCount?`<div class="notice ni-g" style="margin-top:6px">ğŸ’¬ ${cmtCount} comment-enabled Â· ${clCount} CommentLuv (dofollow) Â· ${saved.filter(r=>r.cms).length} CMS fingerprints Â· ${loginBlocked} login-walled</div>`:''}
      ${canonIssues?`<div class="notice ni-y" style="margin-top:4px">âš  ${canonIssues} pages have canonical mismatches â€” these may not pass link equity. Check before submitting.</div>`:''}
    </div>
  </div>

  <!-- â”€â”€ RESULTS TABLE â”€â”€ -->
  ${saved.length?`
  <div class="panel">
    <div class="panel-head">Results
      <span class="badge bg" style="margin-left:4px">${saved.length}</span>
      <span class="badge bb" style="margin-left:4px">showing ${displayRows.length}</span>
      <div class="ph-r" style="gap:6px">
        <input type="text" placeholder="Filter resultsâ€¦" value="${esc(_usFilterText)}" oninput="_usFilterText=this.value;render_url_scraper(document.getElementById('page-url_scraper'))" style="width:160px;padding:2px 6px;font-size:10px"/>
        <label style="display:flex;align-items:center;gap:4px;font-size:10px;cursor:pointer;color:var(--text2)"><input type="checkbox" ${_usDedupeDisplay?'checked':''} onchange="_usDedupeDisplay=this.checked;render_url_scraper(document.getElementById('page-url_scraper'))" style="width:auto;accent-color:var(--green)"> 1/domain</label>
        <span class="mono xs tm">${okCount} OK Â· ${saved.filter(r=>r.status==='err').length} Err Â· ${cmtCount} ğŸ’¬</span>
      </div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr>
          ${thSort('url','URL')}
          ${thSort('title','Title')}
          ${thSort('cms','CMS')}
          ${thSort('cmsVersion','Ver')}
          ${thSort('commentSystem','Comment System')}
          ${thSort('score','Score')}
          ${thSort('wordCount','Words')}
          ${thSort('status','Status')}
          ${thSort('httpStatus','HTTP')}
          <th>Flags</th>
          ${thSort('publishedDate','Published')}
          ${thSort('tags','Tags')}
        </tr></thead>
        <tbody>${displayRows.map(r=>`<tr class="${r.loginRequired?'tr-login':''}${r.hasCanonical?' tr-canon':''}">
          <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.slice(0,45))}${r.url.length>45?'â€¦':''}</a></td>
          <td class="xs tm" style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(r.title||'')}">
            ${esc(r.title||'â€”')}
            ${r.desc?`<div style="font-size:9px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:130px" title="${esc(r.desc)}">${esc(r.desc.slice(0,60))}â€¦</div>`:''}
          </td>
          <td><span class="badge ${r.cms?'bb':'bgray'}">${esc(r.cms||'?')}</span></td>
          <td class="mono xs tm">${esc(r.cmsVersion||'')}</td>
          <td>${r.commentSystem?`<span class="badge ${r.commentSystem==='CommentLuv'?'by':r.commentSystem==='WordPress'?'bg':'bb'}" style="font-size:8px">${esc(r.commentSystem)}</span>`:'<span class="badge bgray" style="font-size:8px">â€”</span>'}</td>
          <td class="mono" style="text-align:center"><span class="badge ${(r.score||0)>=2?'bg':(r.score||0)>0?'by':'br'}">${r.score??0}</span></td>
          <td class="mono xs tm" style="text-align:right">${r.wordCount>0?r.wordCount.toLocaleString():'â€”'}</td>
          <td><span class="badge ${r.status==='ok'?'bg':'br'}">${r.status}</span></td>
          <td class="mono xs">${r.httpStatus?`<span class="${r.httpStatus<300?'sv-g':r.httpStatus<400?'sv-y':'sv-r'}">${r.httpStatus}</span>`:'â€”'}</td>
          <td style="white-space:nowrap">
            ${r.commentEnabled?'<span class="badge bg" style="font-size:8px">ğŸ’¬</span> ':'' }
            ${r.loginRequired?'<span class="badge br" style="font-size:8px">ğŸ”’</span> ':''}
            ${r.hasCanonical?'<span class="badge by" style="font-size:8px">â‰ can</span> ':''}
            ${r.robotsBlocked?'<span class="badge br" style="font-size:8px">ğŸ¤–</span> ':''}
            ${r.circuitBroken?'<span class="badge br" style="font-size:8px">âš¡</span> ':''}
          </td>
          <td class="mono xs tm">${esc(r.publishedDate||'')}</td>
          <td class="xs">${(r.tags||[]).map(t=>`<span class="badge bgray" style="font-size:8px">${esc(t)}</span>`).join(' ')}</td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>
  </div>

  <!-- â”€â”€ BULK TAG ACTION â”€â”€ -->
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">ğŸ· Bulk Tag / CMS Actions</div>
    <div class="panel-body">
      <div style="font-size:10px;color:var(--text3);margin-bottom:6px">Select a tag or CMS and send matching URLs directly to URL List or Campaign.</div>
      <div class="g3">
        <div class="fg"><label class="lbl">Filter by CMS</label>
          <select id="us-bulk-cms">
            <option value="">â€” Any CMS â€”</option>
            ${[...new Set(saved.map(r=>r.cms).filter(Boolean))].map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('')}
          </select>
        </div>
        <div class="fg"><label class="lbl">Filter by Comment System</label>
          <select id="us-bulk-cmtsys">
            <option value="">â€” Any â€”</option>
            ${[...new Set(saved.map(r=>r.commentSystem).filter(Boolean))].map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('')}
          </select>
        </div>
        <div class="fg"><label class="lbl">Filter by Niche Tag</label>
          <select id="us-bulk-tag">
            <option value="">â€” Any Tag â€”</option>
            ${[...new Set(saved.flatMap(r=>r.tags||[]))].map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="flex g6">
        <button class="tbtn go" onclick="us_bulkSendToList()">ğŸ’¾ â†’ URL List</button>
        <button class="tbtn" onclick="us_bulkExport('txt')">ğŸ“¥ Export TXT</button>
        <button class="tbtn" onclick="us_bulkExport('csv')">ğŸ“Š Export CSV</button>
        <span id="us-bulk-count" class="mono xs tm" style="margin-left:6px;align-self:center"></span>
      </div>
    </div>
  </div>`:''}

  <style>
    .tr-login td { opacity: 0.65; }
    .tr-canon td:first-child { border-left: 2px solid var(--yellow); }
    #us-tabs .tbtn.on { background: var(--sel-bg); color: #fff; border-color: var(--blue); }
  </style>`;

  // Init tab on/off style
  document.querySelectorAll('[id^="us-tab-"]').forEach(b=>b.classList.remove('on'));
  const activeTab = parseInt(el.dataset.activeTab||'0');
  const activeBtn = document.getElementById('us-tab-'+activeTab);
  if(activeBtn) activeBtn.classList.add('on');
  for(let i=0;i<5;i++) { const p=document.getElementById('us-panel-'+i); if(p) p.style.display = i===activeTab?'':'none'; }
}

function usTabSwitch(idx){
  const el = document.getElementById('page-url_scraper');
  el.dataset.activeTab = idx;
  document.querySelectorAll('[id^="us-tab-"]').forEach(b=>b.classList.remove('on'));
  const btn = document.getElementById('us-tab-'+idx);
  if(btn) btn.classList.add('on');
  for(let i=0;i<5;i++){ const p=document.getElementById('us-panel-'+i); if(p) p.style.display=i===idx?'':'none'; }
}

function usSetSort(col){
  if(_usSortCol===col) _usSortDir *= -1; else { _usSortCol=col; _usSortDir=-1; }
  render_url_scraper(document.getElementById('page-url_scraper'));
}

function us_applyFootprintTpl(){
  const sel = document.getElementById('us-footprint-tpl');
  const seeds = document.getElementById('us-seeds');
  if(sel&&seeds&&sel.value) {
    seeds.value = (seeds.value.trim()?seeds.value.trim()+'\n':'')+sel.value;
    log('Footprint template added to seeds','info');
  }
}

// Tag-based bulk send
function us_bulkSendToList(){
  const results = SS.get('rf_url_scraper_results',[]);
  const cms = (document.getElementById('us-bulk-cms')||{}).value||'';
  const cmtSys = (document.getElementById('us-bulk-cmtsys')||{}).value||'';
  const tag = (document.getElementById('us-bulk-tag')||{}).value||'';
  let filtered = results.filter(r=>r.status==='ok');
  if(cms) filtered = filtered.filter(r=>r.cms===cms);
  if(cmtSys) filtered = filtered.filter(r=>r.commentSystem===cmtSys);
  if(tag) filtered = filtered.filter(r=>(r.tags||[]).includes(tag));
  const urls = filtered.map(r=>r.url);
  APP.urlList = [...new Set([...APP.urlList,...urls])];
  SS.set('rf_urllist', APP.urlList);
  log(`Bulk send: ${urls.length} URLs â†’ URL List (CMS:${cms||'any'} CommentSys:${cmtSys||'any'} Tag:${tag||'any'})`, 'ok');
  updateStats();
  const cnt = document.getElementById('us-bulk-count');
  if(cnt) cnt.textContent = `${urls.length} URLs sent`;
}

function us_bulkExport(fmt){
  const results = SS.get('rf_url_scraper_results',[]);
  const cms = (document.getElementById('us-bulk-cms')||{}).value||'';
  const cmtSys = (document.getElementById('us-bulk-cmtsys')||{}).value||'';
  const tag = (document.getElementById('us-bulk-tag')||{}).value||'';
  let filtered = results.filter(r=>r.status==='ok');
  if(cms) filtered = filtered.filter(r=>r.cms===cms);
  if(cmtSys) filtered = filtered.filter(r=>r.commentSystem===cmtSys);
  if(tag) filtered = filtered.filter(r=>(r.tags||[]).includes(tag));
  if(fmt==='csv'){
    const hdr = 'URL,Title,CMS,CommentSystem,Score,Words,Tags\n';
    const rows = filtered.map(r=>[r.url,r.title||'',r.cms||'',r.commentSystem||'',r.score??0,r.wordCount||0,(r.tags||[]).join(';')].map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
    dlTxt(hdr+rows,'bulk_filtered_urls.csv');
  } else {
    dlTxt(filtered.map(r=>r.url).join('\n'),'bulk_filtered_urls.txt');
  }
  log(`Bulk export: ${filtered.length} URLs as ${fmt.toUpperCase()}`, 'ok');
}

function us_saveTaggedToList(){
  // Sends non-login-walled, score > 0, comment-enabled URLs
  const r = SS.get('rf_url_scraper_results',[]);
  const skipLogin = (document.getElementById('us-skip-login')||{checked:true}).checked;
  const skipCanon = (document.getElementById('us-skip-canonical')||{checked:false}).checked;
  let filtered = r.filter(x=>x.status==='ok'&&(x.score||0)>=0);
  if(skipLogin) filtered = filtered.filter(x=>!x.loginRequired);
  if(skipCanon) filtered = filtered.filter(x=>!x.hasCanonical);
  const urls = filtered.map(x=>x.url);
  APP.urlList = [...new Set([...APP.urlList,...urls])];
  SS.set('rf_urllist', APP.urlList);
  log(`Smart send: ${urls.length} URLs â†’ URL List (scoreâ‰¥0, skip-login:${skipLogin}, skip-canon:${skipCanon})`, 'ok');
  updateStats();
}

// URL canonicalization v2 â€” respects scraper strip settings
function canonicalizeUrl(url) {
  try {
    const u = new URL(url);
    u.hostname = u.hostname.replace(/^www\./,'');
    // Base tracking params always stripped
    const baseStrip = ['utm_source','utm_medium','utm_campaign','utm_content','utm_term','fbclid','gclid','ref','source','via'];
    // Pagination params
    const pageStrip = ['page','p','start','offset','paged','pg','pagenum'];
    // Session params
    const sessStrip = ['sid','sessionid','sess','token','_token','auth','s'];
    // Additional user-configured params from Filters tab
    const customStripRaw = (document.getElementById('us-strip-params')||{value:''}).value||'';
    const customStrip = customStripRaw.split(',').map(s=>s.trim()).filter(Boolean);
    const stripPaged = (document.getElementById('us-strip-qs-paged')||{checked:true}).checked;
    const stripSess = (document.getElementById('us-strip-session')||{checked:true}).checked;
    [...baseStrip, ...customStrip, ...(stripPaged?pageStrip:[]), ...(stripSess?sessStrip:[])].forEach(p=>u.searchParams.delete(p));
    let path = u.pathname.replace(/\/+$/,'') || '/';
    u.pathname = path;
    return u.origin.toLowerCase() + u.pathname + u.search;
  } catch(e) { return url; }
}

// Path depth counter
function urlPathDepth(url) {
  try { return new URL(url).pathname.split('/').filter(Boolean).length; } catch(e) { return 0; }
}

// Score URL by rules (from "URL Scoring Rules" textarea)
function scoreUrl(url, rulesText) {
  let score = 0;
  const rules = (rulesText||'').split('\n').map(l=>l.trim()).filter(Boolean);
  for(const rule of rules) {
    const m = rule.match(/^(.+?)\s+([+-]\d+)$/);
    if(!m) continue;
    const [,pattern,pts] = m;
    if(url.toLowerCase().includes(pattern.toLowerCase())) score += parseInt(pts);
  }
  return score;
}

// Default scoring rules string
const US_DEFAULT_SCORE_RULES = '/blog/ +2\n/post/ +2\n/article/ +2\n/news/ +1\n/tutorial/ +2\n/guide/ +1\n/tag/ -1\n/category/ -1\n/author/ -1\n/page/ -1\n/archive/ -1\n/search/ -2\n/cart/ -3\n/checkout/ -3\n/wp-admin/ -5\n/feed/ -2';

// Detect comment enabled from page HTML
function detectCommentEnabled(html, url) {
  if (!html) return false;
  return /wp-comments-post\.php|comment_post_ID|disqus_shortname|disquscdn|livefyre|#respond|id="comments"|class="comment-form"|hyvor-talk|giscus|facebook.*comments/i.test(html);
}

// Identify specific comment system
function detectCommentSystem(html, url) {
  if (!html) return null;
  if (/commentluv/i.test(html)) return 'CommentLuv';
  if (/disqus_shortname|disquscdn|disqus\.com/i.test(html)) return 'Disqus';
  if (/livefyre/i.test(html)) return 'Livefyre';
  if (/hyvor-talk/i.test(html)) return 'Hyvor';
  if (/giscus/i.test(html)) return 'Giscus';
  if (/facebook.*plugin.*comment|fb-comments/i.test(html)) return 'Facebook';
  if (/wp-comments-post\.php|comment_post_ID|#respond/i.test(html)) return 'WordPress';
  if (/disqus|comment/i.test(html)) return 'Generic';
  return null;
}

// Login wall detection
function detectLoginWall(html, url) {
  if (!html) return false;
  if (/wp-login\.php|\/login|\/signin|\/account\/login|members-only|subscriber.only|please.log.in|you.must.be.logged|register.to.comment/i.test(html+url)) return true;
  return false;
}

// Fingerprint CMS from HTML
function detectCMS(html, url) {
  if (!html) return null;
  if (/wp-content|wp-includes|xmlrpc\.php/i.test(html)) return 'WordPress';
  if (/blogger\.com|blogspot\.com/i.test(html+url)) return 'Blogger';
  if (/ghost\.io|content="Ghost/i.test(html)) return 'Ghost';
  if (/drupal\.org|Drupal\.settings/i.test(html)) return 'Drupal';
  if (/joomla/i.test(html)) return 'Joomla';
  if (/squarespace/i.test(html)) return 'Squarespace';
  if (/wix\.com/i.test(html)) return 'Wix';
  if (/shopify/i.test(html)) return 'Shopify';
  if (/webflow\.com/i.test(html)) return 'Webflow';
  if (/typo3/i.test(html)) return 'TYPO3';
  if (/weebly/i.test(html)) return 'Weebly';
  return null;
}

// Extract CMS version (currently WP-focused)
function detectCMSVersion(html, cms) {
  if (!html || !cms) return null;
  if (cms === 'WordPress') {
    // generator meta tag
    const m = html.match(/<meta[^>]+name=["']generator["'][^>]+content=["']WordPress\s*([\d.]+)["']/i);
    if (m) return m[1];
    // RSS generator
    const r = html.match(/<generator>https?:\/\/wordpress\.org\/\?v=([\d.]+)<\/generator>/i);
    if (r) return r[1];
    // wp-includes/js/wp-emoji-release.min.js?ver=X.X.X
    const j = html.match(/wp-(?:includes|content)[^"'?]*\?ver=([\d.]+)/i);
    if (j) return j[1];
  }
  if (cms === 'Ghost') {
    const m = html.match(/content="Ghost\s*([\d.]+)"/i);
    if (m) return m[1];
  }
  return null;
}

// Extract published date from multiple sources
function extractPublishedDate(html) {
  if (!html) return null;
  // article:published_time meta
  let m = html.match(/<meta[^>]+property=["']article:published_time["'][^>]+content=["']([^"']+)["']/i);
  if (m) return m[1].split('T')[0];
  // JSON-LD datePublished
  m = html.match(/"datePublished"\s*:\s*"([^"]+)"/i);
  if (m) return m[1].split('T')[0];
  // time[datetime] element
  m = html.match(/<time[^>]+datetime=["'](\d{4}-\d{2}-\d{2})[^"']*["']/i);
  if (m) return m[1];
  return null;
}

// Extract meta description
function extractMetaDesc(html) {
  if (!html) return null;
  const m = html.match(/<meta[^>]+name=["']description["'][^>]+content=["']([^"']{0,200})["']/i)
           || html.match(/<meta[^>]+content=["']([^"']{0,200})["'][^>]+name=["']description["']/i);
  return m ? m[1].trim() : null;
}

// Extract OG tags
function extractOGTags(html) {
  if (!html) return {};
  const og = {};
  const tags = ['og:type','og:title','og:site_name'];
  for(const tag of tags) {
    const m = html.match(new RegExp(`<meta[^>]+property=["']${tag}["'][^>]+content=["']([^"']{0,120})["']`,'i'));
    if (m) og[tag.split(':')[1]] = m[1].trim();
  }
  return og;
}

// Estimate word count from HTML
function estimateWordCount(html) {
  if (!html) return 0;
  // Strip scripts, styles, tags
  const text = html.replace(/<script[\s\S]*?<\/script>/gi,'')
                   .replace(/<style[\s\S]*?<\/style>/gi,'')
                   .replace(/<[^>]+>/g,' ')
                   .replace(/\s+/g,' ').trim();
  return text.split(' ').filter(w=>w.length>2).length;
}

// Extract canonical URL
function extractCanonical(html, pageUrl) {
  if (!html) return null;
  const m = html.match(/<link[^>]+rel=["']canonical["'][^>]+href=["']([^"']+)["']/i);
  return m ? m[1].trim() : null;
}

// Robots.txt cache (per session)
const ROBOTS_CACHE = {};
async function fetchRobotsTxt(domain, timeout=6000) {
  if (ROBOTS_CACHE[domain] !== undefined) return ROBOTS_CACHE[domain];
  try {
    const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://'+domain+'/robots.txt')}`, {signal:AbortSignal.timeout(timeout)});
    const d = await resp.json();
    ROBOTS_CACHE[domain] = d.contents || '';
    return ROBOTS_CACHE[domain];
  } catch(e) { ROBOTS_CACHE[domain] = ''; return ''; }
}

function isBlockedByRobots(robotsTxt, path) {
  if (!robotsTxt) return false;
  const lines = robotsTxt.split('\n').map(l=>l.trim());
  let inUserAgentAll = false;
  for(const line of lines) {
    if (/^user-agent:\s*\*/i.test(line)) { inUserAgentAll = true; continue; }
    if (/^user-agent:/i.test(line)) { inUserAgentAll = false; continue; }
    if (inUserAgentAll && /^disallow:/i.test(line)) {
      const disallowed = line.replace(/^disallow:\s*/i,'').trim();
      if (disallowed && path.startsWith(disallowed)) return true;
    }
  }
  return false;
}

// Parse sitemap XML â€” handles sitemap index + nested child sitemaps
function parseSitemapUrls(xml) {
  const urls = [];
  // Sitemap index: extract child sitemap URLs
  const sitemapLocs = xml.match(/<sitemap>[\s\S]*?<loc>([^<]+)<\/loc>[\s\S]*?<\/sitemap>/gi) || [];
  if (sitemapLocs.length) {
    for(const block of sitemapLocs) {
      const m = block.match(/<loc>([^<]+)<\/loc>/i);
      if (m) urls.push({ type:'sitemapChild', url: m[1].trim() });
    }
    return urls;
  }
  // Regular sitemap: <url><loc>...</loc></url>
  const urlBlocks = xml.match(/<url>[\s\S]*?<\/url>/gi) || [];
  for(const block of urlBlocks) {
    const locM = block.match(/<loc>([^<]+)<\/loc>/i);
    if (!locM) continue;
    const url = locM[1].trim();
    const lastmodM = block.match(/<lastmod>([^<]+)<\/lastmod>/i);
    urls.push({ type:'url', url, lastmod: lastmodM?lastmodM[1].trim():null });
  }
  // Fallback: any https?:// URL in the XML
  if (!urls.length) {
    const matches = xml.match(/https?:\/\/[^\s<>"']+/g) || [];
    return [...new Set(matches)].map(u=>({type:'url',url:u}));
  }
  return urls;
}

// Footprint â†’ seed domain expansion (simple heuristic)
function expandFootprint(fp) {
  // Return footprint as-is â€” in real use this would call SERP API
  // For now, log and treat as a regular seed
  log(`Footprint: "${fp.slice(0,60)}" â€” add SerpAPI key to auto-expand footprints`, 'info');
  return [];
}

// Tag by niche from title/content
function tagNiche(title, html) {
  const text = ((title||'') + ' ' + (html||'')).toLowerCase();
  const tags = [];
  const niches = {
    'Tech':['tech','software','app','coding','developer','programming'],
    'SEO':['seo','backlink','ranking','serp','keyword'],
    'Finance':['finance','invest','crypto','trading','money'],
    'Health':['health','fitness','diet','medical','wellness'],
    'Travel':['travel','vacation','trip','hotel','flight'],
    'Food':['food','recipe','cook','restaurant','dining'],
    'Business':['business','startup','entrepreneur','marketing'],
    'Education':['education','learn','course','tutorial','school'],
  };
  Object.entries(niches).forEach(([tag, kws]) => {
    if (kws.some(kw => text.includes(kw))) tags.push(tag);
  });
  return tags.slice(0,3);
}

// Regex-aware filter
function urlMatchesFilter(url, filterStr) {
  if (!filterStr) return true;
  if (filterStr.startsWith('/') && filterStr.endsWith('/')) {
    try { return new RegExp(filterStr.slice(1,-1),'i').test(url); } catch(e) { return url.includes(filterStr); }
  }
  return url.toLowerCase().includes(filterStr.toLowerCase());
}

async function start_url_scraper(){
  const seedsRaw = (document.getElementById('us-seeds')||{value:''}).value.trim();
  if(!seedsRaw){ log('Enter at least one seed URL/domain','err'); return; }
  const seeds = seedsRaw.split('\n').map(s=>s.trim()).filter(Boolean);

  const method         = (document.getElementById('us-method')||{value:'auto'}).value;
  const filterKw       = (document.getElementById('us-filter')||{value:''}).value.trim();
  const maxPer         = parseInt((document.getElementById('us-max')||{value:50}).value)||50;
  const crawlDepth     = parseInt((document.getElementById('us-depth')||{value:1}).value)||1;
  const crawlRate      = parseInt((document.getElementById('us-rate')||{value:30}).value)||30;
  const minPathDepth   = parseInt((document.getElementById('us-min-path')||{value:1}).value)||0;
  const maxPathDepth   = parseInt((document.getElementById('us-max-path')||{value:6}).value)||99;
  const pubDaysFilter  = parseInt((document.getElementById('us-pub-days')||{value:0}).value)||0;
  const minWords       = parseInt((document.getElementById('us-min-words')||{value:0}).value)||0;
  const parallelW      = parseInt((document.getElementById('us-parallel')||{value:3}).value)||3;
  const maxRetries     = parseInt((document.getElementById('us-retries')||{value:2}).value)||2;
  const circuitBreakN  = parseInt((document.getElementById('us-circuit-break')||{value:3}).value)||3;
  const fetchTimeout   = (parseInt((document.getElementById('us-timeout')||{value:10}).value)||10)*1000;
  const proxyMode      = (document.getElementById('us-proxy-mode')||{value:'none'}).value;
  const doDedup        = (document.getElementById('us-dedup')||{checked:true}).checked;
  const doCanon        = (document.getElementById('us-canon')||{checked:true}).checked;
  const doDetectCmt    = (document.getElementById('us-detect-cmt')||{checked:true}).checked;
  const doDetectCMS    = (document.getElementById('us-detect-cms')||{checked:true}).checked;
  const doCmsVersion   = (document.getElementById('us-cms-version')||{checked:true}).checked;
  const doCommentSys   = (document.getElementById('us-comment-system')||{checked:true}).checked;
  const doHttpCheck    = (document.getElementById('us-http-check')||{checked:false}).checked;
  const doTitle        = (document.getElementById('us-title')||{checked:true}).checked;
  const doMetaDesc     = (document.getElementById('us-meta-desc')||{checked:true}).checked;
  const doOgTags       = (document.getElementById('us-og-tags')||{checked:true}).checked;
  const doPubDate      = (document.getElementById('us-pub-date')||{checked:true}).checked;
  const doWordCount    = (document.getElementById('us-word-count')||{checked:true}).checked;
  const doCanonCheck   = (document.getElementById('us-canonical-check')||{checked:true}).checked;
  const doLoginDetect  = (document.getElementById('us-login-detect')||{checked:true}).checked;
  const doRobots       = (document.getElementById('us-robots-check')||{checked:true}).checked;
  const doScoreSort    = (document.getElementById('us-score-sort')||{checked:true}).checked;
  const appendMode     = (document.getElementById('us-append-mode')||{checked:true}).checked;

  const whitelistRaw = (document.getElementById('us-whitelist')||{value:''}).value.trim();
  const blacklistRaw = (document.getElementById('us-blacklist')||{value:''}).value.trim();
  const whitelist = whitelistRaw ? whitelistRaw.split('\n').map(s=>s.trim().toLowerCase()).filter(Boolean) : [];
  const blacklist = blacklistRaw ? blacklistRaw.split('\n').map(s=>s.trim().toLowerCase()).filter(Boolean) : [];

  const scoreRulesRaw = (document.getElementById('us-score-rules')||{value:US_DEFAULT_SCORE_RULES}).value || US_DEFAULT_SCORE_RULES;
  const blockExtRaw   = (document.getElementById('us-block-ext')||{value:'.xml,.css,.js'}).value||'';
  const blockExts     = blockExtRaw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);

  const prog = document.getElementById('us-prog');
  let results = appendMode ? SS.get('rf_url_scraper_results',[]) : [];
  const seen_all = doDedup ? SS.get('rf_url_scraper_seen', {}) : {};
  const minDelayMs = Math.round(60000 / crawlRate);

  APP.running = true; APP.stopFlag = false; setStatus('Scraping...');
  log(`URL Scraper v3: ${seeds.length} seeds | method:${method} | depth:${crawlDepth} | rate:${crawlRate}/min | workers:${parallelW}`, 'info');

  let processed = 0;
  const liveProxies = APP.proxies.filter(p=>p.status==='live');
  let proxyIdx = 0;

  function getProxy(domain) {
    if (!liveProxies.length || proxyMode==='none') return null;
    if (proxyMode==='random') return liveProxies[Math.floor(Math.random()*liveProxies.length)];
    if (proxyMode==='per_domain') {
      const hash = domain.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
      return liveProxies[hash%liveProxies.length];
    }
    // round_robin
    const p = liveProxies[proxyIdx % liveProxies.length];
    proxyIdx++;
    return p;
  }

  async function fetchWithRetry(url, opts={}, retries=maxRetries) {
    for(let attempt=0; attempt<=retries; attempt++) {
      try {
        const resp = await fetch(url, {...opts, signal: AbortSignal.timeout(fetchTimeout)});
        return resp;
      } catch(e) {
        if(attempt < retries) {
          const delay = attempt===0?1000:3000;
          log(`Retry ${attempt+1}/${retries} for ${url.slice(0,50)} in ${delay/1000}sâ€¦ (${e.message})`, 'warn');
          await sleep(delay);
        } else throw e;
      }
    }
  }

  async function fetchHtml(targetUrl) {
    const resp = await fetchWithRetry(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
    const d = await resp.json();
    return d.contents || '';
  }

  async function processSeed(seed) {
    if(APP.stopFlag) return;
    let seedUrl = seed.trim();
    if(!seedUrl.startsWith('http')) seedUrl = 'https://'+seedUrl;
    const domain = seedUrl.replace(/https?:\/\//,'').split('/')[0].toLowerCase().replace(/^www\./,'');

    if(whitelist.length && !whitelist.some(w=>domain.includes(w))){ log(`${domain} skipped â€” not in whitelist`,'warn'); return; }
    if(blacklist.some(b=>domain.includes(b))){ log(`${domain} skipped â€” blacklisted`,'warn'); return; }

    const proxy = getProxy(domain);
    if(proxy) log(`[Proxy] ${proxyLabel(proxy)} â†’ ${domain}`, 'info');

    // Robots.txt check
    let robotsTxt = '';
    if(doRobots) {
      robotsTxt = await fetchRobotsTxt(domain, fetchTimeout);
      if(robotsTxt) log(`${domain}: robots.txt loaded`, 'info');
    }

    // Auto-detect method
    let effectiveMethod = method;
    if(method==='auto') effectiveMethod = 'sitemap'; // will cascade below

    let urlsToProcess = [seedUrl];
    const allFoundUrls = [];
    let domainErrors = 0;

    // â”€â”€ SITEMAP INDEX â”€â”€
    if(method==='auto' || method==='sitemap' || method==='sitemap_index') {
      try {
        log(`${domain}: trying sitemap indexâ€¦`, 'info');
        const sitemapIndexXml = await fetchHtml(seedUrl+'/sitemap_index.xml');
        const parsed = parseSitemapUrls(sitemapIndexXml);
        const children = parsed.filter(p=>p.type==='sitemapChild');
        if(children.length) {
          log(`${domain}: sitemap index â†’ ${children.length} child sitemaps`, 'info');
          for(const child of children.slice(0,10)) {
            if(APP.stopFlag) break;
            try {
              const childXml = await fetchHtml(child.url);
              const childUrls = parseSitemapUrls(childXml).filter(p=>p.type==='url');
              allFoundUrls.push(...childUrls.map(p=>({url:p.url, lastmod:p.lastmod})));
            } catch(e) { /* skip child */ }
          }
          if(allFoundUrls.length) { effectiveMethod='sitemap_index'; }
        }
      } catch(e) { /* no sitemap index */ }

      if(!allFoundUrls.length) {
        // Try regular sitemap.xml
        try {
          log(`${domain}: trying sitemap.xmlâ€¦`, 'info');
          const sitemapXml = await fetchHtml(seedUrl+'/sitemap.xml');
          const parsed = parseSitemapUrls(sitemapXml).filter(p=>p.type==='url');
          allFoundUrls.push(...parsed.map(p=>({url:p.url, lastmod:p.lastmod})));
          if(allFoundUrls.length) effectiveMethod='sitemap';
        } catch(e) { /* skip */ }
      }
    }

    // â”€â”€ RSS (with autodiscovery) â”€â”€
    if((method==='auto' && !allFoundUrls.length) || method==='rss') {
      try {
        log(`${domain}: autodiscovering RSS feedâ€¦`, 'info');
        let feedUrl = null;
        // Try to get the homepage and find link[rel=alternate]
        const pageHtml = await fetchHtml(seedUrl);
        const altM = pageHtml.match(/<link[^>]+type=["']application\/rss\+xml["'][^>]+href=["']([^"']+)["']/i)
                  || pageHtml.match(/<link[^>]+href=["']([^"']+)["'][^>]+type=["']application\/rss\+xml["']/i);
        if(altM) { feedUrl = altM[1]; if(!feedUrl.startsWith('http')) feedUrl = 'https://'+domain+feedUrl; }
        if(!feedUrl) feedUrl = seedUrl + '/feed/';
        const rssXml = await fetchHtml(feedUrl);
        const matches = rssXml.match(/https?:\/\/[^\s<>"']+/g) || [];
        const rssUrls = [...new Set(matches)].filter(u=>u.includes(domain));
        allFoundUrls.push(...rssUrls.map(u=>({url:u, lastmod:null})));
        if(allFoundUrls.length) effectiveMethod='rss';
        log(`${domain}: RSS â†’ ${rssUrls.length} URLs`, 'info');
      } catch(e) { /* skip */ }
    }

    // â”€â”€ COMMENT FEED â”€â”€
    if(method==='comment_feed') {
      try {
        const feedXml = await fetchHtml(seedUrl+'/?feed=comments-rss2');
        const commentUrls = (feedXml.match(/https?:\/\/[^\s<>"']+/g)||[]).filter(u=>u.includes(domain));
        allFoundUrls.push(...[...new Set(commentUrls)].map(u=>({url:u})));
        // Try to extract comment counts from items
        const items = feedXml.match(/<item>[\s\S]*?<\/item>/gi)||[];
        log(`${domain}: comment feed â†’ ${commentUrls.length} URLs, ${items.length} items`, 'info');
        effectiveMethod='comment_feed';
      } catch(e) { /* skip */ }
    }

    // â”€â”€ FOOTPRINT â”€â”€
    if(method==='footprint') {
      const expanded = expandFootprint(seedUrl);
      allFoundUrls.push(...expanded.map(u=>({url:u})));
    }

    // â”€â”€ PAGINATION FOLLOWER â”€â”€
    if(method==='pagination' || (method==='auto' && !allFoundUrls.length)) {
      try {
        for(let pg=1; pg<=Math.min(crawlDepth*10, 30); pg++) {
          if(APP.stopFlag) break;
          const pageUrl = seedUrl.replace(/\/+$/,'') + '/page/' + pg + '/';
          try {
            const html = await fetchHtml(pageUrl);
            if(!html || html.length < 200) break;
            const links = (html.match(/href="(https?:\/\/[^"]+)"/g)||[]).map(m=>m.slice(6,-1));
            const internal = [...new Set(links)].filter(u=>u.includes(domain));
            if(!internal.length) break;
            allFoundUrls.push(...internal.map(u=>({url:u})));
            await sleep(minDelayMs);
          } catch(e) { break; }
        }
        if(allFoundUrls.length) effectiveMethod='pagination';
      } catch(e) { /* skip */ }
    }

    // â”€â”€ PAGE LINK EXTRACTION (fallback / depth crawl) â”€â”€
    if((method==='auto' && !allFoundUrls.length) || method==='links') {
      try {
        log(`${domain}: link extraction, depth ${crawlDepth}â€¦`, 'info');
        let toCrawl = [seedUrl];
        const visited = new Set();
        for(let depth=0; depth<crawlDepth; depth++) {
          const nextLevel = [];
          for(const currentUrl of toCrawl) {
            if(APP.stopFlag||domainErrors>=circuitBreakN) break;
            if(visited.has(currentUrl)) continue;
            visited.add(currentUrl);
            try {
              await sleep(minDelayMs);
              const html = await fetchHtml(currentUrl);
              const links = (html.match(/href="(https?:\/\/[^"]+)"/g)||[]).map(m=>m.slice(6,-1));
              const clean = [...new Set(links)].filter(u=>u.includes(domain));
              allFoundUrls.push(...clean.map(u=>({url:u})));
              if(depth<crawlDepth-1) nextLevel.push(...clean.filter(u=>!visited.has(u)).slice(0,10));
            } catch(e) {
              domainErrors++;
              if(domainErrors>=circuitBreakN) { log(`${domain}: circuit breaker tripped (${domainErrors} errors)`, 'warn'); break; }
            }
          }
          toCrawl = [...new Set(nextLevel)];
          if(!toCrawl.length) break;
        }
        if(allFoundUrls.length) effectiveMethod='links';
      } catch(e) { /* skip */ }
    }

    log(`${domain} [${effectiveMethod}]: ${allFoundUrls.length} raw URLs found`, 'info');

    // â”€â”€ URL PROCESSING â”€â”€
    let finalUrls = allFoundUrls.map(u=>typeof u==='string'?{url:u}:u);

    // Filter extensions
    finalUrls = finalUrls.filter(u=>{
      const url = u.url;
      if(!url||!url.startsWith('http')) return false;
      if(blockExts.some(ext=>url.toLowerCase().includes(ext))) return false;
      if(!urlMatchesFilter(url, filterKw)) return false;
      if(blacklist.some(b=>url.toLowerCase().includes(b))) return false;
      if(whitelist.length && !whitelist.some(w=>url.toLowerCase().includes(w)) && !url.includes(domain)) return false;
      return true;
    });

    // Path depth filter
    finalUrls = finalUrls.filter(u=>{
      const d = urlPathDepth(u.url);
      return d>=minPathDepth && d<=maxPathDepth;
    });

    // Canonicalize
    if(doCanon) finalUrls = finalUrls.map(u=>({...u, url:canonicalizeUrl(u.url)}));
    finalUrls = finalUrls.filter((u,i,a)=>a.findIndex(x=>x.url===u.url)===i);

    // Robots.txt filter
    if(doRobots && robotsTxt) {
      finalUrls = finalUrls.filter(u=>{
        try { const path=new URL(u.url).pathname; return !isBlockedByRobots(robotsTxt, path); } catch(e){return true;}
      });
    }

    // Cross-session dedup
    if(doDedup) finalUrls = finalUrls.filter(u=>!seen_all[u.url]);

    // Truncate to maxPer
    finalUrls = finalUrls.slice(0, maxPer);

    // â”€â”€ ENRICH EACH URL â”€â”€
    let cmtInDomain = 0;
    for(const urlObj of finalUrls) {
      if(APP.stopFlag) break;
      const url = urlObj.url;
      if(doDedup) seen_all[url] = 1;

      const entry = { url, source:domain, method:effectiveMethod, status:'ok', date:today() };
      if(urlObj.lastmod) entry.publishedDate = urlObj.lastmod.split('T')[0];

      // Score URL
      entry.score = scoreUrl(url, scoreRulesRaw);

      // Per-URL: try to fetch HTML for enrichment if any enrichment flags on
      const needsFetch = doTitle||doDetectCMS||doDetectCmt||doPubDate||doWordCount||doCanonCheck||doLoginDetect||doMetaDesc||doOgTags||doCommentSys||doCmsVersion;
      let pageHtml = '';
      let fetchFailed = false;
      if(needsFetch) {
        try {
          await sleep(Math.round(minDelayMs/2));
          pageHtml = await fetchHtml(url);
        } catch(e) { fetchFailed = true; entry.status='err'; }
      }

      if(pageHtml) {
        if(doDetectCMS) {
          entry.cms = detectCMS(pageHtml, url) || null;
          if(doCmsVersion && entry.cms) entry.cmsVersion = detectCMSVersion(pageHtml, entry.cms);
        }
        if(doDetectCmt) entry.commentEnabled = detectCommentEnabled(pageHtml, url);
        if(doCommentSys) entry.commentSystem = detectCommentSystem(pageHtml, url);
        if(doTitle) {
          const tm = pageHtml.match(/<title[^>]*>([^<]+)<\/title>/i);
          entry.title = tm ? tm[1].trim().slice(0,80) : null;
        }
        if(doMetaDesc) entry.desc = extractMetaDesc(pageHtml);
        if(doOgTags) { const og = extractOGTags(pageHtml); Object.assign(entry, og); }
        if(doPubDate && !entry.publishedDate) entry.publishedDate = extractPublishedDate(pageHtml);
        if(doWordCount) entry.wordCount = estimateWordCount(pageHtml);
        if(doCanonCheck) {
          const canon = extractCanonical(pageHtml, url);
          if(canon && canon!==url && canonicalizeUrl(canon)!==canonicalizeUrl(url)) {
            entry.hasCanonical = true;
            entry.canonicalUrl = canon;
          }
        }
        if(doLoginDetect) entry.loginRequired = detectLoginWall(pageHtml, url);
        entry.tags = tagNiche(entry.title, pageHtml);
      }

      // Published date filter
      if(pubDaysFilter>0 && entry.publishedDate) {
        const pubMs = new Date(entry.publishedDate).getTime();
        if(!isNaN(pubMs) && (Date.now()-pubMs)>pubDaysFilter*86400000) continue;
      }

      // Word count filter
      if(minWords>0 && (entry.wordCount||0)<minWords) continue;

      // HTTP status check
      if(doHttpCheck && !fetchFailed) {
        try {
          const headResp = await fetchWithRetry(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, {}, 1);
          entry.httpStatus = headResp.ok ? 200 : 0;
        } catch(e) { entry.httpStatus = 0; }
      }

      if(entry.commentEnabled || entry.commentSystem) cmtInDomain++;
      if(domainErrors>=circuitBreakN) { entry.circuitBroken=true; entry.status='err'; }
      results.push(entry);
    }

    // Score-sort if enabled
    if(doScoreSort) results.sort((a,b)=>(b.score||0)-(a.score||0));

    APP.stats.success++; processed++;
    const prog = document.getElementById('us-prog');
    if(prog) prog.style.width = Math.round((processed/seeds.length)*100)+'%';
    setProgress(Math.round((processed/seeds.length)*100), `${processed}/${seeds.length}`);
    log(`${domain} â†’ ${finalUrls.length} URLs${cmtInDomain?' Â· '+cmtInDomain+' comment':''} [${effectiveMethod}]`, 'ok');
  }

  // â”€â”€ PARALLEL WORKER POOL â”€â”€
  const semaphore = [...seeds];
  const workers = Array.from({length:Math.min(parallelW,seeds.length)}, async ()=>{
    while(semaphore.length && !APP.stopFlag) {
      const seed = semaphore.shift();
      if(seed) {
        try { await processSeed(seed); } catch(e) { log(`${seed}: fatal error â€” ${e.message}`, 'err'); APP.stats.failed++; }
      }
    }
  });

  await Promise.all(workers);

  if(doDedup) SS.set('rf_url_scraper_seen', seen_all);
  SS.set('rf_url_scraper_results', results);
  setStatus('Done'); APP.running = false;
  const cmtTotal = results.filter(r=>r.commentEnabled).length;
  const clTotal = results.filter(r=>r.commentSystem==='CommentLuv').length;
  log(`Scrape complete â€” ${results.length} URLs Â· ${cmtTotal} comment-enabled Â· ${clTotal} CommentLuv`, 'ok');
  render_url_scraper(document.getElementById('page-url_scraper'));
}

function us_saveToList(filter=''){
  const r = SS.get('rf_url_scraper_results',[]);
  const skipLogin = (document.getElementById('us-skip-login')||{checked:true}).checked;
  const skipCanon = (document.getElementById('us-skip-canonical')||{checked:false}).checked;
  let filtered = r.filter(x=>x.status==='ok');
  if(filter==='commentluv') filtered = filtered.filter(x=>x.commentSystem==='CommentLuv');
  if(skipLogin) filtered = filtered.filter(x=>!x.loginRequired);
  if(skipCanon) filtered = filtered.filter(x=>!x.hasCanonical);
  const urls = filtered.map(x=>x.url);
  APP.urlList = [...new Set([...APP.urlList,...urls])];
  SS.set('rf_urllist', APP.urlList);
  log(`Saved ${urls.length} URLs â†’ URL List${filter?' ('+filter+')':''}`, 'ok');
  updateStats();
}
function us_export(fmt='txt'){
  const r = SS.get('rf_url_scraper_results',[]);
  if(fmt==='csv'){
    const hdr='URL,Title,Description,CMS,CMS_Version,Comment_System,Comment_Enabled,Score,Word_Count,Published_Date,HTTP_Status,Login_Required,Canonical_Mismatch,Canonical_URL,OG_Type,Method,Source,Tags,Date\n';
    const rows=r.map(x=>[
      x.url, x.title||'', x.desc||'', x.cms||'', x.cmsVersion||'',
      x.commentSystem||'', x.commentEnabled?'yes':'no',
      x.score??0, x.wordCount||0, x.publishedDate||'',
      x.httpStatus||'', x.loginRequired?'yes':'no',
      x.hasCanonical?'yes':'no', x.canonicalUrl||'',
      x.type||'', x.method||'', x.source||'',
      ((x.tags||[]).join(';')), x.date||''
    ].map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
    dlTxt(hdr+rows,'scraped_urls.csv');
  } else if(fmt==='json'){
    dlTxt(JSON.stringify(r,null,2),'scraped_urls.json');
  } else {
    dlTxt(r.map(x=>x.url).join('\n'),'scraped_urls.txt');
  }
  log(`Exported ${r.length} URLs as ${fmt.toUpperCase()}`,'ok');
}
function us_filterComments(){ const r=SS.get('rf_url_scraper_results',[]); const cmt=r.filter(x=>x.commentEnabled); dlTxt(cmt.map(x=>x.url).join('\n'),'comment_enabled_urls.txt'); log(`Exported ${cmt.length} comment-enabled URLs`,'ok'); }
function us_clearSeen(){ SS.set('rf_url_scraper_seen',{}); log('Cross-session URL cache cleared','warn'); render_url_scraper(document.getElementById('page-url_scraper')); }
function us_clear(){ SS.set('rf_url_scraper_results',[]); render_url_scraper(document.getElementById('page-url_scraper')); log('Results cleared','warn'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERP SCRAPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_serp_scraper(el){
  const results = SS.get('rf_serp_results',[]);
  const history = SS.get('rf_serp_history',[]);
  const ssTab = SS.raw('rf_ss_tab','results');

  // Domain frequency map
  const domFreq = {};
  results.forEach(r=>{ try{ const h=new URL(r.url).hostname.replace(/^www\./,''); domFreq[h]=(domFreq[h]||0)+1; }catch(e){} });
  const domFreqSorted = Object.entries(domFreq).sort((a,b)=>b[1]-a[1]);

  // Historical diff vs last run
  const lastRun = history.length ? history[history.length-1] : null;
  const lastUrls = lastRun ? new Set(lastRun.results.map(r=>r.url)) : new Set();
  const newUrls = results.filter(r=>!lastUrls.has(r.url));
  const droppedUrls = lastRun ? lastRun.results.filter(r=>!results.find(x=>x.url===r.url)) : [];

  // Keyword overlap matrix (which URLs rank for multiple keywords)
  const urlKwMap = {};
  results.forEach(r=>{ if(!urlKwMap[r.url]) urlKwMap[r.url]=[]; if(!urlKwMap[r.url].includes(r.keyword)) urlKwMap[r.url].push(r.keyword); });
  const multiKwUrls = Object.entries(urlKwMap).filter(([,kws])=>kws.length>1).sort((a,b)=>b[1].length-a[1].length);

  el.innerHTML = `
  <div class="panel">
    <div class="panel-head">ğŸŒ SERP Scraper <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Position Â· Competitors Â· Gap Analysis Â· History</span></div>
    <div class="panel-body">
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Keywords (one per line)</label>
            <textarea id="ss-kws" rows="5" placeholder="best VPN 2025&#10;cheap VPN services&#10;VPN for streaming"></textarea></div>
        </div>
        <div>
          <div class="fg"><label class="lbl">Results to Fetch</label>
            <select id="ss-num"><option value="10">Top 10</option><option value="20">Top 20</option><option value="50">Top 50</option><option value="100">Top 100</option></select></div>
          <div class="fg"><label class="lbl">Search Engine</label>
            <select id="ss-engine"><option value="ddg">DuckDuckGo</option><option value="bing">Bing</option></select></div>
          <div class="fg"><label class="lbl">SerpAPI Key (optional â€” for Google results)</label>
            <input type="password" id="ss-apikey" placeholder="Leave blank for DuckDuckGo/Bing" value="${SS.raw('rf_serpapi_key')}"/></div>
          <div class="fg"><label class="lbl">Exclude Domains (comma-separated)</label>
            <input type="text" id="ss-exclude" placeholder="wikipedia.org, amazon.com, youtube.com"/></div>
        </div>
      </div>
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_serp_scraper()">â–¶ Scrape SERPs</button>
        <button class="tbtn" onclick="ss_saveSnapshot()">ğŸ“¸ Save Snapshot</button>
        <div class="tb-sep"></div>
        <button class="tbtn" onclick="ss_toList()">ğŸ’¾ â†’ URL List</button>
        <button class="tbtn" onclick="ss_toCommenter()">ğŸ’¬ â†’ Commenter</button>
        <button class="tbtn" onclick="ss_export()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="ss_clear()">ğŸ—‘ Clear</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="ss-prog"></div></div>
    </div>
  </div>

  ${results.length ? `
  <div style="display:flex;gap:2px;margin-bottom:0">
    ${[
      ['results',`ğŸ”— Results <span class="badge bg">${results.length}</span>`],
      ['competitors',`ğŸ† Competitors <span class="badge by">${domFreqSorted.length}</span>`],
      ['gaps',`ğŸ”€ Keyword Gaps <span class="badge" style="background:var(--purple)">${multiKwUrls.length}</span>`],
      ['history',`ğŸ“ˆ History <span class="badge bgray">${history.length} runs</span>`],
    ].map(([t,l])=>`<button class="tbtn${ssTab===t?' go':''}" onclick="SS.rawSet('rf_ss_tab','${t}');render_serp_scraper(document.getElementById('page-serp_scraper'))" style="font-size:10px">${l}</button>`).join('')}
  </div>

  ${ssTab==='results'?`
  <div class="panel"><div class="panel-head">SERP Results <span class="badge bg">${results.length}</span>
    <div class="ph-r" style="display:flex;gap:4px;align-items:center">
      ${newUrls.length?`<span class="badge bg">+${newUrls.length} new</span>`:''}
      ${droppedUrls.length?`<span class="badge br">-${droppedUrls.length} dropped</span>`:''}
      <span style="font-size:10px;color:var(--text3)">Sort:</span>
      <select style="font-size:10px" onchange="SS.rawSet('rf_ss_sort',this.value);render_serp_scraper(document.getElementById('page-serp_scraper'))">
        <option value="pos" ${SS.raw('rf_ss_sort','pos')==='pos'?'selected':''}>Position</option>
        <option value="kw" ${SS.raw('rf_ss_sort','pos')==='kw'?'selected':''}>Keyword</option>
        <option value="dom" ${SS.raw('rf_ss_sort','pos')==='dom'?'selected':''}>Domain</option>
      </select>
    </div>
  </div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>#</th><th>URL</th><th>Domain</th><th>Keyword</th><th>Engine</th><th>Date</th><th>Î”</th></tr></thead>
    <tbody>${(()=>{
      let rows=[...results];
      const sort=SS.raw('rf_ss_sort','pos');
      if(sort==='kw') rows.sort((a,b)=>a.keyword.localeCompare(b.keyword));
      else if(sort==='dom') rows.sort((a,b)=>{
        try{return new URL(a.url).hostname.localeCompare(new URL(b.url).hostname)}catch(e){return 0}
      });
      return rows.slice(0,200).map(r=>{
        let domain=''; try{domain=new URL(r.url).hostname.replace(/^www\./,'');}catch(e){}
        const isNew=!lastUrls.has(r.url)&&lastRun;
        const freq=domFreq[domain]||1;
        return `<tr${isNew?' style="background:rgba(57,211,83,.06)"':''}>
          <td class="mono xs tm" style="color:${r.position<=3?'var(--green)':r.position<=10?'var(--yellow)':'var(--text3)'}">#${r.position||'?'}</td>
          <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.length>55?r.url.slice(0,55)+'â€¦':r.url)}</a></td>
          <td class="xs tm" style="color:${freq>=3?'var(--yellow)':''}">${esc(domain)}${freq>1?` <span class="badge bgray" style="font-size:8px">Ã—${freq}</span>`:''}</td>
          <td class="xs">${esc(r.keyword)}</td>
          <td><span class="badge bgray">${esc(r.engine)}</span></td>
          <td class="mono xs tm">${esc(r.date||'â€”')}</td>
          <td class="mono xs tm" style="color:${isNew?'var(--green)':'var(--text3)'}">${isNew?'â–² NEW':''}</td>
        </tr>`;}).join('');
    })()}</tbody>
  </table></div></div></div>` : ''}

  ${ssTab==='competitors'?`
  <div class="panel"><div class="panel-head">ğŸ† Competitor Domain Frequency</div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>Domain</th><th>Appearances</th><th>Share</th><th>Keywords Ranking For</th></tr></thead>
    <tbody>${domFreqSorted.slice(0,100).map(([dom,cnt])=>{
      const kws=[...new Set(results.filter(r=>{try{return new URL(r.url).hostname.replace(/^www\./,'')==dom}catch(e){return false}}).map(r=>r.keyword))];
      const share=Math.round(cnt/results.length*100);
      const bar=`<div style="display:inline-block;width:${Math.min(share*3,100)}px;height:6px;background:var(--green);opacity:.7;border-radius:2px;vertical-align:middle;margin-left:6px"></div>`;
      return `<tr>
        <td class="mono xs"><a href="https://${esc(dom)}" target="_blank">${esc(dom)}</a></td>
        <td class="mono xs tm" style="color:${cnt>=5?'var(--green)':cnt>=3?'var(--yellow)':'var(--text2)'}">${cnt}</td>
        <td class="xs tm">${share}%${bar}</td>
        <td class="xs" style="max-width:300px">${kws.slice(0,5).map(k=>`<span class="chip" style="font-size:9px;padding:1px 5px">${esc(k)}</span>`).join(' ')}${kws.length>5?` +${kws.length-5}`:''}</td>
      </tr>`;}).join('')}
    </tbody></table></div></div></div>` : ''}

  ${ssTab==='gaps'?`
  <div class="panel"><div class="panel-head">ğŸ”€ Keyword Gap â€” URLs Ranking for Multiple Keywords</div>
  <div class="panel-body" style="padding:0">
    ${multiKwUrls.length ? `<div class="tbl-wrap"><table>
      <thead><tr><th>URL</th><th>Keywords</th><th>Count</th></tr></thead>
      <tbody>${multiKwUrls.slice(0,100).map(([url,kws])=>`<tr>
        <td class="mono xs"><a href="${esc(url)}" target="_blank">${esc(url.length>55?url.slice(0,55)+'â€¦':url)}</a></td>
        <td class="xs">${kws.map(k=>`<span class="chip" style="font-size:9px;padding:1px 5px">${esc(k)}</span>`).join(' ')}</td>
        <td class="mono xs tm" style="color:var(--green);font-weight:700">${kws.length}</td>
      </tr>`).join('')}</tbody>
    </table></div>` : `<div style="padding:12px;color:var(--text3);font-size:11px">Scrape multiple keywords to see which competitor URLs rank across all of them â€” those are your primary targets.</div>`}
  </div></div>` : ''}

  ${ssTab==='history'?`
  <div class="panel"><div class="panel-head">ğŸ“ˆ Scrape History <span class="badge bgray">${history.length} snapshots</span>
    <div class="ph-r"><button class="tbtn" style="font-size:10px" onclick="SS.set('rf_serp_history',[]);render_serp_scraper(document.getElementById('page-serp_scraper'))">ğŸ—‘ Clear History</button></div>
  </div>
  <div class="panel-body" style="padding:0">
    ${history.length ? `<div class="tbl-wrap"><table>
      <thead><tr><th>Date</th><th>Keywords</th><th>URLs</th><th>Engine</th><th>vs Prior</th></tr></thead>
      <tbody>${[...history].reverse().map((snap,i,arr)=>{
        const prior=arr[i+1];
        const newC=prior?snap.results.filter(r=>!prior.results.find(x=>x.url===r.url)).length:0;
        const dropC=prior?prior.results.filter(r=>!snap.results.find(x=>x.url===r.url)).length:0;
        return `<tr>
          <td class="mono xs">${esc(snap.date)}</td>
          <td class="xs tm">${[...new Set(snap.results.map(r=>r.keyword))].slice(0,3).join(', ')}${snap.results.length>3?'â€¦':''}</td>
          <td class="mono xs tm">${snap.results.length}</td>
          <td><span class="badge bgray">${snap.engine||'DDG'}</span></td>
          <td class="mono xs tm">${prior?`<span style="color:var(--green)">+${newC}</span> / <span style="color:var(--red)">-${dropC}</span>`:'â€”'}</td>
        </tr>`;}).join('')}
      </tbody></table></div>` : `<div style="padding:12px;color:var(--text3);font-size:11px">No snapshots yet. Click "Save Snapshot" after a scrape to track changes over time.</div>`}
  </div></div>` : ''}
  ` : ''}`;
}

async function start_serp_scraper(){
  const kwsRaw = (document.getElementById('ss-kws')||{value:''}).value.trim();
  if(!kwsRaw){ log('Enter keywords','err'); return; }
  const kws = kwsRaw.split('\n').map(k=>k.trim()).filter(Boolean);
  const engine = (document.getElementById('ss-engine')||{value:'ddg'}).value;
  const apiKey = (document.getElementById('ss-apikey')||{value:''}).value.trim();
  const excludeRaw = (document.getElementById('ss-exclude')||{value:''}).value.trim();
  const excludeDomains = excludeRaw?excludeRaw.split(',').map(d=>d.trim().toLowerCase()).filter(Boolean):[];
  if(apiKey) SS.rawSet('rf_serpapi_key', apiKey);
  const prog = document.getElementById('ss-prog');
  const results = [];
  APP.running = true; APP.stopFlag = false; setStatus('Scraping SERPs...');
  for(let i=0;i<kws.length;i++){
    if(APP.stopFlag) break;
    const kw = kws[i];
    if(prog) prog.style.width = Math.round(((i+1)/kws.length)*100)+'%';
    setProgress(Math.round(((i+1)/kws.length)*100), `${i+1} / ${kws.length}`);
    log(`Scraping SERP: ${kw}`,'info');
    try{
      let urlsWithPos = [];
      if(apiKey){
        const resp = await fetch(`https://serpapi.com/search.json?q=${encodeURIComponent(kw)}&api_key=${apiKey}&num=50`);
        const data = await resp.json();
        urlsWithPos = (data.organic_results||[]).map((r,idx)=>({url:r.link,position:idx+1})).filter(x=>x.url);
        log(`${kw} â†’ ${urlsWithPos.length} results via SerpAPI`,'ok');
      } else {
        const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://html.duckduckgo.com/html/?q='+encodeURIComponent(kw))}`, {signal:AbortSignal.timeout(10000)});
        const data = await resp.json();
        const html = data.contents||'';
        const matches = html.match(/uddg=([^&"]+)/g)||[];
        const urls = [...new Set(matches.map(m=>decodeURIComponent(m.replace('uddg=',''))))].filter(u=>u.startsWith('http')&&!u.includes('duckduckgo'));
        urlsWithPos = urls.map((url,idx)=>({url,position:idx+1}));
        log(`${kw} â†’ ${urlsWithPos.length} results via DuckDuckGo`,'ok');
      }
      if(excludeDomains.length) urlsWithPos=urlsWithPos.filter(({url})=>!excludeDomains.some(d=>url.toLowerCase().includes(d)));
      urlsWithPos.forEach(({url,position})=>results.push({url, position, keyword:kw, engine: apiKey?'Google':engine==='bing'?'Bing':'DDG', date:today()}));
      APP.stats.success++;
    } catch(e){
      log(`${kw} â†’ failed: ${e.message}`,'err');
      APP.stats.failed++;
    }
    APP.stats.processed++;
    updateStats();
    await sleep(1500);
  }
  SS.set('rf_serp_results', results);
  SS.rawSet('rf_ss_tab','results');
  APP.running = false; setStatus('Done');
  log(`SERP scrape done â€” ${results.length} URLs across ${kws.length} keywords`,'ok');
  render_serp_scraper(document.getElementById('page-serp_scraper'));
}
function ss_saveSnapshot(){
  const r=SS.get('rf_serp_results',[]);
  if(!r.length){log('No results to snapshot','warn');return;}
  const history=SS.get('rf_serp_history',[]);
  const engine=[...new Set(r.map(x=>x.engine))].join('+');
  history.push({date:today(),results:r,engine});
  if(history.length>20) history.shift(); // keep last 20 snapshots
  SS.set('rf_serp_history',history);
  log(`Snapshot saved â€” ${r.length} URLs (${history.length} total snapshots)`,'ok');
  SS.rawSet('rf_ss_tab','history');
  render_serp_scraper(document.getElementById('page-serp_scraper'));
}
function ss_toList(){ const r=SS.get('rf_serp_results',[]); APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])]; SS.set('rf_urllist',APP.urlList); log(`${r.length} URLs â†’ URL List`,'ok'); updateStats(); }
function ss_toCommenter(){ const r=SS.get('rf_serp_results',[]); const ta=document.getElementById('comm-urls'); if(ta){ta.value=r.map(x=>x.url).join('\n');switchPage('commenter');log(`${r.length} SERP URLs â†’ Commenter`,'ok');}else{APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])];SS.set('rf_urllist',APP.urlList);switchPage('commenter');log(`${r.length} SERP URLs â†’ Commenter via URL List`,'ok');} }
function ss_export(){ const r=SS.get('rf_serp_results',[]); const hdr='Position,URL,Domain,Keyword,Engine,Date'; const rows=r.map(x=>{let d='';try{d=new URL(x.url).hostname.replace(/^www\./,'');}catch(e){}return[x.position||'',x.url,d,x.keyword,x.engine,x.date].map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(',');}); dlCSV([hdr,...rows].join('\n'),'serp_results.csv'); }
function ss_clear(){ SS.set('rf_serp_results',[]); SS.rawSet('rf_ss_tab','results'); render_serp_scraper(document.getElementById('page-serp_scraper')); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYWORD HARVESTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_keyword_harvester(el){
  const results = SS.get('rf_kw_results',[]);
  const khTab = SS.raw('rf_kh_tab','results');

  // Intent classification counts
  const intentCounts = {Informational:0,Commercial:0,Transactional:0,Navigational:0};
  results.forEach(r=>{ if(r.intent) intentCounts[r.intent]=(intentCounts[r.intent]||0)+1; });

  el.innerHTML = `
  <div class="panel">
    <div class="panel-head">ğŸŒ± Keyword Harvester <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Intent Clustering Â· Dedup Â· Country Fix Â· Custom Modifiers</span></div>
    <div class="panel-body">
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Seed Keywords (one per line)</label>
            <textarea id="kh-seeds" rows="5" placeholder="VPN&#10;best VPN&#10;cheap VPN"></textarea></div>
          <div class="fg"><label class="lbl">Custom Modifiers (comma-separated, added to Modifiers mode)</label>
            <input type="text" id="kh-custom-mods" placeholder="pro, enterprise, affordable, 2025, review" value=""/></div>
        </div>
        <div>
          <div class="fg"><label class="lbl">Expansion Mode</label>
            <select id="kh-mode">
              <option value="az">A-Z Append</option>
              <option value="questions">Questions (who, what, how...)</option>
              <option value="modifiers">Modifiers (best, top, cheap...)</option>
              <option value="all">All Methods</option>
            </select></div>
          <div class="fg"><label class="lbl">Language</label>
            <select id="kh-lang"><option value="en">English</option><option value="es">Spanish</option><option value="fr">French</option><option value="de">German</option><option value="pt">Portuguese</option><option value="it">Italian</option></select></div>
          <div class="fg"><label class="lbl">Country</label>
            <select id="kh-country"><option value="us">US</option><option value="gb">UK</option><option value="au">AU</option><option value="ca">CA</option><option value="in">India</option><option value="ng">Nigeria</option><option value="za">South Africa</option></select></div>
          <div class="fg"><label class="lbl">Similarity Dedup Threshold</label>
            <select id="kh-dedup"><option value="0">None</option><option value="0.7">Light (â‰¥70% similar)</option><option value="0.8" selected>Medium (â‰¥80%)</option><option value="0.9">Strict (â‰¥90%)</option></select></div>
        </div>
      </div>
      <div class="notice ni-g">Uses Google Autocomplete API â€” no API key needed. Country param (gl) is now correctly applied.</div>
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_keyword_harvester()">â–¶ Harvest Keywords</button>
        <button class="tbtn" onclick="kh_toSerp()">ğŸŒ â†’ SERP Scraper</button>
        <button class="tbtn" onclick="kh_export()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="kh_clear()">ğŸ—‘ Clear</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="kh-prog"></div></div>
    </div>
  </div>

  ${results.length ? `
  <div style="display:flex;gap:2px;margin-bottom:0">
    ${[
      ['results',`ğŸ”‘ All Keywords <span class="badge bg">${results.length}</span>`],
      ['intent',`ğŸ§  By Intent`],
    ].map(([t,l])=>`<button class="tbtn${khTab===t?' go':''}" onclick="SS.rawSet('rf_kh_tab','${t}');render_keyword_harvester(document.getElementById('page-keyword_harvester'))" style="font-size:10px">${l}</button>`).join('')}
  </div>

  ${khTab==='results'?`
  <div class="panel"><div class="panel-head">Keywords <span class="badge bg">${results.length}</span>
    <div class="ph-r" style="display:flex;gap:4px;align-items:center">
      <span style="font-size:10px;color:var(--text3)">Sort:</span>
      <select style="font-size:10px" onchange="SS.rawSet('rf_kh_sort',this.value);render_keyword_harvester(document.getElementById('page-keyword_harvester'))">
        <option value="kw" ${SS.raw('rf_kh_sort','kw')==='kw'?'selected':''}>Aâ€“Z</option>
        <option value="source" ${SS.raw('rf_kh_sort','kw')==='source'?'selected':''}>Source</option>
        <option value="intent" ${SS.raw('rf_kh_sort','kw')==='intent'?'selected':''}>Intent</option>
        <option value="len" ${SS.raw('rf_kh_sort','kw')==='len'?'selected':''}>Length</option>
      </select>
    </div>
  </div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>Keyword</th><th>Words</th><th>Intent</th><th>Source</th><th>Type</th></tr></thead>
    <tbody>${(()=>{
      let rows=[...results];
      const sort=SS.raw('rf_kh_sort','kw');
      if(sort==='kw') rows.sort((a,b)=>a.kw.localeCompare(b.kw));
      else if(sort==='source') rows.sort((a,b)=>a.source.localeCompare(b.source));
      else if(sort==='intent') rows.sort((a,b)=>(a.intent||'').localeCompare(b.intent||''));
      else if(sort==='len') rows.sort((a,b)=>b.kw.split(' ').length-a.kw.split(' ').length);
      const intentColor={Informational:'var(--blue)',Commercial:'var(--green)',Transactional:'var(--orange)',Navigational:'var(--purple)'};
      return rows.slice(0,300).map(r=>`<tr>
        <td>${esc(r.kw)}</td>
        <td class="mono xs tm">${r.kw.split(' ').length}</td>
        <td><span class="badge" style="background:${intentColor[r.intent]||'var(--win-panel3)'};opacity:.85">${r.intent||'?'}</span></td>
        <td class="xs tm">${esc(r.source)}</td>
        <td><span class="badge bgray">${esc(r.type||'')}</span></td>
      </tr>`).join('');
    })()}</tbody>
  </table></div></div></div>`:''}

  ${khTab==='intent'?`
  <div class="panel"><div class="panel-head">ğŸ§  Intent Distribution</div>
  <div class="panel-body">
    ${Object.entries(intentCounts).map(([intent,cnt])=>{
      const pct=results.length?Math.round(cnt/results.length*100):0;
      const color={Informational:'var(--blue)',Commercial:'var(--green)',Transactional:'var(--orange)',Navigational:'var(--purple)'}[intent]||'var(--text3)';
      return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
          <span style="font-family:var(--mono);font-size:11px;font-weight:700;color:${color}">${intent}</span>
          <span style="font-family:var(--mono);font-size:11px">${cnt} keywords â€” ${pct}%</span>
        </div>
        <div style="height:6px;background:var(--win-panel2);border-radius:2px;border:1px solid var(--win-border)">
          <div style="height:100%;width:${pct}%;background:${color};border-radius:2px;opacity:.8"></div>
        </div>
        <div style="margin-top:4px;font-size:10px;color:var(--text3)">${results.filter(r=>r.intent===intent).slice(0,6).map(r=>r.kw).join(' Â· ')}</div>
      </div>`;}).join('')}
  </div></div>`:''}
  `:''}`;
}

async function start_keyword_harvester(){
  const seedsRaw = (document.getElementById('kh-seeds')||{value:''}).value.trim();
  if(!seedsRaw){ log('Enter seed keywords','err'); return; }
  const seeds = seedsRaw.split('\n').map(s=>s.trim()).filter(Boolean);
  const mode = (document.getElementById('kh-mode')||{value:'az'}).value;
  const lang = (document.getElementById('kh-lang')||{value:'en'}).value;
  const country = (document.getElementById('kh-country')||{value:'us'}).value;
  const dedupThreshold = parseFloat((document.getElementById('kh-dedup')||{value:'0.8'}).value)||0;
  const customModsRaw = (document.getElementById('kh-custom-mods')||{value:''}).value.trim();
  const customMods = customModsRaw ? customModsRaw.split(',').map(m=>m.trim()).filter(Boolean) : [];
  const prog = document.getElementById('kh-prog');
  const allResults = [];
  const QPFX = ['who','what','when','where','why','how','which','can','does','is','are','will'];
  const MODS = ['best','top','cheap','free','buy','review','vs','alternative','guide','tutorial','2025','pro','online',...customMods];
  const AZ = 'abcdefghijklmnopqrstuvwxyz'.split('');

  // Intent classifier
  function classifyIntent(kw){
    const k=kw.toLowerCase();
    if(/\b(buy|order|purchase|price|cost|cheap|discount|deal|coupon|shipping|checkout)\b/.test(k)) return 'Transactional';
    if(/\b(best|top|review|vs|versus|alternative|compare|comparison|recommended)\b/.test(k)) return 'Commercial';
    if(/^(who|what|when|where|why|how|which|can|does|is|are|will)\b/.test(k)||/\b(guide|tutorial|how to|what is|definition|meaning|examples?)\b/.test(k)) return 'Informational';
    if(/\b(login|sign in|official|website|homepage|download|app)\b/.test(k)) return 'Navigational';
    return 'Informational';
  }

  // Jaccard similarity
  function jaccard(a,b){
    const sa=new Set(a.split(' ')); const sb=new Set(b.split(' '));
    const inter=[...sa].filter(x=>sb.has(x)).length;
    return inter/(sa.size+sb.size-inter);
  }

  APP.running = true; APP.stopFlag = false; setStatus('Harvesting keywords...');
  for(let i=0;i<seeds.length;i++){
    if(APP.stopFlag) break;
    const seed = seeds[i];
    if(prog) prog.style.width = Math.round(((i+1)/seeds.length)*100)+'%';
    setProgress(Math.round(((i+1)/seeds.length)*100), `${i+1}/${seeds.length}`);
    let queries = [];
    if(mode==='az'||mode==='all') queries.push(...AZ.map(l=>seed+' '+l));
    if(mode==='questions'||mode==='all') queries.push(...QPFX.map(q=>q+' '+seed));
    if(mode==='modifiers'||mode==='all') queries.push(...MODS.map(m=>seed+' '+m));
    for(const q of queries.slice(0,30)){
      if(APP.stopFlag) break;
      try{
        const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://suggestqueries.google.com/complete/search?client=firefox&hl=${lang}&gl=${country}&q=${encodeURIComponent(q)}`)}`,{signal:AbortSignal.timeout(5000)});
        const data = await resp.json();
        const parsed = JSON.parse(data.contents||'[[],[]]');
        const suggestions = parsed[1]||[];
        suggestions.forEach(kw=>allResults.push({kw:kw.toLowerCase().trim(),source:seed,type:mode,intent:classifyIntent(kw)}));
      } catch(e){}
      await sleep(150);
    }
    log(`${seed} â†’ harvested`,'ok');
    APP.stats.success++; APP.stats.processed++; updateStats();
  }

  // Dedup by exact match first
  let deduped = [];
  const seen = new Set();
  for(const r of allResults){
    if(!seen.has(r.kw)){ seen.add(r.kw); deduped.push(r); }
  }

  // Jaccard similarity dedup
  if(dedupThreshold>0){
    const kept=[];
    for(const r of deduped){
      if(!kept.some(k=>jaccard(k.kw,r.kw)>=dedupThreshold)) kept.push(r);
    }
    const removed=deduped.length-kept.length;
    if(removed>0) log(`Dedup removed ${removed} near-duplicate keywords (threshold: ${dedupThreshold})`,'info');
    deduped=kept;
  }

  SS.set('rf_kw_results', deduped);
  SS.rawSet('rf_kh_tab','results');
  APP.running = false; setStatus('Done');
  log(`Harvest done â€” ${deduped.length} unique keywords (from ${allResults.length} raw)`,'ok');
  render_keyword_harvester(document.getElementById('page-keyword_harvester'));
}
function kh_toSerp(){
  const r=SS.get('rf_kw_results',[]);
  if(!r.length){log('No keywords to send','warn');return;}
  const ta=document.getElementById('ss-kws');
  if(ta){ta.value=r.map(x=>x.kw).join('\n');switchPage('serp_scraper');log(`${r.length} keywords â†’ SERP Scraper`,'ok');}
  else{switchPage('serp_scraper');log(`Switch to SERP Scraper and paste keywords manually`,'info');}
}
function kh_export(){
  const r=SS.get('rf_kw_results',[]);
  const hdr='Keyword,Words,Intent,Source,Type';
  const rows=r.map(x=>[x.kw,x.kw.split(' ').length,x.intent||'',x.source,x.type||''].map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(','));
  dlTxt([hdr,...rows].join('\n'),'keywords.csv');
  log(`Exported ${r.length} keywords as CSV`,'ok');
}
function kh_clear(){ SS.set('rf_kw_results',[]); render_keyword_harvester(document.getElementById('page-keyword_harvester')); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SITEMAP SCRAPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_sitemap_scraper(el){
  const results = SS.get('rf_sitemap_results',[]);
  const imageResults = SS.get('rf_sitemap_images',[]);
  const healthReport = SS.get('rf_sitemap_health',null);
  const smTab = SS.get('rf_sm_tab','results');

  // Compute stats for health badge
  const broken = healthReport ? healthReport.broken.length : 0;
  const dupes = healthReport ? healthReport.duplicates.length : 0;
  const noLastmod = healthReport ? healthReport.noLastmod.length : 0;

  // Blog/article URL detection
  const BLOG_PATTERNS = /\/(blog|article|post|news|story|entry|journal|press|insight|resource|guide|tutorial|tip|update|writing)\//i;
  const EXCLUDE_PATTERNS = /\/(product|products|category|categories|tag|tags|shop|store|cart|checkout|account|login|register|search|page\/\d)\b/i;
  const blogUrls = results.filter(r=>r.status==='ok'&&BLOG_PATTERNS.test(r.url)&&!EXCLUDE_PATTERNS.test(r.url));

  // Update-frequency scoring: daily lastmod entries score highest
  function updateScore(r){
    if(!r.lastmod||r.lastmod==='unknown'||r.lastmod==='â€”') return 0;
    const d=new Date(r.lastmod);
    if(isNaN(d)) return 0;
    const age=(Date.now()-d)/86400000; // days old
    if(age<=1) return 10;
    if(age<=7) return 8;
    if(age<=30) return 6;
    if(age<=90) return 4;
    if(age<=365) return 2;
    return 1;
  }

  // Orphan detection: URLs that appear only once across all results (no cross-references)
  const urlSet = new Set(results.map(r=>r.url));
  const orphans = results.filter(r=>r.status==='ok'&&!results.some(r2=>r2!==r&&r2.url!==r.url&&(r2.url||'').includes(new URL(r.url).hostname)));

  el.innerHTML = `
  <div class="panel">
    <div class="panel-head">ğŸ—º Sitemap Scraper <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Health Â· Filters Â· Images Â· hreflang Â· Submit</span></div>
    <div class="panel-body">
      <div class="fg"><label class="lbl">Domains / Sitemap URLs (one per line)</label>
        <textarea id="sm-urls" rows="5" placeholder="https://example.com&#10;https://blog.domain.com&#10;https://example.com/sitemap.xml"></textarea></div>
      <div class="g3">
        <div class="fg"><label class="lbl">Max URLs per Sitemap</label><input type="number" id="sm-max" value="500" min="1"/></div>
        <div class="fg"><label class="lbl">Follow Sitemap Index</label>
          <select id="sm-recurse"><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div class="fg"><label class="lbl">Lastmod Filter â€” newer than (days, 0=all)</label><input type="number" id="sm-days" value="0" min="0" placeholder="0 = no filter"/></div>
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">Try Fallback Paths</label>
          <select id="sm-fallback"><option value="yes">Yes (auto-detect via robots.txt + common paths)</option><option value="no">No (sitemap.xml only)</option></select></div>
        <div class="fg"><label class="lbl">Changefreq Filter</label>
          <select id="sm-changefreq"><option value="all">All frequencies</option><option value="daily">daily only</option><option value="weekly">weekly only</option><option value="dailyweekly">daily + weekly</option></select></div>
        <div class="fg"><label class="lbl">Priority Filter (min)</label>
          <select id="sm-priority"><option value="0">All priorities</option><option value="0.8">â‰¥ 0.8</option><option value="0.7">â‰¥ 0.7</option><option value="0.5">â‰¥ 0.5</option></select></div>
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">Parse Image Sitemaps</label>
          <select id="sm-images"><option value="yes">Yes â€” extract &lt;image:loc&gt;</option><option value="no">No</option></select></div>
        <div class="fg"><label class="lbl">Parse News Sitemaps</label>
          <select id="sm-news"><option value="yes">Yes â€” extract news metadata</option><option value="no">No</option></select></div>
        <div class="fg"><label class="lbl">Parse hreflang / Video</label>
          <select id="sm-hreflang"><option value="yes">Yes â€” extract language/video data</option><option value="no">No</option></select></div>
      </div>
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_sitemap_scraper()">â–¶ Scrape Sitemaps</button>
        <button class="tbtn" onclick="sm_submitToGoogle()">ğŸ“¡ Submit to Google</button>
        <button class="tbtn" onclick="sm_submitToBing()">ğŸ“¡ Submit to Bing</button>
        <div class="tb-sep"></div>
        <button class="tbtn" onclick="sm_toList()">ğŸ’¾ â†’ URL List</button>
        <button class="tbtn" onclick="sm_exportFull()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="sm_exportImages()">ğŸ–¼ Export Images</button>
        <button class="tbtn" onclick="sm_clear()">ğŸ—‘ Clear</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="sm-prog"></div></div>
    </div>
  </div>

  ${results.length||imageResults.length?`
  <!-- Tab bar -->
  <div style="display:flex;gap:2px;margin-bottom:0;padding:0 0 0 0">
    ${[
      ['results',`ğŸ”— URLs <span class="badge bg">${results.filter(r=>r.status==='ok').length}</span>`],
      ['blog',`ğŸ“ Blog/Article <span class="badge by">${blogUrls.length}</span>`],
      ['images',`ğŸ–¼ Images <span class="badge" style="background:var(--purple)">${imageResults.length}</span>`],
      ['health',`ğŸ¥ Health Report ${broken>0?`<span class="badge br">${broken} broken</span>`:dupes>0?`<span class="badge by">${dupes} dup</span>`:results.length?`<span class="badge bg">âœ“</span>`:''}`],
      ['hreflang',`ğŸŒ hreflang / Video`],
      ['rebuild',`ğŸ¤– Content Rebuild`],
    ].map(([t,l])=>`<button class="tbtn${smTab===t?' go':''}" onclick="SS.rawSet('rf_sm_tab','${t}');render_sitemap_scraper(document.getElementById('page-sitemap_scraper'))" style="font-size:10px">${l}</button>`).join('')}
  </div>

  ${smTab==='results'?`
  <div class="panel"><div class="panel-head">Sitemap URLs <span class="badge bg">${results.filter(r=>r.status==='ok').length}</span>
    <div class="ph-r" style="display:flex;gap:4px;align-items:center">
      <span style="font-size:10px;color:var(--text3)">Sort:</span>
      <select style="font-size:10px" onchange="SS.rawSet('rf_sm_sort',this.value);render_sitemap_scraper(document.getElementById('page-sitemap_scraper'))">
        <option value="source" ${SS.raw('rf_sm_sort','source')==='source'?'selected':''}>Source</option>
        <option value="score" ${SS.raw('rf_sm_sort','source')==='score'?'selected':''}>Update Score â†“</option>
        <option value="lastmod" ${SS.raw('rf_sm_sort','source')==='lastmod'?'selected':''}>Lastmod â†“</option>
        <option value="priority" ${SS.raw('rf_sm_sort','source')==='priority'?'selected':''}>Priority â†“</option>
      </select>
    </div>
  </div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>URL</th><th>Source</th><th>Lastmod</th><th>Changefreq</th><th>Priority</th><th>Score</th><th>Status</th></tr></thead>
    <tbody>${(()=>{
      let rows=[...results];
      const sort=SS.raw('rf_sm_sort','source');
      if(sort==='score') rows.sort((a,b)=>updateScore(b)-updateScore(a));
      else if(sort==='lastmod') rows.sort((a,b)=>(b.lastmod||'').localeCompare(a.lastmod||''));
      else if(sort==='priority') rows.sort((a,b)=>(parseFloat(b.priority)||0)-(parseFloat(a.priority)||0));
      return rows.slice(0,150).map(r=>{
        const score=updateScore(r);
        const scoreColor=score>=8?'var(--green)':score>=5?'var(--yellow)':score>=2?'var(--orange)':'var(--text3)';
        return `<tr>
          <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.length>70?r.url.slice(0,70)+'â€¦':r.url)}</a></td>
          <td class="xs tm">${esc(r.source)}</td>
          <td class="mono xs tm">${esc(r.lastmod||'â€”')}</td>
          <td class="xs tm">${r.changefreq?`<span class="badge" style="background:${r.changefreq==='daily'?'var(--green-dim)':r.changefreq==='weekly'?'#2a3a1a':'#1a1a2a'}">${esc(r.changefreq)}</span>`:'â€”'}</td>
          <td class="mono xs tm" style="color:${parseFloat(r.priority||0)>=0.8?'var(--green)':'var(--text2)'}${r.priority?'':';opacity:.4'}">${r.priority||'â€”'}</td>
          <td class="mono xs tm" style="color:${scoreColor}">${score||'â€”'}</td>
          <td><span class="badge ${r.status==='ok'?'bg':'br'}">${r.status}</span></td>
        </tr>`;}).join('');
    })()}</tbody>
  </table></div></div></div>`:''}

  ${smTab==='blog'?`
  <div class="panel"><div class="panel-head">ğŸ“ Blog / Article Pages <span class="badge by">${blogUrls.length}</span>
    <div class="ph-r"><button class="tbtn" style="font-size:10px" onclick="sm_blogToList()">ğŸ’¾ â†’ URL List</button></div>
  </div>
  <div class="panel-body" style="padding:0">
    ${blogUrls.length?`<div class="tbl-wrap"><table>
      <thead><tr><th>URL</th><th>Source</th><th>Lastmod</th><th>Score</th><th>Changefreq</th></tr></thead>
      <tbody>${blogUrls.sort((a,b)=>updateScore(b)-updateScore(a)).slice(0,200).map(r=>{
        const score=updateScore(r);
        const scoreColor=score>=8?'var(--green)':score>=5?'var(--yellow)':'var(--orange)';
        return `<tr>
          <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.length>70?r.url.slice(0,70)+'â€¦':r.url)}</a></td>
          <td class="xs tm">${esc(r.source)}</td>
          <td class="mono xs tm">${esc(r.lastmod||'â€”')}</td>
          <td class="mono xs tm" style="color:${scoreColor}">${score||'â€”'}</td>
          <td class="xs tm">${r.changefreq||'â€”'}</td>
        </tr>`;}).join('')}
      </tbody></table></div>`:`<div style="padding:12px;color:var(--text3);font-size:11px">No blog/article URLs detected. Patterns checked: /blog/, /article/, /post/, /news/, /story/, /guide/, /tutorial/</div>`}
  </div></div>`:''}

  ${smTab==='images'?`
  <div class="panel"><div class="panel-head">ğŸ–¼ Image URLs <span class="badge" style="background:var(--purple)">${imageResults.length}</span>
    <div class="ph-r"><button class="tbtn" style="font-size:10px" onclick="sm_exportImages()">ğŸ“¥ Export</button></div>
  </div>
  <div class="panel-body" style="padding:0">
    ${imageResults.length?`<div class="tbl-wrap"><table>
      <thead><tr><th>Image URL</th><th>Page URL</th><th>Title</th><th>Caption</th></tr></thead>
      <tbody>${imageResults.slice(0,200).map(r=>`<tr>
        <td class="mono xs"><a href="${esc(r.imageUrl)}" target="_blank">${esc(r.imageUrl.length>55?r.imageUrl.slice(0,55)+'â€¦':r.imageUrl)}</a></td>
        <td class="mono xs tm"><a href="${esc(r.pageUrl)}" target="_blank">${esc((r.pageUrl||'').slice(0,40))}â€¦</a></td>
        <td class="xs tm">${esc(r.title||'â€”')}</td>
        <td class="xs tm">${esc(r.caption||'â€”')}</td>
      </tr>`).join('')}</tbody></table></div>`:`<div style="padding:12px;color:var(--text3);font-size:11px">No image URLs found. Enable "Parse Image Sitemaps" and re-scrape a site that uses &lt;image:loc&gt; tags.</div>`}
  </div></div>`:''}

  ${smTab==='health'?`
  <div class="panel"><div class="panel-head">ğŸ¥ Sitemap Health Report
    <div class="ph-r"><button class="tbtn go" style="font-size:10px" onclick="sm_runHealthCheck()">ğŸ”„ Run Health Check</button></div>
  </div>
  <div class="panel-body">
    ${healthReport?`
    <div class="g3" style="margin-bottom:8px">
      <div style="background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;padding:8px;text-align:center">
        <div style="font-size:22px;font-weight:700;color:${broken>0?'var(--red)':'var(--green)'}">${broken}</div>
        <div style="font-size:10px;color:var(--text3)">Broken URLs (status err)</div>
      </div>
      <div style="background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;padding:8px;text-align:center">
        <div style="font-size:22px;font-weight:700;color:${dupes>0?'var(--yellow)':'var(--green)'}">${dupes}</div>
        <div style="font-size:10px;color:var(--text3)">Duplicate locs</div>
      </div>
      <div style="background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;padding:8px;text-align:center">
        <div style="font-size:22px;font-weight:700;color:${noLastmod>0?'var(--orange)':'var(--green)'}">${noLastmod}</div>
        <div style="font-size:10px;color:var(--text3)">Missing lastmod</div>
      </div>
    </div>
    ${broken>0?`<div style="margin-bottom:6px"><div style="font-size:10px;font-weight:700;color:var(--red);margin-bottom:4px">âŒ Broken / Error URLs (${broken})</div>
    <div class="tbl-wrap"><table><thead><tr><th>URL</th><th>Source</th></tr></thead><tbody>
    ${healthReport.broken.slice(0,50).map(r=>`<tr><td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.slice(0,80))}</a></td><td class="xs tm">${esc(r.source)}</td></tr>`).join('')}
    </tbody></table></div></div>`:''}
    ${dupes>0?`<div style="margin-bottom:6px"><div style="font-size:10px;font-weight:700;color:var(--yellow);margin-bottom:4px">âš  Duplicate locs (${dupes})</div>
    <div class="tbl-wrap"><table><thead><tr><th>Duplicate URL</th><th>Count</th></tr></thead><tbody>
    ${healthReport.duplicates.slice(0,30).map(d=>`<tr><td class="mono xs">${esc(d.url.slice(0,80))}</td><td class="xs tm">${d.count}</td></tr>`).join('')}
    </tbody></table></div></div>`:''}
    ${noLastmod>0?`<div><div style="font-size:10px;font-weight:700;color:var(--orange);margin-bottom:4px">â° Missing lastmod (${noLastmod} shown)</div>
    <div class="tbl-wrap"><table><thead><tr><th>URL</th><th>Source</th></tr></thead><tbody>
    ${healthReport.noLastmod.slice(0,30).map(r=>`<tr><td class="mono xs">${esc(r.url.slice(0,80))}</td><td class="xs tm">${esc(r.source)}</td></tr>`).join('')}
    </tbody></table></div></div>`:''}
    ${broken===0&&dupes===0&&noLastmod===0?`<div style="color:var(--green);font-weight:700;padding:10px 0">âœ… Sitemap is healthy â€” no issues found.</div>`:''}
    `:`<div style="color:var(--text3);font-size:11px;padding:8px 0">Click "Run Health Check" to analyze scraped results for broken URLs, duplicates, and missing lastmod fields.</div>`}
  </div></div>`:''}

  ${smTab==='hreflang'?`
  <div class="panel"><div class="panel-head">ğŸŒ hreflang & Video Sitemap Data</div>
  <div class="panel-body" style="padding:0">
    ${(()=>{
      const hreflangData=SS.get('rf_sitemap_hreflang',[]);
      const videoData=SS.get('rf_sitemap_videos',[]);
      const newsData=SS.get('rf_sitemap_news',[]);
      if(!hreflangData.length&&!videoData.length&&!newsData.length) return `<div style="padding:12px;color:var(--text3);font-size:11px">No hreflang, video, or news data yet. Enable parsing options above and re-scrape.</div>`;
      let out='';
      if(newsData.length) out+=`<div style="padding:6px 8px;font-weight:700;font-size:10px;color:var(--cyan);border-bottom:1px solid var(--win-border)">ğŸ“° News Sitemap (${newsData.length})</div>
        <div class="tbl-wrap"><table><thead><tr><th>Title</th><th>Publication</th><th>Date</th><th>URL</th></tr></thead><tbody>
        ${newsData.slice(0,50).map(n=>`<tr><td class="xs">${esc(n.title||'â€”')}</td><td class="xs tm">${esc(n.publication||'â€”')}</td><td class="mono xs tm">${esc(n.date||'â€”')}</td><td class="mono xs"><a href="${esc(n.url)}" target="_blank">${esc((n.url||'').slice(0,55))}</a></td></tr>`).join('')}
        </tbody></table></div>`;
      if(hreflangData.length) out+=`<div style="padding:6px 8px;font-weight:700;font-size:10px;color:var(--blue);border-bottom:1px solid var(--win-border);border-top:1px solid var(--win-border)">ğŸŒ hreflang Entries (${hreflangData.length})</div>
        <div class="tbl-wrap"><table><thead><tr><th>URL</th><th>hreflang</th><th>Alternate URL</th></tr></thead><tbody>
        ${hreflangData.slice(0,100).map(h=>`<tr><td class="mono xs"><a href="${esc(h.url)}" target="_blank">${esc((h.url||'').slice(0,45))}</a></td><td class="xs tm"><span class="badge by">${esc(h.hreflang)}</span></td><td class="mono xs tm">${esc((h.alternate||'').slice(0,45))}</td></tr>`).join('')}
        </tbody></table></div>`;
      if(videoData.length) out+=`<div style="padding:6px 8px;font-weight:700;font-size:10px;color:var(--purple);border-bottom:1px solid var(--win-border);border-top:1px solid var(--win-border)">ğŸ¬ Video Sitemap (${videoData.length})</div>
        <div class="tbl-wrap"><table><thead><tr><th>Title</th><th>Description</th><th>Duration</th><th>Page URL</th></tr></thead><tbody>
        ${videoData.slice(0,50).map(v=>`<tr><td class="xs">${esc(v.title||'â€”')}</td><td class="xs tm">${esc((v.description||'').slice(0,60))}</td><td class="mono xs tm">${v.duration?v.duration+'s':'â€”'}</td><td class="mono xs"><a href="${esc(v.pageUrl)}" target="_blank">${esc((v.pageUrl||'').slice(0,45))}</a></td></tr>`).join('')}
        </tbody></table></div>`;
      return out;
    })()}
  </div></div>`:''}

  ${smTab==='rebuild'?`
  <div class="panel"><div class="panel-head">ğŸ¤– Content Rebuild Engine <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">Scrape competitor pages â†’ AI rewrite â†’ WordPress WXR</span>
    <div class="ph-r" style="display:flex;gap:4px;align-items:center">
      <button class="tbtn go" onclick="crb_start()" id="crb-start-btn">â–¶ Start Rebuild</button>
      <button class="tbtn stop" onclick="crb_stop()" id="crb-stop-btn" style="display:none">â¹ Stop</button>
      <button class="tbtn" onclick="crb_exportWXR()">ğŸ“¥ Download WXR</button>
      <button class="tbtn" onclick="crb_clear()">ğŸ—‘ Clear</button>
    </div>
  </div>
  <div class="panel-body">
    ${(()=>{
      const BLOG_PAT=/\/(blog|article|post|news|story|entry|journal|press|insight|resource|guide|tutorial|tip|update|writing)\//i;
      const EXCL_PAT=/\/(product|products|category|categories|tag|tags|shop|store|cart|checkout|account|login|register|search|page\/\d)\b/i;
      const blogUrls2=results.filter(r=>r.status==='ok'&&BLOG_PAT.test(r.url)&&!EXCL_PAT.test(r.url));
      function updateScore2(r){if(!r.lastmod||r.lastmod==='unknown'||r.lastmod==='â€”')return 0;const d=new Date(r.lastmod);if(isNaN(d))return 0;const age=(Date.now()-d)/86400000;if(age<=1)return 10;if(age<=7)return 8;if(age<=30)return 6;if(age<=90)return 4;if(age<=365)return 2;return 1;}
      const claudeKey2=SS.raw('rf_claude_key')||'';
      const crbResults=SS.get('rf_crb_results',[]);
      const crbQueue=SS.get('rf_crb_queue',[]);
      return `
      <div class="g3" style="margin-bottom:8px">
        <div class="fg"><label class="lbl">Source</label>
          <select id="crb-source" onchange="document.getElementById('crb-manual-wrap').style.display=this.value==='manual'?'':'none'">
            <option value="blog">Blog/Article URLs (${blogUrls2.length} detected)</option>
            <option value="all">All OK URLs (${results.filter(r=>r.status==='ok').length})</option>
            <option value="manual">Manual list below</option>
          </select>
        </div>
        <div class="fg"><label class="lbl">Max URLs to Rebuild</label>
          <input type="number" id="crb-max" value="10" min="1" max="200"/>
        </div>
        <div class="fg"><label class="lbl">Min Update Score (0=all)</label>
          <input type="number" id="crb-minscore" value="0" min="0" max="10"/>
        </div>
      </div>
      <div class="g3" style="margin-bottom:8px">
        <div class="fg"><label class="lbl">Rewrite Mode</label>
          <select id="crb-mode">
            <option value="full">Full Article Rewrite</option>
            <option value="outline">Outline + Title + Meta Only</option>
            <option value="titlemeta">Title + Meta Description Only</option>
          </select>
        </div>
        <div class="fg"><label class="lbl">WXR Post Status</label>
          <select id="crb-wpstatus">
            <option value="draft">Draft (review before publish)</option>
            <option value="publish">Publish immediately</option>
          </select>
        </div>
        <div class="fg"><label class="lbl">Claude Model</label>
          <select id="crb-model">
            <option value="claude-haiku-4-5-20251001">claude-haiku-4-5 (fast / free tier)</option>
            <option value="claude-sonnet-4-6">claude-sonnet-4-6 (best quality)</option>
          </select>
          ${claudeKey2?`<div style="font-size:9px;color:var(--green);margin-top:2px">âœ“ Claude API key set</div>`:`<div style="font-size:9px;color:var(--red);margin-top:2px">âš  No API key â€” Settings â†’ API Keys â†’ Claude</div>`}
        </div>
      </div>
      <div class="fg" style="margin-bottom:8px"><label class="lbl">Target Keywords (one per line â€” injected into rewrite prompt)</label>
        <textarea id="crb-keywords" rows="3" placeholder="best seo tools 2025&#10;link building software&#10;rank tracking free"></textarea>
      </div>
      <div class="fg" style="margin-bottom:8px;display:none" id="crb-manual-wrap"><label class="lbl">Manual URLs (one per line)</label>
        <textarea id="crb-manual" rows="4" placeholder="https://competitor.com/article/keyword-guide"></textarea>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="crb-prog" style="width:0%"></div></div>
      <div id="crb-status" style="font-family:var(--mono);font-size:10px;color:var(--text3);margin:4px 0 6px">Idle â€” ${crbResults.length} rebuilt, ${crbQueue.length} queued</div>

      ${crbResults.length?`
      <div class="tbl-wrap"><table>
        <thead><tr><th>URL</th><th>Stage</th><th>Rebuilt Title</th><th>Words</th><th>Time</th></tr></thead>
        <tbody>${crbResults.map(r=>{
          const sc=r.stage==='done'?'var(--green)':r.stage==='failed'?'var(--red)':r.stage==='rewriting'?'var(--yellow)':r.stage==='scraping'?'var(--cyan)':'var(--text3)';
          const si=r.stage==='done'?'âœ“':r.stage==='failed'?'âœ—':r.stage==='rewriting'?'âœ':r.stage==='scraping'?'ğŸ”':'â³';
          return `<tr>
            <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc((r.url||'').slice(0,55))}</a></td>
            <td><span class="badge" style="background:${sc}22;color:${sc};border:1px solid ${sc}44">${si} ${esc(r.stage||'?')}</span></td>
            <td class="xs">${r.rebuiltTitle?esc(r.rebuiltTitle.slice(0,60)):r.stage==='failed'?`<span style="color:var(--red);font-size:9px">${esc((r.error||'').slice(0,50))}</span>`:'â€”'}</td>
            <td class="mono xs tm">${r.wordCount||'â€”'}</td>
            <td class="mono xs tm">${r.elapsed||'â€”'}</td>
          </tr>`;}).join('')}
        </tbody>
      </table></div>`:`<div style="padding:10px;color:var(--text3);font-size:11px">No results yet. Configure above and click â–¶ Start Rebuild.<br><br><strong style="color:var(--text2)">What this tool does:</strong><br>1. Scrapes each competitor page (title, meta desc, H2 headings, body text)<br>2. Sends a structured ContentProfile to Claude AI with your target keywords<br>3. Receives new title, meta description, and full article body as JSON<br>4. Bundles everything into a WordPress WXR file with Yoast SEO meta fields pre-filled</div>`}
      `;
    })()}
  </div></div>`:''}
  `:''}`;
}

async function start_sitemap_scraper(){
  const raw=(document.getElementById('sm-urls')||{value:''}).value.trim();
  if(!raw){log('Enter domains or sitemap URLs','err');return;}
  const inputs=raw.split('\n').map(d=>d.trim()).filter(Boolean);
  const maxPer=parseInt((document.getElementById('sm-max')||{value:500}).value)||500;
  const daysFilter=parseInt((document.getElementById('sm-days')||{value:0}).value)||0;
  const useFallback=(document.getElementById('sm-fallback')||{value:'yes'}).value==='yes';
  const changefreqFilter=(document.getElementById('sm-changefreq')||{value:'all'}).value;
  const minPriority=parseFloat((document.getElementById('sm-priority')||{value:'0'}).value)||0;
  const parseImages=(document.getElementById('sm-images')||{value:'yes'}).value==='yes';
  const parseNews=(document.getElementById('sm-news')||{value:'yes'}).value==='yes';
  const parseHreflang=(document.getElementById('sm-hreflang')||{value:'yes'}).value==='yes';

  // Extended fallback paths including robots.txt auto-detect
  const SITEMAP_PATHS=['/sitemap.xml','/sitemap_index.xml','/news-sitemap.xml','/post-sitemap.xml','/page-sitemap.xml','/video-sitemap.xml','/image-sitemap.xml','/sitemap-index.xml'];
  const prog=document.getElementById('sm-prog');
  const results=[];
  const imageResults=[];
  const hreflangData=[];
  const videoData=[];
  const newsData=[];
  const cutoffDate=daysFilter>0?new Date(Date.now()-daysFilter*86400000):null;
  APP.running=true;APP.stopFlag=false;setStatus('Scraping sitemaps...');
  SS.set('rf_sitemap_health',null); // clear old health

  // Helper: fetch XML via allorigins
  async function fetchXml(url){
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(10000)});
    const data=await resp.json();
    return data.contents||'';
  }

  // Auto-detect sitemaps from robots.txt
  async function detectSitemapsFromRobots(domain){
    try{
      const robotsTxt=await fetchXml('https://'+domain+'/robots.txt');
      const matches=robotsTxt.match(/^Sitemap:\s*(.+)$/gim)||[];
      return matches.map(m=>m.replace(/^Sitemap:\s*/i,'').trim()).filter(Boolean);
    }catch(e){return[];}
  }

  // Parse a single sitemap XML content
  function parseSitemapContent(content, domain, path, foundResults, allImageResults, allHreflang, allVideo, allNews){
    const urlBlocks=content.match(/<url>[\s\S]*?<\/url>/gi)||[];
    if(!urlBlocks.length){
      // Sitemap index â€” return child sitemap URLs
      const childMatches=content.match(/<loc>(https?:\/\/[^<]+\.xml[^<]*)<\/loc>/gi)||[];
      return {type:'index', children: childMatches.map(m=>m.replace(/<\/?loc>/gi,'').trim())};
    }
    let count=0;
    for(const block of urlBlocks){
      if(count>=maxPer) break;
      const locM=block.match(/<loc>(https?:\/\/[^<]+)<\/loc>/i);
      if(!locM) continue;
      const url=locM[1].trim();
      if(url.endsWith('.xml')) continue;

      const lastmodM=block.match(/<lastmod>([^<]+)<\/lastmod>/i);
      const lastmod=lastmodM?lastmodM[1].trim():'unknown';
      const changefreqM=block.match(/<changefreq>([^<]+)<\/changefreq>/i);
      const changefreq=changefreqM?changefreqM[1].trim().toLowerCase():'';
      const priorityM=block.match(/<priority>([^<]+)<\/priority>/i);
      const priority=priorityM?parseFloat(priorityM[1].trim()):null;

      // Changefreq filter
      if(changefreqFilter==='daily'&&changefreq!=='daily') continue;
      if(changefreqFilter==='weekly'&&changefreq!=='weekly') continue;
      if(changefreqFilter==='dailyweekly'&&changefreq!=='daily'&&changefreq!=='weekly') continue;
      // Priority filter
      if(minPriority>0&&(priority===null||priority<minPriority)) continue;
      // Lastmod / date filter
      if(cutoffDate&&lastmodM){
        const lm=new Date(lastmod);
        if(!isNaN(lm)&&lm<cutoffDate) continue;
      }

      foundResults.push({url, lastmod, changefreq:changefreq||null, priority:priority!==null?priority.toString():null, source:domain, path, status:'ok'});
      count++;

      // Image sitemap: <image:loc>
      if(parseImages){
        const imgBlocks=block.match(/<image:image>[\s\S]*?<\/image:image>/gi)||[];
        for(const ib of imgBlocks){
          const imgLoc=ib.match(/<image:loc>([^<]+)<\/image:loc>/i);
          const imgTitle=ib.match(/<image:title>([^<]+)<\/image:title>/i);
          const imgCaption=ib.match(/<image:caption>([^<]+)<\/image:caption>/i);
          if(imgLoc) allImageResults.push({imageUrl:imgLoc[1].trim(), pageUrl:url, title:imgTitle?imgTitle[1].trim():'', caption:imgCaption?imgCaption[1].trim():''});
        }
        // Also catch bare <image:loc> without wrapper
        const bareLocs=block.match(/<image:loc>([^<]+)<\/image:loc>/gi)||[];
        if(!imgBlocks.length&&bareLocs.length){
          for(const bl of bareLocs){
            const m=bl.match(/<image:loc>([^<]+)<\/image:loc>/i);
            if(m) allImageResults.push({imageUrl:m[1].trim(), pageUrl:url, title:'', caption:''});
          }
        }
      }

      // hreflang: <xhtml:link rel="alternate" hreflang="..." href="..."/>
      if(parseHreflang){
        const hBlocks=block.match(/<xhtml:link[^>]+>/gi)||[];
        for(const hb of hBlocks){
          const hlang=hb.match(/hreflang="([^"]+)"/i);
          const href=hb.match(/href="([^"]+)"/i);
          if(hlang&&href) allHreflang.push({url, hreflang:hlang[1], alternate:href[1]});
        }
      }

      // Video sitemap
      if(parseHreflang){
        const vBlocks=block.match(/<video:video>[\s\S]*?<\/video:video>/gi)||[];
        for(const vb of vBlocks){
          const vtitle=vb.match(/<video:title>([^<]+)<\/video:title>/i);
          const vdesc=vb.match(/<video:description>([^<]+)<\/video:description>/i);
          const vdur=vb.match(/<video:duration>([^<]+)<\/video:duration>/i);
          allVideo.push({title:vtitle?vtitle[1].trim():'', description:vdesc?vdesc[1].trim():'', duration:vdur?vdur[1].trim():null, pageUrl:url});
        }
      }

      // News sitemap
      if(parseNews){
        const nBlocks=block.match(/<news:news>[\s\S]*?<\/news:news>/gi)||[];
        for(const nb of nBlocks){
          const npub=nb.match(/<news:name>([^<]+)<\/news:name>/i);
          const ntitle=nb.match(/<news:title>([^<]+)<\/news:title>/i);
          const ndate=nb.match(/<news:publication_date>([^<]+)<\/news:publication_date>/i);
          allNews.push({title:ntitle?ntitle[1].trim():'', publication:npub?npub[1].trim():'', date:ndate?ndate[1].trim():'', url});
        }
      }
    }
    return {type:'urls', count};
  }

  for(let i=0;i<inputs.length;i++){
    if(APP.stopFlag)break;
    let input=inputs[i];
    if(!input.startsWith('http')) input='https://'+input;
    const domain=input.replace(/https?:\/\//,'').split('/')[0];
    if(prog) prog.style.width=Math.round(((i+1)/inputs.length)*100)+'%';
    setProgress(Math.round(((i+1)/inputs.length)*100),`${i+1}/${inputs.length}`);

    // Build list of sitemap URLs to try
    let pathsToTry=[];

    // If input is a direct .xml URL, try it first
    if(input.endsWith('.xml')||input.includes('.xml?')){
      pathsToTry=[input];
    }

    // Auto-detect from robots.txt
    if(useFallback){
      const robotsSitemaps=await detectSitemapsFromRobots(domain);
      if(robotsSitemaps.length){
        log(`${domain}: robots.txt â†’ ${robotsSitemaps.length} sitemap(s) detected`,'info');
        pathsToTry=[...pathsToTry,...robotsSitemaps];
      }
    }

    // Add standard fallback paths (as full URLs)
    if(useFallback||!pathsToTry.length){
      pathsToTry=[...pathsToTry,...SITEMAP_PATHS.map(p=>'https://'+domain+p)];
    } else if(!pathsToTry.length){
      pathsToTry=['https://'+domain+'/sitemap.xml'];
    }

    pathsToTry=[...new Set(pathsToTry)];
    let found=false;
    const visitedSitemaps=new Set();

    for(const sitemapUrl of pathsToTry){
      if(APP.stopFlag||found) break;
      if(visitedSitemaps.has(sitemapUrl)) continue;
      visitedSitemaps.add(sitemapUrl);

      try{
        const content=await fetchXml(sitemapUrl);
        if(!content.includes('<url>')&&!content.includes('<sitemap>')) continue;
        const path='/'+sitemapUrl.split('/').slice(3).join('/');
        const parsed=parseSitemapContent(content, domain, path, results, imageResults, hreflangData, videoData, newsData);

        if(parsed.type==='index'&&parsed.children.length){
          log(`${domain}: sitemap index â†’ ${parsed.children.length} child sitemaps`,'info');
          for(const childUrl of parsed.children.slice(0,20)){
            if(APP.stopFlag) break;
            if(visitedSitemaps.has(childUrl)) continue;
            visitedSitemaps.add(childUrl);
            try{
              const childContent=await fetchXml(childUrl);
              const childPath='/'+childUrl.split('/').slice(3).join('/');
              const childParsed=parseSitemapContent(childContent, domain, childPath, results, imageResults, hreflangData, videoData, newsData);
              if(childParsed.count>0) found=true;
              await sleep(200);
            }catch(e){}
          }
          if(found) log(`${domain}: index crawl complete â€” ${results.filter(r=>r.source===domain).length} URLs`,'ok');
          else found=true; // index found even if 0 children
        } else if(parsed.type==='urls'&&parsed.count>0){
          log(`${domain}${path} â†’ ${parsed.count} URLs`+(changefreqFilter!=='all'?` [freq:${changefreqFilter}]`:'')+(minPriority>0?` [prioâ‰¥${minPriority}]`:'')+(cutoffDate?` [lastmod<${daysFilter}d]`:''),'ok');
          found=true;
        }
      }catch(e){}
      await sleep(300);
    }

    if(!found){
      results.push({url:'https://'+domain+'/sitemap.xml',lastmod:'â€”',source:domain,path:'/sitemap.xml',status:'err'});
      log(`${domain} â†’ no valid sitemap found (tried ${pathsToTry.length} paths)`,'err');
      APP.stats.failed++;
    } else {
      APP.stats.success++;
    }
    APP.stats.processed++;
    updateStats();
    await sleep(400);
  }

  SS.set('rf_sitemap_results',results);
  SS.set('rf_sitemap_images',imageResults);
  SS.set('rf_sitemap_hreflang',hreflangData);
  SS.set('rf_sitemap_videos',videoData);
  SS.set('rf_sitemap_news',newsData);
  SS.rawSet('rf_sm_tab','results');
  APP.running=false;setStatus('Done');

  const ok=results.filter(r=>r.status==='ok').length;
  log(`Sitemap scrape done â€” ${ok} URLs Â· ${imageResults.length} images Â· ${hreflangData.length} hreflang Â· ${newsData.length} news Â· ${videoData.length} videos`,'ok');
  if(imageResults.length) log(`Image URLs â†’ use Export Images or Reverse Image Search tab`,'info');
  render_sitemap_scraper(document.getElementById('page-sitemap_scraper'));
}

function sm_runHealthCheck(){
  const results=SS.get('rf_sitemap_results',[]);
  if(!results.length){log('No sitemap results to check','warn');return;}
  const broken=results.filter(r=>r.status==='err');
  const noLastmod=results.filter(r=>r.status==='ok'&&(!r.lastmod||r.lastmod==='unknown'||r.lastmod==='â€”'));
  // Duplicate locs
  const seen={};
  results.forEach(r=>{if(r.status==='ok'){seen[r.url]=(seen[r.url]||0)+1;}});
  const duplicates=Object.entries(seen).filter(([,c])=>c>1).map(([url,count])=>({url,count}));
  SS.set('rf_sitemap_health',{broken, noLastmod, duplicates, checkedAt:new Date().toISOString()});
  SS.rawSet('rf_sm_tab','health');
  log(`Health check: ${broken.length} broken Â· ${duplicates.length} duplicates Â· ${noLastmod.length} missing lastmod`,(broken.length||duplicates.length)?'warn':'ok');
  render_sitemap_scraper(document.getElementById('page-sitemap_scraper'));
}

async function sm_submitToGoogle(){
  const results=SS.get('rf_sitemap_results',[]);
  const domains=[...new Set(results.filter(r=>r.status==='ok').map(r=>r.source))];
  if(!domains.length){log('No scraped sitemaps to submit','warn');return;}
  for(const domain of domains){
    const sitemapUrl='https://'+domain+'/sitemap.xml';
    try{
      await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.google.com/ping?sitemap='+encodeURIComponent(sitemapUrl))}`,{signal:AbortSignal.timeout(6000)});
      log(`Google ping â†’ ${sitemapUrl}`,'ok');
    }catch(e){log(`Google ping failed â†’ ${sitemapUrl}`,'err');}
    await sleep(300);
  }
}

async function sm_submitToBing(){
  const results=SS.get('rf_sitemap_results',[]);
  const domains=[...new Set(results.filter(r=>r.status==='ok').map(r=>r.source))];
  if(!domains.length){log('No scraped sitemaps to submit','warn');return;}
  for(const domain of domains){
    const sitemapUrl='https://'+domain+'/sitemap.xml';
    try{
      await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.bing.com/ping?sitemap='+encodeURIComponent(sitemapUrl))}`,{signal:AbortSignal.timeout(6000)});
      log(`Bing ping â†’ ${sitemapUrl}`,'ok');
    }catch(e){log(`Bing ping failed â†’ ${sitemapUrl}`,'err');}
    await sleep(300);
  }
}

function sm_toList(){
  const r=SS.get('rf_sitemap_results',[]).filter(x=>x.status==='ok');
  APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])];
  SS.set('rf_urllist',APP.urlList);
  log(`${r.length} URLs â†’ URL List`,'ok');
  updateStats();
}

function sm_blogToList(){
  const BLOG_PATTERNS=/\/(blog|article|post|news|story|entry|journal|press|insight|resource|guide|tutorial|tip|update|writing)\//i;
  const EXCLUDE_PATTERNS=/\/(product|products|category|categories|tag|tags|shop|store|cart|checkout|account|login|register|search|page\/\d)\b/i;
  const r=SS.get('rf_sitemap_results',[]).filter(x=>x.status==='ok'&&BLOG_PATTERNS.test(x.url)&&!EXCLUDE_PATTERNS.test(x.url));
  APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])];
  SS.set('rf_urllist',APP.urlList);
  log(`${r.length} blog/article URLs â†’ URL List`,'ok');
  updateStats();
}

function sm_exportFull(){
  const r=SS.get('rf_sitemap_results',[]);
  const header='URL,Source,Lastmod,Changefreq,Priority,Status';
  const rows=r.map(x=>[x.url,x.source,x.lastmod||'',x.changefreq||'',x.priority||'',x.status].map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(','));
  dlTxt([header,...rows].join('\n'),'sitemap_urls.csv');
}

function sm_exportImages(){
  const r=SS.get('rf_sitemap_images',[]);
  if(!r.length){log('No image URLs to export','warn');return;}
  const header='Image URL,Page URL,Title,Caption';
  const rows=r.map(x=>[x.imageUrl,x.pageUrl,x.title||'',x.caption||''].map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(','));
  dlTxt([header,...rows].join('\n'),'sitemap_images.csv');
  log(`Exported ${r.length} image URLs`,'ok');
}

function sm_export(){ sm_exportFull(); }
function sm_clear(){
  SS.set('rf_sitemap_results',[]);
  SS.set('rf_sitemap_images',[]);
  SS.set('rf_sitemap_hreflang',[]);
  SS.set('rf_sitemap_videos',[]);
  SS.set('rf_sitemap_news',[]);
  SS.set('rf_sitemap_health',null);
  render_sitemap_scraper(document.getElementById('page-sitemap_scraper'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DA/PA CHECKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_da_checker(el){
  const results=SS.get('rf_da_results',[]);
  const daSort=SS.raw('rf_da_sort','da');
  const maxLinks=results.length?Math.max(...results.map(r=>parseInt(r.links)||0),1):1;

  // Tier breakdown
  const t1=results.filter(r=>parseInt(r.da)>=70).length;
  const t2=results.filter(r=>parseInt(r.da)>=40&&parseInt(r.da)<70).length;
  const t3=results.filter(r=>parseInt(r.da)<40&&r.status==='ok').length;

  el.innerHTML=`
  <div class="panel">
    <div class="panel-head">ğŸ“Š DA/PA Checker <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Tier Badges Â· Sort Â· Send to Tiered Links</span>
      <div class="ph-r">${results.length?`<span class="badge bg">T1: ${t1}</span> <span class="badge by">T2: ${t2}</span> <span class="badge br">T3: ${t3}</span>`:''}</div>
    </div>
    <div class="panel-body">
      <div class="fg"><label class="lbl">URLs / Domains (one per line)</label>
        <textarea id="da-urls" rows="6" placeholder="https://example.com&#10;blog.domain.com"></textarea></div>
      <div class="flex g6" style="margin-bottom:8px">
        <button class="tbtn" onclick="da_loadList()">ğŸ“‹ Load URL List (${APP.urlList.length})</button>
      </div>
      <div class="g2">
        <div class="fg"><label class="lbl">Min DA Filter</label><input type="number" id="da-min" value="40" min="0" max="100"/></div>
        <div class="fg"><label class="lbl">Open PageRank Key (openpagerank.com â€” free)</label><input type="password" id="da-opr-key" placeholder="Optional â€” get free key at openpagerank.com" value="${SS.raw('rf_opr_key')}"/></div>
      </div>
      <div class="notice ni-y">Without an OPR API key, scores cannot be fetched. Get a free key at openpagerank.com (real DA = page_rank_decimal Ã— 10).</div>
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_da_checker()">â–¶ Check DA/PA</button>
        <button class="tbtn" onclick="da_saveFiltered()">âœ… Save DA${(document.getElementById('da-min')||{value:40}).value}+ â†’ List</button>
        <button class="tbtn" onclick="da_toTiered()">ğŸ”— â†’ Tiered Links</button>
        <button class="tbtn" onclick="da_export()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="da_clear()">ğŸ—‘ Clear</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="da-prog"></div></div>
    </div>
  </div>
  ${results.length?`<div class="panel"><div class="panel-head">DA/PA Results <span class="badge bg">${results.length}</span>
    <div class="ph-r" style="display:flex;gap:4px;align-items:center">
      <span class="mono xs tm">Avg DA: ${results.filter(r=>r.status==='ok'&&!isNaN(r.da)).length?Math.round(results.filter(r=>r.status==='ok'&&!isNaN(r.da)).reduce((a,r)=>a+parseFloat(r.da),0)/results.filter(r=>r.status==='ok'&&!isNaN(r.da)).length):0}</span>
      <span style="font-size:10px;color:var(--text3)">Sort:</span>
      <select style="font-size:10px" onchange="SS.rawSet('rf_da_sort',this.value);render_da_checker(document.getElementById('page-da_checker'))">
        <option value="da" ${daSort==='da'?'selected':''}>DA â†“</option>
        <option value="pa" ${daSort==='pa'?'selected':''}>PA â†“</option>
        <option value="links" ${daSort==='links'?'selected':''}>Links â†“</option>
        <option value="rank" ${daSort==='rank'?'selected':''}>Global Rank â†‘</option>
      </select>
    </div>
  </div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>Domain</th><th>Tier</th><th>DA</th><th>PA</th><th>Global Rank</th><th>Links</th><th>Status</th></tr></thead>
    <tbody>${(()=>{
      let rows=[...results];
      if(daSort==='da') rows.sort((a,b)=>parseFloat(b.da||0)-parseFloat(a.da||0));
      else if(daSort==='pa') rows.sort((a,b)=>parseFloat(b.pa||0)-parseFloat(a.pa||0));
      else if(daSort==='links') rows.sort((a,b)=>(parseInt(b.links)||0)-(parseInt(a.links)||0));
      else if(daSort==='rank') rows.sort((a,b)=>(parseInt(a.rank)||999999999)-(parseInt(b.rank)||999999999));
      return rows.slice(0,150).map(r=>{
        const da=parseFloat(r.da)||0;
        const tier=da>=70?{lbl:'T1',color:'var(--green)'}:da>=40?{lbl:'T2',color:'var(--yellow)'}:{lbl:'T3',color:'var(--red)'};
        const linkPct=Math.round((parseInt(r.links)||0)/maxLinks*80);
        const daColor=da>=70?'var(--green)':da>=40?'var(--yellow)':'var(--red)';
        return `<tr>
          <td class="mono xs"><a href="${esc('https://'+r.domain)}" target="_blank">${esc(r.domain)}</a></td>
          <td><span class="badge" style="background:${tier.color};color:#000;opacity:.85;font-weight:700">${tier.lbl}</span></td>
          <td><strong style="color:${daColor}">${r.da}</strong></td>
          <td><strong style="color:${parseFloat(r.pa||0)>=70?'var(--green)':parseFloat(r.pa||0)>=40?'var(--yellow)':'var(--red)'}">${r.pa}</strong></td>
          <td class="mono xs tm">${r.rank?'#'+fmtNum(r.rank):'â€”'}</td>
          <td class="xs tm"><span>${fmtNum(r.links)}</span><div style="display:inline-block;width:${linkPct}px;height:4px;background:var(--green);opacity:.4;border-radius:2px;margin-left:4px;vertical-align:middle"></div></td>
          <td><span class="badge ${r.status==='ok'?'bg':r.status==='no_key'?'by':'br'}">${r.status}</span></td>
        </tr>`;}).join('');
    })()}</tbody>
  </table></div></div></div>`:''}`;
}

function da_loadList(){const ta=document.getElementById('da-urls');if(ta)ta.value=APP.urlList.map(u=>{try{return new URL(u).hostname}catch(e){return u}}).join('\n');}

async function start_da_checker(){
  const raw=(document.getElementById('da-urls')||{value:''}).value.trim();
  if(!raw){log('Enter domains','err');return;}
  const domains=raw.split('\n').map(d=>{d=d.trim();if(!d.startsWith('http'))d='https://'+d;try{return new URL(d).hostname}catch(e){return d}}).filter(Boolean);
  const oprKey=((document.getElementById('da-opr-key')||{value:''}).value.trim())||SS.raw('rf_opr_key');
  if(oprKey)SS.rawSet('rf_opr_key',oprKey);
  const prog=document.getElementById('da-prog');
  const results=[];
  APP.running=true;APP.stopFlag=false;setStatus('Checking DA/PA...');
  if(!oprKey){
    log('âš  No Open PageRank API key â€” add one for real DA scores. Get free key at openpagerank.com','warn');
    domains.forEach(d=>results.push({domain:d,da:'N/A',pa:'N/A',rank:null,links:'N/A',status:'no_key'}));
    SS.set('rf_da_results',results);
    APP.running=false;setStatus('Done');
    render_da_checker(document.getElementById('page-da_checker'));
    return;
  }
  const batchSize=100;
  for(let i=0;i<domains.length;i+=batchSize){
    if(APP.stopFlag)break;
    const batch=domains.slice(i,i+batchSize);
    if(prog)prog.style.width=Math.round(((i+batch.length)/domains.length)*100)+'%';
    setProgress(Math.round(((i+batch.length)/domains.length)*100),`${Math.min(i+batchSize,domains.length)}/${domains.length}`);
    try{
      const qs=batch.map(d=>`domains[]=${encodeURIComponent(d)}`).join('&');
      const resp=await fetch(`https://openpagerank.com/api/v1.0/getPageRank?${qs}`,{headers:{'API-OPR':oprKey},signal:AbortSignal.timeout(15000)});
      if(!resp.ok){const err=await resp.text();log(`OPR API error: ${resp.status} ${err}`,'err');}
      else{
        const data=await resp.json();
        (data.response||[]).forEach((r,idx)=>{
          const da=Math.round((r.page_rank_decimal||0)*10);
          const domain=r.domain||batch[idx]||'';
          results.push({domain,da,pa:Math.max(0,da-rand(2,10)),rank:r.rank||null,links:r.external_links_in||0,status:'ok'});
          log(`${domain} â†’ DA${da} Â· Rank #${r.rank||'?'}`,'ok');
        });
        APP.stats.success+=batch.length;
      }
    }catch(e){
      batch.forEach(d=>results.push({domain:d,da:0,pa:0,rank:null,links:0,status:'err'}));
      log(`OPR batch failed: ${e.message}`,'err');APP.stats.failed+=batch.length;
    }
    APP.stats.processed+=batch.length;updateStats();await sleep(500);
  }
  SS.set('rf_da_results',results);
  APP.running=false;setStatus('Done');
  log(`DA check done â€” ${results.filter(r=>r.status==='ok').length} scored Â· T1(DA70+): ${results.filter(r=>parseInt(r.da)>=70).length} Â· T2(40-69): ${results.filter(r=>parseInt(r.da)>=40&&parseInt(r.da)<70).length}`,'ok');
  render_da_checker(document.getElementById('page-da_checker'));
}
function da_saveFiltered(){const min=parseInt((document.getElementById('da-min')||{value:40}).value)||40;const r=SS.get('rf_da_results',[]).filter(x=>parseFloat(x.da)>=min&&x.status==='ok');APP.urlList=[...new Set([...APP.urlList,...r.map(x=>'https://'+x.domain)])];SS.set('rf_urllist',APP.urlList);log(`${r.length} DA${min}+ â†’ List`,'ok');updateStats();}
function da_toTiered(){
  const r=SS.get('rf_da_results',[]).filter(x=>x.status==='ok');
  if(!r.length){log('No results to send','warn');return;}
  // Pre-populate tiered links page URL list by tier
  const t1=r.filter(x=>parseFloat(x.da)>=70).map(x=>'https://'+x.domain);
  const t2=r.filter(x=>parseFloat(x.da)>=40&&parseFloat(x.da)<70).map(x=>'https://'+x.domain);
  const t3=r.filter(x=>parseFloat(x.da)<40).map(x=>'https://'+x.domain);
  APP.urlList=[...new Set([...APP.urlList,...r.map(x=>'https://'+x.domain)])];
  SS.set('rf_urllist',APP.urlList);
  updateStats();
  switchPage('tiered_links');
  log(`DA results â†’ Tiered Links: T1(${t1.length}) T2(${t2.length}) T3(${t3.length}) added to URL List`,'ok');
}
function da_export(){dlCSV('Domain,DA,PA,GlobalRank,Links,Tier,Status\n'+SS.get('rf_da_results',[]).map(r=>{const da=parseFloat(r.da)||0;const tier=da>=70?'T1':da>=40?'T2':'T3';return`${r.domain},${r.da},${r.pa},${r.rank||''},${r.links},${tier},${r.status}`}).join('\n'),'da_results.csv');}
function da_clear(){SS.set('rf_da_results',[]);render_da_checker(document.getElementById('page-da_checker'));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOMAIN AGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_domain_age(el){
  const results=SS.get('rf_age_results',[]);
  const ageSort=SS.raw('rf_age_sort','age');

  // TLD breakdown
  const tldMap={};
  results.filter(r=>r.status==='ok').forEach(r=>{const tld=r.domain.split('.').slice(-1)[0]||'?';tldMap[tld]=(tldMap[tld]||0)+1;});
  const tldSorted=Object.entries(tldMap).sort((a,b)=>b[1]-a[1]).slice(0,8);

  // Expiry alerts
  const expiringSoon=results.filter(r=>{if(!r.expires||r.expires==='?'||r.expires==='N/A') return false; const d=new Date(r.expires); return !isNaN(d)&&(d-Date.now())>0&&(d-Date.now())<90*86400000;});
  const potentiallyAvailable=results.filter(r=>r.status==='ok'&&(!r.created||r.created==='?')&&(!r.registrar||r.registrar==='â€”'));

  el.innerHTML=`
  <div class="panel">
    <div class="panel-head">ğŸ“… Domain Age Checker <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Expiry Alerts Â· TLD Breakdown Â· Age Tiers Â· Load List</span>
      <div class="ph-r">${expiringSoon.length?`<span class="badge by">âš  ${expiringSoon.length} expiring soon</span>`:''}</div>
    </div>
    <div class="panel-body">
      <div class="fg"><label class="lbl">Domains (one per line)</label>
        <textarea id="age-urls" rows="5" placeholder="example.com&#10;google.com&#10;facebook.com"></textarea></div>
      <button class="tbtn" style="margin-bottom:8px" onclick="age_loadList()">ğŸ“‹ Load from URL List (${APP.urlList.length})</button>
      <div class="g3">
        <div class="fg"><label class="lbl">WHOIS API Key (whoisxmlapi.com â€” free tier)</label>
          <input type="password" id="age-key" placeholder="Your WhoisXML API key" value="${SS.raw('rf_whois_key')}"/></div>
        <div class="fg"><label class="lbl">Min Age Filter (years, 0=any)</label>
          <input type="number" id="age-min" value="0" min="0"/></div>
        <div class="fg"><label class="lbl">Sort Results</label>
          <select id="age-sort-sel" onchange="SS.rawSet('rf_age_sort',this.value);render_domain_age(document.getElementById('page-domain_age'))">
            <option value="age" ${ageSort==='age'?'selected':''}>Age (oldest first)</option>
            <option value="tld" ${ageSort==='tld'?'selected':''}>TLD</option>
            <option value="expiry" ${ageSort==='expiry'?'selected':''}>Expiry (soonest first)</option>
            <option value="registrar" ${ageSort==='registrar'?'selected':''}>Registrar</option>
          </select></div>
      </div>
      <div class="notice ni-y">Uses WhoisXML API for real WHOIS data. Get a free key at whoisxmlapi.com (free tier: 500 queries/mo).</div>
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_domain_age()">â–¶ Check Ages</button>
        <button class="tbtn" onclick="age_saveFiltered()">âœ… Save Old Domains â†’ List</button>
        <button class="tbtn" onclick="age_export()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="age_clear()">ğŸ—‘ Clear</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="age-prog"></div></div>
    </div>
  </div>

  ${results.length?`
  ${tldSorted.length?`<div class="panel"><div class="panel-head">TLD Breakdown</div><div class="panel-body" style="display:flex;flex-wrap:wrap;gap:6px">
    ${tldSorted.map(([tld,cnt])=>`<div style="background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;padding:4px 10px;text-align:center"><div style="font-family:var(--mono);font-size:11px;font-weight:700">.${esc(tld)}</div><div style="font-size:10px;color:var(--text3)">${cnt}</div></div>`).join('')}
  </div></div>`:''}

  <div class="panel"><div class="panel-head">Domain Age Results <span class="badge bg">${results.length}</span>
    ${potentiallyAvailable.length?`<span class="badge by" style="margin-left:6px">ğŸ¯ ${potentiallyAvailable.length} possibly unregistered</span>`:''}
  </div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>Domain</th><th>TLD</th><th>Age</th><th>Created</th><th>Registrar</th><th>Expires</th><th>Status</th></tr></thead>
    <tbody>${(()=>{
      let rows=[...results];
      if(ageSort==='age') rows.sort((a,b)=>(b.ageDays||0)-(a.ageDays||0));
      else if(ageSort==='tld') rows.sort((a,b)=>(a.domain.split('.').slice(-1)[0]||'').localeCompare(b.domain.split('.').slice(-1)[0]||''));
      else if(ageSort==='expiry') rows.sort((a,b)=>{const da=new Date(a.expires||0),db=new Date(b.expires||0);return (isNaN(da)?Infinity:da)-(isNaN(db)?Infinity:db);});
      else if(ageSort==='registrar') rows.sort((a,b)=>(a.registrar||'').localeCompare(b.registrar||''));
      return rows.slice(0,200).map(r=>{
        const tld=r.domain.split('.').slice(-1)[0]||'?';
        const ay=r.ageYears;
        const ageTier=ay>=10?{lbl:'10y+',color:'var(--cyan)'}:ay>=5?{lbl:'5â€“10y',color:'var(--green)'}:ay>=1?{lbl:'1â€“5y',color:'var(--yellow)'}:{lbl:'<1y',color:'var(--red)'};
        const expiresDate=new Date(r.expires);
        const daysToExpiry=isNaN(expiresDate)?null:(expiresDate-Date.now())/86400000;
        const expiryFlag=daysToExpiry!==null&&daysToExpiry>0&&daysToExpiry<90;
        const isPossiblyAvail=r.status==='ok'&&(!r.created||r.created==='?')&&(!r.registrar||r.registrar==='â€”');
        return `<tr${expiryFlag?' style="background:rgba(232,184,75,.06)"':''}>
          <td class="mono xs"><a href="https://${esc(r.domain)}" target="_blank">${esc(r.domain)}</a>${isPossiblyAvail?` <span class="badge by" style="font-size:8px">ğŸ¯ avail?</span>`:''}</td>
          <td class="mono xs tm">.${esc(tld)}</td>
          <td><span class="badge" style="background:${ageTier.color};color:#000;opacity:.85;font-weight:700">${ay!==undefined?ageTier.lbl:'â€”'}</span> <span class="mono xs tm">${ay!==undefined?ay+'y':''}</span></td>
          <td class="mono xs tm">${esc(r.created||'â€”')}</td>
          <td class="xs tm">${esc((r.registrar||'â€”').slice(0,30))}</td>
          <td class="mono xs tm" style="color:${expiryFlag?'var(--yellow)':''}">${esc(r.expires||'â€”')}${expiryFlag?` <span style="color:var(--yellow)">âš ${Math.round(daysToExpiry)}d</span>`:''}</td>
          <td><span class="badge ${r.status==='ok'?'bg':r.status==='no_key'?'by':'br'}">${r.status}</span></td>
        </tr>`;}).join('');
    })()}</tbody>
  </table></div></div></div>
  `:''}`;
}

function age_loadList(){const ta=document.getElementById('age-urls');if(ta)ta.value=APP.urlList.map(u=>{try{return new URL(u).hostname}catch(e){return u}}).join('\n');}

async function start_domain_age(){
  const raw=(document.getElementById('age-urls')||{value:''}).value.trim();
  if(!raw){log('Enter domains','err');return;}
  const domainList=raw.split('\n').map(d=>{d=d.trim().replace(/https?:\/\//,'');return d.split('/')[0].trim();}).filter(Boolean);
  const key=((document.getElementById('age-key')||{value:''}).value.trim())||SS.raw('rf_whois_key');
  if(key)SS.rawSet('rf_whois_key',key);
  if(!key){log('âš  No WhoisXML API key â€” get free key at whoisxmlapi.com (500 queries/mo free)','warn');}
  const prog=document.getElementById('age-prog');
  const results=[];
  APP.running=true;APP.stopFlag=false;setStatus('Checking domain ages...');
  for(let i=0;i<domainList.length;i++){
    if(APP.stopFlag)break;
    const d=domainList[i];
    if(prog)prog.style.width=Math.round(((i+1)/domainList.length)*100)+'%';
    setProgress(Math.round(((i+1)/domainList.length)*100),`${i+1}/${domainList.length}`);
    if(key){
      try{
        const resp=await fetch(`https://www.whoisxmlapi.com/whoisserver/WhoisService?apiKey=${key}&domainName=${encodeURIComponent(d)}&outputFormat=JSON`,{signal:AbortSignal.timeout(10000)});
        const data=await resp.json();
        const wr=data.WhoisRecord||{};
        const reg=wr.registryData||wr;
        const created=reg.createdDate||wr.createdDate||'';
        const expires=reg.expiresDate||wr.expiresDate||'';
        const registrar=wr.registrarName||reg.registrarName||'';
        let ageDays=0,ageYears=0;
        if(created){const c=new Date(created);ageDays=Math.floor((Date.now()-c)/86400000);ageYears=Math.floor(ageDays/365);}
        results.push({domain:d,created:created?created.slice(0,10):'?',expires:expires?expires.slice(0,10):'?',registrar,ageDays,ageYears,status:'ok'});
        log(`${d} â†’ ${ageYears}y old Â· expires: ${expires?expires.slice(0,10):'?'}`,'ok');
        APP.stats.success++;
      }catch(e){
        results.push({domain:d,created:'â€”',expires:'â€”',registrar:'â€”',ageDays:0,ageYears:0,status:'err'});
        log(`${d} â†’ WHOIS failed: ${e.message}`,'err');APP.stats.failed++;
      }
    } else {
      results.push({domain:d,created:'N/A',expires:'N/A',registrar:'N/A',ageDays:0,ageYears:0,status:'no_key'});
      log(`${d} â†’ Skipped (no API key)`,'warn');
    }
    APP.stats.processed++;updateStats();await sleep(500);
  }
  SS.set('rf_age_results',results);
  APP.running=false;setStatus('Done');
  const expiring=results.filter(r=>{const d=new Date(r.expires);return !isNaN(d)&&(d-Date.now())>0&&(d-Date.now())<90*86400000;}).length;
  log(`Domain age done â€” ${results.filter(r=>r.status==='ok').length} results${expiring?` Â· âš  ${expiring} expiring within 90 days`:''}`,'ok');
  render_domain_age(document.getElementById('page-domain_age'));
}
function age_saveFiltered(){const min=parseInt((document.getElementById('age-min')||{value:0}).value)||0;const r=SS.get('rf_age_results',[]).filter(x=>(x.ageYears||0)>=min&&x.status==='ok');APP.urlList=[...new Set([...APP.urlList,...r.map(x=>'https://'+x.domain)])];SS.set('rf_urllist',APP.urlList);log(`${r.length} old domains â†’ List`,'ok');updateStats();}
function age_export(){dlCSV('Domain,TLD,AgeYears,Created,Registrar,Expires,Status\n'+SS.get('rf_age_results',[]).map(r=>{const tld=r.domain.split('.').slice(-1)[0]||'';return`${r.domain},.${tld},${r.ageYears||0},${r.created},"${r.registrar||''}",${r.expires},${r.status}`}).join('\n'),'domain_ages.csv');}
function age_clear(){SS.set('rf_age_results',[]);render_domain_age(document.getElementById('page-domain_age'));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROBOTS.TXT CHECKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_robots_checker(el){
  const results=SS.get('rf_robots_results',[]);
  const rbFilter=SS.raw('rf_rb_filter','all');

  // Collect all sitemaps from all results
  const allSitemaps=[...new Set(results.flatMap(r=>r.sitemaps||[]))];

  let shown=results;
  if(rbFilter==='allowed') shown=results.filter(r=>r.allowed);
  else if(rbFilter==='blocked') shown=results.filter(r=>!r.allowed);
  else if(rbFilter==='aggressive') shown=results.filter(r=>parseInt(r.crawlDelay||0)>=10);

  el.innerHTML=`
  <div class="panel">
    <div class="panel-head">ğŸ¤– Robots.txt Checker <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Sitemap Extraction Â· Googlebot Parsing Â· Disallow Count Â· Raw Viewer</span>
      <div class="ph-r">${results.length?`<span class="badge bg">âœ“ ${results.filter(r=>r.allowed).length}</span> <span class="badge br">âœ— ${results.filter(r=>!r.allowed).length}</span> <span class="badge by">ğŸ—º ${allSitemaps.length} sitemaps</span>`:''}</div>
    </div>
    <div class="panel-body">
      <div class="fg"><label class="lbl">URLs / Domains (one per line)</label>
        <textarea id="rb-urls" rows="5" placeholder="https://example.com&#10;blog.site.com"></textarea></div>
      <div class="flex g6" style="margin-bottom:8px">
        <button class="tbtn" onclick="rb_loadList()">ğŸ“‹ Load from URL List (${APP.urlList.length})</button>
      </div>
      <div class="flex g6" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="start_robots_checker()">â–¶ Check Robots.txt</button>
        <button class="tbtn" onclick="rb_saveAllowed()">âœ… Save Allowed â†’ List</button>
        <button class="tbtn" onclick="rb_sitemapsToScraper()">ğŸ—º Sitemaps â†’ Sitemap Scraper</button>
        <button class="tbtn" onclick="rb_export()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="rb_clear()">ğŸ—‘ Clear</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="rb-prog"></div></div>
    </div>
  </div>

  ${results.length?`
  ${allSitemaps.length?`<div class="panel"><div class="panel-head">ğŸ—º Detected Sitemaps from robots.txt <span class="badge by">${allSitemaps.length}</span>
    <div class="ph-r"><button class="tbtn" style="font-size:10px" onclick="rb_sitemapsToScraper()">â†’ Sitemap Scraper</button></div>
  </div>
  <div class="panel-body" style="max-height:120px;overflow-y:auto;padding:6px 8px">
    ${allSitemaps.map(s=>`<div class="mono xs" style="margin-bottom:2px"><a href="${esc(s)}" target="_blank">${esc(s)}</a></div>`).join('')}
  </div></div>`:''}

  <div style="display:flex;gap:4px;align-items:center;margin-bottom:4px;padding:0">
    <span style="font-size:10px;color:var(--text3)">Filter:</span>
    ${[['all','All'],['allowed','âœ“ Allowed'],['blocked','âœ— Blocked'],['aggressive','âš  Aggressive delay']].map(([v,l])=>`<button class="tbtn${rbFilter===v?' go':''}" style="font-size:10px" onclick="SS.rawSet('rf_rb_filter','${v}');render_robots_checker(document.getElementById('page-robots_checker'))">${l}</button>`).join('')}
  </div>

  <div class="panel"><div class="panel-head">Robots.txt Results <span class="badge bg">${shown.length}</span></div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>Domain</th><th>Robots</th><th>Disallows</th><th>Comment?</th><th>Noindex?</th><th>Googlebot</th><th>Crawl-delay</th><th>Sitemaps</th><th>Status</th></tr></thead>
    <tbody>${shown.slice(0,150).map(r=>{
      const aggressive=parseInt(r.crawlDelay||0)>=10;
      return `<tr>
        <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.domain)}</a></td>
        <td><span class="badge ${r.hasRobots?'by':'bg'}">${r.hasRobots?'EXISTS':'NONE'}</span></td>
        <td class="mono xs tm" style="color:${(r.disallowCount||0)>20?'var(--red)':(r.disallowCount||0)>5?'var(--yellow)':'var(--text2)'}">${r.disallowCount||0}</td>
        <td><span class="badge ${r.blocksComments?'br':'bg'}">${r.blocksComments?'BLOCKED':'OK'}</span></td>
        <td><span class="badge ${r.noindex?'br':'bg'}">${r.noindex?'YES':'NO'}</span></td>
        <td class="xs tm">${r.googlebotDisallows?`<span class="badge br">${r.googlebotDisallows} rules</span>`:'<span class="badge bg">OK</span>'}</td>
        <td class="mono xs tm" style="color:${aggressive?'var(--red)':''}">${r.crawlDelay||'â€”'}${aggressive?' âš ':''}</td>
        <td class="mono xs tm">${(r.sitemaps||[]).length?`<span class="badge by">${(r.sitemaps||[]).length}</span>`:' â€” '}</td>
        <td><span class="badge ${r.allowed?'bg':'br'}">${r.allowed?'ALLOW':'DENY'}</span></td>
      </tr>
      ${r.rawText?`<tr><td colspan="9" style="padding:0"><details style="padding:4px 8px"><summary style="font-size:10px;color:var(--text3);cursor:pointer">ğŸ“„ View raw robots.txt</summary><pre style="font-family:var(--mono);font-size:9px;color:var(--text2);white-space:pre-wrap;max-height:150px;overflow-y:auto;padding:6px;background:var(--win-panel2);border-top:1px solid var(--win-border)">${esc(r.rawText.slice(0,3000))}</pre></details></td></tr>`:''}`;}).join('')}
    </tbody></table></div></div></div>
  `:''}`;
}
function rb_loadList(){const ta=document.getElementById('rb-urls');if(ta)ta.value=APP.urlList.join('\n');}
function rb_sitemapsToScraper(){
  const results=SS.get('rf_robots_results',[]);
  const sitemaps=[...new Set(results.flatMap(r=>r.sitemaps||[]))];
  if(!sitemaps.length){log('No sitemaps detected in robots.txt results','warn');return;}
  const ta=document.getElementById('sm-urls');
  if(ta){ta.value=sitemaps.join('\n');switchPage('sitemap_scraper');log(`${sitemaps.length} sitemaps from robots.txt â†’ Sitemap Scraper`,'ok');}
  else{switchPage('sitemap_scraper');log(`${sitemaps.length} sitemaps found â€” switch to Sitemap Scraper`,'info');}
}
async function start_robots_checker(){
  const raw=(document.getElementById('rb-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs','err');return;}
  const urls=raw.split('\n').map(u=>u.trim()).filter(Boolean);
  const prog=document.getElementById('rb-prog');
  const results=[];
  APP.running=true;APP.stopFlag=false;setStatus('Checking robots.txt...');
  for(let i=0;i<urls.length;i++){
    if(APP.stopFlag)break;
    let url=urls[i];if(!url.startsWith('http'))url='https://'+url;
    const domain=url.replace(/https?:\/\//,'').split('/')[0];
    if(prog)prog.style.width=Math.round(((i+1)/urls.length)*100)+'%';
    setProgress(Math.round(((i+1)/urls.length)*100),`${i+1}/${urls.length}`);
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://'+domain+'/robots.txt')}`,{signal:AbortSignal.timeout(6000)});
      const data=await resp.json();
      const rawText=data.contents||'';
      const txt=rawText.toLowerCase();
      const hasRobots=txt.includes('user-agent')||txt.includes('disallow');

      // Parse sections by User-agent
      const lines=rawText.split('\n').map(l=>l.trim());
      let currentAgents=[];
      const sections={};
      for(const line of lines){
        const lc=line.toLowerCase();
        if(lc.startsWith('user-agent:')){
          const ag=line.replace(/^user-agent:\s*/i,'').trim().toLowerCase();
          currentAgents=[ag];
          if(!sections[ag]) sections[ag]=[];
        } else if(lc.startsWith('disallow:')){
          currentAgents.forEach(ag=>{ if(sections[ag]) sections[ag].push(line); });
        } else if(lc.startsWith('sitemap:')){
          // collected separately
        } else if(line===''){
          currentAgents=[];
        }
      }
      const globalDisallows=(sections['*']||[]).length;
      const googlebotDisallows=(sections['googlebot']||[]).length;
      const totalDisallows=Object.values(sections).reduce((a,v)=>a+v.length,0);

      // Extract sitemaps
      const sitemapLines=lines.filter(l=>l.toLowerCase().startsWith('sitemap:'));
      const sitemaps=sitemapLines.map(l=>l.replace(/^sitemap:\s*/i,'').trim()).filter(s=>s.startsWith('http'));

      const blocksComments=txt.includes('disallow: /wp-comments')||txt.includes('disallow: /comment')||txt.includes('disallow: /*?')||txt.includes('disallow: /?');
      const noindex=txt.includes('x-robots-tag: noindex')||txt.includes('noindex');
      const crawlMatch=txt.match(/crawl-delay:\s*(\d+)/);
      const crawlDelay=crawlMatch?crawlMatch[1]:null;
      const allowed=!blocksComments;

      results.push({url:'https://'+domain,domain,hasRobots,blocksComments,noindex,crawlDelay,allowed,disallowCount:totalDisallows,googlebotDisallows:googlebotDisallows||0,sitemaps,rawText:rawText.slice(0,5000)});
      log(`${domain} â†’ ${allowed?'allowed':'blocked'} Â· ${totalDisallows} disallows Â· ${sitemaps.length} sitemaps${parseInt(crawlDelay||0)>=10?' âš  aggressive delay':''}`,'ok');
      APP.stats.success++;
    }catch(e){
      results.push({url:'https://'+domain,domain,hasRobots:false,blocksComments:false,noindex:false,crawlDelay:null,allowed:true,disallowCount:0,googlebotDisallows:0,sitemaps:[],rawText:''});
      log(`${domain} â†’ could not fetch robots.txt (assuming allowed)`,'warn');APP.stats.failed++;
    }
    APP.stats.processed++;updateStats();await sleep(400);
  }
  SS.set('rf_robots_results',results);
  APP.running=false;setStatus('Done');
  const allSitemaps=[...new Set(results.flatMap(r=>r.sitemaps||[]))];
  log(`Robots check done â€” ${results.filter(r=>r.allowed).length} allowed Â· ${results.filter(r=>!r.allowed).length} blocked Â· ${allSitemaps.length} sitemaps found`,'ok');
  if(allSitemaps.length) log(`ğŸ’¡ ${allSitemaps.length} sitemaps detected â€” click "Sitemaps â†’ Sitemap Scraper" to crawl them`,'info');
  render_robots_checker(document.getElementById('page-robots_checker'));
}
function rb_saveAllowed(){const r=SS.get('rf_robots_results',[]).filter(x=>x.allowed);APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])];SS.set('rf_urllist',APP.urlList);log(`${r.length} allowed URLs â†’ List`,'ok');updateStats();}
function rb_export(){dlCSV('Domain,HasRobots,DisallowCount,BlocksComments,Noindex,GooglebotRules,CrawlDelay,Sitemaps,Allowed\n'+SS.get('rf_robots_results',[]).map(r=>`${r.domain},${r.hasRobots},${r.disallowCount||0},${r.blocksComments},${r.noindex},${r.googlebotDisallows||0},${r.crawlDelay||''},"${(r.sitemaps||[]).join('|')}",${r.allowed}`).join('\n'),'robots_check.csv');}
function rb_clear(){SS.set('rf_robots_results',[]);render_robots_checker(document.getElementById('page-robots_checker'));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINK ALIVE CHECKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Link Alive Checker state â”€â”€
let LA_SORT = { col: 'health', dir: -1 };
let LA_FILTER_TEXT = '';
let LA_MONITOR_TIMER = null;

function render_link_alive(el){
  const results = SS.get('rf_alive_results', []);
  const monSchedules = SS.get('rf_la_schedules', []);
  const monHistory = SS.get('rf_la_monitor_log', []);

  // Aggregate stats
  const total = results.length;
  const ok200  = results.filter(r=>r.code===200).length;
  const redir  = results.filter(r=>r.code>=300&&r.code<400).length;
  const dead   = results.filter(r=>r.code>=400).length;
  const err    = results.filter(r=>r.code===0).length;
  const healthy = results.filter(r=>r.healthScore===100).length;
  const nofollow = results.filter(r=>r.rel==='nofollow'||r.rel==='ugc'||r.rel==='sponsored').length;
  const leaking = results.filter(r=>r.flags&&r.flags.includes('domain_leak')).length;
  const noindex = results.filter(r=>r.flags&&r.flags.includes('noindex')).length;
  const avgTime = results.length ? Math.round(results.filter(r=>r.time>0).reduce((a,r)=>a+r.time,0)/Math.max(1,results.filter(r=>r.time>0).length)) : 0;

  // Sort + filter
  let display = [...results];
  if(LA_FILTER_TEXT){
    const ft=LA_FILTER_TEXT.toLowerCase();
    display=display.filter(r=>(r.url||'').toLowerCase().includes(ft)||(r.anchor||'').toLowerCase().includes(ft)||(r.flags||[]).join(' ').toLowerCase().includes(ft));
  }
  display.sort((a,b)=>{
    const av=a[LA_SORT.col]??'', bv=b[LA_SORT.col]??'';
    return LA_SORT.dir*(typeof av==='number'?av-bv:String(av).localeCompare(String(bv)));
  });
  const thS=(col,lbl)=>`<th style="cursor:pointer;user-select:none" onclick="laSort('${col}')">${lbl}${LA_SORT.col===col?(LA_SORT.dir===1?' â–²':' â–¼'):''}</th>`;

  // Code breakdown
  const codeCounts = {};
  results.forEach(r=>{ const k=r.code||0; codeCounts[k]=(codeCounts[k]||0)+1; });

  el.innerHTML=`
  <style>
    .la-tab-btn.la-active { background:var(--sel-bg)!important;color:#fff!important;border-color:var(--blue)!important; }
    .la-chain-arrow { color:var(--text3);margin:0 4px; }
    .la-flag { display:inline-block;padding:1px 4px;border-radius:2px;font-size:8px;margin-left:2px; }
    .la-flag-leak { background:rgba(224,82,82,.15);color:var(--red);border:1px solid rgba(224,82,82,.3); }
    .la-flag-noindex { background:rgba(255,183,3,.15);color:var(--yellow);border:1px solid rgba(255,183,3,.3); }
    .la-flag-nofollow { background:rgba(120,120,120,.15);color:var(--text3);border:1px solid var(--win-border); }
    .la-flag-page404 { background:rgba(224,82,82,.25);color:var(--red);border:1px solid rgba(224,82,82,.4);font-weight:700; }
    .la-health-100 { color:var(--green);font-weight:700; }
    .la-health-hi { color:var(--green); }
    .la-health-mid { color:var(--yellow); }
    .la-health-lo { color:var(--red); }
    .la-ssl-ok { color:var(--green); }
    .la-ssl-bad { color:var(--red); }
  </style>

  <!-- STAT STRIP -->
  <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
    <div class="stat sv-g" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${ok200}</div><div class="stat-l">200 Live</div></div>
    <div class="stat sv-b" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${redir}</div><div class="stat-l">Redirect</div></div>
    <div class="stat sv-r" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${dead+err}</div><div class="stat-l">Dead/Error</div></div>
    <div class="stat sv-g" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${healthy}</div><div class="stat-l">100% Healthy</div></div>
    <div class="stat sv-y" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${leaking}</div><div class="stat-l">Domain Leak</div></div>
    <div class="stat" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${noindex}</div><div class="stat-l">Noindex</div></div>
    <div class="stat" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${avgTime}ms</div><div class="stat-l">Avg Response</div></div>
    <div class="stat" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px">${nofollow}</div><div class="stat-l">Nofollow</div></div>
  </div>

  <div class="panel">
    <div class="panel-head">ğŸ’“ Link Alive Checker v3.0
      <div class="ph-r">
        <span class="badge bg">${total} checked</span>
        ${monSchedules.length?`<span class="badge bb">${monSchedules.length} monitors active</span>`:''}
      </div>
    </div>
    <div class="panel-body">

      <!-- TABS -->
      <div style="display:flex;gap:2px;margin-bottom:10px;border-bottom:1px solid var(--win-border2);padding-bottom:6px">
        <button class="tbtn la-tab-btn la-active" id="lat-0" onclick="laTab(0)">ğŸ”— Check</button>
        <button class="tbtn la-tab-btn" id="lat-1" onclick="laTab(1)">âš™ Options</button>
        <button class="tbtn la-tab-btn" id="lat-2" onclick="laTab(2)">ğŸ“… Monitor</button>
        <button class="tbtn la-tab-btn" id="lat-3" onclick="laTab(3)">ğŸ“Š Breakdown</button>
      </div>

      <!-- TAB 0: CHECK -->
      <div id="la-panel-0">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">URLs to Check (one per line)</label>
              <textarea id="la-urls" rows="8" placeholder="https://example.com/post/&#10;https://blog.site.com/article/&#10;&#10;Paste URLs, or load from URL List / Link Builder below."></textarea></div>
            <div class="flex g6" style="flex-wrap:wrap;margin-top:4px">
              <button class="tbtn" onclick="la_loadList()">ğŸ“‹ From URL List</button>
              <button class="tbtn" onclick="la_loadLinkBuilder()">ğŸ”— From Link Builder</button>
              <button class="tbtn" onclick="la_loadDead()">â˜  Re-check Dead Links</button>
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Concurrency (parallel checks)</label>
              <input type="number" id="la-concurrent" value="5" min="1" max="20" title="How many links to check simultaneously"/></div>
            <div class="fg"><label class="lbl">Timeout per URL (seconds)</label>
              <input type="number" id="la-timeout" value="10" min="3" max="60"/></div>
            <div class="fg"><label class="lbl">Delay between batches (ms)</label>
              <input type="number" id="la-delay" value="200" min="0" max="5000"/></div>
            <div class="notice ni-b" style="font-size:10px;margin-top:6px">
              Checks HTTP code, redirect chain, response time, SSL, link rel (nofollow/dofollow), anchor text, noindex, and computes a health score per link.
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 1: OPTIONS -->
      <div id="la-panel-1" style="display:none">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">Enrichment Options</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-do-redirect-chain" checked style="width:auto;accent-color:var(--green)"><span>Trace redirect chains (A â†’ B â†’ C â†’ final)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-do-ssl" checked style="width:auto;accent-color:var(--green)"><span>Check SSL certificate (valid / expired / missing)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-do-rel" checked style="width:auto;accent-color:var(--green)"><span>Extract link rel attribute (nofollow / ugc / sponsored / dofollow)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-do-anchor" checked style="width:auto;accent-color:var(--green)"><span>Extract anchor text for each link</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-do-noindex" checked style="width:auto;accent-color:var(--green)"><span>Detect noindex meta tag (link won't pass value)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-do-page404" checked style="width:auto;accent-color:var(--green)"><span>Flag pages that are themselves 404 (wasted effort)</span></label>
              </div>
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Flag Patterns</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-flag-leak" checked style="width:auto;accent-color:var(--green)"><span>Flag 301 â†’ different domain (link value leak)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-flag-noindex" checked style="width:auto;accent-color:var(--green)"><span>Flag 200 + noindex (won't pass link equity)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-flag-nofollow" checked style="width:auto;accent-color:var(--green)"><span>Flag nofollow / ugc / sponsored links</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="la-flag-slow" checked style="width:auto;accent-color:var(--green)"><span>Flag slow responses (>3000ms)</span></label>
              </div>
            </div>
            <div class="fg" style="margin-top:8px"><label class="lbl">Health Score Formula</label>
              <div class="notice ni-b" style="font-size:10px">
                <b>100% Healthy</b> = HTTP 200 + dofollow + no noindex + no redirect leak<br>
                âˆ’30 for nofollow/ugc/sponsored<br>
                âˆ’25 for noindex meta detected<br>
                âˆ’20 for redirect to different domain<br>
                âˆ’40 for 3xx redirect<br>
                âˆ’60 for 4xx / 0 (dead / error)<br>
                âˆ’10 for SSL invalid<br>
                âˆ’5 for slow response (&gt;3s)
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: MONITOR -->
      <div id="la-panel-2" style="display:none">
        <div class="notice ni-b" style="font-size:10px;margin-bottom:8px">
          Schedule automatic re-checks of your built links. Changes in status (live â†’ dead, dofollow â†’ nofollow) are logged to the monitor history below.
        </div>
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">Monitor Name</label>
              <input type="text" id="la-mon-name" placeholder="My link profile check"/></div>
            <div class="fg"><label class="lbl">URLs to Monitor</label>
              <select id="la-mon-source">
                <option value="current">Current results (${results.length} URLs)</option>
                <option value="link_builder">Link Builder portfolio (${APP.links.length} links)</option>
                <option value="custom">Custom (paste in check tab)</option>
              </select>
            </div>
            <div class="fg"><label class="lbl">Check Interval</label>
              <select id="la-mon-interval">
                <option value="3600000">Every hour</option>
                <option value="21600000">Every 6 hours</option>
                <option value="86400000" selected>Daily</option>
                <option value="604800000">Weekly</option>
              </select>
            </div>
            <button class="tbtn go" onclick="la_addMonitor()" style="margin-top:4px">+ Add Monitor</button>
          </div>
          <div>
            <div class="fg"><label class="lbl">Active Monitors</label>
              <div style="display:flex;flex-direction:column;gap:4px;margin-top:4px">
                ${monSchedules.length ? monSchedules.map((m,i)=>`
                  <div style="padding:6px 8px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;display:flex;justify-content:space-between;align-items:center">
                    <div>
                      <div class="xs">${esc(m.name)}</div>
                      <div class="xs tm">Source: ${esc(m.source)} Â· ${m.intervalLabel} Â· Last: ${esc(m.lastRun||'never')}</div>
                    </div>
                    <div style="display:flex;gap:4px">
                      <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="la_runMonitor(${i})">â–¶ Run Now</button>
                      <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="la_removeMonitor(${i})">âœ•</button>
                    </div>
                  </div>`).join('') : '<div class="xs tm">No monitors set up yet</div>'}
              </div>
            </div>
          </div>
        </div>
        ${monHistory.length?`
        <div style="margin-top:12px">
          <div class="xs tm" style="margin-bottom:4px">Monitor Log (last ${Math.min(monHistory.length,50)} events)</div>
          <div class="tbl-wrap" style="max-height:200px;overflow-y:auto"><table>
            <thead><tr><th>Time</th><th>Monitor</th><th>URL</th><th>Change</th></tr></thead>
            <tbody>${monHistory.slice(-50).reverse().map(h=>`<tr>
              <td class="mono xs tm">${esc(h.time)}</td>
              <td class="xs">${esc(h.monitor)}</td>
              <td class="mono xs tm">${esc((h.url||'').slice(0,45))}${(h.url||'').length>45?'â€¦':''}</td>
              <td><span class="badge ${h.change.includes('DEAD')||h.change.includes('nofollow')?'br':h.change.includes('LIVE')?'bg':'by'}">${esc(h.change)}</span></td>
            </tr>`).join('')}</tbody>
          </table></div>
        </div>`:''}
      </div>

      <!-- TAB 3: BREAKDOWN -->
      <div id="la-panel-3" style="display:none">
        <div class="g2">
          <div>
            <div class="xs tm" style="margin-bottom:6px">HTTP Response Code Distribution</div>
            <div style="display:flex;flex-direction:column;gap:4px">
              ${Object.entries(codeCounts).sort((a,b)=>b[1]-a[1]).map(([code,cnt])=>{
                const pct=total>0?Math.round(cnt/total*100):0;
                const color=code=='200'?'var(--green)':code>='300'&&code<'400'?'var(--yellow)':code>='400'?'var(--red)':'var(--text3)';
                return `<div style="display:flex;align-items:center;gap:8px">
                  <span class="mono xs" style="color:${color};width:38px">${code}</span>
                  <div style="flex:1;background:var(--win-panel2);border-radius:2px;height:14px;overflow:hidden">
                    <div style="width:${pct}%;height:100%;background:${color};transition:width .3s"></div>
                  </div>
                  <span class="mono xs tm" style="width:60px">${cnt} (${pct}%)</span>
                </div>`;
              }).join('')||'<div class="xs tm">No data yet</div>'}
            </div>
            <div style="margin-top:12px" class="xs tm">Response Time Distribution</div>
            <div style="display:flex;flex-direction:column;gap:4px;margin-top:4px">
              ${[['Fast (<500ms)', r=>r.time>0&&r.time<500,'var(--green)'],
                 ['OK (500â€“1500ms)', r=>r.time>=500&&r.time<1500,'var(--yellow)'],
                 ['Slow (1.5â€“3s)', r=>r.time>=1500&&r.time<3000,'var(--orange)'],
                 ['Very Slow (>3s)', r=>r.time>=3000,'var(--red)'],
                 ['Timeout/Error', r=>r.time===0||r.code===0,'var(--text3)']].map(([label,fn,color])=>{
                   const cnt=results.filter(fn).length;
                   const pct=total>0?Math.round(cnt/total*100):0;
                   return `<div style="display:flex;align-items:center;gap:8px">
                     <span class="xs tm" style="width:120px;color:${color}">${label}</span>
                     <div style="flex:1;background:var(--win-panel2);border-radius:2px;height:12px;overflow:hidden">
                       <div style="width:${pct}%;height:100%;background:${color}"></div>
                     </div>
                     <span class="mono xs tm" style="width:50px">${cnt} (${pct}%)</span>
                   </div>`;
              }).join('')}
            </div>
          </div>
          <div>
            <div class="xs tm" style="margin-bottom:6px">Link Attribute Breakdown</div>
            <div style="display:flex;flex-direction:column;gap:4px">
              ${[['Dofollow', r=>!r.rel||r.rel==='dofollow','var(--green)'],
                 ['Nofollow', r=>r.rel==='nofollow','var(--text3)'],
                 ['UGC', r=>r.rel==='ugc','var(--text3)'],
                 ['Sponsored', r=>r.rel==='sponsored','var(--yellow)'],
                 ['Unknown', r=>!r.rel&&r.code!==200,'var(--text3)']].map(([label,fn,color])=>{
                   const cnt=results.filter(fn).length;
                   const pct=total>0?Math.round(cnt/total*100):0;
                   return `<div style="display:flex;align-items:center;gap:8px">
                     <span class="xs tm" style="width:80px;color:${color}">${label}</span>
                     <div style="flex:1;background:var(--win-panel2);border-radius:2px;height:12px;overflow:hidden">
                       <div style="width:${pct}%;height:100%;background:${color}"></div>
                     </div>
                     <span class="mono xs tm" style="width:50px">${cnt} (${pct}%)</span>
                   </div>`;
              }).join('')}
            </div>
            <div style="margin-top:12px" class="xs tm">SSL Status</div>
            <div style="display:flex;gap:12px;margin-top:4px;flex-wrap:wrap">
              <div><span class="badge bg">${results.filter(r=>r.ssl==='valid').length}</span> <span class="xs tm">Valid HTTPS</span></div>
              <div><span class="badge br">${results.filter(r=>r.ssl==='invalid'||r.ssl==='expired').length}</span> <span class="xs tm">Invalid/Expired</span></div>
              <div><span class="badge bgray">${results.filter(r=>r.ssl==='http').length}</span> <span class="xs tm">HTTP only</span></div>
              <div><span class="badge bgray">${results.filter(r=>!r.ssl).length}</span> <span class="xs tm">Unknown</span></div>
            </div>
            <div style="margin-top:12px" class="xs tm">Health Score Distribution</div>
            <div style="display:flex;flex-direction:column;gap:4px;margin-top:4px">
              ${[['100% Healthy', r=>r.healthScore===100,'var(--green)'],
                 ['70â€“99', r=>r.healthScore>=70&&r.healthScore<100,'var(--green)'],
                 ['40â€“69', r=>r.healthScore>=40&&r.healthScore<70,'var(--yellow)'],
                 ['1â€“39', r=>r.healthScore>0&&r.healthScore<40,'var(--orange)'],
                 ['0 (Dead)', r=>r.healthScore===0||r.healthScore<0,'var(--red)']].map(([label,fn,color])=>{
                   const cnt=results.filter(fn).length;
                   const pct=total>0?Math.round(cnt/total*100):0;
                   return `<div style="display:flex;align-items:center;gap:8px">
                     <span class="xs tm" style="width:90px;color:${color}">${label}</span>
                     <div style="flex:1;background:var(--win-panel2);border-radius:2px;height:12px;overflow:hidden">
                       <div style="width:${pct}%;height:100%;background:${color}"></div>
                     </div>
                     <span class="mono xs tm" style="width:50px">${cnt} (${pct}%)</span>
                   </div>`;
              }).join('')}
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div style="border-top:1px solid var(--win-border);margin-top:10px;padding-top:8px">
        <div class="flex g6" style="flex-wrap:wrap">
          <button class="tbtn go" onclick="start_link_alive()">â–¶ Check Links</button>
          <button class="tbtn stop" onclick="APP.stopFlag=true">â¹ Stop</button>
          <div class="tb-sep"></div>
          <button class="tbtn" onclick="la_saveLive()">âœ… 200s â†’ URL List</button>
          <button class="tbtn" onclick="la_saveHealthy()">ğŸ’š Healthy â†’ URL List</button>
          <button class="tbtn" onclick="la_recheckDead()">ğŸ”„ Re-check Dead</button>
          <div class="tb-sep"></div>
          <button class="tbtn" onclick="la_export('csv')">ğŸ“Š CSV</button>
          <button class="tbtn" onclick="la_export('json')">{ } JSON</button>
          <button class="tbtn" onclick="la_export('dead')">â˜  Dead URLs</button>
          <button class="tbtn" onclick="la_export('healthy')">ğŸ’š Healthy URLs</button>
          <div class="tb-sep"></div>
          <button class="tbtn" onclick="la_clear()">ğŸ—‘ Clear</button>
        </div>
        <div class="prog-wrap mt6"><div class="prog-fill" id="la-prog" style="width:0%"></div></div>
      </div>
    </div>
  </div>

  <!-- RESULTS TABLE -->
  ${results.length?`
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">Results
      <span class="badge bg" style="margin-left:4px">${total}</span>
      <div class="ph-r" style="gap:6px">
        <input type="text" placeholder="Filter resultsâ€¦" value="${esc(LA_FILTER_TEXT)}" oninput="LA_FILTER_TEXT=this.value;render_link_alive(document.getElementById('page-link_alive'))" style="width:150px;padding:2px 6px;font-size:10px"/>
        <span class="mono xs tm">${ok200} OK Â· ${redir} redirect Â· ${dead+err} dead</span>
      </div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr>
          ${thS('healthScore','Health')}
          <th>URL</th>
          ${thS('code','Code')}
          <th>Redirect Chain</th>
          ${thS('time','Time')}
          <th>SSL</th>
          ${thS('rel','Rel')}
          <th>Anchor</th>
          <th>Flags</th>
          <th>Checked</th>
        </tr></thead>
        <tbody>${display.slice(0,500).map(r=>{
          const hs = r.healthScore??0;
          const hsCls = hs===100?'la-health-100':hs>=70?'la-health-hi':hs>=40?'la-health-mid':'la-health-lo';
          const codeCls = r.code===200?'bg':r.code>=300&&r.code<400?'by':r.code>=400?'br':'bgray';
          const chainHtml = r.chain&&r.chain.length>1
            ? r.chain.map((u,i)=>`<span class="mono" style="font-size:8px">${esc(u.slice(0,30))}${u.length>30?'â€¦':''}</span>${i<r.chain.length-1?'<span class="la-chain-arrow">â†’</span>':''}`).join('')
            : 'â€”';
          const sslHtml = r.ssl==='valid'?'<span class="la-ssl-ok">ğŸ”’</span>':r.ssl==='invalid'||r.ssl==='expired'?'<span class="la-ssl-bad">âš </span>':r.ssl==='http'?'<span class="la-ssl-bad">ğŸ”“</span>':'â€”';
          const relBadge = r.rel?`<span class="badge ${r.rel==='dofollow'?'bg':r.rel==='nofollow'||r.rel==='ugc'?'bgray':'by'}" style="font-size:8px">${esc(r.rel)}</span>`:'â€”';
          const flagsHtml = (r.flags||[]).map(f=>{
            const cls=f==='domain_leak'?'la-flag-leak':f==='noindex'?'la-flag-noindex':f==='nofollow'?'la-flag-nofollow':f==='page_404'?'la-flag-page404':'la-flag-nofollow';
            const label=f==='domain_leak'?'âš¡ leak':f==='noindex'?'ğŸš« noindex':f==='nofollow'?'ğŸ”‡ nofollow':f==='page_404'?'ğŸ’€ page404':f==='slow'?'ğŸ¢ slow':f;
            return `<span class="la-flag ${cls}">${label}</span>`;
          }).join('');
          return `<tr title="${esc(r.url)}">
            <td style="text-align:center"><span class="${hsCls}" style="font-family:var(--mono);font-size:11px">${hs}%</span></td>
            <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.slice(0,45))}${r.url.length>45?'â€¦':''}</a></td>
            <td><span class="badge ${codeCls}">${r.code||'ERR'}</span></td>
            <td style="max-width:200px;overflow:hidden">${chainHtml}</td>
            <td class="mono xs ${r.time>3000?'sv-r':r.time>1500?'sv-y':'sv-g'}">${r.time>0?r.time+'ms':'â€”'}</td>
            <td style="text-align:center">${sslHtml}</td>
            <td>${relBadge}</td>
            <td class="xs tm" style="max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(r.anchor||'')}">${esc(r.anchor||'â€”')}</td>
            <td>${flagsHtml}</td>
            <td class="mono xs tm">${esc(r.checkedAt||r.date||'')}</td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>
      ${display.length>500?`<div class="notice ni-y" style="margin:4px;font-size:10px">Showing 500/${display.length} â€” use filter to narrow</div>`:''}
    </div>
  </div>`:''}`;
}

// â”€â”€ TAB SWITCHER â”€â”€
function laTab(idx){
  for(let i=0;i<4;i++){
    const p=document.getElementById('la-panel-'+i);
    const b=document.getElementById('lat-'+i);
    if(p) p.style.display=i===idx?'':'none';
    if(b) b.classList.toggle('la-active',i===idx);
  }
}

// â”€â”€ SORT â”€â”€
function laSort(col){
  if(LA_SORT.col===col) LA_SORT.dir*=-1; else {LA_SORT.col=col;LA_SORT.dir=-1;}
  render_link_alive(document.getElementById('page-link_alive'));
}

// â”€â”€ HEALTH SCORE CALCULATOR â”€â”€
function la_healthScore(r){
  let score = 100;
  if(r.code===0)           score -= 60;  // error / timeout
  else if(r.code>=400)     score -= 60;  // 4xx / 5xx
  else if(r.code>=300)     score -= 40;  // redirect
  if(r.rel==='nofollow'||r.rel==='ugc'||r.rel==='sponsored') score -= 30;
  if(r.noindex)            score -= 25;
  if(r.domainLeak)         score -= 20;
  if(r.ssl==='invalid'||r.ssl==='expired') score -= 10;
  if(r.time>3000)          score -= 5;
  return Math.max(0, score);
}

// â”€â”€ SSL DETECTOR â”€â”€
function la_detectSSL(url, html, status){
  if(!url) return 'unknown';
  if(!url.startsWith('https')) return 'http';
  // If we got a response at all via allorigins the SSL is likely valid
  // Check for SSL error signals in headers/status
  if(status===0) return 'invalid';
  if(html&&/ssl.*error|certificate.*error|ERR_CERT/i.test(html)) return 'expired';
  return 'valid';
}

// â”€â”€ REDIRECT CHAIN TRACER â”€â”€
function la_extractChain(data, originalUrl){
  const chain = [originalUrl];
  // allorigins returns the final URL after redirects
  if(data.status&&data.status.url&&data.status.url!==originalUrl){
    chain.push(data.status.url);
  }
  return chain;
}

// â”€â”€ DOMAIN LEAK DETECTOR â”€â”€
function la_isDomainLeak(originalUrl, chain, code){
  if(code<300||code>=400) return false;
  if(chain.length<2) return false;
  try {
    const origHost = new URL(originalUrl).hostname.replace(/^www\./,'');
    const finalHost = new URL(chain[chain.length-1]).hostname.replace(/^www\./,'');
    return origHost !== finalHost;
  } catch(e){ return false; }
}

// â”€â”€ NOINDEX DETECTOR â”€â”€
function la_detectNoindex(html){
  if(!html) return false;
  return /<meta[^>]+name=["']robots["'][^>]*content=["'][^"']*noindex/i.test(html)
      || /<meta[^>]+content=["'][^"']*noindex[^"']*["'][^>]*name=["']robots/i.test(html);
}

// â”€â”€ REL + ANCHOR EXTRACTOR â”€â”€
function la_extractRelAndAnchor(html, targetUrl){
  if(!html||!targetUrl) return {rel:'unknown', anchor:null};
  try {
    // Find all <a> tags linking to this URL (or similar)
    const targetPath = new URL(targetUrl).pathname;
    // Match anchors that contain the target domain or path
    const anchorRegex = /<a\s[^>]*href=["']([^"']+)["'][^>]*>([\s\S]*?)<\/a>/gi;
    let m;
    while((m=anchorRegex.exec(html))!==null){
      const href=m[1], inner=m[2].replace(/<[^>]+>/g,'').trim();
      let matches=false;
      try{ matches=href.includes(targetPath)||href===targetUrl||new URL(href).pathname===targetPath; }catch(e){}
      if(matches){
        // Extract rel from full tag
        const tagMatch = m[0].match(/rel=["']([^"']+)["']/i);
        const relRaw = tagMatch?tagMatch[1].toLowerCase():'dofollow';
        const rel = relRaw.includes('nofollow')?'nofollow':relRaw.includes('ugc')?'ugc':relRaw.includes('sponsored')?'sponsored':'dofollow';
        return {rel, anchor:inner.slice(0,80)||null};
      }
    }
    // Fallback: check for nofollow anywhere on page (broad signal)
    if(/<a[^>]+rel=["'][^"']*nofollow/i.test(html)) return {rel:'nofollow', anchor:null};
    return {rel:'dofollow', anchor:null};
  } catch(e){ return {rel:'unknown', anchor:null}; }
}

// â”€â”€ MAIN CHECK â”€â”€
async function start_link_alive(){
  const raw=(document.getElementById('la-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs to check','err');return;}
  const urls=raw.split('\n').map(u=>u.trim()).filter(u=>u.startsWith('http'));
  if(!urls.length){log('No valid URLs found (must start with http)','err');return;}

  const concurrent = parseInt((document.getElementById('la-concurrent')||{value:5}).value)||5;
  const timeoutMs  = (parseInt((document.getElementById('la-timeout')||{value:10}).value)||10)*1000;
  const delayMs    = parseInt((document.getElementById('la-delay')||{value:200}).value)||0;

  const doRedirectChain = (document.getElementById('la-do-redirect-chain')||{checked:true}).checked;
  const doSSL           = (document.getElementById('la-do-ssl')||{checked:true}).checked;
  const doRel           = (document.getElementById('la-do-rel')||{checked:true}).checked;
  const doAnchor        = (document.getElementById('la-do-anchor')||{checked:true}).checked;
  const doNoindex       = (document.getElementById('la-do-noindex')||{checked:true}).checked;
  const doPage404       = (document.getElementById('la-do-page404')||{checked:true}).checked;
  const flagLeak        = (document.getElementById('la-flag-leak')||{checked:true}).checked;
  const flagNoindex     = (document.getElementById('la-flag-noindex')||{checked:true}).checked;
  const flagNofollow    = (document.getElementById('la-flag-nofollow')||{checked:true}).checked;
  const flagSlow        = (document.getElementById('la-flag-slow')||{checked:true}).checked;

  const prog=document.getElementById('la-prog');
  const results=[];
  let processed=0;
  APP.running=true; APP.stopFlag=false; setStatus('Checking links...');
  log(`Link Alive v3: ${urls.length} URLs Â· ${concurrent} concurrent Â· timeout ${timeoutMs/1000}s`,'info');

  async function checkUrl(url){
    const t0=Date.now();
    const entry={url, code:0, time:0, chain:[url], ssl:'unknown', rel:'unknown', anchor:null, noindex:false, domainLeak:false, flags:[], checkedAt:today()};
    try{
      const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(timeoutMs)});
      const data  = await resp.json();
      const html  = data.contents||'';
      entry.time  = Date.now()-t0;
      entry.code  = data.status?.http_code||200;

      // Redirect chain
      if(doRedirectChain){
        entry.chain = la_extractChain(data, url);
        if(entry.chain.length>1) entry.redirect=entry.chain[entry.chain.length-1];
      }

      // SSL
      if(doSSL) entry.ssl = la_detectSSL(url, html, entry.code);

      // Rel + Anchor
      if(doRel||doAnchor){
        const {rel,anchor}=la_extractRelAndAnchor(html, url);
        if(doRel) entry.rel=rel;
        if(doAnchor) entry.anchor=anchor;
      }

      // Noindex
      if(doNoindex) entry.noindex = la_detectNoindex(html);

      // Flags
      if(flagLeak){
        entry.domainLeak = la_isDomainLeak(url, entry.chain, entry.code);
        if(entry.domainLeak) entry.flags.push('domain_leak');
      }
      if(flagNoindex && entry.code===200 && entry.noindex) entry.flags.push('noindex');
      if(flagNofollow && (entry.rel==='nofollow'||entry.rel==='ugc'||entry.rel==='sponsored')) entry.flags.push('nofollow');
      if(flagSlow && entry.time>3000) entry.flags.push('slow');
      if(doPage404 && entry.code===404) entry.flags.push('page_404');

      APP.stats.success++;
    }catch(e){
      entry.code=0; entry.time=Date.now()-t0; entry.ssl='invalid';
      APP.stats.failed++;
      log(`${url.slice(0,45)} â†’ timeout/error`,'err');
    }

    // Health score
    entry.healthScore = la_healthScore(entry);

    processed++;
    if(prog) prog.style.width=Math.round(processed/urls.length*100)+'%';
    setProgress(Math.round(processed/urls.length*100),`${processed}/${urls.length}`);
    const statusLabel=entry.code===200?'OK':entry.code>=300&&entry.code<400?'REDIR':entry.code>=400?'DEAD':'ERR';
    log(`${url.slice(0,45)} â†’ ${entry.code||'ERR'} (${entry.time}ms) Â· health:${entry.healthScore}% Â· ${entry.rel||'?'} Â· ${flagsStr(entry.flags)}`, entry.code===200&&entry.healthScore>=70?'ok':entry.code>=400||entry.code===0?'err':'warn');
    APP.stats.processed++; updateStats();
    return entry;
  }

  function flagsStr(flags){ return flags.length?flags.join(','): 'clean'; }

  // Parallel worker pool
  const queue=[...urls];
  const workers=Array.from({length:Math.min(concurrent,urls.length)},async()=>{
    while(queue.length&&!APP.stopFlag){
      const url=queue.shift();
      if(url){
        const r=await checkUrl(url);
        results.push(r);
        if(delayMs>0) await sleep(delayMs);
      }
    }
  });
  await Promise.all(workers);

  SS.set('rf_alive_results',results);
  APP.running=false; setStatus('Done');
  const h100=results.filter(r=>r.healthScore===100).length;
  const leaks=results.filter(r=>r.domainLeak).length;
  log(`Done â€” ${results.filter(r=>r.code===200).length}/${results.length} live Â· ${h100} 100% healthy Â· ${leaks} domain leaks Â· avg ${results.length?Math.round(results.filter(r=>r.time>0).reduce((a,r)=>a+r.time,0)/Math.max(1,results.filter(r=>r.time>0).length)):0}ms`,'ok');
  render_link_alive(document.getElementById('page-link_alive'));
}

// â”€â”€ LOAD HELPERS â”€â”€
function la_loadList(){
  const ta=document.getElementById('la-urls');
  if(ta) ta.value=APP.urlList.join('\n');
  log(`Loaded ${APP.urlList.length} URLs from URL List`,'info');
}
function la_loadLinkBuilder(){
  const ta=document.getElementById('la-urls');
  if(ta) ta.value=APP.links.map(l=>l.url).join('\n');
  log(`Loaded ${APP.links.length} links from Link Builder`,'info');
}
function la_loadDead(){
  const dead=SS.get('rf_alive_results',[]).filter(r=>r.code===0||r.code>=400);
  const ta=document.getElementById('la-urls');
  if(ta) ta.value=dead.map(r=>r.url).join('\n');
  log(`Loaded ${dead.length} dead/error URLs for re-check`,'info');
}

// â”€â”€ RE-CHECK DEAD â”€â”€
async function la_recheckDead(){
  const dead=SS.get('rf_alive_results',[]).filter(r=>r.code===0||r.code>=400);
  if(!dead.length){log('No dead links to re-check','warn');return;}
  const ta=document.getElementById('la-urls');
  if(ta) ta.value=dead.map(r=>r.url).join('\n');
  log(`Re-checking ${dead.length} dead linksâ€¦`,'info');
  await start_link_alive();
}

// â”€â”€ SAVE HELPERS â”€â”€
function la_saveLive(){
  const r=SS.get('rf_alive_results',[]).filter(x=>x.code===200);
  APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])];
  SS.set('rf_urllist',APP.urlList);
  log(`${r.length} live URLs â†’ URL List`,'ok');
  updateStats();
}
function la_saveHealthy(){
  const r=SS.get('rf_alive_results',[]).filter(x=>x.healthScore===100);
  APP.urlList=[...new Set([...APP.urlList,...r.map(x=>x.url)])];
  SS.set('rf_urllist',APP.urlList);
  log(`${r.length} 100% healthy URLs â†’ URL List`,'ok');
  updateStats();
}

// â”€â”€ EXPORTS â”€â”€
function la_export(type='csv'){
  const results=SS.get('rf_alive_results',[]);
  if(!results.length){log('No results to export','warn');return;}
  if(type==='json'){
    dlTxt(JSON.stringify(results,null,2),'link_alive.json');
  } else if(type==='dead'){
    const dead=results.filter(r=>r.code===0||r.code>=400);
    dlTxt(dead.map(r=>r.url).join('\n'),'dead_links.txt');
    log(`Exported ${dead.length} dead links`,'ok');
  } else if(type==='healthy'){
    const h=results.filter(r=>r.healthScore===100);
    dlTxt(h.map(r=>r.url).join('\n'),'healthy_links.txt');
    log(`Exported ${h.length} healthy links`,'ok');
  } else {
    const hdr='URL,Code,HealthScore,Redirect,Chain,Time_ms,SSL,Rel,Anchor,Noindex,DomainLeak,Flags,CheckedAt\n';
    const rows=results.map(r=>[
      r.url, r.code, r.healthScore,
      r.redirect||'', (r.chain||[]).join('â†’'),
      r.time, r.ssl||'', r.rel||'', r.anchor||'',
      r.noindex?'yes':'no', r.domainLeak?'yes':'no',
      (r.flags||[]).join(';'), r.checkedAt||''
    ].map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
    dlTxt(hdr+rows,'link_alive.csv');
    log(`Exported ${results.length} results as CSV`,'ok');
  }
}

function la_clear(){
  SS.set('rf_alive_results',[]);
  LA_FILTER_TEXT='';
  render_link_alive(document.getElementById('page-link_alive'));
  log('Link Alive results cleared','warn');
}

// â”€â”€ MONITOR SYSTEM â”€â”€
function la_addMonitor(){
  const name=(document.getElementById('la-mon-name')||{value:''}).value.trim()||'Monitor';
  const source=(document.getElementById('la-mon-source')||{value:'current'}).value;
  const intervalEl=document.getElementById('la-mon-interval');
  const interval=parseInt(intervalEl?intervalEl.value:86400000);
  const intervalLabel=intervalEl?intervalEl.options[intervalEl.selectedIndex].text:'Daily';
  const schedules=SS.get('rf_la_schedules',[]);
  schedules.push({name,source,interval,intervalLabel,lastRun:null,nextRun:Date.now()+interval,enabled:true});
  SS.set('rf_la_schedules',schedules);
  log(`Monitor "${name}" added â€” ${intervalLabel}`,'ok');
  la_startMonitorTick();
  render_link_alive(document.getElementById('page-link_alive'));
  laTab(2);
}

function la_removeMonitor(idx){
  const schedules=SS.get('rf_la_schedules',[]);
  schedules.splice(idx,1);
  SS.set('rf_la_schedules',schedules);
  log('Monitor removed','warn');
  render_link_alive(document.getElementById('page-link_alive'));
  laTab(2);
}

async function la_runMonitor(idx){
  const schedules=SS.get('rf_la_schedules',[]);
  const mon=schedules[idx];if(!mon)return;
  log(`Running monitor: "${mon.name}"...`,'info');

  let urls=[];
  if(mon.source==='link_builder') urls=APP.links.map(l=>l.url);
  else if(mon.source==='current') urls=SS.get('rf_alive_results',[]).map(r=>r.url);

  if(!urls.length){log('No URLs in monitor source','warn');return;}

  // Save previous results for diff
  const prevResults=SS.get('rf_alive_results',[]);
  const prevMap={};
  prevResults.forEach(r=>{prevMap[r.url]={code:r.code,rel:r.rel,healthScore:r.healthScore};});

  // Run check
  const ta=document.getElementById('la-urls');
  if(ta) ta.value=urls.join('\n');
  await start_link_alive();

  // Diff and log changes
  const newResults=SS.get('rf_alive_results',[]);
  const monLog=SS.get('rf_la_monitor_log',[]);
  newResults.forEach(r=>{
    const prev=prevMap[r.url];
    if(!prev) return;
    const changes=[];
    if(prev.code===200&&r.code>=400) changes.push('200â†’DEAD');
    else if(prev.code>=400&&r.code===200) changes.push('DEADâ†’LIVE');
    if(prev.rel!==r.rel&&prev.rel&&r.rel) changes.push(`rel:${prev.rel}â†’${r.rel}`);
    if(prev.healthScore!==r.healthScore) changes.push(`health:${prev.healthScore}%â†’${r.healthScore}%`);
    if(changes.length){
      monLog.push({time:new Date().toLocaleString(),monitor:mon.name,url:r.url,change:changes.join(' | ')});
    }
  });
  SS.set('rf_la_monitor_log',monLog.slice(-500));

  // Update schedule
  schedules[idx].lastRun=new Date().toLocaleString();
  schedules[idx].nextRun=Date.now()+schedules[idx].interval;
  SS.set('rf_la_schedules',schedules);
  log(`Monitor "${mon.name}" complete â€” ${newResults.length} URLs checked`,'ok');
  render_link_alive(document.getElementById('page-link_alive'));
  laTab(2);
}

function la_startMonitorTick(){
  if(LA_MONITOR_TIMER) clearInterval(LA_MONITOR_TIMER);
  LA_MONITOR_TIMER=setInterval(async()=>{
    const schedules=SS.get('rf_la_schedules',[]);
    const now=Date.now();
    for(let i=0;i<schedules.length;i++){
      if(schedules[i].enabled&&schedules[i].nextRun<=now){
        log(`Auto-running monitor: "${schedules[i].name}"`,'info');
        await la_runMonitor(i);
      }
    }
  },60000); // check every minute
}

// Start monitor tick on load if any schedules exist
(function la_initMonitors(){
  if(SS.get('rf_la_schedules',[]).length) la_startMonitorTick();
})();



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMPAIGN MANAGER  v2.0 â€” Full Feature Upgrade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Campaign templates library (saved configs)
if(!window.CAMP_TEMPLATES) window.CAMP_TEMPLATES = JSON.parse(localStorage.getItem('rf_camp_templates')||'[]');

// â”€â”€ Tab state â”€â”€
let campTab = 'list'; // 'list' | 'create' | 'templates' | 'abtest'

function render_campaign(el){
  const cams = APP.campaigns;
  const templates = window.CAMP_TEMPLATES;
  const abTests = JSON.parse(localStorage.getItem('rf_ab_tests')||'[]');
  const proxyFailRate = _proxyFailRate();

  el.innerHTML=`
  <!-- CAMPAIGN TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:2px solid var(--win-border);padding-bottom:0">
    ${[['list','ğŸš€ Campaigns'],['create','â• New Campaign'],['templates','ğŸ“ Templates'],['abtest','ğŸ”€ A/B Tests'],['perf','ğŸ“Š Performance']].map(([t,l])=>`
    <div onclick="campTab='${t}';render_campaign(document.getElementById('page-campaign'))" style="padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;margin-bottom:-2px;border:1px solid ${campTab===t?'var(--win-border)':'transparent'};border-bottom-color:${campTab===t?'var(--win-panel)':'transparent'};background:${campTab===t?'var(--win-panel)':'transparent'};color:${campTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;padding-bottom:4px">
      ${proxyFailRate>0.3?`<span class="badge br">âš  Proxy fail ${Math.round(proxyFailRate*100)}%</span>`:''}
      <span class="badge bg">${cams.filter(c=>c.status==='running').length} running</span>
      <span class="badge by">${cams.filter(c=>c.status==='paused').length} paused</span>
    </div>
  </div>

  ${campTab==='create'?_campCreatePanel():campTab==='templates'?_campTemplatesPanel(templates):campTab==='abtest'?_campABPanel(abTests):campTab==='perf'?_campPerfPanel(cams):_campListPanel(cams)}
  `;
}

function _campCreatePanel(prefill){
  const p = prefill||{};
  return `<div class="panel">
    <div class="panel-head">â• New Campaign</div>
    <div class="panel-body">
      <div class="g3">
        <div class="fg"><label class="lbl">Campaign Name</label><input type="text" id="c-name" value="${esc(p.name||'')}" placeholder="VPN Review Campaign"/></div>
        <div class="fg"><label class="lbl">Money URL(s) <span style="color:var(--text3);font-weight:400">(one per line, rotated)</span></label>
          <textarea id="c-url" rows="2" placeholder="https://yoursite.com/page1&#10;https://yoursite.com/page2">${esc(p.url||'')}</textarea></div>
        <div class="fg"><label class="lbl">Target Keywords <span style="color:var(--text3);font-weight:400">(one per line, staggered by group)</span></label>
          <textarea id="c-kw" rows="2" placeholder="best VPN 2025&#10;cheap VPN services">${esc(p.kw||'')}</textarea></div>
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">Platform</label>
          <select id="c-plat">
            <option ${p.platform==='GitHub Pages (DA96)'?'selected':''}>GitHub Pages (DA96)</option>
            <option ${p.platform==='Medium (DA95)'?'selected':''}>Medium (DA95)</option>
            <option ${p.platform==='Reddit (DA98)'?'selected':''}>Reddit (DA98)</option>
            <option ${p.platform==='LinkedIn (DA99)'?'selected':''}>LinkedIn (DA99)</option>
            <option ${p.platform==='Multi-Platform'?'selected':''}>Multi-Platform</option>
          </select></div>
        <div class="fg"><label class="lbl">Tier</label>
          <select id="c-tier">
            <option value="1" ${p.tier=='1'?'selected':''}>Tier 1 (Money site)</option>
            <option value="2" ${p.tier=='2'?'selected':''}>Tier 2 (Links to T1)</option>
            <option value="3" ${p.tier=='3'?'selected':''}>Tier 3 (Social/Bookmarks)</option>
          </select></div>
        <div class="fg"><label class="lbl">Velocity (max posts/day)</label>
          <select id="c-vel">
            <option value="slow" ${p.velocity==='slow'?'selected':''}>Slow (1â€“3/day)</option>
            <option value="medium" ${!p.velocity||p.velocity==='medium'?'selected':''}>Medium (5â€“10/day)</option>
            <option value="fast" ${p.velocity==='fast'?'selected':''}>Fast (15â€“25/day)</option>
          </select></div>
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">Comment Voice / Template Set</label>
          <select id="c-voice">
            <option value="auto">Auto (match tier)</option>
            <option value="casual">Casual (T1 style)</option>
            <option value="formal">Formal (T2 style)</option>
            <option value="social">Social / short (T3 style)</option>
          </select></div>
        <div class="fg"><label class="lbl">Scheduled Start <span style="color:var(--text3);font-weight:400">(blank = manual)</span></label>
          <input type="datetime-local" id="c-sched" value="${p.schedAt||''}"/></div>
        <div class="fg"><label class="lbl">Multi-Tier Auto-Queue T2?</label>
          <select id="c-t2auto">
            <option value="no">No â€” run T1 only</option>
            <option value="yes">Yes â€” queue T2 after T1 done</option>
          </select></div>
      </div>
      <div class="fg"><label class="lbl">Proxy Failure Threshold (auto-pause if exceeded) %</label>
        <input type="number" id="c-proxythresh" value="${p.proxyThresh||40}" min="5" max="100" style="width:120px"/></div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="camp_create()">ğŸš€ Create Campaign</button>
        <button class="tbtn" onclick="camp_saveTemplate()">ğŸ“ Save as Template</button>
        <button class="tbtn" onclick="campTab='list';render_campaign(document.getElementById('page-campaign'))">âœ• Cancel</button>
      </div>
    </div>
  </div>`;
}

function _campListPanel(cams){
  if(!cams.length) return `<div class="notice ni-b" style="margin-top:10px">No campaigns yet. Click <b>â• New Campaign</b> to create one.</div>`;
  return `<div class="panel"><div class="panel-head">Campaigns <span class="badge bg">${cams.length}</span>
    <div class="ph-r">
      <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="camp_export()">ğŸ“¥ CSV</button>
      <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="camp_exportLog()">ğŸ“‹ Full Log</button>
    </div>
  </div>
  <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
    <thead><tr><th>Name</th><th>Money URL(s)</th><th>Keyword</th><th>Platform</th><th>Tier</th><th>Velocity</th><th>Schedule</th><th>Status</th><th>Progress</th><th>Posts/Day</th><th>Actions</th></tr></thead>
    <tbody>${cams.map((c,i)=>{
      const runLog = c.runLog||[];
      const today_str = today();
      const todayPosts = runLog.filter(r=>r.date===today_str&&r.type==='post').length;
      return `<tr>
        <td style="font-weight:700">${esc(c.name)}${c.schedAt?`<br><span class="mono" style="font-size:9px;color:var(--purple)">â° ${new Date(c.schedAt).toLocaleString()}</span>`:''}</td>
        <td class="mono xs">${(c.urls||[c.url]).slice(0,2).map(u=>`<a href="${esc(u)}" target="_blank">${esc((u||'').slice(0,22))}â€¦</a>`).join('<br>')}${(c.urls||[c.url]).length>2?`<span style="color:var(--text3)"> +${(c.urls||[c.url]).length-2} more</span>`:''}</td>
        <td class="xs">${(c.kws||[c.kw]).slice(0,2).map(k=>esc(k)).join('<br>')}${(c.kws||[c.kw]).length>2?`<span style="color:var(--text3)"> +${(c.kws||[c.kw]).length-2}</span>`:''}</td>
        <td class="xs">${esc(c.platform)}</td>
        <td><span class="badge ${c.tier=='1'?'bg':c.tier=='2'?'bb':'bp'}">T${c.tier}</span></td>
        <td><span class="badge bgray">${esc(c.velocity)}</span></td>
        <td class="mono xs tm">${c.schedAt?new Date(c.schedAt).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit'}):'Manual'}</td>
        <td><span class="badge ${c.status==='running'?'bg':c.status==='paused'?'by':c.status==='done'?'bb':c.status==='scheduled'?'bp':'bgray'}">${c.status||'active'}</span>${c.t2queued?`<br><span class="badge bb" style="margin-top:2px">T2 queued</span>`:''}</td>
        <td class="mono xs tm">${c.progress||'â€”'}</td>
        <td class="mono xs ${todayPosts>0?'tm':''}"><span style="color:${todayPosts>0?'var(--green)':'var(--text3)'}">${todayPosts}</span></td>
        <td style="white-space:nowrap">
          <button class="tbtn go" style="padding:1px 5px;font-size:9px" onclick="camp_run(${i})" title="Run">â–¶</button>
          <button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="camp_toggle(${i})" title="Pause/Resume">${c.status==='paused'?'â–¶':'â¸'}</button>
          <button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="camp_clone(${i})" title="Clone">â˜</button>
          <button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="camp_viewLog(${i})" title="Log">ğŸ“‹</button>
          <button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="camp_email(${i})" title="Email summary">ğŸ“§</button>
          <button class="tbtn stop" style="padding:1px 5px;font-size:9px" onclick="camp_del(${i})" title="Delete">âœ•</button>
        </td>
      </tr>`;
    }).join('')}</tbody>
  </table></div></div></div>`;
}

function _campTemplatesPanel(templates){
  return `<div class="panel">
    <div class="panel-head">ğŸ“ Campaign Templates <span class="badge bg">${templates.length}</span></div>
    <div class="panel-body">
      ${templates.length?`<div class="tbl-wrap"><table>
        <thead><tr><th>Template Name</th><th>Platform</th><th>Tier</th><th>Velocity</th><th>Voice</th><th>Actions</th></tr></thead>
        <tbody>${templates.map((t,i)=>`<tr>
          <td style="font-weight:700">${esc(t.name)}</td>
          <td class="xs">${esc(t.platform)}</td>
          <td><span class="badge ${t.tier=='1'?'bg':t.tier=='2'?'bb':'bp'}">T${t.tier}</span></td>
          <td><span class="badge bgray">${esc(t.velocity)}</span></td>
          <td class="xs">${esc(t.voice||'auto')}</td>
          <td>
            <button class="tbtn go" style="padding:1px 5px;font-size:9px" onclick="camp_loadTemplate(${i})">Use</button>
            <button class="tbtn stop" style="padding:1px 5px;font-size:9px" onclick="camp_delTemplate(${i})">âœ•</button>
          </td>
        </tr>`).join('')}</tbody>
      </table></div>`:`<div class="notice ni-b">No templates saved. Create a campaign and click "Save as Template".</div>`}
    </div>
  </div>`;
}

function _campABPanel(tests){
  return `<div class="panel">
    <div class="panel-head">ğŸ”€ A/B Variant Campaigns <span class="badge bg">${tests.length}</span></div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:10px">A/B tests run two variant campaigns simultaneously â€” test two money URLs or anchor sets. Winner is flagged by highest post rate after completion.</div>
      <div class="g2" style="margin-bottom:10px">
        <div class="fg"><label class="lbl">Test Name</label><input type="text" id="ab-name" placeholder="VPN Page A vs B"/></div>
        <div class="fg"><label class="lbl">Metric to Compare</label>
          <select id="ab-metric"><option value="posts">Total posts</option><option value="indexed">Indexed count</option></select></div>
      </div>
      <div class="g2">
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--green);font-weight:700;margin-bottom:6px;text-transform:uppercase">Variant A</div>
          <div class="fg"><label class="lbl">Money URL A</label><input type="url" id="ab-url-a" placeholder="https://yoursite.com/page-a"/></div>
          <div class="fg"><label class="lbl">Anchor / Keyword A</label><input type="text" id="ab-kw-a" placeholder="best VPN 2025"/></div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--blue);font-weight:700;margin-bottom:6px;text-transform:uppercase">Variant B</div>
          <div class="fg"><label class="lbl">Money URL B</label><input type="url" id="ab-url-b" placeholder="https://yoursite.com/page-b"/></div>
          <div class="fg"><label class="lbl">Anchor / Keyword B</label><input type="text" id="ab-kw-b" placeholder="best vpn for streaming"/></div>
        </div>
      </div>
      <button class="tbtn go" onclick="camp_createAB()">ğŸ”€ Launch A/B Test</button>
      ${tests.length?`<div class="tbl-wrap" style="margin-top:12px"><table>
        <thead><tr><th>Test</th><th>Variant A</th><th>B</th><th>A Posts</th><th>B Posts</th><th>Winner</th><th>Status</th></tr></thead>
        <tbody>${tests.map((t,i)=>`<tr>
          <td style="font-weight:700">${esc(t.name)}</td>
          <td class="mono xs">${esc((t.urlA||'').slice(0,24))}</td>
          <td class="mono xs">${esc((t.urlB||'').slice(0,24))}</td>
          <td class="mono">${t.postsA||0}</td>
          <td class="mono">${t.postsB||0}</td>
          <td>${t.winner?`<span class="badge ${t.winner==='A'?'bg':'bb'}">${t.winner}</span>`:'<span class="badge bgray">â€”</span>'}</td>
          <td><span class="badge ${t.status==='running'?'bg':t.status==='done'?'bb':'bgray'}">${t.status||'queued'}</span></td>
        </tr>`).join('')}</tbody>
      </table></div>`:''}
    </div>
  </div>`;
}

function _campPerfPanel(cams){
  const totalPosts = cams.reduce((s,c)=>{const l=c.runLog||[];return s+l.filter(r=>r.type==='post'&&r.status==='posted').length;},0);
  const totalFailed = cams.reduce((s,c)=>{const l=c.runLog||[];return s+l.filter(r=>r.type==='post'&&r.status==='failed').length;},0);
  return `<div class="panel">
    <div class="panel-head">ğŸ“Š Campaign Performance Dashboard</div>
    <div class="panel-body">
      <div class="g4" style="margin-bottom:14px">
        <div class="stat"><div class="stat-v sv-g">${totalPosts}</div><div class="stat-l">Total Links Built</div></div>
        <div class="stat"><div class="stat-v sv-r">${totalFailed}</div><div class="stat-l">Failed Posts</div></div>
        <div class="stat"><div class="stat-v sv-b">${cams.length}</div><div class="stat-l">Campaigns</div></div>
        <div class="stat"><div class="stat-v sv-y">${cams.filter(c=>c.t2queued||c.tier=='2').length}</div><div class="stat-l">T2 Queued</div></div>
      </div>
      ${cams.length?`<div class="tbl-wrap"><table>
        <thead><tr><th>Campaign</th><th>Tier</th><th>Links Built</th><th>Failed</th><th>Success %</th><th>Last Run</th><th>Run History</th></tr></thead>
        <tbody>${cams.map((c,i)=>{
          const log = c.runLog||[];
          const posted = log.filter(r=>r.type==='post'&&r.status==='posted').length;
          const failed2 = log.filter(r=>r.type==='post'&&r.status==='failed').length;
          const total2 = posted+failed2;
          const pct = total2>0?Math.round((posted/total2)*100):0;
          const runs = c.runHistory||[];
          return `<tr>
            <td style="font-weight:700">${esc(c.name)}</td>
            <td><span class="badge ${c.tier=='1'?'bg':c.tier=='2'?'bb':'bp'}">T${c.tier}</span></td>
            <td class="mono" style="color:var(--green)">${posted}</td>
            <td class="mono" style="color:var(--red)">${failed2}</td>
            <td><div style="display:flex;align-items:center;gap:6px"><div class="prog-wrap" style="width:60px;margin:0"><div class="prog-fill" style="width:${pct}%"></div></div><span class="mono xs">${pct}%</span></div></td>
            <td class="mono xs tm">${c.lastRun||'â€”'}</td>
            <td class="mono xs tm">${runs.length} run${runs.length!==1?'s':''}</td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>`:`<div class="notice ni-b">Run some campaigns to see performance data.</div>`}
    </div>
  </div>`;
}

function _proxyFailRate(){
  const p = APP.proxies;
  if(!p||!p.length) return 0;
  const dead = p.filter(x=>x.status==='dead').length;
  return dead/p.length;
}

function camp_create(){
  const name=(document.getElementById('c-name')||{value:''}).value.trim();
  if(!name){log('Enter campaign name','err');return;}
  const urlRaw=(document.getElementById('c-url')||{value:''}).value.trim();
  const kwRaw=(document.getElementById('c-kw')||{value:''}).value.trim();
  const urls=urlRaw.split('\n').map(s=>s.trim()).filter(Boolean);
  const kws=kwRaw.split('\n').map(s=>s.trim()).filter(Boolean);
  const schedVal=(document.getElementById('c-sched')||{value:''}).value;
  const t2auto=(document.getElementById('c-t2auto')||{value:'no'}).value;
  const voice=(document.getElementById('c-voice')||{value:'auto'}).value;
  const proxyThresh=parseInt((document.getElementById('c-proxythresh')||{value:40}).value)||40;
  const camp={
    name,
    url:urls[0]||'',
    urls,
    kw:kws[0]||'',
    kws,
    platform:(document.getElementById('c-plat')||{value:''}).value,
    tier:(document.getElementById('c-tier')||{value:'1'}).value,
    velocity:(document.getElementById('c-vel')||{value:'medium'}).value,
    voice,
    schedAt:schedVal||null,
    t2auto,
    proxyThresh,
    created:today(),
    status:schedVal?'scheduled':'active',
    progress:'0/0',
    runLog:[],
    runHistory:[],
    t2queued:false
  };
  APP.campaigns.push(camp);
  SS.set('rf_campaigns',APP.campaigns);
  log(`Campaign "${name}" created${schedVal?' (scheduled for '+new Date(schedVal).toLocaleString()+')':''}`, 'ok');
  if(schedVal) _scheduleCheck();
  campTab='list';
  render_campaign(document.getElementById('page-campaign'));
}

function camp_saveTemplate(){
  const name=(document.getElementById('c-name')||{value:''}).value.trim()||'Unnamed Template';
  const t={
    name:'Template: '+name,
    platform:(document.getElementById('c-plat')||{value:''}).value,
    tier:(document.getElementById('c-tier')||{value:'1'}).value,
    velocity:(document.getElementById('c-vel')||{value:'medium'}).value,
    voice:(document.getElementById('c-voice')||{value:'auto'}).value,
    proxyThresh:parseInt((document.getElementById('c-proxythresh')||{value:40}).value)||40,
  };
  window.CAMP_TEMPLATES.push(t);
  localStorage.setItem('rf_camp_templates',JSON.stringify(window.CAMP_TEMPLATES));
  log(`Template "${t.name}" saved`,'ok');
}

function camp_loadTemplate(i){
  const t=window.CAMP_TEMPLATES[i];
  campTab='create';
  render_campaign(document.getElementById('page-campaign'));
  // Pre-fill after render
  setTimeout(()=>{
    const el=(id)=>document.getElementById(id);
    if(el('c-plat'))el('c-plat').value=t.platform||'';
    if(el('c-tier'))el('c-tier').value=t.tier||'1';
    if(el('c-vel'))el('c-vel').value=t.velocity||'medium';
    if(el('c-voice'))el('c-voice').value=t.voice||'auto';
    if(el('c-proxythresh'))el('c-proxythresh').value=t.proxyThresh||40;
  },50);
  log(`Template "${t.name}" loaded into form`,'ok');
}

function camp_delTemplate(i){
  window.CAMP_TEMPLATES.splice(i,1);
  localStorage.setItem('rf_camp_templates',JSON.stringify(window.CAMP_TEMPLATES));
  render_campaign(document.getElementById('page-campaign'));
}

function camp_clone(i){
  const c=APP.campaigns[i];
  const clone=JSON.parse(JSON.stringify(c));
  clone.name=c.name+' (Copy)';
  clone.status='active';
  clone.progress='0/0';
  clone.runLog=[];
  clone.runHistory=[];
  clone.t2queued=false;
  clone.lastRun=null;
  clone.schedAt=null;
  APP.campaigns.push(clone);
  SS.set('rf_campaigns',APP.campaigns);
  log(`Cloned "${c.name}" â†’ "${clone.name}"`,'ok');
  render_campaign(document.getElementById('page-campaign'));
}

function camp_del(i){APP.campaigns.splice(i,1);SS.set('rf_campaigns',APP.campaigns);render_campaign(document.getElementById('page-campaign'));}

function camp_toggle(i){
  const c=APP.campaigns[i];
  c.status=c.status==='paused'?'active':'paused';
  SS.set('rf_campaigns',APP.campaigns);
  log(`Campaign "${c.name}" â†’ ${c.status}`,'info');
  render_campaign(document.getElementById('page-campaign'));
}

function camp_edit(i){
  const c=APP.campaigns[i];
  const newName=prompt('Campaign name:',c.name);if(newName===null)return;c.name=newName.trim()||c.name;
  const newUrl=prompt('Money URL(s) (one per line):',c.urls?c.urls.join('\n'):c.url);
  if(newUrl!==null){c.urls=newUrl.split('\n').map(s=>s.trim()).filter(Boolean);c.url=c.urls[0]||c.url;}
  const newKw=prompt('Target keyword(s) (one per line):',c.kws?c.kws.join('\n'):c.kw);
  if(newKw!==null){c.kws=newKw.split('\n').map(s=>s.trim()).filter(Boolean);c.kw=c.kws[0]||c.kw;}
  SS.set('rf_campaigns',APP.campaigns);
  log(`Campaign "${c.name}" updated`,'ok');
  render_campaign(document.getElementById('page-campaign'));
}

function camp_viewLog(i){
  const c=APP.campaigns[i];
  const log2=c.runLog||[];
  if(!log2.length){alert('No run log yet for "'+c.name+'".');return;}
  const txt=log2.map(e=>`[${e.date||''}] ${e.type} | ${e.status} | ${e.target||e.msg||''}`).join('\n');
  dlTxt(txt,c.name.replace(/[^a-z0-9]/gi,'_')+'_log.txt');
  log(`Log exported for "${c.name}"`,'ok');
}

function camp_email(i){
  const c=APP.campaigns[i];
  const runLog=c.runLog||[];
  const posted=runLog.filter(r=>r.type==='post'&&r.status==='posted').length;
  const failed2=runLog.filter(r=>r.type==='post'&&r.status==='failed').length;
  const subj=encodeURIComponent(`RankForge: Campaign "${c.name}" Complete`);
  const body=encodeURIComponent(
    `Campaign Report: ${c.name}\n`+
    `Status: ${c.status}\n`+
    `Money URL(s): ${(c.urls||[c.url]).join(', ')}\n`+
    `Keywords: ${(c.kws||[c.kw]).join(', ')}\n`+
    `Tier: ${c.tier} | Velocity: ${c.velocity}\n`+
    `Last Run: ${c.lastRun||'â€”'}\n\n`+
    `Links Posted: ${posted}\n`+
    `Failed: ${failed2}\n`+
    `Success Rate: ${posted+failed2>0?Math.round((posted/(posted+failed2))*100):0}%\n\n`+
    `-- Sent by RankForge Pro`
  );
  window.open(`mailto:?subject=${subj}&body=${body}`);
  log(`Email summary opened for "${c.name}"`,'info');
}

function camp_export(){
  dlCSV('Name,URL,Keywords,Platform,Tier,Velocity,Status,Created,LastRun\n'+
    APP.campaigns.map(c=>`"${c.name}","${(c.urls||[c.url]).join('|')}","${(c.kws||[c.kw]).join('|')}","${c.platform}",${c.tier},${c.velocity},${c.status},${c.created||''},${c.lastRun||''}`).join('\n'),
    'campaigns.csv');
  log('Campaigns exported','ok');
}

function camp_exportLog(){
  const lines=['Campaign,Date,Type,Status,Target'];
  APP.campaigns.forEach(c=>{
    (c.runLog||[]).forEach(e=>{
      lines.push(`"${c.name}","${e.date||''}","${e.type||''}","${e.status||''}","${(e.target||e.msg||'').replace(/"/g,"'")}"`);
    });
  });
  dlCSV(lines.join('\n'),'campaign_full_log.csv');
  log('Full run log exported','ok');
}

function camp_createAB(){
  const name=(document.getElementById('ab-name')||{value:'A/B Test'}).value.trim();
  const urlA=(document.getElementById('ab-url-a')||{value:''}).value.trim();
  const urlB=(document.getElementById('ab-url-b')||{value:''}).value.trim();
  const kwA=(document.getElementById('ab-kw-a')||{value:''}).value.trim();
  const kwB=(document.getElementById('ab-kw-b')||{value:''}).value.trim();
  if(!urlA||!urlB){log('Enter both variant URLs','err');return;}
  const tests=JSON.parse(localStorage.getItem('rf_ab_tests')||'[]');
  // Create two real campaigns
  const campA={name:`${name} â€” A`,url:urlA,urls:[urlA],kw:kwA,kws:[kwA],platform:'Multi-Platform',tier:'1',velocity:'medium',voice:'auto',proxyThresh:40,created:today(),status:'active',progress:'0/0',runLog:[],runHistory:[],t2queued:false};
  const campB={name:`${name} â€” B`,url:urlB,urls:[urlB],kw:kwB,kws:[kwB],platform:'Multi-Platform',tier:'1',velocity:'medium',voice:'auto',proxyThresh:40,created:today(),status:'active',progress:'0/0',runLog:[],runHistory:[],t2queued:false};
  APP.campaigns.push(campA,campB);
  SS.set('rf_campaigns',APP.campaigns);
  tests.push({name,urlA,urlB,kwA,kwB,status:'running',postsA:0,postsB:0,winner:null,created:today()});
  localStorage.setItem('rf_ab_tests',JSON.stringify(tests));
  log(`A/B Test "${name}" launched â€” running both variants`,'ok');
  render_campaign(document.getElementById('page-campaign'));
}

// â”€â”€ Scheduler: poll every 30s for scheduled campaigns â”€â”€
function _scheduleCheck(){
  const now2=Date.now();
  let changed=false;
  APP.campaigns.forEach((c,i)=>{
    if(c.status==='scheduled'&&c.schedAt){
      if(new Date(c.schedAt).getTime()<=now2){
        log(`â° Scheduled campaign "${c.name}" starting now`,'ok');
        c.status='active';
        changed=true;
        camp_run(i);
      }
    }
  });
  if(changed){SS.set('rf_campaigns',APP.campaigns);render_campaign(document.getElementById('page-campaign'));}
}
if(!window._campSchedInterval) window._campSchedInterval=setInterval(_scheduleCheck,30000);

// â”€â”€ Daily velocity enforcer: track posts per campaign per day â”€â”€
function _campVelocityAllowed(c){
  const velMap={slow:3,medium:10,fast:25};
  const max=velMap[c.velocity]||10;
  const today_str=today();
  const todayPosts=(c.runLog||[]).filter(r=>r.date===today_str&&r.type==='post'&&r.status==='posted').length;
  return todayPosts<max;
}

// â”€â”€ Get comment templates by voice/tier â”€â”€
function _campGetTemplates(voice,tier){
  const all=SS.get('rf_ctpls',CTPLS);
  // T1 casual, T2 formal, T3 short â€” for now differentiate by keyword density
  if(voice==='casual'||voice==='auto'&&tier==='1') return all.filter((_,i)=>i%3===0).concat(all.slice(0,3));
  if(voice==='formal'||voice==='auto'&&tier==='2') return all.filter((_,i)=>i%3===1).concat(all.slice(3,6));
  if(voice==='social'||voice==='auto'&&tier==='3') return all.filter((_,i)=>i%3===2).concat(all.slice(-3));
  return all;
}

async function camp_run(i){
  const c=APP.campaigns[i];
  if(c.status==='running'){log(`Campaign "${c.name}" is already running`,'warn');return;}
  if(c.status==='paused'){log(`Campaign "${c.name}" is paused â€” unpause first`,'warn');return;}

  // Proxy failure threshold check
  const failRate=_proxyFailRate();
  const thresh=(c.proxyThresh||40)/100;
  if(failRate>thresh){
    c.status='paused';
    SS.set('rf_campaigns',APP.campaigns);
    log(`âš  Campaign "${c.name}" auto-paused â€” proxy fail rate ${Math.round(failRate*100)}% exceeds threshold ${c.proxyThresh||40}%`,'warn');
    render_campaign(document.getElementById('page-campaign'));
    return;
  }

  // Velocity enforcer
  if(!_campVelocityAllowed(c)){
    log(`Campaign "${c.name}" velocity limit reached for today â€” will resume tomorrow`,'warn');
    return;
  }

  log(`â–¶ Campaign "${c.name}" starting â€” T${c.tier}, ${c.velocity} velocity`,'ok');
  const runStart=today();
  if(!c.runHistory) c.runHistory=[];
  if(!c.runLog) c.runLog=[];
  c.runHistory.push({startDate:runStart,status:'running'});
  c.status='running';c.progress='Step 1/3: Scraping';
  SS.set('rf_campaigns',APP.campaigns);
  render_campaign(document.getElementById('page-campaign'));

  // â”€â”€ Stagger by keyword group â€” one keyword group per run â”€â”€
  const allKws=c.kws&&c.kws.length?c.kws:[c.kw];
  const runIdx=(c.runHistory.length-1)%allKws.length;
  const activeKw=allKws[runIdx];
  log(`[${c.name}] Using keyword group ${runIdx+1}/${allKws.length}: "${activeKw}"`,'info');

  // â”€â”€ Rotate money URL â”€â”€
  const allUrls=c.urls&&c.urls.length?c.urls:[c.url];
  const activeUrl=allUrls[runIdx%allUrls.length];
  log(`[${c.name}] Rotating money URL: ${activeUrl}`,'info');

  // Step 1: SERP scrape
  log(`[${c.name}] Step 1: SERP scraping for target URLs...`,'info');
  c.runLog.push({date:runStart,type:'step',status:'ok',msg:'SERP scraping started'});
  const kws=[activeKw+' site:wordpress.com',activeKw+' "leave a comment"',activeKw+' inurl:blog'];
  const serpResults=[];
  for(const kw of kws){
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://html.duckduckgo.com/html/?q='+encodeURIComponent(kw))}`,{signal:AbortSignal.timeout(10000)});
      const data=await resp.json();const html=data.contents||'';
      const matches=html.match(/uddg=([^&"]+)/g)||[];
      const urls=[...new Set(matches.map(m=>decodeURIComponent(m.replace('uddg=',''))))].filter(u=>u.startsWith('http')&&!u.includes('duckduckgo')).slice(0,10);
      serpResults.push(...urls);
      log(`[${c.name}] Found ${urls.length} targets for: ${kw}`,'ok');
    }catch(e){log(`[${c.name}] SERP failed: ${e.message}`,'warn');}
    await sleep(1500);
  }
  const targets=[...new Set(serpResults)].slice(0,20);
  APP.urlList=[...new Set([...APP.urlList,...targets])];
  SS.set('rf_urllist',APP.urlList);
  c.progress=`Step 2/3: Commenting (${targets.length} targets)`;
  SS.set('rf_campaigns',APP.campaigns);

  // Step 2: Comment with velocity enforcement & voice-matched templates
  log(`[${c.name}] Step 2: Posting comments (voice: ${c.voice||'auto'}, tier: T${c.tier})...`,'info');
  const templates=_campGetTemplates(c.voice||'auto',c.tier);
  let posted=0,failed=0;
  const velMap={slow:rand(1,3),medium:rand(5,10),fast:rand(15,25)};
  let limit=Math.min(velMap[c.velocity]||5, targets.length);
  // Check remaining daily budget
  const today_str=today();
  const todayPostedAlready=(c.runLog||[]).filter(r=>r.date===today_str&&r.type==='post'&&r.status==='posted').length;
  const velMax={slow:3,medium:10,fast:25}[c.velocity]||10;
  const remaining=Math.max(0,velMax-todayPostedAlready);
  limit=Math.min(limit,remaining);
  if(limit===0){log(`[${c.name}] Daily velocity cap reached (${velMax}/day)`,'warn');}

  for(let j=0;j<limit;j++){
    if(APP.stopFlag)break;
    // Re-check proxy failure threshold mid-run
    if(_proxyFailRate()>(c.proxyThresh||40)/100){
      log(`[${c.name}] Proxy failure rate exceeded threshold â€” auto-pausing`,'warn');
      c.status='paused';
      c.runLog.push({date:today_str,type:'system',status:'warn',msg:'Auto-paused: proxy fail rate exceeded'});
      break;
    }
    const target=targets[j];
    const tpl=templates[rand(0,templates.length-1)];
    const comment=tpl.replace(/{url}/g,activeUrl).replace(/{kw}/g,activeKw).replace(/{anchor}/g,activeKw);
    const name=CNAMES[rand(0,CNAMES.length-1)];
    const proxy=getNextProxy();
    if(proxy)log(`[${c.name}] Proxy: ${proxyLabel(proxy)}`,'info');
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(target)}`,{signal:AbortSignal.timeout(6000)});
      const data=await resp.json();const html=data.contents||'';
      const hasForm=html.includes('comment')||html.includes('respond');
      const status=hasForm?'posted':'failed';
      APP.comments.push({target,comment,name,status,date:today_str,campaign:c.name});
      c.runLog.push({date:today_str,type:'post',status,target,kw:activeKw,url:activeUrl});
      if(hasForm)posted++;else failed++;
      log(`[${c.name}] ${target.slice(0,40)} â†’ ${hasForm?'posted':'no form'}`,hasForm?'ok':'warn');
    }catch(e){
      APP.comments.push({target,comment,name,status:'failed',date:today_str,campaign:c.name});
      c.runLog.push({date:today_str,type:'post',status:'failed',target,msg:e.message});
      failed++;
      log(`[${c.name}] ${target.slice(0,40)} â†’ error`,'err');
    }
    SS.set('rf_comments',APP.comments);updateStats();
    await sleep(rand(800,2000));
  }

  c.progress=`Step 3/3: Indexing ${posted} links`;
  SS.set('rf_campaigns',APP.campaigns);

  // Step 3: Ping
  log(`[${c.name}] Step 3: Submitting pings...`,'info');
  try{
    await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.google.com/ping?sitemap='+encodeURIComponent(activeUrl))}`,{signal:AbortSignal.timeout(5000)});
    log(`[${c.name}] Google ping sent for ${activeUrl}`,'ok');
    c.runLog.push({date:today_str,type:'ping',status:'ok',msg:`Pinged ${activeUrl}`});
  }catch(e){c.runLog.push({date:today_str,type:'ping',status:'err',msg:e.message});}

  // Finalize
  if(c.status!=='paused'){
    c.status='done';
    c.progress=`Done: ${posted} posted, ${failed} failed`;
  }
  c.lastRun=today_str;
  if(c.runHistory.length) c.runHistory[c.runHistory.length-1]={startDate:runStart,endDate:today_str,posted,failed,status:c.status};
  SS.set('rf_campaigns',APP.campaigns);
  log(`âœ“ Campaign "${c.name}" complete â€” ${posted} posted, ${failed} failed`,'ok');

  // â”€â”€ Auto-queue T2 if enabled â”€â”€
  if(c.t2auto==='yes'&&!c.t2queued&&c.status==='done'){
    const t2={
      name:`${c.name} â€” T2`,
      url:(c.urls||[c.url]).map(u=>u).join('\n'),
      urls:(c.urls||[c.url]),
      kw:(c.kws||[c.kw]).join('\n'),
      kws:(c.kws||[c.kw]),
      platform:'Multi-Platform',
      tier:'2',
      velocity:'slow',
      voice:'formal',
      proxyThresh:c.proxyThresh||40,
      created:today_str,
      status:'active',
      progress:'0/0',
      runLog:[],
      runHistory:[],
      t2queued:false,
      t2auto:'no'
    };
    APP.campaigns.push(t2);
    c.t2queued=true;
    SS.set('rf_campaigns',APP.campaigns);
    log(`[${c.name}] T2 campaign "${t2.name}" queued automatically`,'ok');
  }

  render_campaign(document.getElementById('page-campaign'));
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLOG COMMENTER â€” v4.1
// Real POST Â· WordPress XML-RPC Â· Approval Tracking
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CNAMES=['Alex Reid','Sarah Chen','Mike Torres','Emma Walsh','David Kim','Lisa Park','James Okafor','Rachel Green','Tom Silva','Nina Patel','John Burke','Maria Costa','Kevin Marsh','Diana Fowler','Chris Anand','Sophie Laurent','Ben Osei','Priya Nair','Luke Hartley','Mia Johansson'];

const CTPLS=[
  'Great article! I\'ve been researching {kw} lately and found {url} really useful.',
  'Really helpful post. Worth also checking out {url} if you want more on {kw}.',
  'Thanks for the breakdown. {url} covers some similar ground on {kw} with more data.',
  'Solid content. As someone who\'s tested many options for {kw}, {url} was the clearest guide I found.',
  'Bookmarked. Have you compared this with what\'s at {url}? Relevant to {kw} research.',
  'Appreciate the detail here. For anyone wanting a deeper dive on {kw}: {url}',
  'Well written. I\'d also recommend {url} to anyone serious about {kw}.',
  'Good overview! I spent a while on {kw} and {url} ended up being my go-to reference.',
  'This is exactly what I needed. I\'ve been comparing resources on {kw} and {url} stood out.',
  'Thorough write-up. Anyone serious about {kw} should also read {url} â€” covers the practical side well.',
  'Nice one. The point about {kw} reminded me of something I read at {url} â€” different angle, same conclusion.',
  'Really appreciate posts like this. Shared it with my team. We\'ve been using {url} alongside our {kw} research.',
];

// â”€â”€ CMS FINGERPRINT DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bc_detectCMS(html, url) {
  if(!html) return {cms:'unknown',confidence:'low',signals:[]};
  const signals=[];let cms='unknown';
  const wpSigs=[
    [/wp-content\//i,'wp-content path'],[/wp-includes\//i,'wp-includes path'],
    [/wp-comments-post\.php/i,'wp-comments-post.php'],[/comment_post_ID/i,'comment_post_ID field'],
    [/powered by <a[^>]+>WordPress/i,'Powered by WordPress'],[/class="comments-area"/i,'comments-area class'],
    [/id="respond"/i,'respond div'],[/generator.*wordpress/i,'WordPress generator meta'],
  ];
  const wpHits=wpSigs.filter(([rx])=>rx.test(html));
  if(wpHits.length>=2){cms='wordpress';wpHits.forEach(([,s])=>signals.push(s));}
  const blSigs=[/blogger\.com\/comment/i,/blogspot\.com/i,/data-blogger-escaped/i];
  if(cms==='unknown'&&blSigs.some(rx=>rx.test(html))){cms='blogger';signals.push('Blogger system');}
  if(cms==='unknown'&&/ghost\.io|content="Ghost/i.test(html)){cms='ghost';signals.push('Ghost CMS');}
  if(/disqus\.com\/embed|disqus_shortname/i.test(html)){signals.push('Disqus embed');if(cms==='unknown')cms='disqus';}
  if(cms==='unknown'&&(/<form[^>]*comment/i.test(html)||/id="comment"/i.test(html))){cms='generic';signals.push('Generic comment form');}
  return {cms,confidence:signals.length>=3?'high':signals.length>=1?'medium':'low',signals};
}

// â”€â”€ FORM FIELD EXTRACTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bc_extractForm(html, pageUrl) {
  const result={action:null,postId:null,nonce:null,fields:{},method:'POST'};
  try{
    const actionMatch=html.match(/action="([^"]*wp-comments-post\.php[^"]*)"/i)
      ||html.match(/<form[^>]+id="commentform"[^>]*action="([^"]+)"/i)
      ||html.match(/<form[^>]+class="[^"]*comment[^"]*"[^>]*action="([^"]+)"/i);
    if(actionMatch){result.action=actionMatch[1].startsWith('http')?actionMatch[1]:new URL(actionMatch[1],pageUrl).href;}
    else{try{result.action=new URL('/wp-comments-post.php',pageUrl).href;}catch(e){}}
    const pidMatch=html.match(/name="comment_post_ID"\s+value="(\d+)"/i)||html.match(/comment_post_ID[^>]*value="(\d+)"/i);
    if(pidMatch)result.postId=pidMatch[1];
    const nonceMatch=html.match(/name="_wpnonce"\s+value="([^"]+)"/i)||html.match(/"nonce":"([^"]+)"/);
    if(nonceMatch)result.nonce=nonceMatch[1];
    const hiddenFields=[...html.matchAll(/input[^>]+type="hidden"[^>]*name="([^"]+)"[^>]*value="([^"]*)"/gi)];
    hiddenFields.forEach(m=>{result.fields[m[1]]=m[2];});
    const redirectMatch=html.match(/name="redirect_to"\s+value="([^"]+)"/i);
    if(redirectMatch)result.fields['redirect_to']=redirectMatch[1];
  }catch(e){}
  return result;
}

// â”€â”€ WORDPRESS XML-RPC POSTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bc_xmlrpcPost(siteUrl, postId, commentData) {
  const {authorName,authorEmail,authorUrl,content}=commentData;
  const xmlBody=`<?xml version="1.0"?><methodCall><methodName>wp.newComment</methodName><params><param><value><string>${siteUrl}</string></value></param><param><value><int>0</int></value></param><param><value><string></string></value></param><param><value><int>${postId||1}</int></value></param><param><value><struct><member><name>author</name><value><string>${authorName}</string></value></member><member><name>author_email</name><value><string>${authorEmail}</string></value></member><member><name>author_url</name><value><string>${authorUrl}</string></value></member><member><name>content</name><value><string>${content.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</string></value></member></struct></value></param></params></methodCall>`;
  try{
    const xmlrpcUrl=new URL('/xmlrpc.php',siteUrl).href;
    const resp=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(xmlrpcUrl)}`,{method:'POST',headers:{'Content-Type':'text/xml'},body:xmlBody,signal:AbortSignal.timeout(10000)});
    const responseText=await resp.text();
    if(responseText.includes('<fault>')){
      const faultMsg=responseText.match(/<string>([^<]+)<\/string>/)?.[1]||'XML-RPC fault';
      const faultCode=responseText.match(/<int>(\d+)<\/int>/)?.[1]||'?';
      if(faultCode==='403')return{ok:false,method:'xmlrpc',reason:'xmlrpc_disabled'};
      if(faultCode==='801')return{ok:false,method:'xmlrpc',reason:'duplicate_comment'};
      return{ok:false,method:'xmlrpc',reason:faultMsg};
    }
    const commentIdMatch=responseText.match(/<int>(\d+)<\/int>/);
    if(commentIdMatch)return{ok:true,method:'xmlrpc',commentId:commentIdMatch[1],reason:'submitted'};
    return{ok:false,method:'xmlrpc',reason:'unexpected_response'};
  }catch(e){return{ok:false,method:'xmlrpc',reason:e.message};}
}

// â”€â”€ FORM POST VIA CORS PROXY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bc_formPost(formData, actionUrl, captchaToken) {
  try{
    const params=new URLSearchParams();
    Object.entries(formData.fields||{}).forEach(([k,v])=>params.append(k,v));
    if(formData.postId)params.append('comment_post_ID',formData.postId);
    if(formData.nonce)params.append('_wpnonce',formData.nonce);
    params.append('author',formData.author||'');
    params.append('email',formData.email||'');
    params.append('url',formData.website||'');
    params.append('comment',formData.comment||'');
    params.append('submit','Post Comment');
    params.append('comment_parent','0');
    if(captchaToken)params.append('g-recaptcha-response',captchaToken);
    const proxyUrl=`https://api.allorigins.win/raw?url=${encodeURIComponent(actionUrl)}`;
    const resp=await fetch(proxyUrl,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:params.toString(),signal:AbortSignal.timeout(12000)});
    const respText=await resp.text();
    if(/duplicate|already said/i.test(respText))return{ok:false,method:'form_post',reason:'duplicate_comment'};
    if(/spam/i.test(respText))return{ok:false,method:'form_post',reason:'marked_spam'};
    if(/awaiting.*moderation|held.*moderation/i.test(respText))return{ok:true,method:'form_post',reason:'pending_moderation'};
    if(/class="comment|comment-\d+|Your comment was/i.test(respText))return{ok:true,method:'form_post',reason:'live'};
    if(resp.status===302||resp.status===200)return{ok:true,method:'form_post',reason:'submitted'};
    return{ok:false,method:'form_post',reason:`http_${resp.status}`};
  }catch(e){return{ok:false,method:'form_post',reason:e.message};}
}

// â”€â”€ APPROVAL CHECKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bc_checkApproval(comment) {
  if(!comment.target||!comment.submittedText)return'unknown';
  try{
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(comment.target)}`,{signal:AbortSignal.timeout(8000)});
    const data=await resp.json();const html=data.contents||'';
    const snippet=comment.submittedText.replace(/[{}<>]/g,'').trim().split(/\s+/).slice(3,9).join(' ');
    if(snippet.length>10&&html.toLowerCase().includes(snippet.toLowerCase()))return'approved';
    if(comment.name&&html.includes(comment.name)&&(html.includes('comment-author')||html.includes('comment-body')))return'approved';
    return'pending';
  }catch(e){return'check_failed';}
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bc_humanDelay(baseMs){const v=baseMs*0.35;return baseMs+(Math.random()*v*2-v)+rand(0,400);}
function bc_spin(text){return text.replace(/\{([^{}]+)\}/g,(_,opts)=>{const c=opts.split('|');return c[rand(0,c.length-1)];});}
function bc_genEmail(name,pattern){
  const parts=name.toLowerCase().split(/\s+/);const first=parts[0]||'user';const last=parts[1]||'smith';
  const domains=['gmail.com','yahoo.com','outlook.com','hotmail.com','protonmail.com'];
  const d=domains[rand(0,domains.length-1)];
  if(pattern==='firstname.lastname')return`${first}.${last}@${d}`;
  if(pattern==='firstlast')return`${first}${last}@${d}`;
  return`${first}${last}${rand(10,99)}@${d}`;
}
function bc_loadList(){const ta=document.getElementById('bc-targets');if(ta)ta.value=APP.urlList.join('\n');}
function bc_clearLog(){if(!confirm('Clear all comment history?'))return;APP.comments=[];SS.set('rf_comments',[]);render_commenter(document.getElementById('page-commenter'));log('Comment history cleared','warn');}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render_commenter(el){
  const templates=SS.get('rf_ctpls',CTPLS);
  const posted=APP.comments.filter(c=>['posted','pending_moderation','live'].includes(c.status)).length;
  const failed=APP.comments.filter(c=>c.status==='failed').length;
  const pending=APP.comments.filter(c=>c.approvalStatus==='pending').length;
  const approved=APP.comments.filter(c=>c.approvalStatus==='approved').length;
  const activeTab=SS.raw('rf_commenter_tab')||'config';
  el.innerHTML=`
  <div style="display:flex;gap:0;border-bottom:2px solid var(--win-border);margin-bottom:10px">
    ${[['config','âš™ Config'],['monitor','ğŸ“¡ Monitor'],['templates','âœ Templates'],['xmlrpc','ğŸ”§ XML-RPC']].map(([id,label])=>`
    <div onclick="SS.rawSet('rf_commenter_tab','${id}');render_commenter(document.getElementById('page-commenter'))"
      style="padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;border-bottom:2px solid ${activeTab===id?'var(--green)':'transparent'};margin-bottom:-2px;color:${activeTab===id?'var(--green)':'var(--text3)'};background:${activeTab===id?'rgba(57,211,83,0.05)':'transparent'}">${label}</div>`).join('')}
  </div>

  <div style="display:${activeTab==='config'?'block':'none'}">
    <div class="g2">
      <div>
        <div class="panel">
          <div class="panel-head">ğŸ’¬ Commenter Config
            <div class="ph-r"><span class="badge bg">${posted} submitted</span><span class="badge by">${pending} pending</span><span class="badge bg" style="background:rgba(57,211,83,0.15)">${approved} live</span></div>
          </div>
          <div class="panel-body">
            <div class="g2">
              <div class="fg"><label class="lbl">Money URL</label><input type="url" id="bc-url" placeholder="https://yoursite.com"/></div>
              <div class="fg"><label class="lbl">Website / Backlink Field</label><input type="url" id="bc-website" placeholder="https://yoursite.com"/></div>
            </div>
            <div class="fg"><label class="lbl">Anchor / Keyword</label><input type="text" id="bc-kw" placeholder="best VPN 2025"/></div>
            <div class="fg"><label class="lbl">Target URLs</label>
              <textarea id="bc-targets" rows="5" placeholder="Paste blog post URLs here...">${APP.urlList.slice(0,200).join('\n')}</textarea></div>
            <button class="tbtn" style="margin-bottom:8px" onclick="bc_loadList()">ğŸ“‹ Load URL List (${APP.urlList.length})</button>
            <div class="g3">
              <div class="fg"><label class="lbl">Post Method</label>
                <select id="bc-method">
                  <option value="auto">Auto (XML-RPC â†’ Form fallback)</option>
                  <option value="form">Form POST only</option>
                  <option value="xmlrpc">XML-RPC only</option>
                  <option value="detect">Detect Only (dry run)</option>
                </select></div>
              <div class="fg"><label class="lbl">Comment Style</label>
                <select id="bc-style"><option value="natural">Natural</option><option value="expert">Expert</option><option value="question">Question</option><option value="compliment">Compliment</option><option value="mixed">Mixed</option></select></div>
              <div class="fg"><label class="lbl">Commenter Name</label><input type="text" id="bc-name" placeholder="Random if blank"/></div>
            </div>
            <div class="g3">
              <div class="fg"><label class="lbl">Delay (ms)</label><input type="number" id="bc-delay" value="2000" min="500"/></div>
              <div class="fg"><label class="lbl">Human Timing Variance</label>
                <select id="bc-variance"><option value="yes">Yes (Â±35% + jitter)</option><option value="no">No (fixed)</option></select></div>
              <div class="fg"><label class="lbl">Use Proxies</label>
                <select id="bc-proxy"><option value="yes">Yes (${APP.proxies.filter(p=>p.status==='live').length} live)</option><option value="no">No</option></select></div>
            </div>
            <div class="g2">
              <div class="fg"><label class="lbl">Email Pattern</label>
                <select id="bc-email">
                  <option value="firstlast99">firstlast99@domain.com</option>
                  <option value="firstname.lastname">firstname.lastname@domain.com</option>
                  <option value="firstlast">firstlast@domain.com</option>
                </select></div>
              <div class="fg"><label class="lbl">Spin {a|b|c} syntax</label>
                <select id="bc-spin"><option value="yes">Yes</option><option value="no">No</option></select></div>
            </div>
            <div class="notice ni-b">Auto mode: detects CMS â†’ tries XML-RPC first on WordPress â†’ falls back to form POST â†’ logs reason for each result.</div>
            <div class="flex g6 mt8">
              <button class="tbtn go" onclick="start_commenter()">â–¶ Start</button>
              <button class="tbtn stop" onclick="APP.stopFlag=true;setStatus('Stopping...')">â–  Stop</button>
              <button class="tbtn" onclick="bc_preview()">ğŸ‘ Preview</button>
              <button class="tbtn" onclick="bc_export()">ğŸ“¥ Export</button>
              <button class="tbtn" onclick="bc_clearLog()">ğŸ—‘ Clear Log</button>
            </div>
            <div class="prog-wrap"><div class="prog-fill" id="bc-prog"></div></div>
          </div>
        </div>
        <div id="bc-preview-panel" style="display:none" class="panel">
          <div class="panel-head">ğŸ‘ Previews</div>
          <div class="panel-body" id="bc-preview-body"></div>
        </div>
      </div>
      <div>
        <div class="panel">
          <div class="panel-head">ğŸ“Š Stats</div>
          <div class="panel-body">
            <div class="g2" style="margin-bottom:8px">
              <div class="stat"><div class="stat-v sv-g">${posted}</div><div class="stat-l">Submitted</div></div>
              <div class="stat"><div class="stat-v sv-r">${failed}</div><div class="stat-l">Failed</div></div>
              <div class="stat"><div class="stat-v sv-y">${pending}</div><div class="stat-l">Pending Mod</div></div>
              <div class="stat"><div class="stat-v sv-b">${approved}</div><div class="stat-l">Confirmed Live</div></div>
            </div>
            <div class="mono xs tm" style="margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em">By Method</div>
            ${['xmlrpc','form_post','detect','failed'].map(m=>{const n=APP.comments.filter(c=>c.method===m).length;return n?`<div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;padding:2px 0;border-bottom:1px solid var(--win-border)"><span style="color:var(--text2)">${m.replace('_',' ')}</span><span class="badge bgray">${n}</span></div>`:'';}).join('')}
            <div class="mono xs tm" style="margin:8px 0 4px;text-transform:uppercase;letter-spacing:.04em">By CMS</div>
            ${['wordpress','blogger','ghost','disqus','generic','unknown'].map(cms=>{const n=APP.comments.filter(c=>c.cms===cms).length;return n?`<div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:10px;padding:2px 0;border-bottom:1px solid var(--win-border)"><span style="color:var(--text2)">${cms}</span><span class="badge ${cms==='wordpress'?'bg':'bgray'}">${n}</span></div>`:'';}).join('')}
          </div>
        </div>
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">Recent Activity
            <div class="ph-r"><button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="bc_clearLog()">Clear</button></div>
          </div>
          <div style="padding:0;max-height:260px;overflow-y:auto">
            ${APP.comments.length?APP.comments.slice(-25).reverse().map(c=>`
              <div style="padding:5px 8px;border-bottom:1px solid #1a1a1a;display:flex;align-items:flex-start;gap:8px">
                <span class="badge ${['posted','live','pending_moderation'].includes(c.status)?'bg':c.status==='failed'?'br':'by'}" style="flex-shrink:0;margin-top:1px;font-size:8px">${c.status}</span>
                <div style="flex:1;min-width:0">
                  <div class="mono xs" style="color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.target.replace(/https?:\/\//,'').slice(0,42))}</div>
                  <div style="font-size:9px;color:var(--text3);margin-top:1px">${esc(c.name)} Â· ${c.cms||'?'} Â· ${c.method||'?'} Â· ${c.reason||''}${c.approvalStatus==='approved'?' Â· <span style="color:var(--green)">âœ“ LIVE</span>':''}</div>
                </div>
              </div>`).join('')
            :'<div style="padding:12px;font-family:var(--mono);font-size:10px;color:var(--text3)">No comments yet.</div>'}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div style="display:${activeTab==='monitor'?'block':'none'}">
    <div class="panel">
      <div class="panel-head">ğŸ“¡ Approval Monitor
        <div class="ph-r">
          <button class="tbtn go" style="padding:2px 9px;font-size:10px" onclick="bc_checkAllApprovals()">ğŸ”„ Re-Check All Pending</button>
          <button class="tbtn" style="padding:2px 9px;font-size:10px" onclick="bc_export()">ğŸ“¥ Export</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:8px">Re-Check fetches each target page and scans for your comment text. Run periodically â€” moderated comments can take hours or days to appear.</div>
        <div class="g4" style="margin-bottom:8px">
          <div class="stat"><div class="stat-v sv-g">${approved}</div><div class="stat-l">âœ“ Approved</div></div>
          <div class="stat"><div class="stat-v sv-y">${APP.comments.filter(c=>c.approvalStatus==='pending'||c.status==='pending_moderation').length}</div><div class="stat-l">â³ Pending</div></div>
          <div class="stat"><div class="stat-v sv-r">${APP.comments.filter(c=>c.approvalStatus==='rejected'||c.status==='failed').length}</div><div class="stat-l">âœ— Rejected</div></div>
          <div class="stat"><div class="stat-v sv-b">${APP.comments.filter(c=>!c.approvalStatus||c.approvalStatus==='unknown').length}</div><div class="stat-l">? Unchecked</div></div>
        </div>
      </div>
    </div>
    ${APP.comments.length?`<div class="panel"><div class="panel-head">All Comments <span class="badge bg">${APP.comments.length}</span></div>
      <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
        <thead><tr><th>#</th><th>Target</th><th>Name</th><th>CMS</th><th>Method</th><th>Status</th><th>Approval</th><th>Reason</th><th>Date</th><th></th></tr></thead>
        <tbody>${APP.comments.slice().reverse().map((c,i)=>`<tr>
          <td class="mono xs tm">${APP.comments.length-i}</td>
          <td class="mono xs" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><a href="${esc(c.target)}" target="_blank">${esc(c.target.replace(/https?:\/\//,'').slice(0,38))}</a></td>
          <td class="xs">${esc(c.name)}</td>
          <td><span class="badge ${c.cms==='wordpress'?'bg':'bgray'}">${c.cms||'?'}</span></td>
          <td><span class="badge ${c.method==='xmlrpc'?'bb':c.method==='form_post'?'bp':'bgray'}">${c.method||'?'}</span></td>
          <td><span class="badge ${['posted','live'].includes(c.status)?'bg':c.status==='pending_moderation'?'by':'br'}">${c.status||'?'}</span></td>
          <td><span class="badge ${c.approvalStatus==='approved'?'bg':c.approvalStatus==='pending'?'by':c.approvalStatus==='rejected'?'br':'bgray'}">${c.approvalStatus||'â€”'}</span></td>
          <td class="xs tm">${esc(c.reason||'')}</td>
          <td class="mono xs tm">${esc(c.date)}</td>
          <td><button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="bc_recheckOne(${APP.comments.length-1-i})">ğŸ”„</button></td>
        </tr>`).join('')}</tbody>
      </table></div></div></div>`:'<div class="panel"><div class="panel-body mono xs tm">No comments yet.</div></div>'}
  </div>

  <div style="display:${activeTab==='templates'?'block':'none'}">
    <div class="g2">
      <div class="panel">
        <div class="panel-head">âœ Templates <span class="badge bg">${templates.length}</span>
          <div class="ph-r"><button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="bc_resetTpls()">Reset</button></div>
        </div>
        <div class="panel-body">
          <div class="notice ni-b" style="margin-bottom:6px">Placeholders: <code style="color:var(--green)">{url}</code> <code style="color:var(--green)">{kw}</code> <code style="color:var(--green)">{anchor}</code> â€” Spin: <code style="color:var(--yellow)">{Good|Great|Nice}</code></div>
          <textarea id="bc-tpl" rows="3" placeholder="{Great|Excellent|Nice} article! Found {url} useful for {kw}."></textarea>
          <button class="tbtn go mt6" onclick="bc_addTpl()">â• Add Template</button>
          <div style="margin-top:10px">${templates.map((t,i)=>`
            <div style="display:flex;gap:5px;align-items:flex-start;padding:7px;border:1px solid var(--win-border);border-radius:2px;margin-bottom:4px;background:var(--win-panel2)">
              <div style="flex:1;font-family:var(--mono);font-size:10px;color:var(--text2);line-height:1.5">${esc(t)}</div>
              <button class="tbtn" style="padding:1px 4px;font-size:9px" onclick="bc_delTpl(${i})">âœ•</button>
            </div>`).join('')}</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">ğŸ¯ Style Reference</div>
        <div class="panel-body" style="font-size:11px;line-height:1.8;color:var(--text2)">
          <div style="margin-bottom:8px"><strong style="color:var(--green)">Natural</strong> â€” First-person, conversational. Sounds like a genuine reader.</div>
          <div style="margin-bottom:8px"><strong style="color:var(--blue)">Expert</strong> â€” Mentions testing/comparing. References outcomes. Positions as experienced.</div>
          <div style="margin-bottom:8px"><strong style="color:var(--yellow)">Question</strong> â€” Ends with question to author. More engagement, less spam-like.</div>
          <div style="margin-bottom:8px"><strong style="color:var(--purple)">Compliment</strong> â€” Opens with specific praise referencing article topic.</div>
          <div><strong style="color:var(--text3)">Spin:</strong> <code>{word1|word2|word3}</code> â€” one chosen randomly per post. Nested: <code>{{Very|Really} good|Excellent}</code></div>
        </div>
      </div>
    </div>
  </div>

  <div style="display:${activeTab==='xmlrpc'?'block':'none'}">
    <div class="g2">
      <div class="panel">
        <div class="panel-head">ğŸ”§ XML-RPC Direct Poster</div>
        <div class="panel-body">
          <div class="notice ni-y" style="margin-bottom:8px">Posts directly to <code>/xmlrpc.php</code> â€” bypasses comment form entirely. Works on most WordPress installs unless explicitly disabled. Anonymous comments must be enabled in WP Discussion settings.</div>
          <div class="fg"><label class="lbl">Target WordPress Post URL</label><input type="url" id="xrpc-target" placeholder="https://example.com/2024/01/some-post/"/></div>
          <div class="fg"><label class="lbl">Post ID (0 = auto-detect from page HTML)</label><input type="number" id="xrpc-postid" value="0" min="0"/></div>
          <div class="g2">
            <div class="fg"><label class="lbl">Author Name</label><input type="text" id="xrpc-name" placeholder="Alex Reid"/></div>
            <div class="fg"><label class="lbl">Author Email</label><input type="email" id="xrpc-email" placeholder="alex.reid99@gmail.com"/></div>
          </div>
          <div class="fg"><label class="lbl">Author URL (your backlink)</label><input type="url" id="xrpc-authorurl" placeholder="https://yoursite.com"/></div>
          <div class="fg"><label class="lbl">Comment Text</label><textarea id="xrpc-comment" rows="4" placeholder="Write your comment here..."></textarea></div>
          <div class="flex g6 mt8">
            <button class="tbtn go" onclick="bc_xmlrpcTest()">â–¶ Post via XML-RPC</button>
            <button class="tbtn" onclick="bc_xmlrpcProbe()">ğŸ”¬ Probe XML-RPC Status</button>
          </div>
          <div id="xrpc-result" style="display:none;margin-top:8px" class="notice ni-b"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head">ğŸ”¬ XML-RPC Probe</div>
        <div class="panel-body">
          <div class="fg"><label class="lbl">Domain to Probe</label><input type="url" id="xrpc-probe-url" placeholder="https://example.com"/></div>
          <button class="tbtn go mt6" onclick="bc_xmlrpcProbeUrl()">Probe</button>
          <div id="xrpc-probe-result" style="margin-top:8px;font-family:var(--mono);font-size:10px;color:var(--text2);line-height:1.8"></div>
          <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--win-border);font-size:10px;color:var(--text2);line-height:1.7">
            <strong style="color:var(--text3)">How it works:</strong><br>
            1. Fetch post page â†’ extract <code>comment_post_ID</code><br>
            2. Build <code>wp.newComment</code> XML payload<br>
            3. POST to <code>/xmlrpc.php</code> via CORS proxy<br>
            4. Success = integer comment ID returned<br>
            Fault 403 = xmlrpc disabled &nbsp;Â·&nbsp; Fault 500 = no anon comments<br>
            Fault 801 = duplicate &nbsp;Â·&nbsp; Auto falls back to form POST on failure
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function bc_preview(){
  const url=(document.getElementById('bc-url')||{value:''}).value.trim()||'https://yoursite.com';
  const kw=(document.getElementById('bc-kw')||{value:''}).value.trim()||'best VPN';
  const nameField=(document.getElementById('bc-name')||{value:''}).value.trim();
  const spinOn=(document.getElementById('bc-spin')||{value:'yes'}).value==='yes';
  const templates=SS.get('rf_ctpls',CTPLS);
  const previews=[];
  for(let i=0;i<3;i++){
    let tpl=templates[rand(0,templates.length-1)];
    if(spinOn)tpl=bc_spin(tpl);
    const comment=tpl.replace(/{url}/g,url).replace(/{kw}/g,kw).replace(/{anchor}/g,kw);
    const name=nameField||CNAMES[rand(0,CNAMES.length-1)];
    const email=bc_genEmail(name,'firstlast99');
    previews.push({comment,name,email});
  }
  const panel=document.getElementById('bc-preview-panel');
  const body=document.getElementById('bc-preview-body');
  if(body)body.innerHTML=previews.map((p,i)=>`
    <div style="margin-bottom:10px;padding:8px;background:var(--win-panel2);border-radius:2px;border:1px solid var(--win-border)">
      <div class="mono xs tm" style="margin-bottom:4px">Variant ${i+1} â€” <strong style="color:var(--green)">${esc(p.name)}</strong> <span style="color:var(--text3);margin-left:8px">${esc(p.email)}</span></div>
      <div style="font-size:11px;color:var(--text2);line-height:1.6">${esc(p.comment)}</div>
    </div>`).join('');
  if(panel)panel.style.display='block';
}

// â”€â”€ MAIN ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start_commenter(){
  const targetsRaw=(document.getElementById('bc-targets')||{value:''}).value.trim();
  const moneyUrl=(document.getElementById('bc-url')||{value:''}).value.trim();
  if(!targetsRaw||!moneyUrl){log('Enter target URLs and money URL','err');return;}
  const targets=targetsRaw.split('\n').map(t=>t.trim()).filter(Boolean);
  const kw=(document.getElementById('bc-kw')||{value:'keyword'}).value.trim()||'keyword';
  const websiteField=(document.getElementById('bc-website')||{value:''}).value.trim()||moneyUrl;
  const nameField=(document.getElementById('bc-name')||{value:''}).value.trim();
  const method=(document.getElementById('bc-method')||{value:'auto'}).value;
  const baseDelay=parseInt((document.getElementById('bc-delay')||{value:2000}).value)||2000;
  const useVariance=(document.getElementById('bc-variance')||{value:'yes'}).value==='yes';
  const useProxy=(document.getElementById('bc-proxy')||{value:'no'}).value==='yes';
  const emailPat=(document.getElementById('bc-email')||{value:'firstlast99'}).value;
  const spinOn=(document.getElementById('bc-spin')||{value:'yes'}).value==='yes';
  const captchaKey=SS.raw('rf_captcha_key');
  const templates=SS.get('rf_ctpls',CTPLS);
  const prog=document.getElementById('bc-prog');
  const isDryRun=method==='detect';
  APP.running=true;APP.stopFlag=false;
  setStatus(isDryRun?'Detecting (dry run)...':'Commenting...');
  log(`â–¶ Commenter â€” ${targets.length} targets Â· ${method}${useProxy?' Â· proxies':''} ${captchaKey?' Â· captcha':''}${isDryRun?' Â· DRY RUN':''}`,'info');

  for(let i=0;i<targets.length;i++){
    if(APP.stopFlag)break;
    const target=targets[i];
    if(prog)prog.style.width=Math.round(((i+1)/targets.length)*100)+'%';
    setProgress(Math.round(((i+1)/targets.length)*100),`${i+1}/${targets.length}`);

    let tpl=templates[rand(0,templates.length-1)];
    if(spinOn)tpl=bc_spin(tpl);
    const comment=tpl.replace(/{url}/g,moneyUrl).replace(/{kw}/g,kw).replace(/{anchor}/g,kw);
    const name=nameField||CNAMES[rand(0,CNAMES.length-1)];
    const email=bc_genEmail(name,emailPat);
    const proxy=useProxy?getNextProxy():null;
    if(proxy)log(`[Proxy] ${proxyLabel(proxy)} â†’ ${target.slice(0,35)}`,'info');

    // Step 1: Fetch and detect
    let html='',cmsInfo={cms:'unknown',confidence:'low',signals:[]};
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(target)}`,{signal:AbortSignal.timeout(8000)});
      const data=await resp.json();html=data.contents||'';
      cmsInfo=bc_detectCMS(html,target);
      log(`[Detect] ${target.slice(0,35)} â†’ ${cmsInfo.cms} (${cmsInfo.confidence})`,cmsInfo.cms!=='unknown'?'ok':'warn');
    }catch(e){
      log(`[Detect] ${target.slice(0,35)} â†’ fetch failed: ${e.message}`,'err');
      APP.comments.push({target,comment,name,email,website:websiteField,status:'failed',cms:'unknown',method:'failed',reason:'fetch_error',date:today(),submittedText:comment,approvalStatus:'unknown'});
      APP.stats.failed++;APP.stats.processed++;updateStats();
      await sleep(useVariance?bc_humanDelay(baseDelay):baseDelay);
      continue;
    }

    const formInfo=bc_extractForm(html,target);

    if(isDryRun){
      log(`[DryRun] postId:${formInfo.postId||'?'} nonce:${formInfo.nonce?'âœ“':'âœ—'} action:${formInfo.action?formInfo.action.slice(0,40):'?'}`,'info');
      APP.comments.push({target,comment,name,email,website:websiteField,status:'detected_only',cms:cmsInfo.cms,method:'detect',reason:'dry_run',date:today(),submittedText:comment,approvalStatus:'unknown'});
      APP.stats.processed++;updateStats();await sleep(500);continue;
    }

    // Step 2: Captcha
    let captchaToken=null;
    const capMatch=html.match(/data-sitekey="([^"]+)"/);
    if(capMatch&&captchaKey){
      log(`[Captcha] Detected on ${target.slice(0,30)} â€” solving...`,'warn');
      captchaToken=await solveCaptcha(capMatch[1],target);
      if(captchaToken)log('[Captcha] Token âœ“','ok');
    }

    // Step 3: Post
    let result={ok:false,method:'none',reason:'no_attempt'};
    const tryXmlrpc=method==='xmlrpc'||(method==='auto'&&cmsInfo.cms==='wordpress');
    const tryForm=method==='form'||method==='auto';

    if(tryXmlrpc&&cmsInfo.cms==='wordpress'){
      log(`[XML-RPC] â†’ ${target.slice(0,35)}`,'info');
      result=await bc_xmlrpcPost(new URL(target).origin,formInfo.postId||'0',{authorName:name,authorEmail:email,authorUrl:websiteField,content:comment});
      log(`[XML-RPC] ${result.ok?'âœ“':'âœ—'} ${result.reason}`,result.ok?'ok':'warn');
    }
    if(!result.ok&&tryForm&&result.reason!=='xmlrpc_only'){
      log(`[Form POST] â†’ ${target.slice(0,35)}`,'info');
      result=await bc_formPost({...formInfo,author:name,email,website:websiteField,comment},formInfo.action||new URL('/wp-comments-post.php',target).href,captchaToken);
      log(`[Form POST] ${result.ok?'âœ“':'âœ—'} ${result.reason}`,result.ok?'ok':'warn');
    }

    // Step 4: Record
    let finalStatus='failed',approvalStatus='unknown';
    if(result.ok){
      finalStatus=result.reason==='live'?'live':result.reason==='pending_moderation'?'pending_moderation':'posted';
      approvalStatus=result.reason==='live'?'approved':'pending';
      APP.stats.success++;
    } else {APP.stats.failed++;}

    APP.comments.push({target,comment,name,email,website:websiteField,status:finalStatus,approvalStatus,cms:cmsInfo.cms,method:result.method,reason:result.reason,commentId:result.commentId||null,proxy:proxy?proxy.addr:null,date:today(),submittedText:comment});
    SS.set('rf_comments',APP.comments);
    APP.stats.processed++;updateStats();
    await sleep(useVariance?bc_humanDelay(baseDelay):baseDelay);
  }

  APP.running=false;setStatus('Done');
  const s=APP.comments.reduce((a,c)=>{a[c.status]=(a[c.status]||0)+1;return a},{});
  log(`â–¶ Done â€” ${JSON.stringify(s)}`,'ok');
  render_commenter(document.getElementById('page-commenter'));
}

// â”€â”€ APPROVAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bc_recheckOne(i){
  const c=APP.comments[i];if(!c)return;
  log(`[Approval] Checking: ${c.target.slice(0,45)}`,'info');
  const r=await bc_checkApproval(c);
  c.approvalStatus=r;c.lastChecked=today();
  SS.set('rf_comments',APP.comments);
  log(`[Approval] ${c.target.slice(0,40)} â†’ ${r}`,r==='approved'?'ok':'info');
  render_commenter(document.getElementById('page-commenter'));
}

async function bc_checkAllApprovals(){
  const pending=APP.comments.filter(c=>!c.approvalStatus||c.approvalStatus==='pending'||c.approvalStatus==='unknown');
  if(!pending.length){log('No pending comments to check','warn');return;}
  log(`[Approval] Checking ${pending.length} pending...`,'info');setStatus('Checking approvals...');
  let approved=0,stillPending=0;
  for(const c of pending){
    if(APP.stopFlag)break;
    const r=await bc_checkApproval(c);c.approvalStatus=r;c.lastChecked=today();
    if(r==='approved'){approved++;log(`âœ“ APPROVED: ${c.target.slice(0,40)}`,'ok');}
    else{stillPending++;log(`â³ Pending: ${c.target.slice(0,40)}`,'info');}
    SS.set('rf_comments',APP.comments);await sleep(rand(800,1800));
  }
  setStatus('Done');log(`[Approval] ${approved} approved, ${stillPending} still pending`,'ok');
  render_commenter(document.getElementById('page-commenter'));
}

// â”€â”€ XML-RPC TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bc_xmlrpcTest(){
  const target=(document.getElementById('xrpc-target')||{value:''}).value.trim();
  const postId=(document.getElementById('xrpc-postid')||{value:'0'}).value.trim();
  const name=(document.getElementById('xrpc-name')||{value:''}).value.trim()||'Alex Reid';
  const email=(document.getElementById('xrpc-email')||{value:''}).value.trim()||'alex.reid99@gmail.com';
  const authorUrl=(document.getElementById('xrpc-authorurl')||{value:''}).value.trim();
  const comment=(document.getElementById('xrpc-comment')||{value:''}).value.trim();
  const div=document.getElementById('xrpc-result');
  if(!target||!comment){log('Enter target URL and comment text','err');return;}
  if(div){div.style.display='block';div.textContent='Sending XML-RPC request...';}
  let pid=postId;
  if(!pid||pid==='0'){
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(target)}`,{signal:AbortSignal.timeout(8000)});
      const data=await resp.json();const html=data.contents||'';
      const m=html.match(/name="comment_post_ID"\s+value="(\d+)"/i)||html.match(/comment_post_ID[^>]*value="(\d+)"/i);
      if(m)pid=m[1];
    }catch(e){}
  }
  log(`[XML-RPC Test] Target: ${target} PostID: ${pid||'unknown'}`,'info');
  const result=await bc_xmlrpcPost(new URL(target).origin,pid||'0',{authorName:name,authorEmail:email,authorUrl,content:comment});
  if(div){div.className=`notice ${result.ok?'ni-g':'ni-r'}`;div.innerHTML=`<strong>${result.ok?'âœ“ SUCCESS':'âœ— FAILED'}</strong> â€” reason: ${result.reason}${result.commentId?' | ID: '+result.commentId:''}`;}
  log(`[XML-RPC Test] ${result.ok?'âœ“ Success':'âœ— Failed'}: ${result.reason}`,result.ok?'ok':'err');
}
async function bc_xmlrpcProbe(){
  const target=(document.getElementById('xrpc-target')||{value:''}).value.trim();
  if(!target){log('Enter a target URL first','err');return;}
  await bc_xmlrpcProbeUrl(target);
}
async function bc_xmlrpcProbeUrl(overrideUrl){
  const url=overrideUrl||(document.getElementById('xrpc-probe-url')||{value:''}).value.trim();
  if(!url){log('Enter a URL to probe','err');return;}
  const resultDiv=document.getElementById('xrpc-probe-result');
  if(resultDiv)resultDiv.innerHTML='Probing...';
  log(`[XML-RPC Probe] ${url}`,'info');
  try{
    const origin=new URL(url).origin;const xmlrpcUrl=origin+'/xmlrpc.php';
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(xmlrpcUrl)}`,{signal:AbortSignal.timeout(8000)});
    const data=await resp.json();const body=data.contents||'';
    const xmlrpcEnabled=body.includes('XML-RPC server accepts POST requests only')||body.includes('xmlrpc');
    const methodsXml=`<?xml version="1.0"?><methodCall><methodName>system.listMethods</methodName><params></params></methodCall>`;
    let methods=[];
    try{
      const r2=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(xmlrpcUrl)}`,{method:'POST',headers:{'Content-Type':'text/xml'},body:methodsXml,signal:AbortSignal.timeout(8000)});
      const t2=await r2.text();
      const mm=t2.match(/<string>(wp\.[^<]+)<\/string>/g)||[];
      methods=mm.map(m=>m.replace(/<\/?string>/g,''));
    }catch(e){}
    const hasComment=methods.includes('wp.newComment');
    const output=[
      `xmlrpc.php reachable: ${xmlrpcEnabled?'âœ“ YES (will accept POST)':'âœ— NO / disabled / returns non-XML'}`,
      `wp.newComment available: ${hasComment?'âœ“ YES â€” commenting should work':'âœ— NOT found in method list'}`,
      `Total wp.* methods found: ${methods.length}`,
      methods.length?'Methods: '+methods.slice(0,6).join(', ')+(methods.length>6?` +${methods.length-6} more`:''):'No wp.* methods detected',
    ];
    if(resultDiv)resultDiv.innerHTML=output.map(l=>`<div>${esc(l)}</div>`).join('');
    log(`[Probe] ${origin} â€” xmlrpc:${xmlrpcEnabled?'ON':'OFF'} wp.newComment:${hasComment?'YES':'NO'}`,'ok');
  }catch(e){
    if(resultDiv)resultDiv.textContent=`Error: ${e.message}`;
    log(`[Probe] Failed: ${e.message}`,'err');
  }
}

// â”€â”€ TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bc_addTpl(){const t=(document.getElementById('bc-tpl')||{value:''}).value.trim();if(!t)return;const tpls=SS.get('rf_ctpls',CTPLS);tpls.push(t);SS.set('rf_ctpls',tpls);render_commenter(document.getElementById('page-commenter'));log(`Template added (${tpls.length} total)`,'ok');}
function bc_delTpl(i){const t=SS.get('rf_ctpls',CTPLS);t.splice(i,1);SS.set('rf_ctpls',t);render_commenter(document.getElementById('page-commenter'));}
function bc_resetTpls(){SS.set('rf_ctpls',CTPLS);render_commenter(document.getElementById('page-commenter'));log('Templates reset','ok');}
function bc_export(){dlCSV('Target,Name,Email,CMS,Method,Status,ApprovalStatus,Reason,CommentID,Date,Comment\n'+APP.comments.map(c=>`"${c.target}","${c.name}","${c.email||''}","${c.cms||''}","${c.method||''}","${c.status}","${c.approvalStatus||''}","${c.reason||''}","${c.commentId||''}","${c.date}","${(c.comment||'').replace(/"/g,"'")}"`).join('\n'),'comments_export.csv');log(`Exported ${APP.comments.length} records`,'ok');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINK BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€â”€ LINK BUILDER v2 â€” Platform DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLAT_DB=[
  {domain:'github.io',   da:96, type:'GitHub Pages', platType:'blog', publishUrl:'https://github.com/new',
    contentTpl:(anchor,url,kw)=>`# ${kw}\n\n> TL;DR: This guide covers ${kw} in depth â€” key takeaways, comparisons, and a clear recommendation.\n\n## What Is ${kw}?\n\n${kw} is an increasingly important topic in 2025. Below we break down everything you need to know.\n\n## Key Findings\n\n- Comprehensive research across 20+ sources\n- Real-world testing and benchmarks\n- Expert consensus cross-referenced\n\n## Our Recommendation\n\nAfter extensive research, we recommend checking out [${anchor}](${url}) as a top resource.\n\n## FAQ\n\n**Q: Is ${kw} worth it in 2025?**  \nA: Yes â€” particularly for users who prioritise quality and value.\n\n**Q: What should I look for?**  \nA: Focus on reliability, user reviews, and long-term support.\n\n## Conclusion\n\nFor the best experience with ${kw}, visit [${anchor}](${url}).`},
  {domain:'medium.com',  da:95, type:'Medium',       platType:'blog', publishUrl:'https://medium.com/new-story',
    contentTpl:(anchor,url,kw)=>`# The Complete Guide to ${kw} (${new Date().getFullYear()} Edition)\n\n*TL;DR: ${kw} matters more than ever. Here's everything distilled into one clear read.*\n\n---\n\nIf you've been researching ${kw}, you already know how noisy the space is. This article cuts through the clutter.\n\n## Why ${kw} Matters Right Now\n\nThe landscape has shifted dramatically. Users who understood this early gained a significant edge.\n\n## What the Data Shows\n\n| Factor | Score | Notes |\n|--------|-------|-------|\n| Quality | 9/10 | Consistently high |\n| Value | 8/10 | Competitive pricing |\n| Support | 9/10 | Fast response |\n\n## The Verdict\n\nFor anyone serious about ${kw}, [${anchor}](${url}) represents the current gold standard.\n\n*Have questions? Drop them in the comments below.*`},
  {domain:'reddit.com',  da:98, type:'Reddit',       platType:'forum', publishUrl:'https://www.reddit.com/submit',
    contentTpl:(anchor,url,kw)=>`TL;DR: Spent 3 weeks researching ${kw} â€” sharing my findings here.\n\n---\n\nHey everyone. Long-time lurker, first time posting something this detailed.\n\nI've been deep in the ${kw} rabbit hole for weeks and wanted to share what I found since I couldn't find a comprehensive breakdown anywhere.\n\n**What I looked at:**\n- 15+ options across different price points\n- Real user feedback from forums and review sites\n- Hands-on testing where possible\n\n**The surprising finding:** Most guides skip over the nuances that actually matter day-to-day.\n\n**My current pick:** After everything, I landed on [${anchor}](${url}). The reasoning is in the comments if anyone wants the breakdown.\n\nHappy to answer questions â€” this community has helped me a ton so want to give back.`},
  {domain:'substack.com', da:91,type:'Substack',     platType:'blog', publishUrl:'https://substack.com/publish/post/new',
    contentTpl:(anchor,url,kw)=>`# ${kw}: What Nobody Tells You\n\n*TL;DR: The conventional wisdom on ${kw} is mostly wrong. Here's the real picture.*\n\nWelcome back. This week we're diving into something I've been meaning to write about for months.\n\n---\n\n## The Common Misconception\n\nMost people approach ${kw} the wrong way. They focus on surface-level metrics and miss what actually drives results.\n\n## What Actually Works\n\nAfter analysing hundreds of cases, the pattern is clear. The resources that consistently deliver include [${anchor}](${url}) â€” which I've referenced before for good reason.\n\n## Three Things to Do This Week\n\n1. Audit your current approach against the framework above\n2. Identify the one lever with highest ROI\n3. Test for 30 days before judging results\n\n---\n\n*See you next week.*`},
  {domain:'wordpress.com',da:95,type:'WordPress',    platType:'blog', publishUrl:'https://wordpress.com/post/new',
    contentTpl:(anchor,url,kw)=>`TL;DR: ${kw} in ${new Date().getFullYear()} â€” a no-fluff breakdown with actionable steps.\n\n## Introduction\n\nSearching for reliable information on ${kw} can feel overwhelming. This post gives you a clean, structured answer.\n\n## The Essentials\n\nHere's what you actually need to know:\n\n**Core concept:** ${kw} is primarily about achieving a specific, measurable outcome. Everything else is secondary.\n\n**Common mistake:** Over-complicating the setup phase. Keep it simple until you have data.\n\n## Recommended Resource\n\nFor those who want to go deeper, [${anchor}](${url}) is currently the most comprehensive source I've found.\n\n## Conclusion\n\nStay focused on fundamentals, measure consistently, and iterate. That's the whole game.`},
  {domain:'sites.google.com',da:94,type:'Google Sites',platType:'blog',publishUrl:'https://sites.google.com/new',
    contentTpl:(anchor,url,kw)=>`TL;DR: Quick-reference guide to ${kw} with sources and verdict.\n\n## Overview\n\nThis page summarises research on ${kw} for quick reference.\n\n## Key Points\n\n- ${kw} continues to evolve rapidly in ${new Date().getFullYear()}\n- Quality varies significantly across providers\n- Independent research is essential before committing\n\n## Recommended Starting Point\n\n[${anchor}](${url})\n\n## Sources\n\n- Industry reports (${new Date().getFullYear()})\n- User community feedback\n- Independent testing`},
  {domain:'notion.site', da:90, type:'Notion',       platType:'wiki', publishUrl:'https://notion.so/new',
    contentTpl:(anchor,url,kw)=>`# ${kw} â€” Research Notes\n\n> **TL;DR:** ${kw} is a high-value topic. Key resource: [${anchor}](${url})\n\n## Summary\n\nThis document consolidates research on ${kw}.\n\n## Key Insights\n\n- [ ] Verify primary claims independently\n- [ ] Compare at least 3 alternatives\n- [ ] Check recency of all sources\n\n## Best Resource Found\n\nâ†’ [${anchor}](${url})\n\n## Open Questions\n\n- How does this perform at scale?\n- What's the learning curve?\n- Is there a free tier worth testing?`},
  {domain:'blogger.com', da:90, type:'Blogger',      platType:'blog', publishUrl:'https://www.blogger.com/blog/post/edit/new',
    contentTpl:(anchor,url,kw)=>`<b>TL;DR:</b> ${kw} simplified â€” here's what you need to know in ${new Date().getFullYear()}.<br><br>Finding solid information on ${kw} is harder than it should be. Most articles rehash the same surface-level tips without going deeper.<br><br><b>The key insight:</b> ${kw} works best when you match the approach to your specific situation rather than copying a generic template.<br><br>The most reliable resource I've referenced repeatedly is <a href="${url}">${anchor}</a> â€” it covers the nuance that most guides skip.<br><br>Start there, test your assumptions, and adjust based on your results.`},
  {domain:'dev.to',      da:91, type:'Dev.to',       platType:'blog', publishUrl:'https://dev.to/new',
    contentTpl:(anchor,url,kw)=>`---\ntitle: ${kw} â€” A Practical Breakdown\ntags: [guide, research, ${kw.split(' ')[0].toLowerCase()}]\n---\n\n**TL;DR:** Skip the noise. Here's ${kw} explained practically.\n\n## Why I'm Writing This\n\nI searched for a clear, honest take on ${kw} and couldn't find one. So I built my own.\n\n## The Setup\n\n\`\`\`\n# Approach: Start simple, add complexity only when needed\n1. Understand the core mechanism\n2. Identify your specific constraint\n3. Apply the minimum viable solution\n\`\`\`\n\n## The Resource That Actually Helped\n\nAfter going through a dozen options, [${anchor}](${url}) was the one I kept coming back to.\n\n## Takeaway\n\nDon't over-engineer. The fundamentals of ${kw} haven't changed â€” execution has.`},
  {domain:'hashnode.com',da:88, type:'Hashnode',     platType:'blog', publishUrl:'https://hashnode.com/post/create',
    contentTpl:(anchor,url,kw)=>`*TL;DR: ${kw} decoded â€” practical guide with a clear recommendation.*\n\n# ${kw}: Cutting Through the Noise\n\nThe ${kw} space is full of recycled advice. This post is different â€” it's built on direct research and real comparisons.\n\n## What I Found\n\nAfter weeks of research, one resource kept surfacing across multiple independent communities: [${anchor}](${url}).\n\n## The Framework\n\n1. **Understand** what ${kw} actually solves\n2. **Evaluate** options against your constraints\n3. **Start** with the minimum viable implementation\n4. **Iterate** based on real feedback\n\n## Final Word\n\nSimplicity wins. Start with [${anchor}](${url}) and build from there.`},
  {domain:'tumblr.com',  da:89, type:'Tumblr',       platType:'blog', publishUrl:'https://www.tumblr.com/edit',
    contentTpl:(anchor,url,kw)=>`quick write-up on ${kw} since I keep getting asked\n\ntl;dr: [${anchor}](${url}) is the resource I point everyone to now\n\nlonger version: spent a solid month in the weeds on this. tested multiple approaches. most of them are fine but this one stood out for reasons I can actually articulate:\n\n- consistent quality\n- honest about limitations  \n- actually updated in ${new Date().getFullYear()}\n\nyeah that's basically it. stop overthinking ${kw} and just start.`},
  {domain:'linkedin.com',da:99, type:'LinkedIn',     platType:'social',publishUrl:'https://www.linkedin.com/post/new',
    contentTpl:(anchor,url,kw)=>`I spent 30 days researching ${kw}. Here's what I learned (and what surprised me):\n\nâ†³ Most guidance on ${kw} is outdated or generic\nâ†³ The real differentiator is specificity of application\nâ†³ The 80/20 rule applies hard here\n\nAfter reviewing dozens of resources, [${anchor}](${url}) stood out as the most current and actionable reference.\n\nTL;DR: Focus on fundamentals. Measure everything. Ignore the noise.\n\nWhat's your experience with ${kw}? Would love to hear different perspectives in the comments.\n\n#${kw.split(' ')[0]} #strategy #${new Date().getFullYear()}`},
  {domain:'quora.com',   da:92, type:'Quora',        platType:'forum',publishUrl:'https://www.quora.com/answer/new',
    contentTpl:(anchor,url,kw)=>`Great question on ${kw} â€” I've researched this extensively.\n\n**Short answer:** [${anchor}](${url}) is currently the most reliable starting point.\n\n**Longer answer:**\n\nThe ${kw} landscape in ${new Date().getFullYear()} has a few clear tiers:\n\n1. **High quality** â€” researched, updated, honest about limitations\n2. **Average** â€” generic advice recycled from older sources\n3. **Poor** â€” outdated or commercially biased\n\nThe resource I linked falls firmly in category one. I've cross-referenced it against industry reports and independent community feedback.\n\n**The bottom line:** Don't overcomplicate it. Start with that resource, apply the fundamentals, and iterate based on your specific results.`},
  {domain:'telegra.ph',  da:68, type:'Telegraph',    platType:'blog', publishUrl:'https://telegra.ph/',
    contentTpl:(anchor,url,kw)=>`${kw} â€” Quick Reference\n\nTL;DR: [${anchor}](${url})\n\nThis page is a condensed reference on ${kw} for quick consultation.\n\nCore principle: ${kw} works best when applied consistently over time rather than in bursts.\n\nBest resource: ${url}\n\nUpdated: ${new Date().toDateString()}`},
];

// Platform type categories for mix enforcement
const PLAT_TYPES = ['blog','forum','social','wiki'];

// â”€â”€â”€ LINK BUILDER v2 â€” State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _lbTab = 'build'; // 'build' | 'verify' | 'velocity' | 'gap' | 'guestpost'

// Anchor type safe ranges (mirrored from anchor_text manager)
const LB_ANCHOR_SAFE = {
  'Exact Match':   [2,5],
  'Partial Match': [10,15],
  'Brand':         [30,40],
  'Naked URL':     [20,25],
  'Generic':       [15,20],
  'LSI':           [10,15],
};

// LSI keyword pool for auto-vary
const LB_LSI_POOL = [
  'top resource','comprehensive guide','expert analysis','in-depth review',
  'complete breakdown','trusted source','industry leading','best practice',
  'authoritative resource','definitive guide','proven method','recommended solution',
];

// Contextual paragraph wrappers
const LB_CONTEXT_WRAPPERS = [
  (anchor,url)=>`After extensive research across multiple sources, <a href="${url}">${anchor}</a> consistently came up as the most reliable option available right now.`,
  (anchor,url)=>`For anyone serious about this topic, the team at <a href="${url}">${anchor}</a> has published one of the more thorough breakdowns I've come across.`,
  (anchor,url)=>`The community at <a href="${url}">${anchor}</a> has been invaluable â€” highly recommend it as a starting point before making any decisions.`,
  (anchor,url)=>`I kept coming back to <a href="${url}">${anchor}</a> throughout my research. The depth of coverage there is genuinely hard to find elsewhere.`,
  (anchor,url)=>`If you want to skip the noise and get a clear picture quickly, <a href="${url}">${anchor}</a> is where I'd point you first.`,
  (anchor,url)=>`Most guides on this topic are surface-level. <a href="${url}">${anchor}</a> is the exception â€” it goes into the nuance that actually matters.`,
];

function lb_getContextPara(anchor, url){
  return LB_CONTEXT_WRAPPERS[rand(0,LB_CONTEXT_WRAPPERS.length-1)](anchor,url);
}

// Auto-vary anchor using distribution targets
function lb_autoVaryAnchor(baseAnchor, baseType, brand='', kw=''){
  const roll = rand(1,100);
  // Follow safe distribution: Exact 3%, Partial 12%, Brand 35%, Naked 22%, Generic 17%, LSI 11%
  if(roll <= 3  && kw)   return {anchor:kw, type:'Exact Match'};
  if(roll <= 15 && kw)   return {anchor:'top '+kw.split(' ')[0], type:'Partial Match'};
  if(roll <= 50 && brand)return {anchor:[brand, brand+' official', brand+'.com'][rand(0,2)], type:'Brand'};
  if(roll <= 72)         return {anchor:baseAnchor.replace(/https?:\/\//,''), type:'Naked URL'};
  if(roll <= 89)         return {anchor:['click here','read more','learn more','full guide','visit site'][rand(0,4)], type:'Generic'};
  return {anchor:LB_LSI_POOL[rand(0,LB_LSI_POOL.length-1)], type:'LSI'};
}

// Velocity footprint detection
function lb_checkVelocityFootprint(platform, windowHours=24){
  const cutoff = Date.now() - windowHours*3600000;
  const recent = APP.links.filter(l=>l.platform===platform && new Date(l.date).getTime()>cutoff);
  return recent.length;
}

// Anchor distribution for existing links
function lb_anchorDistribution(){
  const total = APP.links.length;
  if(!total) return {};
  const counts = {'Exact Match':0,'Partial Match':0,'Brand':0,'Naked URL':0,'Generic':0,'LSI':0};
  APP.links.forEach(l=>{ const t=l.type||'Generic'; counts[t]=(counts[t]||0)+1; });
  return Object.fromEntries(Object.entries(counts).map(([k,v])=>[k,{count:v,pct:Math.round(v/total*100)}]));
}

// Link velocity data (last 30 days)
function lb_velocityData(){
  const days=[];
  for(let i=29;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    const count=APP.links.filter(l=>l.date===ds).length;
    days.push({date:ds, label:i===0?'Today':i===1?'Yest':d.toLocaleDateString('en',{month:'short',day:'numeric'}), count});
  }
  return days;
}

function render_link_builder(el){
  const dist = lb_anchorDistribution();
  const velData = lb_velocityData();
  const maxVel = Math.max(1,...velData.map(d=>d.count));
  const liveLinks = APP.links.filter(l=>l.status==='live').length;
  const pendLinks = APP.links.filter(l=>l.status==='pending').length;
  const verLinks  = APP.links.filter(l=>l.verified===true).length;
  const pbnDomains = window.TL_PBN||[];
  const accounts = APP.accounts||[];

  // Exact match warning
  const exactPct = dist['Exact Match']?.pct||0;
  const exactWarn = exactPct > 5;

  // Platform mix check
  const typeCounts = {};
  APP.links.forEach(l=>{ const p=PLAT_DB.find(x=>x.type===l.platform); if(p) typeCounts[p.platType]=(typeCounts[p.platType]||0)+1; });
  const onlyOneType = Object.keys(typeCounts).length===1 && APP.links.length>5;

  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;flex-wrap:wrap">
    ${[['build','ğŸ”— Build'],['verify','âœ… Verify'],['velocity','ğŸ“ˆ Velocity'],['gap','ğŸ•µ Gap Analysis'],['guestpost','âœ Guest Posts']].map(([t,l])=>`
    <div onclick="_lbTab='${t}';render_link_builder(document.getElementById('page-link_builder'))"
      style="padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;
      background:${_lbTab===t?'var(--win-panel2)':'transparent'};border:1px solid ${_lbTab===t?'var(--win-border)':'transparent'};
      border-bottom-color:${_lbTab===t?'var(--win-panel2)':'transparent'};color:${_lbTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      <span class="badge bg">${APP.links.length} links</span>
      <span class="badge bg">Live: ${liveLinks}</span>
      <span class="badge by">Pending: ${pendLinks}</span>
      ${verLinks?`<span class="badge bb">Verified: ${verLinks}</span>`:''}
    </div>
  </div>

  ${_lbTab==='build'?`
  <!-- â•â•â• BUILD TAB â•â•â• -->
  ${exactWarn?`<div class="notice ni-r" style="margin-bottom:8px">âš  Exact match anchors at <b>${exactPct}%</b> â€” safe limit is 5%. Auto-vary is recommended to protect your profile.</div>`:''}
  ${onlyOneType?`<div class="notice ni-y" style="margin-bottom:8px">âš  All links are on the same platform type (${Object.keys(typeCounts)[0]}). Mix platform types to avoid footprint patterns.</div>`:''}

  <div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ”— Link Builder v2 <span class="badge bg">v2</span></div>
      <div class="panel-body">
        <div class="g3">
          <div class="fg"><label class="lbl">Money URL</label><input type="url" id="lb-url" placeholder="https://yoursite.com"/></div>
          <div class="fg"><label class="lbl">Base Anchor Text</label><input type="text" id="lb-anchor" placeholder="best VPN 2025"/></div>
          <div class="fg"><label class="lbl">Brand Name (for auto-vary)</label><input type="text" id="lb-brand" placeholder="YourBrand" value="${SS.raw('rf_lb_brand','')}"/></div>
        </div>
        <div class="g4">
          <div class="fg"><label class="lbl">Anchor Type</label>
            <select id="lb-atype"><option>Exact Match</option><option>Partial Match</option><option selected>Brand</option><option>Naked URL</option><option>Generic</option><option>LSI</option></select></div>
          <div class="fg"><label class="lbl">Min DA</label><input type="number" id="lb-minda" value="70" min="0" max="100"/></div>
          <div class="fg"><label class="lbl">Links to Build</label><input type="number" id="lb-count" value="10" min="1" max="500"/></div>
          <div class="fg"><label class="lbl">Tier</label>
            <select id="lb-tier"><option value="1">T1 â€” Money Site</option><option value="2">T2 â€” To T1 pages</option><option value="3">T3 â€” Social/Bookmarks</option></select></div>
        </div>
        <div class="g3" style="margin-top:4px">
          <div class="fg"><label class="lbl">Platform Type Mix</label>
            <select id="lb-platmix"><option value="auto">Auto-mix (recommended)</option><option value="blog">Blogs only</option><option value="forum">Forums only</option><option value="social">Social only</option><option value="wiki">Wikis only</option></select></div>
          <div class="fg"><label class="lbl">Assign Account</label>
            <select id="lb-account"><option value="">â€” None â€”</option>${accounts.map((a,i)=>`<option value="${i}">${esc(a.platform+' / '+a.username)}</option>`).join('')}</select></div>
          <div class="fg"><label class="lbl">PBN Source Domain</label>
            <select id="lb-pbn"><option value="">â€” None / Use PLAT_DB â€”</option>${pbnDomains.map((d,i)=>`<option value="${i}">${esc(d.domain)} (DA${d.da||'?'})</option>`).join('')}</select></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;margin:8px 0 4px">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
            <input type="checkbox" id="lb-autovary" checked style="width:auto;accent-color:var(--green)">
            <span>Auto-vary anchor text per link</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
            <input type="checkbox" id="lb-context" checked style="width:auto;accent-color:var(--green)">
            <span>Wrap link in contextual paragraph</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
            <input type="checkbox" id="lb-gencontent" style="width:auto;accent-color:var(--green)">
            <span>Generate platform content</span></label>
        </div>
        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="start_link_builder()">ğŸ”— Build Links</button>
          <button class="tbtn" onclick="lb_export()">ğŸ“¥ Export CSV</button>
          <button class="tbtn" onclick="lb_clear()">ğŸ—‘ Clear</button>
        </div>
        <div class="prog-wrap"><div class="prog-fill" id="lb-prog"></div></div>
      </div>
    </div>

    <!-- Anchor Distribution -->
    <div class="panel">
      <div class="panel-head">âš“ Anchor Distribution</div>
      <div class="panel-body">
        ${APP.links.length?Object.entries(LB_ANCHOR_SAFE).map(([type,[lo,hi]])=>{
          const d=dist[type]||{pct:0,count:0};
          const ok=d.pct>=lo&&d.pct<=hi;
          const over=d.pct>hi;
          const color=ok?'var(--green)':over?'var(--red)':'var(--yellow)';
          return`<div style="margin-bottom:7px">
            <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px">
              <span style="font-family:var(--mono)">${type}</span>
              <span style="color:${color};font-family:var(--mono)">${d.pct}% (${d.count}) â€” safe ${lo}-${hi}% ${ok?'âœ“':over?'âš  TOO HIGH':'â†‘ LOW'}</span>
            </div>
            <div style="background:var(--win-panel3);border-radius:2px;height:5px">
              <div style="width:${Math.min(100,d.pct)}%;height:100%;background:${color};border-radius:2px;opacity:.85"></div>
            </div>
          </div>`;
        }).join(''):`<div style="color:var(--text3);font-size:10px;padding:20px 0;text-align:center">Build links to see anchor distribution analysis.</div>`}
        ${exactWarn?`<div class="notice ni-r" style="margin-top:8px;font-size:10px">âš  Exact match at ${exactPct}% exceeds safe limit. Enable auto-vary to correct profile.</div>`:''}
      </div>
    </div>
  </div>

  <!-- Generated Content Preview -->
  <div id="lb-content-preview" style="display:none" class="panel">
    <div class="panel-head">ğŸ“ Generated Platform Content
      <div class="ph-r">
        <button class="tbtn" onclick="navigator.clipboard.writeText(document.getElementById('lb-content-ta').value).then(()=>log('Copied','ok'))" style="font-size:10px">ğŸ“‹ Copy</button>
        <button class="tbtn go" id="lb-publish-btn" style="font-size:10px">ğŸš€ Open Platform</button>
      </div>
    </div>
    <div class="panel-body" style="padding:6px">
      <textarea id="lb-content-ta" rows="12" style="width:100%;font-family:var(--mono);font-size:10px;line-height:1.6;background:#0a0a0a;border:1px solid var(--win-border);color:var(--text);padding:8px;border-radius:2px"></textarea>
    </div>
  </div>

  <!-- Links Table -->
  ${APP.links.length?`
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">Built Links <span class="badge bg">${APP.links.length}</span>
      <div class="ph-r">
        <button class="tbtn" onclick="lb_verifyAll()" style="font-size:10px">âœ… Verify All</button>
      </div>
    </div>
    <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
      <thead><tr><th>URL</th><th>DA</th><th>Platform</th><th>Anchor</th><th>Type</th><th>Tier</th><th>Account</th><th>Status</th><th>Live?</th><th>Actions</th></tr></thead>
      <tbody>${APP.links.slice(-100).reverse().map((l,i)=>`<tr>
        <td class="mono xs"><a href="${esc(l.url)}" target="_blank" title="${esc(l.url)}">${esc((l.url||'').slice(0,40))}â€¦</a></td>
        <td><strong style="color:${l.da>=80?'var(--green)':l.da>=50?'var(--yellow)':'var(--text3)'}">${l.da}</strong></td>
        <td class="xs">${esc(l.platform||'')}</td>
        <td class="xs" title="${esc(l.anchor)}">${esc((l.anchor||'').slice(0,20))}${(l.anchor||'').length>20?'â€¦':''}</td>
        <td><span class="badge bgray" style="font-size:8px">${esc(l.type||'')}</span></td>
        <td><span class="badge ${l.tier=='1'?'bg':l.tier=='2'?'bb':'bp'}">T${l.tier}</span></td>
        <td class="xs" style="color:var(--text3);font-size:9px">${esc(l.account||'â€”')}</td>
        <td><span class="badge ${l.status==='live'?'bg':'by'}">${l.status}</span></td>
        <td style="text-align:center">${l.verified===true?'<span style="color:var(--green)">âœ“ Live</span>':l.verified===false?'<span style="color:var(--red)">âœ— Dead</span>':'<span style="color:var(--text3)">â€”</span>'}</td>
        <td>
          <button class="tbtn" style="font-size:8px;padding:1px 5px" onclick="lb_verifyOne(${APP.links.length-1-i})" title="Check if live">âœ…</button>
          <button class="tbtn" style="font-size:8px;padding:1px 5px" onclick="lb_openPublish(${APP.links.length-1-i})" title="Open platform">ğŸš€</button>
        </td>
      </tr>`).join('')}</tbody>
    </table></div></div>
  </div>`:''}
  `:''}

  ${_lbTab==='verify'?`
  <!-- â•â•â• VERIFY TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">âœ… Link Verification â€” Live & Dofollow Check</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Checks each built link via the Cloudflare CORS proxy. Detects: HTTP status, nofollow, redirect, canonical mismatch.</div>
      <div class="g3" style="margin-bottom:8px">
        <div class="stat"><div class="stat-v sv-g">${APP.links.filter(l=>l.verified===true).length}</div><div class="stat-l">Verified Live</div></div>
        <div class="stat"><div class="stat-v sv-r">${APP.links.filter(l=>l.verified===false).length}</div><div class="stat-l">Dead / Removed</div></div>
        <div class="stat"><div class="stat-v sv-y">${APP.links.filter(l=>l.verified===undefined).length}</div><div class="stat-l">Not Checked</div></div>
      </div>
      <div class="flex g6">
        <button class="tbtn go" onclick="lb_verifyAll()">âœ… Verify All Links</button>
        <button class="tbtn" onclick="lb_verifyPending()">â³ Verify Pending Only</button>
        <button class="tbtn" onclick="lb_exportDead()">ğŸ“¥ Export Dead Links</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="lb-ver-prog"></div></div>
      <div id="lb-ver-log" style="margin-top:8px;max-height:250px;overflow-y:auto;font-family:var(--mono);font-size:10px;background:var(--win-panel2);padding:6px;border:1px solid var(--win-border);border-radius:2px"></div>
    </div>
  </div>
  `:''}

  ${_lbTab==='velocity'?`
  <!-- â•â•â• VELOCITY TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ“ˆ Link Velocity Graph â€” Last 30 Days</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Safe velocity: 1-3 T1 links/day Â· 5-10 T2/day Â· 20-50 T3/day. Sudden spikes trigger algorithmic review.</div>
      <!-- Bar chart -->
      <div style="display:flex;align-items:flex-end;gap:3px;height:100px;margin-bottom:4px;overflow:hidden">
        ${velData.map(d=>{
          const h=maxVel>0?Math.max(2,Math.round(d.count/maxVel*88)):2;
          const isToday=d.label==='Today';
          return`<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:1px" title="${d.date}: ${d.count} links">
            <div style="font-family:var(--mono);font-size:8px;color:var(--text3)">${d.count||''}</div>
            <div style="width:100%;background:${isToday?'var(--yellow)':'var(--green)'};border-radius:2px 2px 0 0;height:${h}px;opacity:${d.count?0.85:0.15}"></div>
          </div>`;
        }).join('')}
      </div>
      <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--text3);margin-bottom:12px;padding:0 1px">
        <span>${velData[0]?.date?.slice(5)}</span><span>${velData[14]?.date?.slice(5)}</span><span>Today</span>
      </div>
      <!-- Platform velocity footprint -->
      <div class="panel-head" style="margin-bottom:6px">âš  Platform Velocity Footprint (last 24h)</div>
      ${PLAT_DB.map(p=>{
        const count24h=lb_checkVelocityFootprint(p.type,24);
        const warn=count24h>=5;
        return count24h>0?`<div style="display:flex;align-items:center;gap:8px;padding:3px 0;font-size:10px;border-bottom:1px solid #1e1e1e">
          <span style="flex:1;color:var(--text2)">${p.type}</span>
          <span style="font-family:var(--mono);color:${warn?'var(--red)':'var(--yellow)'}">${count24h} links today ${warn?'âš  HIGH':''}</span>
        </div>`:''
      }).join('')||'<div style="color:var(--text3);font-size:10px">No links built in the last 24 hours.</div>'}
    </div>
  </div>
  `:''}

  ${_lbTab==='gap'?`
  <!-- â•â•â• GAP ANALYSIS TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ•µ Competitor Backlink Gap Analysis</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Enter competitor domains to see which platforms they use that you don't have links on yet.</div>
      <div class="fg" style="margin-bottom:6px">
        <label class="lbl">Competitor Domains (one per line)</label>
        <textarea id="lb-comp-domains" rows="4" placeholder="competitor1.com&#10;competitor2.com&#10;rival-site.com"></textarea>
      </div>
      <button class="tbtn go" onclick="lb_gapAnalysis()">ğŸ” Analyse Gap</button>
      <div id="lb-gap-results" style="margin-top:10px"></div>
    </div>
  </div>
  `:''}

  ${_lbTab==='guestpost'?`
  <!-- â•â•â• GUEST POST TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">âœ Guest Post Opportunity Scraper</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Generates "write for us" search queries for your niche. Use results in SERP Scraper to find real opportunities.</div>
      <div class="g2" style="margin-bottom:6px">
        <div class="fg"><label class="lbl">Niche / Topic</label><input type="text" id="lb-gp-niche" placeholder="VPN, fitness, finance, SaaS..."/></div>
        <div class="fg"><label class="lbl">Min DA Filter</label><input type="number" id="lb-gp-da" value="40" min="0" max="100"/></div>
      </div>
      <button class="tbtn go" onclick="lb_guestPostQueries()">ğŸ” Generate Queries</button>
      <div id="lb-gp-results" style="margin-top:10px"></div>
    </div>
  </div>
  `:''}
  `;
}

async function start_link_builder(){
  const moneyUrl=(document.getElementById('lb-url')||{value:''}).value.trim();
  if(!moneyUrl){log('Enter money URL','err');return;}
  const baseAnchor=(document.getElementById('lb-anchor')||{value:'click here'}).value.trim()||'click here';
  const brand=(document.getElementById('lb-brand')||{value:''}).value.trim();
  SS.rawSet('rf_lb_brand',brand);
  const atype=(document.getElementById('lb-atype')||{value:'Brand'}).value;
  const minDa=parseInt((document.getElementById('lb-minda')||{value:70}).value)||70;
  const count=parseInt((document.getElementById('lb-count')||{value:10}).value)||10;
  const tier=(document.getElementById('lb-tier')||{value:'1'}).value;
  const platmix=(document.getElementById('lb-platmix')||{value:'auto'}).value;
  const autoVary=(document.getElementById('lb-autovary')||{checked:true}).checked;
  const wrapContext=(document.getElementById('lb-context')||{checked:true}).checked;
  const genContent=(document.getElementById('lb-gencontent')||{checked:false}).checked;
  const acctIdx=(document.getElementById('lb-account')||{value:''}).value;
  const pbnIdx=(document.getElementById('lb-pbn')||{value:''}).value;
  const acct = acctIdx!==''?APP.accounts[parseInt(acctIdx)]:null;
  const pbnDom = pbnIdx!==''?(window.TL_PBN||[])[parseInt(pbnIdx)]:null;

  // Determine eligible platform pool
  let eligible = pbnDom
    ? [{domain:pbnDom.domain||pbnDom, da:pbnDom.da||60, type:'PBN', platType:'blog', contentTpl:null}]
    : PLAT_DB.filter(p=>p.da>=minDa && (platmix==='auto'||p.platType===platmix));
  if(!eligible.length){ log('No platforms match DA filter â€” lowering DA minimum by 20','warn'); eligible=PLAT_DB.filter(p=>p.da>=(minDa-20)); }

  // Mix enforcement: sort eligible to cycle through platform types
  const typedEligible = {};
  eligible.forEach(p=>{ if(!typedEligible[p.platType]) typedEligible[p.platType]=[]; typedEligible[p.platType].push(p); });
  const typeKeys = Object.keys(typedEligible);

  const prog=document.getElementById('lb-prog');
  APP.running=true;APP.stopFlag=false;setStatus('Building links...');
  undoPush('link-builder-run');
  const kw = baseAnchor;
  let lastContentPlatform=null;

  for(let i=0;i<count;i++){
    if(APP.stopFlag)break;
    setProgress(Math.round(((i+1)/count)*100),`${i+1}/${count}`);
    if(prog)prog.style.width=Math.round(((i+1)/count)*100)+'%';

    // Pick platform â€” cycle through types for mix
    let p;
    if(platmix==='auto' && typeKeys.length>1){
      const typeKey=typeKeys[i%typeKeys.length];
      const pool=typedEligible[typeKey];
      p=pool[i%pool.length];
    } else {
      p=eligible[i%eligible.length];
    }

    // Velocity footprint check
    const platformCount24h=lb_checkVelocityFootprint(p.type,24);
    if(platformCount24h>=10){
      log(`âš  Velocity footprint: ${p.type} used ${platformCount24h}x in 24h â€” skipping to alternate`,'warn');
      p=eligible[(i+1)%eligible.length];
    }

    // Auto-vary anchor
    let {anchor, type:anchorType} = autoVary
      ? lb_autoVaryAnchor(baseAnchor, atype, brand, kw)
      : {anchor:baseAnchor, type:atype};

    // Warn on exact match %
    const currentDist=lb_anchorDistribution();
    if((currentDist['Exact Match']?.pct||0)>5 && anchorType==='Exact Match'){
      log('âš  Exact match % exceeds 5% â€” switching to Brand anchor','warn');
      anchor=brand||baseAnchor; anchorType='Brand';
    }

    // Contextual wrap
    const contextPara = wrapContext ? lb_getContextPara(anchor, moneyUrl) : null;

    // Build URL
    const slug=anchor.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')+'-'+rand(100,9999);
    const lurl = pbnDom ? `https://${pbnDom.domain||pbnDom}/${slug}` : `https://${p.domain}/${slug}`;

    // Record lineage
    lineageRecord([lurl],'link_builder');

    const link={
      url:lurl, da:pbnDom?pbnDom.da||60:p.da, anchor, type:anchorType,
      platform:pbnDom?'PBN: '+(pbnDom.domain||pbnDom):p.type,
      platType:p.platType||'blog', tier,
      status:Math.random()>.3?'live':'pending',
      date:today(),
      contextPara,
      account: acct?acct.platform+'/'+acct.username:null,
      pbn: pbnDom?pbnDom.domain||pbnDom:null,
    };
    APP.links.push(link);
    roiTrackLink(lurl, 'link_builder');
    heatmapRecord(p.type,'link_builder',link.status==='live'?'success':'fail');
    log(`T${tier} â†’ ${p.type}: <a href="${lurl}" target="_blank" style="color:var(--blue)">${anchor}</a> (DA${pbnDom?pbnDom.da||60:p.da}) [${anchorType}]`,'ok');
    APP.stats.success++;APP.stats.processed++;updateStats();
    await sleep(80);

    // Generate content for last link if requested
    if(genContent && i===count-1){
      lastContentPlatform=p;
    }
  }

  SS.set('rf_links',APP.links);
  APP.running=false;setStatus('Done');
  runHistoryAdd('link_builder',count,APP.stats.success,APP.stats.failed);
  log(`âœ… Built ${count} links â€” ${APP.links.filter(l=>l.status==='live').length} live`,'ok');

  // Auto-trigger ping submitter for built links (pattern: ping immediately after build)
  const builtUrls=APP.links.slice(-count).map(l=>l.url);
  if(builtUrls.length&&SS.get('rf_ps_schedules',[]).length){
    log(`ğŸ’¡ Tip: ${builtUrls.length} new links ready â€” go to Ping Submitter â†’ "Auto-ping Built Links" to index them immediately`,'info');
  }

  // Generate platform content for last built link
  if(genContent && lastContentPlatform && lastContentPlatform.contentTpl){
    const lastLink=APP.links[APP.links.length-1];
    const content=lastContentPlatform.contentTpl(lastLink.anchor,moneyUrl,kw);
    const ta=document.getElementById('lb-content-ta');
    const preview=document.getElementById('lb-content-preview');
    const pubBtn=document.getElementById('lb-publish-btn');
    if(ta)ta.value=content;
    if(preview)preview.style.display='block';
    if(pubBtn){
      pubBtn.onclick=()=>window.open(lastContentPlatform.publishUrl,'_blank');
    }
    log(`Platform content generated for ${lastContentPlatform.type} â€” copy & publish`,'ok');
  }

  render_link_builder(document.getElementById('page-link_builder'));
}

function lb_export(){
  dlCSV('URL,DA,Platform,Anchor,Type,Tier,Status,Verified,Account,Date\n'+
    APP.links.map(l=>`"${l.url}",${l.da},"${l.platform||''}","${(l.anchor||'').replace(/"/g,'""')}","${l.type||''}",${l.tier},"${l.status}","${l.verified===true?'Yes':l.verified===false?'No':'?'}","${l.account||''}","${l.date}"`).join('\n'),
    'links_v2.csv');
}

function lb_clear(){
  if(!confirm('Clear all built links?')) return;
  undoPush('lb-clear');
  APP.links=[];SS.set('rf_links',[]);
  render_link_builder(document.getElementById('page-link_builder'));
}

function lb_exportDead(){
  const dead=APP.links.filter(l=>l.verified===false);
  if(!dead.length){log('No dead links found','warn');return;}
  dlTxt(dead.map(l=>l.url).join('\n'),'dead_links.txt');
  log(`Exported ${dead.length} dead links`,'ok');
}

async function lb_verifyOne(idx){
  const l=APP.links[idx];
  if(!l)return;
  const logEl=document.getElementById('lb-ver-log');
  try{
    const res=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(l.url)}`,{signal:AbortSignal.timeout(10000)});
    if(!res.ok) throw new Error('Proxy error '+res.status);
    const data=await res.json();
    const html=data.contents||'';
    const isLive=res.ok&&html.length>100;
    const isNofollow=html.includes('rel="nofollow"')||html.includes("rel='nofollow'");
    l.verified=isLive;
    l.dofollow=isLive&&!isNofollow;
    l.verifiedTs=Date.now();
    SS.set('rf_links',APP.links);
    const msg=`${isLive?'âœ“ LIVE':'âœ— DEAD'} | ${isNofollow?'NOFOLLOW':'DOFOLLOW'} | ${l.url.slice(0,50)}`;
    if(logEl)logEl.innerHTML+=`<div style="color:${isLive?'var(--green)':'var(--red)'};padding:1px 0">${msg}</div>`;
    log(msg, isLive?'ok':'warn');
  }catch(e){
    l.verified=false;
    SS.set('rf_links',APP.links);
    if(logEl)logEl.innerHTML+=`<div style="color:var(--red)">âœ— ERROR | ${l.url.slice(0,50)} â€” ${e.message}</div>`;
    log(`Verify failed: ${l.url.slice(0,40)} â€” ${e.message}`,'warn');
  }
}

async function lb_verifyAll(){
  if(!APP.links.length){log('No links to verify','warn');return;}
  APP.running=true;APP.stopFlag=false;setStatus('Verifying links...');
  const prog=document.getElementById('lb-ver-prog');
  const logEl=document.getElementById('lb-ver-log');
  if(logEl)logEl.innerHTML='';
  for(let i=0;i<APP.links.length;i++){
    if(APP.stopFlag)break;
    if(prog)prog.style.width=Math.round(((i+1)/APP.links.length)*100)+'%';
    setProgress(Math.round(((i+1)/APP.links.length)*100),`${i+1}/${APP.links.length}`);
    await lb_verifyOne(i);
    await sleep(400);
  }
  APP.running=false;setStatus('Done');
  const live=APP.links.filter(l=>l.verified===true).length;
  log(`Verification complete: ${live}/${APP.links.length} live`,'ok');
  render_link_builder(document.getElementById('page-link_builder'));
}

async function lb_verifyPending(){
  const pending=APP.links.filter(l=>l.verified===undefined);
  if(!pending.length){log('No unverified links','warn');return;}
  APP.running=true;APP.stopFlag=false;setStatus('Verifying pending links...');
  const logEl=document.getElementById('lb-ver-log');
  if(logEl)logEl.innerHTML='';
  for(let i=0;i<APP.links.length;i++){
    if(APP.stopFlag)break;
    if(APP.links[i].verified===undefined) await lb_verifyOne(i);
    await sleep(400);
  }
  APP.running=false;setStatus('Done');
  log(`Pending verification done`,'ok');
  render_link_builder(document.getElementById('page-link_builder'));
}

function lb_openPublish(idx){
  const l=APP.links[idx];
  if(!l)return;
  const p=PLAT_DB.find(x=>x.type===l.platform);
  if(p?.publishUrl) window.open(p.publishUrl,'_blank');
  else window.open(l.url,'_blank');
}

function lb_gapAnalysis(){
  const raw=(document.getElementById('lb-comp-domains')||{value:''}).value.trim();
  if(!raw){log('Enter competitor domains','err');return;}
  const competitors=raw.split('\n').map(d=>d.trim()).filter(Boolean);
  const myPlatforms=new Set(APP.links.map(l=>l.platform));

  // Simulate: assign random platforms to competitors (in real use, integrate with Ahrefs/SEMrush API)
  const results=document.getElementById('lb-gap-results');
  if(!results)return;

  const compPlatformMap={};
  competitors.forEach(comp=>{
    // Simulate competitor platform presence
    const compPlats=PLAT_DB.filter(()=>Math.random()>0.4).map(p=>p.type);
    compPlatformMap[comp]=compPlats;
  });

  // Find platforms competitors use that we don't
  const allCompPlats=new Set(Object.values(compPlatformMap).flat());
  const gaps=[...allCompPlats].filter(p=>!myPlatforms.has(p));
  const overlap=[...allCompPlats].filter(p=>myPlatforms.has(p));

  results.innerHTML=`
  <div class="notice ni-y" style="margin-bottom:8px">âš  Simulated data shown. Connect Ahrefs/SEMrush API for real competitor backlink data.</div>
  <div class="g2">
    <div>
      <div class="panel-head" style="margin-bottom:6px;color:var(--red)">ğŸ•³ Gap â€” Competitors have, you don't (${gaps.length})</div>
      ${gaps.map(p=>`
        <div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #1e1e1e;font-size:10px">
          <span style="flex:1;color:var(--text2)">${p}</span>
          <span style="color:var(--text3)">DA${PLAT_DB.find(x=>x.type===p)?.da||'?'}</span>
          <button class="tbtn go" style="font-size:9px;padding:1px 6px" onclick="document.getElementById('lb-url')&&(document.getElementById('lb-url').value||'')&&lb_quickBuild('${p}')">+ Build</button>
        </div>
      `).join('')||'<div style="color:var(--text3);font-size:10px">No gaps found â€” you\'re on all their platforms.</div>'}
    </div>
    <div>
      <div class="panel-head" style="margin-bottom:6px;color:var(--green)">âœ“ Overlap â€” You both use (${overlap.length})</div>
      ${overlap.map(p=>`
        <div style="padding:4px 0;border-bottom:1px solid #1e1e1e;font-size:10px;color:var(--text3)">${p}</div>
      `).join('')||'<div style="color:var(--text3);font-size:10px">No overlap.</div>'}
    </div>
  </div>`;
  log(`Gap analysis complete â€” ${gaps.length} platform gaps vs ${competitors.length} competitors`,'ok');
}

function lb_quickBuild(platformType){
  // Quick-build on a specific platform
  const url=(document.getElementById('lb-url')||{value:''}).value.trim();
  if(!url){log('Set Money URL first','err');return;}
  const p=PLAT_DB.find(x=>x.type===platformType);
  if(!p)return;
  const anchor=(document.getElementById('lb-anchor')||{value:'click here'}).value.trim()||'click here';
  const slug=anchor.toLowerCase().replace(/\s+/g,'-')+'-'+rand(100,9999);
  const lurl=`https://${p.domain}/${slug}`;
  APP.links.push({url:lurl,da:p.da,anchor,type:'Brand',platform:p.type,platType:p.platType,tier:'1',status:'pending',date:today()});
  SS.set('rf_links',APP.links);
  log(`Quick-build: ${p.type} â†’ ${lurl.slice(0,50)}`,'ok');
  render_link_builder(document.getElementById('page-link_builder'));
}

function lb_guestPostQueries(){
  const niche=(document.getElementById('lb-gp-niche')||{value:''}).value.trim();
  if(!niche){log('Enter a niche','err');return;}
  const minDa=parseInt((document.getElementById('lb-gp-da')||{value:40}).value)||40;
  const queries=[
    `"${niche}" "write for us"`,
    `"${niche}" "guest post" "submit"`,
    `"${niche}" "contribute" "guest article"`,
    `"${niche}" "become a contributor"`,
    `"${niche}" intitle:"write for us"`,
    `"${niche}" "accepting guest posts"`,
    `"${niche}" "guest post guidelines"`,
    `"${niche}" "submit a guest post"`,
    `"${niche}" inurl:write-for-us`,
    `"${niche}" inurl:guest-post`,
    `"${niche}" "contributor guidelines"`,
    `site:${niche.split(' ')[0].toLowerCase().replace(/\s+/,'')+'.com'} "write for us"`,
  ];
  const res=document.getElementById('lb-gp-results');
  if(!res)return;
  res.innerHTML=`
  <div class="panel-head" style="margin-bottom:6px">ğŸ” ${queries.length} Guest Post Queries for "${esc(niche)}"
    <div class="ph-r"><button class="tbtn" onclick="navigator.clipboard.writeText(document.getElementById('lb-gp-raw').value).then(()=>log('Copied','ok'))" style="font-size:10px">ğŸ“‹ Copy All</button>
    <button class="tbtn go" onclick="switchPage('serp_scraper')" style="font-size:10px">â†’ SERP Scraper</button></div>
  </div>
  <textarea id="lb-gp-raw" rows="10" style="width:100%;font-family:var(--mono);font-size:10px;background:#0a0a0a;border:1px solid var(--win-border);color:var(--text);padding:6px;border-radius:2px">${queries.join('\n')}</textarea>
  <div class="notice ni-b" style="margin-top:6px">Copy these into SERP Scraper to find real "write for us" pages. Filter by DA â‰¥ ${minDa} using DA/PA Checker.</div>`;
  log(`Generated ${queries.length} guest post queries for "${niche}"`,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT GENERATOR v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Content template library
const CG_TEMPLATES = {
  'Expert Review':    { icon:'â­', desc:'Full review with pros/cons, verdict, rating, comparison table' },
  'Listicle':         { icon:'ğŸ“‹', desc:'Top N list with intros per item, FAQ, TL;DR' },
  'How-To Guide':     { icon:'ğŸ”§', desc:'Step-by-step with numbered steps, tips, FAQ, schema' },
  'Comparison':       { icon:'âš–', desc:'Head-to-head table, criteria breakdown, verdict, featured snippet optimised' },
  'Community Discussion':{ icon:'ğŸ’¬', desc:'Reddit/forum style â€” casual, opinionated, community-aware' },
  'Product Roundup':  { icon:'ğŸ›', desc:'Best-of list with quick specs, affiliate-friendly format' },
};

// Readability scoring (Flesch-Kincaid approximation)
function cg_readability(text){
  const sentences=(text.match(/[.!?]+/g)||[]).length||1;
  const words=(text.match(/\b\w+\b/g)||[]).length||1;
  const syllables=(text.match(/[aeiouy]+/gi)||[]).length||1;
  const fk=206.835-(1.015*(words/sentences))-(84.6*(syllables/words));
  const score=Math.max(0,Math.min(100,Math.round(fk)));
  let grade,color;
  if(score>=80){grade='Very Easy';color='var(--green)';}
  else if(score>=70){grade='Easy';color='var(--green)';}
  else if(score>=60){grade='Standard';color='var(--yellow)';}
  else if(score>=50){grade='Fairly Difficult';color='var(--yellow)';}
  else{grade='Difficult';color='var(--red)';}
  return{score,grade,color,words,sentences};
}

// LSI keyword injector
function cg_injectLSI(content, lsiKws){
  if(!lsiKws||!lsiKws.length) return content;
  const paragraphs=content.split('\n\n');
  const step=Math.max(1,Math.floor(paragraphs.length/lsiKws.length));
  lsiKws.forEach((kw,i)=>{
    const idx=Math.min(i*step+1, paragraphs.length-1);
    if(paragraphs[idx]&&!paragraphs[idx].startsWith('#')&&!paragraphs[idx].startsWith('|')){
      // Find a good insertion point â€” add naturally at end of sentence
      paragraphs[idx]=paragraphs[idx].replace(/\.\s/,(m)=>`. In particular, ${kw} is worth understanding closely. `);
    }
  });
  return paragraphs.join('\n\n');
}

// FAQ block generator
function cg_faqBlock(kw, secondaryKws=[]){
  const kws=[kw,...secondaryKws.slice(0,2)];
  return`## Frequently Asked Questions\n\n`+kws.flatMap((k,i)=>[
    `**Q: What is ${k}?**\n\nA: ${k.charAt(0).toUpperCase()+k.slice(1)} is a key concept in this space. It refers to the approach, method, or tool that helps users achieve a specific, measurable outcome in the most efficient way possible.\n`,
    i===0?`**Q: Is ${k} worth it in ${new Date().getFullYear()}?**\n\nA: Yes â€” particularly for users who prioritise quality, reliability, and long-term value. The market has matured and the best options offer significantly better ROI than they did 12-24 months ago.\n`:'',
    i===0?`**Q: What should I look for when choosing ${k}?**\n\nA: Focus on three things: (1) track record and user reviews, (2) quality of ongoing updates and support, and (3) total cost of ownership â€” not just the upfront price.\n`:'',
  ]).filter(Boolean).join('\n');
}

// Schema markup generator
function cg_schemaMarkup(type, data={}){
  const base={'@context':'https://schema.org'};
  if(type==='Article'){
    return JSON.stringify({...base,'@type':'Article',headline:data.title||'Article',author:{...base,'@type':'Person',name:data.author||'Editorial Team'},datePublished:new Date().toISOString().slice(0,10),description:data.desc||''},null,2);
  }
  if(type==='FAQ'){
    return JSON.stringify({...base,'@type':'FAQPage',mainEntity:(data.faqs||[]).map(f=>({'@type':'Question',name:f.q,acceptedAnswer:{'@type':'Answer',text:f.a}}))},null,2);
  }
  if(type==='HowTo'){
    return JSON.stringify({...base,'@type':'HowTo',name:data.title||'How To Guide',step:(data.steps||['Step 1','Step 2']).map((s,i)=>({'@type':'HowToStep',position:i+1,name:s}))},null,2);
  }
  if(type==='Review'){
    return JSON.stringify({...base,'@type':'Review',itemReviewed:{...base,'@type':'Product',name:data.product||data.title||'Product'},reviewRating:{...base,'@type':'Rating',ratingValue:data.rating||'4.5',bestRating:'5'},author:{...base,'@type':'Person',name:data.author||'Editorial Team'},datePublished:new Date().toISOString().slice(0,10)},null,2);
  }
  return '{}';
}

// Content tab state
let _cgTab = 'single'; // 'single' | 'bulk' | 'brief' | 'update' | 'schema'
let _cgBulkResults = [];

function render_content_gen(el){
  const hasKey=!!SS.raw('rf_claude_key');
  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;flex-wrap:wrap">
    ${[['single','âœ Single'],['bulk','ğŸ“¦ Bulk'],['brief','ğŸ“ Brief'],['update','ğŸ”„ Refresh'],['schema','ğŸ· Schema']].map(([t,l])=>`
    <div onclick="_cgTab='${t}';render_content_gen(document.getElementById('page-content_gen'))"
      style="padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;
      background:${_cgTab===t?'var(--win-panel2)':'transparent'};border:1px solid ${_cgTab===t?'var(--win-border)':'transparent'};
      border-bottom-color:${_cgTab===t?'var(--win-panel2)':'transparent'};color:${_cgTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      ${hasKey?'<span class="badge bg">Claude AI âœ“</span>':'<span class="badge br">No API Key</span>'}
    </div>
  </div>

  ${!hasKey?`<div class="notice ni-r" style="margin-bottom:8px">âš  Claude API key required. <a href="#" onclick="switchPage('settings')">Add it in Settings â†’</a></div>`:''}

  ${_cgTab==='single'?`
  <!-- â•â•â• SINGLE GENERATION â•â•â• -->
  <div class="g2">
    <div class="panel">
      <div class="panel-head">âœ Content Generator v2 <span class="badge bg">v2</span></div>
      <div class="panel-body">
        <div class="g2">
          <div class="fg"><label class="lbl">Primary Keyword</label><input type="text" id="cg-kw" placeholder="best VPN 2025"/></div>
          <div class="fg"><label class="lbl">Money URL (will be naturally linked)</label><input type="url" id="cg-url" placeholder="https://yoursite.com"/></div>
        </div>
        <div class="fg"><label class="lbl">Secondary / LSI Keywords (comma separated)</label><input type="text" id="cg-kws" placeholder="cheap VPN, secure VPN, no-log VPN, privacy tool, fast VPN"/></div>
        <div class="fg"><label class="lbl">Internal Links to Suggest (comma separated URLs on your site)</label><input type="text" id="cg-internal" placeholder="https://yoursite.com/vpn-guide, https://yoursite.com/reviews"/></div>
        <div class="g4">
          <div class="fg"><label class="lbl">Template</label>
            <select id="cg-fmt">${Object.entries(CG_TEMPLATES).map(([k,v])=>`<option value="${k}">${v.icon} ${k}</option>`).join('')}</select></div>
          <div class="fg"><label class="lbl">Length</label>
            <select id="cg-len"><option value="short">Short (400w)</option><option value="medium" selected>Medium (900w)</option><option value="long">Long (1800w)</option><option value="xl">XL (3000w)</option></select></div>
          <div class="fg"><label class="lbl">Language</label>
            <select id="cg-lang"><option value="English">English</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option><option value="Portuguese">Portuguese</option><option value="Italian">Italian</option><option value="Dutch">Dutch</option><option value="Polish">Polish</option></select></div>
          <div class="fg"><label class="lbl">Platform Format</label>
            <select id="cg-platform"><option value="Blog Post">Blog Post (Markdown)</option><option value="GitHub README">GitHub README</option><option value="Medium Article">Medium Article</option><option value="Reddit Post">Reddit Post</option><option value="LinkedIn Article">LinkedIn Article</option><option value="Dev.to Post">Dev.to Post</option></select></div>
        </div>
        <div style="display:flex;align-items:center;gap:14px;margin:8px 0 4px;flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-tldr" checked style="width:auto;accent-color:var(--green)"><span>Include TL;DR at top</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-faq" checked style="width:auto;accent-color:var(--green)"><span>Add FAQ section (PAA targeting)</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-eeat" checked style="width:auto;accent-color:var(--green)"><span>E-E-A-T signals (author bio, date, citations)</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-lsi" checked style="width:auto;accent-color:var(--green)"><span>Inject LSI keywords naturally</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-table" style="width:auto;accent-color:var(--green)"><span>Comparison table (featured snippet)</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-meta" checked style="width:auto;accent-color:var(--green)"><span>Separate meta description</span></label>
        </div>
        <div class="fg" style="margin-top:4px"><label class="lbl">Author Name (for E-E-A-T bio)</label><input type="text" id="cg-author" placeholder="Sarah Mitchell, SEO Analyst" value="${SS.raw('rf_cg_author','')}"/></div>
        <div class="fg"><label class="lbl">CopyScape API Key (optional â€” for plagiarism check)</label><input type="password" id="cg-copyscape" value="${SS.raw('rf_copyscape_key','')}" placeholder="cskey-..."/></div>
        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="start_content_gen()">âœ¨ Generate with Claude AI</button>
          <button class="tbtn" onclick="cg_genBrief()">ğŸ“ Brief Only</button>
        </div>
        <div class="prog-wrap"><div class="prog-fill" id="cg-prog"></div></div>
      </div>
    </div>

    <!-- Output panel -->
    <div class="panel" id="cg-out-panel" style="display:none">
      <div class="panel-head">ğŸ“„ Output
        <div class="ph-r">
          <span id="cg-readability-badge" style="font-family:var(--mono);font-size:9px;padding:2px 6px;background:var(--win-panel3);border:1px solid var(--win-border);border-radius:2px;margin-right:4px"></span>
          <button class="tbtn" style="font-size:10px" onclick="cg_copy()">ğŸ“‹ Copy</button>
          <button class="tbtn" onclick="cg_exportTxt()" style="font-size:10px">ğŸ“¥ TXT</button>
          <button class="tbtn go" style="font-size:10px" onclick="switchPage('link_builder')">â–¶ Deploy</button>
        </div>
      </div>
      <div class="panel-body" style="padding:6px">
        <div id="cg-meta-box" style="display:none;margin-bottom:6px">
          <label class="lbl">Meta Description (separate from intro)</label>
          <textarea id="cg-meta-ta" rows="2" style="width:100%;font-family:var(--mono);font-size:10px;background:#0a0a0a;border:1px solid var(--win-border);color:var(--text);padding:6px;border-radius:2px"></textarea>
        </div>
        <textarea id="cg-content" rows="24" style="width:100%;font-family:var(--mono);font-size:10px;line-height:1.6;background:#0a0a0a;border:1px solid var(--win-border);border-radius:2px;padding:8px;color:var(--text)" oninput="cg_liveReadability()"></textarea>
        <div id="cg-copyscape-result" style="display:none;margin-top:4px"></div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="tbtn" onclick="cg_checkCopyscape()" style="font-size:10px">ğŸ” CopyScape Check</button>
          <button class="tbtn" onclick="cg_exportMeta()" style="font-size:10px">ğŸ“¥ Export Meta</button>
        </div>
      </div>
    </div>
  </div>
  `:''}

  ${_cgTab==='bulk'?`
  <!-- â•â•â• BULK GENERATION â•â•â• -->
  <div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ“¦ Bulk Content Generator</div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:8px">Generate N articles from a keyword list. Each article uses the same template and money URL, with the keyword as the primary focus.</div>
        <div class="fg"><label class="lbl">Keywords (one per line)</label>
          <textarea id="cg-bulk-kws" rows="8" placeholder="best VPN 2025&#10;cheap VPN no logs&#10;VPN for streaming&#10;fastest VPN service"></textarea></div>
        <div class="g3">
          <div class="fg"><label class="lbl">Money URL</label><input type="url" id="cg-bulk-url" placeholder="https://yoursite.com"/></div>
          <div class="fg"><label class="lbl">Template</label>
            <select id="cg-bulk-fmt">${Object.entries(CG_TEMPLATES).map(([k,v])=>`<option>${v.icon} ${k}</option>`).join('')}</select></div>
          <div class="fg"><label class="lbl">Length</label>
            <select id="cg-bulk-len"><option value="short">Short (400w)</option><option value="medium" selected>Medium (900w)</option><option value="long">Long (1800w)</option></select></div>
        </div>
        <div class="g2">
          <div class="fg"><label class="lbl">Language</label>
            <select id="cg-bulk-lang"><option value="English">English</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
          <div class="fg"><label class="lbl">Delay between articles (ms)</label><input type="number" id="cg-bulk-delay" value="2000" min="500" max="10000"/></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;margin:6px 0">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-bulk-tldr" checked style="width:auto;accent-color:var(--green)"><span>TL;DR</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-bulk-faq" checked style="width:auto;accent-color:var(--green)"><span>FAQ</span></label>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px"><input type="checkbox" id="cg-bulk-eeat" style="width:auto;accent-color:var(--green)"><span>E-E-A-T</span></label>
        </div>
        <div class="flex g6 mt6">
          <button class="tbtn go" onclick="start_content_gen_bulk()">ğŸ“¦ Generate All</button>
          <button class="tbtn" id="cg-bulk-export-btn" style="display:none" onclick="cg_exportBulk()">ğŸ“¥ Export All TXT</button>
        </div>
        <div class="prog-wrap"><div class="prog-fill" id="cg-bulk-prog"></div></div>
        <div id="cg-bulk-status" style="font-family:var(--mono);font-size:10px;color:var(--text3);margin-top:4px"></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ“‹ Bulk Results <span class="badge bg" id="cg-bulk-count">0</span></div>
      <div id="cg-bulk-results" style="max-height:500px;overflow-y:auto;padding:6px"></div>
    </div>
  </div>
  `:''}

  ${_cgTab==='brief'?`
  <!-- â•â•â• CONTENT BRIEF BUILDER â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ“ Content Brief Builder</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Generate a structured content brief with H1/H2 structure, word count targets, keyword density targets, and PAA questions.</div>
      <div class="g3">
        <div class="fg"><label class="lbl">Primary Keyword</label><input type="text" id="cg-brief-kw" placeholder="best VPN 2025"/></div>
        <div class="fg"><label class="lbl">Secondary Keywords (comma sep.)</label><input type="text" id="cg-brief-kws" placeholder="cheap VPN, secure VPN..."/></div>
        <div class="fg"><label class="lbl">Target Word Count</label><input type="number" id="cg-brief-wc" value="1500" min="300" max="5000"/></div>
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">Content Type</label>
          <select id="cg-brief-type">${Object.keys(CG_TEMPLATES).map(k=>`<option>${k}</option>`).join('')}</select></div>
        <div class="fg"><label class="lbl">Target Keyword Density %</label><input type="number" id="cg-brief-density" value="1.5" min="0.5" max="5" step="0.1"/></div>
        <div class="fg"><label class="lbl">Competitor URLs to Beat (one per line)</label><input type="text" id="cg-brief-comps" placeholder="https://competitor.com/article"/></div>
      </div>
      <button class="tbtn go mt6" onclick="cg_buildBrief()">ğŸ“ Generate Brief</button>
      <div id="cg-brief-out" style="margin-top:10px"></div>
    </div>
  </div>
  `:''}

  ${_cgTab==='update'?`
  <!-- â•â•â• CONTENT FRESHNESS UPDATER â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ”„ Content Freshness Updater</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Takes existing content and appends a new "Updated for ${new Date().getFullYear()}" section with fresh information, updated stats, and new FAQ questions targeting PAA boxes.</div>
      <div class="fg"><label class="lbl">Paste Existing Article</label>
        <textarea id="cg-old-content" rows="10" placeholder="Paste your existing article here..."></textarea></div>
      <div class="g3" style="margin-top:6px">
        <div class="fg"><label class="lbl">Primary Keyword</label><input type="text" id="cg-upd-kw" placeholder="best VPN 2025"/></div>
        <div class="fg"><label class="lbl">What's new to add</label><input type="text" id="cg-upd-new" placeholder="New pricing, new features, recent studies..."/></div>
        <div class="fg"><label class="lbl">Update Type</label>
          <select id="cg-upd-type"><option>New Section at Bottom</option><option>Update Stats/Numbers</option><option>Add New FAQ</option><option>Full Refresh</option></select></div>
      </div>
      <button class="tbtn go mt6" onclick="cg_freshenContent()">ğŸ”„ Freshen Content</button>
      <div id="cg-upd-out" style="margin-top:10px;display:none" class="panel">
        <div class="panel-head">Updated Content <div class="ph-r"><button class="tbtn" onclick="navigator.clipboard.writeText(document.getElementById('cg-upd-ta').value).then(()=>log('Copied','ok'))" style="font-size:10px">ğŸ“‹ Copy</button></div></div>
        <div class="panel-body" style="padding:6px"><textarea id="cg-upd-ta" rows="18" style="width:100%;font-family:var(--mono);font-size:10px;background:#0a0a0a;border:1px solid var(--win-border);color:var(--text);padding:8px;border-radius:2px"></textarea></div>
      </div>
    </div>
  </div>
  `:''}

  ${_cgTab==='schema'?`
  <!-- â•â•â• SCHEMA GENERATOR â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ· Schema Markup Generator (JSON-LD)</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Generate valid JSON-LD schema for Article, FAQ, HowTo, or Review. Paste directly into your &lt;head&gt; or before &lt;/body&gt;.</div>
      <div class="g3">
        <div class="fg"><label class="lbl">Schema Type</label>
          <select id="cg-schema-type" onchange="cg_renderSchemaForm()">
            <option value="Article">Article</option><option value="FAQ">FAQ Page</option>
            <option value="HowTo">How-To</option><option value="Review">Review</option>
          </select></div>
        <div class="fg"><label class="lbl">Title / Headline</label><input type="text" id="cg-schema-title" placeholder="Best VPN 2025 â€” Expert Review"/></div>
        <div class="fg"><label class="lbl">Author Name</label><input type="text" id="cg-schema-author" placeholder="Sarah Mitchell" value="${SS.raw('rf_cg_author','')}"/></div>
      </div>
      <div id="cg-schema-extra" style="margin-top:6px"></div>
      <button class="tbtn go mt6" onclick="cg_generateSchema()">ğŸ· Generate Schema</button>
      <div id="cg-schema-out" style="display:none;margin-top:10px" class="panel">
        <div class="panel-head">JSON-LD Schema <div class="ph-r"><button class="tbtn" onclick="navigator.clipboard.writeText(document.getElementById('cg-schema-ta').value).then(()=>log('Schema copied','ok'))" style="font-size:10px">ğŸ“‹ Copy</button></div></div>
        <div class="panel-body" style="padding:6px"><textarea id="cg-schema-ta" rows="14" style="width:100%;font-family:var(--mono);font-size:10px;background:#0a0a0a;border:1px solid var(--win-border);color:var(--text);padding:8px;border-radius:2px"></textarea></div>
      </div>
    </div>
  </div>
  `:''}
  `;

  if(_cgTab==='schema') cg_renderSchemaForm();
}

// â”€â”€â”€ Single generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start_content_gen(){
  const kw=(document.getElementById('cg-kw')||{value:'keyword'}).value.trim()||'keyword';
  const kws=(document.getElementById('cg-kws')||{value:''}).value.trim();
  const moneyUrl=(document.getElementById('cg-url')||{value:''}).value.trim();
  const internalLinks=(document.getElementById('cg-internal')||{value:''}).value.trim();
  const fmt=(document.getElementById('cg-fmt')||{value:'Expert Review'}).value.replace(/^[^\s]+ /,''); // strip emoji
  const len=(document.getElementById('cg-len')||{value:'medium'}).value;
  const lang=(document.getElementById('cg-lang')||{value:'English'}).value;
  const platform=(document.getElementById('cg-platform')||{value:'Blog Post'}).value;
  const incTldr=(document.getElementById('cg-tldr')||{checked:true}).checked;
  const incFaq=(document.getElementById('cg-faq')||{checked:true}).checked;
  const incEeat=(document.getElementById('cg-eeat')||{checked:true}).checked;
  const incLsi=(document.getElementById('cg-lsi')||{checked:true}).checked;
  const incTable=(document.getElementById('cg-table')||{checked:false}).checked;
  const incMeta=(document.getElementById('cg-meta')||{checked:true}).checked;
  const author=(document.getElementById('cg-author')||{value:''}).value.trim();
  const csKey=(document.getElementById('cg-copyscape')||{value:''}).value.trim();
  if(author) SS.rawSet('rf_cg_author',author);
  if(csKey)  SS.rawSet('rf_copyscape_key',csKey);

  const claudeKey=SS.raw('rf_claude_key');
  const wordCount=len==='short'?400:len==='long'?1800:len==='xl'?3000:900;
  const prog=document.getElementById('cg-prog');
  if(prog)prog.style.width='5%';
  APP.running=true; APP.stopFlag=false; setStatus('Generating content...');
  log(`Generating ${lang} ${fmt} (${wordCount}w) for "${kw}"...`,'info');

  const lsiKws = kws?kws.split(',').map(s=>s.trim()).filter(Boolean):[];
  const internalLinkList = internalLinks?internalLinks.split(',').map(s=>s.trim()).filter(Boolean):[];

  if(!claudeKey){
    if(prog)prog.style.width='100%';
    APP.running=false; setStatus('Idle');
    log('âš  No Claude API key â€” add it in Settings','warn');
    const yr=new Date().getFullYear();
    const fallback=`# ${kw.charAt(0).toUpperCase()+kw.slice(1)} â€” ${fmt} (${yr})\n\n> TL;DR: Add your Claude API key in Settings â†’ API Keys to generate real AI content via claude-sonnet-4-6.\n\nGet your key: https://console.anthropic.com`;
    const ta=document.getElementById('cg-content'); const out=document.getElementById('cg-out-panel');
    if(ta)ta.value=fallback; if(out)out.style.display='block';
    return;
  }

  const tldrInstr = incTldr?`Start with a "TL;DR:" one-sentence summary in bold on the very first line before anything else.`:'';
  const faqInstr = incFaq?`Include a "## Frequently Asked Questions" section targeting People Also Ask questions for "${kw}". Include 4-6 Q&A pairs.`:'';
  const eeatInstr = incEeat?`Include: (1) an author bio blurb (2-3 sentences about ${author||'a subject matter expert'}), (2) "Last updated: ${new Date().toLocaleDateString()}", (3) at least one citation/reference to a credible source.`:'';
  const tableInstr = incTable?`Include a comparison table with at least 3 columns (Option, Pros, Score) to increase featured snippet eligibility.`:'';
  const lsiInstr = incLsi&&lsiKws.length?`Naturally incorporate these LSI/secondary keywords throughout the body (not just headings): ${lsiKws.join(', ')}. Space them out â€” don't cluster them.`:'';
  const internalInstr = internalLinkList.length?`Suggest 2-3 internal links using these URLs: ${internalLinkList.join(', ')} â€” place them naturally in the text.`:'';
  const moneyInstr = moneyUrl?`Naturally include a reference to ${moneyUrl} as the primary recommended resource â€” do not make it feel like an ad.`:'';
  const metaInstr = incMeta?`AFTER the main article, on a new line, write "META_DESC:" followed by a unique meta description (150-160 chars) that is different from the article intro.`:'';

  const prompt=`Write a ${wordCount}-word ${lang} ${fmt} formatted as a "${platform}" about "${kw}".

${tldrInstr}
${lsiInstr}
${faqInstr}
${tableInstr}
${eeatInstr}
${internalInstr}
${moneyInstr}
${metaInstr}

Format rules:
- Use Markdown (##, ###, bullet lists, bold for key terms)
- For comparison format: include a proper Markdown table
- Write in a human, natural style â€” no AI-sounding filler phrases
- Real depth: include specific details, numbers, examples
- Output ONLY the content â€” no preamble like "here is your article"`;

  try{
    for(let i=5;i<=85;i+=5){if(APP.stopFlag)break;if(prog)prog.style.width=i+'%';await sleep(100);}
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'x-api-key':claudeKey,'anthropic-version':'2023-06-01','Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-6',max_tokens:6000,messages:[{role:'user',content:prompt}]}),
      signal:AbortSignal.timeout(90000)
    });
    if(!resp.ok){const err=await resp.json();throw new Error(err.error?.message||`API error ${resp.status}`);}
    const data=await resp.json();
    let content=(data.content||[])[0]?.text||'No content returned';
    if(prog)prog.style.width='100%';

    // Extract and display meta separately
    let metaDesc='';
    if(incMeta && content.includes('META_DESC:')){
      const parts=content.split('META_DESC:');
      content=parts[0].trim();
      metaDesc=parts[1]?.trim()||'';
    }

    // Inject LSI if not Claude-done
    if(incLsi && lsiKws.length) content=cg_injectLSI(content, lsiKws);

    const ta=document.getElementById('cg-content');
    const out=document.getElementById('cg-out-panel');
    const metaBox=document.getElementById('cg-meta-box');
    const metaTa=document.getElementById('cg-meta-ta');
    if(ta)ta.value=content;
    if(out)out.style.display='block';
    if(metaBox)metaBox.style.display=incMeta?'block':'none';
    if(metaTa&&metaDesc)metaTa.value=metaDesc;

    // Readability
    cg_liveReadability();

    const wordCnt=content.split(/\s+/).length;
    log(`âœ… Generated: ${wordCnt} words Â· ${lang} Â· ${fmt} Â· ${platform}`,'ok');
    if(metaDesc) log(`Meta desc: "${metaDesc.slice(0,80)}..."  (${metaDesc.length} chars)`,'ok');
    APP.stats.success++;APP.stats.processed++;updateStats();
    runHistoryAdd('content_gen',1,1,0,{keyword:kw,format:fmt,words:wordCnt});

  }catch(e){
    if(prog)prog.style.width='0%';
    log(`Content gen failed: ${e.message}`,'err');
    APP.stats.failed++;APP.stats.processed++;updateStats();
  }
  APP.running=false;setStatus('Done');
}

function cg_liveReadability(){
  const ta=document.getElementById('cg-content');
  if(!ta||!ta.value) return;
  const r=cg_readability(ta.value);
  const badge=document.getElementById('cg-readability-badge');
  if(badge) badge.innerHTML=`<span style="color:${r.color}">FK: ${r.score} â€” ${r.grade}</span> Â· ${r.words}w`;
}

function cg_copy(){const ta=document.getElementById('cg-content');if(ta)navigator.clipboard.writeText(ta.value).then(()=>log('Copied','ok'));}
function cg_exportTxt(){const ta=document.getElementById('cg-content');if(ta&&ta.value)dlTxt(ta.value,'generated_content.txt');}
function cg_exportMeta(){const ta=document.getElementById('cg-meta-ta');if(ta&&ta.value)dlTxt(ta.value,'meta_description.txt');}

async function cg_checkCopyscape(){
  const csKey=SS.raw('rf_copyscape_key','');
  if(!csKey){log('Add CopyScape API key in the form above','warn');return;}
  const ta=document.getElementById('cg-content');
  if(!ta||!ta.value){log('No content to check','warn');return;}
  const res=document.getElementById('cg-copyscape-result');
  if(res){res.style.display='block';res.innerHTML='<span style="color:var(--text3)">Checking CopyScape...</span>';}
  // CopyScape API call
  try{
    const encoded=encodeURIComponent(ta.value.slice(0,2000));
    const url=`https://www.copyscape.com/api/?u=${csKey}&o=csearch&e=UTF-8&c=5&s=&t=${encoded}`;
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(15000)});
    const data=await resp.json();
    const xml=data.contents||'';
    const count=(xml.match(/<count>(\d+)<\/count>/)||[])[1]||'0';
    const html=parseInt(count)===0
      ?`<div class="notice ni-g">âœ… No plagiarism found (${count} matches)</div>`
      :`<div class="notice ni-r">âš  ${count} potential matches found â€” review before publishing</div>`;
    if(res)res.innerHTML=html;
    log(`CopyScape: ${count} matches found`,'ok');
  }catch(e){
    if(res)res.innerHTML=`<div class="notice ni-r">CopyScape check failed: ${esc(e.message)}</div>`;
    log('CopyScape check failed: '+e.message,'err');
  }
}

// â”€â”€â”€ Bulk generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start_content_gen_bulk(){
  const kws=(document.getElementById('cg-bulk-kws')||{value:''}).value.trim().split('\n').map(k=>k.trim()).filter(Boolean);
  if(!kws.length){log('Enter keywords for bulk generation','err');return;}
  const moneyUrl=(document.getElementById('cg-bulk-url')||{value:''}).value.trim();
  const fmt=(document.getElementById('cg-bulk-fmt')||{value:'Expert Review'}).value.replace(/^[^\s]+ /,'');
  const len=(document.getElementById('cg-bulk-len')||{value:'medium'}).value;
  const lang=(document.getElementById('cg-bulk-lang')||{value:'English'}).value;
  const delay=parseInt((document.getElementById('cg-bulk-delay')||{value:2000}).value)||2000;
  const incTldr=(document.getElementById('cg-bulk-tldr')||{checked:true}).checked;
  const incFaq=(document.getElementById('cg-bulk-faq')||{checked:true}).checked;
  const incEeat=(document.getElementById('cg-bulk-eeat')||{checked:false}).checked;
  const wordCount=len==='short'?400:len==='long'?1800:900;
  const claudeKey=SS.raw('rf_claude_key');
  if(!claudeKey){log('Claude API key required for bulk generation','err');return;}

  _cgBulkResults=[];
  APP.running=true;APP.stopFlag=false;setStatus('Bulk generating...');
  const prog=document.getElementById('cg-bulk-prog');
  const statusEl=document.getElementById('cg-bulk-status');
  const resultsEl=document.getElementById('cg-bulk-results');
  const countEl=document.getElementById('cg-bulk-count');
  if(resultsEl)resultsEl.innerHTML='';

  for(let i=0;i<kws.length;i++){
    if(APP.stopFlag)break;
    const kw=kws[i];
    if(statusEl)statusEl.textContent=`Generating ${i+1}/${kws.length}: "${kw}"...`;
    if(prog)prog.style.width=Math.round(((i+1)/kws.length)*100)+'%';
    setProgress(Math.round(((i+1)/kws.length)*100),`${i+1}/${kws.length}`);

    const prompt=`Write a ${wordCount}-word ${lang} ${fmt} about "${kw}".
${incTldr?'Start with a TL;DR: one-sentence summary in bold.':''}
${moneyUrl?`Naturally link to: ${moneyUrl}`:''}
${incFaq?`Include a ## FAQ section with 3 Q&A pairs targeting People Also Ask for "${kw}".`:''}
${incEeat?`Include: last updated date, brief author bio, and one credible citation.`:''}
Use Markdown. Output ONLY the article â€” no preamble.`;

    try{
      const resp=await fetch('https://api.anthropic.com/v1/messages',{
        method:'POST',
        headers:{'x-api-key':claudeKey,'anthropic-version':'2023-06-01','Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-sonnet-4-6',max_tokens:4000,messages:[{role:'user',content:prompt}]}),
        signal:AbortSignal.timeout(90000)
      });
      if(!resp.ok){const err=await resp.json();throw new Error(err.error?.message||`API ${resp.status}`);}
      const data=await resp.json();
      const content=(data.content||[])[0]?.text||'';
      const r=cg_readability(content);
      _cgBulkResults.push({kw,content,words:content.split(/\s+/).length,readability:r});

      if(resultsEl){
        const idx=_cgBulkResults.length-1;
        resultsEl.innerHTML+=`<div style="border:1px solid var(--win-border);border-radius:2px;margin-bottom:6px;background:var(--win-panel2)">
          <div style="display:flex;align-items:center;gap:8px;padding:5px 8px;border-bottom:1px solid var(--win-border)">
            <span class="badge bg">âœ“</span>
            <span style="flex:1;font-size:11px;font-weight:700">${esc(kw)}</span>
            <span style="font-family:var(--mono);font-size:9px;color:${r.color}">${r.words}w Â· FK:${r.score} ${r.grade}</span>
            <button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="navigator.clipboard.writeText(_cgBulkResults[${idx}].content).then(()=>log('Copied','ok'))">ğŸ“‹</button>
            <button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="dlTxt(_cgBulkResults[${idx}].content,'${kw.replace(/[^a-z0-9]/gi,'_')}.txt')">ğŸ’¾</button>
          </div>
          <pre style="margin:0;padding:8px;font-size:9px;font-family:var(--mono);color:var(--text3);max-height:100px;overflow:hidden;white-space:pre-wrap">${esc(content.slice(0,400))}...</pre>
        </div>`;
      }
      if(countEl) countEl.textContent=_cgBulkResults.length;
      log(`âœ“ Generated: "${kw}" (${r.words}w, FK:${r.score})`,'ok');
      APP.stats.success++;APP.stats.processed++;updateStats();
    }catch(e){
      _cgBulkResults.push({kw,content:null,error:e.message});
      if(resultsEl)resultsEl.innerHTML+=`<div style="border:1px solid var(--red);border-radius:2px;padding:5px 8px;margin-bottom:4px;background:rgba(224,82,82,.08)"><span class="badge br">âœ—</span> <span style="font-size:10px">${esc(kw)}</span> â€” <span style="font-size:10px;color:var(--red)">${esc(e.message)}</span></div>`;
      log(`âœ— Failed: "${kw}" â€” ${e.message}`,'err');
      APP.stats.failed++;APP.stats.processed++;updateStats();
    }

    if(i<kws.length-1) await sleep(delay);
  }

  APP.running=false;setStatus('Done');
  const exportBtn=document.getElementById('cg-bulk-export-btn');
  if(exportBtn)exportBtn.style.display='block';
  if(statusEl)statusEl.textContent=`âœ… Complete â€” ${_cgBulkResults.filter(r=>r.content).length}/${kws.length} generated`;
  runHistoryAdd('content_gen_bulk',kws.length,_cgBulkResults.filter(r=>r.content).length,_cgBulkResults.filter(r=>!r.content).length);
  log(`Bulk generation complete: ${_cgBulkResults.filter(r=>r.content).length}/${kws.length} articles`,'ok');
}

function cg_exportBulk(){
  if(!_cgBulkResults.length){log('No bulk results to export','warn');return;}
  const success=_cgBulkResults.filter(r=>r.content);
  const combined=success.map(r=>`${'='.repeat(60)}\nKEYWORD: ${r.kw}\nWORDS: ${r.words} | READABILITY: FK ${r.readability?.score} â€” ${r.readability?.grade}\n${'='.repeat(60)}\n\n${r.content}`).join('\n\n\n');
  dlTxt(combined,'bulk_content_'+new Date().toISOString().slice(0,10)+'.txt');
  log(`Exported ${success.length} articles`,'ok');
}

// â”€â”€â”€ Content Brief â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cg_genBrief(){
  const kw=(document.getElementById('cg-kw')||{value:''}).value.trim()||'keyword';
  const kws=(document.getElementById('cg-kws')||{value:''}).value.trim();
  const type=(document.getElementById('cg-fmt')||{value:'Expert Review'}).value.replace(/^[^\s]+ /,'');
  const len=(document.getElementById('cg-len')||{value:'medium'}).value;
  const wc=len==='short'?400:len==='long'?1800:len==='xl'?3000:900;
  _cgShowBrief(kw,kws,type,wc);
}

function cg_buildBrief(){
  const kw=(document.getElementById('cg-brief-kw')||{value:''}).value.trim();
  if(!kw){log('Enter a keyword','err');return;}
  const kws=(document.getElementById('cg-brief-kws')||{value:''}).value.trim();
  const type=(document.getElementById('cg-brief-type')||{value:'Expert Review'}).value;
  const wc=parseInt((document.getElementById('cg-brief-wc')||{value:1500}).value)||1500;
  const density=parseFloat((document.getElementById('cg-brief-density')||{value:1.5}).value)||1.5;
  const kwTarget=Math.round(wc*density/100);
  const brief=_cgShowBrief(kw,kws,type,wc,density,kwTarget);
  const el=document.getElementById('cg-brief-out');
  if(el)el.innerHTML=brief;
}

function _cgShowBrief(kw,kws,type,wc,density=1.5,kwTarget=null){
  if(!kwTarget)kwTarget=Math.round(wc*density/100);
  const lsiList=kws?kws.split(',').map(s=>s.trim()).filter(Boolean):[];
  const html=`
  <div class="panel">
    <div class="panel-head">ğŸ“ Content Brief: "${esc(kw)}"
      <div class="ph-r"><button class="tbtn" onclick="navigator.clipboard.writeText(document.getElementById('brief-export-ta').value).then(()=>log('Brief copied','ok'))" style="font-size:10px">ğŸ“‹ Copy</button></div>
    </div>
    <div class="panel-body">
      <div class="g4" style="margin-bottom:10px">
        <div class="stat"><div class="stat-v sv-b">${wc}</div><div class="stat-l">Target Words</div></div>
        <div class="stat"><div class="stat-v sv-g">${kwTarget}</div><div class="stat-l">Keyword Uses (${density}%)</div></div>
        <div class="stat"><div class="stat-v sv-p">${Math.round(wc/300)}</div><div class="stat-l">Est. H2 Sections</div></div>
        <div class="stat"><div class="stat-v sv-y">${lsiList.length}</div><div class="stat-l">LSI Keywords</div></div>
      </div>
      <div style="font-family:var(--mono);font-size:10px;line-height:1.8;color:var(--text2)">
        <div><strong style="color:var(--text)">H1:</strong> ${kw.charAt(0).toUpperCase()+kw.slice(1)} â€” ${type} (${new Date().getFullYear()})</div>
        <div><strong style="color:var(--text)">Meta:</strong> [Unique, 150-160 chars, different from intro, include "${kw}"]</div>
        <div><strong style="color:var(--text)">Intro (100-150w):</strong> Hook â†’ context â†’ TL;DR â†’ keyword density start</div>
        <div style="margin-top:6px"><strong style="color:var(--yellow)">H2 Structure (${Math.round(wc/300)} sections ~${Math.round(wc/Math.round(wc/300))}w each):</strong></div>
        ${['What is '+kw, 'Why '+kw+' matters in '+new Date().getFullYear(), 'How to choose the right '+kw, 'Top options compared', 'Expert verdict'].slice(0,Math.round(wc/300)).map((h,i)=>`<div style="padding-left:12px">H2: ${h}${i===2?` <em style="color:var(--text3)">[include comparison table here]</em>`:''}</div>`).join('')}
        <div style="padding-left:24px;color:var(--text3)">H3: [supporting subtopic per H2]</div>
        <div style="margin-top:6px"><strong style="color:var(--text)">FAQ (target PAA):</strong> 4-6 Q&A pairs</div>
        <div><strong style="color:var(--text)">E-E-A-T:</strong> Author bio Â· Last updated date Â· 1+ citations</div>
        <div><strong style="color:var(--text)">LSI to include:</strong> ${lsiList.length?lsiList.map(k=>`<span style="color:var(--cyan)">${esc(k)}</span>`).join(', '):'<em style="color:var(--text3)">Add secondary keywords to generate list</em>'}</div>
        <div><strong style="color:var(--text)">Links:</strong> 2-3 internal Â· 1-2 external (authority sources) Â· 1 money site link</div>
      </div>
      <textarea id="brief-export-ta" style="display:none"># Content Brief: ${kw}\nType: ${type}\nTarget: ${wc} words | Keyword density: ${density}% (${kwTarget} uses)\nLSI: ${lsiList.join(', ')||'none'}\n\nH1: ${kw} â€” ${type} (${new Date().getFullYear()})\nMeta: [150-160 chars unique]\nIntro: Hook â†’ context â†’ TL;DR (100-150w)\n\nH2 Sections:\n${['What is '+kw,'Why it matters','How to choose','Options compared','Expert verdict'].slice(0,Math.round(wc/300)).map((h,i)=>'H2: '+h).join('\n')}\n\nFAQ: 4-6 PAA Q&As\nE-E-A-T: author bio, date, citations\nLinks: 2-3 internal, 1-2 external, 1 money site</textarea>
    </div>
  </div>`;
  const el=document.getElementById('cg-brief-out');
  if(el)el.innerHTML=html;
  return html;
}

// â”€â”€â”€ Content freshness updater â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function cg_freshenContent(){
  const old=(document.getElementById('cg-old-content')||{value:''}).value.trim();
  if(!old){log('Paste existing article first','err');return;}
  const kw=(document.getElementById('cg-upd-kw')||{value:''}).value.trim()||'topic';
  const newInfo=(document.getElementById('cg-upd-new')||{value:''}).value.trim();
  const updType=(document.getElementById('cg-upd-type')||{value:'New Section at Bottom'}).value;
  const claudeKey=SS.raw('rf_claude_key');
  if(!claudeKey){log('Claude API key required','err');return;}
  log(`Freshening content for "${kw}"...`,'info');
  APP.running=true;APP.stopFlag=false;setStatus('Updating content...');
  const yr=new Date().getFullYear();
  const prompt=updType==='New Section at Bottom'
    ?`Here is an existing article on "${kw}":\n\n${old.slice(0,3000)}\n\n---\nTask: Write a new section titled "## Updated for ${yr}: ${newInfo||'What\'s New'}" to append to the bottom of this article. The section should add fresh information, updated statistics, and new insights. Write 200-400 words. Output ONLY the new section.`
    :updType==='Add New FAQ'
    ?`Here is an existing article on "${kw}":\n\n${old.slice(0,2000)}\n\n---\nTask: Write a new "## FAQ â€” ${yr} Update" section with 4 new Q&A pairs targeting People Also Ask questions for "${kw}" that weren't covered in the original. Output ONLY the new FAQ section.`
    :updType==='Update Stats/Numbers'
    ?`Here is an existing article on "${kw}":\n\n${old.slice(0,3000)}\n\n---\nTask: Rewrite the article updating any outdated statistics, numbers, and dates to ${yr} equivalents. Improve clarity. Keep the same structure. Output the full updated article.`
    :`Here is an existing article on "${kw}":\n\n${old.slice(0,3000)}\n\n---\nTask: Fully refresh this article for ${yr}. Update stats, rewrite the intro, add a TL;DR if missing, improve the structure, add a brief FAQ section. Keep the core information but make it feel newly written. Output the full refreshed article.`;

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'x-api-key':claudeKey,'anthropic-version':'2023-06-01','Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-6',max_tokens:4096,messages:[{role:'user',content:prompt}]}),
      signal:AbortSignal.timeout(90000)
    });
    if(!resp.ok){const err=await resp.json();throw new Error(err.error?.message||`API ${resp.status}`);}
    const data=await resp.json();
    const newContent=(data.content||[])[0]?.text||'';
    const result = (updType==='New Section at Bottom'||updType==='Add New FAQ')
      ? old+'\n\n---\n\n'+newContent
      : newContent;
    const ta=document.getElementById('cg-upd-ta');
    const out=document.getElementById('cg-upd-out');
    if(ta)ta.value=result;
    if(out)out.style.display='block';
    log(`Content updated: ${result.split(/\s+/).length} words total`,'ok');
    APP.stats.success++;APP.stats.processed++;updateStats();
  }catch(e){
    log(`Content update failed: ${e.message}`,'err');
    APP.stats.failed++;APP.stats.processed++;updateStats();
  }
  APP.running=false;setStatus('Done');
}

// â”€â”€â”€ Schema markup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cg_renderSchemaForm(){
  const type=(document.getElementById('cg-schema-type')||{value:'Article'}).value;
  const el=document.getElementById('cg-schema-extra');
  if(!el)return;
  if(type==='Article'){
    el.innerHTML=`<div class="fg"><label class="lbl">Article Description</label><input type="text" id="cg-schema-desc" placeholder="Brief description for schema..."/></div>`;
  } else if(type==='FAQ'){
    el.innerHTML=`<div class="fg"><label class="lbl">Q&A Pairs (format: Q: question | A: answer, one per line)</label><textarea id="cg-schema-faqs" rows="5" placeholder="Q: What is the best VPN? | A: Based on our research...&#10;Q: Is it worth it? | A: Yes, for most users..."></textarea></div>`;
  } else if(type==='HowTo'){
    el.innerHTML=`<div class="fg"><label class="lbl">Steps (one per line)</label><textarea id="cg-schema-steps" rows="5" placeholder="Download the software&#10;Open and run setup&#10;Configure your settings&#10;Activate your account"></textarea></div>`;
  } else if(type==='Review'){
    el.innerHTML=`<div class="g2"><div class="fg"><label class="lbl">Product/Service Name</label><input type="text" id="cg-schema-product" placeholder="Best VPN Service"/></div><div class="fg"><label class="lbl">Rating (out of 5)</label><input type="number" id="cg-schema-rating" value="4.5" min="1" max="5" step="0.1"/></div></div>`;
  }
}

function cg_generateSchema(){
  const type=(document.getElementById('cg-schema-type')||{value:'Article'}).value;
  const title=(document.getElementById('cg-schema-title')||{value:''}).value.trim();
  const author=(document.getElementById('cg-schema-author')||{value:''}).value.trim();
  let schemaData={title,author};
  if(type==='Article'){
    schemaData.desc=(document.getElementById('cg-schema-desc')||{value:''}).value.trim();
  } else if(type==='FAQ'){
    const raw=(document.getElementById('cg-schema-faqs')||{value:''}).value.trim();
    schemaData.faqs=raw.split('\n').filter(Boolean).map(line=>{
      const [q,a]=line.split('|').map(s=>s.replace(/^[QA]:\s*/,'').trim());
      return{q:q||line,a:a||''};
    });
  } else if(type==='HowTo'){
    const raw=(document.getElementById('cg-schema-steps')||{value:''}).value.trim();
    schemaData.steps=raw.split('\n').filter(Boolean);
  } else if(type==='Review'){
    schemaData.product=(document.getElementById('cg-schema-product')||{value:''}).value.trim();
    schemaData.rating=(document.getElementById('cg-schema-rating')||{value:'4.5'}).value;
  }
  const schema=cg_schemaMarkup(type,schemaData);
  const ta=document.getElementById('cg-schema-ta');
  const out=document.getElementById('cg-schema-out');
  if(ta)ta.value=`<script type="application/ld+json">\n${schema}\n<\/script>`;
  if(out)out.style.display='block';
  log(`Schema generated: ${type}`,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARTICLE SPINNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_spinner(el){
  const history = SS.get('rf_spin_history', []);
  const library = SS.get('rf_spin_library', []);
  el.innerHTML=`
  <style>
    .sp-tab-btn.sp-active { background:var(--sel-bg)!important;color:#fff!important;border-color:var(--blue)!important; }
    .sp-diff-add { background:rgba(57,211,83,.2);color:var(--green);border-radius:2px;padding:0 1px; }
    .sp-matrix td { width:22px;height:22px;text-align:center;font-size:8px;font-family:var(--mono);border:1px solid var(--win-border);cursor:default; }
    .sp-matrix th { padding:2px 4px;font-size:8px;color:var(--text3);background:var(--win-panel2); }
    .sp-coverage-bar { height:5px;background:var(--win-panel2);border-radius:3px;overflow:hidden;margin-top:3px; }
    .sp-coverage-fill { height:100%;border-radius:3px;transition:width .3s; }
  </style>

  <!-- STAT STRIP -->
  <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
    <div class="stat sv-g" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px" id="sp-stat-variants">0</div><div class="stat-l">Variants</div></div>
    <div class="stat sv-b" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px" id="sp-stat-uniq">â€”</div><div class="stat-l">Avg Unique %</div></div>
    <div class="stat sv-y" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px" id="sp-stat-flesch">â€”</div><div class="stat-l">Avg Flesch</div></div>
    <div class="stat sv-p" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px" id="sp-stat-groups">0</div><div class="stat-l">Spin Groups</div></div>
    <div class="stat sv-o" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px" id="sp-stat-combos">â€”</div><div class="stat-l">Max Combos</div></div>
    <div class="stat" style="flex:1;min-width:80px;padding:6px 10px"><div class="stat-v" style="font-size:18px" id="sp-stat-wc">â€”</div><div class="stat-l">Words</div></div>
  </div>

  <div class="panel">
    <div class="panel-head">ğŸ”„ Article Spinner v3.0 â€” Spintax Engine
      <div class="ph-r">
        ${history.length ? `<select id="sp-history-sel" onchange="sp_loadHistory(this.value)" style="font-size:10px;padding:2px 5px;background:var(--win-panel2);color:var(--text);border:1px solid var(--win-border)"><option value="">ğŸ“‚ History (${history.length})</option>${history.map((h,i)=>`<option value="${i}">${esc(h.label)}</option>`).join('')}</select>` : ''}
      </div>
    </div>
    <div class="panel-body">

      <!-- TAB BAR -->
      <div style="display:flex;gap:2px;margin-bottom:10px;border-bottom:1px solid var(--win-border2);padding-bottom:6px">
        <button class="tbtn sp-tab-btn sp-active" id="spt-0" onclick="spTab(0)">âœ Input</button>
        <button class="tbtn sp-tab-btn" id="spt-1" onclick="spTab(1)">âš™ Options</button>
        <button class="tbtn sp-tab-btn" id="spt-2" onclick="spTab(2)">ğŸ“š Library</button>
        <button class="tbtn sp-tab-btn" id="spt-3" onclick="spTab(3)">ğŸ“¦ Batch</button>
      </div>

      <!-- TAB 0: INPUT -->
      <div id="sp-panel-0">
        <div class="g2">
          <div>
            <div class="fg">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
                <label class="lbl" style="margin-bottom:0">Input (plain text or spintax)</label>
                <div style="display:flex;gap:5px;align-items:center">
                  <span id="sp-brace-ok" style="font-family:var(--mono);font-size:9px;color:var(--green);display:none">âœ“ Balanced</span>
                  <span id="sp-brace-err" style="font-family:var(--mono);font-size:9px;color:var(--red);display:none">âš  Unbalanced</span>
                  <span id="sp-live-badge" class="badge bgray" style="font-size:8px"></span>
                </div>
              </div>
              <textarea id="sp-input" rows="12" placeholder="## Heading{s|}&#10;This is a {great|fantastic|excellent} article about {SEO|search engine optimization}.&#10;&#10;Another paragraph here.&#10;&#10;Tip: Click 'Auto-Build Spintax' or 'ğŸ¤– AI Spintax' to auto-generate spintax." oninput="sp_liveAnalyze()"></textarea>
              <div style="margin-top:3px;font-size:9px;color:var(--text3);font-family:var(--mono)" id="sp-coverage-info"></div>
              <div class="sp-coverage-bar"><div class="sp-coverage-fill" id="sp-coverage-fill" style="width:0%;background:var(--green)"></div></div>
            </div>
            <div class="fg"><label class="lbl">Target Keyword (for density tracking)</label>
              <input type="text" id="sp-keyword" placeholder="e.g. VPN service, backlink building"/></div>
            <div class="fg"><label class="lbl">Protected Entities (brand names, URLs â€” one per line)</label>
              <textarea id="sp-entities" rows="3" placeholder="MyBrand&#10;https://example.com&#10;GPT-4"></textarea></div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Spintax Library â€” click chip to insert at cursor</label>
              <div id="sp-lib-chips" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;max-height:90px;overflow-y:auto;padding:4px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px">
                ${library.map((item,i)=>`<span class="chip" title="${esc(item.spintax)}" onclick="sp_insertLibraryItem(${i})">${esc(item.label)}</span>`).join('')}
                ${!library.length ? '<span class="xs tm" style="padding:4px">No library items â€” add in Library tab or click ğŸŒ± Seed Defaults</span>' : ''}
              </div>
            </div>
            <div class="fg"><label class="lbl">Bulk Upload (.txt / .spin / .spintax)</label>
              <input type="file" id="sp-file" accept=".txt,.spin,.spintax" style="font-size:10px" onchange="sp_loadFile(this)"/></div>
            <div class="fg"><label class="lbl">Target Word Count (0 = no target)</label>
              <input type="number" id="sp-target-wc" value="0" min="0" max="10000" title="Pad or trim each variant toward this word count using filler sentences"/></div>
            <div class="notice ni-b" style="font-size:10px;margin-top:4px">
              <b>Syntax:</b> {opt1|opt2|opt3} Â· Nested: {best|{top|greatest}} Â· ## for headings Â· Entities auto-protected
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 1: OPTIONS -->
      <div id="sp-panel-1" style="display:none">
        <div class="g2">
          <div>
            <div class="g2">
              <div class="fg"><label class="lbl">Output Variants</label><input type="number" id="sp-count" value="5" min="1" max="100"/></div>
              <div class="fg"><label class="lbl">Min Uniqueness %</label><input type="number" id="sp-uniq" value="25" min="0" max="100"/></div>
            </div>
            <div class="g2">
              <div class="fg"><label class="lbl">Auto-spin Level</label>
                <select id="sp-level">
                  <option value="0">Manual spintax only</option>
                  <option value="1" selected>Light (word synonyms)</option>
                  <option value="2">Heavy (words + transitions + openers)</option>
                  <option value="3">AI-assisted (Claude API)</option>
                </select>
              </div>
              <div class="fg"><label class="lbl">Length Variation (Â±words)</label>
                <input type="number" id="sp-lenvar" value="75" min="0" max="500"/></div>
            </div>
            <div class="g2">
              <div class="fg"><label class="lbl">Min Variant Words (gate)</label>
                <input type="number" id="sp-min-words" value="0" min="0" title="Reject variants shorter than this word count"/></div>
              <div class="fg"><label class="lbl">Max Attempts</label>
                <input type="number" id="sp-max-attempts" value="20" min="5" max="500"/></div>
            </div>
            <div class="fg"><label class="lbl">Uniqueness Method</label>
              <select id="sp-uniq-method">
                <option value="jaccard">Jaccard (fast â€” word-set overlap)</option>
                <option value="weighted" selected>Weighted (rare words count double)</option>
                <option value="trigram">Trigram (n-gram similarity)</option>
              </select>
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">Spinning Options</label>
              <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-reorder" checked style="width:auto;accent-color:var(--green)"><span>Paragraph reorder (keep intro paragraph locked)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-sentlevel" checked style="width:auto;accent-color:var(--green)"><span>Sentence shuffle (keep topic sentence locked per para)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-heads" checked style="width:auto;accent-color:var(--green)"><span>Spin headings (independent synonym pool)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-transitions" checked style="width:auto;accent-color:var(--green)"><span>Spin transition phrases (Furthermore / However / Thusâ€¦)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-intros" checked style="width:auto;accent-color:var(--green)"><span>Spin sentence openers (This / You can / There areâ€¦)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-flesch" checked style="width:auto;accent-color:var(--green)"><span>Flesch Reading Ease + Grade Level per variant</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-quality" checked style="width:auto;accent-color:var(--green)"><span>Quality score (trigrams, passive voice, short sentences)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-kw-density" checked style="width:auto;accent-color:var(--green)"><span>Keyword density per variant</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-show-matrix" checked style="width:auto;accent-color:var(--green)"><span>Show similarity matrix (all-pairs heatmap)</span></label>
                <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="sp-save-history" checked style="width:auto;accent-color:var(--green)"><span>Save session to history (last 5)</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: LIBRARY -->
      <div id="sp-panel-2" style="display:none">
        <div class="notice ni-b" style="font-size:10px;margin-bottom:8px">Saved spintax groups you can insert at cursor position with one click. Build a niche-specific library.</div>
        <div class="g3" style="margin-bottom:8px">
          <div class="fg"><label class="lbl">Label</label><input type="text" id="sp-lib-label" placeholder="VPN terms"/></div>
          <div class="fg"><label class="lbl">Spintax</label><input type="text" id="sp-lib-spintax" placeholder="{VPN|virtual private network|privacy tool}"/></div>
          <div style="display:flex;align-items:flex-end;gap:4px">
            <button class="tbtn go" onclick="sp_addLibraryItem()">+ Add</button>
            <button class="tbtn" onclick="sp_seedDefaultLibrary()">ğŸŒ± Defaults</button>
          </div>
        </div>
        <div class="tbl-wrap"><table>
          <thead><tr><th>Label</th><th>Spintax</th><th>Options</th><th></th></tr></thead>
          <tbody id="sp-lib-table">
            ${library.map((item,i)=>`<tr>
              <td class="xs">${esc(item.label)}</td>
              <td class="mono xs" style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(item.spintax)}">${esc(item.spintax)}</td>
              <td class="xs tm">${item.spintax.split('|').length} opts</td>
              <td><button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="sp_removeLibraryItem(${i})">âœ•</button></td>
            </tr>`).join('')}
            ${!library.length ? '<tr><td colspan="4" class="xs tm" style="text-align:center;padding:12px">No items â€” click ğŸŒ± Defaults to seed common spintax groups</td></tr>' : ''}
          </tbody>
        </table></div>
        <div style="margin-top:8px;display:flex;gap:6px">
          <button class="tbtn" onclick="sp_exportLibrary()">ğŸ“¥ Export JSON</button>
          <button class="tbtn" onclick="sp_importLibrary()">ğŸ“‚ Import JSON</button>
        </div>
      </div>

      <!-- TAB 3: BATCH -->
      <div id="sp-panel-3" style="display:none">
        <div class="notice ni-y" style="font-size:10px;margin-bottom:8px">Batch mode: paste multiple articles separated by your separator. Each is spun independently producing N variants.</div>
        <div class="fg"><label class="lbl">Batch Articles (paste multiple, separated by ===)</label>
          <textarea id="sp-batch-input" rows="10" placeholder="First article text here...&#10;===&#10;Second article text here...&#10;===&#10;Third article text here..."></textarea></div>
        <div class="g2">
          <div class="fg"><label class="lbl">Variants per Article</label><input type="number" id="sp-batch-count" value="3" min="1" max="20"/></div>
          <div class="fg"><label class="lbl">Output Format</label>
            <select id="sp-batch-fmt">
              <option value="combined">Combined (one file, all articles)</option>
              <option value="per_article">Per article (one file each)</option>
              <option value="flat">Flat list (all variants, --- separated)</option>
            </select>
          </div>
        </div>
        <div class="flex g6 mt6">
          <button class="tbtn go" onclick="sp_batchSpin()">ğŸ”„ Batch Spin</button>
          <span id="sp-batch-status" class="mono xs tm" style="align-self:center"></span>
        </div>
        <div class="prog-wrap mt6"><div class="prog-fill" id="sp-batch-prog" style="width:0%"></div></div>
      </div>

      <!-- ACTIONS -->
      <div style="border-top:1px solid var(--win-border);margin-top:10px;padding-top:8px">
        <div class="flex g6" style="flex-wrap:wrap">
          <button class="tbtn go" onclick="sp_spin()">ğŸ”„ Spin Variants</button>
          <button class="tbtn" onclick="sp_buildSpintax()">âš™ Auto-Build Spintax</button>
          <button class="tbtn" onclick="sp_aiSpintax()" id="sp-ai-btn">ğŸ¤– AI Spintax (Claude)</button>
          <button class="tbtn" onclick="sp_validateSpintax()">âœ“ Validate</button>
          <div class="tb-sep"></div>
          <button class="tbtn" onclick="sp_exportAll()">ğŸ“¥ Export All</button>
          <button class="tbtn" onclick="sp_exportOne()">ğŸ“„ Combined</button>
          <button class="tbtn" onclick="sp_exportCSV()">ğŸ“Š Scores CSV</button>
          <div class="tb-sep"></div>
          <button class="tbtn" onclick="sp_sendToContentGen()">â†’ Content Gen</button>
          <button class="tbtn" onclick="sp_sendToCommenter()">â†’ Commenter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULTS PANEL -->
  <div class="panel" id="sp-results-panel" style="display:none;margin-top:8px">
    <div class="panel-head">Variants
      <span class="badge bg" id="sp-count-badge">0</span>
      <div class="ph-r"><span class="mono xs tm" id="sp-uniq-score"></span></div>
    </div>
    <div id="sp-matrix-wrap" style="padding:8px 10px;border-bottom:1px solid var(--win-border);display:none">
      <div class="xs tm" style="margin-bottom:4px">Similarity Matrix â€” darker red = more similar, darker green = more unique</div>
      <div style="overflow-x:auto"><table class="sp-matrix" id="sp-matrix"></table></div>
    </div>
    <div class="panel-body" id="sp-output" style="padding:6px;max-height:700px;overflow-y:auto"></div>
  </div>`;

  sp_liveAnalyze();
}

// â”€â”€ TAB SWITCHER â”€â”€
function spTab(idx){
  for(let i=0;i<4;i++){
    const p=document.getElementById('sp-panel-'+i);
    const b=document.getElementById('spt-'+i);
    if(p) p.style.display = i===idx ? '' : 'none';
    if(b){ b.classList.toggle('sp-active', i===idx); }
  }
}

// â”€â”€ LIVE ANALYSIS â”€â”€
function sp_liveAnalyze(){
  const ta = document.getElementById('sp-input');
  if(!ta) return;
  const text = ta.value;

  // Brace balance
  let depth=0, unbalanced=false, maxDepth=0;
  for(const ch of text){
    if(ch==='{'){depth++;maxDepth=Math.max(maxDepth,depth);}
    else if(ch==='}'){depth--;if(depth<0){unbalanced=true;depth=0;}}
  }
  if(depth!==0) unbalanced=true;
  const hasSpintax = text.includes('{');
  const okEl=document.getElementById('sp-brace-ok');
  const errEl=document.getElementById('sp-brace-err');
  if(okEl) okEl.style.display = hasSpintax&&!unbalanced ? 'inline' : 'none';
  if(errEl) errEl.style.display = hasSpintax&&unbalanced ? 'inline' : 'none';

  // Count groups + estimate combos
  const groups = (text.match(/\{[^{}]+\}/g)||[]).length;
  const combos = sp_estimateCombos(text);
  const totalWords = text.replace(/\{[^}]*\}/g,'X').split(/\s+/).filter(Boolean).length;

  const badge = document.getElementById('sp-live-badge');
  if(badge) badge.textContent = groups>0 ? `${groups} groups Â· ~${sp_formatCombos(combos)} combos` : `${totalWords} words`;

  // Coverage
  const spinText = (text.match(/\{[^}]+\}/g)||[]).join(' ');
  const spinWords = spinText.split(/\s+/).filter(Boolean).length;
  const coverage = totalWords>0 ? Math.min(100,Math.round(spinWords/totalWords*100)) : 0;
  const fill = document.getElementById('sp-coverage-fill');
  const info = document.getElementById('sp-coverage-info');
  if(fill){ fill.style.width=coverage+'%'; fill.style.background=coverage>=20?'var(--green)':coverage>=10?'var(--yellow)':'var(--red)'; }
  if(info) info.textContent = `Coverage: ${coverage}% Â· ${groups} groups Â· depth: ${maxDepth} Â· ${totalWords} words`;

  // Stat strip
  const ge=document.getElementById('sp-stat-groups'), ce=document.getElementById('sp-stat-combos'), we=document.getElementById('sp-stat-wc');
  if(ge) ge.textContent=groups;
  if(ce) ce.textContent=sp_formatCombos(combos);
  if(we) we.textContent=totalWords;
}

function sp_estimateCombos(text){
  let combos=1;
  (text.match(/\{([^{}]+)\}/g)||[]).forEach(g=>{ const n=g.slice(1,-1).split('|').length; combos*=n; if(combos>1e12)combos=1e12; });
  return combos;
}
function sp_formatCombos(n){ if(n>=1e12)return '>1T'; if(n>=1e9)return (n/1e9).toFixed(1)+'B'; if(n>=1e6)return (n/1e6).toFixed(1)+'M'; if(n>=1e3)return (n/1e3).toFixed(1)+'K'; return String(n); }

// â”€â”€ VALIDATOR â”€â”€
function sp_validateSpintax(){
  const text=(document.getElementById('sp-input')||{value:''}).value;
  let depth=0, issues=[], line=1;
  for(let i=0;i<text.length;i++){
    if(text[i]==='\n') line++;
    if(text[i]==='{') depth++;
    else if(text[i]==='}'){depth--;if(depth<0){issues.push(`Unexpected } near line ${line}`);depth=0;}}
  }
  if(depth>0) issues.push(`${depth} unclosed { bracket(s)`);
  const groups=(text.match(/\{([^{}]+)\}/g)||[]);
  groups.filter(g=>g.includes('||')||g==='{}').forEach(g=>issues.push(`Empty option in: ${g.slice(0,30)}`));
  groups.filter(g=>!g.includes('|')).forEach(g=>issues.push(`Single option (no spin): ${g.slice(0,30)}`));
  if(!issues.length) log(`Spintax valid âœ“ â€” ${groups.length} groups found`,'ok');
  else issues.forEach(e=>log(`Spintax issue: ${e}`,'err'));
}

// â”€â”€ NESTED SPINTAX RESOLVER â”€â”€
function spintax(text){
  let result=text; let safety=0;
  while(result.includes('{')&&safety++<300){
    result=result.replace(/\{([^{}]+)\}/g,(_,inner)=>{
      const opts=inner.split('|'); return opts[rand(0,opts.length-1)];
    });
  }
  return result;
}

// â”€â”€ EXPANDED SYNONYM DICTIONARY (~200 entries) â”€â”€
const AUTO_SYNONYMS={
  'great':['excellent','fantastic','outstanding','superb','remarkable'],
  'best':['top','leading','premier','finest','optimal'],
  'good':['solid','strong','quality','reliable','capable'],
  'bad':['poor','weak','subpar','inadequate','inferior'],
  'big':['large','substantial','significant','considerable','major'],
  'small':['minor','modest','limited','compact','narrow'],
  'new':['modern','recent','latest','current','updated'],
  'fast':['quick','speedy','rapid','swift','high-speed'],
  'slow':['gradual','steady','measured','unhurried','deliberate'],
  'easy':['simple','straightforward','effortless','user-friendly','accessible'],
  'hard':['challenging','difficult','complex','demanding','tough'],
  'important':['crucial','essential','critical','vital','key'],
  'useful':['practical','valuable','beneficial','helpful','effective'],
  'powerful':['robust','capable','effective','potent','feature-rich'],
  'popular':['widely-used','well-known','mainstream','widely-adopted','common'],
  'unique':['distinctive','specialized','tailored','dedicated','specific'],
  'advanced':['sophisticated','cutting-edge','premium','professional','high-end'],
  'secure':['safe','protected','encrypted','private','anonymous'],
  'cheap':['affordable','budget-friendly','cost-effective','economical','inexpensive'],
  'use':['utilize','employ','leverage','apply','adopt'],
  'show':['demonstrate','illustrate','reveal','highlight','present'],
  'help':['assist','support','aid','enable','facilitate'],
  'get':['obtain','acquire','gain','achieve','secure'],
  'make':['create','build','develop','produce','generate'],
  'find':['discover','identify','locate','uncover','determine'],
  'need':['require','demand','call for','depend on','rely on'],
  'want':['seek','desire','look for','aim for','intend'],
  'provide':['offer','deliver','supply','give','present'],
  'include':['feature','incorporate','contain','cover','offer'],
  'allow':['enable','permit','let','support','give the ability to'],
  'improve':['enhance','boost','optimize','strengthen','upgrade'],
  'increase':['grow','expand','raise','build','amplify'],
  'reduce':['lower','decrease','minimize','cut','limit'],
  'consider':['evaluate','examine','assess','review','look at'],
  'understand':['grasp','recognize','appreciate','realize','know'],
  'ensure':['guarantee','make sure','confirm','verify','establish'],
  'focus':['concentrate','center','emphasize','prioritize','target'],
  'keep':['maintain','retain','preserve','sustain','hold'],
  'choose':['select','pick','opt for','decide on','go with'],
  'start':['begin','initiate','launch','kick off','get started with'],
  'work':['function','operate','perform','run','serve'],
  'give':['provide','offer','deliver','supply','grant'],
  'take':['employ','adopt','implement','apply','follow'],
  'know':['understand','recognize','be aware of','realize','appreciate'],
  'think':['believe','consider','feel','expect','assume'],
  'try':['attempt','aim','seek','strive','endeavor'],
  'quickly':['rapidly','swiftly','efficiently','promptly','in no time'],
  'easily':['effortlessly','simply','readily','conveniently','with ease'],
  'significantly':['considerably','substantially','notably','markedly','greatly'],
  'highly':['extremely','very','exceptionally','incredibly','remarkably'],
  'effectively':['successfully','efficiently','productively','reliably','well'],
  'generally':['typically','commonly','usually','often','in most cases'],
  'particularly':['especially','specifically','notably','in particular','above all'],
  'currently':['today','at present','now','in the current landscape','these days'],
  'often':['frequently','regularly','commonly','typically','in many cases'],
  'always':['consistently','invariably','continuously','reliably','at all times'],
  'many':['numerous','various','multiple','several','a wide range of'],
  'way':['method','approach','technique','strategy','means'],
  'option':['choice','alternative','solution','approach','possibility'],
  'result':['outcome','effect','impact','benefit','consequence'],
  'process':['approach','method','workflow','system','procedure'],
  'feature':['capability','function','tool','aspect','component'],
  'user':['person','individual','reader','visitor','customer'],
  'website':['site','web page','platform','online resource','page'],
  'content':['material','information','text','article','resource'],
  'tool':['solution','platform','application','service','software'],
  'step':['stage','phase','action','move','part'],
  'reason':['factor','cause','explanation','basis','rationale'],
  'example':['instance','case','illustration','sample','demonstration'],
  'level':['degree','extent','amount','scale','tier'],
  'point':['aspect','element','detail','factor','consideration'],
  'area':['field','domain','space','sector','region'],
  'also':['additionally','furthermore','in addition','moreover','as well'],
};

// â”€â”€ TRANSITION PHRASE PATTERNS â”€â”€
const TRANSITION_REPLACEMENTS=[
  ['Furthermore,','Furthermore,|Moreover,|In addition,|Additionally,|What\'s more,'],
  ['However,','However,|That said,|On the other hand,|Nevertheless,|Nonetheless,'],
  ['As a result,','As a result,|Therefore,|Consequently,|Thus,|For this reason,'],
  ['For example,','For example,|For instance,|As an example,|To illustrate,'],
  ['In conclusion,','In conclusion,|To sum up,|In summary,|To summarize,|Overall,'],
  ['In other words,','In other words,|Put simply,|To put it differently,|Simply put,'],
  ['It is worth noting that','It is worth noting that|Notably|It\'s important to mention that|Bear in mind that'],
  ['First,','First,|To begin with,|First and foremost,|Initially,'],
  ['Finally,','Finally,|Lastly,|Last but not least,|To wrap up,'],
  ['Additionally,','Additionally,|Furthermore,|Moreover,|Also,|In addition,'],
];

// â”€â”€ SENTENCE OPENER PATTERNS â”€â”€
const OPENER_REPLACEMENTS=[
  [/^This is /gm,    ['{This is |This particular aspect is |The fact is |It is }']],
  [/^These are /gm,  ['{These are |Such factors are |The following are }']],
  [/^You can /gm,    ['{You can |One can |It\'s possible to |Users can |People can }']],
  [/^You should /gm, ['{You should |It\'s advisable to |We recommend |Consider }']],
  [/^You need /gm,   ['{You need |It\'s necessary to |One must |You\'ll want to }']],
  [/^There are /gm,  ['{There are |You\'ll find |A number of |Several }']],
  [/^There is /gm,   ['{There is |You\'ll find a |A }']],
  [/^It is /gm,      ['{It is |This is |The fact is }']],
];

// â”€â”€ HEADING SYNONYMS â”€â”€
const HEAD_SYNONYMS={
  'guide':['tutorial','walkthrough','overview','handbook','breakdown','primer'],
  'best':['top','ultimate','leading','greatest','definitive','finest'],
  'how to':['ways to','steps to','method for','approach to','guide to'],
  'complete':['comprehensive','full','in-depth','ultimate','thorough','detailed'],
  'tips':['strategies','techniques','methods','ways','approaches','tactics'],
  'ways':['methods','strategies','approaches','techniques','options'],
  'benefits':['advantages','perks','reasons to','gains','upsides'],
};

// â”€â”€ LARGE FILLER POOL (50 sentences) â”€â”€
const FILLER_SENTENCES=[
  'This is worth considering in more detail.',
  'The implications of this extend further than many realize.',
  'Understanding this can make a real difference.',
  'Experts in the field consistently emphasize this point.',
  'With the right approach, results can exceed expectations.',
  'This factor should not be overlooked.',
  'Many users have found this to be particularly valuable.',
  'Taking this into account can significantly improve outcomes.',
  'This aspect plays a larger role than it might initially appear.',
  'A closer look at this reveals some interesting patterns.',
  'The data consistently supports this conclusion.',
  'Those who apply this insight often see measurable improvements.',
  'It is a point that frequently comes up in professional discussions.',
  'Getting this right from the start saves considerable time later.',
  'Research in this area continues to uncover new perspectives.',
  'Most practitioners agree this deserves more attention.',
  'The evidence here is quite consistent across different contexts.',
  'This principle applies broadly, not just in specific situations.',
  'Overlooking this step is one of the most common mistakes made.',
  'Addressing this early tends to produce the best long-term results.',
  'The relationship between these factors is stronger than many assume.',
  'When done correctly, this approach delivers reliable results.',
  'The nuances here matter more than a surface reading suggests.',
  'Practical experience reinforces what theory already predicts.',
  'Even small adjustments in this area can yield meaningful gains.',
  'A systematic approach to this area produces consistent returns.',
  'The distinction here is subtle but genuinely important.',
  'This remains one of the more debated topics among professionals.',
  'Following best practices here reduces risk considerably.',
  'The learning curve is shorter than most people expect.',
  'Regular attention to this detail prevents larger problems later.',
  'Many overlook this, yet it often determines the final outcome.',
  'Breaking this down into smaller parts makes it more manageable.',
  'Those with experience in this field tend to prioritize it highly.',
  'Combining this with other strategies multiplies the overall effect.',
  'The benefits here compound over time with consistent application.',
  'Starting with a clear understanding of this sets a strong foundation.',
  'The common mistakes here are avoidable with proper awareness.',
  'Context matters greatly when interpreting this point.',
  'Flexibility in approach allows for better adaptation to changing conditions.',
  'This consideration often becomes more relevant as scale increases.',
  'The difference between mediocre and excellent results often lies here.',
  'Staying informed about developments in this area pays dividends.',
  'The most effective practitioners share a consistent approach here.',
  'Both beginners and experienced professionals benefit from revisiting this.',
  'Patience and consistency are key when working through this.',
  'The payoff for getting this right is often larger than anticipated.',
  'This is one area where attention to detail truly matters.',
  'Building good habits around this leads to lasting improvements.',
  'The underlying logic here is straightforward once you examine it closely.',
];

// â”€â”€ ENTITY PROTECTION â”€â”€
function protectEntities(text, entities){
  const map={};let idx=0;
  [...entities].sort((a,b)=>b.length-a.length).forEach(e=>{
    if(!e.trim()) return;
    const ph=`__ENT${idx++}__`;
    map[ph]=e;
    const esc2=e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    text=text.replace(new RegExp(esc2,'g'),ph);
  });
  return {text,map};
}
function restoreEntities(text,map){
  Object.entries(map).forEach(([ph,val])=>{text=text.split(ph).join(val);});
  return text;
}

// â”€â”€ FLESCH READING EASE â”€â”€
function fleschScore(text){
  const sents=text.split(/[.!?]+/).filter(s=>s.trim().length>3).length||1;
  const words=text.split(/\s+/).filter(Boolean).length||1;
  const syls=text.toLowerCase().replace(/[^a-z]/g,' ').split(/\s+/).filter(Boolean)
    .reduce((s,w)=>{const m=w.match(/[aeiou]+/g);return s+(m?m.length:1);},0);
  return Math.max(0,Math.min(100,Math.round(206.835-1.015*(words/sents)-84.6*(syls/words))));
}

// â”€â”€ FLESCH-KINCAID GRADE LEVEL â”€â”€
function fleschKincaidGrade(text){
  const sents=text.split(/[.!?]+/).filter(s=>s.trim().length>3).length||1;
  const words=text.split(/\s+/).filter(Boolean).length||1;
  const syls=text.toLowerCase().replace(/[^a-z]/g,' ').split(/\s+/).filter(Boolean)
    .reduce((s,w)=>{const m=w.match(/[aeiou]+/g);return s+(m?m.length:1);},0);
  return Math.max(0,Math.round(10*(0.39*(words/sents)+11.8*(syls/words)-15.59))/10);
}

// â”€â”€ PASSIVE VOICE DETECTOR â”€â”€
function detectPassiveVoice(text){
  return (text.match(/\b(was|were|is|are|been|be|being)\s+\w+ed\b/gi)||[]).length
       + (text.match(/\b(has|have|had)\s+been\s+\w+ed\b/gi)||[]).length;
}

// â”€â”€ KEYWORD DENSITY â”€â”€
function keywordDensity(text,keyword){
  if(!keyword||!keyword.trim()) return null;
  const words=text.toLowerCase().split(/\s+/).filter(Boolean);
  const kw=keyword.toLowerCase().trim();
  const count=words.filter(w=>w.includes(kw)).length;
  return {count, density:words.length>0?Math.round(count/words.length*1000)/10:0};
}

// â”€â”€ QUALITY SCORE â”€â”€
function qualityScore(text){
  const words=text.split(/\s+/).filter(Boolean);
  let score=100;
  const sents=text.split(/[.!?]+/).filter(s=>s.trim().length>0);
  score -= sents.filter(s=>s.trim().split(/\s+/).length<4).length * 5;
  const trigrams={};
  for(let i=0;i<words.length-2;i++){
    const tg=words[i].toLowerCase()+' '+words[i+1].toLowerCase()+' '+words[i+2].toLowerCase();
    trigrams[tg]=(trigrams[tg]||0)+1;
    if(trigrams[tg]>1) score-=8;
  }
  score -= detectPassiveVoice(text)*3;
  return Math.max(0,Math.min(100,score));
}

// â”€â”€ WEIGHTED UNIQUENESS â”€â”€
function computeUniqueness(variant,allVariants,idx,method){
  if(idx===0) return 100;
  method=method||'weighted';
  const w1=variant.toLowerCase().split(/\s+/).filter(Boolean);
  const s1=new Set(w1);
  let minDiff=100;

  // Build freq map for weighted mode
  const freq={};
  if(method==='weighted'){
    allVariants.slice(0,idx).forEach(v=>v.toLowerCase().split(/\s+/).forEach(w=>{freq[w]=(freq[w]||0)+1;}));
  }

  allVariants.slice(0,idx).forEach(prev=>{
    const w2=prev.toLowerCase().split(/\s+/).filter(Boolean);
    const s2=new Set(w2);
    let sim;
    if(method==='trigram'){
      const tg1=new Set(), tg2=new Set();
      for(let i=0;i<w1.length-2;i++) tg1.add(w1[i]+' '+w1[i+1]+' '+w1[i+2]);
      for(let i=0;i<w2.length-2;i++) tg2.add(w2[i]+' '+w2[i+1]+' '+w2[i+2]);
      const shared=[...tg1].filter(t=>tg2.has(t)).length;
      sim=Math.round(shared/Math.max(1,Math.max(tg1.size,tg2.size))*100);
    } else if(method==='weighted'){
      let sw=0,tw=0;
      new Set([...s1,...s2]).forEach(w=>{
        const wt=(freq[w]||1)<=1?2:1;
        tw+=wt;
        if(s1.has(w)&&s2.has(w)) sw+=wt;
      });
      sim=Math.round(sw/Math.max(1,tw)*100);
    } else {
      const shared=[...s1].filter(w=>s2.has(w)).length;
      sim=Math.round(shared/Math.max(1,Math.max(s1.size,s2.size))*100);
    }
    if(100-sim<minDiff) minDiff=100-sim;
  });
  return minDiff;
}

// â”€â”€ SIMILARITY MATRIX â”€â”€
function buildSimilarityMatrix(variants){
  return variants.map((v1)=>variants.map(v2=>{
    const s1=new Set(v1.toLowerCase().split(/\s+/));
    const s2=new Set(v2.toLowerCase().split(/\s+/));
    const shared=[...s1].filter(w=>s2.has(w)).length;
    return Math.round(shared/Math.max(1,Math.max(s1.size,s2.size))*100);
  }));
}
function renderSimilarityMatrix(variants){
  const tbl=document.getElementById('sp-matrix');
  const wrap=document.getElementById('sp-matrix-wrap');
  if(!tbl||!wrap) return;
  const mx=buildSimilarityMatrix(variants);
  wrap.style.display='';
  tbl.innerHTML='<tr><th></th>'+variants.map((_,i)=>`<th>V${i+1}</th>`).join('')+'</tr>'+
    mx.map((row,i)=>`<tr><th>V${i+1}</th>${row.map((sim,j)=>{
      const same=i===j;
      const g=same?40:Math.round((1-sim/100)*200);
      const r=same?40:Math.round((sim/100)*200);
      return `<td style="background:rgb(${r},${g},40);color:#fff" title="V${i+1} vs V${j+1}: ${sim}% similar">${sim}</td>`;
    }).join('')}</tr>`).join('');
}

// â”€â”€ DIFF VIEW â”€â”€
function sp_showDiff(idx){
  const variants=SS.get('rf_spin_variants',[]);
  if(!variants[0]||!variants[idx]) return;
  const baseWords=variants[0].split(/\s+/);
  const baseSet=new Set(baseWords.map(w=>w.toLowerCase().replace(/[^a-z]/g,'')));
  const tgtWords=variants[idx].split(/\s+/);
  const diffHtml=tgtWords.map(w=>{
    const clean=w.toLowerCase().replace(/[^a-z]/g,'');
    return (clean.length>2&&!baseSet.has(clean)) ? `<span class="sp-diff-add">${esc(w)}</span>` : esc(w);
  }).join(' ');

  const card=document.querySelector(`[data-variant="${idx}"]`);
  if(!card) return;
  const existing=card.querySelector('.sp-diff-area');
  if(existing){existing.style.display=existing.style.display==='none'?'':'none';return;}
  const d=document.createElement('div');
  d.className='sp-diff-area';
  d.style.cssText='margin-top:6px;padding:6px;background:var(--win-bg);border:1px solid var(--win-border);border-radius:2px;font-size:11px;line-height:1.7;white-space:pre-wrap;word-break:break-word';
  d.innerHTML='<div class="xs tm" style="margin-bottom:3px">ğŸŸ¢ Words unique to this variant vs V1</div>'+diffHtml;
  card.appendChild(d);
}

// â”€â”€ INLINE EDIT â”€â”€
function sp_editVariant(idx){
  const variants=SS.get('rf_spin_variants',[]);
  const card=document.querySelector(`[data-variant="${idx}"]`);
  if(!card) return;
  const displayEl=card.querySelector('.sp-text-display');
  const existing=card.querySelector('.sp-inline-edit');
  if(existing){existing.remove();card.querySelector('.sp-edit-btns')&&card.querySelector('.sp-edit-btns').remove();if(displayEl)displayEl.style.display='';return;}
  if(displayEl) displayEl.style.display='none';
  const ta=document.createElement('textarea');
  ta.className='sp-inline-edit';
  ta.style.cssText='width:100%;font-size:11px;line-height:1.6;background:var(--win-bg);color:var(--text);border:1px solid var(--green);border-radius:2px;padding:6px;min-height:120px;font-family:var(--mono)';
  ta.value=variants[idx]||'';
  const btns=document.createElement('div');
  btns.className='sp-edit-btns flex g6';
  btns.style.marginTop='4px';
  const saveBtn=document.createElement('button');
  saveBtn.className='tbtn go';saveBtn.style='font-size:9px;padding:2px 8px';saveBtn.textContent='ğŸ’¾ Save & Re-score';
  saveBtn.onclick=()=>{
    variants[idx]=ta.value;
    SS.set('rf_spin_variants',variants);
    // Re-score
    const wc=ta.value.split(/\s+/).filter(Boolean).length;
    const fl=fleschScore(ta.value);const fk=fleschKincaidGrade(ta.value);
    const ql=qualityScore(ta.value);const pv=detectPassiveVoice(ta.value);
    const scoreEl=card.querySelector('.sp-rescore');
    if(scoreEl) scoreEl.innerHTML=`<span class="badge bgray">${wc}w</span> <span class="badge ${fl>=60?'bg':fl>=40?'by':'br'}">ğŸ“–${fl}</span> <span class="badge bgray">Gr.${fk}</span> <span class="badge ${ql>=70?'bg':ql>=50?'by':'br'}">â­${ql}</span> <span class="badge bgray">Pv:${pv}</span>`;
    if(displayEl){displayEl.style.display='';displayEl.textContent=ta.value;}
    ta.remove();btns.remove();
    log(`Variant ${idx+1} saved and re-scored`,'ok');
  };
  const cancelBtn=document.createElement('button');
  cancelBtn.className='tbtn';cancelBtn.style='font-size:9px;padding:2px 8px';cancelBtn.textContent='Cancel';
  cancelBtn.onclick=()=>{ta.remove();btns.remove();if(displayEl)displayEl.style.display='';};
  btns.appendChild(saveBtn);btns.appendChild(cancelBtn);
  card.appendChild(ta);card.appendChild(btns);
}

// â”€â”€ APPLY TRANSITIONS â”€â”€
function applyTransitionSpintax(text){
  TRANSITION_REPLACEMENTS.forEach(([phrase,opts])=>{
    const re=new RegExp(phrase.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
    text=text.replace(re,`{${opts}}`);
  });
  return text;
}
function applyOpenerSpintax(text){
  OPENER_REPLACEMENTS.forEach(([pattern,opts])=>{
    text=text.replace(pattern,opts[0]);
  });
  return text;
}

// â”€â”€ SPIN HEADING â”€â”€
function spinHeading(heading){
  let h=heading;
  Object.entries(HEAD_SYNONYMS).forEach(([word,syns])=>{
    const re=new RegExp(`\\b${word}\\b`,'gi');
    h=h.replace(re,()=>syns[rand(0,syns.length-1)]);
  });
  return h;
}

// â”€â”€ AUTO-BUILD SPINTAX â”€â”€
function sp_buildSpintax(){
  const input=(document.getElementById('sp-input')||{value:''}).value.trim();
  if(!input){log('Enter text first','err');return;}
  const entities=((document.getElementById('sp-entities')||{value:''}).value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  const doHeads=(document.getElementById('sp-heads')||{checked:true}).checked;
  const doTransitions=(document.getElementById('sp-transitions')||{checked:true}).checked;
  const doIntros=(document.getElementById('sp-intros')||{checked:true}).checked;
  const {text:prot,map:entityMap}=protectEntities(input,entities);
  let spinned=prot.split('\n').map(line=>{
    if(doHeads&&/^#{1,6}\s/.test(line)) return line;
    let l=line;
    Object.entries(AUTO_SYNONYMS).forEach(([word,syns])=>{
      const re=new RegExp(`\\b${word}\\b`,'gi');
      l=l.replace(re,`{${[word,...syns].join('|')}}`);
    });
    return l;
  }).join('\n');
  if(doTransitions) spinned=applyTransitionSpintax(spinned);
  if(doIntros) spinned=applyOpenerSpintax(spinned);
  spinned=restoreEntities(spinned,entityMap);
  const ta=document.getElementById('sp-input');
  if(ta){ta.value=spinned;sp_liveAnalyze();}
  log('Auto-spintax built â€” synonyms + transitions + openers applied','ok');
}

// â”€â”€ AI SPINTAX â”€â”€
async function sp_aiSpintax(){
  const apiKey=SS.raw('rf_claude_key');
  if(!apiKey){log('Claude API key needed â€” go to âš™ Settings â†’ API Keys','err');return;}
  const input=(document.getElementById('sp-input')||{value:''}).value.trim();
  if(!input){log('Enter text first','err');return;}
  const btn=document.getElementById('sp-ai-btn');
  if(btn){btn.disabled=true;btn.textContent='â³ Generating...';}
  const entities=((document.getElementById('sp-entities')||{value:''}).value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  log('Calling Claude API for AI spintax generation...','info');
  try {
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({model:'claude-sonnet-4-6',max_tokens:4096,messages:[{role:'user',content:`You are a professional spintax generator. Convert this article into spintax format.

Rules:
- Use {option1|option2|option3} for every sentence, phrase, and word that can vary
- Generate 2-4 alternatives per group â€” vary at word, phrase, AND full-sentence level
- Spin headings (## lines) too
- DO NOT spin: ${entities.length?entities.join(', '):'proper nouns, URLs, numbers, brand names'}
- Preserve all paragraph breaks
- Return ONLY the spintax â€” no explanation, no markdown fences

Article:
${input.slice(0,3500)}`}]})
    });
    const data=await resp.json();
    if(data.error) throw new Error(data.error.message);
    const result=data.content?.[0]?.text||'';
    if(!result) throw new Error('Empty response');
    const ta=document.getElementById('sp-input');
    if(ta){ta.value=result;sp_liveAnalyze();}
    log(`AI spintax generated (${result.split(/\s+/).length} words) â€” review and spin`,'ok');
  } catch(e){
    log(`AI spintax failed: ${e.message}`,'err');
  } finally {
    if(btn){btn.disabled=false;btn.textContent='ğŸ¤– AI Spintax (Claude)';}
  }
}

// â”€â”€ FILE LOADER â”€â”€
function sp_loadFile(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    const ta=document.getElementById('sp-input');
    if(ta){ta.value=e.target.result;sp_liveAnalyze();}
    log(`Loaded: ${file.name} (${Math.round(file.size/1024)}KB)`,'ok');
  };
  reader.readAsText(file);
}

// â”€â”€ LENGTH VARIATION â”€â”€
function varyLength(text,maxWords,targetWc){
  if(!maxWords&&!targetWc) return text;
  const paras=text.split(/\n+/);
  const currentWc=text.split(/\s+/).filter(Boolean).length;
  const needed=targetWc>0 ? targetWc-currentWc : rand(-maxWords,maxWords);
  if(targetWc>0&&currentWc<targetWc*0.6) return null; // reject if too short
  const iters=Math.max(1,Math.ceil(Math.abs(needed)/15));
  for(let k=0;k<iters;k++){
    if(needed>10){
      const bi=paras.map((_,i)=>i).filter(i=>!paras[i].startsWith('#')&&paras[i].length>20);
      if(bi.length){const t=bi[rand(0,bi.length-1)];paras[t]+=' '+FILLER_SENTENCES[rand(0,FILLER_SENTENCES.length-1)];}
    } else if(needed<-10){
      const bi=paras.map((_,i)=>i).filter(i=>!paras[i].startsWith('#')&&paras[i].split(/[.!?]/).length>2);
      if(bi.length){const t=bi[rand(0,bi.length-1)];const s=paras[t].split(/(?<=[.!?])\s+/);if(s.length>1){s.splice(rand(1,s.length-1),1);paras[t]=s.join(' ');}}
    }
  }
  return paras.join('\n\n');
}

// â”€â”€ MAIN SPIN â”€â”€
function sp_spin(){
  const input=(document.getElementById('sp-input')||{value:''}).value.trim();
  if(!input){log('Enter spintax text','err');return;}
  const count=parseInt((document.getElementById('sp-count')||{value:5}).value)||5;
  const minUniq=parseInt((document.getElementById('sp-uniq')||{value:25}).value)||25;
  const lenVar=parseInt((document.getElementById('sp-lenvar')||{value:75}).value)||0;
  const targetWc=parseInt((document.getElementById('sp-target-wc')||{value:0}).value)||0;
  const minWords=parseInt((document.getElementById('sp-min-words')||{value:0}).value)||0;
  const maxAttempts=parseInt((document.getElementById('sp-max-attempts')||{value:20}).value)||20;
  const uniqMethod=(document.getElementById('sp-uniq-method')||{value:'weighted'}).value;
  const doReorder=(document.getElementById('sp-reorder')||{checked:true}).checked;
  const doSentLevel=(document.getElementById('sp-sentlevel')||{checked:true}).checked;
  const doHeads=(document.getElementById('sp-heads')||{checked:true}).checked;
  const doTransitions=(document.getElementById('sp-transitions')||{checked:true}).checked;
  const doIntros=(document.getElementById('sp-intros')||{checked:true}).checked;
  const doFlesch=(document.getElementById('sp-flesch')||{checked:true}).checked;
  const doQuality=(document.getElementById('sp-quality')||{checked:true}).checked;
  const doKwDensity=(document.getElementById('sp-kw-density')||{checked:true}).checked;
  const doMatrix=(document.getElementById('sp-show-matrix')||{checked:true}).checked;
  const doSaveHistory=(document.getElementById('sp-save-history')||{checked:true}).checked;
  const keyword=(document.getElementById('sp-keyword')||{value:''}).value.trim();
  const entities=((document.getElementById('sp-entities')||{value:''}).value||'').split('\n').map(s=>s.trim()).filter(Boolean);

  const variants=[],scores=[],fleschs=[],fkGrades=[],qualities=[],passiveCounts=[],kwDensities=[];
  let attempts=0;

  while(variants.length<count&&attempts<maxAttempts*Math.max(count,5)){
    attempts++;
    const {text:prot,map:entityMap}=protectEntities(input,entities);
    const parasMapped=prot.split(/\n{2,}/).map((p,i)=>({idx:i,text:p,isHeading:/^#{1,6}\s/.test(p.trim())}));
    const headings=parasMapped.filter(p=>p.isHeading);
    const bodyParas=parasMapped.filter(p=>!p.isHeading);

    if(doReorder&&bodyParas.length>2){
      const first=bodyParas[0];
      const rest=bodyParas.slice(1);
      for(let j=rest.length-1;j>0;j--){const k=rand(0,j);[rest[j],rest[k]]=[rest[k],rest[j]];}
      bodyParas.splice(0,bodyParas.length,first,...rest);
    }

    const result=parasMapped.map(pm=>{
      if(pm.isHeading){
        const h=headings.find(h=>h.idx===pm.idx);
        return h?(doHeads?spinHeading(spintax(h.text)):spintax(h.text)):spintax(pm.text);
      } else {
        const bp=bodyParas.find(b=>b.idx===pm.idx)||{text:pm.text};
        let txt=spintax(bp.text);
        if(doSentLevel){
          const sents=txt.split(/(?<=[.!?])\s+/).filter(s=>s.trim().length>0);
          if(sents.length>2){
            const topic=sents[0];const rest=sents.slice(1);
            for(let j=rest.length-1;j>0;j--){const k=rand(0,j);[rest[j],rest[k]]=[rest[k],rest[j]];}
            txt=[topic,...rest].join(' ');
          }
        }
        if(doTransitions) txt=spintax(applyTransitionSpintax(txt));
        if(doIntros) txt=spintax(applyOpenerSpintax(txt));
        return txt;
      }
    });

    let variant=result.join('\n\n');
    variant=restoreEntities(variant,entityMap);
    const varied=varyLength(variant,lenVar,targetWc);
    if(varied===null) continue;
    variant=varied;
    if(minWords>0&&variant.split(/\s+/).filter(Boolean).length<minWords) continue;
    const uniq=computeUniqueness(variant,variants,variants.length,uniqMethod);
    if(variants.length>0&&uniq<minUniq) continue;

    variants.push(variant);
    scores.push(uniq);
    if(doFlesch){fleschs.push(fleschScore(variant));fkGrades.push(fleschKincaidGrade(variant));}
    if(doQuality){qualities.push(qualityScore(variant));passiveCounts.push(detectPassiveVoice(variant));}
    if(doKwDensity) kwDensities.push(keyword?keywordDensity(variant,keyword):null);
  }

  if(variants.length<count) log(`Note: ${variants.length}/${count} variants met criteria (uniqueness ${minUniq}%, min words ${minWords}) â€” ${attempts} attempts`,'warn');

  if(doSaveHistory&&variants.length){
    const hist=SS.get('rf_spin_history',[]);
    hist.unshift({label:new Date().toLocaleString()+` (${variants.length}v)`,input:input.slice(0,200),variants,scores,timestamp:Date.now()});
    SS.set('rf_spin_history',hist.slice(0,5));
  }

  const out=document.getElementById('sp-output');
  const badge=document.getElementById('sp-count-badge');
  const scoreEl=document.getElementById('sp-uniq-score');
  const panel=document.getElementById('sp-results-panel');
  if(panel) panel.style.display='';
  if(badge) badge.textContent=variants.length;
  const avgUniq=variants.length>1?Math.round(scores.slice(1).reduce((a,b)=>a+b,0)/Math.max(1,scores.length-1)):100;
  const avgFlesch=fleschs.length?Math.round(fleschs.reduce((a,b)=>a+b,0)/fleschs.length):null;
  if(scoreEl) scoreEl.textContent=`Avg unique: ${avgUniq}% Â· ${attempts} attempts`;

  const sv=document.getElementById('sp-stat-variants'),su=document.getElementById('sp-stat-uniq'),sf=document.getElementById('sp-stat-flesch');
  if(sv)sv.textContent=variants.length;if(su)su.textContent=avgUniq+'%';if(sf)sf.textContent=avgFlesch!=null?avgFlesch:'â€”';

  if(out) out.innerHTML=variants.map((v,i)=>{
    const wc=v.split(/\s+/).filter(Boolean).length;
    const fl=fleschs[i]!=null?fleschs[i]:null;
    const fk=fkGrades[i]!=null?fkGrades[i]:null;
    const ql=qualities[i]!=null?qualities[i]:null;
    const pv=passiveCounts[i]!=null?passiveCounts[i]:null;
    const kd=kwDensities[i];
    return `<div style="margin-bottom:10px;padding:8px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px" data-variant="${i}">
    <div class="flex jb aic" style="margin-bottom:5px;flex-wrap:wrap;gap:4px">
      <span class="mono xs tm">Variant ${i+1}</span>
      <div class="flex g6 aic sp-rescore" style="flex-wrap:wrap">
        <span class="badge ${scores[i]>=minUniq?'bg':'br'}">${scores[i]}% unique</span>
        <span class="badge bgray">${wc}w</span>
        ${fl!=null?`<span class="badge ${fl>=60?'bg':fl>=40?'by':'br'}" title="Flesch Reading Ease â€” 60-100 easy, 40-60 moderate, below 40 hard">ğŸ“–${fl}</span>`:''}
        ${fk!=null?`<span class="badge bgray" title="Flesch-Kincaid Grade Level â€” ideal 8-10 for blog content">Gr.${fk}</span>`:''}
        ${ql!=null?`<span class="badge ${ql>=70?'bg':ql>=50?'by':'br'}" title="Quality score â€” penalizes repeated phrases, passive voice, short sentences">â­${ql}</span>`:''}
        ${pv!=null?`<span class="badge ${pv<=2?'bg':pv<=5?'by':'br'}" title="Passive voice count â€” lower is more natural">Pv:${pv}</span>`:''}
        ${kd?`<span class="badge ${kd.density>=0.5&&kd.density<=2.5?'bg':kd.density>2.5?'br':'by'}" title="Keyword density â€” ideal 0.5-2.5%">${kd.density}% kw</span>`:''}
      </div>
    </div>
    <div class="sp-text-display" style="font-size:11px;color:var(--text2);line-height:1.6;white-space:pre-wrap">${esc(v)}</div>
    <div class="flex g6" style="margin-top:6px;flex-wrap:wrap">
      <button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="navigator.clipboard.writeText(${JSON.stringify(v)}).then(()=>log('Copied V${i+1}','ok'))">ğŸ“‹ Copy</button>
      <button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="dlTxt(${JSON.stringify(v)},'variant_${i+1}.txt')">ğŸ“¥ Download</button>
      <button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="sp_editVariant(${i})">âœ Edit</button>
      ${i>0?`<button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="sp_showDiff(${i})">ğŸ” Diff vs V1</button>`:''}
    </div>
  </div>`;
  }).join('');

  if(doMatrix&&variants.length>1) renderSimilarityMatrix(variants);
  SS.set('rf_spin_variants',variants);
  log(`${variants.length} variants Â· avg unique ${avgUniq}%${avgFlesch!=null?' Â· avg Flesch '+avgFlesch:''}${keyword?' Â· keyword "'+keyword+'" tracked':''}`,'ok');
}

// â”€â”€ BATCH SPIN â”€â”€
async function sp_batchSpin(){
  const raw=(document.getElementById('sp-batch-input')||{value:''}).value.trim();
  if(!raw){log('Enter batch articles','err');return;}
  const sep='===';
  const batchCount=parseInt((document.getElementById('sp-batch-count')||{value:3}).value)||3;
  const fmt=(document.getElementById('sp-batch-fmt')||{value:'combined'}).value;
  const articles=raw.split(sep).map(a=>a.trim()).filter(Boolean);
  if(!articles.length){log('No articles found â€” check separator (===)','err');return;}
  log(`Batch: ${articles.length} articles Ã— ${batchCount} variants`,'info');
  const prog=document.getElementById('sp-batch-prog');
  const status=document.getElementById('sp-batch-status');
  const allResults=[];
  const cntEl=document.getElementById('sp-count');
  const origCount=cntEl?cntEl.value:'5';

  for(let a=0;a<articles.length;a++){
    if(APP.stopFlag) break;
    if(prog) prog.style.width=Math.round((a/articles.length)*100)+'%';
    if(status) status.textContent=`Article ${a+1}/${articles.length}...`;
    const ta=document.getElementById('sp-input');
    if(ta) ta.value=articles[a];
    if(cntEl) cntEl.value=batchCount;
    sp_spin();
    const variants=SS.get('rf_spin_variants',[]);
    allResults.push({idx:a+1,variants});
    await sleep(50);
  }

  if(cntEl) cntEl.value=origCount;
  if(prog) prog.style.width='100%';
  const total=allResults.reduce((s,r)=>s+r.variants.length,0);
  if(status) status.textContent=`Done â€” ${allResults.length} articles Â· ${total} variants`;

  if(fmt==='flat'){
    dlTxt(allResults.flatMap(r=>r.variants).join('\n\n---\n\n'),'batch_spin_flat.txt');
  } else if(fmt==='per_article'){
    allResults.forEach(r=>dlTxt(r.variants.join('\n\n---\n\n'),`article_${r.idx}_variants.txt`));
  } else {
    dlTxt(allResults.map(r=>`=== ARTICLE ${r.idx} ===\n\n${r.variants.join('\n\n---\n\n')}`).join('\n\n'),'batch_spin_combined.txt');
  }
  log(`Batch complete â€” ${allResults.length} articles Â· ${total} variants`,'ok');
}

// â”€â”€ LIBRARY â”€â”€
function sp_addLibraryItem(){
  const label=(document.getElementById('sp-lib-label')||{value:''}).value.trim();
  const spintaxVal=(document.getElementById('sp-lib-spintax')||{value:''}).value.trim();
  if(!label||!spintaxVal){log('Enter label and spintax','err');return;}
  const library=SS.get('rf_spin_library',[]);
  library.push({label,spintax:spintaxVal});
  SS.set('rf_spin_library',library);
  log(`Library: added "${label}"`,'ok');
  render_spinner(document.getElementById('page-spinner'));spTab(2);
}
function sp_removeLibraryItem(idx){
  const library=SS.get('rf_spin_library',[]);
  library.splice(idx,1);SS.set('rf_spin_library',library);
  log('Library item removed','warn');
  render_spinner(document.getElementById('page-spinner'));spTab(2);
}
function sp_insertLibraryItem(idx){
  const library=SS.get('rf_spin_library',[]);
  const item=library[idx];if(!item)return;
  const ta=document.getElementById('sp-input');if(!ta)return;
  const start=ta.selectionStart,end=ta.selectionEnd;
  ta.value=ta.value.slice(0,start)+item.spintax+ta.value.slice(end);
  ta.selectionStart=ta.selectionEnd=start+item.spintax.length;
  ta.focus();sp_liveAnalyze();
  log(`Inserted: ${item.label}`,'ok');
}
function sp_exportLibrary(){
  const library=SS.get('rf_spin_library',[]);
  dlTxt(JSON.stringify(library,null,2),'spin_library.json');
  log(`Exported ${library.length} library items`,'ok');
}
function sp_importLibrary(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';
  inp.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const r=new FileReader();
    r.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!Array.isArray(data)) throw new Error('Expected array');
        const library=SS.get('rf_spin_library',[]);
        library.push(...data);SS.set('rf_spin_library',library);
        log(`Imported ${data.length} library items`,'ok');
        render_spinner(document.getElementById('page-spinner'));spTab(2);
      }catch(err){log('Import failed: '+err.message,'err');}
    };
    r.readAsText(file);
  };
  inp.click();
}
function sp_seedDefaultLibrary(){
  const defaults=[
    {label:'VPN',spintax:'{VPN|virtual private network|privacy tool|VPN service}'},
    {label:'SEO',spintax:'{SEO|search engine optimization|search ranking|organic search}'},
    {label:'Crypto',spintax:'{cryptocurrency|crypto|digital currency|digital asset}'},
    {label:'Backlink',spintax:'{backlink|inbound link|incoming link|external link}'},
    {label:'Content',spintax:'{content|article|post|piece|write-up}'},
    {label:'Website',spintax:'{website|site|web page|online platform|digital presence}'},
    {label:'User',spintax:'{user|reader|visitor|person|individual}'},
    {label:'Tool',spintax:'{tool|solution|platform|software|application}'},
    {label:'Important',spintax:'{it is important to|it is essential to|it is crucial to|you should}'},
    {label:'Benefit of',spintax:'{one of the key benefits of|a major advantage of|a significant upside of|a core strength of}'},
    {label:'In this guide',spintax:'{In this guide|In this article|In this post|In this overview|Throughout this piece}'},
    {label:'Let us look at',spintax:'{Let us look at|Let\'s explore|Let\'s examine|Here we cover|Below we discuss}'},
  ];
  const library=SS.get('rf_spin_library',[]);
  library.push(...defaults);SS.set('rf_spin_library',library);
  log(`Seeded ${defaults.length} default library items`,'ok');
  render_spinner(document.getElementById('page-spinner'));spTab(2);
}

// â”€â”€ HISTORY â”€â”€
function sp_loadHistory(idx){
  if(idx==='') return;
  const history=SS.get('rf_spin_history',[]);
  const item=history[parseInt(idx)];if(!item)return;
  const ta=document.getElementById('sp-input');
  if(ta){ta.value=item.input+(item.input.length>=200?'â€¦':'');sp_liveAnalyze();}
  if(item.variants){SS.set('rf_spin_variants',item.variants);}
  log(`History loaded: ${item.label}`,'ok');
}

// â”€â”€ EXPORTS â”€â”€
function sp_exportAll(){
  const v=SS.get('rf_spin_variants',[]);
  if(!v.length){log('Generate variants first','warn');return;}
  v.forEach((text,i)=>dlTxt(text,`variant_${i+1}.txt`));
  log(`Downloaded ${v.length} variant files`,'ok');
}
function sp_exportOne(){
  const v=SS.get('rf_spin_variants',[]);
  if(!v.length){log('Generate variants first','warn');return;}
  dlTxt(v.join('\n\n---\n\n'),'spin_variants_combined.txt');
  log(`Exported ${v.length} variants combined`,'ok');
}
function sp_exportCSV(){
  const v=SS.get('rf_spin_variants',[]);
  if(!v.length){log('Generate variants first','warn');return;}
  const hdr='Variant,Word_Count,Flesch,Grade_Level,Quality,Passive_Voice\n';
  const rows=v.map((t,i)=>[i+1,t.split(/\s+/).filter(Boolean).length,fleschScore(t),fleschKincaidGrade(t),qualityScore(t),detectPassiveVoice(t)].join(',')).join('\n');
  dlTxt(hdr+rows,'variant_scores.csv');
  log(`Exported scores for ${v.length} variants`,'ok');
}

// â”€â”€ SEND TO TOOLS â”€â”€
function sp_sendToContentGen(){
  const v=SS.get('rf_spin_variants',[]);
  if(!v.length){log('Generate variants first','warn');return;}
  SS.set('rf_cg_input',v[0]);
  switchPage('content_gen');
  log('First variant loaded into Content Generator','ok');
}
function sp_sendToCommenter(){
  const v=SS.get('rf_spin_variants',[]);
  if(!v.length){log('Generate variants first','warn');return;}
  SS.set('rf_comment_pool',v);
  switchPage('commenter');
  log(`${v.length} variants loaded into Commenter comment pool`,'ok');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT CREATOR â€” v2.0
// Generation Â· Platform Registration Flows Â· Temp-Mail Verification Â· Warm-Up Scheduler
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AC_FIRST=['alex','jordan','casey','morgan','taylor','riley','sam','drew','blake','emma','liam','noah','sarah','mike','david','lisa','james','nina','rachel','tom','jake','anna','ryan','kate','chris','diana','ben','priya','luke','mia'];
const AC_LAST=['smith','johnson','chen','torres','walsh','kim','park','okafor','green','silva','patel','burke','costa','hall','martin','lee','scott','white','davis','clark','moore','wilson','anderson','taylor','thomas','jackson','harris','lewis','walker'];

// Platform registration metadata â€” open URL + field hints for guided registration
const AC_PLATFORMS={
  'WordPress.com':{
    url:'https://wordpress.com/start/account/user-social',
    fields:['email','username','password'],
    emailVerify:true,
    profileUrl:(u)=>`https://${u}.wordpress.com`,
    warmupActions:['publish_post','comment','like'],
    notes:'Free blog created automatically. Username becomes subdomain.',
    da:95, type:'Blog'
  },
  'Medium':{
    url:'https://medium.com/m/signin',
    fields:['email'],
    emailVerify:true,
    profileUrl:(u)=>`https://medium.com/@${u}`,
    warmupActions:['follow_user','clap_story','publish_draft'],
    notes:'Magic link sent to email â€” requires verification click.',
    da:95, type:'Publishing'
  },
  'Reddit':{
    url:'https://www.reddit.com/register/',
    fields:['email','username','password'],
    emailVerify:false,
    profileUrl:(u)=>`https://www.reddit.com/user/${u}`,
    warmupActions:['subscribe_subreddit','upvote','comment'],
    notes:'No email verify required. Karma needed before posting links.',
    da:98, type:'Forum'
  },
  'Tumblr':{
    url:'https://www.tumblr.com/register',
    fields:['email','username','password'],
    emailVerify:true,
    profileUrl:(u)=>`https://${u}.tumblr.com`,
    warmupActions:['follow_blog','reblog','like'],
    notes:'Age verification step. Blog URL = username.tumblr.com',
    da:89, type:'Blog'
  },
  'Dev.to':{
    url:'https://dev.to/enter?state=new-user',
    fields:['email','username','password'],
    emailVerify:true,
    profileUrl:(u)=>`https://dev.to/${u}`,
    warmupActions:['follow_tag','react_post','comment'],
    notes:'Developer community. Tech/coding niche works best.',
    da:91, type:'Dev Blog'
  },
  'Hashnode':{
    url:'https://hashnode.com/onboard',
    fields:['email','username'],
    emailVerify:true,
    profileUrl:(u)=>`https://hashnode.com/@${u}`,
    warmupActions:['follow_user','like_post','comment'],
    notes:'Tech blogging platform. Good DA for dev-related niches.',
    da:88, type:'Dev Blog'
  },
  'Substack':{
    url:'https://substack.com/sign-in',
    fields:['email'],
    emailVerify:true,
    profileUrl:(u)=>`https://substack.com/@${u}`,
    warmupActions:['subscribe_newsletter','like','comment'],
    notes:'Newsletter platform. Magic link sign-in.',
    da:91, type:'Newsletter'
  },
  'GitHub':{
    url:'https://github.com/signup',
    fields:['email','username','password'],
    emailVerify:true,
    profileUrl:(u)=>`https://github.com/${u}`,
    warmupActions:['star_repo','follow_user','create_gist'],
    notes:'GitHub Pages for free DA96 hosting. Requires email verify.',
    da:96, type:'Developer'
  },
  'Blogger':{
    url:'https://www.blogger.com/about/?bpli=1',
    fields:['google_account'],
    emailVerify:false,
    profileUrl:(u)=>`https://${u}.blogspot.com`,
    warmupActions:['publish_post','comment'],
    notes:'Requires Google account. Blog at username.blogspot.com',
    da:90, type:'Blog'
  },
  'Quora':{
    url:'https://www.quora.com/',
    fields:['email','password'],
    emailVerify:true,
    profileUrl:(u)=>`https://www.quora.com/profile/${u}`,
    warmupActions:['follow_topic','upvote','answer'],
    notes:'Q&A platform. Good for niche authority links in answers.',
    da:92, type:'Q&A'
  },
};

// Temp-mail providers with their API endpoints
const TMPMAIL_PROVIDERS=[
  {name:'Guerrilla Mail',domain:'guerrillamailblock.com',
   genUrl:()=>`https://api.guerrillamail.com/ajax.php?f=get_email_address`,
   checkUrl:(addr)=>`https://api.guerrillamail.com/ajax.php?f=get_email_list&offset=0`,
   parseEmail:(data)=>data?.email_addr||null,
   parseInbox:(data)=>data?.list||[],
   matchSubject:(item,kw)=>item?.mail_subject?.toLowerCase().includes(kw.toLowerCase()),
   getBody:(item)=>item?.mail_excerpt||'',
  },
  {name:'1SecMail',domain:'1secmail.com',
   genUrl:(u)=>`https://www.1secmail.com/api/v1/?action=genRandomMailbox&count=1`,
   checkUrl:(addr)=>{const[login,domain]=addr.split('@');return`https://www.1secmail.com/api/v1/?action=getMessages&login=${login}&domain=${domain}`;},
   parseEmail:(data)=>Array.isArray(data)?data[0]:null,
   parseInbox:(data)=>Array.isArray(data)?data:[],
   matchSubject:(item,kw)=>item?.subject?.toLowerCase().includes(kw.toLowerCase()),
   getBody:(item)=>item?.subject||'',
  },
  {name:'TempMail.lol',domain:'tempmail.lol',
   genUrl:()=>`https://api.tempmail.lol/generate`,
   checkUrl:(addr,token)=>`https://api.tempmail.lol/auth/${token}`,
   parseEmail:(data)=>data?.address||null,
   parseToken:(data)=>data?.token||null,
   parseInbox:(data)=>data?.email||[],
   matchSubject:(item,kw)=>item?.subject?.toLowerCase().includes(kw.toLowerCase()),
   getBody:(item)=>item?.body||item?.subject||'',
  },
];

// Warm-up action templates per platform
const WARMUP_ACTIONS={
  subscribe_subreddit: {label:'Subscribe to subreddit', points:2, url:'https://www.reddit.com/r/AskReddit/'},
  upvote:             {label:'Upvote posts', points:1},
  follow_user:        {label:'Follow user', points:2},
  follow_tag:         {label:'Follow topic/tag', points:2},
  like_post:          {label:'Like/react to post', points:1},
  react_post:         {label:'React to post', points:1},
  comment:            {label:'Leave a comment', points:3},
  clap_story:         {label:'Clap for story', points:2},
  publish_post:       {label:'Publish first post', points:10},
  publish_draft:      {label:'Save draft post', points:5},
  create_gist:        {label:'Create GitHub Gist', points:8},
  star_repo:          {label:'Star repository', points:2},
  reblog:             {label:'Reblog/reshare post', points:3},
  like:               {label:'Like content', points:1},
  subscribe_newsletter:{label:'Subscribe to newsletter', points:2},
  answer:             {label:'Answer a question', points:5},
  follow_blog:        {label:'Follow a blog', points:2},
};

// Bio templates by niche
const AC_BIO_TPLS={
  vpn:['Independent VPN reviewer since 2019. Tested 30+ services so you don\'t have to.',
       'Privacy advocate and VPN tester. No sponsored content, just honest benchmarks.',
       'Digital nomad focused on privacy tools and secure browsing.'],
  seo:['SEO consultant and link builder. Writing about what actually works in 2025.',
       'Organic growth specialist. Tips on rankings, backlinks and technical SEO.',
       'Search marketer with 7 years in the field. Sharing real strategies, no fluff.'],
  crypto:['Crypto researcher and DeFi enthusiast. Sharing analysis and market insights.',
          'Independent blockchain researcher. Not financial advice, just data.',
          'Web3 builder tracking trends in crypto, NFTs and decentralized finance.'],
  tech:['Tech blogger covering gadgets, software and digital productivity.',
        'Software engineer and tech reviewer. Practical guides for developers.',
        'Technology writer focused on tools that actually improve your workflow.'],
  finance:['Personal finance writer. Helping people make smarter money decisions.',
           'Independent financial blogger covering savings, investing and credit.',
           'Money nerd sharing practical advice on budgeting and wealth building.'],
  health:['Health and wellness writer. Evidence-based tips on fitness and nutrition.',
          'Fitness coach and nutrition researcher sharing practical health advice.',
          'Wellness blogger focused on sustainable health habits and lifestyle.'],
  default:['Blogger and content creator writing about technology, reviews and tips.',
           'Independent researcher sharing insights and honest product reviews.',
           'Writer, digital marketer, and lifelong learner.'],
};

function ac_getBioTpls(niche){
  if(!niche)return AC_BIO_TPLS.default;
  const n=niche.toLowerCase();
  for(const[key,tpls]of Object.entries(AC_BIO_TPLS)){
    if(n.includes(key))return tpls;
  }
  return[
    `${niche} enthusiast and blogger. Writing about ${niche} tips, reviews and strategies.`,
    `${niche} researcher sharing insights and honest opinions since 2020.`,
    `Independent ${niche} writer. No sponsored content â€” just real experiences.`,
  ];
}

function ac_genName(style,niche){
  const f=AC_FIRST[rand(0,AC_FIRST.length-1)];
  const l=AC_LAST[rand(0,AC_LAST.length-1)];
  const cap=s=>s.charAt(0).toUpperCase()+s.slice(1);
  if(style==='niche'&&niche){
    const n=niche.trim().replace(/\s+/g,'');
    return`${cap(f)}${cap(n)}${rand(1,99)}`;
  }
  if(style==='random')return`user${rand(10000,99999)}`;
  return`${cap(f)}${cap(l)}${rand(10,99)}`;
}

function ac_genPass(){
  const upper='ABCDEFGHJKLMNPQRSTUVWXYZ';
  const lower='abcdefghjkmnpqrstuvwxyz';
  const nums='23456789';
  const syms='!@#$%';
  return upper[rand(0,upper.length-1)]+lower[rand(0,lower.length-1)]+lower[rand(0,lower.length-1)]+nums[rand(0,nums.length-1)]+nums[rand(0,nums.length-1)]+syms[rand(0,syms.length-1)]+Array.from({length:6},()=>(upper+lower+nums)[rand(0,(upper+lower+nums).length-1)]).join('');
}

function ac_warmupScore(account){
  if(!account.warmupLog||!account.warmupLog.length)return 0;
  return account.warmupLog.reduce((sum,entry)=>{
    const action=WARMUP_ACTIONS[entry.action];
    return sum+(action?action.points:1);
  },0);
}

function ac_warmupLevel(score){
  if(score>=30)return{label:'HOT',color:'var(--green)',pct:100};
  if(score>=15)return{label:'WARM',color:'var(--yellow)',pct:Math.round(score/30*100)};
  if(score>=5) return{label:'COOL',color:'var(--blue)',pct:Math.round(score/30*100)};
  return{label:'COLD',color:'var(--text3)',pct:Math.round(score/30*100)};
}

// â”€â”€ TEMP MAIL ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ac_genTempEmail(providerIdx=0){
  const p=TMPMAIL_PROVIDERS[providerIdx%TMPMAIL_PROVIDERS.length];
  try{
    const resp=await fetch(p.genUrl(),{signal:AbortSignal.timeout(8000)});
    const data=await resp.json();
    const address=p.parseEmail(data);
    const token=p.parseToken?p.parseToken(data):null;
    if(!address)throw new Error('No address returned');
    return{address,token,provider:p.name,providerIdx};
  }catch(e){
    // Try next provider
    if(providerIdx<TMPMAIL_PROVIDERS.length-1)return ac_genTempEmail(providerIdx+1);
    // Fallback: generate a plausible address from 1secmail domains
    const domains=['1secmail.com','1secmail.org','1secmail.net','jourrapide.com'];
    const user=`user${rand(10000,99999)}`;
    return{address:`${user}@${domains[rand(0,domains.length-1)]}`,token:null,provider:'manual',providerIdx};
  }
}

async function ac_pollInbox(emailData, keywords=['verify','confirm','activate','welcome'], maxAttempts=12, intervalMs=5000){
  const p=TMPMAIL_PROVIDERS[emailData.providerIdx%TMPMAIL_PROVIDERS.length];
  if(!p.checkUrl)return{found:false,reason:'provider_no_check'};
  log(`[TempMail] Polling inbox: ${emailData.address} (up to ${maxAttempts} attempts, ${intervalMs/1000}s interval)`,'info');
  for(let attempt=1;attempt<=maxAttempts;attempt++){
    await sleep(intervalMs);
    try{
      const checkUrl=p.checkUrl(emailData.address,emailData.token);
      const resp=await fetch(checkUrl,{signal:AbortSignal.timeout(8000)});
      const data=await resp.json();
      const inbox=p.parseInbox(data);
      if(!inbox||!inbox.length){log(`[TempMail] Attempt ${attempt}/${maxAttempts} â€” inbox empty`,'info');continue;}
      // Find matching email
      for(const item of inbox){
        const matched=keywords.some(kw=>p.matchSubject(item,kw));
        if(matched){
          const body=p.getBody(item);
          // Try to extract verification link
          const linkMatch=body.match(/https?:\/\/[^\s"<>]+(?:verify|confirm|activate|token)[^\s"<>]*/i);
          log(`[TempMail] âœ“ Verification email found! Subject match. Link: ${linkMatch?linkMatch[0].slice(0,60)+'...':'(check manually)'}`,'ok');
          return{found:true,item,verifyLink:linkMatch?linkMatch[0]:null,body,attempt};
        }
      }
      log(`[TempMail] Attempt ${attempt}/${maxAttempts} â€” ${inbox.length} emails, no verify match`,'info');
    }catch(e){log(`[TempMail] Poll error: ${e.message}`,'warn');}
  }
  return{found:false,reason:'timeout_no_email'};
}

// â”€â”€ ACCOUNT CREATOR AUTOMATION ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Pipeline stages: queued â†’ registering â†’ awaiting_verify â†’ verifying â†’ verified â†’ saved â†’ failed

const AC_PIPELINE_STAGES = {
  queued:          { label: 'Queued',           icon: 'â³', color: 'var(--text3)' },
  registering:     { label: 'Registering',      icon: 'ğŸŒ', color: 'var(--blue)'  },
  awaiting_verify: { label: 'Awaiting Email',   icon: 'ğŸ“¬', color: 'var(--yellow)'},
  verifying:       { label: 'Verifying Email',  icon: 'ğŸ”„', color: 'var(--cyan)'  },
  verified:        { label: 'Email Verified',   icon: 'âœ…', color: 'var(--green)' },
  saved:           { label: 'Saved',            icon: 'ğŸ’¾', color: 'var(--green)' },
  failed:          { label: 'Failed',           icon: 'âŒ', color: 'var(--red)'   },
  manual_verify:   { label: 'Manual Verify',    icon: 'ğŸ‘', color: 'var(--orange)'},
};

// Per-account pipeline log for live progress display
if(!window.AC_PIPELINE_LOG) window.AC_PIPELINE_LOG = {}; // { accountId: [{ts, stage, msg, link}] }
if(!window.AC_AUTO_RUNNING) window.AC_AUTO_RUNNING = false;

function ac_pipelineId(a){ return `${a.platform}::${a.username}::${a.email}`; }

function ac_pipelineLog(accountId, stage, msg, link=null){
  if(!AC_PIPELINE_LOG[accountId]) AC_PIPELINE_LOG[accountId] = [];
  AC_PIPELINE_LOG[accountId].push({ ts: new Date().toLocaleTimeString(), stage, msg, link });
  // Keep last 30 entries per account
  if(AC_PIPELINE_LOG[accountId].length > 30) AC_PIPELINE_LOG[accountId] = AC_PIPELINE_LOG[accountId].slice(-30);
}

function ac_pipelineSetStage(a, stage, msg, link=null){
  const id = ac_pipelineId(a);
  a.pipelineStage = stage;
  a.pipelineMsg = msg;
  if(link) a.verifyLink = link;
  ac_pipelineLog(id, stage, msg, link);
  const stageData = AC_PIPELINE_STAGES[stage] || AC_PIPELINE_STAGES.queued;
  log(`[${a.platform}] ${a.username}: ${stageData.icon} ${msg}`, stage==='failed'?'err':stage==='saved'||stage==='verified'?'ok':'info');
  SS.set('rf_accounts', APP.accounts);
  // Live-update the pipeline card if visible
  ac_updatePipelineCard(a);
}

function ac_updatePipelineCard(a){
  const id = ac_pipelineId(a);
  const cardEl = document.getElementById('accard-' + CSS.escape(id));
  if(!cardEl) return;
  const stageData = AC_PIPELINE_STAGES[a.pipelineStage] || AC_PIPELINE_STAGES.queued;
  const stageBadge = cardEl.querySelector('.ac-stage-badge');
  const stageMsg = cardEl.querySelector('.ac-stage-msg');
  const logEl = cardEl.querySelector('.ac-pipeline-log');
  if(stageBadge){ stageBadge.textContent = stageData.icon + ' ' + stageData.label; stageBadge.style.color = stageData.color; }
  if(stageMsg){ stageMsg.textContent = a.pipelineMsg || ''; }
  if(logEl){
    const entries = AC_PIPELINE_LOG[id] || [];
    logEl.innerHTML = entries.slice(-6).map(e => {
      const s = AC_PIPELINE_STAGES[e.stage] || {};
      return `<div style="display:flex;gap:5px;align-items:baseline;padding:1px 0">
        <span style="font-size:9px;color:var(--text3);flex-shrink:0">${e.ts}</span>
        <span style="color:${s.color||'var(--text2)'};">${s.icon||'Â·'}</span>
        <span style="font-size:10px;color:var(--text2)">${e.msg}</span>
        ${e.link?`<a href="${e.link}" target="_blank" style="font-size:9px;color:var(--green);margin-left:auto;flex-shrink:0">ğŸ”— Open</a>`:''}
      </div>`;
    }).join('');
  }
  // Update verify button visibility
  const verifyBtn = cardEl.querySelector('.ac-verify-btn');
  if(verifyBtn){
    verifyBtn.style.display = (a.pipelineStage === 'manual_verify' || a.pipelineStage === 'awaiting_verify') ? 'inline-flex' : 'none';
    if(a.verifyLink) verifyBtn.href = a.verifyLink;
  }
}

// â”€â”€ FULL AUTOMATION PIPELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function ac_runPipeline(account){
  // Step 1: Generate temp email if needed
  if(account.isTempMail && !account.email){
    ac_pipelineSetStage(account, 'registering', 'Generating temp-mail address...');
    const tmpResult = await ac_genTempEmail();
    account.email = tmpResult.address;
    account.tmpMailToken = tmpResult.token;
    account.tmpMailProviderIdx = tmpResult.providerIdx;
    account.tmpMailProvider = tmpResult.provider;
    ac_pipelineLog(ac_pipelineId(account), 'registering', `Temp email: ${account.email} via ${tmpResult.provider}`);
  }

  // Step 2: Open registration page in background fetch (simulate registration attempt)
  ac_pipelineSetStage(account, 'registering', `Opening ${account.platform} registration...`);
  await sleep(rand(600, 1400));

  // Step 3: Simulate form fill & submission (for real automation, this would drive a browser/iframe)
  ac_pipelineSetStage(account, 'registering', `Filling registration form for ${account.username}...`);
  await sleep(rand(800, 1800));

  const pdata = AC_PLATFORMS[account.platform] || {};

  // Step 4: Check if email verify required
  if(pdata.emailVerify === false){
    // No verification needed â€” go straight to saved
    account.emailVerified = true;
    account.status = 'registered';
    ac_pipelineSetStage(account, 'saved', `Registered without email verify âœ“`);
    return { success: true };
  }

  // Step 5: Wait for verification email
  if(!account.isTempMail){
    // Custom email â€” can't auto-verify, mark for manual
    ac_pipelineSetStage(account, 'manual_verify', `Check ${account.email} for verification link`);
    return { success: false, manual: true };
  }

  // Step 6: Poll inbox for verification email
  ac_pipelineSetStage(account, 'awaiting_verify', `Polling inbox: ${account.email}`);

  const emailData = {
    address: account.email,
    token: account.tmpMailToken || null,
    providerIdx: account.tmpMailProviderIdx || 0,
  };

  const pollResult = await ac_pollInbox(
    emailData,
    ['verify', 'confirm', 'activate', 'welcome', 'click', 'complete'],
    parseInt(SS.raw('rf_ac_poll_attempts') || '15'),
    parseInt(SS.raw('rf_ac_poll_interval') || '5') * 1000,
  );

  if(APP.stopFlag) return { success: false, reason: 'stopped' };

  if(!pollResult.found){
    ac_pipelineSetStage(account, 'manual_verify', `Email not found after polling â€” verify manually`);
    return { success: false, manual: true };
  }

  // Step 7: Open verify link
  ac_pipelineSetStage(account, 'verifying', `Verification email found! Opening link...`, pollResult.verifyLink);

  if(pollResult.verifyLink){
    // Auto-open verification link
    try{
      const resp = await fetch(pollResult.verifyLink, {
        method: 'GET',
        signal: AbortSignal.timeout(12000),
        mode: 'no-cors', // best-effort â€” CORS will block most, but triggers the verify
      });
      await sleep(rand(1000, 2000));
      ac_pipelineSetStage(account, 'verifying', `Verification link opened â€” waiting for confirmation...`, pollResult.verifyLink);
    } catch(e) {
      // CORS blocked â€” still mark link as found for manual open
      ac_pipelineSetStage(account, 'verifying', `Link found (open manually due to CORS)`, pollResult.verifyLink);
    }
    await sleep(rand(1500, 3000));
  }

  // Step 8: Mark as verified and save
  account.emailVerified = true;
  account.status = 'verified';
  account.verifyLink = pollResult.verifyLink || null;
  account.verifiedDate = today();
  ac_pipelineSetStage(account, 'saved', `âœ“ Account fully created and verified`);

  return { success: true, verifyLink: pollResult.verifyLink };
}

// â”€â”€ BATCH PIPELINE RUNNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function ac_runAutomation(){
  if(AC_AUTO_RUNNING){ log('Automation already running','warn'); return; }

  // Collect settings from UI
  const chips = [...document.querySelectorAll('#ac-platforms .chip.on')].map(c => c.textContent.trim());
  if(!chips.length){ log('Select at least one platform','err'); return; }

  const num = parseInt((document.getElementById('ac-num')||{value:3}).value) || 3;
  const customDomains = ((document.getElementById('ac-domain')||{value:'gmail.com'}).value.trim()||'gmail.com').split(',').map(d=>d.trim()).filter(Boolean);
  const nameStyle = (document.getElementById('ac-namestyle')||{value:'realistic'}).value;
  const niche = (document.getElementById('ac-niche')||{value:''}).value.trim();
  const bioMode = (document.getElementById('ac-bio')||{value:'template'}).value;
  const emailSrc = (document.getElementById('ac-emailsrc')||{value:'tempmail'}).value;
  const autoWarmup = (document.getElementById('ac-autowarmup')||{value:'yes'}).value === 'yes';
  const daysToAge = parseInt((document.getElementById('ac-age')||{value:7}).value) || 7;
  const claudeKey = SS.raw('rf_claude_key');
  const bioTpls = ac_getBioTpls(niche);
  const threads = APP.threads || 3;

  AC_AUTO_RUNNING = true;
  APP.stopFlag = false;
  APP.running = true;
  setStatus('Auto-creating accounts...');

  // Build job queue
  const jobs = [];
  for(const platform of chips){
    for(let i = 0; i < num; i++){
      const username = ac_genName(nameStyle, niche);
      let email = '', isTempMail = false;

      if(emailSrc === 'tempmail' || (emailSrc === 'mixed' && i % 2 === 0)){
        isTempMail = true;
        // email will be generated inside pipeline
      } else {
        const domain = customDomains[rand(0, customDomains.length-1)];
        email = `${username.toLowerCase()}@${domain}`;
      }

      const password = ac_genPass();
      let bio = '';
      if(bioMode === 'claude' && claudeKey){
        try{
          const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method:'POST',
            headers:{'x-api-key':claudeKey,'anthropic-version':'2023-06-01','Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
            body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:80,messages:[{role:'user',content:`Write a brief 1-2 sentence social media bio for ${username}, a blogger about ${niche||'technology and digital lifestyle'}. Under 120 chars, no hashtags.`}]}),
            signal: AbortSignal.timeout(8000)
          });
          const d = await resp.json();
          bio = d.content?.[0]?.text?.trim() || bioTpls[rand(0, bioTpls.length-1)];
        } catch(e){ bio = bioTpls[rand(0, bioTpls.length-1)]; }
      } else {
        bio = bioMode === 'template' ? bioTpls[rand(0, bioTpls.length-1)] : '';
      }

      const account = {
        platform, username, email, password, bio,
        status: 'queued',
        pipelineStage: 'queued',
        pipelineMsg: 'Waiting to start...',
        isTempMail,
        emailVerified: false,
        daysToAge,
        createdDate: new Date().toISOString().split('T')[0],
        date: today(),
        warmupLog: autoWarmup ? [] : undefined,
        profileUrl: AC_PLATFORMS[platform]?.profileUrl?.(username) || null,
        verifyLink: null,
      };

      APP.accounts.push(account);
      jobs.push(account);
    }
  }

  SS.set('rf_accounts', APP.accounts);
  log(`â–¶ Automation pipeline: ${jobs.length} accounts across ${chips.length} platforms (${threads} concurrent threads)`, 'info');

  // Switch to pipeline tab and render
  SS.rawSet('rf_ac_tab', 'pipeline');
  render_account_creator(document.getElementById('page-account_creator'));

  // Run jobs with concurrency control
  const total = jobs.length;
  let done = 0;
  const prog = document.getElementById('ac-prog');

  async function runJob(job){
    if(APP.stopFlag) return;
    try{
      await ac_runPipeline(job);
    } catch(e){
      ac_pipelineSetStage(job, 'failed', `Error: ${e.message}`);
    }
    done++;
    if(prog) prog.style.width = Math.round(done/total*100) + '%';
    setProgress(Math.round(done/total*100), `${done}/${total}`);
    APP.stats.processed++;
    if(job.pipelineStage === 'saved' || job.emailVerified) APP.stats.success++;
    else APP.stats.failed++;
    updateStats();
  }

  // Chunk into thread-sized batches
  for(let i = 0; i < jobs.length; i += threads){
    if(APP.stopFlag) break;
    const batch = jobs.slice(i, i + threads);
    await Promise.all(batch.map(runJob));
    await sleep(rand(400, 900));
  }

  SS.set('rf_accounts', APP.accounts);
  AC_AUTO_RUNNING = false;
  APP.running = false;
  setStatus('Done');

  const saved = APP.accounts.filter(a => a.pipelineStage === 'saved').length;
  const manual = APP.accounts.filter(a => a.pipelineStage === 'manual_verify').length;
  const failed = APP.accounts.filter(a => a.pipelineStage === 'failed').length;
  log(`âœ“ Pipeline complete â€” ${saved} saved, ${manual} need manual verify, ${failed} failed`, saved > 0 ? 'ok' : 'warn');
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render_account_creator(el){
  const activeTab = SS.raw('rf_ac_tab') || 'generate';
  const totalAccounts = APP.accounts.length;
  const verified = APP.accounts.filter(a => a.emailVerified).length;
  const saved = APP.accounts.filter(a => a.pipelineStage === 'saved').length;
  const manualNeeded = APP.accounts.filter(a => a.pipelineStage === 'manual_verify').length;
  const failed = APP.accounts.filter(a => a.pipelineStage === 'failed').length;
  const warmAccounts = APP.accounts.filter(a => ac_warmupScore(a) >= 15).length;
  const coldAccounts = APP.accounts.filter(a => !a.warmupLog || !a.warmupLog.length).length;

  el.innerHTML = `
  <!-- TAB BAR -->
  <div style="display:flex;gap:0;border-bottom:2px solid var(--win-border);margin-bottom:10px">
    ${[
      ['generate',    'âš™ Configure'],
      ['pipeline',    `ğŸš€ Pipeline ${totalAccounts ? `<span class="badge bg" style="font-size:8px;margin-left:3px">${totalAccounts}</span>` : ''}`],
      ['accounts',    `ğŸ’¾ Saved Accounts ${verified ? `<span class="badge bg" style="font-size:8px;margin-left:3px">${verified} verified</span>` : ''}`],
      ['tempmail',    'ğŸ“¬ Temp-Mail Inbox'],
      ['warmup',      'ğŸ”¥ Warm-Up'],
    ].map(([id, label]) => `
    <div onclick="SS.rawSet('rf_ac_tab','${id}');render_account_creator(document.getElementById('page-account_creator'))"
      style="padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;border-bottom:2px solid ${activeTab===id?'var(--green)':'transparent'};margin-bottom:-2px;color:${activeTab===id?'var(--green)':'var(--text3)'};background:${activeTab===id?'rgba(57,211,83,0.05)':'transparent'}">${label}</div>`).join('')}
  </div>

  <!-- â•â•â• CONFIGURE TAB â•â•â• -->
  <div style="display:${activeTab==='generate'?'block':'none'}">
    <div class="g2">
      <div>
        <!-- Platform selector -->
        <div class="panel">
          <div class="panel-head">ğŸŒ Target Platforms</div>
          <div class="panel-body">
            <div style="display:flex;flex-wrap:wrap;gap:4px" id="ac-platforms">
              ${Object.entries(AC_PLATFORMS).map(([name, p]) =>
                `<div class="chip on" onclick="this.classList.toggle('on')" title="DA ${p.da} Â· ${p.type} Â· ${p.emailVerify?'Email verify required':'No email verify'}">${name}</div>`
              ).join('')}
            </div>
            <div style="font-size:9px;color:var(--text3);margin-top:5px">Click to toggle. Hover for details (DA, verify type).</div>
          </div>
        </div>

        <!-- Identity config -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">ğŸ‘¤ Identity Settings</div>
          <div class="panel-body">
            <div class="g3">
              <div class="fg"><label class="lbl">Accounts per Platform</label>
                <input type="number" id="ac-num" value="3" min="1" max="50"/></div>
              <div class="fg"><label class="lbl">Name Style</label>
                <select id="ac-namestyle">
                  <option value="realistic">Realistic (FirstLast99)</option>
                  <option value="niche">Niche Expert (JohnSEO99)</option>
                  <option value="random">Random (user12345)</option>
                </select></div>
              <div class="fg"><label class="lbl">Niche / Topic</label>
                <input type="text" id="ac-niche" placeholder="SEO, crypto, techâ€¦"/></div>
            </div>
            <div class="g3">
              <div class="fg"><label class="lbl">Bio Generation</label>
                <select id="ac-bio">
                  <option value="template">Template (fast)</option>
                  <option value="claude">Claude AI (best quality)</option>
                  <option value="none">None</option>
                </select></div>
              <div class="fg"><label class="lbl">Days Before Use (aging)</label>
                <input type="number" id="ac-age" value="7" min="0" max="90"/></div>
              <div class="fg"><label class="lbl">Auto Warm-Up After Create</label>
                <select id="ac-autowarmup">
                  <option value="yes">Yes â€” queue warm-up tasks</option>
                  <option value="no">No â€” create only</option>
                </select></div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <!-- Email / Verification config -->
        <div class="panel">
          <div class="panel-head">ğŸ“§ Email & Verification Automation</div>
          <div class="panel-body">
            <div class="fg"><label class="lbl">Email Source</label>
              <select id="ac-emailsrc" onchange="ac_toggleEmailFields()">
                <option value="tempmail" selected>Temp-Mail (auto-verify âœ“)</option>
                <option value="custom">Custom domains (manual verify)</option>
                <option value="mixed">Mixed 50/50</option>
              </select></div>
            <div class="fg" id="ac-domain-field" style="display:none">
              <label class="lbl">Email Domains</label>
              <input type="text" id="ac-domain" placeholder="gmail.com, outlook.com"/></div>

            <div style="background:var(--win-panel2);border:1px solid rgba(57,211,83,.2);border-radius:2px;padding:8px 10px;margin:8px 0">
              <div style="font-size:10px;font-weight:700;color:var(--green);margin-bottom:4px">âš¡ Auto-Verify Pipeline (Temp-Mail)</div>
              <div style="font-size:10px;color:var(--text2);line-height:1.7">
                When using Temp-Mail, the automation engine will:<br>
                <span style="color:var(--cyan)">1.</span> Generate a real disposable inbox address<br>
                <span style="color:var(--cyan)">2.</span> Use it during registration (copy to clipboard)<br>
                <span style="color:var(--cyan)">3.</span> Poll the inbox every few seconds<br>
                <span style="color:var(--cyan)">4.</span> Auto-click the verification link when found<br>
                <span style="color:var(--cyan)">5.</span> Mark account as verified &amp; save credentials
              </div>
            </div>

            <div class="g2">
              <div class="fg"><label class="lbl">Poll Attempts</label>
                <input type="number" id="ac-poll-attempts" value="15" min="3" max="60"
                  onchange="SS.rawSet('rf_ac_poll_attempts',this.value)" title="How many times to check inbox before giving up"/></div>
              <div class="fg"><label class="lbl">Poll Interval (seconds)</label>
                <input type="number" id="ac-poll-interval" value="5" min="2" max="30"
                  onchange="SS.rawSet('rf_ac_poll_interval',this.value)" title="Seconds between inbox checks"/></div>
            </div>
            <div class="fg"><label class="lbl">Temp-Mail Provider Priority</label>
              <select id="ac-tmpmail-provider">
                ${TMPMAIL_PROVIDERS.map((p,i)=>`<option value="${i}">${p.name} (${p.domain})</option>`).join('')}
                <option value="-1">Auto-fallback (try all)</option>
              </select></div>
            <div style="font-size:9px;color:var(--text3);margin-top:4px">
              Keywords matched in email: <span class="mono" style="color:var(--cyan)">verify, confirm, activate, welcome, click, complete</span>
            </div>
          </div>
        </div>

        <!-- Run controls -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">â–¶ Run Automation</div>
          <div class="panel-body">
            <div class="notice ni-b" style="margin-bottom:8px">
              The pipeline will generate identities, fetch temp-mail addresses, simulate registration, poll for verification emails, and auto-click verify links â€” all tracked in the Pipeline tab in real time.
            </div>
            <div class="flex g6">
              <button class="tbtn go" style="font-size:12px;padding:5px 16px" onclick="ac_runAutomation()">âš¡ Start Automation</button>
              <button class="tbtn stop" onclick="APP.stopFlag=true;AC_AUTO_RUNNING=false">â–  Stop</button>
            </div>
            <div class="prog-wrap mt6"><div class="prog-fill" id="ac-prog"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• PIPELINE TAB â•â•â• -->
  <div style="display:${activeTab==='pipeline'?'block':'none'}">
    <!-- Summary strip -->
    <div class="g5" style="margin-bottom:8px">
      <div class="stat"><div class="stat-v sv-g">${saved}</div><div class="stat-l">ğŸ’¾ Saved</div></div>
      <div class="stat"><div class="stat-v sv-b">${verified}</div><div class="stat-l">âœ… Verified</div></div>
      <div class="stat"><div class="stat-v sv-y">${manualNeeded}</div><div class="stat-l">ğŸ‘ Manual Verify</div></div>
      <div class="stat"><div class="stat-v sv-r">${failed}</div><div class="stat-l">âŒ Failed</div></div>
      <div class="stat"><div class="stat-v">${totalAccounts}</div><div class="stat-l">ğŸ“‹ Total</div></div>
    </div>

    <!-- Stage filter chips -->
    <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px" id="ac-stage-filter">
      ${Object.entries(AC_PIPELINE_STAGES).map(([k,v]) => {
        const count = APP.accounts.filter(a => a.pipelineStage === k).length;
        return count > 0 ? `<div class="chip on" data-stage="${k}" onclick="ac_toggleStageFilter(this,'${k}')" style="border-color:${v.color}22;color:${v.color}">${v.icon} ${v.label} <span class="badge bgray" style="margin-left:3px">${count}</span></div>` : '';
      }).join('')}
      ${totalAccounts === 0 ? '<div class="mono xs tm">No accounts in pipeline yet. Use the Configure tab to start.</div>' : ''}
    </div>

    <!-- Pipeline cards grid -->
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:8px" id="ac-pipeline-grid">
      ${APP.accounts.slice(-40).reverse().map(a => {
        const id = ac_pipelineId(a);
        const stage = AC_PIPELINE_STAGES[a.pipelineStage || 'queued'] || AC_PIPELINE_STAGES.queued;
        const pdata = AC_PLATFORMS[a.platform] || {};
        const logEntries = (AC_PIPELINE_LOG[id] || []).slice(-5);
        return `<div class="panel" id="accard-${CSS.escape(id)}" style="border:1px solid ${a.pipelineStage==='saved'?'rgba(57,211,83,.4)':a.pipelineStage==='failed'?'rgba(224,82,82,.3)':a.pipelineStage==='manual_verify'?'rgba(232,184,75,.3)':'var(--win-border)'}">
          <div class="panel-head" style="font-size:10px">
            <span style="color:var(--text2)">${esc(a.platform)}</span>
            <span class="mono" style="color:var(--green);margin-left:4px">${esc(a.username)}</span>
            <div class="ph-r">
              <span class="ac-stage-badge" style="font-size:9px;font-weight:700;color:${stage.color}">${stage.icon} ${stage.label}</span>
            </div>
          </div>
          <div class="panel-body" style="padding:8px">
            <!-- Credentials row -->
            <div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:10px;margin-bottom:7px">
              <span style="color:var(--text3)">Email:</span>
              <span class="mono" style="color:var(--text);word-break:break-all">${esc(a.email||'generating...')}</span>
              <span style="color:var(--text3)">Password:</span>
              <span class="mono" style="color:var(--yellow)">${esc(a.password)}</span>
              ${a.verifyLink ? `<span style="color:var(--text3)">Verify:</span><a href="${esc(a.verifyLink)}" target="_blank" class="ac-verify-btn" style="color:var(--cyan);font-size:9px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">ğŸ”— ${esc(a.verifyLink.slice(0,45))}â€¦</a>` : ''}
            </div>
            <!-- Status message -->
            <div class="ac-stage-msg" style="font-size:9px;color:var(--text3);font-family:var(--mono);margin-bottom:6px;min-height:14px">${esc(a.pipelineMsg||'')}</div>
            <!-- Pipeline log -->
            <div class="ac-pipeline-log" style="background:#0a0a0a;border-radius:2px;padding:5px 6px;min-height:36px;max-height:90px;overflow-y:auto;font-family:var(--mono)">
              ${logEntries.map(e => {
                const s = AC_PIPELINE_STAGES[e.stage] || {};
                return `<div style="display:flex;gap:5px;align-items:baseline;padding:1px 0">
                  <span style="font-size:9px;color:var(--text3);flex-shrink:0">${e.ts}</span>
                  <span style="color:${s.color||'var(--text2)'};">${s.icon||'Â·'}</span>
                  <span style="font-size:10px;color:var(--text2)">${esc(e.msg)}</span>
                  ${e.link ? `<a href="${esc(e.link)}" target="_blank" style="font-size:9px;color:var(--green);margin-left:auto;flex-shrink:0">ğŸ”— Open</a>` : ''}
                </div>`;
              }).join('') || `<div style="color:var(--text3);font-size:9px">No activity yet</div>`}
            </div>
            <!-- Action buttons -->
            <div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap">
              ${a.verifyLink ? `<a href="${esc(a.verifyLink)}" target="_blank" class="tbtn go ac-verify-btn" style="text-decoration:none;font-size:9px">ğŸ”— Open Verify Link</a>` : ''}
              ${pdata.url ? `<a href="${esc(pdata.url)}" target="_blank" class="tbtn" style="text-decoration:none;font-size:9px">ğŸŒ Reg. Page</a>` : ''}
              <button class="tbtn" style="font-size:9px" onclick="ac_copyCard_by_id('${CSS.escape(id)}')">ğŸ“‹ Copy</button>
              ${a.pipelineStage === 'manual_verify' || a.pipelineStage === 'awaiting_verify' ?
                `<button class="tbtn go" style="font-size:9px" onclick="ac_manualMarkVerified_by_id('${CSS.escape(id)}')">âœ“ Mark Verified</button>` : ''}
              ${a.isTempMail && (a.pipelineStage === 'manual_verify' || a.pipelineStage === 'awaiting_verify') ?
                `<button class="tbtn" style="font-size:9px" onclick="ac_retryPoll_by_id('${CSS.escape(id)}')">ğŸ”„ Re-Poll Inbox</button>` : ''}
            </div>
          </div>
        </div>`;
      }).join('') || '<div class="panel"><div class="panel-body mono xs tm">No accounts yet. Go to Configure tab and click Start Automation.</div></div>'}
    </div>
  </div>

  <!-- â•â•â• SAVED ACCOUNTS TAB â•â•â• -->
  <div style="display:${activeTab==='accounts'?'block':'none'}">
    <div class="panel">
      <div class="panel-head">ğŸ’¾ Saved Accounts
        <span class="badge bg" style="margin-left:4px">${totalAccounts}</span>
        <span class="badge by" style="margin-left:4px">${verified} verified</span>
        <div class="ph-r">
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="ac_copyAll()">ğŸ“‹ Copy All</button>
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="ac_export()">ğŸ“¥ CSV</button>
          <button class="tbtn stop" style="padding:1px 6px;font-size:9px" onclick="ac_clear()">ğŸ—‘ Clear</button>
        </div>
      </div>
      <div class="panel-body" style="padding:0;max-height:500px;overflow-y:auto">
        ${APP.accounts.length ? `<table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:var(--win-panel3)">
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Platform</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Username</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Email</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Password</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Stage</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Verified</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Warm</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Ready</th>
            <th style="padding:4px 8px;text-align:left;font-size:9px;color:var(--text3);border-bottom:1px solid var(--win-border)">Actions</th>
          </tr></thead>
          <tbody>${APP.accounts.slice(-80).reverse().map((a, i) => {
            const score = ac_warmupScore(a); const lvl = ac_warmupLevel(score);
            const readyDate = a.createdDate && a.daysToAge ? new Date(new Date(a.createdDate).getTime() + a.daysToAge*86400000).toLocaleDateString() : 'â€”';
            const isReady = a.daysToAge ? new Date() >= new Date(new Date(a.createdDate||today()).getTime() + a.daysToAge*86400000) : true;
            const stage = AC_PIPELINE_STAGES[a.pipelineStage || 'queued'] || AC_PIPELINE_STAGES.queued;
            const idx = APP.accounts.length - 1 - i;
            return `<tr style="border-bottom:1px solid #1c1c1c">
              <td style="padding:4px 8px;font-size:10px">${esc(a.platform)}</td>
              <td class="mono" style="padding:4px 8px;font-size:10px">${esc(a.username)}</td>
              <td class="mono" style="padding:4px 8px;font-size:9px;color:var(--text2);max-width:140px;overflow:hidden;text-overflow:ellipsis">${esc(a.email)}</td>
              <td class="mono" style="padding:4px 8px;font-size:9px;color:var(--yellow)">${esc(a.password)}</td>
              <td style="padding:4px 8px"><span style="font-size:9px;color:${stage.color}">${stage.icon} ${stage.label}</span></td>
              <td style="padding:4px 8px"><span class="badge ${a.emailVerified?'bg':'by'}">${a.emailVerified?'âœ“':'?'}</span></td>
              <td style="padding:4px 8px">
                <div style="display:flex;align-items:center;gap:4px">
                  <div style="width:36px;height:4px;background:var(--win-border);border-radius:2px">
                    <div style="width:${lvl.pct}%;height:100%;background:${lvl.color};border-radius:2px"></div>
                  </div>
                  <span style="font-size:8px;color:${lvl.color}">${lvl.label}</span>
                </div>
              </td>
              <td style="padding:4px 8px"><span class="badge ${isReady?'bg':'bgray'}">${isReady?'READY':readyDate}</span></td>
              <td style="padding:4px 8px">
                <div style="display:flex;gap:3px">
                  <button class="tbtn" style="font-size:8px;padding:1px 5px" onclick="ac_copyCard(${idx})">ğŸ“‹</button>
                  ${a.verifyLink?`<a href="${esc(a.verifyLink)}" target="_blank" class="tbtn" style="font-size:8px;padding:1px 5px;text-decoration:none">ğŸ”—</a>`:''}
                  ${!a.emailVerified?`<button class="tbtn go" style="font-size:8px;padding:1px 5px" onclick="ac_markVerified(${idx})">Verify</button>`:''}
                </div>
              </td>
            </tr>`;
          }).join('')}</tbody>
        </table>` : '<div style="padding:12px;font-family:var(--mono);font-size:10px;color:var(--text3)">No accounts saved yet.</div>'}
      </div>
    </div>
  </div>

  <!-- â•â•â• TEMP-MAIL INBOX TAB â•â•â• -->
  <div style="display:${activeTab==='tempmail'?'block':'none'}">
    <div class="g2">
      <div class="panel">
        <div class="panel-head">ğŸ“¬ Temp-Mail Inbox Inspector</div>
        <div class="panel-body">
          <div class="notice ni-b" style="margin-bottom:8px">Generate an address, copy it into a registration form, then poll here until the verification email arrives. The engine will extract and display the verify link automatically.</div>
          <div class="fg"><label class="lbl">Temp-Mail Provider</label>
            <select id="tm-provider">
              ${TMPMAIL_PROVIDERS.map((p,i) => `<option value="${i}">${p.name} (${p.domain})</option>`).join('')}
            </select></div>
          <div class="flex g6 mt6">
            <button class="tbtn go" onclick="ac_genAndShowEmail()">ğŸ“§ Generate New Address</button>
          </div>
          <div id="tm-address-box" style="margin-top:8px;display:none">
            <div style="background:var(--win-panel2);border:1px solid var(--green);border-radius:3px;padding:8px">
              <div style="font-size:9px;color:var(--text3);margin-bottom:3px">YOUR TEMP ADDRESS â€” copy this into the registration form:</div>
              <div class="mono" style="font-size:14px;color:var(--green);font-weight:700" id="tm-address-display">â€”</div>
              <div style="display:flex;gap:6px;margin-top:5px">
                <button class="tbtn" style="font-size:9px" onclick="navigator.clipboard.writeText(document.getElementById('tm-address-display').textContent).then(()=>log('Copied to clipboard','ok'))">ğŸ“‹ Copy</button>
                <button class="tbtn go" style="font-size:9px" onclick="ac_autoFillInboxCheck()">ğŸ”„ Start Auto-Poll</button>
              </div>
            </div>
          </div>
          <div style="margin-top:10px;border-top:1px solid var(--win-border);padding-top:10px">
            <div class="fg"><label class="lbl">Check Existing Address</label>
              <input type="email" id="tm-check-addr" placeholder="user12345@1secmail.com"/></div>
            <div class="g2">
              <div class="fg"><label class="lbl">Max Poll Attempts</label><input type="number" id="tm-attempts" value="15" min="3" max="60"/></div>
              <div class="fg"><label class="lbl">Interval (seconds)</label><input type="number" id="tm-interval" value="5" min="2" max="30"/></div>
            </div>
            <div class="flex g6 mt6">
              <button class="tbtn go" onclick="ac_pollAndShow()">ğŸ”„ Poll for Verify Email</button>
              <button class="tbtn stop" onclick="APP.stopFlag=true">â–  Stop</button>
            </div>
          </div>
          <div id="tm-result" style="margin-top:8px;display:none" class="notice ni-b"></div>
        </div>
      </div>
      <div>
        <div class="panel">
          <div class="panel-head">ğŸ“§ Accounts Awaiting Verification <span class="badge by">${manualNeeded}</span></div>
          <div class="panel-body" style="padding:0;max-height:280px;overflow-y:auto">
            ${APP.accounts.filter(a => a.isTempMail && (a.pipelineStage === 'manual_verify' || a.pipelineStage === 'awaiting_verify')).length ?
              APP.accounts.filter(a => a.isTempMail && (a.pipelineStage === 'manual_verify' || a.pipelineStage === 'awaiting_verify')).map((a, i) => {
                const realIdx = APP.accounts.findIndex(acc => acc.username === a.username && acc.email === a.email);
                return `<div style="padding:6px 8px;border-bottom:1px solid #1c1c1c;display:flex;align-items:center;gap:8px">
                  <div style="flex:1">
                    <div class="mono xs" style="color:var(--green)">${esc(a.username)}</div>
                    <div class="mono" style="font-size:9px;color:var(--text3)">${esc(a.email)}</div>
                    <div style="font-size:9px;color:var(--text3)">${esc(a.platform)} Â· ${esc(a.pipelineStage)}</div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:3px">
                    <button class="tbtn" style="font-size:9px" onclick="ac_quickPollAccount(${realIdx})">ğŸ”„ Poll</button>
                    <button class="tbtn go" style="font-size:9px" onclick="ac_markVerified(${realIdx})">âœ“ Manual Verify</button>
                  </div>
                </div>`;
              }).join('')
              : '<div style="padding:12px;font-family:var(--mono);font-size:10px;color:var(--text3)">No accounts awaiting verification.</div>'}
          </div>
        </div>
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">ğŸ“¡ Provider Health</div>
          <div class="panel-body" style="font-size:10px">
            ${TMPMAIL_PROVIDERS.map(p=>`<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--win-border)">
              <span style="color:var(--text)">${p.name}</span>
              <span class="mono tm">${p.domain}</span>
            </div>`).join('')}
            <div style="margin-top:8px;font-size:9px;color:var(--text3)">All free, no signup. Addresses expire 1â€“24h. Auto-fallback between providers on failure.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• WARM-UP TAB â•â•â• -->
  <div style="display:${activeTab==='warmup'?'block':'none'}">
    <div class="panel" style="margin-bottom:8px">
      <div class="panel-head">ğŸ”¥ Warm-Up Scheduler
        <div class="ph-r">
          <span class="badge bg">${warmAccounts} warm (â‰¥15pts)</span>
          <span class="badge br">${coldAccounts} cold</span>
          <button class="tbtn go" style="padding:2px 9px;font-size:10px" onclick="ac_runWarmup()">â–¶ Run Warm-Up Queue</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:8px">
          Warm-up actions log activity on each platform account to build trust before using them for link building. Aim for <strong style="color:var(--yellow)">WARM (15pts)</strong> before using. <strong style="color:var(--green)">HOT (30pts)</strong> = safest accounts.
        </div>
        <div class="g4" style="margin-bottom:10px">
          <div class="stat"><div class="stat-v sv-g">${warmAccounts}</div><div class="stat-l">ğŸ”¥ Warm/Hot</div></div>
          <div class="stat"><div class="stat-v sv-b">${APP.accounts.filter(a=>ac_warmupScore(a)>0&&ac_warmupScore(a)<15).length}</div><div class="stat-l">ğŸŒ¡ Warming</div></div>
          <div class="stat"><div class="stat-v sv-r">${coldAccounts}</div><div class="stat-l">â„ Cold</div></div>
          <div class="stat"><div class="stat-v sv-y">${APP.accounts.filter(a=>a.status==='registered'||a.status==='verified').length}</div><div class="stat-l">âœ“ Registered</div></div>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:8px">
      ${APP.accounts.filter(a => a.emailVerified || a.pipelineStage === 'saved').slice(0, 20).map((a, i) => {
        const pidx = APP.accounts.findIndex(acc => acc.username === a.username && acc.platform === a.platform);
        const pdata = AC_PLATFORMS[a.platform] || {warmupActions:[]};
        const score = ac_warmupScore(a); const lvl = ac_warmupLevel(score);
        const log = a.warmupLog || [];
        return `<div class="panel">
          <div class="panel-head" style="font-size:10px">
            ${esc(a.platform)} â€” <span class="mono" style="color:var(--green)">${esc(a.username)}</span>
            <div class="ph-r">
              <div style="display:flex;align-items:center;gap:4px">
                <div style="width:50px;height:5px;background:var(--win-border);border-radius:2px">
                  <div style="width:${lvl.pct}%;height:100%;background:${lvl.color};border-radius:2px"></div>
                </div>
                <span style="font-size:9px;font-weight:700;color:${lvl.color}">${lvl.label} ${score}pts</span>
              </div>
            </div>
          </div>
          <div class="panel-body">
            <div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px">
              ${(pdata.warmupActions||[]).map(actionKey => {
                const action = WARMUP_ACTIONS[actionKey] || {label:actionKey, points:1};
                const done = log.some(l => l.action === actionKey);
                return `<button class="tbtn ${done?'stop':''}" style="font-size:8px;padding:2px 5px" onclick="ac_logWarmup(${pidx},'${actionKey}',this)">
                  ${done?'âœ“':''} ${esc(action.label)} <span style="color:var(--text3)">(+${action.points})</span>
                </button>`;
              }).join('')}
            </div>
            ${log.length ? `<div style="font-size:9px;color:var(--text3)">${log.slice(-3).map(l=>`<div>âœ“ ${l.action} â€” ${l.date}</div>`).join('')}${log.length>3?`<div>+${log.length-3} more</div>`:''}</div>` : ''}
          </div>
        </div>`;
      }).join('') || '<div class="panel"><div class="panel-body mono xs tm">No verified accounts yet. Complete the automation pipeline first.</div></div>'}
    </div>
  </div>`;
}

// â”€â”€ PIPELINE HELPER ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function ac_copyCard_by_id(escapedId){
  const card = document.getElementById('accard-' + escapedId);
  if(!card) return;
  // Find account by matching id
  const rawId = Object.keys(AC_PIPELINE_LOG).find(k => CSS.escape(k) === escapedId) ||
    APP.accounts.map(ac_pipelineId).find(k => CSS.escape(k) === escapedId);
  if(!rawId) { log('Could not find account to copy','warn'); return; }
  const [platform, username, email] = rawId.split('::');
  const a = APP.accounts.find(acc => acc.platform === platform && acc.username === username && acc.email === email);
  if(!a) return;
  const text = `Platform: ${a.platform}\nUsername: ${a.username}\nEmail: ${a.email}\nPassword: ${a.password}${a.bio?'\nBio: '+a.bio:''}${a.verifyLink?'\nVerify: '+a.verifyLink:''}`;
  navigator.clipboard.writeText(text).then(() => log(`Copied credentials for ${a.username}`, 'ok'));
}

function ac_manualMarkVerified_by_id(escapedId){
  const rawId = APP.accounts.map(ac_pipelineId).find(k => CSS.escape(k) === escapedId);
  if(!rawId) return;
  const [platform, username, email] = rawId.split('::');
  const a = APP.accounts.find(acc => acc.platform === platform && acc.username === username && acc.email === email);
  if(!a) return;
  a.emailVerified = true;
  a.status = 'verified';
  ac_pipelineSetStage(a, 'saved', 'Manually marked as verified âœ“');
}

async function ac_retryPoll_by_id(escapedId){
  const rawId = APP.accounts.map(ac_pipelineId).find(k => CSS.escape(k) === escapedId);
  if(!rawId) return;
  const [platform, username, email] = rawId.split('::');
  const a = APP.accounts.find(acc => acc.platform === platform && acc.username === username && acc.email === email);
  if(!a || !a.isTempMail) return;
  ac_pipelineSetStage(a, 'awaiting_verify', `Re-polling inbox: ${a.email}`);
  const providerIdx = TMPMAIL_PROVIDERS.findIndex(p => a.email.includes(p.domain));
  const emailData = { address: a.email, token: a.tmpMailToken || null, providerIdx: providerIdx >= 0 ? providerIdx : 0 };
  const result = await ac_pollInbox(emailData, ['verify','confirm','activate','welcome','click'], 12, 4000);
  if(result.found){
    a.emailVerified = true;
    a.status = 'verified';
    a.verifyLink = result.verifyLink || null;
    ac_pipelineSetStage(a, 'saved', 'âœ“ Verified via re-poll!', result.verifyLink);
    render_account_creator(document.getElementById('page-account_creator'));
  } else {
    ac_pipelineSetStage(a, 'manual_verify', 'Still no email â€” open verify link manually');
  }
}

function ac_autoFillInboxCheck(){
  const addr = document.getElementById('tm-address-display')?.textContent;
  if(addr && addr !== 'â€”'){
    const checkInput = document.getElementById('tm-check-addr');
    if(checkInput) checkInput.value = addr;
    ac_pollAndShow();
  }
}

function ac_toggleStageFilter(el, stage){
  el.classList.toggle('on');
  const grid = document.getElementById('ac-pipeline-grid');
  if(!grid) return;
  const activeStages = [...document.querySelectorAll('#ac-stage-filter .chip.on')].map(c => c.dataset.stage);
  [...grid.querySelectorAll('[id^="accard-"]')].forEach(card => {
    // Stage is encoded in badge text â€” find matching account
    const badge = card.querySelector('.ac-stage-badge');
    if(!badge) return;
    if(activeStages.length === 0){ card.style.display = ''; return; }
    const stageMatch = Object.entries(AC_PIPELINE_STAGES).find(([k,v]) => badge.textContent.includes(v.label));
    if(stageMatch && activeStages.includes(stageMatch[0])){ card.style.display = ''; }
    else if(!stageMatch){ card.style.display = ''; }
    else { card.style.display = 'none'; }
  });
}

// â”€â”€ WARM-UP FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ac_logWarmup(idx, actionKey, btn){
  const a = APP.accounts[idx]; if(!a) return;
  if(!a.warmupLog) a.warmupLog = [];
  const already = a.warmupLog.some(l => l.action === actionKey);
  if(already){
    a.warmupLog = a.warmupLog.filter(l => l.action !== actionKey);
    if(btn) btn.classList.remove('stop');
  } else {
    a.warmupLog.push({action:actionKey, date:today(), points:(WARMUP_ACTIONS[actionKey]||{points:1}).points});
    if(btn) btn.classList.add('stop');
  }
  SS.set('rf_accounts', APP.accounts);
  log(`[Warmup] ${a.username} @ ${a.platform}: ${actionKey} ${already?'removed':'logged'}`, 'info');
}

async function ac_runWarmup(){
  const cold = APP.accounts.filter(a => (a.emailVerified || a.pipelineStage === 'saved') && ac_warmupScore(a) < 15);
  if(!cold.length){ log('No cold verified accounts to warm up','warn'); return; }
  log(`[Warmup] Starting warm-up for ${cold.length} accounts`, 'info');
  setStatus('Running warm-up...');
  for(const a of cold){
    if(APP.stopFlag) break;
    if(!a.warmupLog) a.warmupLog = [];
    const pdata = AC_PLATFORMS[a.platform] || {warmupActions:[]};
    const pending = (pdata.warmupActions||[]).filter(action => !a.warmupLog.some(l => l.action === action));
    if(pending.length){
      const action = pending[0];
      const actionData = WARMUP_ACTIONS[action] || {points:1};
      a.warmupLog.push({action, date:today(), points:actionData.points});
      log(`[Warmup] ${a.username} @ ${a.platform}: queued ${action} (+${actionData.points}pts)`, 'info');
      await sleep(rand(300, 800));
    }
  }
  SS.set('rf_accounts', APP.accounts);
  setStatus('Done');
  log('[Warmup] Queue processed', 'ok');
  render_account_creator(document.getElementById('page-account_creator'));
}

// â”€â”€ STATUS MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ac_markRegistered(idx){
  const a = APP.accounts[idx]; if(!a) return;
  a.status = a.status === 'registered' ? 'created' : 'registered';
  if(a.status === 'registered' && !a.warmupLog) a.warmupLog = [];
  SS.set('rf_accounts', APP.accounts);
  log(`${a.username} @ ${a.platform} â†’ ${a.status}`, 'ok');
  render_account_creator(document.getElementById('page-account_creator'));
}

function ac_markVerified(idx){
  const a = APP.accounts[idx]; if(!a) return;
  a.emailVerified = true;
  a.status = 'verified';
  ac_pipelineSetStage(a, 'saved', 'Manually marked as verified âœ“');
  SS.set('rf_accounts', APP.accounts);
  log(`${a.username} email verified (manual)`, 'ok');
  render_account_creator(document.getElementById('page-account_creator'));
}

function ac_copyCard(idx){
  const a = APP.accounts[idx]; if(!a) return;
  const text = `Platform: ${a.platform}\nUsername: ${a.username}\nEmail: ${a.email}\nPassword: ${a.password}${a.bio?'\nBio: '+a.bio:''}${a.verifyLink?'\nVerify: '+a.verifyLink:''}`;
  navigator.clipboard.writeText(text).then(() => log(`Copied credentials for ${a.username}`, 'ok'));
}

function ac_copyAll(){
  const text = APP.accounts.map(a => `${a.platform} | ${a.username} | ${a.email} | ${a.password} | ${a.emailVerified?'verified':'unverified'}`).join('\n');
  navigator.clipboard.writeText(text).then(() => log(`Copied ${APP.accounts.length} account credentials`, 'ok'));
}

function ac_toggleEmailFields(){
  const src = (document.getElementById('ac-emailsrc')||{value:'tempmail'}).value;
  const field = document.getElementById('ac-domain-field');
  if(field) field.style.display = src === 'tempmail' ? 'none' : 'block';
}

// â”€â”€ TEMP MAIL FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ac_genAndShowEmail(){
  const providerIdx = parseInt((document.getElementById('tm-provider')||{value:0}).value) || 0;
  log(`[TempMail] Generating address via ${TMPMAIL_PROVIDERS[providerIdx].name}...`, 'info');
  const result = await ac_genTempEmail(providerIdx);
  const box = document.getElementById('tm-address-box');
  const display = document.getElementById('tm-address-display');
  const checkInput = document.getElementById('tm-check-addr');
  if(display) display.textContent = result.address;
  if(box) box.style.display = 'block';
  if(checkInput) checkInput.value = result.address;
  log(`[TempMail] Address ready: ${result.address} (${result.provider})`, 'ok');
}

async function ac_pollAndShow(){
  const addr = (document.getElementById('tm-check-addr')||{value:''}).value.trim();
  if(!addr){ log('Enter an email address to poll','err'); return; }
  const kws = ['verify','confirm','activate','welcome','click','complete'];
  const attempts = parseInt((document.getElementById('tm-attempts')||{value:15}).value) || 15;
  const interval = parseInt((document.getElementById('tm-interval')||{value:5}).value) || 5;
  const providerIdx = TMPMAIL_PROVIDERS.findIndex(p => addr.includes(p.domain));
  const emailData = {address:addr, token:null, providerIdx:providerIdx>=0?providerIdx:1};
  const resultDiv = document.getElementById('tm-result');
  if(resultDiv){ resultDiv.style.display='block'; resultDiv.className='notice ni-b'; resultDiv.textContent=`Polling ${addr}â€¦`; }
  APP.stopFlag = false;
  const result = await ac_pollInbox(emailData, kws, attempts, interval*1000);
  if(resultDiv){
    resultDiv.className = `notice ${result.found?'ni-g':'ni-r'}`;
    if(result.found){
      resultDiv.innerHTML = `<strong>âœ“ Verification email found!</strong> (attempt ${result.attempt})<br>
        ${result.verifyLink ? `<a href="${result.verifyLink}" target="_blank" style="color:var(--green);font-family:var(--mono);font-size:9px;word-break:break-all">ğŸ”— ${result.verifyLink.slice(0,80)}â€¦</a>` : '<em>No direct link in excerpt â€” check inbox manually</em>'}`;
      log(`[TempMail] âœ“ Verify email found after ${result.attempt} attempts`, 'ok');
    } else {
      resultDiv.textContent = `âœ— No verification email after ${attempts} attempts. Reason: ${result.reason||'timeout'}. Try increasing attempts or polling again.`;
      log('[TempMail] No email found after polling','warn');
    }
  }
}

async function ac_quickPollAccount(idx){
  const a = APP.accounts[idx]; if(!a || !a.isTempMail) return;
  log(`[TempMail] Quick-poll for ${a.username} (${a.email})`, 'info');
  const providerIdx = TMPMAIL_PROVIDERS.findIndex(p => a.email.includes(p.domain));
  const emailData = {address:a.email, token:a.tmpMailToken||null, providerIdx:providerIdx>=0?providerIdx:0};
  const result = await ac_pollInbox(emailData, ['verify','confirm','activate','welcome','click'], 8, 4000);
  if(result.found){
    a.emailVerified = true;
    a.status = 'verified';
    a.verifyLink = result.verifyLink || null;
    ac_pipelineSetStage(a, 'saved', 'âœ“ Verified via quick-poll!', result.verifyLink);
    render_account_creator(document.getElementById('page-account_creator'));
  } else {
    log(`${a.username}: no verify email yet (${result.reason||'not found'})`, 'info');
  }
}

// â”€â”€ EXPORT / CLEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ac_export(){
  dlCSV(
    'Platform,Username,Email,Password,Bio,PipelineStage,EmailVerified,TempMail,WarmupScore,VerifyLink,ReadyDate\n' +
    APP.accounts.map(a => {
      const score = ac_warmupScore(a);
      const readyDate = a.createdDate && a.daysToAge ? new Date(new Date(a.createdDate).getTime() + a.daysToAge*86400000).toLocaleDateString() : 'â€”';
      return `"${a.platform}","${a.username}","${a.email}","${a.password}","${(a.bio||'').replace(/"/g,"'")}","${a.pipelineStage||''}","${a.emailVerified?'yes':'no'}","${a.isTempMail?'yes':'no'}","${score}","${a.verifyLink||''}","${readyDate}"`;
    }).join('\n'),
    'accounts_export.csv'
  );
  log(`Exported ${APP.accounts.length} accounts`, 'ok');
}
function ac_clear(){ if(!confirm(`Delete all ${APP.accounts.length} accounts?`)) return; APP.accounts=[]; AC_PIPELINE_LOG={}; SS.set('rf_accounts',[]); render_account_creator(document.getElementById('page-account_creator')); log('Accounts cleared','warn'); }


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINK INDEXER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINK INDEXER v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Multiple IndexNow key hosts for rotation
const LI_INDEXNOW_HOSTS = [
  'api.indexnow.org',
  'www.bing.com',
  'search.seznam.cz',
  'yandex.com',
];

// Drip scheduler state
const LI_DRIP_KEY = 'rf_li_drip';
function li_dripGet(){ try{ return JSON.parse(localStorage.getItem(LI_DRIP_KEY)||'null'); }catch(e){ return null; } }
function li_dripSave(d){ try{ localStorage.setItem(LI_DRIP_KEY, JSON.stringify(d)); }catch(e){} }
function li_dripClear(){ localStorage.removeItem(LI_DRIP_KEY); }

// Dedup: don't re-index same URL within 24h
function li_recentlyIndexed(url){
  const results = SS.get('rf_idx_results',[]);
  const cutoff = Date.now() - 86400000;
  return results.some(r=>r.url===url && new Date(r.date).getTime()>cutoff);
}

let _liTab = 'submit'; // 'submit'|'sitemap'|'drip'|'verify'

function render_link_indexer(el){
  const results = SS.get('rf_idx_results',[]);
  const drip = li_dripGet();
  const ok = results.filter(r=>r.status==='ok').length;
  const err = results.filter(r=>r.status==='err').length;
  const t1Links = APP.links.filter(l=>l.tier==='1'||l.tier===1);
  const t2t3Links = APP.links.filter(l=>l.tier==='2'||l.tier==='3'||l.tier===2||l.tier===3);

  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;flex-wrap:wrap">
    ${[['submit','ğŸ“¡ Submit'],['sitemap','ğŸ—º Sitemap'],['drip','ğŸ’§ Drip'],['verify','ğŸ” Verify']].map(([t,l])=>`
    <div onclick="_liTab='${t}';render_link_indexer(document.getElementById('page-link_indexer'))"
      style="padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;
      background:${_liTab===t?'var(--win-panel2)':'transparent'};border:1px solid ${_liTab===t?'var(--win-border)':'transparent'};
      border-bottom-color:${_liTab===t?'var(--win-panel2)':'transparent'};color:${_liTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      <span class="badge bg">OK: ${ok}</span>
      <span class="badge br">Failed: ${err}</span>
      ${drip?`<span class="badge by">ğŸ’§ Drip active</span>`:''}
    </div>
  </div>

  ${_liTab==='submit'?`
  <!-- â•â•â• SUBMIT TAB â•â•â• -->
  <div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ“¡ Link Indexer v2 <span class="badge bg">v2</span></div>
      <div class="panel-body">
        <div class="flex g6" style="margin-bottom:6px;flex-wrap:wrap">
          <button class="tbtn" onclick="li_loadLinks()">ğŸ“‹ All Links (${APP.links.length})</button>
          <button class="tbtn" onclick="li_loadTier('t2t3')" title="Submit T2/T3 first â€” they take longer to index">âš¡ T2+T3 First (${t2t3Links.length})</button>
          <button class="tbtn" onclick="li_loadTier('t1')">ğŸ¯ T1 Only (${t1Links.length})</button>
          <button class="tbtn" onclick="li_loadFromList()">ğŸ“‹ From URL List (${APP.urlList.length})</button>
        </div>
        <div class="fg"><label class="lbl">URLs to Index (one per line)</label>
          <textarea id="li-urls" rows="7" placeholder="https://yourpage.github.io/vpn/&#10;https://medium.com/@user/article&#10;https://reddit.com/r/..."></textarea></div>

        <div class="g2" style="margin-top:8px">
          <div>
            <div class="lbl" style="margin-bottom:4px">Methods</div>
            <div style="display:flex;flex-direction:column;gap:5px">
              ${[
                ['IndexNow (batch API)','li-indexnow','on','Submits all URLs in one batch POST'],
                ['IndexNow Key Rotation','li-inow-rotate','on','Rotates across Bing/Yandex/Seznam hosts'],
                ['Google Sitemap Ping','li-google','on','Classic /ping?sitemap= endpoint'],
                ['Bing Sitemap Ping','li-bing','on','Bing ping endpoint'],
                ['Backlink Pinger','li-backlink','on','Fetch linking page via CORS proxy to warm cache'],
                ['Google Indexing API','li-gindex','off','For publisher pages â€” requires OAuth token'],
                ['RSS Feed Submit','li-rss','off','Generate RSS from URLs and submit'],
              ].map(([n,id,def,tip])=>`<label style="display:flex;align-items:center;gap:7px;cursor:pointer" title="${tip}">
                <input type="checkbox" id="${id}" ${def==='on'?'checked':''} style="width:auto;accent-color:var(--green)">
                <span class="mono xs">${n}</span>
                <span style="font-size:9px;color:var(--text3)">${tip}</span>
              </label>`).join('')}
            </div>
          </div>
          <div>
            <div class="fg"><label class="lbl">IndexNow API Key</label>
              <input type="text" id="li-key" placeholder="Your IndexNow key" value="${SS.raw('rf_indexnow_key')}"/></div>
            <div class="fg" style="margin-top:6px"><label class="lbl">Google Indexing API OAuth Token</label>
              <input type="password" id="li-gindex-token" placeholder="Bearer token from Google OAuth" value="${SS.raw('rf_gindex_token','')}"/></div>
            <div class="notice ni-b" style="margin-top:6px">IndexNow free at indexnow.org Â· Google Indexing API limited to publisher/job pages.</div>
            <div class="notice ni-y" style="margin-top:4px">ğŸ’¡ Submit T2/T3 links first â€” they need more time to index. Use "T2+T3 First" button above.</div>
          </div>
        </div>

        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="start_link_indexer()">ğŸ“¡ Submit All Now</button>
          <button class="tbtn" onclick="li_batchIndexNow()">âš¡ Batch IndexNow</button>
          <button class="tbtn" onclick="li_export()">ğŸ“¥ Export</button>
          <button class="tbtn" onclick="li_clear()">ğŸ—‘ Clear</button>
        </div>
        <div class="prog-wrap"><div class="prog-fill" id="li-prog"></div></div>
      </div>
    </div>

    <!-- Stats panel -->
    <div class="panel">
      <div class="panel-head">ğŸ“Š Indexing Stats</div>
      <div class="panel-body">
        <div class="g2" style="margin-bottom:10px">
          <div class="stat"><div class="stat-v sv-g">${ok}</div><div class="stat-l">Accepted</div></div>
          <div class="stat"><div class="stat-v sv-r">${err}</div><div class="stat-l">Failed</div></div>
        </div>
        <div style="font-size:10px;color:var(--text2);line-height:2;font-family:var(--mono)">
          Total submissions: <span style="color:var(--text)">${results.length}</span><br>
          Unique URLs: <span style="color:var(--text)">${new Set(results.map(r=>r.url)).size}</span><br>
          Last run: <span style="color:var(--text)">${results.length?results[results.length-1].date:'â€”'}</span><br>
          T2/T3 pending: <span style="color:var(--yellow)">${t2t3Links.length}</span><br>
          T1 pending: <span style="color:var(--green)">${t1Links.length}</span>
        </div>
        ${drip?`<div class="notice ni-y" style="margin-top:8px">ğŸ’§ Drip active: ${drip.remaining} URLs remaining Â· ${drip.perDay}/day</div>`:''}
      </div>
    </div>
  </div>

  <!-- Results table -->
  ${results.length?`
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">Submission Log <span class="badge bg">${results.length}</span>
      <div class="ph-r"><button class="tbtn" onclick="li_clear()" style="font-size:10px">ğŸ—‘ Clear</button></div>
    </div>
    <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
      <thead><tr><th>URL</th><th>Method</th><th>Status</th><th>Response</th><th>Date</th></tr></thead>
      <tbody>${results.slice(-80).reverse().map(r=>`<tr>
        <td class="mono xs"><a href="${esc(r.url)}" target="_blank" title="${esc(r.url)}">${esc((r.url||'').slice(0,50))}â€¦</a></td>
        <td><span class="badge bgray" style="font-size:8px">${esc(r.method)}</span></td>
        <td><span class="badge ${r.status==='ok'?'bg':'br'}">${r.status}</span></td>
        <td class="mono xs" style="font-size:9px;color:var(--text3)">${esc(r.response||'â€”')}</td>
        <td class="mono xs tm">${esc(r.date)}</td>
      </tr>`).join('')}</tbody>
    </table></div></div>
  </div>`:''}
  `:''}

  ${_liTab==='sitemap'?`
  <!-- â•â•â• SITEMAP TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ—º On-the-fly Sitemap Generator & Submitter</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Generates a valid sitemap.xml from your URL list, lets you download it, and submits it to Google/Bing â€” more efficient than individual URL pings.</div>
      <div class="g3">
        <div class="fg"><label class="lbl">Base Domain (for sitemap loc)</label>
          <input type="text" id="li-sm-domain" placeholder="yoursite.github.io" value="${SS.raw('rf_li_sm_domain','')}"/></div>
        <div class="fg"><label class="lbl">Priority</label>
          <select id="li-sm-priority"><option value="1.0">1.0 â€” Homepage</option><option value="0.8" selected>0.8 â€” High</option><option value="0.6">0.6 â€” Normal</option><option value="0.4">0.4 â€” Low</option></select></div>
        <div class="fg"><label class="lbl">Change Frequency</label>
          <select id="li-sm-freq"><option>daily</option><option selected>weekly</option><option>monthly</option></select></div>
      </div>
      <div class="fg" style="margin-top:6px"><label class="lbl">URLs to include (one per line â€” or leave blank to use all built links)</label>
        <textarea id="li-sm-urls" rows="6" placeholder="Leave blank to use all ${APP.links.length} built links automatically"></textarea></div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="li_generateSitemap()">ğŸ—º Generate & Download</button>
        <button class="tbtn" onclick="li_submitSitemap()">ğŸ“¡ Submit to Google + Bing</button>
      </div>
      <div id="li-sm-preview" style="display:none;margin-top:10px" class="panel">
        <div class="panel-head">Sitemap Preview <div class="ph-r"><button class="tbtn" onclick="navigator.clipboard.writeText(document.getElementById('li-sm-ta').value).then(()=>log('Copied','ok'))" style="font-size:10px">ğŸ“‹ Copy</button></div></div>
        <div class="panel-body" style="padding:6px"><textarea id="li-sm-ta" rows="12" style="width:100%;font-family:var(--mono);font-size:9px;background:#0a0a0a;border:1px solid var(--win-border);color:var(--text);padding:6px;border-radius:2px"></textarea></div>
      </div>
    </div>
  </div>
  `:''}

  ${_liTab==='drip'?`
  <!-- â•â•â• DRIP TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ’§ Drip Submission Scheduler</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Submit X URLs per day instead of all at once. Natural drip pattern avoids sudden crawl budget spikes. Saves state across sessions.</div>
      ${drip?`
      <div class="notice ni-g" style="margin-bottom:8px">âœ… Active drip: <b>${drip.remaining}</b> URLs remaining Â· <b>${drip.perDay}</b>/day Â· Started ${drip.startDate}</div>
      <div class="flex g6" style="margin-bottom:8px">
        <button class="tbtn go" onclick="li_dripRunToday()">â–¶ Submit Today's Batch</button>
        <button class="tbtn" onclick="li_dripClearUI()">ğŸ—‘ Cancel Drip</button>
      </div>
      <div style="font-size:10px;color:var(--text2);font-family:var(--mono);line-height:1.8">
        Total URLs: ${drip.total} Â· Submitted: ${drip.submitted} Â· Remaining: ${drip.remaining}<br>
        Per day: ${drip.perDay} Â· Est. completion: ${drip.estComplete}
      </div>`:`
      <div class="fg"><label class="lbl">URLs to drip-submit (one per line â€” or load built links)</label>
        <textarea id="li-drip-urls" rows="7" placeholder="https://..."></textarea></div>
      <div class="flex g6" style="margin-bottom:6px">
        <button class="tbtn" onclick="document.getElementById('li-drip-urls').value=APP.links.map(l=>l.url).join('\\n')">ğŸ“‹ Load All Links</button>
        <button class="tbtn" onclick="document.getElementById('li-drip-urls').value=APP.links.filter(l=>l.tier==='2'||l.tier==='3').map(l=>l.url).join('\\n')">âš¡ T2+T3 Only</button>
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">URLs per day</label><input type="number" id="li-drip-per-day" value="10" min="1" max="200"/></div>
        <div class="fg"><label class="lbl">Methods</label>
          <select id="li-drip-method"><option value="indexnow">IndexNow</option><option value="google">Google Ping</option><option value="both">Both</option></select></div>
        <div style="display:flex;align-items:flex-end"><button class="tbtn go" onclick="li_dripSetup()">ğŸ’§ Setup Drip</button></div>
      </div>`}
    </div>
  </div>
  `:''}

  ${_liTab==='verify'?`
  <!-- â•â•â• VERIFY TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ” Indexing Status Verification</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Checks if URLs appear in Google via the "site:" operator using the CORS proxy. For full GSC verification, use the GSC Inspector tool.</div>
      <div class="fg"><label class="lbl">URLs to verify (one per line)</label>
        <textarea id="li-ver-urls" rows="6" placeholder="https://yourpage.github.io/vpn/&#10;https://medium.com/@user/article"></textarea></div>
      <div class="flex g6 mt6">
        <button class="tbtn go" onclick="li_verifyIndexed()">ğŸ” Check Indexed</button>
        <button class="tbtn" onclick="document.getElementById('li-ver-urls').value=APP.links.map(l=>l.url).join('\\n')">ğŸ“‹ Load Built Links</button>
        <button class="tbtn" onclick="li_exportVerify()">ğŸ“¥ Export</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="li-ver-prog"></div></div>
      <div id="li-ver-results" style="margin-top:8px"></div>
    </div>
  </div>
  `:''}
  `;
}

// â”€â”€â”€ Load helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function li_loadLinks(){ const ta=document.getElementById('li-urls');if(ta)ta.value=APP.links.map(l=>l.url).join('\n');log(`Loaded ${APP.links.length} built links`,'ok'); }
function li_loadFromList(){ const ta=document.getElementById('li-urls');if(ta)ta.value=APP.urlList.join('\n');log(`Loaded ${APP.urlList.length} URLs from list`,'ok'); }
function li_loadTier(t){
  const ta=document.getElementById('li-urls');if(!ta)return;
  const links = t==='t1'
    ? APP.links.filter(l=>l.tier==='1'||l.tier===1)
    : APP.links.filter(l=>l.tier==='2'||l.tier==='3'||l.tier===2||l.tier===3);
  ta.value=links.map(l=>l.url).join('\n');
  log(`Loaded ${links.length} ${t==='t1'?'T1':'T2+T3'} links â€” ${t==='t1'?'direct money site links':'submit first, they take longer to index'}`,'ok');
}

// â”€â”€â”€ Batch IndexNow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function li_batchIndexNow(){
  const raw=(document.getElementById('li-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs to batch-submit','err');return;}
  const urls=raw.split('\n').map(u=>u.trim()).filter(u=>u.startsWith('http'));
  if(!urls.length){log('No valid URLs','err');return;}
  let key=(document.getElementById('li-key')||{value:''}).value.trim()||SS.raw('rf_indexnow_key','');
  if(!key){key='rankforge-'+rand(100000,999999);SS.rawSet('rf_indexnow_key',key);}
  const useRotation=(document.getElementById('li-inow-rotate')||{checked:true}).checked;
  const hosts=useRotation?LI_INDEXNOW_HOSTS:['api.indexnow.org'];
  const results=SS.get('rf_idx_results',[]);
  log(`Batch IndexNow: ${urls.length} URLs across ${hosts.length} hosts`,'info');
  // Group by hostname
  const byHost={};
  urls.forEach(u=>{ try{const h=new URL(u).hostname;if(!byHost[h])byHost[h]=[];byHost[h].push(u);}catch(e){} });
  let submitted=0;
  for(const [siteHost,siteUrls] of Object.entries(byHost)){
    for(const apiHost of hosts){
      try{
        const resp=await fetch(`https://${apiHost}/indexnow`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({host:siteHost,key,keyLocation:`https://${siteHost}/${key}.txt`,urlList:siteUrls}),
          signal:AbortSignal.timeout(8000)
        });
        const status=resp.status===200||resp.status===202?'ok':'err';
        siteUrls.forEach(u=>results.push({url:u,method:`IndexNow(${apiHost})`,status,response:`HTTP ${resp.status}`,date:today()}));
        log(`Batch IndexNow â†’ ${apiHost}: ${siteUrls.length} URLs from ${siteHost} â†’ HTTP ${resp.status}`,status==='ok'?'ok':'warn');
        submitted+=siteUrls.length;
        APP.stats.success+=status==='ok'?siteUrls.length:0;
        APP.stats.failed+=status!=='ok'?siteUrls.length:0;
      }catch(e){
        siteUrls.forEach(u=>results.push({url:u,method:`IndexNow(${apiHost})`,status:'err',response:e.message,date:today()}));
        log(`Batch IndexNow failed (${apiHost}): ${e.message}`,'err');
      }
    }
    await sleep(300);
  }
  SS.set('rf_idx_results',results);
  APP.stats.processed+=submitted;updateStats();
  log(`Batch IndexNow complete: ${submitted} URLs submitted`,'ok');
  render_link_indexer(document.getElementById('page-link_indexer'));
}

// â”€â”€â”€ Main submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function start_link_indexer(){
  const raw=(document.getElementById('li-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs','err');return;}
  let urls=raw.split('\n').map(u=>u.trim()).filter(Boolean);
  const useIndexNow=(document.getElementById('li-indexnow')||{checked:true}).checked;
  const useRotation=(document.getElementById('li-inow-rotate')||{checked:true}).checked;
  const useGoogle=(document.getElementById('li-google')||{checked:true}).checked;
  const useBing=(document.getElementById('li-bing')||{checked:true}).checked;
  const useBacklink=(document.getElementById('li-backlink')||{checked:true}).checked;
  const useGIndex=(document.getElementById('li-gindex')||{checked:false}).checked;
  const useRss=(document.getElementById('li-rss')||{checked:false}).checked;
  let key=(document.getElementById('li-key')||{value:''}).value.trim()||SS.raw('rf_indexnow_key','');
  if(!key){key='rankforge-'+rand(100000,999999);SS.rawSet('rf_indexnow_key',key);}
  SS.rawSet('rf_indexnow_key',key);
  const gToken=(document.getElementById('li-gindex-token')||{value:''}).value.trim()||SS.raw('rf_gindex_token','');
  if(gToken) SS.rawSet('rf_gindex_token',gToken);

  // Filter already-indexed in last 24h
  const newUrls=urls.filter(u=>!li_recentlyIndexed(u));
  if(newUrls.length<urls.length) log(`Skipped ${urls.length-newUrls.length} URLs already indexed in last 24h`,'info');
  urls=newUrls;
  if(!urls.length){log('All URLs already submitted in last 24h','warn');return;}

  // RSS generation if enabled
  if(useRss) await li_generateAndSubmitRss(urls,key);

  const prog=document.getElementById('li-prog');
  const results=SS.get('rf_idx_results',[]);
  APP.running=true;APP.stopFlag=false;setStatus('Indexing...');
  log(`Submitting ${urls.length} URLs (${useRotation?'rotating hosts':'single host'})...`,'info');

  const apiHosts=useRotation?LI_INDEXNOW_HOSTS:['api.indexnow.org'];

  for(let i=0;i<urls.length;i++){
    if(APP.stopFlag)break;
    const url=urls[i];
    if(prog)prog.style.width=Math.round(((i+1)/urls.length)*100)+'%';
    setProgress(Math.round(((i+1)/urls.length)*100),`${i+1}/${urls.length}`);
    let host; try{host=new URL(url).hostname;}catch(e){host='unknown';}

    // Backlink pinger â€” fetch the page first to warm cache/trigger crawl
    if(useBacklink){
      try{
        await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(6000)});
        results.push({url,method:'Backlink Ping',status:'ok',response:'Cache warmed',date:today()});
        log(`Cache warm â†’ ${url.slice(0,45)}`,'ok');APP.stats.success++;
      }catch(e){ results.push({url,method:'Backlink Ping',status:'err',response:e.message.slice(0,40),date:today()}); }
    }

    // IndexNow (single URL with host rotation)
    if(useIndexNow){
      const apiHost=apiHosts[i%apiHosts.length];
      try{
        const resp=await fetch(`https://${apiHost}/indexnow`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({host,key,keyLocation:`https://${host}/${key}.txt`,urlList:[url]}),
          signal:AbortSignal.timeout(6000)
        });
        const ok=resp.status===200||resp.status===202;
        results.push({url,method:`IndexNow(${apiHost})`,status:ok?'ok':'err',response:`HTTP ${resp.status}`,date:today()});
        log(`IndexNow(${apiHost}) â†’ ${url.slice(0,40)} â†’ ${resp.status}`,ok?'ok':'warn');
        ok?APP.stats.success++:APP.stats.failed++;
      }catch(e){results.push({url,method:'IndexNow',status:'err',response:e.message.slice(0,40),date:today()});APP.stats.failed++;}
    }

    // Google Sitemap Ping
    if(useGoogle){
      try{
        const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.google.com/ping?sitemap='+encodeURIComponent(url))}`,{signal:AbortSignal.timeout(5000)});
        const ok=resp.ok;
        results.push({url,method:'Google Ping',status:ok?'ok':'err',response:ok?'200 OK':`HTTP ${resp.status}`,date:today()});
        log(`Google ping â†’ ${url.slice(0,40)}`,ok?'ok':'warn');
        ok?APP.stats.success++:APP.stats.failed++;
      }catch(e){results.push({url,method:'Google Ping',status:'err',response:e.message.slice(0,40),date:today()});APP.stats.failed++;}
    }

    // Bing Ping
    if(useBing){
      try{
        const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.bing.com/ping?sitemap='+encodeURIComponent(url))}`,{signal:AbortSignal.timeout(5000)});
        const ok=resp.ok;
        results.push({url,method:'Bing Ping',status:ok?'ok':'err',response:ok?'200 OK':`HTTP ${resp.status}`,date:today()});
        log(`Bing ping â†’ ${url.slice(0,40)}`,ok?'ok':'warn');
        ok?APP.stats.success++:APP.stats.failed++;
      }catch(e){results.push({url,method:'Bing Ping',status:'err',response:e.message.slice(0,40),date:today()});APP.stats.failed++;}
    }

    // Google Indexing API
    if(useGIndex&&gToken){
      try{
        const resp=await fetch('https://indexing.googleapis.com/v3/urlNotifications:publish',{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+gToken},
          body:JSON.stringify({url,type:'URL_UPDATED'}),
          signal:AbortSignal.timeout(8000)
        });
        const ok=resp.status===200;
        const body=await resp.json().catch(()=>({}));
        results.push({url,method:'Google Indexing API',status:ok?'ok':'err',response:ok?'Notified':(body.error?.message||`HTTP ${resp.status}`).slice(0,50),date:today()});
        log(`Google Indexing API â†’ ${url.slice(0,35)} â†’ ${ok?'OK':body.error?.message||resp.status}`,ok?'ok':'warn');
        ok?APP.stats.success++:APP.stats.failed++;
      }catch(e){results.push({url,method:'Google Indexing API',status:'err',response:e.message.slice(0,40),date:today()});APP.stats.failed++;}
    }

    APP.stats.processed++;updateStats();
    roiMarkIndexed(url);
    await sleep(250);
  }

  SS.set('rf_idx_results',results);
  APP.running=false;setStatus('Done');
  runHistoryAdd('link_indexer',urls.length,results.filter(r=>r.status==='ok').length,results.filter(r=>r.status==='err').length);
  log(`âœ… Indexing done â€” ${results.filter(r=>r.status==='ok').length} accepted, ${results.filter(r=>r.status==='err').length} failed`,'ok');
  webhookSend('link_indexer','indexing_complete',{submitted:urls.length});
  render_link_indexer(document.getElementById('page-link_indexer'));
}

// â”€â”€â”€ RSS generation & submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function li_generateAndSubmitRss(urls,key){
  const domain = urls[0]?new URL(urls[0]).hostname:'rankforge.io';
  const rss=`<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>RankForge Index Feed</title>
    <link>https://${domain}/</link>
    <description>Auto-generated indexing feed</description>
    <lastBuildDate>${new Date().toUTCString()}</lastBuildDate>
    ${urls.map(u=>`<item><link>${u}</link><pubDate>${new Date().toUTCString()}</pubDate></item>`).join('\n    ')}
  </channel>
</rss>`;
  // Download the RSS file
  dlTxt(rss,'indexfeed.xml');
  // Submit to Superfeedr (WebSub hub)
  try{
    await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://push.superfeedr.com/?hub.mode=publish&hub.url=https://${domain}/indexfeed.xml`)}`,{signal:AbortSignal.timeout(5000)});
    log(`RSS feed generated (${urls.length} URLs) + submitted to Superfeedr`,'ok');
  }catch(e){
    log(`RSS generated â€” Superfeedr submission failed: ${e.message}`,'warn');
  }
}

// â”€â”€â”€ Sitemap generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function li_generateSitemap(){
  const domain=(document.getElementById('li-sm-domain')||{value:''}).value.trim();
  if(domain) SS.rawSet('rf_li_sm_domain',domain);
  const priority=(document.getElementById('li-sm-priority')||{value:'0.8'}).value;
  const freq=(document.getElementById('li-sm-freq')||{value:'weekly'}).value;
  const rawUrls=(document.getElementById('li-sm-urls')||{value:''}).value.trim();
  const urls=rawUrls?rawUrls.split('\n').map(u=>u.trim()).filter(Boolean):APP.links.map(l=>l.url);
  if(!urls.length){log('No URLs for sitemap','warn');return;}
  const date=new Date().toISOString().slice(0,10);
  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${urls.map(u=>`  <url>
    <loc>${u.replace(/&/g,'&amp;')}</loc>
    <lastmod>${date}</lastmod>
    <changefreq>${freq}</changefreq>
    <priority>${priority}</priority>
  </url>`).join('\n')}
</urlset>`;
  const ta=document.getElementById('li-sm-ta');
  const preview=document.getElementById('li-sm-preview');
  if(ta)ta.value=xml;
  if(preview)preview.style.display='block';
  dlTxt(xml,'sitemap.xml');
  log(`Sitemap generated: ${urls.length} URLs â†’ sitemap.xml downloaded`,'ok');
}

async function li_submitSitemap(){
  const domain=(document.getElementById('li-sm-domain')||{value:''}).value.trim();
  if(!domain){log('Enter your domain first','err');return;}
  const sitemapUrl=`https://${domain}/sitemap.xml`;
  const endpoints=[
    `https://www.google.com/ping?sitemap=${encodeURIComponent(sitemapUrl)}`,
    `https://www.bing.com/ping?sitemap=${encodeURIComponent(sitemapUrl)}`,
  ];
  for(const ep of endpoints){
    try{
      await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(ep)}`,{signal:AbortSignal.timeout(5000)});
      log(`Sitemap submitted â†’ ${ep.split('?')[0].replace('https://api.allorigins.win/get?url=','')}`,'ok');
    }catch(e){ log(`Sitemap submit failed: ${e.message}`,'warn'); }
  }
}

// â”€â”€â”€ Drip scheduler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function li_dripSetup(){
  const raw=(document.getElementById('li-drip-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs for drip schedule','err');return;}
  const urls=raw.split('\n').map(u=>u.trim()).filter(Boolean);
  const perDay=parseInt((document.getElementById('li-drip-per-day')||{value:10}).value)||10;
  const method=(document.getElementById('li-drip-method')||{value:'indexnow'}).value;
  const days=Math.ceil(urls.length/perDay);
  const estComplete=new Date(Date.now()+days*86400000).toISOString().slice(0,10);
  const drip={urls,submitted:0,remaining:urls.length,perDay,method,startDate:today(),estComplete,total:urls.length};
  li_dripSave(drip);
  log(`ğŸ’§ Drip set up: ${urls.length} URLs Â· ${perDay}/day Â· ~${days} days Â· est. complete ${estComplete}`,'ok');
  render_link_indexer(document.getElementById('page-link_indexer'));
}

async function li_dripRunToday(){
  const drip=li_dripGet();
  if(!drip||!drip.remaining){log('No drip active or all done','warn');return;}
  const batch=drip.urls.slice(drip.submitted,drip.submitted+drip.perDay);
  if(!batch.length){log('No URLs remaining in drip','warn');li_dripClear();return;}
  log(`ğŸ’§ Running today's drip batch: ${batch.length} URLs (method: ${drip.method})`,'info');
  const results=SS.get('rf_idx_results',[]);
  APP.running=true;APP.stopFlag=false;setStatus('Drip submitting...');
  for(let i=0;i<batch.length;i++){
    if(APP.stopFlag)break;
    const url=batch[i];
    setProgress(Math.round(((i+1)/batch.length)*100),`${i+1}/${batch.length}`);
    let host;try{host=new URL(url).hostname;}catch(e){host='unknown';}
    const key=SS.raw('rf_indexnow_key','rankforge-'+rand(100000,999999));
    if(drip.method==='indexnow'||drip.method==='both'){
      try{
        const resp=await fetch(`https://api.indexnow.org/indexnow`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({host,key,urlList:[url]}),signal:AbortSignal.timeout(6000)});
        const ok=resp.status===200||resp.status===202;
        results.push({url,method:'Drip-IndexNow',status:ok?'ok':'err',response:`HTTP ${resp.status}`,date:today()});
        log(`Drip â†’ ${url.slice(0,45)}`,ok?'ok':'warn');
        ok?APP.stats.success++:APP.stats.failed++;
      }catch(e){results.push({url,method:'Drip-IndexNow',status:'err',response:e.message.slice(0,40),date:today()});APP.stats.failed++;}
    }
    if(drip.method==='google'||drip.method==='both'){
      try{
        await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.google.com/ping?sitemap='+encodeURIComponent(url))}`,{signal:AbortSignal.timeout(5000)});
        results.push({url,method:'Drip-Google',status:'ok',response:'200 OK',date:today()});
      }catch(e){ results.push({url,method:'Drip-Google',status:'err',response:e.message.slice(0,40),date:today()}); }
    }
    APP.stats.processed++;updateStats();
    await sleep(300);
  }
  // Update drip state
  drip.submitted+=batch.length;
  drip.remaining=drip.urls.length-drip.submitted;
  if(drip.remaining<=0){li_dripClear();log('ğŸ’§ Drip complete â€” all URLs submitted','ok');}
  else{li_dripSave(drip);log(`ğŸ’§ Today's batch done â€” ${drip.remaining} remaining`,'ok');}
  SS.set('rf_idx_results',results);
  APP.running=false;setStatus('Done');
  render_link_indexer(document.getElementById('page-link_indexer'));
}

function li_dripClearUI(){ if(confirm('Cancel drip schedule?')){li_dripClear();log('Drip cancelled','warn');render_link_indexer(document.getElementById('page-link_indexer'));} }

// â”€â”€â”€ Verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _liVerResults=[];
async function li_verifyIndexed(){
  const raw=(document.getElementById('li-ver-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs to verify','err');return;}
  const urls=raw.split('\n').map(u=>u.trim()).filter(Boolean);
  _liVerResults=[];
  const prog=document.getElementById('li-ver-prog');
  const resultsEl=document.getElementById('li-ver-results');
  if(resultsEl)resultsEl.innerHTML='<div style="color:var(--text3);font-size:10px">Checking...</div>';
  APP.running=true;APP.stopFlag=false;setStatus('Verifying indexing...');
  for(let i=0;i<urls.length;i++){
    if(APP.stopFlag)break;
    const url=urls[i];
    if(prog)prog.style.width=Math.round(((i+1)/urls.length)*100)+'%';
    setProgress(Math.round(((i+1)/urls.length)*100),`${i+1}/${urls.length}`);
    let indexed=null,note='';
    try{
      // Check via allorigins proxy â€” look for the URL in Google search results
      const siteQuery=`site:${url}`;
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.google.com/search?q='+encodeURIComponent(siteQuery)+'&num=1')}`,{signal:AbortSignal.timeout(8000)});
      const data=await resp.json();
      const html=data.contents||'';
      // If Google returns 0 results or "no results" message, not indexed
      indexed=!html.includes('did not match any documents')&&!html.includes('0 results')&&html.length>5000;
      note=indexed?'Found in Google':'Not found in Google';
    }catch(e){indexed=null;note='Check failed: '+e.message.slice(0,40);}
    _liVerResults.push({url,indexed,note,date:today()});
    log(`Indexed check: ${url.slice(0,45)} â†’ ${indexed===true?'âœ“ INDEXED':indexed===false?'âœ— NOT INDEXED':'? CHECK FAILED'}`,indexed?'ok':indexed===false?'warn':'err');
    await sleep(600);
  }
  APP.running=false;setStatus('Done');
  if(resultsEl)resultsEl.innerHTML=`
  <div class="g3" style="margin-bottom:10px">
    <div class="stat"><div class="stat-v sv-g">${_liVerResults.filter(r=>r.indexed===true).length}</div><div class="stat-l">Indexed</div></div>
    <div class="stat"><div class="stat-v sv-r">${_liVerResults.filter(r=>r.indexed===false).length}</div><div class="stat-l">Not Indexed</div></div>
    <div class="stat"><div class="stat-v sv-y">${_liVerResults.filter(r=>r.indexed===null).length}</div><div class="stat-l">Unknown</div></div>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>URL</th><th>Status</th><th>Note</th><th>Date</th></tr></thead>
    <tbody>${_liVerResults.map(r=>`<tr>
      <td class="mono xs"><a href="${esc(r.url)}" target="_blank">${esc(r.url.slice(0,50))}â€¦</a></td>
      <td><span class="badge ${r.indexed===true?'bg':r.indexed===false?'br':'by'}">${r.indexed===true?'âœ“ Indexed':r.indexed===false?'âœ— Not Indexed':'? Unknown'}</span></td>
      <td class="xs" style="color:var(--text3)">${esc(r.note)}</td>
      <td class="mono xs tm">${esc(r.date)}</td>
    </tr>`).join('')}</tbody>
  </table></div>`;
  log(`Verification done: ${_liVerResults.filter(r=>r.indexed===true).length}/${urls.length} indexed`,'ok');
}

function li_exportVerify(){
  if(!_liVerResults.length){log('No verification results to export','warn');return;}
  dlCSV('URL,Indexed,Note,Date\n'+_liVerResults.map(r=>`"${r.url}","${r.indexed===true?'Yes':r.indexed===false?'No':'Unknown'}","${r.note}","${r.date}"`).join('\n'),'indexing_verification.csv');
}

function li_export(){dlCSV('URL,Method,Status,Response,Date\n'+SS.get('rf_idx_results',[]).map(r=>`"${r.url}","${r.method}","${r.status}","${r.response||''}","${r.date}"`).join('\n'),'indexed_v2.csv');}
function li_clear(){if(confirm('Clear all indexing results?')){SS.set('rf_idx_results',[]);render_link_indexer(document.getElementById('page-link_indexer'));}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PING SUBMITTER v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Blog name pool for fingerprint variation
const PS_BLOG_NAMES = [
  'Digital Insights Blog','Tech Review Hub','SEO Research Notes','Web Discovery Feed',
  'Content Publishing Journal','Marketing Intelligence Blog','Online Research Hub',
  'Expert Analysis Feed','Industry Insights Blog','Knowledge Base Hub',
  'Professional Review Site','Digital Strategy Notes',
];

// Category pool for metadata variation
const PS_CATEGORIES = [
  'Technology','Digital Marketing','SEO','Software Reviews','Online Tools',
  'Web Development','Content Strategy','Research','Business','Analysis',
];

// Full ping service registry
const PS_SERVICES_ALL = [
  {id:'pingomatic', name:'Pingomatic',        url:(u,n)=>`http://rpc.pingomatic.com/?url=${encodeURIComponent(u)}&name=${encodeURIComponent(n)}`, type:'get'},
  {id:'twingly',   name:'Twingly',            url:(u,n)=>`https://www.twingly.com/ping.xml?url=${encodeURIComponent(u)}`, type:'get'},
  {id:'blogping',  name:'BlogPing',           url:(u,n)=>`http://blogping.com/ping/?url=${encodeURIComponent(u)}&name=${encodeURIComponent(n)}`, type:'get'},
  {id:'google',    name:'Google Sitemap',     url:(u,n)=>`https://www.google.com/ping?sitemap=${encodeURIComponent(u)}`, type:'get'},
  {id:'bing',      name:'Bing Sitemap',       url:(u,n)=>`https://www.bing.com/ping?sitemap=${encodeURIComponent(u)}`, type:'get'},
  {id:'feedburner',name:'Feedburner',         url:(u,n,f)=>`https://feedburner.google.com/fb/a/pingSubmit?bloglink=${encodeURIComponent(f||u)}`, type:'get'},
  {id:'superfeedr',name:'Superfeedr (WebSub)',url:(u,n)=>`https://push.superfeedr.com/?hub.mode=publish&hub.url=${encodeURIComponent(u)}`, type:'get'},
  {id:'pubsubhubbub',name:'PubSubHubbub',     url:(u,n)=>`https://pubsubhubbub.appspot.com/?hub.mode=publish&hub.url=${encodeURIComponent(u)}`, type:'post', postData:(u)=>new URLSearchParams({'hub.mode':'publish','hub.url':u}).toString()},
  {id:'blogsearch',name:'Blog Search Hub',    url:(u,n)=>`http://blogsearch.google.com/ping/RPC2?url=${encodeURIComponent(u)}`, type:'get'},
  {id:'weblogs',   name:'Weblogs.com',        url:(u,n)=>`http://rpc.weblogs.com/RPC2?url=${encodeURIComponent(u)}&name=${encodeURIComponent(n)}`, type:'get'},
  {id:'technorati',name:'Technorati',         url:(u,n)=>`http://rpc.technorati.com/rpc/ping?url=${encodeURIComponent(u)}&name=${encodeURIComponent(n)}`, type:'get'},
  {id:'bloglines', name:'Bloglines',          url:(u,n)=>`http://www.bloglines.com/ping?url=${encodeURIComponent(u)}&name=${encodeURIComponent(n)}`, type:'get'},
  {id:'custom',    name:'Custom Endpoint',    url:(u,n,f,ep)=>ep?`${ep}?url=${encodeURIComponent(u)}&name=${encodeURIComponent(n)}`:'', type:'get'},
];

// Ping dedup â€” don't re-ping same URL+service within 24h
const PS_DEDUP_KEY='rf_ps_dedup';
function ps_recentlyPinged(url,serviceId){
  try{
    const dedup=JSON.parse(localStorage.getItem(PS_DEDUP_KEY)||'{}');
    const k=`${serviceId}||${url}`;
    return dedup[k]&&Date.now()-dedup[k]<86400000;
  }catch(e){return false;}
}
function ps_markPinged(url,serviceId){
  try{
    const dedup=JSON.parse(localStorage.getItem(PS_DEDUP_KEY)||'{}');
    dedup[`${serviceId}||${url}`]=Date.now();
    // Prune old entries
    const cutoff=Date.now()-86400000;
    Object.keys(dedup).forEach(k=>{if(dedup[k]<cutoff)delete dedup[k];});
    localStorage.setItem(PS_DEDUP_KEY,JSON.stringify(dedup));
  }catch(e){}
}

// RSS autodiscovery
async function ps_discoverRss(pageUrl){
  try{
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(pageUrl)}`,{signal:AbortSignal.timeout(8000)});
    const data=await resp.json();
    const html=data.contents||'';
    const matches=html.match(/<link[^>]+type=["']application\/rss\+xml["'][^>]+href=["']([^"']+)["']/i)
      || html.match(/<link[^>]+href=["']([^"']+)["'][^>]+type=["']application\/rss\+xml["']/i);
    if(matches&&matches[1]){
      const rssUrl=matches[1].startsWith('http')?matches[1]:new URL(matches[1],pageUrl).href;
      log(`RSS autodiscovery: found ${rssUrl}`,'ok');
      return rssUrl;
    }
    // Fallback guesses
    const base=new URL(pageUrl).origin;
    for(const guess of['/feed','/feed.xml','/rss.xml','/feed/rss','/atom.xml']){
      try{
        const r=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(base+guess)}`,{signal:AbortSignal.timeout(3000)});
        const d=await r.json();
        if(d.contents&&d.contents.includes('<rss')){log(`RSS found via guess: ${base+guess}`,'ok');return base+guess;}
      }catch(e){}
    }
    return null;
  }catch(e){return null;}
}

let _psTab='submit'; // 'submit'|'schedule'|'history'

function render_ping_submitter(el){
  const results=SS.get('rf_ping_results',[]);
  const schedules_ps=SS.get('rf_ps_schedules',[]);
  const ok=results.filter(r=>r.status==='ok').length;
  const fail=results.filter(r=>r.status!=='ok').length;

  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;flex-wrap:wrap">
    ${[['submit','ğŸ“ Submit'],['schedule','â° Schedule'],['history','ğŸ“œ History']].map(([t,l])=>`
    <div onclick="_psTab='${t}';render_ping_submitter(document.getElementById('page-ping_submitter'))"
      style="padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;
      background:${_psTab===t?'var(--win-panel2)':'transparent'};border:1px solid ${_psTab===t?'var(--win-border)':'transparent'};
      border-bottom-color:${_psTab===t?'var(--win-panel2)':'transparent'};color:${_psTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      <span class="badge bg">OK: ${ok}</span>
      <span class="badge br">Failed: ${fail}</span>
      <span class="badge by">${schedules_ps.filter(s=>s.enabled).length} scheduled</span>
    </div>
  </div>

  ${_psTab==='submit'?`
  <!-- â•â•â• SUBMIT TAB â•â•â• -->
  <div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ“ Ping Submitter v2 <span class="badge bg">v2</span></div>
      <div class="panel-body">
        <div class="g2">
          <div>
            <div class="fg"><label class="lbl">Blog/Page URL</label><input type="url" id="ps-url" placeholder="https://yourpage.github.io/vpn/"/></div>
            <div class="fg"><label class="lbl">Blog Name <span style="color:var(--text3);font-size:9px">(auto-varied per ping if blank)</span></label>
              <input type="text" id="ps-name" placeholder="Leave blank for auto-variation"/></div>
            <div style="display:flex;align-items:center;gap:8px;margin:4px 0">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
                <input type="checkbox" id="ps-autodiscover" checked style="width:auto;accent-color:var(--green)">
                <span>Auto-discover RSS feed</span></label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
                <input type="checkbox" id="ps-varyorder" checked style="width:auto;accent-color:var(--green)">
                <span>Vary ping order per run</span></label>
            </div>
            <div class="fg"><label class="lbl">RSS Feed URL <span style="color:var(--text3);font-size:9px">(auto-detected if blank)</span></label>
              <input type="url" id="ps-feed" placeholder="Auto-discovered from page â€” or enter manually"/></div>
            <div class="fg" style="margin-top:4px"><label class="lbl">Custom Ping Endpoint (optional)</label>
              <input type="url" id="ps-custom-ep" placeholder="https://your-ping-server.com/ping"/></div>
            <div class="fg"><label class="lbl">Category/Tag (for services that support it)</label>
              <input type="text" id="ps-category" placeholder="Technology, SEO, Software Reviews..."/></div>
          </div>
          <div>
            <div class="lbl" style="margin-bottom:6px">Services (${PS_SERVICES_ALL.length} available)</div>
            <div style="max-height:260px;overflow-y:auto;display:flex;flex-direction:column;gap:4px">
              ${PS_SERVICES_ALL.map(s=>`
              <label style="display:flex;align-items:center;gap:7px;cursor:pointer">
                <input type="checkbox" id="ps-svc-${s.id}" ${['pingomatic','twingly','google','bing','superfeedr','pubsubhubbub'].includes(s.id)?'checked':''} style="width:auto;accent-color:var(--green)">
                <span class="mono xs">${s.name}</span>
                ${s.id==='custom'?'<span style="font-size:9px;color:var(--text3)">(uses custom endpoint above)</span>':''}
              </label>`).join('')}
            </div>
            <div style="display:flex;gap:6px;margin-top:6px">
              <button class="tbtn" style="font-size:10px" onclick="PS_SERVICES_ALL.forEach(s=>{const el=document.getElementById('ps-svc-'+s.id);if(el)el.checked=true})">All</button>
              <button class="tbtn" style="font-size:10px" onclick="PS_SERVICES_ALL.forEach(s=>{const el=document.getElementById('ps-svc-'+s.id);if(el)el.checked=false})">None</button>
            </div>
          </div>
        </div>

        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="start_ping_submitter()">ğŸ“ Send Pings</button>
          <button class="tbtn" onclick="ps_autoPingBuiltLinks()" title="Ping all recently built links">âš¡ Auto-ping Built Links</button>
          <button class="tbtn" onclick="ps_export()">ğŸ“¥ Export</button>
          <button class="tbtn" onclick="ps_clear()">ğŸ—‘ Clear</button>
        </div>
        <div class="prog-wrap"><div class="prog-fill" id="ps-prog"></div></div>
      </div>
    </div>

    <!-- Stats -->
    <div class="panel">
      <div class="panel-head">ğŸ“Š Ping Stats</div>
      <div class="panel-body">
        <div class="g2" style="margin-bottom:10px">
          <div class="stat"><div class="stat-v sv-g">${ok}</div><div class="stat-l">Accepted</div></div>
          <div class="stat"><div class="stat-v sv-r">${fail}</div><div class="stat-l">Failed</div></div>
        </div>
        <div style="font-size:10px;color:var(--text2);line-height:2;font-family:var(--mono)">
          Total pings: ${results.length}<br>
          Unique URLs: ${new Set(results.map(r=>r.url)).size}<br>
          Services used: ${new Set(results.map(r=>r.service)).size}<br>
          Last ping: ${results.length?results[results.length-1].date:'â€”'}
        </div>
        <div class="notice ni-b" style="margin-top:8px;font-size:10px">Dedup active: same URL+service won't re-ping within 24h</div>
      </div>
    </div>
  </div>

  <!-- Recent results -->
  ${results.length?`
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">Recent Pings <span class="badge bg">${results.length}</span></div>
    <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
      <thead><tr><th>Service</th><th>URL</th><th>Blog Name</th><th>Response</th><th>Status</th><th>Date</th></tr></thead>
      <tbody>${results.slice(-60).reverse().map(r=>`<tr>
        <td class="xs">${esc(r.service)}</td>
        <td class="mono xs" title="${esc(r.url)}">${esc((r.url||'').slice(0,35))}â€¦</td>
        <td class="xs" style="color:var(--text3);font-size:9px">${esc((r.blogName||'').slice(0,20))}</td>
        <td class="xs" style="font-size:9px;color:var(--text3)">${esc(r.response||'â€”')}</td>
        <td><span class="badge ${r.status==='ok'?'bg':'br'}">${r.status==='ok'?'OK':'Fail'}</span></td>
        <td class="mono xs tm">${esc(r.date)}</td>
      </tr>`).join('')}</tbody>
    </table></div></div>
  </div>`:''}
  `:''}

  ${_psTab==='schedule'?`
  <!-- â•â•â• SCHEDULE TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">â° Scheduled Pings â€” Re-ping every N days
      <div class="ph-r"><button class="tbtn go" onclick="ps_addSchedule()" style="font-size:10px">+ Add</button></div>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Re-ping URLs automatically every X days. Checked at launch. Useful for keeping pages in crawl rotation.</div>
      <div id="ps-schedule-add" style="display:none;background:var(--win-panel2);padding:8px;border:1px solid var(--win-border);border-radius:2px;margin-bottom:8px">
        <div class="g3">
          <div class="fg"><label class="lbl">URL to ping</label><input type="url" id="ps-sch-url" placeholder="https://..."/></div>
          <div class="fg"><label class="lbl">Blog Name</label><input type="text" id="ps-sch-name" placeholder="My Blog"/></div>
          <div class="fg"><label class="lbl">Re-ping every N days</label><input type="number" id="ps-sch-days" value="7" min="1" max="365"/></div>
        </div>
        <div class="flex g6 mt6">
          <button class="tbtn go" onclick="ps_saveSchedule()">Save</button>
          <button class="tbtn" onclick="document.getElementById('ps-schedule-add').style.display='none'">Cancel</button>
        </div>
      </div>
      ${schedules_ps.length?schedules_ps.map((s,i)=>`
      <div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid #1e1e1e;font-size:10px">
        <span style="color:${s.enabled?'var(--green)':'var(--text3)'}">${s.enabled?'â—':'â—‹'}</span>
        <span style="flex:1;color:var(--text2)" title="${esc(s.url)}">${esc((s.url||'').slice(0,45))}â€¦</span>
        <span style="color:var(--text3)">Every ${s.days}d</span>
        <span style="color:var(--text3)">Last: ${s.lastPing||'never'}</span>
        <button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="ps_runSchedule(${i})">â–¶ Run</button>
        <button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="ps_toggleSchedule(${i})">${s.enabled?'Pause':'Resume'}</button>
        <button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="ps_deleteSchedule(${i})">âœ•</button>
      </div>`).join(''):'<div style="color:var(--text3);font-size:10px">No scheduled pings configured.</div>'}
    </div>
  </div>
  `:''}

  ${_psTab==='history'?`
  <!-- â•â•â• HISTORY TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ“œ Full Ping History <span class="badge bg">${results.length}</span>
      <div class="ph-r">
        <button class="tbtn" onclick="ps_export()" style="font-size:10px">ğŸ“¥ CSV</button>
        <button class="tbtn" onclick="ps_clear()" style="font-size:10px">ğŸ—‘ Clear</button>
      </div>
    </div>
    <div class="panel-body" style="padding:0"><div class="tbl-wrap" style="max-height:500px"><table>
      <thead><tr><th>Date</th><th>Service</th><th>URL</th><th>Blog Name</th><th>Response</th><th>Status</th></tr></thead>
      <tbody>${results.slice().reverse().map(r=>`<tr>
        <td class="mono xs tm">${esc(r.date)}</td>
        <td class="xs">${esc(r.service)}</td>
        <td class="mono xs" title="${esc(r.url)}">${esc((r.url||'').slice(0,40))}â€¦</td>
        <td class="xs" style="font-size:9px;color:var(--text3)">${esc(r.blogName||'â€”')}</td>
        <td class="xs" style="font-size:9px;color:var(--text3)">${esc(r.response||'â€”')}</td>
        <td><span class="badge ${r.status==='ok'?'bg':'br'}" style="font-size:8px">${r.status}</span></td>
      </tr>`).join('')}</tbody>
    </table></div></div>
  </div>
  `:''}
  `;
}

async function start_ping_submitter(overrideUrl, overrideName, overrideFeed){
  const url=overrideUrl||(document.getElementById('ps-url')||{value:''}).value.trim();
  if(!url){log('Enter page URL','err');return;}
  const baseName=(overrideName||(document.getElementById('ps-name')||{value:''}).value.trim());
  const manualFeed=(overrideFeed||(document.getElementById('ps-feed')||{value:''}).value.trim());
  const customEp=(document.getElementById('ps-custom-ep')||{value:''}).value.trim();
  const category=(document.getElementById('ps-category')||{value:''}).value.trim()||PS_CATEGORIES[rand(0,PS_CATEGORIES.length-1)];
  const autoDiscover=(document.getElementById('ps-autodiscover')||{checked:true}).checked;
  const varyOrder=(document.getElementById('ps-varyorder')||{checked:true}).checked;

  // Auto-discover RSS
  let feedUrl=manualFeed;
  if(!feedUrl&&autoDiscover){
    log('Discovering RSS feed...','info');
    feedUrl=await ps_discoverRss(url)||url+'/feed/';
    const feedEl=document.getElementById('ps-feed');
    if(feedEl&&feedUrl) feedEl.value=feedUrl;
  } else if(!feedUrl){ feedUrl=url+'/feed/'; }

  // Build enabled services list
  let services=PS_SERVICES_ALL.filter(s=>{
    const cb=document.getElementById('ps-svc-'+s.id);
    return cb?cb.checked:['pingomatic','google','bing','superfeedr'].includes(s.id);
  });
  // Filter out dedup-skipped
  const toSkip=services.filter(s=>ps_recentlyPinged(url,s.id));
  if(toSkip.length){log(`Skipping ${toSkip.length} services already pinged in last 24h (${toSkip.map(s=>s.name).join(', ')})`,'info');}
  services=services.filter(s=>!ps_recentlyPinged(url,s.id));
  if(!services.length){log('All selected services already pinged this URL in last 24h','warn');return;}

  // Vary order per run
  if(varyOrder){
    for(let i=services.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[services[i],services[j]]=[services[j],services[i]];}
  }

  const prog=document.getElementById('ps-prog');
  const results=SS.get('rf_ping_results',[]);
  APP.running=true;APP.stopFlag=false;setStatus('Pinging...');
  log(`Sending ${services.length} pings for ${url.slice(0,40)}...`,'info');

  for(let i=0;i<services.length;i++){
    if(APP.stopFlag)break;
    const svc=services[i];
    // Auto-vary blog name per ping
    const blogName=baseName||PS_BLOG_NAMES[rand(0,PS_BLOG_NAMES.length-1)];
    if(prog)prog.style.width=Math.round(((i+1)/services.length)*100)+'%';
    setProgress(Math.round(((i+1)/services.length)*100),`${i+1}/${services.length}`);

    let status='err',response='';
    try{
      const pingUrl=svc.url(url,blogName,feedUrl,customEp);
      if(!pingUrl){status='skip';response='No endpoint configured';
      } else if(svc.type==='post'){
        // WebSub/PubSubHubbub POST
        const resp=await fetch(`https://api.allorigins.win/post?url=${encodeURIComponent(pingUrl)}`,{
          method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:svc.postData?svc.postData(url):'',signal:AbortSignal.timeout(7000)
        });
        status=resp.ok?'ok':'err';
        response=`HTTP ${resp.status}`;
      } else {
        const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(pingUrl)}`,{signal:AbortSignal.timeout(7000)});
        const data=await resp.json().catch(()=>({}));
        const body=(data.contents||'').slice(0,200);
        // Parse XML-RPC response
        const isError=body.includes('<faultCode>')||body.includes('faultCode');
        const isSuccess=body.includes('<success')||body.includes('Thanks')||resp.ok;
        status=isError?'err':isSuccess?'ok':'err';
        const faultStr=(body.match(/<faultString>([^<]+)<\/faultString>/)||[])[1];
        response=faultStr||`HTTP ${resp.status}`+(isSuccess?' OK':'');
      }
      if(status==='ok'){APP.stats.success++;}else{APP.stats.failed++;}
    }catch(e){status='err';response=e.message.slice(0,50);}

    results.push({service:svc.name,url,blogName,feedUrl,category,status,response,date:today()});
    if(status!=='skip') ps_markPinged(url,svc.id);
    log(`${svc.name}: ${status==='ok'?'âœ“':'âœ—'} ${response.slice(0,40)}`,status==='ok'?'ok':'warn');
    APP.stats.processed++;updateStats();
    await sleep(rand(400,900)); // vary delay for fingerprint
  }

  SS.set('rf_ping_results',results);
  APP.running=false;setStatus('Done');
  runHistoryAdd('ping_submitter',services.length,results.filter(r=>r.status==='ok').length,results.filter(r=>r.status==='err').length);
  log(`âœ… Pings sent: ${results.filter(r=>r.status==='ok').length} accepted, ${results.filter(r=>r.status==='err').length} failed`,'ok');
  render_ping_submitter(document.getElementById('page-ping_submitter'));
}

// Auto-ping all recently built links
async function ps_autoPingBuiltLinks(){
  const recentLinks=APP.links.filter(l=>{const d=new Date(l.date).getTime();return Date.now()-d<86400000*2;});
  if(!recentLinks.length){log('No links built in last 48h to auto-ping','warn');return;}
  log(`Auto-pinging ${recentLinks.length} recently built links...`,'info');
  for(const l of recentLinks){
    if(APP.stopFlag)break;
    await start_ping_submitter(l.url,null,null);
    await sleep(500);
  }
  log(`Auto-ping complete: ${recentLinks.length} links processed`,'ok');
}

// Scheduled ping management
function ps_addSchedule(){ document.getElementById('ps-schedule-add').style.display='block'; }
function ps_saveSchedule(){
  const url=(document.getElementById('ps-sch-url')||{value:''}).value.trim();
  if(!url){log('Enter URL','err');return;}
  const name=(document.getElementById('ps-sch-name')||{value:''}).value.trim()||PS_BLOG_NAMES[0];
  const days=parseInt((document.getElementById('ps-sch-days')||{value:7}).value)||7;
  const scheds=SS.get('rf_ps_schedules',[]);
  scheds.push({url,name,days,enabled:true,lastPing:null,created:today()});
  SS.set('rf_ps_schedules',scheds);
  document.getElementById('ps-schedule-add').style.display='none';
  log(`Scheduled ping added: ${url.slice(0,40)} every ${days} days`,'ok');
  render_ping_submitter(document.getElementById('page-ping_submitter'));
}
function ps_toggleSchedule(i){ const s=SS.get('rf_ps_schedules',[]); s[i].enabled=!s[i].enabled; SS.set('rf_ps_schedules',s); render_ping_submitter(document.getElementById('page-ping_submitter')); }
function ps_deleteSchedule(i){ const s=SS.get('rf_ps_schedules',[]); s.splice(i,1); SS.set('rf_ps_schedules',s); render_ping_submitter(document.getElementById('page-ping_submitter')); }
async function ps_runSchedule(i){
  const s=SS.get('rf_ps_schedules',[]);
  if(!s[i])return;
  await start_ping_submitter(s[i].url, s[i].name, null);
  s[i].lastPing=today();
  SS.set('rf_ps_schedules',s);
  log(`Scheduled ping ran: ${s[i].url.slice(0,40)}`,'ok');
}

// Check scheduled pings on boot
function ps_checkSchedules(){
  const scheds=SS.get('rf_ps_schedules',[]);
  const due=scheds.filter(s=>{
    if(!s.enabled)return false;
    if(!s.lastPing)return true;
    const last=new Date(s.lastPing).getTime();
    return Date.now()-last>=s.days*86400000;
  });
  if(due.length) log(`â° ${due.length} scheduled ping(s) due â€” go to Ping Submitter â†’ Schedule tab`,'warn');
}

function ps_export(){dlCSV('Service,URL,BlogName,Response,Status,Date\n'+SS.get('rf_ping_results',[]).map(r=>`"${r.service}","${r.url}","${r.blogName||''}","${r.response||''}","${r.status}","${r.date}"`).join('\n'),'ping_results_v2.csv');log('Exported','ok');}
function ps_clear(){if(confirm('Clear all ping results?')){SS.set('rf_ping_results',[]);render_ping_submitter(document.getElementById('page-ping_submitter'));log('Cleared','warn');}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GSC INSPECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GSC INSPECTOR v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Coverage status priority flags
const GSC_COVERAGE_FLAGS = {
  'Discovered - currently not indexed': { label:'ğŸ”´ HIGH PRIORITY', color:'var(--red)',    tip:'Discovered but not indexed â€” push to indexer immediately' },
  'Crawled - currently not indexed':    { label:'ğŸŸ  INDEX PUSH',    color:'var(--orange)', tip:'Crawled but excluded â€” check content quality' },
  'Excluded by noindex tag':            { label:'â¬› NOINDEX',        color:'var(--text3)',  tip:'Intentionally excluded â€” verify this is correct' },
  'Duplicate, submitted URL not selected':{ label:'ğŸŸ¡ DUPLICATE',   color:'var(--yellow)', tip:'Canonical issue â€” check your canonical tags' },
  'Page with redirect':                 { label:'ğŸŸ¡ REDIRECT',       color:'var(--yellow)', tip:'Redirecting â€” update links to final destination' },
  'Indexed, not submitted in sitemap':  { label:'ğŸŸ¢ INDEXED',        color:'var(--green)',  tip:'Indexed fine, but add to sitemap' },
  'Submitted and indexed':              { label:'âœ… INDEXED',         color:'var(--green)',  tip:'Perfect â€” submitted and indexed' },
};

// Snapshot storage
function gsc_snapshotsGet(){ try{ return JSON.parse(localStorage.getItem('rf_gsc_snapshots')||'[]'); }catch(e){ return []; } }
function gsc_snapshotsSave(s){ try{ localStorage.setItem('rf_gsc_snapshots',JSON.stringify(s)); }catch(e){} }

// Poll state for auto-reinspect
let _gscPollTimer=null;
let _gscPollTargets=[];

// Active tab state
let _gscTab='inspect'; // inspect|performance|coverage|crawlstats|manualaction|compare|alerts

function render_gsc_inspector(el){
  const results=SS.get('rf_gsc_results',[]);
  const token=SS.raw('rf_gsc_token')||'';
  const site=SS.raw('rf_gsc_site')||'';
  const snapshots=gsc_snapshotsGet();
  const alerts=SS.get('rf_gsc_alerts',[]);

  // Pattern flags from results
  const discoveredNotIndexed=results.filter(r=>(r.coverageState||'').includes('Discovered - currently not indexed'));
  const indexedZeroImpressions=results.filter(r=>r.verdict==='PASS'&&r.impressions===0);
  const droppedFromIndex=results.filter(r=>r.wasIndexed&&r.verdict!=='PASS');
  const hasAlerts=alerts.length>0||discoveredNotIndexed.length>0||droppedFromIndex.length>0;

  // Properties list (multiple sites)
  const properties=SS.get('rf_gsc_properties',[]);

  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;flex-wrap:wrap">
    ${[
      ['inspect','ğŸ”¬ Inspect'],
      ['performance','ğŸ“ˆ Performance'],
      ['coverage','ğŸ“Š Coverage'],
      ['crawlstats','ğŸ•· Crawl Stats'],
      ['manualaction','âš  Manual Actions'],
      ['compare','ğŸ”„ Compare'],
      ['alerts','ğŸ”” Alerts'+(hasAlerts?` <span style="background:var(--red);color:#fff;border-radius:8px;padding:0 4px;font-size:9px">${discoveredNotIndexed.length+droppedFromIndex.length+alerts.length}</span>`:'')],
    ].map(([t,l])=>`
    <div onclick="_gscTab='${t}';render_gsc_inspector(document.getElementById('page-gsc_inspector'))"
      style="padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;
      background:${_gscTab===t?'var(--win-panel2)':'transparent'};border:1px solid ${_gscTab===t?'var(--win-border)':'transparent'};
      border-bottom-color:${_gscTab===t?'var(--win-panel2)':'transparent'};color:${_gscTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      ${token?'<span class="badge bg">ğŸ”‘ Token set</span>':'<span class="badge br">No token</span>'}
      ${site?`<span class="badge by" style="font-size:9px" title="${esc(site)}">${esc(site.replace('sc-domain:','').replace('https://','').slice(0,20))}</span>`:''}
    </div>
  </div>

  <!-- â”€â”€â”€ Auth Panel (always shown) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" style="margin-bottom:8px">
    <div class="panel-head" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer">
      ğŸ”‘ GSC Authentication & Properties <span style="color:var(--text3);font-size:10px">(click to expand)</span>
      <span class="badge ${token?'bg':'br'}">${token?'Connected':'Not connected'}</span>
    </div>
    <div style="display:none" class="panel-body">
      <div class="g3">
        <div class="fg"><label class="lbl">OAuth Access Token</label>
          <input type="password" id="gsc-token" placeholder="Bearer token from Google OAuth" value="${esc(token)}" onchange="SS.rawSet('rf_gsc_token',this.value)"/></div>
        <div class="fg"><label class="lbl">Primary Site Property</label>
          <input type="text" id="gsc-site" placeholder="https://yoursite.com/ or sc-domain:yoursite.com" value="${esc(site)}" onchange="SS.rawSet('rf_gsc_site',this.value)"/></div>
        <div style="display:flex;flex-direction:column;gap:6px;justify-content:flex-end">
          <button class="tbtn go" onclick="gsc_authorize()">ğŸ”‘ Authorize Google</button>
          <button class="tbtn" onclick="gsc_addProperty()">+ Add Property</button>
        </div>
      </div>
      ${properties.length?`<div style="margin-top:6px">
        <div class="lbl" style="margin-bottom:4px">Saved Properties (bulk switching)</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px">
          ${properties.map((p,i)=>`
          <div style="display:flex;align-items:center;gap:4px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;padding:3px 6px">
            <button onclick="gsc_switchProperty('${esc(p)}')" style="background:none;border:none;cursor:pointer;color:var(--blue);font-size:10px;font-family:var(--mono)">${esc(p.replace('sc-domain:','').replace('https://','').slice(0,25))}</button>
            <button onclick="gsc_removeProperty(${i})" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:10px">âœ•</button>
          </div>`).join('')}
        </div>
      </div>`:''}
      <div class="notice ni-b" style="margin-top:8px;font-size:10px">
        OAuth scopes needed: webmasters.readonly + webmasters (for index requests)<br>
        Token expires in 1hr. Refresh via Authorize button. Set Google Client ID in Settings for full flow.
      </div>
    </div>
  </div>

  ${_gscTab==='inspect'?`
  <!-- â•â•â• INSPECT TAB â•â•â• -->
  <div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ”¬ URL Inspection v2 <span class="badge bg">v2</span></div>
      <div class="panel-body">
        <div class="fg"><label class="lbl">URLs to Inspect (one per line)</label>
          <textarea id="gsc-urls" rows="7" placeholder="https://yoursite.com/page/&#10;https://yoursite.com/another/"></textarea></div>
        <div class="g3" style="margin-top:6px">
          <div class="fg"><label class="lbl">Property Override (blank = use primary)</label>
            <select id="gsc-prop-override">
              <option value="">Primary: ${esc(site.slice(0,30)||'not set')}</option>
              ${properties.map(p=>`<option value="${esc(p)}">${esc(p.replace('sc-domain:','').replace('https://','').slice(0,30))}</option>`).join('')}
            </select></div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
              <input type="checkbox" id="gsc-rich" checked style="width:auto;accent-color:var(--green)">
              <span>Rich result status</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
              <input type="checkbox" id="gsc-autopoll" style="width:auto;accent-color:var(--green)">
              <span>Auto-reinspect after index request</span></label>
          </div>
          <div class="fg"><label class="lbl">Save snapshot as</label>
            <input type="text" id="gsc-snap-name" placeholder="Before link building, After campaign..."/></div>
        </div>
        <div class="flex g6 mt8" style="flex-wrap:wrap">
          <button class="tbtn go" onclick="start_gsc_inspector()">ğŸ”¬ Inspect URLs</button>
          <button class="tbtn" onclick="document.getElementById('gsc-urls').value=APP.links.map(l=>l.url).join('\n')">ğŸ“‹ Built Links</button>
          <button class="tbtn" onclick="document.getElementById('gsc-urls').value=APP.urlList.join('\n')">ğŸ“‹ URL List</button>
          <button class="tbtn" onclick="gsc_bulkInspectAllProperties()">ğŸ”„ All Properties</button>
          <button class="tbtn" onclick="gsc_saveSnapshot()">ğŸ’¾ Save Snapshot</button>
          <button class="tbtn" onclick="gsc_export()">ğŸ“¥ Export CSV</button>
          <button class="tbtn" onclick="gsc_clear()">ğŸ—‘ Clear</button>
        </div>
        <div class="prog-wrap"><div class="prog-fill" id="gsc-prog"></div></div>
        ${_gscPollTargets.length?`<div class="notice ni-b" style="margin-top:6px">ğŸ”„ Auto-polling ${_gscPollTargets.length} URL(s) for index status changeâ€¦</div>`:''}
      </div>
    </div>

    <!-- Pattern flags sidebar -->
    <div>
      ${discoveredNotIndexed.length?`<div class="notice ni-r" style="margin-bottom:6px">
        ğŸ”´ <strong>${discoveredNotIndexed.length} URL(s) "Discovered - not indexed"</strong> â€” high priority for indexing push.
        <button class="tbtn go" style="font-size:9px;margin-top:4px;display:block" onclick="gsc_pushDiscoveredToIndexer()">ğŸ“¡ Push to Indexer</button>
      </div>`:''}
      ${indexedZeroImpressions.length?`<div class="notice ni-y" style="margin-bottom:6px">
        ğŸŸ¡ <strong>${indexedZeroImpressions.length} indexed URL(s) with 0 impressions</strong> â€” possible content quality issue.
        <button class="tbtn" style="font-size:9px;margin-top:4px;display:block" onclick="gsc_exportZeroImpressions()">ğŸ“¥ Export List</button>
      </div>`:''}
      ${droppedFromIndex.length?`<div class="notice ni-r" style="margin-bottom:6px">
        ğŸš¨ <strong>${droppedFromIndex.length} URL(s) dropped from index</strong> â€” penalty detection. Were previously indexed.
        <button class="tbtn" style="font-size:9px;margin-top:4px;display:block" onclick="gsc_exportDropped()">ğŸ“¥ Export Dropped</button>
      </div>`:''}
      <div class="panel">
        <div class="panel-head" style="font-size:10px">ğŸ“Š Inspection Summary</div>
        <div class="panel-body" style="padding:8px">
          <div class="g2">
            <div class="stat"><div class="stat-v sv-g">${results.filter(r=>r.verdict==='PASS').length}</div><div class="stat-l">Indexed</div></div>
            <div class="stat"><div class="stat-v sv-r">${results.filter(r=>r.verdict==='FAIL').length}</div><div class="stat-l">Not Indexed</div></div>
          </div>
          <div style="margin-top:8px;font-size:10px;font-family:var(--mono);line-height:1.8;color:var(--text2)">
            Neutral: ${results.filter(r=>r.verdict==='NEUTRAL').length}<br>
            Errors: ${results.filter(r=>r.verdict==='ERROR').length}<br>
            Mobile friendly: ${results.filter(r=>r.mobile==='MOBILE_FRIENDLY').length}<br>
            Rich results OK: ${results.filter(r=>r.richResult==='PASS'||r.richResult==='VALID').length}<br>
            Last run: ${results.length?results[results.length-1].inspectedAt||today():'â€”'}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results table -->
  ${results.length?`
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">Inspection Results <span class="badge bg">${results.length}</span>
      <div class="ph-r">
        <button class="tbtn" onclick="gsc_requestIndexAll()" style="font-size:10px">ğŸ“¡ Request Index All Failed</button>
      </div>
    </div>
    <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
      <thead><tr><th>URL</th><th>Verdict</th><th>Coverage</th><th>Crawled</th><th>Last Crawled</th><th>Mobile</th><th>Rich</th><th>DA Corr.</th><th>Actions</th></tr></thead>
      <tbody>${results.map((r,ri)=>{
        const flag=GSC_COVERAGE_FLAGS[r.coverageState||'']||null;
        const linkedDa=gsc_linkedPageDA(r.url);
        const daColor=linkedDa>=70?'var(--green)':linkedDa>0?'var(--yellow)':'var(--text3)';
        const isDropped=r.wasIndexed&&r.verdict!=='PASS';
        return`<tr style="${isDropped?'background:rgba(224,82,82,.08);':r.verdict==='PASS'?'':''}">
          <td class="mono xs" style="max-width:180px">
            <a href="${esc(r.url)}" target="_blank" title="${esc(r.url)}">${esc((r.url||'').slice(0,42))}â€¦</a>
            ${isDropped?'<span style="color:var(--red);font-size:8px;display:block">âš  DROPPED</span>':''}
          </td>
          <td><span class="badge ${r.verdict==='PASS'?'bg':r.verdict==='NEUTRAL'?'by':'br'}">${r.verdict||'â€”'}</span></td>
          <td style="font-size:9px;max-width:140px">
            ${flag?`<span style="color:${flag.color};font-weight:700;font-size:9px" title="${flag.tip}">${flag.label}</span>`:''}
            <div style="color:var(--text3);font-size:8px">${esc((r.coverageState||r.indexStatus||'â€”').slice(0,30))}</div>
          </td>
          <td class="xs" style="font-size:9px">${esc(r.crawlStatus||'â€”')}</td>
          <td class="mono xs tm">${esc(r.lastCrawled||'â€”')}</td>
          <td><span class="badge ${r.mobile==='MOBILE_FRIENDLY'?'bg':'br'}" style="font-size:8px">${r.mobile==='MOBILE_FRIENDLY'?'âœ“':'âœ—'}</span></td>
          <td><span class="badge ${r.richResult==='PASS'||r.richResult==='VALID'?'bg':r.richResult?'br':'bgray'}" style="font-size:8px">${r.richResult||'â€”'}</span></td>
          <td style="font-size:9px;color:${daColor}">${linkedDa>0?`DA${linkedDa}`:'â€”'}</td>
          <td style="white-space:nowrap">
            <button class="tbtn go" style="padding:1px 4px;font-size:8px" onclick="gsc_requestIndex(${ri})" title="Request indexing">ğŸ“¡</button>
            <button class="tbtn" style="padding:1px 4px;font-size:8px" onclick="gsc_reinspectOne(${ri})" title="Re-inspect">ğŸ”¬</button>
            <button class="tbtn" style="padding:1px 4px;font-size:8px" onclick="gsc_pushOneToIndexer(${ri})" title="Send to Link Indexer">â†—</button>
          </td>
        </tr>`;
      }).join('')}</tbody>
    </table></div></div>
  </div>`:''}
  `:''}

  ${_gscTab==='performance'?`
  <!-- â•â•â• PERFORMANCE TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ“ˆ Search Performance Data â€” Clicks, Impressions, CTR, Position</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Pulls real performance data from GSC Search Analytics API. Date range is relative to today.</div>
      <div class="g4">
        <div class="fg"><label class="lbl">Date Range</label>
          <select id="gsc-perf-range">
            <option value="7">Last 7 days</option>
            <option value="28" selected>Last 28 days</option>
            <option value="90">Last 90 days</option>
            <option value="180">Last 6 months</option>
          </select></div>
        <div class="fg"><label class="lbl">Dimension</label>
          <select id="gsc-perf-dim">
            <option value="page">By Page URL</option>
            <option value="query">By Keyword</option>
            <option value="country">By Country</option>
            <option value="device">By Device</option>
          </select></div>
        <div class="fg"><label class="lbl">Filter (URL contains)</label>
          <input type="text" id="gsc-perf-filter" placeholder="blog, category, /vpn..."/></div>
        <div class="fg"><label class="lbl">Max Rows</label>
          <input type="number" id="gsc-perf-rows" value="100" min="1" max="1000"/></div>
      </div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="gsc_pullPerformance()">ğŸ“ˆ Pull Performance Data</button>
        <button class="tbtn" onclick="gsc_exportPerf()">ğŸ“¥ Export CSV</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="gsc-perf-prog"></div></div>
    </div>
  </div>
  <div id="gsc-perf-results" style="margin-top:8px"></div>
  `:''}

  ${_gscTab==='coverage'?`
  <!-- â•â•â• COVERAGE TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ“Š Coverage Report â€” Indexed / Excluded / Errors</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Downloads the full index coverage breakdown from GSC. Shows every URL state: valid, excluded, error, warning.</div>
      <div class="g2">
        <div class="fg"><label class="lbl">Sitemaps to Inspect (one per line â€” blank for all)</label>
          <textarea id="gsc-cov-sitemaps" rows="4" placeholder="https://yoursite.com/sitemap.xml&#10;https://yoursite.com/sitemap-posts.xml"></textarea></div>
        <div>
          <div class="fg"><label class="lbl">Coverage Categories to Download</label>
          <div style="display:flex;flex-direction:column;gap:5px;margin-top:4px">
            ${[['cov-valid','Valid (indexed)','on'],['cov-excluded','Excluded','on'],['cov-error','Errors','on'],['cov-warning','Warnings','on']].map(([id,label,def])=>`
            <label style="display:flex;align-items:center;gap:7px;cursor:pointer">
              <input type="checkbox" id="${id}" ${def==='on'?'checked':''} style="width:auto;accent-color:var(--green)">
              <span class="mono xs">${label}</span>
            </label>`).join('')}
          </div></div>
        </div>
      </div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="gsc_pullCoverage()">ğŸ“Š Download Coverage Report</button>
        <button class="tbtn" onclick="gsc_exportCoverage()">ğŸ“¥ Export CSV</button>
        <button class="tbtn" onclick="gsc_pushExcludedToIndexer()">ğŸ“¡ Push "Discovered" to Indexer</button>
      </div>
      <div class="prog-wrap"><div class="prog-fill" id="gsc-cov-prog"></div></div>
      <div id="gsc-cov-results" style="margin-top:8px"></div>
    </div>
  </div>
  `:''}

  ${_gscTab==='crawlstats'?`
  <!-- â•â•â• CRAWL STATS TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ•· Crawl Stats â€” Bandwidth, Errors, Crawl Rate</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">GSC Crawl Stats API: pages crawled/day, download size, response time, crawl errors. Requires webmasters scope.</div>
      <button class="tbtn go" onclick="gsc_pullCrawlStats()">ğŸ•· Fetch Crawl Stats</button>
      <div class="prog-wrap"><div class="prog-fill" id="gsc-crawl-prog"></div></div>
      <div id="gsc-crawl-results" style="margin-top:8px"></div>
    </div>
  </div>
  `:''}

  ${_gscTab==='manualaction'?`
  <!-- â•â•â• MANUAL ACTIONS TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">âš  Manual Action Checker</div>
    <div class="panel-body">
      <div class="notice ni-r" style="margin-bottom:8px">Checks your GSC property for active Google manual actions (penalties). A manual action means a human Google reviewer has flagged your site.</div>
      <button class="tbtn go" onclick="gsc_checkManualActions()">âš  Check Manual Actions</button>
      <div id="gsc-manual-results" style="margin-top:10px"></div>
    </div>
  </div>
  `:''}

  ${_gscTab==='compare'?`
  <!-- â•â•â• COMPARE TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ”„ Snapshot Comparison â€” Before vs After</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Compare two inspection snapshots to measure the impact of link building on indexing status.</div>
      ${snapshots.length>=2?`
      <div class="g3" style="margin-bottom:8px">
        <div class="fg"><label class="lbl">Snapshot A (Before)</label>
          <select id="gsc-snap-a">${snapshots.map((s,i)=>`<option value="${i}">${esc(s.name)} â€” ${s.date} (${s.results.length} URLs)</option>`).join('')}</select></div>
        <div class="fg"><label class="lbl">Snapshot B (After)</label>
          <select id="gsc-snap-b">${snapshots.map((s,i)=>`<option value="${i}" ${i===snapshots.length-1?'selected':''}>${esc(s.name)} â€” ${s.date} (${s.results.length} URLs)</option>`).join('')}</select></div>
        <div style="display:flex;align-items:flex-end"><button class="tbtn go" onclick="gsc_compareSnapshots()">ğŸ”„ Compare</button></div>
      </div>
      <div id="gsc-compare-results"></div>
      `:`<div class="notice ni-y">Save at least 2 snapshots using "Save Snapshot" on the Inspect tab to compare them here.</div>`}
      <div style="margin-top:12px">
        <div class="panel-head" style="margin-bottom:6px">Saved Snapshots (${snapshots.length})</div>
        ${snapshots.length?snapshots.map((s,i)=>`
        <div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #1e1e1e;font-size:10px">
          <span style="flex:1;color:var(--text2)">${esc(s.name)}</span>
          <span style="color:var(--text3)">${s.date}</span>
          <span class="badge bg">${s.results.length} URLs</span>
          <span class="badge ${s.indexed} bg">${s.results.filter(r=>r.verdict==='PASS').length} indexed</span>
          <button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="gsc_deleteSnapshot(${i})">âœ•</button>
        </div>`).join(''):'<div style="color:var(--text3);font-size:10px">No snapshots saved yet.</div>'}
      </div>
    </div>
  </div>
  `:''}

  ${_gscTab==='alerts'?`
  <!-- â•â•â• ALERTS TAB â•â•â• -->
  <div class="panel">
    <div class="panel-head">ğŸ”” Indexing Alerts â€” Penalty & Coverage Detection</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">Alerts fire when: a previously indexed URL drops from index, coverage changes for monitored URLs, or manual actions are found.</div>

      ${discoveredNotIndexed.length?`
      <div class="notice ni-r" style="margin-bottom:6px">
        <strong>ğŸ”´ ${discoveredNotIndexed.length} URL(s) stuck at "Discovered - currently not indexed"</strong><br>
        ${discoveredNotIndexed.slice(0,5).map(r=>`<div class="mono xs" style="margin-top:2px;color:var(--text)">${esc(r.url.slice(0,60))}</div>`).join('')}
        ${discoveredNotIndexed.length>5?`<div class="xs tm">...and ${discoveredNotIndexed.length-5} more</div>`:''}
        <button class="tbtn go" style="margin-top:6px;font-size:10px" onclick="gsc_pushDiscoveredToIndexer()">ğŸ“¡ Send All to Link Indexer</button>
      </div>`:''}

      ${droppedFromIndex.length?`
      <div class="notice ni-r" style="margin-bottom:6px">
        <strong>ğŸš¨ ${droppedFromIndex.length} URL(s) DROPPED from Google index</strong> â€” possible penalty or deindex<br>
        ${droppedFromIndex.slice(0,5).map(r=>`<div class="mono xs" style="margin-top:2px;color:var(--red)">${esc(r.url.slice(0,60))} â€” was ${esc(r.wasIndexed)}</div>`).join('')}
        <button class="tbtn" style="margin-top:6px;font-size:10px" onclick="gsc_exportDropped()">ğŸ“¥ Export Dropped URLs</button>
      </div>`:''}

      ${indexedZeroImpressions.length?`
      <div class="notice ni-y" style="margin-bottom:6px">
        <strong>ğŸŸ¡ ${indexedZeroImpressions.length} indexed URL(s) with 0 impressions</strong> â€” content may be thin or targeting wrong keywords<br>
        ${indexedZeroImpressions.slice(0,3).map(r=>`<div class="mono xs" style="margin-top:2px;color:var(--text)">${esc(r.url.slice(0,60))}</div>`).join('')}
      </div>`:''}

      ${alerts.length?`
      <div style="margin-top:8px">
        <div class="panel-head" style="margin-bottom:6px">Stored Alerts (${alerts.length})</div>
        ${alerts.slice(-20).reverse().map((a,i)=>`
        <div style="display:flex;align-items:flex-start;gap:8px;padding:5px 0;border-bottom:1px solid #1e1e1e;font-size:10px">
          <span style="color:${a.type==='drop'?'var(--red)':a.type==='manual'?'var(--red)':'var(--yellow)'}">${a.type==='drop'?'ğŸš¨':a.type==='manual'?'âš ':'ğŸŸ¡'}</span>
          <div style="flex:1">
            <div style="color:var(--text)">${esc(a.message)}</div>
            <div class="mono xs tm" style="margin-top:1px">${esc(a.url||'')} Â· ${esc(a.date)}</div>
          </div>
          <button class="tbtn" style="font-size:8px;padding:1px 4px" onclick="gsc_dismissAlert(${alerts.length-1-i})">âœ•</button>
        </div>`).join('')}
        <button class="tbtn" style="margin-top:6px;font-size:10px" onclick="SS.set('rf_gsc_alerts',[]);render_gsc_inspector(document.getElementById('page-gsc_inspector'))">ğŸ—‘ Clear All Alerts</button>
      </div>`:''}

      ${!discoveredNotIndexed.length&&!droppedFromIndex.length&&!indexedZeroImpressions.length&&!alerts.length?
        '<div style="color:var(--text3);font-size:10px;padding:20px 0;text-align:center">âœ… No active alerts. Run an inspection to populate alert detection.</div>':''
      }

      <div style="margin-top:12px">
        <div class="panel-head" style="margin-bottom:6px">DA â†’ Index Correlation</div>
        <div class="notice ni-b" style="margin-bottom:6px;font-size:10px">Shows whether pages with higher-DA backlinks are indexed faster/more reliably â€” proves the linkâ†’index relationship.</div>
        ${gsc_buildDACorrelationTable(results)}
      </div>
    </div>
  </div>
  `:''}
  `;
}

// â”€â”€â”€ Helper: find DA of linking pages for a given URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gsc_linkedPageDA(url){
  const linkedFrom=APP.links.filter(l=>{
    try{ return new URL(l.url).hostname===new URL(url).hostname; }catch(e){ return false; }
  });
  if(!linkedFrom.length) return 0;
  return Math.max(...linkedFrom.map(l=>l.da||0));
}

// â”€â”€â”€ DA â†’ Index Correlation table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gsc_buildDACorrelationTable(results){
  if(!results.length||!APP.links.length) return '<div style="color:var(--text3);font-size:10px">Inspect URLs and build links first to see DA correlation.</div>';
  const brackets=[{label:'DA 90+',min:90},{label:'DA 70-89',min:70,max:90},{label:'DA 50-69',min:50,max:70},{label:'DA <50',min:0,max:50}];
  const rows=brackets.map(b=>{
    const linkedUrls=results.filter(r=>{
      const da=gsc_linkedPageDA(r.url);
      return da>=b.min&&(b.max===undefined||da<b.max);
    });
    const indexed=linkedUrls.filter(r=>r.verdict==='PASS').length;
    const rate=linkedUrls.length?Math.round(indexed/linkedUrls.length*100):null;
    return{...b,total:linkedUrls.length,indexed,rate};
  }).filter(r=>r.total>0);
  if(!rows.length) return '<div style="color:var(--text3);font-size:10px">No correlated data yet.</div>';
  return`<table style="width:100%;font-size:10px;border-collapse:collapse">
    <thead><tr><th style="text-align:left;padding:3px 6px;border-bottom:1px solid var(--win-border)">Linking DA Tier</th><th>URLs</th><th>Indexed</th><th>Index Rate</th></tr></thead>
    <tbody>${rows.map(r=>`<tr>
      <td style="padding:3px 6px;font-family:var(--mono)">${r.label}</td>
      <td style="text-align:center">${r.total}</td>
      <td style="text-align:center;color:var(--green)">${r.indexed}</td>
      <td style="text-align:center">
        <div style="display:flex;align-items:center;gap:6px">
          <div style="flex:1;height:5px;background:var(--win-panel3);border-radius:2px">
            <div style="width:${r.rate||0}%;height:100%;background:${r.rate>=70?'var(--green)':r.rate>=40?'var(--yellow)':'var(--red)'};border-radius:2px"></div>
          </div>
          <span style="font-family:var(--mono);color:${r.rate>=70?'var(--green)':r.rate>=40?'var(--yellow)':'var(--red)'}">${r.rate!==null?r.rate+'%':'â€”'}</span>
        </div>
      </td>
    </tr>`).join('')}</tbody>
  </table>`;
}

// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gsc_authorize(){
  const clientId=SS.raw('rf_google_client_id')||'';
  if(!clientId){
    log('Set your Google Client ID in Settings â†’ API Keys first','warn');
    alert('To use full OAuth:\n1. Create a project at console.cloud.google.com\n2. Enable Search Console API\n3. Create OAuth credentials (Web App)\n4. Paste Client ID in Settings â†’ API Keys â†’ Google Client ID\n\nAlternatively: use Google OAuth Playground (oauth2.googleapis.com/tokeninfo) to get a token manually.');
    window.open('https://developers.google.com/oauthplayground','_blank');
    return;
  }
  const scope=encodeURIComponent('https://www.googleapis.com/auth/webmasters https://www.googleapis.com/auth/webmasters.readonly');
  const redirect=encodeURIComponent(window.location.href.split('?')[0]);
  const authUrl=`https://accounts.google.com/o/oauth2/auth?client_id=${clientId}&redirect_uri=${redirect}&scope=${scope}&response_type=token&access_type=online`;
  window.open(authUrl,'_blank');
  log('Google OAuth opened â€” authorize and paste token above','info');
}

function gsc_addProperty(){
  const p=prompt('Enter GSC property URL (e.g. https://yoursite.com/ or sc-domain:yoursite.com)');
  if(!p||!p.trim()) return;
  const props=SS.get('rf_gsc_properties',[]);
  if(!props.includes(p.trim())){props.push(p.trim());SS.set('rf_gsc_properties',props);}
  log(`Property added: ${p.trim()}`,'ok');
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}
function gsc_switchProperty(p){
  SS.rawSet('rf_gsc_site',p);
  const el=document.getElementById('gsc-site');
  if(el)el.value=p;
  log(`Switched to property: ${p}`,'ok');
}
function gsc_removeProperty(i){
  const props=SS.get('rf_gsc_properties',[]);props.splice(i,1);SS.set('rf_gsc_properties',props);
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}

// â”€â”€â”€ Core inspection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function _gsc_inspectUrl(url, site, token, checkRich=true){
  const resp=await fetch('https://searchconsole.googleapis.com/v1/urlInspection/index:inspect',{
    method:'POST',
    headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
    body:JSON.stringify({inspectionUrl:url,siteUrl:site,languageCode:'en'}),
    signal:AbortSignal.timeout(12000)
  });
  if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
  const data=await resp.json();
  const ir=data.inspectionResult||{};
  const ixr=ir.indexStatusResult||{};
  const mu=ir.mobileUsabilityResult||{};
  const rr=ir.richResultsResult||{};
  // Detect coverage state from referring urls / indexing state
  let coverageState=ixr.indexingState||'';
  // Map GSC indexingState to human-readable coverage state
  const stateMap={
    'INDEXING_ALLOWED':'Submitted and indexed',
    'BLOCKED_BY_META_TAG':'Excluded by noindex tag',
    'BLOCKED_BY_HTTP_HEADER':'Excluded by X-Robots noindex',
    'BLOCKED_BY_ROBOTS_TXT':'Excluded by robots.txt',
    'CRAWLED_CURRENTLY_NOT_INDEXED':'Crawled - currently not indexed',
    'DISCOVERED_CURRENTLY_NOT_INDEXED':'Discovered - currently not indexed',
    'ALTERNATE_PAGE':'Duplicate, submitted URL not selected',
    'PAGE_WITH_REDIRECT':'Page with redirect',
    'NOT_FOUND':'Page not found (404)',
    'SOFT_404':'Soft 404',
  };
  coverageState=stateMap[coverageState]||coverageState;
  return{
    url,
    verdict:ixr.verdict||'UNKNOWN',
    crawlStatus:ixr.crawledAs||'NOT_CRAWLED',
    indexStatus:ixr.indexingState||'â€”',
    coverageState,
    lastCrawled:ixr.lastCrawlTime?ixr.lastCrawlTime.slice(0,10):'â€”',
    mobile:mu.verdict||'â€”',
    mobileIssues:(mu.issues||[]).map(i=>i.issueMessage).join('; ').slice(0,80)||null,
    richResult:rr.verdict||null,
    richResultItems:(rr.detectedItems||[]).map(i=>i.richResultType).join(', ')||null,
    impressions:null, // populated by performance pull
    inspectedAt:today(),
    site,
  };
}

async function start_gsc_inspector(){
  const token=(document.getElementById('gsc-token')||{value:''}).value.trim()||SS.raw('rf_gsc_token','');
  const propOverride=(document.getElementById('gsc-prop-override')||{value:''}).value.trim();
  const site=propOverride||(document.getElementById('gsc-site')||{value:''}).value.trim()||SS.raw('rf_gsc_site','');
  const raw=(document.getElementById('gsc-urls')||{value:''}).value.trim();
  const checkRich=(document.getElementById('gsc-rich')||{checked:true}).checked;
  const autoPoll=(document.getElementById('gsc-autopoll')||{checked:false}).checked;
  if(!raw){log('Enter URLs to inspect','err');return;}
  if(!token){log('Add GSC OAuth token first','err');return;}
  if(!site){log('Enter GSC site property','err');return;}
  SS.rawSet('rf_gsc_token',token);SS.rawSet('rf_gsc_site',site);
  const urls=raw.split('\n').map(u=>u.trim()).filter(Boolean);
  const prog=document.getElementById('gsc-prog');
  const prevResults=SS.get('rf_gsc_results',[]);
  const prevMap={};prevResults.forEach(r=>{prevMap[r.url]=r;});
  const newResults=[];
  const alerts=SS.get('rf_gsc_alerts',[]);
  APP.running=true;APP.stopFlag=false;setStatus('Inspecting...');
  log(`Inspecting ${urls.length} URLs via GSC API (property: ${site})`,'info');

  for(let i=0;i<urls.length;i++){
    if(APP.stopFlag)break;
    const url=urls[i];
    if(prog)prog.style.width=Math.round(((i+1)/urls.length)*100)+'%';
    setProgress(Math.round(((i+1)/urls.length)*100),`${i+1}/${urls.length}`);
    try{
      const r=await _gsc_inspectUrl(url,site,token,checkRich);
      // Carry over impressions if we have them from performance data
      const prev=prevMap[url];
      if(prev?.impressions!==undefined&&prev.impressions!==null) r.impressions=prev.impressions;
      // Penalty detection: was previously indexed, now not?
      if(prev&&prev.verdict==='PASS'&&r.verdict!=='PASS'){
        r.wasIndexed='PASS';
        const alertMsg=`âš  URL dropped from index: ${url.slice(0,60)}`;
        alerts.push({type:'drop',message:alertMsg,url,date:today()});
        log(alertMsg,'err');
      } else if(prev&&prev.verdict==='PASS'){
        r.wasIndexed='PASS'; // keep the history
      }
      newResults.push(r);
      const flag=GSC_COVERAGE_FLAGS[r.coverageState]||null;
      log(`${url.slice(0,42)} â†’ ${r.verdict}${flag?' '+flag.label:''}`,r.verdict==='PASS'?'ok':'warn');
      APP.stats.success++;
    }catch(e){
      newResults.push({url,verdict:'ERROR',crawlStatus:'â€”',indexStatus:'â€”',coverageState:'â€”',lastCrawled:'â€”',mobile:'â€”',richResult:null,inspectedAt:today(),site});
      log(`${url.slice(0,35)} â†’ ${e.message}`,'err');APP.stats.failed++;
    }
    APP.stats.processed++;updateStats();await sleep(1000);
  }

  SS.set('rf_gsc_results',newResults);
  SS.set('rf_gsc_alerts',alerts);
  APP.running=false;setStatus('Done');
  const indexed=newResults.filter(r=>r.verdict==='PASS').length;
  const discovered=newResults.filter(r=>r.coverageState==='Discovered - currently not indexed').length;
  log(`âœ… Inspection done: ${indexed}/${newResults.length} indexed${discovered?` Â· ğŸ”´ ${discovered} Discovered-not-indexed`:''}`,'ok');
  runHistoryAdd('gsc_inspector',newResults.length,indexed,newResults.length-indexed);

  // Auto-poll setup
  if(autoPoll){
    const toWatch=newResults.filter(r=>r.verdict!=='PASS'&&r.verdict!=='ERROR').map(r=>r.url);
    if(toWatch.length){
      _gscPollTargets=[...toWatch];
      log(`ğŸ”„ Auto-polling ${toWatch.length} non-indexed URLs every 5 min...`,'info');
      if(_gscPollTimer) clearInterval(_gscPollTimer);
      _gscPollTimer=setInterval(()=>gsc_pollForIndexChange(site,token),5*60*1000);
    }
  }
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}

// â”€â”€â”€ Bulk inspect across all properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gsc_bulkInspectAllProperties(){
  const props=SS.get('rf_gsc_properties',[]);
  const site=SS.raw('rf_gsc_site','');
  const allProps=[...new Set([site,...props])].filter(Boolean);
  if(!allProps.length){log('Add GSC properties first','warn');return;}
  const raw=(document.getElementById('gsc-urls')||{value:''}).value.trim();
  if(!raw){log('Enter URLs to inspect','err');return;}
  const token=SS.raw('rf_gsc_token','');
  if(!token){log('GSC token required','err');return;}
  const urls=raw.split('\n').map(u=>u.trim()).filter(Boolean);
  const allResults=[];
  log(`Bulk inspecting ${urls.length} URLs across ${allProps.length} properties...`,'info');
  for(const prop of allProps){
    log(`Inspecting under property: ${prop}`,'info');
    for(const url of urls){
      if(APP.stopFlag)break;
      try{
        const r=await _gsc_inspectUrl(url,prop,token,false);
        allResults.push({...r,property:prop});
        log(`[${prop.slice(0,20)}] ${url.slice(0,35)} â†’ ${r.verdict}`,r.verdict==='PASS'?'ok':'warn');
      }catch(e){
        allResults.push({url,verdict:'ERROR',site:prop,property:prop,inspectedAt:today()});
        log(`[${prop.slice(0,20)}] ${url.slice(0,35)} â†’ ERROR: ${e.message}`,'err');
      }
      await sleep(1000);
    }
  }
  SS.set('rf_gsc_results',allResults);
  log(`Bulk inspection done: ${allResults.filter(r=>r.verdict==='PASS').length} indexed across all properties`,'ok');
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}

// â”€â”€â”€ Auto-poll for index change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gsc_pollForIndexChange(site,token){
  if(!_gscPollTargets.length){clearInterval(_gscPollTimer);_gscPollTimer=null;return;}
  log(`ğŸ”„ Polling ${_gscPollTargets.length} URLs for index status change...`,'info');
  const results=SS.get('rf_gsc_results',[]);
  const alerts=SS.get('rf_gsc_alerts',[]);
  const nowIndexed=[];
  for(const url of [..._gscPollTargets]){
    try{
      const r=await _gsc_inspectUrl(url,site,token,false);
      if(r.verdict==='PASS'){
        nowIndexed.push(url);
        _gscPollTargets=_gscPollTargets.filter(u=>u!==url);
        alerts.push({type:'indexed',message:`âœ… URL now indexed: ${url.slice(0,60)}`,url,date:today()});
        log(`âœ… Auto-poll: ${url.slice(0,45)} is now INDEXED`,'ok');
        // Update in results store
        const idx=results.findIndex(res=>res.url===url);
        if(idx>=0) results[idx]={...results[idx],...r};
      }
    }catch(e){}
    await sleep(800);
  }
  if(nowIndexed.length){SS.set('rf_gsc_results',results);SS.set('rf_gsc_alerts',alerts);}
  if(!_gscPollTargets.length){clearInterval(_gscPollTimer);_gscPollTimer=null;log('ğŸ”„ Auto-poll done â€” all targets indexed','ok');}
}

// â”€â”€â”€ Individual actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gsc_requestIndex(i){
  const results=SS.get('rf_gsc_results',[]);
  const r=results[i];if(!r)return;
  const token=SS.raw('rf_gsc_token','');
  const site=r.site||SS.raw('rf_gsc_site','');
  if(!token){log('GSC token required','err');return;}
  log(`Requesting indexing: ${r.url.slice(0,50)}...`,'info');
  try{
    const resp=await fetch('https://searchconsole.googleapis.com/v1/urlInspection/index:inspect',{
      method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify({inspectionUrl:r.url,siteUrl:site,languageCode:'en'}),signal:AbortSignal.timeout(10000)
    });
    if(resp.ok){
      log(`âœ“ Index requested: ${r.url.slice(0,40)}`,'ok');
      r.indexRequested=today();SS.set('rf_gsc_results',results);
    } else {const e=await resp.json();log(`Index request failed: ${e.error?.message||resp.status}`,'err');}
  }catch(e){log(`Index request error: ${e.message}`,'err');}
}

async function gsc_requestIndexAll(){
  const results=SS.get('rf_gsc_results',[]);
  const failed=results.map((r,i)=>({r,i})).filter(({r})=>r.verdict!=='PASS'&&r.verdict!=='ERROR');
  if(!failed.length){log('No failed URLs to request indexing for','warn');return;}
  log(`Requesting indexing for ${failed.length} failed URLs...`,'info');
  for(const {i} of failed){ await gsc_requestIndex(i); await sleep(500); }
  log(`Index requests sent for ${failed.length} URLs`,'ok');
}

async function gsc_reinspectOne(i){
  const results=SS.get('rf_gsc_results',[]);
  const r=results[i];if(!r)return;
  const token=SS.raw('rf_gsc_token','');
  const site=r.site||SS.raw('rf_gsc_site','');
  if(!token){log('GSC token required','err');return;}
  try{
    const fresh=await _gsc_inspectUrl(r.url,site,token,true);
    Object.assign(results[i],fresh);
    SS.set('rf_gsc_results',results);
    log(`Re-inspected: ${r.url.slice(0,40)} â†’ ${fresh.verdict}`,fresh.verdict==='PASS'?'ok':'warn');
    render_gsc_inspector(document.getElementById('page-gsc_inspector'));
  }catch(e){log(`Re-inspect failed: ${e.message}`,'err');}
}

function gsc_pushOneToIndexer(i){
  const results=SS.get('rf_gsc_results',[]);
  const r=results[i];if(!r)return;
  const ta=document.getElementById('li-urls');
  if(ta){const cur=ta.value.trim();ta.value=cur?cur+'\n'+r.url:r.url;}
  switchPage('link_indexer');
  log(`Pushed to Link Indexer: ${r.url.slice(0,40)}`,'ok');
}

function gsc_pushDiscoveredToIndexer(){
  const results=SS.get('rf_gsc_results',[]);
  const discovered=results.filter(r=>r.coverageState==='Discovered - currently not indexed');
  if(!discovered.length){log('No "Discovered - not indexed" URLs','warn');return;}
  switchPage('link_indexer');
  setTimeout(()=>{
    const ta=document.getElementById('li-urls');
    if(ta)ta.value=discovered.map(r=>r.url).join('\n');
    log(`Loaded ${discovered.length} discovered-not-indexed URLs into Link Indexer`,'ok');
  },300);
}

function gsc_pushExcludedToIndexer(){
  const results=SS.get('rf_gsc_results',[]);
  const excluded=results.filter(r=>r.verdict!=='PASS'&&(r.coverageState||'').includes('Discovered'));
  if(!excluded.length){log('No excluded URLs to push','warn');return;}
  switchPage('link_indexer');
  setTimeout(()=>{ const ta=document.getElementById('li-urls'); if(ta)ta.value=excluded.map(r=>r.url).join('\n'); },300);
  log(`Pushed ${excluded.length} excluded URLs to indexer`,'ok');
}

// â”€â”€â”€ Performance data pull â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _gscPerfData=[];
async function gsc_pullPerformance(){
  const token=SS.raw('rf_gsc_token','');
  const site=SS.raw('rf_gsc_site','');
  if(!token||!site){log('GSC token and site property required','err');return;}
  const days=parseInt((document.getElementById('gsc-perf-range')||{value:28}).value)||28;
  const dim=(document.getElementById('gsc-perf-dim')||{value:'page'}).value;
  const filter=(document.getElementById('gsc-perf-filter')||{value:''}).value.trim();
  const rows=parseInt((document.getElementById('gsc-perf-rows')||{value:100}).value)||100;
  const prog=document.getElementById('gsc-perf-prog');
  if(prog)prog.style.width='30%';
  const endDate=new Date().toISOString().slice(0,10);
  const startDate=new Date(Date.now()-days*86400000).toISOString().slice(0,10);
  log(`Pulling performance data: ${startDate} â†’ ${endDate} (${dim})...`,'info');
  APP.running=true;setStatus('Pulling performance...');
  try{
    const body={
      startDate,endDate,dimensions:[dim],rowLimit:rows,
      ...(filter?{dimensionFilterGroups:[{filters:[{dimension:dim,operator:'contains',expression:filter}]}]}:{})
    };
    const resp=await fetch(`https://searchconsole.googleapis.com/webmasters/v3/sites/${encodeURIComponent(site)}/searchAnalytics/query`,{
      method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify(body),signal:AbortSignal.timeout(30000)
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const data=await resp.json();
    _gscPerfData=data.rows||[];
    if(prog)prog.style.width='100%';

    // Correlate impressions back into inspection results
    if(dim==='page'){
      const results=SS.get('rf_gsc_results',[]);
      _gscPerfData.forEach(row=>{
        const url=row.keys[0];
        const idx=results.findIndex(r=>r.url===url);
        if(idx>=0){results[idx].impressions=row.impressions;results[idx].clicks=row.clicks;results[idx].ctr=row.ctr;results[idx].position=row.position;}
      });
      SS.set('rf_gsc_results',results);
    }

    const el=document.getElementById('gsc-perf-results');
    if(el){
      const totalClicks=_gscPerfData.reduce((s,r)=>s+r.clicks,0);
      const totalImpr=_gscPerfData.reduce((s,r)=>s+r.impressions,0);
      const avgCtr=_gscPerfData.length?(_gscPerfData.reduce((s,r)=>s+(r.ctr||0),0)/_gscPerfData.length*100).toFixed(1):0;
      const avgPos=_gscPerfData.length?(_gscPerfData.reduce((s,r)=>s+(r.position||0),0)/_gscPerfData.length).toFixed(1):0;
      el.innerHTML=`
      <div class="panel">
        <div class="panel-head">Performance: ${esc(dim)} â€” ${startDate} â†’ ${endDate}
          <div class="ph-r"><button class="tbtn" onclick="gsc_exportPerf()" style="font-size:10px">ğŸ“¥ CSV</button></div>
        </div>
        <div class="panel-body">
          <div class="g4" style="margin-bottom:10px">
            <div class="stat"><div class="stat-v sv-g">${totalClicks.toLocaleString()}</div><div class="stat-l">Total Clicks</div></div>
            <div class="stat"><div class="stat-v sv-b">${totalImpr.toLocaleString()}</div><div class="stat-l">Impressions</div></div>
            <div class="stat"><div class="stat-v sv-y">${avgCtr}%</div><div class="stat-l">Avg CTR</div></div>
            <div class="stat"><div class="stat-v sv-p">${avgPos}</div><div class="stat-l">Avg Position</div></div>
          </div>
          <div style="padding:0"><div class="tbl-wrap"><table>
            <thead><tr><th>${dim.charAt(0).toUpperCase()+dim.slice(1)}</th><th>Clicks</th><th>Impressions</th><th>CTR</th><th>Position</th><th>Flags</th></tr></thead>
            <tbody>${_gscPerfData.slice(0,200).map(row=>{
              const key=row.keys[0]||'';
              const zeroImp=row.impressions===0;
              const highPos=row.position>20;
              return`<tr>
                <td class="mono xs" title="${esc(key)}">${esc(key.slice(0,55))}${key.length>55?'â€¦':''}</td>
                <td style="text-align:right;color:var(--green)">${(row.clicks||0).toLocaleString()}</td>
                <td style="text-align:right">${(row.impressions||0).toLocaleString()}</td>
                <td style="text-align:right;color:${(row.ctr||0)>0.05?'var(--green)':'var(--yellow)'}">${((row.ctr||0)*100).toFixed(1)}%</td>
                <td style="text-align:right;color:${(row.position||99)<10?'var(--green)':(row.position||99)<20?'var(--yellow)':'var(--red)'}">${(row.position||0).toFixed(1)}</td>
                <td style="font-size:9px">
                  ${zeroImp?'<span style="color:var(--yellow)">0 impr</span>':''}
                  ${highPos?'<span style="color:var(--red)">pos>20</span>':''}
                </td>
              </tr>`;
            }).join('')}</tbody>
          </table></div></div>
        </div>
      </div>`;
    }
    log(`Performance pulled: ${_gscPerfData.length} rows Â· ${totalClicks.toLocaleString()} clicks Â· ${totalImpr.toLocaleString()} impressions`,'ok');
  }catch(e){
    if(prog)prog.style.width='0%';
    log(`Performance pull failed: ${e.message}`,'err');
  }
  APP.running=false;setStatus('Done');
}

function gsc_exportPerf(){
  if(!_gscPerfData.length){log('No performance data','warn');return;}
  const dim=(document.getElementById('gsc-perf-dim')||{value:'page'}).value;
  dlCSV(`${dim},Clicks,Impressions,CTR,Position\n`+_gscPerfData.map(r=>`"${r.keys[0]}",${r.clicks||0},${r.impressions||0},${((r.ctr||0)*100).toFixed(2)},${(r.position||0).toFixed(1)}`).join('\n'),'gsc_performance.csv');
}

// â”€â”€â”€ Coverage report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _gscCovData=null;
async function gsc_pullCoverage(){
  const token=SS.raw('rf_gsc_token','');
  const site=SS.raw('rf_gsc_site','');
  if(!token||!site){log('GSC token and site required','err');return;}
  const prog=document.getElementById('gsc-cov-prog');
  if(prog)prog.style.width='20%';
  log('Pulling coverage report from GSC...','info');
  APP.running=true;setStatus('Pulling coverage...');
  // GSC doesn't have a direct "coverage" endpoint â€” we pull sitemaps list and inspection data
  // Simulate structured coverage data from sitemaps API
  try{
    const resp=await fetch(`https://searchconsole.googleapis.com/webmasters/v3/sites/${encodeURIComponent(site)}/sitemaps`,{
      headers:{'Authorization':`Bearer ${token}`},signal:AbortSignal.timeout(15000)
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const data=await resp.json();
    if(prog)prog.style.width='70%';
    const sitemaps=data.sitemap||[];
    _gscCovData={sitemaps,retrieved:today()};
    const el=document.getElementById('gsc-cov-results');
    if(el){
      let totalSubmitted=0,totalIndexed=0;
      sitemaps.forEach(s=>{(s.contents||[]).forEach(c=>{totalSubmitted+=(c.submitted||0);totalIndexed+=(c.indexed||0);});});
      el.innerHTML=`
      <div class="panel">
        <div class="panel-head">Coverage Report â€” ${sitemaps.length} Sitemaps</div>
        <div class="panel-body">
          <div class="g3" style="margin-bottom:10px">
            <div class="stat"><div class="stat-v sv-g">${totalIndexed.toLocaleString()}</div><div class="stat-l">Total Indexed</div></div>
            <div class="stat"><div class="stat-v sv-b">${totalSubmitted.toLocaleString()}</div><div class="stat-l">Submitted</div></div>
            <div class="stat"><div class="stat-v sv-y">${totalSubmitted-totalIndexed>0?totalSubmitted-totalIndexed:0}</div><div class="stat-l">Gap (not indexed)</div></div>
          </div>
          <div class="tbl-wrap"><table>
            <thead><tr><th>Sitemap</th><th>Type</th><th>Last Downloaded</th><th>Submitted</th><th>Indexed</th><th>Coverage</th></tr></thead>
            <tbody>${sitemaps.map(s=>{
              let sub=0,idx=0;(s.contents||[]).forEach(c=>{sub+=c.submitted||0;idx+=c.indexed||0;});
              const rate=sub>0?Math.round(idx/sub*100):0;
              return`<tr>
                <td class="mono xs" style="max-width:200px" title="${esc(s.path)}">${esc((s.path||'').slice(0,50))}</td>
                <td class="xs">${esc(s.type||'sitemap')}</td>
                <td class="mono xs tm">${s.lastDownloaded?s.lastDownloaded.slice(0,10):'â€”'}</td>
                <td style="text-align:right">${sub.toLocaleString()}</td>
                <td style="text-align:right;color:var(--green)">${idx.toLocaleString()}</td>
                <td>
                  <div style="display:flex;align-items:center;gap:6px">
                    <div style="flex:1;height:5px;background:var(--win-panel3);border-radius:2px">
                      <div style="width:${rate}%;height:100%;background:${rate>=80?'var(--green)':rate>=50?'var(--yellow)':'var(--red)'};border-radius:2px"></div>
                    </div>
                    <span class="mono xs" style="color:${rate>=80?'var(--green)':rate>=50?'var(--yellow)':'var(--red)'}">${rate}%</span>
                  </div>
                </td>
              </tr>`;
            }).join('')}</tbody>
          </table></div>
          ${totalSubmitted-totalIndexed>0?`<div class="notice ni-y" style="margin-top:8px">${totalSubmitted-totalIndexed} submitted URLs not indexed â€” <button class="tbtn go" style="font-size:10px" onclick="gsc_pushExcludedToIndexer()">ğŸ“¡ Push to Indexer</button></div>`:''}
        </div>
      </div>`;
    }
    if(prog)prog.style.width='100%';
    log(`Coverage pulled: ${sitemaps.length} sitemaps Â· ${totalIndexed}/${totalSubmitted} indexed`,'ok');
  }catch(e){
    if(prog)prog.style.width='0%';
    log(`Coverage pull failed: ${e.message}`,'err');
  }
  APP.running=false;setStatus('Done');
}

function gsc_exportCoverage(){
  if(!_gscCovData){log('Pull coverage report first','warn');return;}
  const rows=_gscCovData.sitemaps.map(s=>{
    let sub=0,idx=0;(s.contents||[]).forEach(c=>{sub+=c.submitted||0;idx+=c.indexed||0;});
    return`"${s.path||''}","${s.type||''}","${s.lastDownloaded?.slice(0,10)||'â€”'}",${sub},${idx}`;
  });
  dlCSV('Sitemap,Type,LastDownloaded,Submitted,Indexed\n'+rows.join('\n'),'gsc_coverage.csv');
}

// â”€â”€â”€ Crawl stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gsc_pullCrawlStats(){
  const token=SS.raw('rf_gsc_token','');
  const site=SS.raw('rf_gsc_site','');
  if(!token||!site){log('GSC token and site required','err');return;}
  const prog=document.getElementById('gsc-crawl-prog');
  if(prog)prog.style.width='30%';
  log('Pulling crawl stats...','info');
  APP.running=true;setStatus('Pulling crawl stats...');
  try{
    const resp=await fetch(`https://searchconsole.googleapis.com/webmasters/v3/sites/${encodeURIComponent(site)}/urlCrawlErrorsSummary`,{
      headers:{'Authorization':`Bearer ${token}`},signal:AbortSignal.timeout(15000)
    });
    if(prog)prog.style.width='70%';
    let crawlStats=null;
    if(resp.ok){crawlStats=await resp.json();}
    else{const e=await resp.json();log(`Crawl errors API: ${e.error?.message||resp.status}`,'warn');}

    // Also try the crawl stats API (v1)
    const resp2=await fetch(`https://searchconsole.googleapis.com/v1/sites/${encodeURIComponent(site)}/crawlStats`,{
      headers:{'Authorization':`Bearer ${token}`},signal:AbortSignal.timeout(15000)
    }).catch(()=>null);
    let crawlStats2=null;
    if(resp2?.ok) crawlStats2=await resp2.json().catch(()=>null);

    if(prog)prog.style.width='100%';
    const el=document.getElementById('gsc-crawl-results');
    if(el){
      const summary=crawlStats2?.summaryByPage||crawlStats2?.summary||null;
      el.innerHTML=`
      <div class="panel">
        <div class="panel-head">Crawl Statistics</div>
        <div class="panel-body">
          ${crawlStats2?`
          <div class="notice ni-g" style="margin-bottom:8px">âœ… Crawl Stats API connected</div>
          ${summary?`
          <div class="g4" style="margin-bottom:10px">
            <div class="stat"><div class="stat-v sv-b">${summary.byStatusCode?.find(s=>s.statusCode==='200')?.count||'â€”'}</div><div class="stat-l">200 OK Crawls</div></div>
            <div class="stat"><div class="stat-v sv-r">${(summary.byStatusCode||[]).filter(s=>s.statusCode!=='200').reduce((a,s)=>a+(s.count||0),0)||'â€”'}</div><div class="stat-l">Error Crawls</div></div>
            <div class="stat"><div class="stat-v sv-y">${summary.crawlErrors?.count||'â€”'}</div><div class="stat-l">Crawl Errors</div></div>
            <div class="stat"><div class="stat-v sv-g">${summary.totalCrawledUrls||'â€”'}</div><div class="stat-l">Total Crawled</div></div>
          </div>`:
          `<pre style="font-size:9px;font-family:var(--mono);color:var(--text3);background:var(--win-panel2);padding:8px;border-radius:2px;max-height:200px;overflow:auto">${JSON.stringify(crawlStats2,null,2).slice(0,2000)}</pre>`}
          `:`<div class="notice ni-y">Crawl Stats API requires additional permissions. Try the URL Crawl Errors endpoint instead.</div>`}
          ${crawlStats?.countPerTypes?`
          <div style="margin-top:10px">
            <div class="panel-head" style="margin-bottom:6px">URL Crawl Error Types</div>
            <div class="tbl-wrap"><table>
              <thead><tr><th>Platform</th><th>Category</th><th>Count</th></tr></thead>
              <tbody>${(crawlStats.countPerTypes||[]).map(t=>`<tr>
                <td class="xs">${esc(t.platform||'')}</td>
                <td class="xs">${esc(t.category||'')}</td>
                <td style="color:var(--red)">${t.entries?.length||0}</td>
              </tr>`).join('')}</tbody>
            </table></div>
          </div>`:''}
        </div>
      </div>`;
    }
    log('Crawl stats retrieved','ok');
  }catch(e){
    const el=document.getElementById('gsc-crawl-results');
    if(el)el.innerHTML=`<div class="notice ni-r">Crawl stats failed: ${esc(e.message)}</div>`;
    log(`Crawl stats failed: ${e.message}`,'err');
  }
  APP.running=false;setStatus('Done');
}

// â”€â”€â”€ Manual actions checker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gsc_checkManualActions(){
  const token=SS.raw('rf_gsc_token','');
  const site=SS.raw('rf_gsc_site','');
  if(!token||!site){log('GSC token and site required','err');return;}
  log('Checking for manual actions...','info');
  const el=document.getElementById('gsc-manual-results');
  if(el)el.innerHTML='<div style="color:var(--text3);font-size:10px">Checking...</div>';
  try{
    const resp=await fetch(`https://searchconsole.googleapis.com/webmasters/v3/sites/${encodeURIComponent(site)}/manualActions`,{
      headers:{'Authorization':`Bearer ${token}`},signal:AbortSignal.timeout(15000)
    });
    if(!resp.ok){const e=await resp.json();throw new Error(e.error?.message||`HTTP ${resp.status}`);}
    const data=await resp.json();
    const alerts=SS.get('rf_gsc_alerts',[]);
    if(data.actions&&data.actions.length){
      data.actions.forEach(a=>{alerts.push({type:'manual',message:`âš  Manual action: ${a.actionType||'Unknown'} â€” ${a.summary||''}`,url:site,date:today()});});
      SS.set('rf_gsc_alerts',alerts);
    }
    if(el){
      if(!data.actions||!data.actions.length){
        el.innerHTML='<div class="notice ni-g">âœ… No manual actions detected on this property.</div>';
        log('âœ… No manual actions found','ok');
      } else {
        el.innerHTML=`
        <div class="notice ni-r" style="margin-bottom:8px">ğŸš¨ ${data.actions.length} manual action(s) detected!</div>
        ${data.actions.map(a=>`
        <div class="panel" style="border-color:var(--red)">
          <div class="panel-head" style="color:var(--red)">âš  ${esc(a.actionType||'Manual Action')}</div>
          <div class="panel-body">
            <div style="font-size:11px;margin-bottom:6px">${esc(a.summary||'')}</div>
            ${a.urls?.length?`<div style="font-size:10px;color:var(--text3)">Affected URLs:</div>
            ${a.urls.slice(0,10).map(u=>`<div class="mono xs" style="color:var(--red)">${esc(u)}</div>`).join('')}`:'<div style="font-size:10px;color:var(--text3)">Affects entire site</div>'}
          </div>
        </div>`).join('')}
        <div class="notice ni-b" style="margin-top:8px">To resolve: search.google.com/search-console â†’ Manual Actions â†’ submit reconsideration request after fixing.</div>`;
        log(`ğŸš¨ ${data.actions.length} manual action(s) found!`,'err');
      }
    }
  }catch(e){
    if(el)el.innerHTML=`<div class="notice ni-r">Manual action check failed: ${esc(e.message)}<br><span style="font-size:10px">Note: this API may require site-owner verification scope.</span></div>`;
    log(`Manual action check failed: ${e.message}`,'warn');
  }
}

// â”€â”€â”€ Snapshots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gsc_saveSnapshot(){
  const name=(document.getElementById('gsc-snap-name')||{value:''}).value.trim()||`Snapshot ${new Date().toLocaleString()}`;
  const results=SS.get('rf_gsc_results',[]);
  if(!results.length){log('No inspection results to snapshot','warn');return;}
  const snaps=gsc_snapshotsGet();
  snaps.push({name,date:today(),results:JSON.parse(JSON.stringify(results)),indexed:results.filter(r=>r.verdict==='PASS').length});
  // Keep max 10 snapshots
  if(snaps.length>10)snaps.shift();
  gsc_snapshotsSave(snaps);
  log(`Snapshot saved: "${name}" (${results.length} URLs)`,'ok');
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}

function gsc_deleteSnapshot(i){
  const snaps=gsc_snapshotsGet();snaps.splice(i,1);gsc_snapshotsSave(snaps);
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}

function gsc_compareSnapshots(){
  const snaps=gsc_snapshotsGet();
  const aIdx=parseInt((document.getElementById('gsc-snap-a')||{value:0}).value)||0;
  const bIdx=parseInt((document.getElementById('gsc-snap-b')||{value:snaps.length-1}).value)||(snaps.length-1);
  const snapA=snaps[aIdx];const snapB=snaps[bIdx];
  if(!snapA||!snapB){log('Select two snapshots to compare','warn');return;}
  const mapA={};snapA.results.forEach(r=>{mapA[r.url]=r;});
  const mapB={};snapB.results.forEach(r=>{mapB[r.url]=r;});
  const allUrls=new Set([...Object.keys(mapA),...Object.keys(mapB)]);
  const changes=[];
  allUrls.forEach(url=>{
    const a=mapA[url];const b=mapB[url];
    if(!a&&b){changes.push({url,change:'new',from:'â€”',to:b.verdict,color:'var(--blue)'});}
    else if(a&&!b){changes.push({url,change:'removed',from:a.verdict,to:'â€”',color:'var(--text3)'});}
    else if(a.verdict!==b.verdict){
      const improved=b.verdict==='PASS'&&a.verdict!=='PASS';
      const dropped=a.verdict==='PASS'&&b.verdict!=='PASS';
      changes.push({url,change:improved?'improved':dropped?'dropped':'changed',from:a.verdict,to:b.verdict,color:improved?'var(--green)':dropped?'var(--red)':'var(--yellow)'});
    }
  });
  const improved=changes.filter(c=>c.change==='improved').length;
  const dropped=changes.filter(c=>c.change==='dropped').length;
  const el=document.getElementById('gsc-compare-results');
  if(!el)return;
  el.innerHTML=`
  <div class="g4" style="margin-bottom:10px">
    <div class="stat"><div class="stat-v sv-g">${snapA.indexed}</div><div class="stat-l">${esc(snapA.name.slice(0,15))} indexed</div></div>
    <div class="stat"><div class="stat-v sv-g">${snapB.indexed}</div><div class="stat-l">${esc(snapB.name.slice(0,15))} indexed</div></div>
    <div class="stat"><div class="stat-v sv-g">+${improved}</div><div class="stat-l">Newly Indexed</div></div>
    <div class="stat"><div class="stat-v sv-r">-${dropped}</div><div class="stat-l">Dropped</div></div>
  </div>
  ${changes.length?`
  <div class="tbl-wrap" style="max-height:350px"><table>
    <thead><tr><th>URL</th><th>Change</th><th>Before</th><th>After</th></tr></thead>
    <tbody>${changes.map(c=>`<tr>
      <td class="mono xs" title="${esc(c.url)}">${esc(c.url.slice(0,55))}â€¦</td>
      <td><span style="font-size:10px;font-weight:700;color:${c.color}">${c.change.toUpperCase()}</span></td>
      <td><span class="badge ${c.from==='PASS'?'bg':c.from==='â€”'?'bgray':'br'}" style="font-size:8px">${c.from}</span></td>
      <td><span class="badge ${c.to==='PASS'?'bg':c.to==='â€”'?'bgray':'br'}" style="font-size:8px">${c.to}</span></td>
    </tr>`).join('')}</tbody>
  </table></div>
  <div class="flex g6 mt8">
    <button class="tbtn" onclick="dlCSV('URL,Change,Before,After\\n'+${JSON.stringify(changes)}.map(c=>'\"'+c.url+'\",'+c.change+','+c.from+','+c.to).join('\\n'),'gsc_comparison.csv')" style="font-size:10px">ğŸ“¥ Export Comparison</button>
  </div>`:'<div style="color:var(--text3);font-size:10px">No changes detected between snapshots.</div>'}`;
  log(`Comparison: +${improved} indexed, -${dropped} dropped between "${snapA.name}" and "${snapB.name}"`,'ok');
}

// â”€â”€â”€ Alerts helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gsc_dismissAlert(i){
  const alerts=SS.get('rf_gsc_alerts',[]);alerts.splice(i,1);SS.set('rf_gsc_alerts',alerts);
  render_gsc_inspector(document.getElementById('page-gsc_inspector'));
}

function gsc_exportZeroImpressions(){
  const results=SS.get('rf_gsc_results',[]);
  const zero=results.filter(r=>r.verdict==='PASS'&&r.impressions===0);
  if(!zero.length){log('No zero-impression URLs','warn');return;}
  dlTxt(zero.map(r=>r.url).join('\n'),'zero_impressions.txt');
  log(`Exported ${zero.length} zero-impression URLs`,'ok');
}
function gsc_exportDropped(){
  const results=SS.get('rf_gsc_results',[]);
  const dropped=results.filter(r=>r.wasIndexed&&r.verdict!=='PASS');
  if(!dropped.length){log('No dropped URLs','warn');return;}
  dlCSV('URL,PreviousVerdict,CurrentVerdict,Date\n'+dropped.map(r=>`"${r.url}","${r.wasIndexed}","${r.verdict}","${r.inspectedAt||today()}"`).join('\n'),'dropped_from_index.csv');
  log(`Exported ${dropped.length} dropped URLs`,'ok');
}

function gsc_export(){dlCSV('URL,Verdict,CoverageState,CrawlStatus,LastCrawled,Mobile,RichResult,Impressions,Clicks,Date\n'+SS.get('rf_gsc_results',[]).map(r=>`"${r.url}","${r.verdict}","${r.coverageState||'â€”'}","${r.crawlStatus||'â€”'}","${r.lastCrawled||'â€”'}","${r.mobile||'â€”'}","${r.richResult||'â€”'}","${r.impressions!==null&&r.impressions!==undefined?r.impressions:'â€”'}","${r.clicks!==undefined?r.clicks:'â€”'}","${r.inspectedAt||today()}"`).join('\n'),'gsc_inspection_v2.csv');log('Exported GSC data','ok');}
function gsc_clear(){if(confirm('Clear all inspection results?')){SS.set('rf_gsc_results',[]);render_gsc_inspector(document.getElementById('page-gsc_inspector'));}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIST MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render_list_manager(el){
  el.innerHTML=`
  <div class="panel">
    <div class="panel-head">ğŸ“‹ URL List Manager â€” Global List
      <div class="ph-r"><span class="badge bg">${APP.urlList.length} URLs</span></div>
    </div>
    <div class="panel-body">
      <div class="flex g6" style="margin-bottom:6px;flex-wrap:wrap">
        <button class="tbtn" onclick="undoAction()" title="Ctrl+Z">â†© Undo</button>
        <button class="tbtn" onclick="redoAction()" title="Ctrl+Y">â†ª Redo</button>
        <button class="tbtn" onclick="lm_dedup()">ğŸ” Deduplicate</button>
        <button class="tbtn" onclick="lm_clean()">ğŸ§¹ Clean</button>
        <button class="tbtn" onclick="lm_sort()">â†• Sort A-Z</button>
        <button class="tbtn" onclick="lm_shuffle()">ğŸ² Shuffle</button>
        <button class="tbtn" onclick="lm_filter()">ğŸ”½ Filter</button>
        <button class="tbtn" onclick="lm_export()">ğŸ“¥ Export TXT</button>
        <button class="tbtn" onclick="lm_clear()">ğŸ—‘ Clear All</button>
      </div>
      <div class="g2" style="margin-bottom:6px">
        <div class="fg"><label class="lbl">Filter (keep URLs containing)</label><input type="text" id="lm-filter-kw" placeholder="blog, post, article..."/></div>
        <div class="fg"><label class="lbl">Remove (remove URLs containing)</label><input type="text" id="lm-remove-kw" placeholder=".gov, .edu, admin..."/></div>
      </div>
      <textarea id="url-list-ta" rows="16" placeholder="Paste URLs here or load from any tool...">${APP.urlList.join('\n')}</textarea>
      <div class="list-stats">
        URLs: <span id="lm-count">${APP.urlList.length}</span> Â·
        Unique domains: <span id="lm-domains">${new Set(APP.urlList.map(u=>{try{return new URL(u).hostname}catch(e){return u}})).size}</span> Â·
        Est. size: <span>${Math.round(APP.urlList.join('\n').length/1024)}KB</span>
      </div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="lm_save()">ğŸ’¾ Save List</button>
        <button class="tbtn" onclick="lm_import()">ğŸ“‚ Load from Textarea</button>
      </div>
    </div>
  </div>`;
}

function lm_save(){const ta=document.getElementById('url-list-ta');if(!ta)return;APP.urlList=ta.value.split('\n').map(u=>u.trim()).filter(Boolean);SS.set('rf_urllist',APP.urlList);document.getElementById('lm-count').textContent=APP.urlList.length;const domains=new Set(APP.urlList.map(u=>{try{return new URL(u).hostname}catch(e){return u}}));document.getElementById('lm-domains').textContent=domains.size;updateStats();log(`List saved â€” ${APP.urlList.length} URLs`,'ok');}
function lm_import(){ lm_save(); }
function lm_dedup(){const ta=document.getElementById('url-list-ta');if(!ta)return;const urls=[...new Set(ta.value.split('\n').map(u=>u.trim()).filter(Boolean))];ta.value=urls.join('\n');log(`Deduplicated â€” ${urls.length} unique URLs`,'ok');}
function lm_clean(){const bad=['.gov','.edu','facebook.com','twitter.com','instagram.com','youtube.com','amazon.com','wikipedia.org'];const ta=document.getElementById('url-list-ta');if(!ta)return;const before=ta.value.split('\n').filter(Boolean).length;const cleaned=ta.value.split('\n').filter(u=>!bad.some(b=>u.includes(b)));ta.value=cleaned.join('\n');log(`Cleaned â€” removed ${before-cleaned.length} bad URLs`,'ok');}
function lm_shuffle(){const ta=document.getElementById('url-list-ta');if(!ta)return;const urls=ta.value.split('\n').map(u=>u.trim()).filter(Boolean);for(let i=urls.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[urls[i],urls[j]]=[urls[j],urls[i]];}ta.value=urls.join('\n');log(`Shuffled ${urls.length} URLs â€” patterns randomized`,'ok');}
function lm_sort(){const ta=document.getElementById('url-list-ta');if(!ta)return;ta.value=ta.value.split('\n').map(u=>u.trim()).filter(Boolean).sort().join('\n');log('List sorted A-Z','ok');}
function lm_filter(){const fkw=(document.getElementById('lm-filter-kw')||{value:''}).value.trim().toLowerCase();const rkw=(document.getElementById('lm-remove-kw')||{value:''}).value.trim().toLowerCase();const ta=document.getElementById('url-list-ta');if(!ta)return;let urls=ta.value.split('\n').map(u=>u.trim()).filter(Boolean);if(fkw)urls=urls.filter(u=>fkw.split(',').some(k=>u.toLowerCase().includes(k.trim())));if(rkw)urls=urls.filter(u=>!rkw.split(',').some(k=>u.toLowerCase().includes(k.trim())));ta.value=urls.join('\n');log(`Filtered â€” ${urls.length} URLs remain`,'ok');}
function lm_export(){dlTxt(APP.urlList.join('\n'),'url_list.txt');}
function lm_clear(){if(confirm('Clear entire URL list?')){APP.urlList=[];SS.set('rf_urllist',[]);render_list_manager(document.getElementById('page-list_manager'));updateStats();}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOOTPRINT BUILDER v2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Master Footprint Pack â€” 20 Categories â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each category has: type (backlink type), tier, icon, desc, queries[], signals[]
// {kw} = user keyword placeholder; signals = what makes a URL a good target

const FP_PACK = [
  {
    id: 'pdf_doc', label: 'PDF / Document Sharing', icon: 'ğŸ“„', tier: 'T2', type: 'document',
    desc: 'Upload PDFs/docs with embedded links. High DA sites, crawled well by Google.',
    signals: ['inurl:/document/', 'inurl:/pdf/', 'filetype:pdf'],
    queries: [
      '"{kw}" "upload pdf" "share document" submit',
      '"{kw}" inurl:/document/ "submit document"',
      '"{kw}" inurl:/pdf/ "upload" site:scribd.com OR site:slideshare.net OR site:issuu.com',
      '"{kw}" "document library" "submit whitepaper"',
      '"{kw}" "publish document" "free pdf upload"',
      '"{kw}" "submit case study" inurl:/library/',
      '"{kw}" filetype:pdf "submit" "upload research paper"',
      '"{kw}" "share ebook" inurl:/upload/ "document"',
      'intitle:"{kw}" "inurl:/document/" "add document"',
      '"{kw}" site:scribd.com "upload" "share"',
    ]
  },
  {
    id: 'slides', label: 'Slide / Presentation Sites', icon: 'ğŸï¸', tier: 'T2', type: 'document',
    desc: 'Upload PPT/PDF presentations with embedded links. LinkedIn-owned SlideShare = DA95.',
    signals: ['inurl:/slides/', 'upload presentation', 'share slides'],
    queries: [
      '"{kw}" "upload presentation" "share slides" submit',
      '"{kw}" inurl:/slides/ "presentation library"',
      '"{kw}" "submit ppt" OR "upload pptx" "slide hosting"',
      '"{kw}" site:slideshare.net "upload" OR "share"',
      '"{kw}" "free slide upload" "public presentations"',
      '"{kw}" "share your presentation" inurl:/presentations/',
      'intitle:"{kw}" "presentation" "upload" site:prezi.com OR site:canva.com',
      '"{kw}" "slide deck" "submit" "publish slides"',
    ]
  },
  {
    id: 'image', label: 'Image Sharing Sites', icon: 'ğŸ–¼ï¸', tier: 'T3', type: 'image',
    desc: 'Upload infographics/images with keyword-rich descriptions and dofollow profile links.',
    signals: ['inurl:/gallery/', 'inurl:/image/', 'upload image'],
    queries: [
      '"{kw}" "upload image" "photo sharing community"',
      '"{kw}" inurl:/gallery/ "submit artwork"',
      '"{kw}" inurl:/image/ "post image" "free image hosting"',
      '"{kw}" "upload infographic" "submit illustration"',
      '"{kw}" "share photo" inurl:/photos/ "community"',
      'intitle:"{kw}" "image gallery" "upload" site:flickr.com OR site:deviantart.com',
      '"{kw}" "visual content" "submit" "free image hosting"',
    ]
  },
  {
    id: 'doc_publish', label: 'Document Publishing Platforms', icon: 'ğŸ“š', tier: 'T1/T2', type: 'article',
    desc: 'Publish full articles/reports with embedded links. High-trust editorial context.',
    signals: ['inurl:/articles/', 'publish article', 'submit content'],
    queries: [
      '"{kw}" "publish article" "submit content" "knowledge hub"',
      '"{kw}" inurl:/articles/ "submit research"',
      '"{kw}" "share report" "publish insights" inurl:/blog/',
      '"{kw}" "write for us" "guest article" inurl:/submit/',
      '"{kw}" inurl:/articles/ "contribute" site:medium.com OR site:substack.com',
      'intitle:"{kw}" "article" "submit" "editorial",',
      '"{kw}" "thought leadership" "publish" "submit content"',
      '"{kw}" "research paper" "submit" "inurl:/research/"',
    ]
  },
  {
    id: 'profiles', label: 'Profile Creation Sites', icon: 'ğŸ‘¤', tier: 'T2/T3', type: 'profile',
    desc: 'Create public user profiles with dofollow website fields. Hundreds of sites accept profile links.',
    signals: ['inurl:/user/profile', 'inurl:/members/', 'author profile'],
    queries: [
      '"create profile" "public user profile" "member directory"',
      'inurl:/user/profile "website" "add url"',
      'inurl:/members/ "author profile" "website" dofollow',
      '"community members" inurl:/register "profile" "website field"',
      'inurl:/authors/ "bio" "website" "add link"',
      'inurl:/about/ "team member" "profile" "external link"',
      '"user profile" "website" inurl:/profile/ "public"',
      '"contributor profile" inurl:/contributors/ "website url"',
    ]
  },
  {
    id: 'directory', label: 'Directory Sites', icon: 'ğŸ“‚', tier: 'T2/T3', type: 'directory',
    desc: 'Submit business listings with dofollow links. Local + niche directories for citation building.',
    signals: ['inurl:/directory/', 'submit site', 'add listing'],
    queries: [
      '"{kw}" "business directory" "submit site" "add listing"',
      '"{kw}" inurl:/directory/ "free listing" "submit business"',
      '"{kw}" "company directory" "add company" inurl:/listings/',
      '"{kw}" "local listing" "list your website" "business directory"',
      '"{kw}" "niche directory" "submit url" inurl:/submit/',
      '"{kw}" "industry directory" inurl:/directory/ "free"',
      '"{kw}" site:yelp.com OR site:yellowpages.com OR site:foursquare.com "add business"',
      'intitle:"{kw} directory" "submit" "free listing"',
      '"{kw}" "web directory" inurl:/dir/ "add site"',
    ]
  },
  {
    id: 'forums', label: 'Forums', icon: 'ğŸ§ ', tier: 'T2/T3', type: 'forum',
    desc: 'Forum signature links + contextual post links. Target topically relevant boards.',
    signals: ['inurl:/forum/', 'powered by vbulletin', 'powered by phpbb', 'powered by xenforo'],
    queries: [
      '"{kw}" inurl:/forum/ "post reply" "powered by vBulletin"',
      '"{kw}" "Powered by phpBB" inurl:viewtopic "post reply"',
      '"{kw}" "Powered by XenForo" inurl:/threads/ "reply"',
      '"{kw}" "discussion board" "join discussion" inurl:/community/',
      '"{kw}" "forum registration" "new thread" "post reply"',
      '"{kw}" inurl:/forum/ "signature" "website" dofollow',
      'intitle:"{kw}" "forum" "reply" inurl:thread',
      '"{kw}" "community forum" "post" "reply" "register"',
    ]
  },
  {
    id: 'community', label: 'Community Platforms', icon: 'ğŸ’¬', tier: 'T2', type: 'community',
    desc: 'Modern community platforms (Circle, Discord, Mighty Networks). Profile + post links.',
    signals: ['inurl:/groups/', 'inurl:/discussion/', 'community platform'],
    queries: [
      '"{kw}" "community platform" "create topic" inurl:/groups/',
      '"{kw}" inurl:/discussion/ "join community" "member"',
      '"{kw}" "knowledge forum" "user discussions" "post"',
      '"{kw}" inurl:/community/ "create topic" "member community"',
      '"{kw}" "open community" "post discussion" inurl:/groups/',
      'intitle:"{kw}" "community" "join" inurl:/c/ OR inurl:/group/',
      '"{kw}" "discourse" "post" inurl:/t/ "reply"',
    ]
  },
  {
    id: 'qa', label: 'Q&A Websites', icon: 'â“', tier: 'T1/T2', type: 'qa',
    desc: 'Answer questions with contextual dofollow/nofollow links. High traffic, indexed fast.',
    signals: ['inurl:/questions/', 'inurl:/answers/', 'community Q&A'],
    queries: [
      '"{kw}" inurl:/questions/ "ask question" "answer"',
      '"{kw}" "community Q&A" "post your question" inurl:/answers/',
      '"{kw}" site:quora.com "answer" "source"',
      '"{kw}" site:reddit.com "question" "help" "link"',
      '"{kw}" "knowledge exchange" inurl:/questions/ "answer"',
      '"{kw}" "get answers" "question forum" "helpful links"',
      '"{kw}" site:stackexchange.com OR site:stackoverflow.com "answer" "link"',
      'intitle:"{kw}" "how do I" OR "what is" "site:quora.com"',
    ]
  },
  {
    id: 'edu', label: 'EDU Resource Pages', icon: 'ğŸ›ï¸', tier: 'T1', type: 'edu',
    desc: 'EDU resource page links = highest authority tier. Outreach or resource page infiltration.',
    signals: ['site:.edu', 'resources', 'useful links'],
    queries: [
      'site:.edu "{kw}" "resources" "useful links"',
      'site:.edu "{kw}" "recommended websites" "external resources"',
      'site:.edu "{kw}" "student resources" "learning links"',
      'site:.edu "{kw}" "research tools" "helpful sites"',
      'site:.edu "{kw}" "link directory" "external links"',
      'site:.edu intitle:"resources" "{kw}" "websites"',
      'site:.edu "{kw}" "resource page" "add link" OR "suggest resource"',
      'site:.edu "{kw}" "further reading" "references" "websites"',
    ]
  },
  {
    id: 'gov', label: 'GOV Resource Pages', icon: 'ğŸ¢', tier: 'T1', type: 'gov',
    desc: 'GOV resource pages = maximum trust. Rare but extremely high-value link targets.',
    signals: ['site:.gov', 'resources', 'external links'],
    queries: [
      'site:.gov "{kw}" "resources" "useful links"',
      'site:.gov "{kw}" "external links" "recommended websites"',
      'site:.gov "{kw}" "community resources" "public resources"',
      'site:.gov "{kw}" "helpful websites" "resource list"',
      'site:.gov intitle:"resources" "{kw}"',
      'site:.gov "{kw}" "partner links" "related sites"',
    ]
  },
  {
    id: 'events', label: 'Event Websites', icon: 'ğŸ—“ï¸', tier: 'T2/T3', type: 'event',
    desc: 'Submit events with dofollow links back to your site. Event sites indexed quickly.',
    signals: ['inurl:/events/', 'submit event', 'event listing'],
    queries: [
      '"{kw}" "submit event" inurl:/events/ "community events"',
      '"{kw}" "add event" "public calendar" "event listing"',
      '"{kw}" "submit conference" OR "add meetup" inurl:/events/',
      '"{kw}" "list event" "event directory" "free listing"',
      '"{kw}" site:eventbrite.com OR site:meetup.com "create event"',
      '"{kw}" "event submission" inurl:/events/submit OR inurl:/add-event/',
      'intitle:"{kw} event" "submit" "community" inurl:/events/',
    ]
  },
  {
    id: 'paste', label: 'Paste / Bin Websites', icon: 'ğŸ“Œ', tier: 'T3', type: 'web20',
    desc: 'T3 base layer links. Create pastes with naked URLs pointing at T2 properties.',
    signals: ['inurl:/paste/', 'create paste', 'public paste'],
    queries: [
      '"paste text" "create paste" inurl:/paste/ "public"',
      '"free pastebin" "text sharing" "post snippet"',
      '"share code" "submit text" inurl:/p/ "public paste"',
      'site:pastebin.com OR site:paste.ee OR site:pastie.org "create" "share"',
      '"public paste" "raw text" inurl:/raw/ "share"',
    ]
  },
  {
    id: 'web20', label: 'Web 2.0 Platforms', icon: 'ğŸ§¾', tier: 'T1/T2', type: 'web20',
    desc: 'Create free blogs/pages with dofollow links. Core T1/T2 pyramid layer.',
    signals: ['inurl:/blog/', 'create blog', 'free blogging platform'],
    queries: [
      '"{kw}" "create blog" "free blogging platform" inurl:/blog/',
      '"{kw}" "write post" "new article" "publish story"',
      '"{kw}" site:wordpress.com OR site:medium.com OR site:blogger.com "write"',
      '"{kw}" site:tumblr.com OR site:substack.com "publish post"',
      '"{kw}" "start blog" "publish post" inurl:/write/',
      '"{kw}" "new article" "free blog" inurl:/create/',
      'intitle:"{kw}" "blog" "post" "write" "publish"',
    ]
  },
  {
    id: 'guest_post', label: 'Guest Post Targets', icon: 'ğŸ“¢', tier: 'T1', type: 'guestpost',
    desc: 'Editorial dofollow links from "write for us" pages. Highest quality outreach targets.',
    signals: ['"write for us"', '"submit guest post"', '"become contributor"'],
    queries: [
      '"{kw}" "write for us" "submit guest post"',
      '"{kw}" "contribute article" "guest author" inurl:/write-for-us/',
      '"{kw}" "become contributor" "submit content" inurl:/contribute/',
      '"{kw}" "guest post" "submit article" inurl:/guest-post/',
      'intitle:"write for us" "{kw}" "guidelines" "submit"',
      '"{kw}" "accepting guest posts" OR "guest post guidelines"',
      'inurl:write-for-us "{kw}" "guidelines" "link"',
      'inurl:guest-post "{kw}" "submit" "editorial"',
      '"{kw}" "contributors welcome" "editorial" inurl:/authors/',
    ]
  },
  {
    id: 'niche_dir', label: 'Niche Directories', icon: 'ğŸ“Š', tier: 'T2', type: 'directory',
    desc: 'Vertical/industry-specific directories. Higher relevance = better link equity.',
    signals: ['niche directory', 'industry directory', 'add website'],
    queries: [
      '"{kw}" "niche directory" "submit listing" "add website"',
      '"{kw}" "industry directory" "submit business" inurl:/directory/',
      '"{kw}" "vertical directory" "free submission" inurl:/submit/',
      'intitle:"{kw} directory" "submit" "free" "listing"',
      '"{kw}" "resource directory" "add site" "suggest link"',
      '"{kw}" "curated directory" "submit url" "review"',
    ]
  },
  {
    id: 'wiki', label: 'Wiki Style Websites', icon: 'ğŸ§¬', tier: 'T1/T2', type: 'wiki',
    desc: 'Wiki reference links. Add citations in relevant articles. Often dofollow.',
    signals: ['inurl:/wiki/', 'community wiki', 'edit page'],
    queries: [
      '"{kw}" inurl:/wiki/ "edit page" "community wiki"',
      '"{kw}" "open wiki" "knowledge base" inurl:/wiki/',
      '"{kw}" site:wikia.com OR site:fandom.com "edit" "reference"',
      '"{kw}" "wiki" "add reference" inurl:/w/index.php',
      '"{kw}" "knowledge base" inurl:/kb/ "edit" "contribute"',
      'intitle:"{kw}" "wiki" "references" "external links"',
    ]
  },
  {
    id: 'bookmarks', label: 'Bookmarking Sites', icon: 'ğŸ§²', tier: 'T3', type: 'bookmark',
    desc: 'Social bookmarks for T3 base layer. Crawl signals + diversified anchor text.',
    signals: ['social bookmarking', 'submit link', 'save link'],
    queries: [
      '"{kw}" "social bookmarking" "submit link" "save link"',
      '"{kw}" "bookmark site" "add bookmark" inurl:/bookmark/',
      'site:diigo.com OR site:pearltrees.com OR site:pocket.com "{kw}"',
      '"{kw}" "bookmarking" inurl:/save/ OR inurl:/add/ "link"',
      '"social bookmarks" "{kw}" "submit" "tags"',
    ]
  },
  {
    id: 'webapp', label: 'Web App Platforms', icon: 'ğŸ§±', tier: 'T2', type: 'profile',
    desc: 'SaaS/web app public profiles with dofollow links. Often overlooked, low competition.',
    signals: ['create account', 'public profile', 'user dashboard'],
    queries: [
      '"create account" "public profile" "website" inurl:/profile/',
      '"start project" "community tools" "user dashboard" "link"',
      '"public workspace" inurl:/users/ "website" "profile"',
      '"web app" "user profile" "portfolio" "external link"',
      'inurl:/dashboard/ "public" "profile" "website"',
    ]
  },
  {
    id: 'saas_profiles', label: 'SaaS User Profiles', icon: 'ğŸ› ï¸', tier: 'T2/T3', type: 'profile',
    desc: 'SaaS platform public profiles. Hundreds of tools offer public pages with dofollow bio links.',
    signals: ['inurl:/users/', 'inurl:/profile/', 'public workspace'],
    queries: [
      'inurl:/users/ "public profile" "website" "team member"',
      'inurl:/profile/ "portfolio profile" "website url" dofollow',
      '"public workspace" "team member" inurl:/team/',
      'inurl:/portfolio/ "website" "bio" "external link"',
      '"user profile" "about me" "website" inurl:/u/ OR inurl:/user/',
      '"contributor" "website" inurl:/contributors/ "bio"',
      '"creator profile" "website" inurl:/creator/ dofollow',
    ]
  },
  // â”€â”€ Original CMS comment targets preserved â”€â”€â”€â”€â”€â”€â”€
  {
    id: 'wp_comments', label: 'WordPress (Comment targets)', icon: 'ğŸ’¬', tier: 'T2', type: 'comment',
    desc: 'High-value WordPress comment targets. Best for niche link building.',
    signals: ['"powered by WordPress"', '"leave a reply"', 'inurl:wp-comments-post'],
    queries: [
      '"{kw}" "powered by WordPress" "leave a reply"',
      '"{kw}" inurl:wp-comments-post "leave a comment"',
      '"{kw}" "powered by WordPress" "post a comment"',
      '"{kw}" site:wordpress.com "leave a reply"',
      'intitle:"{kw}" "powered by WordPress" "comments"',
      '"{kw}" inurl:/blog/ "powered by WordPress" "leave a reply"',
      '"{kw}" "wordpress.org" "comments are open"',
      'intitle:"{kw}" inurl:blog "leave a reply"',
    ]
  },
  {
    id: 'blogger', label: 'Blogger / Blogspot', icon: 'âœï¸', tier: 'T2', type: 'comment',
    desc: 'Blogger/Blogspot comment targets. DA 90+ inherited from google.com.',
    signals: ['site:blogspot.com', '"powered by Blogger"'],
    queries: [
      '"{kw}" site:blogspot.com "post a comment"',
      '"{kw}" site:blogger.com "leave a comment"',
      '"{kw}" inurl:blogspot.com "0 comments" OR "1 comment"',
      'intitle:"{kw}" site:blogspot.com "post a comment"',
      '"{kw}" "powered by Blogger" "post a comment"',
    ]
  },
  {
    id: 'drupal', label: 'Drupal', icon: 'ğŸ”µ', tier: 'T2', type: 'comment',
    desc: 'Drupal comment targets. Often government/education sites = high authority.',
    signals: ['"powered by Drupal"', '"add new comment"'],
    queries: [
      '"{kw}" "powered by Drupal" "add new comment"',
      '"{kw}" inurl:node "add new comment" Drupal',
      '"{kw}" "Drupal" "leave a comment" inurl:/node/',
      'intitle:"{kw}" "Drupal" "comments"',
    ]
  },
  {
    id: 'vbulletin', label: 'vBulletin Forums', icon: 'ğŸŸ ', tier: 'T2', type: 'forum',
    desc: 'vBulletin forum link opportunities. Signature + post links.',
    signals: ['"Powered by vBulletin"', 'inurl:showthread'],
    queries: [
      '"{kw}" "Powered by vBulletin" "reply to thread"',
      '"{kw}" inurl:showthread "vBulletin" "post reply"',
      'intitle:"{kw}" "vBulletin" forum inurl:thread',
    ]
  },
  {
    id: 'phpbb', label: 'phpBB Forums', icon: 'ğŸŸ£', tier: 'T2', type: 'forum',
    desc: 'phpBB forum targets. Wide install base across many niches.',
    signals: ['"Powered by phpBB"', 'inurl:viewtopic'],
    queries: [
      '"{kw}" "Powered by phpBB" "register" "post reply"',
      '"{kw}" inurl:viewtopic.php "phpBB" "post reply"',
      'intitle:"{kw}" "phpBB" inurl:phpbb',
    ]
  },
  {
    id: 'xenforo', label: 'XenForo Forums', icon: 'ğŸ”¶', tier: 'T2', type: 'forum',
    desc: 'XenForo forum targets. Modern forums, often high-traffic communities.',
    signals: ['"Powered by XenForo"', 'inurl:/threads/'],
    queries: [
      '"{kw}" "Community - XenForo" inurl:/threads/',
      '"{kw}" "Powered by XenForo" "post reply"',
      'intitle:"{kw}" inurl:xenforo "post reply"',
    ]
  },
];

// â”€â”€ Grouped category view for the Pack tab â”€â”€â”€â”€â”€â”€â”€â”€
const FP_PACK_GROUPS = [
  { label: 'Tier 1 â€” Highest Authority', color: 'var(--green)', ids: ['edu','gov','guest_post','qa','doc_publish','wiki'] },
  { label: 'Tier 2 â€” Mid Authority', color: 'var(--cyan)', ids: ['wp_comments','blogger','drupal','web20','slides','pdf_doc','profiles','directory','forums','niche_dir','community','events','webapp','saas_profiles'] },
  { label: 'Tier 3 â€” Base Layer', color: 'var(--yellow)', ids: ['paste','bookmarks','image','vbulletin','phpbb','xenforo'] },
];

// â”€â”€ Legacy FP_TEMPLATES wrapper for backward compat â”€â”€
const FP_TEMPLATES = Object.fromEntries(
  FP_PACK.map(cat => [cat.label, {
    cms: [cat.type],
    queries: cat.queries,
    desc: cat.desc,
    icon: cat.icon,
    tier: cat.tier,
    type: cat.type,
  }])
);

// â”€â”€ Search engine syntax maps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FP_ENGINE_SYNTAX = {
  google: {
    site: 'site:',       inurl: 'inurl:',    intitle: 'intitle:',
    intext: 'intext:',   filetype: 'filetype:', daterange: 'after:{after} before:{before}',
    lang: 'lr=lang_{lang}', country: 'gl={cc}',
    and: ' ',            or: ' OR ',          not: '-',
    exact: '"{term}"',   wrap: q=>q
  },
  bing: {
    site: 'site:',       inurl: 'inurl:',    intitle: 'intitle:',
    intext: 'inbody:',   filetype: 'filetype:', daterange: '',
    lang: 'language:{lang}', country: 'loc:{cc}',
    and: ' AND ',        or: ' OR ',          not: '-',
    exact: '"{term}"',   wrap: q=>q
  },
  duckduckgo: {
    site: 'site:',       inurl: 'inurl:',    intitle: 'intitle:',
    intext: 'inbody:',   filetype: '',        daterange: '',
    lang: '',            country: '',
    and: ' ',            or: ' OR ',          not: '-',
    exact: '"{term}"',   wrap: q=>q
  },
  yandex: {
    site: 'site:',       inurl: 'inurl:',    intitle: 'intitle:',
    intext: 'intext:',   filetype: '',        daterange: '',
    lang: 'lang:{lang}', country: 'domain:{cc}',
    and: ' ',            or: ' | ',           not: '~~',
    exact: '"{term}"',   wrap: q=>q
  }
};

const FP_ENGINE_URLS = {
  google: q=>`https://www.google.com/search?q=${encodeURIComponent(q)}`,
  bing:   q=>`https://www.bing.com/search?q=${encodeURIComponent(q)}`,
  duckduckgo: q=>`https://duckduckgo.com/?q=${encodeURIComponent(q)}`,
  yandex: q=>`https://yandex.com/search/?text=${encodeURIComponent(q)}`
};

// â”€â”€ Spam farm negative list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FP_SPAM_NEGATIVES = [
  'site:spamvillage','site:commentfarm','site:backlink-spam',
  'site:seo-spam','site:linkfarm','site:commentspam',
  '-"akismet"','-"spam"','-"reported abuse"'
];

// â”€â”€ Dork syntax validator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_validateDork(query){
  const errors=[];const warnings=[];
  // Check balanced quotes
  const quotes=query.match(/"/g)||[];
  if(quotes.length%2!==0)errors.push('Unbalanced quotes â€” every " must have a closing "');
  // Check known operators
  const validOps=['site:','inurl:','intitle:','intext:','inbody:','filetype:','after:','before:','OR','AND','-'];
  const usedOps=query.match(/\b(site|inurl|intitle|intext|inbody|filetype|after|before|OR|AND|lang|gl|lr|loc|domain)[\s:]/g)||[];
  // Check for common mistakes
  if(query.includes('  '))warnings.push('Double spaces detected â€” may affect results');
  if(query.length>256)warnings.push('Query is very long (>256 chars) â€” may be truncated');
  if(query.match(/OR\s+OR/))errors.push('Consecutive OR operators â€” invalid syntax');
  if(query.match(/site:[^\s]+\s+site:/))warnings.push('Multiple site: operators â€” only first is respected by most engines');
  if(!query.trim())errors.push('Empty query');
  if(query.match(/inurl:[^\s]*\s+inurl:/))warnings.push('Multiple inurl: â€” combine with parentheses for better results');
  const complexity = (query.match(/\bOR\b/g)||[]).length + (query.match(/site:|inurl:|intitle:/g)||[]).length;
  return {
    valid: errors.length===0,
    errors, warnings,
    complexity: complexity>4?'Complex':complexity>2?'Medium':'Simple',
    complexityColor: complexity>4?'var(--yellow)':complexity>2?'var(--cyan)':'var(--green)',
    estimatedResults: complexity>4?'Narrow':'Wide'
  };
}

// â”€â”€ Translate query to engine syntax â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_translateToEngine(query, engine){
  const syn=FP_ENGINE_SYNTAX[engine];
  if(!syn)return query;
  let q=query;
  if(engine==='bing'||engine==='yandex'){
    // Replace bare OR with engine-specific
    q=q.replace(/\bOR\b/g,syn.or.trim());
  }
  if(engine==='bing'){
    q=q.replace(/intext:/g,'inbody:');
  }
  if(engine==='yandex'){
    q=q.replace(/intext:/g,'intext:');
  }
  return q;
}

// â”€â”€ Performance tracker helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_recordPerf(query,hits){
  const perfs=SS.get('rf_fp_perf',{});
  if(!perfs[query])perfs[query]={hits:0,searches:0,lastUsed:''};
  perfs[query].hits+=hits;
  perfs[query].searches+=1;
  perfs[query].lastUsed=today();
  SS.set('rf_fp_perf',perfs);
}

function fp_getPerfData(){
  const perfs=SS.get('rf_fp_perf',{});
  return Object.entries(perfs)
    .map(([query,data])=>({query,...data,rate:data.searches>0?Math.round(data.hits/data.searches*10)/10:0}))
    .sort((a,b)=>b.hits-a.hits);
}

// â”€â”€ Combination builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_buildCombinations(parts, logic){
  // parts = array of operator strings, logic = 'AND'|'OR'
  const sep = logic==='OR'?' OR ':' ';
  // Generate all pairs + full combos
  const combos=new Set();
  combos.add(parts.join(sep));
  // pairs
  for(let i=0;i<parts.length;i++){
    for(let j=i+1;j<parts.length;j++){
      combos.add([parts[i],parts[j]].join(sep));
    }
  }
  return [...combos];
}

// â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render_footprint_builder(el){
  const saved=SS.get('rf_footprints',[]);
  const perfs=fp_getPerfData();
  const negatives=SS.get('rf_fp_negatives',FP_SPAM_NEGATIVES);

  el.innerHTML=`
<style>
  .fp-tabs{display:flex;gap:2px;margin-bottom:10px;border-bottom:2px solid var(--win-border);padding-bottom:0}
  .fp-tab{padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;color:var(--text3);border-bottom:2px solid transparent;margin-bottom:-2px;white-space:nowrap}
  .fp-tab.on{color:var(--green);border-bottom-color:var(--green)}
  .fp-tab:hover{color:var(--text)}
  .fp-pane{display:none}.fp-pane.on{display:block}
  .fp-query-row{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;margin-bottom:3px}
  .fp-query-code{flex:1;font-family:var(--mono);font-size:10px;color:var(--green);word-break:break-all}
  .engine-btn{padding:2px 6px;font-size:9px;font-family:var(--mono);cursor:pointer;border:1px solid var(--win-border2);border-radius:2px;background:var(--win-panel3);color:var(--text3)}
  .engine-btn:hover{background:var(--sel-bg);color:#fff}
  .engine-btn.G{border-color:#4285f4;color:#4285f4}
  .engine-btn.B{border-color:#00809d;color:#00809d}
  .engine-btn.D{border-color:#de5833;color:#de5833}
  .engine-btn.Y{border-color:#ff0000;color:#ff0000}
  .valid-ok{color:var(--green)}.valid-err{color:var(--red)}.valid-warn{color:var(--yellow)}
  .tpl-card{background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px;padding:8px;margin-bottom:6px}
  .combo-chip{display:inline-flex;align-items:center;padding:3px 8px;border-radius:2px;font-size:10px;cursor:pointer;border:1px solid var(--win-border2);background:var(--win-panel2);color:var(--text3);font-family:var(--mono);margin:2px;user-select:none}
  .combo-chip.on{background:#0a1e2a;color:var(--cyan);border-color:#1a4a6a}
</style>

<div class="panel">
  <div class="panel-head">ğŸ‘£ Footprint Builder v2 â€” Master Pack
    <div class="ph-r">
      <span class="badge bg">${saved.length} queries</span>
      <span class="badge bb">${perfs.length} tracked</span>
      <span class="badge by">${FP_PACK.length} packs</span>
    </div>
  </div>
  <div class="panel-body">
    <div class="fp-tabs">
      <div class="fp-tab on"  onclick="fp_tab('builder')">ğŸ”¨ Builder</div>
      <div class="fp-tab"     onclick="fp_tab('pack')">ğŸ—ƒ Pack (20)</div>
      <div class="fp-tab"     onclick="fp_tab('combinator')">âš™ Combinator</div>
      <div class="fp-tab"     onclick="fp_tab('validator')">âœ… Validator</div>
      <div class="fp-tab"     onclick="fp_tab('templates')">ğŸ—‚ Templates</div>
      <div class="fp-tab"     onclick="fp_tab('engines')">ğŸŒ Multi-Engine</div>
      <div class="fp-tab"     onclick="fp_tab('tracker')">ğŸ“ˆ Performance</div>
      <div class="fp-tab"     onclick="fp_tab('negatives')">ğŸš« Negatives</div>
    </div>

    <!-- â•â•â• BUILDER TAB â•â•â• -->
    <div class="fp-pane on" id="fppane-builder">
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Keyword / Topic</label>
            <input type="text" id="fp-kw" placeholder="VPN, fitness, crypto..."/>
          </div>
          <div class="fg"><label class="lbl">Niche Modifier</label>
            <input type="text" id="fp-niche" placeholder="e.g. review, guide, tutorial â€” optional"/>
          </div>
          <div class="g2">
            <div class="fg"><label class="lbl">Language Operator</label>
              <select id="fp-lang">
                <option value="">None</option>
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="de">German (de)</option>
                <option value="fr">French (fr)</option>
                <option value="pt">Portuguese (pt)</option>
                <option value="it">Italian (it)</option>
                <option value="nl">Dutch (nl)</option>
                <option value="pl">Polish (pl)</option>
                <option value="ru">Russian (ru)</option>
                <option value="ja">Japanese (ja)</option>
              </select>
            </div>
            <div class="fg"><label class="lbl">Country Code</label>
              <select id="fp-country">
                <option value="">None</option>
                <option value="us">US</option><option value="gb">GB</option>
                <option value="au">AU</option><option value="ca">CA</option>
                <option value="de">DE</option><option value="fr">FR</option>
                <option value="es">ES</option><option value="in">IN</option>
                <option value="br">BR</option><option value="nl">NL</option>
              </select>
            </div>
          </div>
          <div class="g2">
            <div class="fg"><label class="lbl">Date Range: After</label>
              <input type="date" id="fp-after" value="${new Date(Date.now()-180*86400000).toISOString().split('T')[0]}"/>
            </div>
            <div class="fg"><label class="lbl">Date Range: Before</label>
              <input type="date" id="fp-before" value="${new Date().toISOString().split('T')[0]}"/>
            </div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;font-size:10px;color:var(--text2)">
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="fp-use-intitle" checked> intitle: variants</label>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="fp-use-inurl" checked> inurl: variants</label>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="fp-use-intext"> intext: variants</label>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="fp-use-daterange"> Add date range</label>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="fp-use-negatives" checked> Exclude spam farms</label>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="fp-mix-exact"> Mix exact+partial CMS</label>
          </div>
        </div>
        <div>
          <div class="fg"><label class="lbl">CMS / Platform</label>
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px" id="fp-cms">
              ${['WordPress','Blogger','Drupal','Joomla','Ghost','Wix','Squarespace','vBulletin','phpBB','XenForo'].map(c=>`<div class="chip on" onclick="this.classList.toggle('on')">${c}</div>`).join('')}
            </div>
          </div>
          <div class="fg"><label class="lbl">CMS Version Hint</label>
            <select id="fp-cms-ver">
              <option value="">Any version</option>
              <option value="wp5">WordPress 5.x</option>
              <option value="wp6">WordPress 6.x (Block Editor)</option>
              <option value="wp-classic">WordPress Classic Editor</option>
              <option value="drupal8">Drupal 8/9/10</option>
              <option value="drupal7">Drupal 7</option>
              <option value="joomla4">Joomla 4.x</option>
            </select>
          </div>
          <div class="fg"><label class="lbl">Comment / Action Footprints</label>
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px" id="fp-type">
              ${['"leave a reply"','"post a comment"','"leave a comment"','"add comment"','"write a comment"','"submit comment"','"reply to thread"','"post reply"','"add new comment"','"login to post comments"'].map(t=>`<div class="chip on" onclick="this.classList.toggle('on')">${t}</div>`).join('')}
            </div>
          </div>
          <div class="fg"><label class="lbl">Extra Modifiers</label>
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px" id="fp-mod">
              ${['"powered by wordpress"','inurl:blog','inurl:post','inurl:article','inurl:forum','inurl:thread','inurl:viewtopic','inurl:showthread','"comments open"','inurl:/node/'].map(m=>`<div class="chip" onclick="this.classList.toggle('on')">${m}</div>`).join('')}
            </div>
          </div>
        </div>
      </div>
      <div class="fg" style="margin-top:8px">
        <label class="lbl">Add Custom Footprint Query</label>
        <div style="display:flex;gap:5px">
          <input type="text" id="fp-custom" placeholder='"your keyword" inurl:comment "powered by"' style="flex:1"/>
          <button class="tbtn go" onclick="fp_addCustom()" style="white-space:nowrap">â• Add</button>
        </div>
      </div>
      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="fp_generate()">ğŸ‘£ Generate Footprints</button>
        <button class="tbtn" onclick="fp_tab('validator');fp_validateAll()">âœ… Validate All</button>
        <button class="tbtn" onclick="fp_export()">ğŸ“¥ Export TXT</button>
        <button class="tbtn" onclick="fp_exportCSV()">ğŸ“¥ Export CSV</button>
        <button class="tbtn stop" onclick="fp_clear()">ğŸ—‘ Clear</button>
      </div>
    </div>

    <!-- â•â•â• PACK TAB â•â•â• -->
    <div class="fp-pane" id="fppane-pack">
      <div class="g2" style="margin-bottom:10px;align-items:flex-start">
        <div>
          <div class="fg"><label class="lbl">Your Keyword</label>
            <div style="display:flex;gap:6px">
              <input type="text" id="fppack-kw" placeholder="VPN, fitness, crypto..." style="flex:1"/>
              <button class="tbtn go" onclick="fp_packLoadAll()">âš¡ Load ALL 20 Packs</button>
            </div>
          </div>
          <div class="notice ni-b" style="margin-top:4px;font-size:10px">
            Click <b>Use Pack</b> to inject keyword and save queries Â· <b>Load ALL</b> to add every pack at once Â· Each pack is optimized for its backlink type with correct operator patterns
          </div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          ${['all','T1','T2','T3','comment','guestpost','edu','gov','profile','directory','forum','wiki','web20','bookmark','qa','document','article','event','image'].map(f=>`<div class="combo-chip" id="fppack-filter-${f}" onclick="fp_packFilter('${f}')" style="${f==='all'?'background:#0a1e2a;color:var(--cyan);border-color:#1a4a6a':''}">${f}</div>`).join('')}
        </div>
      </div>
      <div id="fppack-grid">
        ${FP_PACK_GROUPS.map(group=>`
          <div style="margin-bottom:16px">
            <div style="font-size:10px;font-weight:700;color:${group.color};text-transform:uppercase;letter-spacing:.06em;border-bottom:1px solid var(--win-border);padding-bottom:4px;margin-bottom:8px">${group.label}</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:6px">
              ${group.ids.map(id=>{
                const cat=FP_PACK.find(c=>c.id===id);
                if(!cat)return'';
                return `<div class="tpl-card" data-type="${cat.type}" data-tier="${cat.tier}" style="border-left:3px solid ${group.color}">
                  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
                    <div>
                      <span style="font-size:13px;margin-right:4px">${cat.icon}</span>
                      <span style="font-weight:700;font-size:11px;color:var(--text)">${esc(cat.label)}</span>
                      <span class="badge bgray" style="font-size:8px;margin-left:4px">${cat.tier}</span>
                      <span class="badge" style="font-size:8px;margin-left:2px;background:#1a1a2a;color:var(--cyan);border:1px solid #2a2a4a">${cat.type}</span>
                    </div>
                    <button class="tbtn go" style="padding:2px 7px;font-size:9px;white-space:nowrap" onclick="fp_packUseCat('${cat.id}')">Use Pack</button>
                  </div>
                  <div style="font-size:10px;color:var(--text3);margin-bottom:5px;line-height:1.4">${esc(cat.desc)}</div>
                  <div style="font-size:9px;color:var(--text3);font-family:var(--mono);margin-bottom:4px">${cat.queries.length} queries Â· signals: ${(cat.signals||[]).slice(0,2).map(s=>`<code style="background:#0a0a14;padding:1px 3px;border-radius:2px;color:var(--cyan)">${esc(s)}</code>`).join(' ')}</div>
                  <div style="display:flex;flex-wrap:wrap;gap:2px">
                    ${cat.queries.slice(0,3).map(q=>`<code style="font-family:var(--mono);font-size:8px;color:#8888aa;background:#0a0a14;padding:2px 4px;border-radius:2px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block">${esc(q.slice(0,65))}${q.length>65?'â€¦':''}</code>`).join('')}
                  </div>
                </div>`;
              }).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- â•â•â• COMBINATOR TAB â•â•â• -->
    <div class="fp-pane" id="fppane-combinator">
      <div class="notice ni-b" style="margin-bottom:10px">Select elements to combine with AND or OR logic into composite queries. Generates all unique combinations.</div>
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Base Keyword</label>
            <input type="text" id="fpc-kw" placeholder="VPN"/>
          </div>
          <div class="fg"><label class="lbl">Operator Elements (click to toggle)</label>
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px" id="fpc-parts">
              ${['"leave a reply"','"post a comment"','inurl:blog','inurl:post','inurl:forum','"powered by wordpress"','intitle:blog','"comments open"','inurl:thread','"add new comment"','inurl:viewtopic','site:blogspot.com'].map(p=>`<div class="combo-chip" onclick="this.classList.toggle('on')">${esc(p)}</div>`).join('')}
            </div>
          </div>
          <div class="fg" style="margin-top:8px">
            <label class="lbl">Custom Element</label>
            <div style="display:flex;gap:5px">
              <input type="text" id="fpc-custom-part" placeholder='e.g. "your footprint"' style="flex:1"/>
              <button class="tbtn go" onclick="fp_addComboPart()">+ Add</button>
            </div>
          </div>
          <div class="g2" style="margin-top:8px">
            <div class="fg"><label class="lbl">Logic</label>
              <select id="fpc-logic">
                <option value="AND">AND (narrow)</option>
                <option value="OR">OR (broad)</option>
              </select>
            </div>
            <div class="fg"><label class="lbl">Max Combos</label>
              <input type="number" id="fpc-max" value="20" min="5" max="200"/>
            </div>
          </div>
          <button class="tbtn go mt8" onclick="fp_buildCombos()">âš™ Build Combinations</button>
        </div>
        <div>
          <div id="fpc-preview" style="max-height:400px;overflow-y:auto">
            <div class="notice ni-b">Select elements and click Build Combinations â†’</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â• VALIDATOR TAB â•â•â• -->
    <div class="fp-pane" id="fppane-validator">
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Query to Validate</label>
            <textarea id="fpv-query" rows="4" placeholder='"VPN" inurl:blog "leave a reply" "powered by WordPress"' oninput="fp_validateLive()"></textarea>
          </div>
          <button class="tbtn go mt6" onclick="fp_validateLive()">âœ… Validate</button>
          <div id="fpv-result" style="margin-top:10px"></div>
        </div>
        <div>
          <div class="fg"><label class="lbl">Batch Validate All Saved Queries</label></div>
          <button class="tbtn go" onclick="fp_validateAll()">âœ… Validate All Saved</button>
          <div id="fpv-batch" style="margin-top:10px;max-height:350px;overflow-y:auto"></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• TEMPLATES TAB â•â•â• -->
    <div class="fp-pane" id="fppane-templates">
      <div class="fg"><label class="lbl">Keyword to inject into templates</label>
        <div style="display:flex;gap:6px">
          <input type="text" id="fpt-kw" placeholder="VPN, fitness, crypto..." style="flex:1"/>
          <button class="tbtn go" onclick="fp_loadAllTemplates()">ğŸ“¥ Load All Templates</button>
        </div>
      </div>
      <div style="margin-top:8px">
        ${FP_PACK.map(cat=>`
          <div class="tpl-card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
              <div>
                <span style="font-size:12px;margin-right:4px">${cat.icon}</span>
                <span style="font-weight:700;font-size:11px;color:var(--text)">${esc(cat.label)}</span>
                <span class="badge bgray" style="font-size:8px;margin-left:4px">${cat.tier}</span>
                <span class="badge" style="font-size:8px;margin-left:2px;background:#1a1a2a;color:var(--cyan);border:1px solid #2a2a4a">${cat.type}</span>
              </div>
              <button class="tbtn go" style="padding:2px 8px;font-size:9px" onclick="fp_loadTemplate('${esc(cat.label.replace(/'/g,"\\'"))}')">Use Template</button>
            </div>
            <div style="font-size:10px;color:var(--text3);margin-bottom:6px">${esc(cat.desc)}</div>
            ${cat.queries&&cat.queries.length?`<div style="display:flex;flex-wrap:wrap;gap:3px">
              ${cat.queries.slice(0,3).map(q=>`<code style="font-family:var(--mono);font-size:9px;color:var(--cyan);background:#0a0a14;padding:2px 5px;border-radius:2px;border:1px solid #1a1a3a">${esc(q.slice(0,65))}${q.length>65?'â€¦':''}</code>`).join('')}
            </div>`:''}
          </div>`).join('')}
      </div>
    </div>

    <!-- â•â•â• MULTI-ENGINE TAB â•â•â• -->
    <div class="fp-pane" id="fppane-engines">
      <div class="notice ni-b" style="margin-bottom:8px">Each search engine uses different syntax for some operators. This tab translates your queries and opens them in the selected engine.</div>
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Base Query</label>
            <textarea id="fpe-query" rows="4" placeholder='"VPN" inurl:blog "leave a reply" "powered by WordPress"'></textarea>
          </div>
          <div class="fg"><label class="lbl">Target Engine</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">
              <button class="tbtn engine-btn G" onclick="fp_openEngine('google')">G Google</button>
              <button class="tbtn engine-btn B" onclick="fp_openEngine('bing')">B Bing</button>
              <button class="tbtn engine-btn D" onclick="fp_openEngine('duckduckgo')">D DuckDuckGo</button>
              <button class="tbtn engine-btn Y" onclick="fp_openEngine('yandex')">Y Yandex</button>
            </div>
          </div>
          <button class="tbtn go mt8" onclick="fp_translateAllEngines()">ğŸŒ Show All Engine Variants</button>
        </div>
        <div id="fpe-variants">
          <div class="notice ni-b">Enter a query and click Show All Engine Variants â†’</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Syntax Reference</div>
        <div class="tbl-wrap"><table style="font-size:10px">
          <thead><tr><th>Operator</th><th style="color:#4285f4">Google</th><th style="color:#00809d">Bing</th><th style="color:#de5833">DuckDuckGo</th><th style="color:#ff0000">Yandex</th></tr></thead>
          <tbody>
            ${[
              ['In-text','intext:','inbody:','inbody:','intext:'],
              ['Language','lr=lang_en','language:en','(limited)','lang:en'],
              ['Country','gl=us','loc:us','(limited)','domain:us'],
              ['Date after','after:2024-01-01','(no operator)','(no operator)','(no operator)'],
              ['OR','OR','OR','OR','|'],
              ['NOT','-term','-term','-term','~~term'],
            ].map(([op,...cells])=>`<tr><td class="mono xs" style="color:var(--text)">${op}</td>${cells.map(c=>`<td class="mono xs" style="color:var(--cyan)">${c}</td>`).join('')}</tr>`).join('')}
          </tbody>
        </table></div>
      </div>
    </div>

    <!-- â•â•â• PERFORMANCE TAB â•â•â• -->
    <div class="fp-pane" id="fppane-tracker">
      <div class="notice ni-b" style="margin-bottom:8px">Track which footprint queries return the most commenting targets. Manually log hits after running each query in URL Scraper.</div>
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Log Hits for Query</label>
            <select id="fpp-query" style="margin-bottom:6px">
              ${saved.map((q,i)=>`<option value="${i}">${esc(q.slice(0,70))}</option>`).join('')}
            </select>
          </div>
          <div class="fg"><label class="lbl">Targets Found</label>
            <input type="number" id="fpp-hits" value="0" min="0"/>
          </div>
          <button class="tbtn go mt6" onclick="fp_logPerf()">ğŸ“ Log Performance</button>
          <div style="margin-top:10px">
            <button class="tbtn" onclick="fp_clearPerf()">ğŸ—‘ Clear Performance Data</button>
          </div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Top Performing Queries</div>
          ${perfs.length?`
          <div style="max-height:350px;overflow-y:auto">
            ${perfs.slice(0,20).map((p,i)=>{
              const maxHits=perfs[0].hits||1;
              return `<div style="margin-bottom:8px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">
                  <span style="font-family:var(--mono);font-size:9px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">#${i+1} ${esc(p.query.slice(0,55))}</span>
                  <span class="badge ${p.hits>=10?'bg':p.hits>=3?'by':'bgray'}" style="font-size:8px;margin-left:6px">${p.hits} hits</span>
                </div>
                <div style="height:5px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:1px;overflow:hidden">
                  <div style="height:100%;width:${Math.min(p.hits/maxHits*100,100)}%;background:${p.hits>=10?'var(--green)':p.hits>=3?'var(--yellow)':'var(--text3)'}"></div>
                </div>
                <div class="mono xs tm">${p.searches} searches Â· avg ${p.rate} hits Â· last: ${p.lastUsed}</div>
              </div>`;
            }).join('')}
          </div>`:'<div class="notice ni-b">No performance data yet. Log hits for each query as you run them.</div>'}
        </div>
      </div>
    </div>

    <!-- â•â•â• NEGATIVES TAB â•â•â• -->
    <div class="fp-pane" id="fppane-negatives">
      <div class="notice ni-y" style="margin-bottom:10px">Negative footprints are appended to every generated query to exclude known spam farms and low-quality sites.</div>
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Active Negative Filters</label>
            <div style="max-height:200px;overflow-y:auto;border:1px solid var(--win-border);border-radius:2px;background:#0a0a0a;padding:6px">
              ${negatives.map((n,i)=>`<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid #1e1e1e">
                <code style="flex:1;font-family:var(--mono);font-size:10px;color:var(--red)">${esc(n)}</code>
                <button class="tbtn stop" style="padding:1px 5px;font-size:9px" onclick="fp_removeNeg(${i})">âœ•</button>
              </div>`).join('')}
            </div>
          </div>
          <div class="fg">
            <label class="lbl">Add Negative Filter</label>
            <div style="display:flex;gap:5px">
              <input type="text" id="fpn-custom" placeholder='-site:spamsite.com or -"spam keyword"' style="flex:1"/>
              <button class="tbtn go" onclick="fp_addNeg()">+ Add</button>
            </div>
          </div>
          <div class="flex g6 mt8">
            <button class="tbtn" onclick="fp_resetNegatives()">â†º Reset to Defaults</button>
            <button class="tbtn" onclick="fp_importNegatives()">ğŸ“¥ Import TXT</button>
          </div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Pre-built Spam Farm Negatives</div>
          ${FP_SPAM_NEGATIVES.map(n=>`<div class="fp-query-row" style="margin-bottom:3px">
            <code class="fp-query-code" style="color:var(--red)">${esc(n)}</code>
            <button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="fp_addSingleNeg('${esc(n)}')">+ Add</button>
          </div>`).join('')}
          <div class="notice ni-b" style="margin-top:8px">You can also maintain a domain blacklist in URL Scraper â†’ Filters tab.</div>
        </div>
      </div>
    </div>

  </div><!-- /panel-body -->
</div><!-- /panel -->

<!-- QUERY LIST -->
${saved.length?`
<div class="panel">
  <div class="panel-head">ğŸ“‹ Generated Queries <span class="badge bg">${saved.length}</span>
    <div class="ph-r">
      <button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="fp_useForScraper()">â–¶ â†’ URL Scraper</button>
      <button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="fp_export()">ğŸ“¥ TXT</button>
      <button class="tbtn" style="padding:2px 7px;font-size:9px" onclick="fp_exportCSV()">ğŸ“¥ CSV</button>
    </div>
  </div>
  <div class="panel-body" style="padding:6px">
    <div style="max-height:500px;overflow-y:auto">
      ${saved.map((q,i)=>{
        const v=fp_validateDork(q);
        const perf=fp_getPerfData().find(p=>p.query===q);
        return `<div class="fp-query-row">
          <span style="font-family:var(--mono);font-size:8px;color:var(--text3);width:22px;flex-shrink:0">${i+1}</span>
          <code class="fp-query-code">${esc(q)}</code>
          <span class="badge ${v.valid?'bg':'br'}" style="font-size:8px;flex-shrink:0">${v.valid?'âœ“':'!'}</span>
          <span style="font-family:var(--mono);font-size:8px;color:${v.complexityColor};flex-shrink:0">${v.complexity}</span>
          ${perf?`<span class="badge bg" style="font-size:8px;flex-shrink:0">${perf.hits}hits</span>`:''}
          <button class="engine-btn G" onclick="window.open(FP_ENGINE_URLS.google(${JSON.stringify(q)}),'_blank')" title="Google">G</button>
          <button class="engine-btn B" onclick="window.open(FP_ENGINE_URLS.bing(${JSON.stringify(q)}),'_blank')" title="Bing">B</button>
          <button class="engine-btn D" onclick="window.open(FP_ENGINE_URLS.duckduckgo(${JSON.stringify(q)}),'_blank')" title="DuckDuckGo">D</button>
          <button class="engine-btn Y" onclick="window.open(FP_ENGINE_URLS.yandex(${JSON.stringify(q)}),'_blank')" title="Yandex">Y</button>
          <button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="navigator.clipboard.writeText(${JSON.stringify(q)}).then(()=>log('Copied','ok'))">ğŸ“‹</button>
          <button class="tbtn stop" style="padding:1px 5px;font-size:9px" onclick="fp_deleteQuery(${i})">âœ•</button>
        </div>`;
      }).join('')}
    </div>
  </div>
</div>`:''}`;
}

// â”€â”€ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_tab(name){
  const tabs=['builder','pack','combinator','validator','templates','engines','tracker','negatives'];
  document.querySelectorAll('.fp-tab').forEach((t,i)=>{
    t.classList.toggle('on',tabs[i]===name);
  });
  document.querySelectorAll('.fp-pane').forEach(p=>p.classList.remove('on'));
  const pane=document.getElementById('fppane-'+name);
  if(pane)pane.classList.add('on');
}

// â”€â”€ Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_generate(){
  const kw=(document.getElementById('fp-kw')||{value:''}).value.trim();
  if(!kw){log('Enter a keyword','err');return;}
  const niche=(document.getElementById('fp-niche')||{value:''}).value.trim();
  const lang=(document.getElementById('fp-lang')||{value:''}).value;
  const country=(document.getElementById('fp-country')||{value:''}).value;
  const afterDate=(document.getElementById('fp-after')||{value:''}).value;
  const beforeDate=(document.getElementById('fp-before')||{value:''}).value;
  const useIntitle=(document.getElementById('fp-use-intitle')||{checked:true}).checked;
  const useInurl=(document.getElementById('fp-use-inurl')||{checked:true}).checked;
  const useIntext=(document.getElementById('fp-use-intext')||{checked:false}).checked;
  const useDateRange=(document.getElementById('fp-use-daterange')||{checked:false}).checked;
  const useNegatives=(document.getElementById('fp-use-negatives')||{checked:true}).checked;
  const mixExact=(document.getElementById('fp-mix-exact')||{checked:false}).checked;
  const cmsVer=(document.getElementById('fp-cms-ver')||{value:''}).value;

  const cms=[...document.querySelectorAll('#fp-cms .chip.on')].map(c=>c.textContent);
  const types=[...document.querySelectorAll('#fp-type .chip.on')].map(c=>c.textContent);
  const mods=[...document.querySelectorAll('#fp-mod .chip.on')].map(c=>c.textContent);
  const negatives=useNegatives?SS.get('rf_fp_negatives',FP_SPAM_NEGATIVES):[];

  // Build suffix modifiers
  const langSuffix=lang?` lr=lang_${lang}`:'';
  const countrySuffix=country?` gl=${country}`:'';
  const dateSuffix=useDateRange&&afterDate?` after:${afterDate}`:'';
  const dateSuffixB=useDateRange&&beforeDate&&beforeDate!==new Date().toISOString().split('T')[0]?` before:${beforeDate}`:'';
  const negSuffix=negatives.length>0?' '+negatives.slice(0,3).join(' '):'';
  const suffix=langSuffix+countrySuffix+dateSuffix+dateSuffixB+negSuffix;

  // CMS version-specific fingerprints
  const cmsVerFingerprints={
    wp5:'"WordPress 5" OR "wp-block-template"',
    wp6:'"WordPress 6" OR "wp-block-"',
    'wp-classic':'"classic editor" OR "wp-admin"',
    drupal8:'"Drupal 8" OR "Drupal 9" OR "Drupal 10"',
    drupal7:'"Drupal 7"',
    joomla4:'"Joomla 4"'
  };
  const verFP=cmsVer&&cmsVerFingerprints[cmsVer]?` (${cmsVerFingerprints[cmsVer]})`:'';

  const kwPhrase=niche?`"${kw}" "${niche}"`:`"${kw}"`;
  const queries=new Set();

  // â”€â”€ Core type queries â”€â”€
  types.forEach(t=>queries.add(`${kwPhrase} ${t}${suffix}`));

  // â”€â”€ CMS + type combos â”€â”€
  cms.forEach(c=>{
    const cmsLower=c.toLowerCase();
    // Exact match footprint
    types.forEach(t=>{
      queries.add(`${kwPhrase} ${t} "${c.toLowerCase()}"${verFP}${suffix}`);
      if(useInurl) queries.add(`${kwPhrase} ${t} inurl:${cmsLower}${verFP}${suffix}`);
      if(useIntitle) queries.add(`intitle:${kwPhrase} ${t} "${c.toLowerCase()}"${verFP}${suffix}`);
    });
    // Partial match (if enabled)
    if(mixExact){
      queries.add(`${kwPhrase} "${c}" ${suffix}`);
      if(useInurl) queries.add(`${kwPhrase} inurl:${cmsLower}${suffix}`);
    }
    // Powered by pattern
    if(['WordPress','Drupal','Joomla','Ghost'].includes(c)){
      queries.add(`${kwPhrase} "powered by ${c}"${verFP}${suffix}`);
      if(useIntitle) queries.add(`intitle:${kwPhrase} "powered by ${c}"${suffix}`);
    }
    // Platform-specific site: queries
    if(c==='Blogger') queries.add(`${kwPhrase} site:blogspot.com ${types[0]||'"post a comment"'}${suffix}`);
    if(c==='WordPress') queries.add(`${kwPhrase} site:wordpress.com ${types[0]||'"leave a reply"'}${suffix}`);
    // Forum-specific patterns
    if(c==='vBulletin'){
      queries.add(`${kwPhrase} "Powered by vBulletin" "reply to thread"${suffix}`);
      queries.add(`${kwPhrase} inurl:showthread "vBulletin" "post reply"${suffix}`);
      if(useIntitle) queries.add(`intitle:${kwPhrase} inurl:thread "vBulletin"${suffix}`);
    }
    if(c==='phpBB'){
      queries.add(`${kwPhrase} "Powered by phpBB" inurl:viewtopic "post reply"${suffix}`);
      queries.add(`${kwPhrase} inurl:viewtopic.php "phpBB"${suffix}`);
    }
    if(c==='XenForo'){
      queries.add(`${kwPhrase} "Community - XenForo" inurl:/threads/${suffix}`);
      queries.add(`${kwPhrase} "Powered by XenForo" "post reply"${suffix}`);
    }
  });

  // â”€â”€ Modifier combos â”€â”€
  mods.forEach(m=>{
    queries.add(`${kwPhrase} ${m}${suffix}`);
    if(useIntitle) queries.add(`intitle:${kwPhrase} ${m}${suffix}`);
    types.forEach(t=>queries.add(`${kwPhrase} ${t} ${m}${suffix}`));
  });

  // â”€â”€ intext variants â”€â”€
  if(useIntext){
    types.forEach(t=>queries.add(`${kwPhrase} intext:${t.replace(/"/g,'')}${suffix}`));
  }

  // â”€â”€ inurl URL-structure variants â”€â”€
  if(useInurl){
    const urlPaths=['/blog/','/post/','/article/','/forum/','/thread/','/node/'];
    urlPaths.forEach(p=>{
      if(types.length) queries.add(`${kwPhrase} inurl:${p} ${types[0]}${suffix}`);
    });
  }

  const unique=[...queries].filter(Boolean);
  const existing=SS.get('rf_footprints',[]);
  const merged=[...new Set([...existing,...unique])];
  SS.set('rf_footprints',merged);
  log(`Generated ${unique.length} footprint queries (${merged.length} total, including ${existing.length} existing)`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}

// â”€â”€ Validator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_validateLive(){
  const q=(document.getElementById('fpv-query')||{value:''}).value;
  const result=fp_validateDork(q);
  const out=document.getElementById('fpv-result');
  if(!out)return;
  out.innerHTML=`
    <div class="notice ${result.valid?'ni-g':'ni-r'}" style="margin-bottom:6px">
      ${result.valid?'âœ“ Valid query syntax':'âœ— Validation errors found'}
      <span style="float:right;font-family:var(--mono)">${result.complexity} Â· ${result.estimatedResults} results</span>
    </div>
    ${result.errors.map(e=>`<div class="valid-err mono xs" style="margin-bottom:3px">âœ— ${esc(e)}</div>`).join('')}
    ${result.warnings.map(w=>`<div class="valid-warn mono xs" style="margin-bottom:3px">âš  ${esc(w)}</div>`).join('')}
    ${result.valid&&!result.errors.length&&!result.warnings.length?'<div class="valid-ok mono xs">No issues found</div>':''}
  `;
}

function fp_validateAll(){
  const saved=SS.get('rf_footprints',[]);
  const out=document.getElementById('fpv-batch');
  if(!out)return;
  if(!saved.length){out.innerHTML='<div class="notice ni-b">No queries saved yet.</div>';return;}
  const results=saved.map((q,i)=>{
    const v=fp_validateDork(q);
    return {q,v,i};
  });
  const errors=results.filter(r=>!r.v.valid);
  const warnings=results.filter(r=>r.v.valid&&r.v.warnings.length>0);
  const ok=results.filter(r=>r.v.valid&&r.v.warnings.length===0);
  out.innerHTML=`
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <span class="badge bg">âœ“ ${ok.length} valid</span>
      <span class="badge by">âš  ${warnings.length} warnings</span>
      <span class="badge br">âœ— ${errors.length} errors</span>
    </div>
    ${errors.map(r=>`<div class="fp-query-row" style="margin-bottom:3px;border-left:3px solid var(--red)">
      <code class="fp-query-code" style="color:var(--red)">${esc(r.q.slice(0,60))}</code>
      <span class="mono xs" style="color:var(--red)">${r.v.errors[0]||''}</span>
    </div>`).join('')}
    ${warnings.map(r=>`<div class="fp-query-row" style="margin-bottom:3px;border-left:3px solid var(--yellow)">
      <code class="fp-query-code" style="color:var(--yellow)">${esc(r.q.slice(0,60))}</code>
      <span class="mono xs" style="color:var(--yellow)">${r.v.warnings[0]||''}</span>
    </div>`).join('')}
  `;
  log(`Validated ${saved.length} queries: ${ok.length} OK, ${warnings.length} warnings, ${errors.length} errors`,'ok');
}

// â”€â”€ Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_loadTemplate(name){
  const tpl=FP_TEMPLATES[name];
  if(!tpl||!tpl.queries||!tpl.queries.length){log(`Template "${name}" has no queries`,'warn');return;}
  const kw=(document.getElementById('fpt-kw')||document.getElementById('fp-kw')||{value:'keyword'}).value.trim()||'keyword';
  const queries=tpl.queries.map(q=>q.replace(/\{kw\}/g,kw));
  const existing=SS.get('rf_footprints',[]);
  const merged=[...new Set([...existing,...queries])];
  SS.set('rf_footprints',merged);
  log(`Template "${name}" loaded: ${queries.length} queries added (${merged.length} total)`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}

function fp_loadAllTemplates(){
  const kw=(document.getElementById('fpt-kw')||{value:'keyword'}).value.trim()||'keyword';
  let total=0;
  FP_PACK.forEach(cat=>{
    if(cat.queries&&cat.queries.length){
      const queries=cat.queries.map(q=>q.replace(/\{kw\}/g,kw));
      const existing=SS.get('rf_footprints',[]);
      SS.set('rf_footprints',[...new Set([...existing,...queries])]);
      total+=queries.length;
    }
  });
  log(`Loaded all ${FP_PACK.length} packs: ${total} queries added`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}

// â”€â”€ Master Pack tab functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_packUseCat(catId){
  const cat=FP_PACK.find(c=>c.id===catId);
  if(!cat){log('Pack not found','err');return;}
  const kw=(document.getElementById('fppack-kw')||document.getElementById('fp-kw')||{value:'keyword'}).value.trim()||'keyword';
  const queries=cat.queries.map(q=>q.replace(/\{kw\}/g,kw));
  const existing=SS.get('rf_footprints',[]);
  const merged=[...new Set([...existing,...queries])];
  SS.set('rf_footprints',merged);
  log(`${cat.icon} "${cat.label}" loaded: ${queries.length} queries â†’ ${merged.length} total`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}

function fp_packLoadAll(){
  const kw=(document.getElementById('fppack-kw')||{value:'keyword'}).value.trim()||'keyword';
  let total=0;
  FP_PACK.forEach(cat=>{
    const queries=cat.queries.map(q=>q.replace(/\{kw\}/g,kw));
    const existing=SS.get('rf_footprints',[]);
    SS.set('rf_footprints',[...new Set([...existing,...queries])]);
    total+=queries.length;
  });
  log(`âš¡ All 20 packs loaded: ${total} queries added (keyword: "${kw}")`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}

// Filter pack cards by type/tier
function fp_packFilter(filter){
  // Update active chip
  document.querySelectorAll('[id^="fppack-filter-"]').forEach(el=>{
    el.style.background=''; el.style.color=''; el.style.borderColor='';
  });
  const active=document.getElementById('fppack-filter-'+filter);
  if(active){active.style.background='#0a1e2a';active.style.color='var(--cyan)';active.style.borderColor='#1a4a6a';}
  // Show/hide cards
  document.querySelectorAll('#fppack-grid .tpl-card').forEach(card=>{
    if(filter==='all'){card.style.display=''; return;}
    const type=card.dataset.type||'';
    const tier=card.dataset.tier||'';
    const show = type===filter || tier.includes(filter.replace('T','').split('')[0] ? filter : '');
    card.style.display = (type===filter || tier.includes(filter)) ? '' : 'none';
  });
  // Show/hide group headers based on visible cards
  document.querySelectorAll('#fppack-grid > div').forEach(group=>{
    const cards=[...group.querySelectorAll('.tpl-card')];
    const anyVisible=cards.some(c=>c.style.display!=='none');
    group.style.display=anyVisible?'':'none';
  });
}

// â”€â”€ Multi-engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_openEngine(engine){
  const q=(document.getElementById('fpe-query')||{value:''}).value.trim();
  if(!q){log('Enter a query first','err');return;}
  const translated=fp_translateToEngine(q,engine);
  const url=FP_ENGINE_URLS[engine](translated);
  window.open(url,'_blank');
  log(`Opened in ${engine}: ${translated.slice(0,60)}...`,'ok');
}

function fp_translateAllEngines(){
  const q=(document.getElementById('fpe-query')||{value:''}).value.trim();
  if(!q){log('Enter a query first','err');return;}
  const out=document.getElementById('fpe-variants');
  if(!out)return;
  const engines=['google','bing','duckduckgo','yandex'];
  const labels={google:'G Google',bing:'B Bing',duckduckgo:'D DuckDuckGo',yandex:'Y Yandex'};
  const colors={google:'#4285f4',bing:'#00809d',duckduckgo:'#de5833',yandex:'#ff0000'};
  out.innerHTML=engines.map(e=>{
    const translated=fp_translateToEngine(q,e);
    const v=fp_validateDork(translated);
    return `<div style="margin-bottom:10px">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
        <span style="font-family:var(--mono);font-size:11px;font-weight:700;color:${colors[e]}">${labels[e]}</span>
        <span class="badge ${v.valid?'bg':'by'}" style="font-size:8px">${v.complexity}</span>
        <button class="engine-btn ${e[0].toUpperCase()}" onclick="window.open(FP_ENGINE_URLS.${e}(${JSON.stringify(translated)}),'_blank')" style="margin-left:auto">Open â†’</button>
      </div>
      <div style="background:#0a0a0a;border:1px solid ${colors[e]}33;border-radius:2px;padding:6px;font-family:var(--mono);font-size:10px;color:var(--cyan);word-break:break-all">${esc(translated)}</div>
    </div>`;
  }).join('');
}

// â”€â”€ Combinator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_addComboPart(){
  const val=(document.getElementById('fpc-custom-part')||{value:''}).value.trim();
  if(!val)return;
  const container=document.getElementById('fpc-parts');
  if(!container)return;
  const chip=document.createElement('div');
  chip.className='combo-chip on';
  chip.textContent=val;
  chip.onclick=()=>chip.classList.toggle('on');
  container.appendChild(chip);
  document.getElementById('fpc-custom-part').value='';
}

function fp_buildCombos(){
  const kw=(document.getElementById('fpc-kw')||{value:''}).value.trim()||'keyword';
  const selected=[...document.querySelectorAll('#fpc-parts .combo-chip.on')].map(c=>c.textContent);
  if(selected.length<2){log('Select at least 2 elements to combine','warn');return;}
  const logic=(document.getElementById('fpc-logic')||{value:'AND'}).value;
  const maxCombos=parseInt((document.getElementById('fpc-max')||{value:20}).value)||20;
  const combos=fp_buildCombinations(selected,logic);
  const queries=combos.slice(0,maxCombos).map(combo=>`"${kw}" ${combo}`);
  const preview=document.getElementById('fpc-preview');
  if(preview)preview.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <span class="mono xs tm">${queries.length} combinations generated</span>
      <button class="tbtn go" style="padding:2px 8px;font-size:9px" onclick="fp_saveCombos()">ğŸ’¾ Save All</button>
    </div>
    ${queries.map((q,i)=>`<div class="fp-query-row">
      <code class="fp-query-code">${esc(q)}</code>
      <button class="engine-btn G" onclick="window.open(FP_ENGINE_URLS.google(${JSON.stringify(q)}),'_blank')">G</button>
    </div>`).join('')}
  `;
  APP._fp_combos=queries;
  log(`Built ${queries.length} combinations with ${logic} logic`,'ok');
}

function fp_saveCombos(){
  if(!APP._fp_combos||!APP._fp_combos.length){log('No combinations to save','warn');return;}
  const existing=SS.get('rf_footprints',[]);
  const merged=[...new Set([...existing,...APP._fp_combos])];
  SS.set('rf_footprints',merged);
  log(`Saved ${APP._fp_combos.length} combinations (${merged.length} total)`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}

// â”€â”€ Performance tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_logPerf(){
  const idx=parseInt((document.getElementById('fpp-query')||{value:0}).value)||0;
  const hits=parseInt((document.getElementById('fpp-hits')||{value:0}).value)||0;
  const saved=SS.get('rf_footprints',[]);
  if(!saved[idx]){log('No query selected','err');return;}
  fp_recordPerf(saved[idx],hits);
  log(`Logged ${hits} hits for query #${idx+1}`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
  fp_tab('tracker');
}
function fp_clearPerf(){SS.set('rf_fp_perf',{});log('Performance data cleared','warn');render_footprint_builder(document.getElementById('page-footprint_builder'));fp_tab('tracker');}

// â”€â”€ Negatives management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_addNeg(){
  const v=(document.getElementById('fpn-custom')||{value:''}).value.trim();
  if(!v){log('Enter a negative filter','err');return;}
  const negs=SS.get('rf_fp_negatives',FP_SPAM_NEGATIVES);
  if(!negs.includes(v)){negs.push(v);SS.set('rf_fp_negatives',negs);}
  document.getElementById('fpn-custom').value='';
  log(`Added negative: ${v}`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
  fp_tab('negatives');
}
function fp_removeNeg(idx){
  const negs=SS.get('rf_fp_negatives',FP_SPAM_NEGATIVES);
  negs.splice(idx,1);SS.set('rf_fp_negatives',negs);
  render_footprint_builder(document.getElementById('page-footprint_builder'));fp_tab('negatives');
}
function fp_addSingleNeg(neg){
  const negs=SS.get('rf_fp_negatives',FP_SPAM_NEGATIVES);
  if(!negs.includes(neg)){negs.push(neg);SS.set('rf_fp_negatives',negs);log(`Added: ${neg}`,'ok');}
  render_footprint_builder(document.getElementById('page-footprint_builder'));fp_tab('negatives');
}
function fp_resetNegatives(){SS.set('rf_fp_negatives',FP_SPAM_NEGATIVES);log('Negatives reset to defaults','ok');render_footprint_builder(document.getElementById('page-footprint_builder'));fp_tab('negatives');}
function fp_importNegatives(){
  const input=document.createElement('input');input.type='file';input.accept='.txt';
  input.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const lines=ev.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
      const negs=SS.get('rf_fp_negatives',FP_SPAM_NEGATIVES);
      lines.forEach(l=>{if(!negs.includes(l))negs.push(l);});
      SS.set('rf_fp_negatives',negs);
      log(`Imported ${lines.length} negative filters`,'ok');
      render_footprint_builder(document.getElementById('page-footprint_builder'));
    };
    reader.readAsText(f);
  };
  input.click();
}

// â”€â”€ Misc helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fp_deleteQuery(idx){
  const saved=SS.get('rf_footprints',[]);
  saved.splice(idx,1);
  SS.set('rf_footprints',saved);
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}
function fp_addCustom(){
  const v=(document.getElementById('fp-custom')||{value:''}).value.trim();
  if(!v){log('Enter a custom footprint query','err');return;}
  const saved=SS.get('rf_footprints',[]);
  saved.push(v);SS.set('rf_footprints',saved);
  document.getElementById('fp-custom').value='';
  log(`Custom footprint added: ${v}`,'ok');
  render_footprint_builder(document.getElementById('page-footprint_builder'));
}
function fp_useForScraper(){
  const saved=SS.get('rf_footprints',[]);
  if(!saved.length)return;
  const ta=document.getElementById('us-seeds');
  if(ta)ta.value=saved.join('\n');
  switchPage('url_scraper');
  log(`${saved.length} footprints loaded into URL Scraper`,'ok');
}
function fp_export(){dlTxt(SS.get('rf_footprints',[]).join('\n'),'footprints.txt');log('Exported footprints TXT','ok');}
function fp_exportCSV(){
  const saved=SS.get('rf_footprints',[]);
  const perfs=fp_getPerfData();
  const perfMap={};perfs.forEach(p=>perfMap[p.query]=p);
  dlCSV('Query,Valid,Complexity,Hits,Searches,LastUsed\n'+
    saved.map(q=>{
      const v=fp_validateDork(q);
      const p=perfMap[q];
      return `"${q.replace(/"/g,'""')}",${v.valid},${v.complexity},${p?p.hits:0},${p?p.searches:0},${p?p.lastUsed:''}`;
    }).join('\n'),'footprints.csv');
  log('Exported footprints CSV with performance data','ok');
}
function fp_clear(){SS.set('rf_footprints',[]);render_footprint_builder(document.getElementById('page-footprint_builder'));log('Footprints cleared','warn');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANCHOR TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AT_PROFILES = {
  'niche_site':   {'Exact Match':[2,5],'Partial Match':[10,15],'Brand':[25,35],'Naked URL':[20,25],'Generic':[15,20],'LSI/Semantic':[10,15]},
  'authority':    {'Exact Match':[1,3],'Partial Match':[8,12],'Brand':[35,45],'Naked URL':[20,25],'Generic':[15,20],'LSI/Semantic':[12,18]},
  'local_biz':    {'Exact Match':[3,7],'Partial Match':[12,18],'Brand':[40,55],'Naked URL':[10,15],'Generic':[10,15],'LSI/Semantic':[5,10]},
  'ecommerce':    {'Exact Match':[5,10],'Partial Match':[15,20],'Brand':[25,35],'Naked URL':[15,20],'Generic':[10,15],'LSI/Semantic':[8,12]},
  'safe_2025':    {'Exact Match':[2,5],'Partial Match':[10,15],'Brand':[30,40],'Naked URL':[20,25],'Generic':[15,20],'LSI/Semantic':[10,15]},
};

function render_anchor_text(el){
  const atProfile=SS.raw('rf_at_profile','safe_2025');
  const SAFE=AT_PROFILES[atProfile]||AT_PROFILES['safe_2025'];

  el.innerHTML=`
  <div class="panel">
    <div class="panel-head">âš“ Anchor Text Manager <span style="font-size:10px;color:var(--text3);font-weight:400;margin-left:6px">v2 â€” Profile Presets Â· Risk Score Â· Randomiser Â· Import from Links</span></div>
    <div class="panel-body">
      <div class="g2" style="margin-bottom:8px">
        <div class="fg"><label class="lbl">Profile Preset</label>
          <select onchange="SS.rawSet('rf_at_profile',this.value);render_anchor_text(document.getElementById('page-anchor_text'))">
            ${[['safe_2025','Safe 2025 (General)'],['niche_site','Niche Site'],['authority','Authority Site'],['local_biz','Local Business'],['ecommerce','E-Commerce']].map(([v,l])=>`<option value="${v}"${atProfile===v?' selected':''}>${l}</option>`).join('')}
          </select></div>
        <div></div>
      </div>
      <div class="notice ni-b" style="margin-bottom:10px">
        <strong>Safe Ranges (${atProfile.replace(/_/g,' ')}):</strong> 
        ${Object.entries(SAFE).map(([t,[lo,hi]])=>`${t} ${lo}â€“${hi}%`).join(' Â· ')}
      </div>
      <div id="at-chart">${Object.entries(SAFE).map(([t,[lo,hi]])=>{const mid=Math.round((lo+hi)/2);return`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><span class="mono xs" style="font-weight:700">${t}</span><span class="badge bg">${lo}â€“${hi}%</span></div><div style="height:5px;background:var(--win-panel2);border-radius:2px;border:1px solid var(--win-border)"><div style="height:100%;width:${mid}%;background:var(--green);border-radius:2px;opacity:.8"></div></div></div>`;}).join('')}
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-head">ğŸ” Analyze Existing Anchor Distribution</div>
    <div class="panel-body">
      <div class="flex g6" style="margin-bottom:6px">
        <button class="tbtn" onclick="at_importFromLinks()">ğŸ“¥ Import from Link Builder</button>
      </div>
      <div class="fg"><label class="lbl">Paste Existing Anchors (one per line)</label>
        <textarea id="at-existing" rows="5" placeholder="click here&#10;best VPN&#10;your-brand.com&#10;check this out&#10;top VPN 2025"></textarea></div>
      <div class="fg"><label class="lbl">Your Main Keyword (for exact match detection)</label>
        <input type="text" id="at-existing-kw" placeholder="best VPN 2025"/></div>
      <button class="tbtn go mt6" onclick="at_analyze()">ğŸ“Š Analyze Distribution</button>
      <div id="at-analysis" style="display:none;margin-top:10px"></div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-head">âœ¨ Generate Anchor Set</div>
    <div class="panel-body">
      <div class="g3">
        <div class="fg"><label class="lbl">Brand Name</label><input type="text" id="at-brand" placeholder="YourBrand"/></div>
        <div class="fg"><label class="lbl">Target Keyword</label><input type="text" id="at-kw" placeholder="best VPN 2025"/></div>
        <div class="fg"><label class="lbl">URL</label><input type="url" id="at-url" placeholder="https://yoursite.com"/></div>
      </div>
      <div class="fg" style="margin-top:6px"><label class="lbl">How many anchors to generate (randomised list)</label>
        <input type="number" id="at-count" value="50" min="5" max="500"/></div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="at_generate()">âœ¨ Generate Set</button>
        <button class="tbtn" onclick="at_randomList()">ğŸ² Generate Randomised List (N anchors)</button>
      </div>
    </div>
  </div>

  <div id="at-out" style="display:none" class="panel">
    <div class="panel-head">Generated Anchors
      <div class="ph-r" style="display:flex;gap:4px">
        <button class="tbtn" style="padding:2px 7px;font-size:10px" onclick="navigator.clipboard.writeText(document.getElementById('at-raw').textContent).then(()=>log('Copied','ok'))">ğŸ“‹ Copy All</button>
        <button class="tbtn" style="padding:2px 7px;font-size:10px" onclick="at_exportAnchors()">ğŸ“¥ Export CSV</button>
      </div>
    </div>
    <div class="panel-body" id="at-body"></div>
    <pre id="at-raw" style="display:none"></pre>
  </div>

  <div id="at-random-out" style="display:none" class="panel">
    <div class="panel-head">ğŸ² Randomised Anchor List
      <div class="ph-r"><button class="tbtn" style="padding:2px 7px;font-size:10px" onclick="navigator.clipboard.writeText(document.getElementById('at-random-raw').textContent).then(()=>log('Copied','ok'))">ğŸ“‹ Copy</button></div>
    </div>
    <div class="panel-body" style="padding:0">
      <pre id="at-random-raw" class="mono xs" style="padding:8px;max-height:250px;overflow-y:auto;white-space:pre-wrap;color:var(--text2)"></pre>
    </div>
  </div>`;
}

function at_generate(){
  const brand=(document.getElementById('at-brand')||{value:'Brand'}).value.trim()||'Brand';
  const kw=(document.getElementById('at-kw')||{value:'keyword'}).value.trim()||'keyword';
  const url=(document.getElementById('at-url')||{value:'https://yoursite.com'}).value.trim()||'https://yoursite.com';
  const kwWords=kw.split(' ');
  const anchors={
    'Exact Match':[kw,kw+' review',kw+' guide',kw+' 2025','the '+kw],
    'Partial Match':['top '+kwWords[0],'best '+kwWords[kwWords.length-1],'cheap '+kwWords[0],kwWords[0]+' review',kwWords[0]+' guide'],
    'Brand':[brand,brand+' official',brand+'.com',brand+' review','visit '+brand],
    'Naked URL':[url,url.replace('https://',''),url.replace('https://www.','')],
    'Generic':['click here','read more','learn more','visit site','full review','check it out','see here','this site','more info','view now'],
    'LSI/Semantic':['online tool','digital solution','top resource','trusted platform','expert guide','industry leader']
  };
  const body=document.getElementById('at-body');
  const raw=document.getElementById('at-raw');
  const out=document.getElementById('at-out');
  if(body)body.innerHTML=Object.entries(anchors).map(([t,v])=>`<div style="margin-bottom:10px"><div class="mono xs tm" style="margin-bottom:4px;font-weight:700;color:var(--text)">${t.toUpperCase()} <span class="badge bgray">${v.length}</span></div><div style="display:flex;flex-wrap:wrap;gap:4px">${v.map(a=>`<div class="chip on">${esc(a)}</div>`).join('')}</div></div>`).join('');
  if(raw)raw.textContent=Object.entries(anchors).map(([t,v])=>t+'\n'+v.join('\n')).join('\n\n');
  if(out)out.style.display='block';
  log(`Generated ${Object.values(anchors).flat().length} anchors across 6 types`,'ok');
}

function at_randomList(){
  const brand=(document.getElementById('at-brand')||{value:'Brand'}).value.trim()||'Brand';
  const kw=(document.getElementById('at-kw')||{value:'keyword'}).value.trim()||'keyword';
  const url=(document.getElementById('at-url')||{value:'https://yoursite.com'}).value.trim()||'https://yoursite.com';
  const n=parseInt((document.getElementById('at-count')||{value:50}).value)||50;
  const atProfile=SS.raw('rf_at_profile','safe_2025');
  const SAFE=AT_PROFILES[atProfile]||AT_PROFILES['safe_2025'];
  const kwWords=kw.split(' ');

  // Anchor pools per type
  const pools={
    'Exact Match':[kw,kw+' review',kw+' guide',kw+' 2025','the '+kw,kw+' tips',kw+' tutorial'],
    'Partial Match':['top '+kwWords[0],'best '+kwWords[kwWords.length-1],'cheap '+kwWords[0],kwWords[0]+' guide',kwWords[0]+' review','great '+kwWords[0]],
    'Brand':[brand,brand+' official',brand+'.com',brand+' review','visit '+brand,brand+' site',brand+' team'],
    'Naked URL':[url,url.replace('https://',''),url.replace('https://www.','')],
    'Generic':['click here','read more','learn more','visit site','full review','check it out','see here','this site','more info','view now','here','this page','source'],
    'LSI/Semantic':['online tool','digital solution','top resource','trusted platform','expert guide','industry leader','professional service','reliable option']
  };

  // Build weighted pool based on midpoints
  const weightedPool=[];
  Object.entries(SAFE).forEach(([type,[lo,hi]])=>{
    const mid=Math.round((lo+hi)/2);
    const count=Math.max(1,Math.round(n*mid/100));
    const pool=pools[type]||[kw];
    for(let i=0;i<count;i++) weightedPool.push(pool[Math.floor(Math.random()*pool.length)]);
  });

  // Shuffle
  for(let i=weightedPool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[weightedPool[i],weightedPool[j]]=[weightedPool[j],weightedPool[i]];}
  const final=weightedPool.slice(0,n);

  const pre=document.getElementById('at-random-raw');
  const out=document.getElementById('at-random-out');
  if(pre) pre.textContent=final.join('\n');
  if(out) out.style.display='block';
  log(`Generated ${final.length} randomised anchors (${atProfile} profile)`,'ok');
}

function at_exportAnchors(){
  const raw=document.getElementById('at-raw');
  if(!raw||!raw.textContent){log('Generate anchors first','warn');return;}
  dlTxt(raw.textContent,'anchors.txt');
  log('Anchors exported','ok');
}

function at_importFromLinks(){
  const used=APP.links.map(l=>l.anchor).filter(Boolean);
  if(!used.length){log('No anchors in Link Builder yet','warn');return;}
  const ta=document.getElementById('at-existing');
  if(ta){ta.value=used.join('\n');log(`Imported ${used.length} anchors from Link Builder`,'ok');}
}

function at_analyze(){
  const raw=(document.getElementById('at-existing')||{value:''}).value.trim();
  const kw=(document.getElementById('at-existing-kw')||{value:''}).value.trim().toLowerCase();
  if(!raw){log('Enter existing anchors to analyze','err');return;}
  const anchors=raw.split('\n').map(a=>a.trim().toLowerCase()).filter(Boolean);
  const total=anchors.length;
  const atProfile=SS.raw('rf_at_profile','safe_2025');
  const SAFE=AT_PROFILES[atProfile]||AT_PROFILES['safe_2025'];
  const GENERIC=['click here','read more','learn more','visit site','here','this','check this','visit','more','view','see here','more info'];
  function classify(a){
    if(!a)return'Generic';
    if(a.startsWith('http')||a.includes('www.'))return'Naked URL';
    if(GENERIC.includes(a))return'Generic';
    if(kw&&a===kw)return'Exact Match';
    if(kw&&kw.split(' ').some(w=>w.length>3&&a.includes(w)))return'Partial Match';
    if(a.length<25&&!a.includes(' '))return'Brand';
    return'LSI/Semantic';
  }
  const counts={};
  Object.keys(SAFE).forEach(t=>counts[t]=0);
  anchors.forEach(a=>{ const t=classify(a); if(counts[t]!==undefined) counts[t]++; });

  // Risk score: sum of abs deviation from midpoint, normalised
  let totalDev=0;
  Object.entries(counts).forEach(([t,c])=>{
    const pct=total?c/total*100:0;
    const [lo,hi]=SAFE[t]||[0,100];
    const mid=(lo+hi)/2;
    totalDev+=Math.abs(pct-mid);
  });
  const riskScore=Math.min(100,Math.round(totalDev/Object.keys(SAFE).length*3));
  const riskColor=riskScore<20?'var(--green)':riskScore<50?'var(--yellow)':'var(--red)';
  const riskLabel=riskScore<20?'âœ… Safe':riskScore<50?'âš  Moderate Risk':'âŒ High Risk';

  const div=document.getElementById('at-analysis');
  if(div){
    div.style.display='block';
    div.innerHTML=`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;padding:8px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px">
      <div style="text-align:center">
        <div style="font-size:28px;font-weight:700;font-family:var(--mono);color:${riskColor}">${riskScore}</div>
        <div style="font-size:10px;color:var(--text3)">Risk Score</div>
      </div>
      <div>
        <div style="font-size:14px;font-weight:700;color:${riskColor}">${riskLabel}</div>
        <div style="font-size:10px;color:var(--text3)">${total} anchors analyzed Â· Profile: ${atProfile.replace(/_/g,' ')}</div>
      </div>
    </div>
    <div style="font-family:var(--mono);font-size:10px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase">Distribution vs Safe Range</div>`+
    Object.entries(counts).map(([t,c])=>{
      const pct=total?Math.round(c/total*100):0;
      const [lo,hi]=SAFE[t]||[0,100];
      const ok=pct>=lo&&pct<=hi;const low=pct<lo;
      const color=ok?'var(--green)':low?'var(--yellow)':'var(--red)';
      const status=ok?'âœ“ OK':low?'â†‘ TOO LOW':'â†“ TOO HIGH';
      return`<div style="margin-bottom:7px"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><span style="font-family:var(--mono);font-size:10px">${t}</span><span style="font-family:var(--mono);font-size:10px;color:${color}">${pct}% (${c}) â€” target ${lo}â€“${hi}% â€” <strong>${status}</strong></span></div><div style="height:5px;background:var(--win-panel2);border-radius:2px;border:1px solid var(--win-border)"><div style="height:100%;width:${Math.min(pct,100)}%;background:${color};border-radius:2px;opacity:0.8"></div></div></div>`;
    }).join('');
    log(`Analyzed ${total} anchors â€” Risk Score: ${riskScore} (${riskLabel})`,'ok');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIERED LINKS â€” v2.0  Full Feature Upgrade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// PBN domain registry â€” stored in localStorage
if(!window.TL_PBN) window.TL_PBN = JSON.parse(localStorage.getItem('rf_pbn_domains')||'[]');

// Tab state
let tlTab = 'pyramid'; // 'pyramid' | 'build' | 'pbn' | 'anchors' | 'platforms'

// Cross-tier anchor strategy constants
const TL_ANCHOR_STRATEGY = {
  1: { types: ['Brand','Partial Match'], label: 'Branded / Partial', color: 'var(--green)' },
  2: { types: ['Generic','LSI'],         label: 'Generic / LSI',    color: 'var(--blue)'  },
  3: { types: ['Naked URL'],             label: 'Naked URL',        color: 'var(--purple)' }
};

// Platform tiers â€” DA thresholds
const TL_PLAT_TIERS = {
  1: PLAT_DB.filter(p=>p.da>=90),
  2: PLAT_DB.filter(p=>p.da>=50&&p.da<90),
  3: PLAT_DB.filter(p=>p.da<50).concat([{domain:'twitter.com',da:94,type:'Twitter/X'},{domain:'pinterest.com',da:93,type:'Pinterest'},{domain:'mix.com',da:62,type:'Mix'},{domain:'diigo.com',da:71,type:'Diigo'},{domain:'scoop.it',da:78,type:'Scoop.it'}])
};

// Velocity drip rates per tier (posts/day default)
const TL_VEL_DEFAULT = { 1: 3, 2: 9, 3: 27 }; // 1:3:9 pyramid ratio

function render_tiered_links(el){
  const t1=APP.links.filter(l=>String(l.tier)==='1');
  const t2=APP.links.filter(l=>String(l.tier)==='2');
  const t3=APP.links.filter(l=>String(l.tier)==='3');
  const pbn=window.TL_PBN;

  // Pyramid health
  const ratio = _tl_pyramidHealth(t1.length,t2.length,t3.length);
  const pbnByTier = {1:pbn.filter(d=>d.tier==='1'),2:pbn.filter(d=>d.tier==='2'),3:pbn.filter(d=>d.tier==='3')};

  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:2px solid var(--win-border);padding-bottom:0">
    ${[['pyramid','ğŸ— Pyramid'],['build','âš™ Build Wizard'],['pbn','ğŸŒ PBN Domains'],['anchors','âš“ Anchor Strategy'],['platforms','ğŸ“‹ Platforms']].map(([t,l])=>`
    <div onclick="tlTab='${t}';render_tiered_links(document.getElementById('page-tiered_links'))" style="padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;margin-bottom:-2px;border:1px solid ${tlTab===t?'var(--win-border)':'transparent'};border-bottom-color:${tlTab===t?'var(--win-panel)':'transparent'};background:${tlTab===t?'var(--win-panel)':'transparent'};color:${tlTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      <span class="badge ${ratio.healthy?'bg':'br'}">${ratio.healthy?'âœ“ Healthy':'âš  Imbalanced'}</span>
      <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="tl_export()">ğŸ“¥ Export</button>
    </div>
  </div>

  ${tlTab==='pyramid'?_tlPyramidTab(t1,t2,t3,ratio,pbnByTier):
    tlTab==='build'?_tlBuildTab(t1,t2,t3):
    tlTab==='pbn'?_tlPBNTab(pbn):
    tlTab==='anchors'?_tlAnchorsTab(t1,t2,t3):
    _tlPlatformsTab()}
  `;
}

// â”€â”€ Pyramid Health Engine â”€â”€
function _tl_pyramidHealth(n1,n2,n3){
  // Ideal: 1:3:9
  const target2 = n1*3;
  const target3 = n1*9;
  const has2 = n2>=Math.max(1,target2*0.5);
  const has3 = n3>=Math.max(1,target3*0.5);
  const healthy = n1>0&&has2&&has3;
  const rec1 = Math.max(1, Math.ceil(Math.max(n2,n3)/9)||1);
  const rec2 = rec1*3;
  const rec3 = rec1*9;
  return {healthy,target2,target3,rec1,rec2,rec3,
    t2pct: target2>0?Math.min(100,Math.round((n2/target2)*100)):0,
    t3pct: target3>0?Math.min(100,Math.round((n3/target3)*100)):0,
    buildOrderOk: n3>=n2 // T3 should be built before T2
  };
}

function _tlPyramidTab(t1,t2,t3,ratio,pbnByTier){
  // T3 build-first warning
  const buildOrderWarn = t2.length>0&&t3.length<t2.length*3;
  const velT1=parseInt(localStorage.getItem('rf_vel_t1')||TL_VEL_DEFAULT[1]);
  const velT2=parseInt(localStorage.getItem('rf_vel_t2')||TL_VEL_DEFAULT[2]);
  const velT3=parseInt(localStorage.getItem('rf_vel_t3')||TL_VEL_DEFAULT[3]);

  return `
  <!-- STAT CARDS -->
  <div class="g3" style="margin-bottom:10px">
    ${[
      ['TIER 1','Direct â†’ Money Site',t1.length,'var(--green)','rgba(57,211,83,.15)','rgba(57,211,83,.3)',ratio.rec1,velT1,'t1'],
      ['TIER 2','Amplify T1 URLs',t2.length,'var(--blue)','rgba(74,158,222,.15)','rgba(74,158,222,.3)',ratio.rec2,velT2,'t2'],
      ['TIER 3','Social Signals',t3.length,'var(--purple)','rgba(155,114,216,.15)','rgba(155,114,216,.3)',ratio.rec3,velT3,'t3'],
    ].map(([tier,desc,cnt,col,bg,border,rec,vel,key])=>`
    <div style="padding:14px 16px;background:${bg};border:1px solid ${border};border-radius:2px;position:relative">
      <div style="font-size:32px;font-weight:800;font-family:var(--mono);color:${col};line-height:1">${cnt}</div>
      <div style="font-family:var(--mono);font-size:10px;font-weight:700;color:${col};margin-top:2px">${tier}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:2px">${desc}</div>
      <div style="margin-top:8px;font-size:9px;color:var(--text3)">Recommended: <span style="color:${col};font-weight:700">${rec}</span> &nbsp;|&nbsp; Velocity: <span style="color:var(--yellow)">${vel}/day</span></div>
      <div style="margin-top:6px;display:flex;align-items:center;gap:8px">
        <input type="number" value="${vel}" min="1" max="200" style="width:55px;padding:2px 5px;font-size:10px" onchange="localStorage.setItem('rf_vel_${key}',this.value);render_tiered_links(document.getElementById('page-tiered_links'))" title="Max posts/day for ${tier}"/>
        <span style="font-size:9px;color:var(--text3)">/day max</span>
      </div>
    </div>`).join('')}
  </div>

  <!-- PYRAMID HEALTH DASHBOARD -->
  <div class="panel">
    <div class="panel-head">ğŸ“Š Pyramid Health Dashboard
      <div class="ph-r"><span class="badge ${ratio.healthy?'bg':'br'}">${ratio.healthy?'âœ“ Balanced':'âš  Needs Work'}</span></div>
    </div>
    <div class="panel-body">
      ${buildOrderWarn?`<div class="notice ni-y" style="margin-bottom:10px">âš  <b>Build Order Warning:</b> T3 links (${t3.length}) should be â‰¥3Ã— T2 links (${t2.length}) before amplifying. Build more T3 first â€” let social signals age before T2 amplification.</div>`:''}
      <div class="g2">
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em">1:3:9 Ratio Progress</div>
          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span class="mono xs" style="color:var(--green)">T1 Baseline</span><span class="mono xs" style="color:var(--green)">${t1.length} built</span></div>
            <div class="prog-wrap"><div class="prog-fill" style="width:100%;background:var(--green)"></div></div>
          </div>
          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span class="mono xs" style="color:var(--blue)">T2 Target: ${ratio.target2} (3Ã— T1)</span><span class="mono xs" style="color:var(--blue)">${t2.length}/${ratio.target2} (${ratio.t2pct}%)</span></div>
            <div class="prog-wrap"><div class="prog-fill" style="width:${ratio.t2pct}%;background:var(--blue)"></div></div>
          </div>
          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;margin-bottom:3px"><span class="mono xs" style="color:var(--purple)">T3 Target: ${ratio.target3} (9Ã— T1)</span><span class="mono xs" style="color:var(--purple)">${t3.length}/${ratio.target3} (${ratio.t3pct}%)</span></div>
            <div class="prog-wrap"><div class="prog-fill" style="width:${ratio.t3pct}%;background:var(--purple)"></div></div>
          </div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em">Recommendation Engine</div>
          <div class="notice ni-b" style="line-height:2">
            ${t1.length===0?'<b>Start with T1:</b> Build parasite pages on DA 90+ platforms pointing to your money site.'
              :!ratio.buildOrderOk?`<b>Priority â€” Build T3 first:</b> Add ${Math.max(0,t2.length*3-t3.length)} more T3 social signals before amplifying T2. Let them age 5â€“7 days.`
              :ratio.t2pct<50?`<b>Build T2 next:</b> You need ~${Math.max(0,ratio.target2-t2.length)} more T2 links (DA 50â€“89) pointing to your ${t1.length} T1 URLs.`
              :ratio.t3pct<50?`<b>Bulk up T3:</b> Add ~${Math.max(0,ratio.target3-t3.length)} social bookmarks/naked-URL posts. Use diverse geo proxies.`
              :'<b>Pyramid is balanced.</b> Maintain drip rates. Monitor for deindexation. Consider running T2 campaign to refresh.'}
          </div>
          <div style="margin-top:8px">
            <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:5px">Quick Actions:</div>
            <div class="flex g6">
              <button class="tbtn go" onclick="tl_autoBuildT3()" ${t3.length>=ratio.target3?'disabled':''}>âš¡ Auto-Fill T3</button>
              <button class="tbtn" onclick="tl_feedT1toT2()" ${t1.length===0?'disabled':''}>ğŸ”— Feed T1â†’T2 Builder</button>
              <button class="tbtn" onclick="tlTab='build';render_tiered_links(document.getElementById('page-tiered_links'))">âš™ Build Wizard</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SVG Pyramid -->
      <div style="margin-top:16px;text-align:center">
        <svg width="480" height="230" viewBox="0 0 480 230" xmlns="http://www.w3.org/2000/svg" style="max-width:100%">
          <polygon points="12,220 468,220 380,145 100,145" fill="rgba(155,114,216,0.12)" stroke="#9b72d8" stroke-width="1.5"/>
          <text x="240" y="182" text-anchor="middle" fill="#9b72d8" font-size="11" font-family="Courier New,monospace" font-weight="700">TIER 3 â€” Social Signals / Bookmarks / Naked URLs</text>
          <text x="240" y="198" text-anchor="middle" fill="#9b72d8" font-size="9" font-family="Courier New,monospace">${t3.length} built Â· Target: ${ratio.target3} Â· ${ratio.t3pct}% Â· ${parseInt(localStorage.getItem('rf_vel_t3')||27)}/day drip Â· Geo-diverse proxies</text>
          <polygon points="100,145 380,145 310,76 170,76" fill="rgba(74,158,222,0.12)" stroke="#4a9ede" stroke-width="1.5"/>
          <text x="240" y="114" text-anchor="middle" fill="#4a9ede" font-size="11" font-family="Courier New,monospace" font-weight="700">TIER 2 â€” Parasite Amplifiers (DA 50â€“89)</text>
          <text x="240" y="130" text-anchor="middle" fill="#4a9ede" font-size="9" font-family="Courier New,monospace">${t2.length} built Â· Target: ${ratio.target2} Â· ${ratio.t2pct}% Â· Generic/LSI anchors Â· Dedicated proxy pool</text>
          <polygon points="170,76 310,76 263,20 217,20" fill="rgba(57,211,83,0.18)" stroke="#39d353" stroke-width="1.5"/>
          <text x="240" y="51" text-anchor="middle" fill="#39d353" font-size="10" font-family="Courier New,monospace" font-weight="700">TIER 1 (DA 90+)</text>
          <text x="240" y="65" text-anchor="middle" fill="#39d353" font-size="9" font-family="Courier New,monospace">${t1.length} built Â· Branded anchors</text>
          <line x1="240" y1="76" x2="240" y2="92" stroke="#39d353" stroke-width="1" stroke-dasharray="3,2" opacity="0.6"/>
          <line x1="240" y1="145" x2="240" y2="161" stroke="#4a9ede" stroke-width="1" stroke-dasharray="3,2" opacity="0.6"/>
          <text x="240" y="226" text-anchor="middle" fill="#555" font-size="8" font-family="Courier New,monospace">T3 social signals age â†’ T2 amplifies T1 â†’ T1 flows juice to Money Site</text>
        </svg>
      </div>
    </div>
  </div>

  <!-- LINK TABLE -->
  ${t1.length||t2.length||t3.length?`
  <div class="panel"><div class="panel-head">All Links by Tier <span class="badge bg">${APP.links.length}</span></div>
    <div class="panel-body" style="padding:0"><div class="tbl-wrap"><table>
      <thead><tr><th>URL</th><th>DA</th><th>Tier</th><th>Anchor</th><th>Anchor Type</th><th>Platform</th><th>Status</th><th>Date</th></tr></thead>
      <tbody>${APP.links.slice(-100).reverse().map(l=>`<tr>
        <td class="mono xs"><a href="${esc(l.url)}" target="_blank">${esc(l.url.slice(0,48))}â€¦</a></td>
        <td><strong style="color:${l.da>=90?'var(--green)':l.da>=50?'var(--yellow)':'var(--purple)'}">${l.da}</strong></td>
        <td><span class="badge ${String(l.tier)==='1'?'bg':String(l.tier)==='2'?'bb':'bp'}">T${l.tier}</span></td>
        <td class="xs">${esc(l.anchor)}</td>
        <td><span class="badge bgray" style="font-size:8px">${esc(l.type||'â€”')}</span></td>
        <td class="xs tm">${esc(l.platform||'â€”')}</td>
        <td><span class="badge ${l.status==='live'?'bg':'by'}">${l.status}</span></td>
        <td class="mono xs tm">${l.date||'â€”'}</td>
      </tr>`).join('')}</tbody>
    </table></div></div></div>`:''}`;
}

function _tlBuildTab(t1,t2,t3){
  // Dependency enforcement
  const canBuildT2 = t1.length>0;
  const canBuildT3 = true; // T3 always buildable (build first!)
  const t1urls = t1.map(l=>l.url);

  return `
  <div class="notice ni-b" style="margin-bottom:10px">
    <b>Build Order:</b> Build T3 first (social signals need time to age) â†’ then T2 (amplify T1 with generic anchors) â†’ T1 last (branded anchors direct to money site).
    The 1:3:9 ratio means for every 1 T1 link, build 3 T2 and 9 T3.
  </div>

  <!-- BUILD ORDER STEPPER -->
  <div style="display:flex;gap:0;margin-bottom:14px;border:1px solid var(--win-border);border-radius:2px;overflow:hidden">
    ${[
      ['1','T3 Social Signals','Build First','var(--purple)',t3.length>=1],
      ['2','T2 Amplifiers','After T3','var(--blue)',t2.length>=1],
      ['3','T1 Money Links','Last','var(--green)',t1.length>=1],
    ].map(([n,title,sub,col,done])=>`
    <div style="flex:1;padding:10px 14px;background:${done?'rgba(57,211,83,.04)':'var(--win-panel2)'};border-right:1px solid var(--win-border);text-align:center">
      <div style="font-size:18px;font-weight:800;font-family:var(--mono);color:${done?col:'var(--text3)'}">Step ${n} ${done?'âœ“':''}</div>
      <div style="font-size:11px;font-weight:700;color:${done?col:'var(--text3)'};margin-top:2px">${title}</div>
      <div style="font-size:9px;color:var(--text3);margin-top:2px">${sub}</div>
    </div>`).join('')}
  </div>

  <div class="g3">
    <!-- T3 Build Card -->
    <div class="panel" style="border-color:rgba(155,114,216,.4)">
      <div class="panel-head" style="color:var(--purple)">ğŸ”µ Tier 3 â€” Social Signals</div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:8px;font-size:9px">Build T3 first. Use naked URLs. Geo-diverse proxy pool.</div>
        <div class="fg"><label class="lbl">Target URL (money site or T1)</label><input type="url" id="tlb-t3-url" placeholder="https://yoursite.com"/></div>
        <div class="fg"><label class="lbl">Anchor (naked URL â€” no keyword)</label><input type="text" id="tlb-t3-anchor" placeholder="https://yoursite.com"/></div>
        <div class="fg"><label class="lbl">Count</label><input type="number" id="tlb-t3-count" value="9" min="1" max="200"/></div>
        <div class="fg"><label class="lbl">Proxy Pool (geo-diverse)</label>
          <select id="tlb-t3-proxy"><option value="geo">Geo-Diverse T3 Pool</option><option value="any">Any Available</option></select></div>
        <div class="fg"><label class="lbl">Drip Rate (posts/day)</label>
          <input type="number" id="tlb-t3-vel" value="${parseInt(localStorage.getItem('rf_vel_t3')||27)}" min="1" max="200"/></div>
        <button class="tbtn go" style="width:100%;margin-top:6px" onclick="tl_buildTier(3)">âš¡ Build T3 Links</button>
      </div>
    </div>

    <!-- T2 Build Card -->
    <div class="panel" style="border-color:rgba(74,158,222,${canBuildT2?'.4':'.15'})">
      <div class="panel-head" style="color:${canBuildT2?'var(--blue)':'var(--text3)'}">ğŸ”— Tier 2 â€” Amplifiers ${!canBuildT2?'<span class="badge br" style="font-size:8px">âš  Need T1 first</span>':''}</div>
      <div class="panel-body">
        ${!canBuildT2?`<div class="notice ni-r" style="margin-bottom:8px">Dependency: Build T1 links first. T2 links must target T1 URLs.</div>`:`<div class="notice ni-b" style="margin-bottom:8px;font-size:9px">T2 points to your T1 URLs. Use generic/LSI anchors â€” never replicate T1 anchors.</div>`}
        <div class="fg"><label class="lbl">T1 Target URLs ${canBuildT2?`<span style="color:var(--green);font-weight:400">(${t1.length} available)</span>`:''}</label>
          <textarea id="tlb-t2-urls" rows="3" placeholder="${canBuildT2?t1urls.slice(0,3).join('\n'):'Build T1 links first'}" ${!canBuildT2?'disabled':''}>${canBuildT2?t1urls.slice(0,5).join('\n'):''}</textarea>
        </div>
        <div class="fg"><label class="lbl">Anchor (Generic/LSI only â€” no brand)</label><input type="text" id="tlb-t2-anchor" placeholder="click here, learn more, this guide" ${!canBuildT2?'disabled':''}/></div>
        <div class="fg"><label class="lbl">Min DA (50â€“89)</label><input type="number" id="tlb-t2-minda" value="50" min="40" max="89" ${!canBuildT2?'disabled':''}/></div>
        <div class="fg"><label class="lbl">Count</label><input type="number" id="tlb-t2-count" value="3" min="1" max="100" ${!canBuildT2?'disabled':''}/></div>
        <div class="fg"><label class="lbl">Proxy Pool (T2 dedicated)</label>
          <select id="tlb-t2-proxy" ${!canBuildT2?'disabled':''}><option value="t2">T2 Dedicated Pool</option><option value="any">Any Available</option></select></div>
        <button class="tbtn go" style="width:100%;margin-top:6px" onclick="tl_buildTier(2)" ${!canBuildT2?'disabled':''}>ğŸ”— Build T2 Links</button>
      </div>
    </div>

    <!-- T1 Build Card -->
    <div class="panel" style="border-color:rgba(57,211,83,.4)">
      <div class="panel-head" style="color:var(--green)">ğŸ’° Tier 1 â€” Money Links</div>
      <div class="panel-body">
        <div class="notice ni-g" style="margin-bottom:8px;font-size:9px">T1 = highest quality. DA 90+ only. Branded or partial-match anchors only.</div>
        <div class="fg"><label class="lbl">Money URL</label><input type="url" id="tlb-t1-url" placeholder="https://yoursite.com/page"/></div>
        <div class="fg"><label class="lbl">Anchor (Brand or Partial only)</label><input type="text" id="tlb-t1-anchor" placeholder="YourBrand VPN, best VPN from YourBrand"/></div>
        <div class="fg"><label class="lbl">Min DA (90+)</label><input type="number" id="tlb-t1-minda" value="90" min="80" max="100"/></div>
        <div class="fg"><label class="lbl">Count</label><input type="number" id="tlb-t1-count" value="1" min="1" max="50"/></div>
        <div class="fg"><label class="lbl">Proxy Pool (T1 premium)</label>
          <select id="tlb-t1-proxy"><option value="t1">T1 Premium Pool</option><option value="any">Any Available</option></select></div>
        <button class="tbtn go" style="width:100%;margin-top:6px" onclick="tl_buildTier(1)">ğŸ’° Build T1 Links</button>
      </div>
    </div>
  </div>`;
}

function _tlPBNTab(pbn){
  return `<div class="panel">
    <div class="panel-head">ğŸŒ PBN / Expired Domain Registry <span class="badge bg">${pbn.length}</span></div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:10px">Register your owned expired domains here. Assign each to a tier. The build wizard will prefer PBN domains for that tier over public platforms.</div>
      <div class="g3" style="margin-bottom:10px">
        <div class="fg"><label class="lbl">Domain</label><input type="text" id="pbn-domain" placeholder="my-pbn-domain.com"/></div>
        <div class="fg"><label class="lbl">DA (estimated)</label><input type="number" id="pbn-da" value="30" min="1" max="100"/></div>
        <div class="fg"><label class="lbl">Assign to Tier</label>
          <select id="pbn-tier">
            <option value="1">Tier 1 (DA 90+ premium, money site links)</option>
            <option value="2" selected>Tier 2 (DA 50â€“89, amplify T1)</option>
            <option value="3">Tier 3 (Social / any DA)</option>
          </select></div>
      </div>
      <div class="g2" style="margin-bottom:12px">
        <div class="fg"><label class="lbl">Niche / Topic</label><input type="text" id="pbn-niche" placeholder="tech, finance, health..."/></div>
        <div class="fg"><label class="lbl">Hosting / IP</label><input type="text" id="pbn-ip" placeholder="192.168.1.1 or host provider"/></div>
      </div>
      <div class="flex g6">
        <button class="tbtn go" onclick="pbn_add()">â• Add Domain</button>
        <button class="tbtn" onclick="pbn_importBulk()">ğŸ“‹ Bulk Import</button>
        <button class="tbtn" onclick="pbn_export()">ğŸ“¥ Export</button>
      </div>
      ${pbn.length?`<div class="tbl-wrap" style="margin-top:12px"><table>
        <thead><tr><th>Domain</th><th>DA</th><th>Tier</th><th>Niche</th><th>IP / Host</th><th>Actions</th></tr></thead>
        <tbody>${pbn.map((d,i)=>`<tr>
          <td class="mono xs" style="font-weight:700">${esc(d.domain)}</td>
          <td><strong style="color:${d.da>=90?'var(--green)':d.da>=50?'var(--yellow)':'var(--purple)'}">${d.da}</strong></td>
          <td><span class="badge ${d.tier==='1'?'bg':d.tier==='2'?'bb':'bp'}">T${d.tier}</span></td>
          <td class="xs tm">${esc(d.niche||'â€”')}</td>
          <td class="mono xs tm">${esc(d.ip||'â€”')}</td>
          <td>
            <button class="tbtn stop" style="padding:1px 5px;font-size:9px" onclick="pbn_del(${i})">âœ•</button>
          </td>
        </tr>`).join('')}</tbody>
      </table></div>`:`<div class="notice ni-b" style="margin-top:10px">No PBN domains registered yet.</div>`}
    </div>
  </div>`;
}

function _tlAnchorsTab(t1,t2,t3){
  // Anchor leakage check â€” T2 anchors should NOT appear in T1
  const t1anchors=new Set(t1.map(l=>(l.anchor||'').toLowerCase()));
  const t2anchors=t2.map(l=>(l.anchor||'').toLowerCase());
  const leaked=t2anchors.filter(a=>t1anchors.has(a)&&a.length>3);
  const t1Types=_anchorBreakdown(t1);
  const t2Types=_anchorBreakdown(t2);
  const t3Types=_anchorBreakdown(t3);

  return `<div class="panel">
    <div class="panel-head">âš“ Cross-Tier Anchor Strategy</div>
    <div class="panel-body">
      <div class="g3" style="margin-bottom:14px">
        ${[
          ['Tier 1','Branded / Partial Match','Use your brand name or brand + keyword. Never generic.','var(--green)','rgba(57,211,83,.08)',t1Types],
          ['Tier 2','Generic / LSI only','Never replicate T1 anchors. Use: "click here", "this guide", "read more", topic synonyms.','var(--blue)','rgba(74,158,222,.08)',t2Types],
          ['Tier 3','Naked URL only','Raw URL: https://yoursite.com â€” no keyword anchor. Mimics natural social sharing.','var(--purple)','rgba(155,114,216,.08)',t3Types],
        ].map(([tier,rule,desc,col,bg,types])=>`
        <div style="padding:12px;background:${bg};border:1px solid ${col.replace(')',',0.3)')};border-radius:2px">
          <div style="font-family:var(--mono);font-size:9px;font-weight:700;color:${col};text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">${tier}</div>
          <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px">${rule}</div>
          <div style="font-size:9px;color:var(--text3);margin-bottom:8px;line-height:1.5">${desc}</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3)">
            ${Object.entries(types).map(([t,n])=>`<span style="color:${col}">${n}</span> ${t}  `).join('')}
          </div>
        </div>`).join('')}
      </div>

      ${leaked.length?`<div class="notice ni-r" style="margin-bottom:10px">
        âš  <b>Anchor Leakage Detected!</b> ${leaked.length} T2 anchor(s) duplicate T1 anchors â€” this creates a footprint.
        Affected: ${leaked.slice(0,5).map(a=>`<span class="badge br">${esc(a)}</span>`).join(' ')}
        ${leaked.length>5?`+${leaked.length-5} more`:''}<br>
        <span style="font-size:9px">Fix: Edit T2 links to use purely generic phrases (click here, learn more, etc.)</span>
      </div>`:`<div class="notice ni-g" style="margin-bottom:10px">âœ“ No anchor leakage detected â€” T1 and T2 anchor sets are cleanly separated.</div>`}

      <div class="g2">
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:6px;text-transform:uppercase">Recommended T1 Anchors</div>
          <div class="flex g6" style="flex-wrap:wrap">
            ${['[Brand] Review','Best [Brand]','[Brand] [Keyword]','Visit [Brand]','[Brand] Guide'].map(a=>`<span class="chip on">${a}</span>`).join('')}
          </div>
        </div>
        <div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:6px;text-transform:uppercase">Recommended T2 Anchors (no brand/keyword)</div>
          <div class="flex g6" style="flex-wrap:wrap">
            ${['click here','read more','this guide','learn more','check this out','visit here','source','reference','details here','full guide'].map(a=>`<span class="chip on" style="background:#0a1a2a;border-color:#1a3a5a;color:var(--blue)">${a}</span>`).join('')}
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function _anchorBreakdown(links){
  const counts={};
  links.forEach(l=>{const t=l.type||'Unknown';counts[t]=(counts[t]||0)+1;});
  return counts;
}

function _tlPlatformsTab(){
  return `<div class="panel">
    <div class="panel-head">ğŸ“‹ Tier-Specific Platform Recommendations</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:12px">Platforms are pre-filtered by tier. T1 = DA 90+ only. T2 = DA 50â€“89. T3 = any DA + social/bookmark sites.</div>
      <div class="g3">
        ${[
          ['Tier 1 â€” DA 90+','var(--green)','rgba(57,211,83,.08)',TL_PLAT_TIERS[1],'bg','Branded anchors, high editorial value, .edu/.gov links if available'],
          ['Tier 2 â€” DA 50â€“89','var(--blue)','rgba(74,158,222,.08)',TL_PLAT_TIERS[2],'bb','Generic/LSI anchors only. Target T1 URLs not money site directly.'],
          ['Tier 3 â€” Any DA','var(--purple)','rgba(155,114,216,.08)',TL_PLAT_TIERS[3],'bp','Naked URL only. Volume play â€” use geo-diverse proxies.'],
        ].map(([title,col,bg,plats,badge,tip])=>`
        <div style="padding:12px;background:${bg};border:1px solid ${col.replace(')',',0.25)')};border-radius:2px">
          <div style="font-family:var(--mono);font-size:9px;font-weight:700;color:${col};margin-bottom:8px;text-transform:uppercase">${title}</div>
          <div style="font-size:9px;color:var(--text3);margin-bottom:8px;font-style:italic">${tip}</div>
          <div style="display:flex;flex-direction:column;gap:3px">
            ${plats.map(p=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 6px;background:var(--win-panel2);border-radius:2px">
              <span class="mono xs">${esc(p.domain)}</span>
              <span class="badge ${badge}">DA${p.da}</span>
            </div>`).join('')}
          </div>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ Build Tier function â”€â”€
function tl_buildTier(tier){
  const tierStr=String(tier);
  let url,anchor,minDa,count,proxyPool;
  if(tierStr==='1'){
    url=(document.getElementById('tlb-t1-url')||{value:''}).value.trim();
    anchor=(document.getElementById('tlb-t1-anchor')||{value:''}).value.trim()||'brand link';
    minDa=parseInt((document.getElementById('tlb-t1-minda')||{value:90}).value)||90;
    count=parseInt((document.getElementById('tlb-t1-count')||{value:1}).value)||1;
    proxyPool=(document.getElementById('tlb-t1-proxy')||{value:'t1'}).value;
  } else if(tierStr==='2'){
    const urlsRaw=(document.getElementById('tlb-t2-urls')||{value:''}).value.trim();
    url=urlsRaw.split('\n')[0]||'';
    anchor=(document.getElementById('tlb-t2-anchor')||{value:''}).value.trim()||'click here';
    minDa=parseInt((document.getElementById('tlb-t2-minda')||{value:50}).value)||50;
    count=parseInt((document.getElementById('tlb-t2-count')||{value:3}).value)||3;
    proxyPool=(document.getElementById('tlb-t2-proxy')||{value:'t2'}).value;
    // Anchor leakage prevention
    const t1anchors=APP.links.filter(l=>String(l.tier)==='1').map(l=>(l.anchor||'').toLowerCase());
    if(t1anchors.includes(anchor.toLowerCase())){
      log('âš  Anchor leakage: T2 anchor matches a T1 anchor. Using "click here" instead.','warn');
      anchor='click here';
    }
  } else {
    url=(document.getElementById('tlb-t3-url')||{value:''}).value.trim();
    anchor=url||(document.getElementById('tlb-t3-anchor')||{value:''}).value.trim();
    minDa=0;
    count=parseInt((document.getElementById('tlb-t3-count')||{value:9}).value)||9;
    proxyPool=(document.getElementById('tlb-t3-proxy')||{value:'geo'}).value;
  }
  if(!url&&tierStr!=='3'){log(`Enter a URL for T${tier}`, 'err');return;}

  // Dependency check
  if(tierStr==='2'&&APP.links.filter(l=>String(l.tier)==='1').length===0){
    log('âš  Tier dependency: Build T1 links before T2.','err');return;
  }

  // Prefer PBN domains for this tier
  const pbnForTier=window.TL_PBN.filter(d=>d.tier===tierStr);
  const platPool = pbnForTier.length
    ? pbnForTier.map(d=>({domain:d.domain,da:d.da,type:'PBN'}))
    : (TL_PLAT_TIERS[tier]||PLAT_DB).filter(p=>p.da>=minDa);

  if(!platPool.length){log(`No platforms available for T${tier} with DA ${minDa}+`,'err');return;}

  // Anchor type enforcement per tier
  const atype = TL_ANCHOR_STRATEGY[tier]?.types[0]||'Generic';
  const vel=parseInt(localStorage.getItem(`rf_vel_t${tierStr}`)||TL_VEL_DEFAULT[tier]);

  log(`Building ${count} T${tier} links â€” ${atype} anchors, ${platPool.length} eligible platforms, proxy: ${proxyPool}, drip: ${vel}/day`,'info');

  for(let i=0;i<count;i++){
    const p=platPool[i%platPool.length];
    const slug=(anchor||url).toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,30)+'-'+rand(100,9999);
    const lurl=`https://${p.domain}/${slug}`;
    const proxy=getNextProxy(proxyPool);
    if(proxy)log(`[T${tier}] Proxy: ${proxyLabel(proxy)}`,'info');
    APP.links.push({url:lurl,da:p.da,anchor,type:atype,platform:p.type,tier:tierStr,status:Math.random()>.25?'live':'pending',date:today(),proxyPool,velocity:vel});
    log(`T${tier} link â†’ ${lurl.slice(0,52)} (DA${p.da}) [${atype}]`,'ok');
    APP.stats.success++;APP.stats.processed++;updateStats();
  }
  SS.set('rf_links',APP.links);
  log(`âœ“ Built ${count} T${tier} links`,'ok');
  render_tiered_links(document.getElementById('page-tiered_links'));
}

// â”€â”€ T1 URL auto-population: feed Link Builder T1 output into T2 targeting â”€â”€
function tl_feedT1toT2(){
  const t1urls=APP.links.filter(l=>String(l.tier)==='1').map(l=>l.url);
  if(!t1urls.length){log('No T1 links to feed â€” build T1 first','warn');return;}
  tlTab='build';
  render_tiered_links(document.getElementById('page-tiered_links'));
  setTimeout(()=>{
    const el=document.getElementById('tlb-t2-urls');
    if(el){el.value=t1urls.join('\n');log(`Fed ${t1urls.length} T1 URLs into T2 targeting assistant`,'ok');}
  },60);
}

// â”€â”€ Auto-fill T3 to reach 1:3:9 ratio â”€â”€
function tl_autoBuildT3(){
  const t1=APP.links.filter(l=>String(l.tier)==='1').length;
  const t3=APP.links.filter(l=>String(l.tier)==='3').length;
  const needed=Math.max(9,t1*9)-t3;
  if(needed<=0){log('T3 already at or above target ratio','ok');return;}
  const moneyUrl=(APP.campaigns[0]?.url)||'https://yoursite.com';
  const platPool=TL_PLAT_TIERS[3];
  const vel=parseInt(localStorage.getItem('rf_vel_t3')||27);
  log(`Auto-filling ${needed} T3 links (naked URL, geo-diverse)...`,'info');
  for(let i=0;i<needed;i++){
    const p=platPool[i%platPool.length];
    const slug='link-'+rand(1000,99999);
    APP.links.push({url:`https://${p.domain}/${slug}`,da:p.da,anchor:moneyUrl,type:'Naked URL',platform:p.type,tier:'3',status:Math.random()>.2?'live':'pending',date:today(),proxyPool:'geo',velocity:vel});
  }
  SS.set('rf_links',APP.links);
  log(`âœ“ Auto-filled ${needed} T3 naked-URL links`,'ok');
  render_tiered_links(document.getElementById('page-tiered_links'));
}

// â”€â”€ PBN helpers â”€â”€
function pbn_add(){
  const domain=(document.getElementById('pbn-domain')||{value:''}).value.trim();
  if(!domain){log('Enter a domain','err');return;}
  window.TL_PBN.push({
    domain,
    da:parseInt((document.getElementById('pbn-da')||{value:30}).value)||30,
    tier:(document.getElementById('pbn-tier')||{value:'2'}).value,
    niche:(document.getElementById('pbn-niche')||{value:''}).value.trim(),
    ip:(document.getElementById('pbn-ip')||{value:''}).value.trim(),
    added:today()
  });
  localStorage.setItem('rf_pbn_domains',JSON.stringify(window.TL_PBN));
  log(`PBN domain "${domain}" registered`,'ok');
  render_tiered_links(document.getElementById('page-tiered_links'));
}
function pbn_del(i){window.TL_PBN.splice(i,1);localStorage.setItem('rf_pbn_domains',JSON.stringify(window.TL_PBN));render_tiered_links(document.getElementById('page-tiered_links'));}
function pbn_export(){dlCSV('Domain,DA,Tier,Niche,IP,Added\n'+window.TL_PBN.map(d=>`"${d.domain}",${d.da},${d.tier},"${d.niche||''}","${d.ip||''}",${d.added||''}`).join('\n'),'pbn_domains.csv');log('PBN domains exported','ok');}
function pbn_importBulk(){
  const raw=prompt('Paste domains (one per line, format: domain.com,DA,tier):');
  if(!raw)return;
  raw.split('\n').map(s=>s.trim()).filter(Boolean).forEach(line=>{
    const [domain,da,tier]=(line+',30,2').split(',');
    if(domain)window.TL_PBN.push({domain:domain.trim(),da:parseInt(da)||30,tier:(tier||'2').trim(),added:today()});
  });
  localStorage.setItem('rf_pbn_domains',JSON.stringify(window.TL_PBN));
  log(`Imported ${window.TL_PBN.length} PBN domains`,'ok');
  render_tiered_links(document.getElementById('page-tiered_links'));
}

function tl_export(){dlCSV('URL,DA,Tier,Anchor,AnchorType,Platform,Status,ProxyPool,Velocity,Date\n'+APP.links.map(l=>`"${l.url}",${l.da},${l.tier},"${l.anchor||''}","${l.type||''}","${l.platform||''}",${l.status},"${l.proxyPool||''}","${l.velocity||''}","${l.date||''}"`).join('\n'),'tiered_links.csv');log('Links exported','ok');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROXY MANAGER  v2.0 â€” Full Feature Upgrade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _prxTab = 'pool'; // 'pool' | 'add' | 'health' | 'strategy' | 'pools'

// Tool list for per-tool assignment
const PRX_TOOLS = ['url_scraper','serp_scraper','commenter','link_builder','campaign','tiered_links','indexer','ping'];

// Country flag emoji map
const PRX_FLAGS = {US:'ğŸ‡ºğŸ‡¸',GB:'ğŸ‡¬ğŸ‡§',UK:'ğŸ‡¬ğŸ‡§',DE:'ğŸ‡©ğŸ‡ª',NL:'ğŸ‡³ğŸ‡±',CA:'ğŸ‡¨ğŸ‡¦',AU:'ğŸ‡¦ğŸ‡º',FR:'ğŸ‡«ğŸ‡·',JP:'ğŸ‡¯ğŸ‡µ',SG:'ğŸ‡¸ğŸ‡¬',IN:'ğŸ‡®ğŸ‡³',BR:'ğŸ‡§ğŸ‡·',RU:'ğŸ‡·ğŸ‡º',UA:'ğŸ‡ºğŸ‡¦',PL:'ğŸ‡µğŸ‡±',SE:'ğŸ‡¸ğŸ‡ª'};

function render_proxy_manager(el){
  const live   = APP.proxies.filter(p=>p.status==='live');
  const dead   = APP.proxies.filter(p=>p.status==='dead'||p.status==='retired');
  const banned = APP.proxies.filter(p=>p.status==='banned');
  const unt    = APP.proxies.filter(p=>p.status==='untested');
  const avgScore = live.length ? Math.round(live.reduce((s,p)=>s+prx_score(p),0)/live.length) : 0;
  const avgUptime= live.length ? Math.round(live.reduce((s,p)=>s+(p.uptimePct||100),0)/live.length) : 0;

  el.innerHTML = `
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:2px solid var(--win-border);padding-bottom:0">
    ${[['pool','ğŸ”€ Proxy Pool'],['scrape','ğŸ•· Scrape Sources'],['add','â• Add / Import'],['health','ğŸ“Š Health Monitor'],['strategy','âš™ Strategy & Rules'],['pools','ğŸ—‚ Tool Pools']].map(([t,l])=>`
    <div onclick="_prxTab='${t}';render_proxy_manager(document.getElementById('page-proxy_manager'))" style="padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;margin-bottom:-2px;border:1px solid ${_prxTab===t?'var(--win-border)':'transparent'};border-bottom-color:${_prxTab===t?'var(--win-panel)':'transparent'};background:${_prxTab===t?'var(--win-panel)':'transparent'};color:${_prxTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      <span class="badge bg">${live.length} live</span>
      <span class="badge br">${dead.length+banned.length} dead/banned</span>
      <span class="badge by">${unt.length} untested</span>
    </div>
  </div>

  ${_prxTab==='pool'    ? _prxPoolTab(live,dead,banned,unt,avgScore,avgUptime)
  : _prxTab==='scrape' ? _prxScrapeTab()
  : _prxTab==='add'    ? _prxAddTab()
  : _prxTab==='health' ? _prxHealthTab(live,dead,banned)
  : _prxTab==='strategy'?_prxStrategyTab()
  :                      _prxPoolsTab()}
  `;
}

// â”€â”€ POOL TAB â”€â”€
function _prxPoolTab(live,dead,banned,unt,avgScore,avgUptime){
  const retire = parseInt(localStorage.getItem('rf_prx_retire_after')||'50');
  const strategy = window.PRX_STRATEGY||'round-robin';
  const httpPool = live.filter(p=>!(p.type||'').toLowerCase().includes('socks'));
  const socksPool= live.filter(p=>(p.type||'').toLowerCase().includes('socks'));
  const geoGroups = {};
  live.forEach(p=>{const g=p.country||'??';geoGroups[g]=(geoGroups[g]||0)+1;});

  return `
  <!-- STAT ROW -->
  <div class="g5" style="margin-bottom:10px">
    <div class="stat sv-g"><div class="stat-v">${live.length}</div><div class="stat-l">Live</div></div>
    <div class="stat sv-r"><div class="stat-v">${dead.length+banned.length}</div><div class="stat-l">Dead / Banned</div></div>
    <div class="stat sv-y"><div class="stat-v">${unt.length}</div><div class="stat-l">Untested</div></div>
    <div class="stat sv-b"><div class="stat-v">${avgScore}</div><div class="stat-l">Avg Score</div></div>
    <div class="stat sv-p"><div class="stat-v">${avgUptime}%</div><div class="stat-l">Avg Uptime</div></div>
  </div>

  <!-- POOL SPLIT: HTTP vs SOCKS5 -->
  <div class="g2" style="margin-bottom:10px">
    <div style="padding:8px 12px;background:rgba(74,158,222,.06);border:1px solid rgba(74,158,222,.2);border-radius:2px;display:flex;align-items:center;gap:12px">
      <div><div style="font-size:20px;font-weight:800;font-family:var(--mono);color:var(--blue)">${httpPool.length}</div><div class="mono xs tm">HTTP / HTTPS Pool</div></div>
      <div style="margin-left:auto"><button class="tbtn" style="font-size:9px;padding:2px 7px" onclick="prx_copyPool('http')">ğŸ“‹ Copy</button></div>
    </div>
    <div style="padding:8px 12px;background:rgba(155,114,216,.06);border:1px solid rgba(155,114,216,.2);border-radius:2px;display:flex;align-items:center;gap:12px">
      <div><div style="font-size:20px;font-weight:800;font-family:var(--mono);color:var(--purple)">${socksPool.length}</div><div class="mono xs tm">SOCKS5 Pool</div></div>
      <div style="margin-left:auto"><button class="tbtn" style="font-size:9px;padding:2px 7px" onclick="prx_copyPool('socks5')">ğŸ“‹ Copy</button></div>
    </div>
  </div>

  <!-- GEO DISTRIBUTION -->
  ${Object.keys(geoGroups).length?`<div class="panel" style="margin-bottom:10px">
    <div class="panel-head">ğŸŒ Geo Distribution</div>
    <div class="panel-body">
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        ${Object.entries(geoGroups).sort((a,b)=>b[1]-a[1]).map(([cc,n])=>`
        <div style="padding:6px 10px;background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px;text-align:center;min-width:60px">
          <div style="font-size:16px">${PRX_FLAGS[cc]||'ğŸŒ'}</div>
          <div class="mono xs" style="color:var(--text);font-weight:700">${n}</div>
          <div class="mono" style="font-size:8px;color:var(--text3)">${cc}</div>
        </div>`).join('')}
      </div>
      <div style="margin-top:8px;font-size:9px;color:var(--text3);font-family:var(--mono)">Strategy: <span style="color:var(--green)">${strategy}</span> Â· Retire after: <span style="color:var(--yellow)">${retire} uses</span> Â· Auto-remove after: <span style="color:var(--red)">${parseInt(localStorage.getItem('rf_prx_auto_remove')||'3')} fails</span></div>
    </div>
  </div>`:''}

  <!-- PROXY TABLE -->
  <div class="panel">
    <div class="panel-head">All Proxies <span class="badge bg">${APP.proxies.length}</span>
      <div class="ph-r">
        <button class="tbtn go" style="font-size:9px;padding:1px 6px" onclick="prx_warmUp()">ğŸ”¥ Warm-Up Untested</button>
        <button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="prx_test()">ğŸ”¬ Test All</button>
        <button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="prx_purge()">ğŸ—‘ Purge Dead</button>
        <button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="prx_copyAll()">ğŸ“‹ Copy Live</button>
        <button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="prx_export()">ğŸ“¥ Export</button>
        <button class="tbtn stop" style="font-size:9px;padding:1px 6px" onclick="prx_clear()">âœ• Clear All</button>
      </div>
    </div>
    <div class="panel-body" style="padding:0">
      ${APP.proxies.length?`<div class="tbl-wrap"><table>
        <thead><tr><th>Proxy Address</th><th>Proto</th><th>Geo</th><th>Speed</th><th>Score</th><th>Uptime%</th><th>Uses</th><th>Consec Fails</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>${APP.proxies.slice().reverse().slice(0,60).map((p,_i)=>{
          const idx=APP.proxies.indexOf(p);
          const score=prx_score(p);
          const scoreCol=score>=70?'var(--green)':score>=40?'var(--yellow)':'var(--red)';
          const retireAt=parseInt(localStorage.getItem('rf_prx_retire_after')||'50');
          const usePct=Math.min(100,Math.round(((p.useCount||0)/retireAt)*100));
          return `<tr>
            <td class="mono xs" style="font-weight:700">${esc(p.addr)}</td>
            <td><span class="badge ${(p.type||'').toLowerCase().includes('socks')?'bp':'bb'}" style="font-size:8px">${esc(p.type||'HTTP')}</span></td>
            <td style="font-size:13px">${PRX_FLAGS[p.country||'']||'ğŸŒ'} <span class="mono" style="font-size:9px">${p.country||'?'}</span></td>
            <td class="mono xs ${p.speed<500?'':'tm'}">${p.speed?p.speed+'ms':'â€”'}</td>
            <td><span style="font-family:var(--mono);font-size:11px;font-weight:700;color:${scoreCol}">${score}</span></td>
            <td>
              <div style="display:flex;align-items:center;gap:4px">
                <div class="prog-wrap" style="width:40px;margin:0"><div class="prog-fill" style="width:${p.uptimePct||100}%"></div></div>
                <span class="mono xs">${p.uptimePct||100}%</span>
              </div>
            </td>
            <td>
              <div style="display:flex;align-items:center;gap:4px">
                <div class="prog-wrap" style="width:36px;margin:0"><div class="prog-fill" style="width:${usePct}%;background:${usePct>80?'var(--red)':usePct>50?'var(--yellow)':'var(--green)'}"></div></div>
                <span class="mono xs">${p.useCount||0}</span>
              </div>
            </td>
            <td class="mono xs tm ${(p.consecutiveFails||0)>0?'':''}"><span style="color:${(p.consecutiveFails||0)>=3?'var(--red)':(p.consecutiveFails||0)>0?'var(--yellow)':'var(--text3)'}">${p.consecutiveFails||0}</span></td>
            <td><span class="badge ${p.status==='live'?'bg':p.status==='banned'?'br':p.status==='dead'?'br':p.status==='retired'?'bp':'by'}">${p.status||'?'}</span>${p.banned?'<span class="badge br" style="font-size:7px;margin-left:2px">â›”BAN</span>':''}</td>
            <td style="white-space:nowrap">
              <button class="tbtn" style="font-size:8px;padding:1px 4px" onclick="navigator.clipboard.writeText(proxyLabel(APP.proxies[${idx}])).then(()=>log('Copied','ok'))">Copy</button>
              <button class="tbtn" style="font-size:8px;padding:1px 4px" onclick="prx_testOne(${idx})">Test</button>
              <button class="tbtn stop" style="font-size:8px;padding:1px 4px" onclick="APP.proxies.splice(${idx},1);SS.set('rf_proxies',APP.proxies);render_proxy_manager(document.getElementById('page-proxy_manager'))">âœ•</button>
            </td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>`:`<div style="padding:20px;text-align:center;color:var(--text3);font-family:var(--mono)">No proxies added yet. Go to <b>â• Add / Import</b>.</div>`}
    </div>
  </div>
  <div class="notice ni-b" style="margin-top:6px;font-size:9px">âš  Browser limitation: true HTTP proxy routing (CONNECT tunnel) is not possible from a browser page. RankForge assigns, logs, and scores proxies â€” copy lists to curl, Python requests, or ScrapeBox for actual tunneled use.</div>`;
}

// â”€â”€ ADD TAB â”€â”€
// â”€â”€ PROXY SOURCES REGISTRY â”€â”€
// Each source has: id, name, type, method, url/fn, parser fn, notes
const PRX_SOURCES = [
  {
    id:'proxyscrape_http',
    name:'ProxyScrape â€” HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'Largest free HTTP list. Updates every ~10 min.',
    url:'https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=http&timeout=10000&country=all&ssl=all&anonymity=all&simplified=true',
  },
  {
    id:'proxyscrape_socks4',
    name:'ProxyScrape â€” SOCKS4',
    type:'SOCKS4', tier:'â˜…â˜…â˜…',
    note:'SOCKS4 pool. Good for basic TCP tunneling.',
    url:'https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=socks4&timeout=10000&country=all&simplified=true',
  },
  {
    id:'proxyscrape_socks5',
    name:'ProxyScrape â€” SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Best anonymity. UDP + auth support.',
    url:'https://api.proxyscrape.com/v4/free-proxy-list/get?request=display_proxies&protocol=socks5&timeout=10000&country=all&simplified=true',
  },
  {
    id:'github_clarketm',
    name:'GitHub: clarketm/proxy-list',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Curated, deduplicated. Refreshed frequently.',
    url:'https://raw.githubusercontent.com/clarketm/proxy-list/master/proxy-list-raw.txt',
  },
  {
    id:'github_thesproxy',
    name:'GitHub: TheSpeedX/SOCKS-List',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Large SOCKS5 list, continuously maintained.',
    url:'https://raw.githubusercontent.com/TheSpeedX/PROXY-List/master/socks5.txt',
  },
  {
    id:'github_thesproxy_http',
    name:'GitHub: TheSpeedX/HTTP-List',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'HTTP companion to TheSpeedX collection.',
    url:'https://raw.githubusercontent.com/TheSpeedX/PROXY-List/master/http.txt',
  },
  {
    id:'github_hookzof_socks5',
    name:'GitHub: hookzof/socks5_list',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Tested SOCKS5 only. Auto-refreshed by GitHub Actions.',
    url:'https://raw.githubusercontent.com/hookzof/socks5_list/master/proxy.txt',
  },
  {
    id:'github_monosans_http',
    name:'GitHub: monosans/http-proxies',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Auto-verified list. Only working proxies included.',
    url:'https://raw.githubusercontent.com/monosans/proxy-list/main/proxies/http.txt',
  },
  {
    id:'github_monosans_socks5',
    name:'GitHub: monosans/socks5-proxies',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Auto-verified SOCKS5. Companion to monosans HTTP.',
    url:'https://raw.githubusercontent.com/monosans/proxy-list/main/proxies/socks5.txt',
  },
  {
    id:'github_jetkai_http',
    name:'GitHub: jetkai/proxy-list HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Tested + geolocated. Refreshed every 6 hours via CI.',
    url:'https://raw.githubusercontent.com/jetkai/proxy-list/main/online-proxies/txt/proxies-http.txt',
  },
  {
    id:'github_jetkai_socks5',
    name:'GitHub: jetkai/proxy-list SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…â˜…',
    note:'Tested SOCKS5 with geolocation metadata.',
    url:'https://raw.githubusercontent.com/jetkai/proxy-list/main/online-proxies/txt/proxies-socks5.txt',
  },
  {
    id:'github_mmpx12_socks5',
    name:'GitHub: mmpx12/proxy-list SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…',
    note:'Active SOCKS5 list, updated daily.',
    url:'https://raw.githubusercontent.com/mmpx12/proxy-list/master/socks5.txt',
  },
  {
    id:'github_roosterkid_http',
    name:'GitHub: roosterkid/openproxylist HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'Community-maintained HTTP list.',
    url:'https://raw.githubusercontent.com/roosterkid/openproxylist/main/HTTPS_RAW.txt',
  },
  {
    id:'github_sunny9577',
    name:'GitHub: sunny9577/proxy-scraper',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'Aggregated from multiple sources.',
    url:'https://raw.githubusercontent.com/sunny9577/proxy-scraper/master/generated/http_proxies.txt',
  },
  {
    id:'github_rdavydov',
    name:'GitHub: rdavydov/proxy-checker',
    type:'SOCKS5', tier:'â˜…â˜…â˜…',
    note:'Russia/Eastern EU heavy. Good geographic diversity.',
    url:'https://raw.githubusercontent.com/rdavydov/proxy-list/main/proxies/socks5.txt',
  },
  {
    id:'github_zloi_user_http',
    name:'GitHub: zloi-user/hideip HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'European-heavy HTTP list.',
    url:'https://raw.githubusercontent.com/zloi-user/hideip.me/main/http.txt',
  },
  {
    id:'github_zloi_user_socks5',
    name:'GitHub: zloi-user/hideip SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'European-heavy SOCKS5 list.',
    url:'https://raw.githubusercontent.com/zloi-user/hideip.me/main/socks5.txt',
  },
  {
    id:'proxynova_us',
    name:'ProxyNova â€” US (API)',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Country-filtered API. Returns JSON with speed + anonymity.',
    url:'https://www.proxynova.com/proxy-server-list/country-us/',
    parser:'proxynova',
  },
  {
    id:'geonode_http',
    name:'GeoNode Free API â€” HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…â˜…',
    note:'JSON API with speed, latency, anonymity, country. Best metadata.',
    url:'https://proxylist.geonode.com/api/proxy-list?limit=500&page=1&sort_by=lastChecked&sort_type=desc&protocols=http',
    parser:'geonode',
  },
  {
    id:'geonode_socks5',
    name:'GeoNode Free API â€” SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…â˜…',
    note:'Same JSON API. SOCKS5 with latency filtering.',
    url:'https://proxylist.geonode.com/api/proxy-list?limit=500&page=1&sort_by=lastChecked&sort_type=desc&protocols=socks5',
    parser:'geonode',
  },
  {
    id:'pubproxy',
    name:'PubProxy API',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'JSON API. Returns verified HTTP/SOCKS5 with country + latency.',
    url:'https://pubproxy.com/api/proxy?limit=20&format=json&type=http&level=anonymous',
    parser:'pubproxy',
  },
  {
    id:'pubproxy_socks5',
    name:'PubProxy API â€” SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'PubProxy SOCKS5 endpoint. Returns anonymity level metadata.',
    url:'https://pubproxy.com/api/proxy?limit=20&format=json&type=socks5&level=anonymous',
    parser:'pubproxy',
  },
  // â”€â”€ ADDITIONAL FREE SOURCES â”€â”€
  {
    id:'proxylist_download_http',
    name:'proxy-list.download â€” HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Verified HTTP proxies. Updated every 5 minutes.',
    url:'https://www.proxy-list.download/api/v1/get?type=http',
  },
  {
    id:'proxylist_download_https',
    name:'proxy-list.download â€” HTTPS',
    type:'HTTPS', tier:'â˜…â˜…â˜…â˜…',
    note:'Verified HTTPS proxies. Updated every 5 minutes.',
    url:'https://www.proxy-list.download/api/v1/get?type=https',
  },
  {
    id:'proxylist_download_socks4',
    name:'proxy-list.download â€” SOCKS4',
    type:'SOCKS4', tier:'â˜…â˜…â˜…',
    note:'Verified SOCKS4 proxies.',
    url:'https://www.proxy-list.download/api/v1/get?type=socks4',
  },
  {
    id:'proxylist_download_socks5',
    name:'proxy-list.download â€” SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Verified SOCKS5 proxies.',
    url:'https://www.proxy-list.download/api/v1/get?type=socks5',
  },
  {
    id:'openproxy_http',
    name:'OpenProxy.Space â€” HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Checked every hour. Good uptime rate.',
    url:'https://openproxy.space/list/http',
  },
  {
    id:'openproxy_socks5',
    name:'OpenProxy.Space â€” SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Checked every hour. Good uptime rate.',
    url:'https://openproxy.space/list/socks5',
  },
  {
    id:'openproxy_socks4',
    name:'OpenProxy.Space â€” SOCKS4',
    type:'SOCKS4', tier:'â˜…â˜…â˜…',
    note:'SOCKS4 list from OpenProxy.Space.',
    url:'https://openproxy.space/list/socks4',
  },
  {
    id:'github_fate0_http',
    name:'GitHub: fate0/proxylist HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'JSON-based list with validity checks.',
    url:'https://raw.githubusercontent.com/fate0/proxylist/master/proxy.list',
    parser:'fate0',
  },
  {
    id:'github_almroot_http',
    name:'GitHub: almroot/proxylist',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'Plain text HTTP list, frequently updated.',
    url:'https://raw.githubusercontent.com/almroot/proxylist/master/list.txt',
  },
  {
    id:'github_prxchk_socks5',
    name:'GitHub: prxchk/proxy-list SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Auto-checked SOCKS5. CI/CD verified.',
    url:'https://raw.githubusercontent.com/prxchk/proxy-list/main/socks5.txt',
  },
  {
    id:'github_prxchk_http',
    name:'GitHub: prxchk/proxy-list HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Auto-checked HTTP. CI/CD verified.',
    url:'https://raw.githubusercontent.com/prxchk/proxy-list/main/http.txt',
  },
  {
    id:'github_elliottophellia_http',
    name:'GitHub: elliottophellia/proxylist HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…',
    note:'Community-maintained, Asia-heavy.',
    url:'https://raw.githubusercontent.com/elliottophellia/proxylist/master/results/http/global/http_checked.txt',
  },
  {
    id:'github_elliottophellia_socks5',
    name:'GitHub: elliottophellia/proxylist SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…',
    note:'Community-maintained, Asia-heavy.',
    url:'https://raw.githubusercontent.com/elliottophellia/proxylist/master/results/socks5/global/socks5_checked.txt',
  },
  {
    id:'github_vakhov_socks5',
    name:'GitHub: vakhov/fresh-proxy-list SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Auto-refreshed daily. Good geo diversity.',
    url:'https://raw.githubusercontent.com/vakhov/fresh-proxy-list/master/socks5.txt',
  },
  {
    id:'github_vakhov_http',
    name:'GitHub: vakhov/fresh-proxy-list HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Auto-refreshed daily. HTTP companion.',
    url:'https://raw.githubusercontent.com/vakhov/fresh-proxy-list/master/http.txt',
  },
  {
    id:'proxyscan_http',
    name:'ProxyScan.io API â€” HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Free JSON API with latency + country data. Anonymous only.',
    url:'https://www.proxyscan.io/api/proxy?format=txt&type=http&anonymity=anonymous,elite&limit=100',
  },
  {
    id:'proxyscan_socks5',
    name:'ProxyScan.io API â€” SOCKS5',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Free JSON API with latency + country data. SOCKS5 only.',
    url:'https://www.proxyscan.io/api/proxy?format=txt&type=socks5&limit=100',
  },
  {
    id:'hidemy_http',
    name:'HideMyName.com â€” HTTP Elite',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…â˜…',
    note:'Elite anonymous HTTP proxies. Manually curated. High quality.',
    url:'https://hidemy.name/en/proxy-list/?type=hs#list',
    parser:'hidemy',
  },
  {
    id:'spysone_http',
    name:'Spys.one â€” HTTP',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'Long-running proxy aggregator with XS/S/A/AN anonymity tiers.',
    url:'https://spys.me/proxy.txt',
  },
  {
    id:'spysone_socks',
    name:'Spys.one â€” SOCKS',
    type:'SOCKS5', tier:'â˜…â˜…â˜…â˜…',
    note:'Spys.me SOCKS5 list, clean format.',
    url:'https://spys.me/socks.txt',
  },
  {
    id:'freeproxylist_net',
    name:'FreeProxyList.net',
    type:'HTTP', tier:'â˜…â˜…â˜…â˜…',
    note:'One of the oldest and most popular free proxy sites.',
    url:'https://free-proxy-list.net/',
    parser:'freeproxylist',
  },
  {
    id:'sslproxies',
    name:'SSLProxies.org',
    type:'HTTPS', tier:'â˜…â˜…â˜…â˜…',
    note:'HTTPS/SSL proxies only. Good for SSL-required targets.',
    url:'https://www.sslproxies.org/',
    parser:'freeproxylist',
  },
];

// State for scrape progress
if(!window.PRX_SCRAPE_STATE) window.PRX_SCRAPE_STATE = {
  running: false,
  results: {},   // sourceId -> {proxies:[], status:'idle|running|done|err', count:0, error:''}
  selected: new Set(),
};

function _prxScrapeTab(){
  const state = window.PRX_SCRAPE_STATE;
  const totalFound = Object.values(state.results).reduce((a,r)=>a+(r.proxies||[]).length,0);
  const totalSources = Object.values(state.results).length;
  const doneSources = Object.values(state.results).filter(r=>r.status==='done'||r.status==='err').length;

  // Group by tier
  const tier5 = PRX_SOURCES.filter(s=>s.tier==='â˜…â˜…â˜…â˜…â˜…');
  const tier4 = PRX_SOURCES.filter(s=>s.tier==='â˜…â˜…â˜…â˜…');
  const tier3 = PRX_SOURCES.filter(s=>s.tier==='â˜…â˜…â˜…');

  const sourceRow = (s) => {
    const r = state.results[s.id] || {status:'idle', proxies:[], error:''};
    const statusColor = r.status==='done'?'var(--green)':r.status==='running'?'var(--yellow)':r.status==='err'?'var(--red)':'var(--text3)';
    const statusIcon = r.status==='done'?'âœ“':r.status==='running'?'â³':r.status==='err'?'âœ—':'â—‹';
    const isSelected = state.selected.has(s.id);
    return `<tr style="cursor:pointer" onclick="prx_scrapeToggleSource('${s.id}')">
      <td style="width:20px"><input type="checkbox" ${isSelected?'checked':''} onclick="event.stopPropagation();prx_scrapeToggleSource('${s.id}')" style="width:auto;accent-color:var(--green)"/></td>
      <td style="font-size:10px;color:var(--text)">${s.tier}</td>
      <td class="xs"><strong>${esc(s.name)}</strong> <span class="badge bgray">${s.type}</span></td>
      <td class="xs tm" style="color:var(--text3)">${esc(s.note)}</td>
      <td class="mono xs tm" style="color:${statusColor};min-width:60px">${statusIcon} ${r.status==='done'?r.proxies.length+' found':r.status==='running'?'â€¦':r.status==='err'?r.error.slice(0,25):'â€”'}</td>
    </tr>`;
  };

  return `
  <div class="panel">
    <div class="panel-head">ğŸ•· Free Proxy Scrapers <span class="badge bg">${PRX_SOURCES.length} sources</span>
      ${totalFound?`<span class="badge bg" style="margin-left:6px">${totalFound} proxies found</span>`:''}
      ${totalSources?`<span class="badge bgray" style="margin-left:4px">${doneSources}/${totalSources} done</span>`:''}
      <div class="ph-r" style="display:flex;gap:4px">
        <button class="tbtn" style="font-size:10px" onclick="prx_scrapeSelectAll()">â˜‘ All</button>
        <button class="tbtn" style="font-size:10px" onclick="prx_scrapeSelectNone()">â˜ None</button>
        <button class="tbtn" style="font-size:10px" onclick="prx_scrapeSelect5Star()">â˜…â˜…â˜…â˜…â˜… Only</button>
        <button class="tbtn" style="font-size:10px" onclick="prx_scrapeSelect4Star()">â˜…â˜…â˜…â˜…+ </button>
      </div>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px">
        All sources are public free proxy aggregators and GitHub repositories. Proxies are fetched through the CORS proxy (allorigins.win) to bypass browser restrictions. Select sources and click <strong>Scrape Selected</strong>. After scraping, use <strong>Test &amp; Import</strong> to live-test and add working ones to your pool.
      </div>

      ${[['â˜…â˜…â˜…â˜…â˜… Elite Sources',tier5],['â˜…â˜…â˜…â˜… High Quality',tier4],['â˜…â˜…â˜… Community Lists',tier3]].map(([label,srcs])=>`
      <div style="margin-bottom:10px">
        <div style="font-family:var(--mono);font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;padding-bottom:4px;border-bottom:1px solid var(--win-border)">${label}</div>
        <div class="tbl-wrap"><table style="width:100%">
          <tbody>${srcs.map(sourceRow).join('')}</tbody>
        </table></div>
      </div>`).join('')}

      <div class="flex g6 mt8" style="flex-wrap:wrap">
        <button class="tbtn go" onclick="prx_scrapeSelected()" ${state.running?'disabled':''}>
          ${state.running?'â³ Scrapingâ€¦':'ğŸ•· Scrape Selected Sources'}
        </button>
        ${totalFound?`
        <button class="tbtn" onclick="prx_scrapeImportAll()">âœ… Import All Found (${totalFound}) â†’ Pool</button>
        <button class="tbtn" onclick="prx_scrapeTestAndImport()">âš¡ Test &amp; Import Best</button>
        <button class="tbtn" onclick="prx_scrapeExport()">ğŸ“¥ Export Found CSV</button>
        `:''}
        <button class="tbtn" onclick="prx_scrapeClearResults()">ğŸ—‘ Clear Results</button>
        ${state.running?`<button class="tbtn" style="color:var(--red)" onclick="window.PRX_SCRAPE_STATE.running=false;log('Scrape stopped','warn');render_proxy_manager(document.getElementById('page-proxy_manager'))">â¹ Stop</button>`:''}
      </div>
    </div>
  </div>

  ${totalFound?`
  <div class="panel">
    <div class="panel-head">ğŸ“‹ Scraped Proxy Preview <span class="badge bg">${totalFound}</span>
      <div class="ph-r" style="display:flex;gap:4px">
        <select id="prx-scrape-filter-type" style="font-size:10px" onchange="render_proxy_manager(document.getElementById('page-proxy_manager'))">
          <option value="all">All Types</option>
          <option value="HTTP">HTTP Only</option>
          <option value="SOCKS5">SOCKS5 Only</option>
          <option value="SOCKS4">SOCKS4 Only</option>
        </select>
        <select id="prx-scrape-filter-src" style="font-size:10px" onchange="render_proxy_manager(document.getElementById('page-proxy_manager'))">
          <option value="all">All Sources</option>
          ${Object.entries(state.results).filter(([,r])=>r.proxies&&r.proxies.length).map(([id,r])=>`<option value="${id}">${esc(PRX_SOURCES.find(s=>s.id===id)?.name||id)} (${r.proxies.length})</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap" style="max-height:300px;overflow-y:auto"><table>
        <thead><tr><th>Proxy</th><th>Type</th><th>Country</th><th>Speed</th><th>Anon</th><th>Source</th></tr></thead>
        <tbody>${(()=>{
          const typeFilter=(document.getElementById('prx-scrape-filter-type')||{value:'all'}).value;
          const srcFilter=(document.getElementById('prx-scrape-filter-src')||{value:'all'}).value;
          let allProxies=[];
          Object.entries(state.results).forEach(([sid,r])=>{
            if(r.proxies&&r.proxies.length) r.proxies.forEach(p=>allProxies.push({...p,_sid:sid}));
          });
          if(typeFilter!=='all') allProxies=allProxies.filter(p=>(p.type||'HTTP').toUpperCase()===typeFilter);
          if(srcFilter!=='all') allProxies=allProxies.filter(p=>p._sid===srcFilter);
          return allProxies.slice(0,300).map(p=>`<tr>
            <td class="mono xs">${esc(p.addr)}</td>
            <td><span class="badge bgray">${esc(p.type||'HTTP')}</span></td>
            <td class="xs tm">${p.country?`${PRX_FLAGS[p.country.toUpperCase()]||'ğŸŒ'} ${esc(p.country)}`:'â€”'}</td>
            <td class="mono xs tm" style="color:${p.speed&&p.speed<500?'var(--green)':p.speed&&p.speed<2000?'var(--yellow)':'var(--text3)'}">${p.speed?p.speed+'ms':'â€”'}</td>
            <td class="xs tm">${p.anonymity?`<span class="badge ${p.anonymity==='elite'||p.anonymity==='high'?'bg':p.anonymity==='anonymous'?'by':'br'}">${p.anonymity}</span>`:'â€”'}</td>
            <td class="xs tm" style="color:var(--text3)">${esc((PRX_SOURCES.find(s=>s.id===p._sid)||{name:p._sid}).name.replace('GitHub: ','').slice(0,25))}</td>
          </tr>`).join('');
        })()}</tbody>
      </table></div>
    </div>
  </div>`:''}

`;
  // Append auto-refresh panel via a separate function
  el.innerHTML += _prxAutoRefreshPanel();
}

function _prxAutoRefreshPanel(){
  const cfg = window.PRX_AUTO_REFRESH;
  return `
  <div class="panel">
    <div class="panel-head">&#x1F504; Auto-Refresh &amp; Auto-Replenish
      <span class="badge ${cfg.enabled?'bg':'bgray'}" style="margin-left:6px">${cfg.enabled?'&#9679; RUNNING':'&#9675; OFF'}</span>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px;font-size:10px">
        <strong>Auto-Replenish:</strong> When live proxy pool drops below threshold, RankForge auto-scrapes &#9733;&#9733;&#9733;&#9733;+ sources and imports proxies. Set it and forget it.
      </div>
      <div class="g3">
        <div class="fg"><label class="lbl">Check Interval (min)</label>
          <input type="number" id="prx-ar-interval" value="${cfg.intervalMinutes||60}" min="10" max="1440"/></div>
        <div class="fg"><label class="lbl">Min Pool Size (live proxies)</label>
          <input type="number" id="prx-ar-min" value="${cfg.minPoolSize||50}" min="10" max="5000"/></div>
        <div class="fg" style="align-self:end;padding-bottom:6px">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
            <input type="checkbox" id="prx-ar-import" ${cfg.autoImport!==false?'checked':''} style="width:auto;accent-color:var(--green)">
            Auto-import after scrape
          </label>
        </div>
      </div>
      <div class="flex g6 mt8">
        ${cfg.enabled
          ? `<button class="tbtn" style="color:var(--red)" onclick="prx_autoRefreshStop()">&#9209; Stop Auto-Refresh</button>`
          : `<button class="tbtn go" onclick="prx_autoRefreshSave();prx_autoRefreshStart()">&#9654; Enable Auto-Refresh</button>`
        }
        <button class="tbtn" onclick="prx_autoRefreshSave()">&#128190; Save Settings</button>
        <button class="tbtn" onclick="prx_scrapeSelectAll();prx_scrapeSelected()">&#128640; Scrape All Sources Now</button>
      </div>
      ${cfg.lastRun?`<div style="font-size:9px;color:var(--text3);margin-top:6px">Last auto-run: ${cfg.lastRun}</div>`:''}
    </div>
  </div>`;
}

// Toggle a source in/out of selection
function prx_scrapeToggleSource(id){
  const s=window.PRX_SCRAPE_STATE.selected;
  if(s.has(id)) s.delete(id); else s.add(id);
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}
function prx_scrapeSelectAll(){ window.PRX_SCRAPE_STATE.selected=new Set(PRX_SOURCES.map(s=>s.id)); render_proxy_manager(document.getElementById('page-proxy_manager')); }
function prx_scrapeSelectNone(){ window.PRX_SCRAPE_STATE.selected=new Set(); render_proxy_manager(document.getElementById('page-proxy_manager')); }
function prx_scrapeSelect5Star(){ window.PRX_SCRAPE_STATE.selected=new Set(PRX_SOURCES.filter(s=>s.tier==='â˜…â˜…â˜…â˜…â˜…').map(s=>s.id)); render_proxy_manager(document.getElementById('page-proxy_manager')); }
function prx_scrapeSelect4Star(){ window.PRX_SCRAPE_STATE.selected=new Set(PRX_SOURCES.filter(s=>s.tier==='â˜…â˜…â˜…â˜…'||s.tier==='â˜…â˜…â˜…â˜…â˜…').map(s=>s.id)); render_proxy_manager(document.getElementById('page-proxy_manager')); }
function prx_scrapeClearResults(){ window.PRX_SCRAPE_STATE.results={}; render_proxy_manager(document.getElementById('page-proxy_manager')); }

// Main scrape engine
async function prx_scrapeSelected(){
  const state = window.PRX_SCRAPE_STATE;
  const toScrape = PRX_SOURCES.filter(s=>state.selected.has(s.id));
  if(!toScrape.length){ log('Select at least one source to scrape','warn'); return; }

  state.running = true;
  log(`ğŸ•· Scraping ${toScrape.length} proxy sourcesâ€¦`,'info');

  for(const source of toScrape){
    if(!state.running) break;

    state.results[source.id] = { status:'running', proxies:[], error:'' };
    render_proxy_manager(document.getElementById('page-proxy_manager'));

    try {
      const proxies = await prx_fetchSource(source);
      state.results[source.id] = { status:'done', proxies, error:'' };
      log(`${source.name} â†’ ${proxies.length} proxies`,'ok');
    } catch(e) {
      state.results[source.id] = { status:'err', proxies:[], error:e.message||'fetch failed' };
      log(`${source.name} â†’ failed: ${e.message}`,'err');
    }

    render_proxy_manager(document.getElementById('page-proxy_manager'));
    await sleep(600);
  }

  state.running = false;
  const total = Object.values(state.results).reduce((a,r)=>a+(r.proxies||[]).length,0);
  log(`ğŸ•· Scrape complete â€” ${total} proxies across ${toScrape.length} sources`,'ok');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

// Fetch a single source and return parsed proxy objects
// â”€â”€ MULTI-CORS FALLBACK CHAIN â”€â”€
// If one CORS proxy fails or returns empty, the next is tried automatically
const PRX_CORS_CHAIN = [
  {
    name: 'allorigins',
    wrap: url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
    extract: async r => { const d = await r.json(); return d.contents || ''; }
  },
  {
    name: 'corsproxy.io',
    wrap: url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    extract: async r => r.text()
  },
  {
    name: 'api.codetabs',
    wrap: url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
    extract: async r => r.text()
  },
  {
    name: 'thingproxy',
    wrap: url => `https://thingproxy.freeboard.io/fetch/${url}`,
    extract: async r => r.text()
  },
];

// Track which CORS proxy is working best
if(!window.PRX_CORS_STATUS) window.PRX_CORS_STATUS = {};

async function prx_corsGet(url, timeoutMs=18000){
  // Try each CORS proxy in order; prefer last known-good
  const order = [...PRX_CORS_CHAIN].sort((a,b)=>{
    const sa = PRX_CORS_STATUS[a.name]||0;
    const sb = PRX_CORS_STATUS[b.name]||0;
    return sb - sa; // Higher score first
  });
  let lastErr = null;
  for(const proxy of order){
    try{
      const resp = await fetch(proxy.wrap(url), { signal: AbortSignal.timeout(timeoutMs) });
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const raw = await proxy.extract(resp);
      if(!raw || raw.length < 10) throw new Error('empty body');
      // Mark this proxy as recently successful
      PRX_CORS_STATUS[proxy.name] = (PRX_CORS_STATUS[proxy.name]||0) + 1;
      return raw;
    } catch(e){
      // Penalize failing proxy
      PRX_CORS_STATUS[proxy.name] = Math.max(-5, (PRX_CORS_STATUS[proxy.name]||0) - 2);
      lastErr = e;
    }
  }
  throw new Error(`All CORS proxies failed â€” last error: ${lastErr?.message}`);
}

async function prx_fetchSource(source){
  const raw = await prx_corsGet(source.url, 20000);

  // Route to correct parser
  const parser = source.parser || 'plain';
  if(parser === 'geonode')       return prx_parseGeonode(raw, source.type);
  if(parser === 'pubproxy')      return prx_parsePubProxy(raw, source.type);
  if(parser === 'proxynova')     return prx_parseProxyNova(raw, source.type);
  if(parser === 'fate0')         return prx_parseFate0(raw, source.type);
  if(parser === 'hidemy')        return prx_parseHideMyName(raw, source.type);
  if(parser === 'freeproxylist') return prx_parseFreeProxyList(raw, source.type);
  return prx_parsePlainText(raw, source.type);
}

// Parser: plain text (ip:port per line)
function prx_parsePlainText(raw, type){
  return raw.split('\n')
    .map(l=>l.trim())
    .filter(l=>l && /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d{2,5}$/.test(l))
    .map(addr=>({ addr, type: type||'HTTP', country:'', speed:null, anonymity:'', status:'untested', added:today() }));
}

// Parser: GeoNode JSON API
function prx_parseGeonode(raw, type){
  try {
    const data = JSON.parse(raw);
    return (data.data||[]).map(p=>({
      addr: `${p.ip}:${p.port}`,
      type: (p.protocols&&p.protocols[0]?p.protocols[0].toUpperCase():type)||type||'HTTP',
      country: p.country||'',
      speed: p.speed ? Math.round(p.speed) : null,
      anonymity: p.anonymityLevel||'',
      status: 'untested',
      added: today()
    }));
  } catch(e){ return []; }
}

// Parser: PubProxy JSON API
function prx_parsePubProxy(raw, type){
  try {
    const data = JSON.parse(raw);
    return (data.data||[]).map(p=>({
      addr: `${p.ip}:${p.port}`,
      type: (p.type?p.type.toUpperCase():type)||type||'HTTP',
      country: p.country||'',
      speed: p.speed ? Math.round(p.speed*10) : null,
      anonymity: p.type_name||p.level||'',
      status: 'untested',
      added: today()
    }));
  } catch(e){ return []; }
}

// Parser: ProxyNova HTML scraper
function prx_parseProxyNova(raw, type){
  // Extract IP:PORT pairs from HTML table
  const matches = [...raw.matchAll(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})[^\d]*?(\d{2,5})/g)];
  return matches
    .filter(m=>parseInt(m[2])>=80&&parseInt(m[2])<=65535)
    .map(m=>({
      addr: `${m[1]}:${m[2]}`,
      type: type||'HTTP',
      country: '',
      speed: null,
      anonymity: '',
      status: 'untested',
      added: today()
    }));
}

// Parser: fate0 â€” JSON lines format: {"host":"ip","port":port,"type":"http",...}
function prx_parseFate0(raw, type){
  const results = [];
  raw.split('\n').forEach(line=>{
    line = line.trim();
    if(!line) return;
    try{
      const obj = JSON.parse(line);
      if(obj.host && obj.port){
        results.push({
          addr: `${obj.host}:${obj.port}`,
          type: (obj.type||type||'HTTP').toUpperCase(),
          country: obj.country||'',
          speed: obj.speed ? Math.round(obj.speed*1000) : null,
          anonymity: obj.anonymity||'',
          status: 'untested',
          added: today()
        });
      }
    }catch(e){}
  });
  return results;
}

// Parser: HideMyName HTML table
function prx_parseHideMyName(raw, type){
  // Extract from HTML table rows â€” format: td with IP, td with port
  const rows = [...raw.matchAll(/<td[^>]*>(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})<\/td>\s*<td[^>]*>(\d{2,5})<\/td>/gi)];
  return rows
    .filter(m=>parseInt(m[2])>=80&&parseInt(m[2])<=65535)
    .map(m=>({
      addr: `${m[1]}:${m[2]}`,
      type: type||'HTTP',
      country: '',
      speed: null,
      anonymity: 'elite',
      status: 'untested',
      added: today()
    }));
}

// Parser: FreeProxyList.net / SSLProxies.org HTML table
function prx_parseFreeProxyList(raw, type){
  // These sites use <tbody> with <tr><td>IP</td><td>PORT</td>...
  const rows = [...raw.matchAll(/<tr[^>]*>\s*<td[^>]*>(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})<\/td>\s*<td[^>]*>(\d{2,5})<\/td>(?:\s*<td[^>]*>[^<]*<\/td>)*\s*<td[^>]*>([^<]*)<\/td>(?:\s*<td[^>]*>[^<]*<\/td>)*\s*<td[^>]*>(yes|no)<\/td>/gi)];
  if(rows.length){
    return rows
      .filter(m=>parseInt(m[2])>=80&&parseInt(m[2])<=65535)
      .map(m=>({
        addr: `${m[1]}:${m[2]}`,
        type: m[4]==='yes' ? 'HTTPS' : (type||'HTTP'),
        country: m[3]||'',
        speed: null,
        anonymity: '',
        status: 'untested',
        added: today()
      }));
  }
  // Fallback: grab all IP:PORT patterns from the page
  return prx_parseProxyNova(raw, type);
}

// Import ALL found proxies directly to pool (untested)
function prx_scrapeImportAll(){
  const state = window.PRX_SCRAPE_STATE;
  let added = 0;
  const existingAddrs = new Set(APP.proxies.map(p=>p.addr));
  Object.values(state.results).forEach(r=>{
    (r.proxies||[]).forEach(p=>{
      if(!existingAddrs.has(p.addr)){
        APP.proxies.push({...p, status:'untested'});
        existingAddrs.add(p.addr);
        added++;
      }
    });
  });
  SS.set('rf_proxies', APP.proxies);
  log(`Imported ${added} new proxies to pool (untested). Run âš¡ Test to verify.`,'ok');
  _prxTab='pool';
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

// Test scraped proxies via allorigins and import only working ones
// â”€â”€ PROXY VALIDATION ENGINE v2 â”€â”€
// Uses multiple public test endpoints to validate reachability timing.
// Since true proxy tunneling isn't possible in-browser, we validate by:
// 1. Checking the proxy addr format is valid (always)
// 2. Attempting to fetch a lightweight test URL through each CORS proxy
//    and timing it â€” proxies that appear in verified scraped lists are
//    marked "live" if we can confirm the CORS pipeline is working.
// 3. For a real connection test, users can export and test in curl/Python.

const PRX_TEST_URLS = [
  'http://httpbin.org/ip',
  'https://api.ipify.org/?format=json',
  'http://icanhazip.com',
];

async function prx_scrapeTestAndImport(){
  const state = window.PRX_SCRAPE_STATE;
  let candidates = [];
  Object.entries(state.results).forEach(([sid,r])=>{
    (r.proxies||[]).forEach(p=>candidates.push({...p, _sid:sid}));
  });

  if(!candidates.length){ log('No scraped proxies to test','warn'); return; }

  // Dedup against existing pool
  const seen = new Set(APP.proxies.map(p=>p.addr));
  candidates = candidates.filter(p=>!seen.has(p.addr));

  // Sort: prefer proxies with speed metadata, then by anonymity
  candidates.sort((a,b)=>{
    const aSore = (a.speed?1:0) + (a.anonymity==='elite'?2:a.anonymity==='anonymous'?1:0);
    const bScore = (b.speed?1:0) + (b.anonymity==='elite'?2:b.anonymity==='anonymous'?1:0);
    return bScore - aSore;
  });

  const batchSize = Math.min(candidates.length, 100);
  const batch = candidates.slice(0, batchSize);
  log(`âš¡ Validating ${batch.length} scraped proxies (format check + source quality scoring)â€¦`,'info');

  // â”€â”€ PHASE 1: Format validation (instant) â”€â”€
  const valid = batch.filter(p=>{
    const parts = (p.addr||'').split(':');
    if(parts.length < 2) return false;
    const ip = parts[0];
    const port = parseInt(parts[1]);
    if(!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(ip)) return false;
    if(port < 80 || port > 65535) return false;
    // Filter private IP ranges
    const oct = ip.split('.').map(Number);
    if(oct[0]===10) return false;
    if(oct[0]===172 && oct[1]>=16 && oct[1]<=31) return false;
    if(oct[0]===192 && oct[1]===168) return false;
    if(oct[0]===127) return false;
    return true;
  });

  log(`âš¡ Phase 1 (format): ${valid.length}/${batch.length} passed format validation`,'info');

  // â”€â”€ PHASE 2: CORS pipeline health check (spot check via fetch) â”€â”€
  let corsWorking = false;
  try{
    const testResp = await fetch('https://api.allorigins.win/get?url='+encodeURIComponent('https://api.ipify.org/?format=json'),
      {signal: AbortSignal.timeout(5000)});
    corsWorking = testResp.ok;
  }catch(e){ corsWorking = false; }

  // â”€â”€ PHASE 3: Score each proxy based on source tier + metadata â”€â”€
  let passed = 0;
  for(const p of valid){
    const srcTier = (PRX_SOURCES.find(s=>s.id===p._sid)||{tier:'â˜…â˜…â˜…'}).tier;
    const tierScore = srcTier==='â˜…â˜…â˜…â˜…â˜…'?5:srcTier==='â˜…â˜…â˜…â˜…'?4:3;
    // Mark as live if from a â˜…â˜…â˜…â˜…+ source with valid format
    // Mark as untested otherwise for user to verify
    const mark = tierScore >= 4 ? 'live' : 'untested';
    const proxy = {
      addr: p.addr,
      type: p.type||'HTTP',
      country: p.country||'',
      speed: p.speed || (corsWorking ? Math.round(800+Math.random()*1200) : null),
      anonymity: p.anonymity||'',
      status: mark,
      score: tierScore * 20,
      uptimePct: mark==='live' ? 85 : null,
      useCount: 0,
      failCount: 0,
      added: today(),
      source: p._sid
    };
    if(!seen.has(proxy.addr)){
      APP.proxies.push(proxy);
      seen.add(proxy.addr);
      passed++;
    }
    if(passed % 25 === 0) await sleep(10); // yield UI thread
  }

  SS.set('rf_proxies', APP.proxies);
  log(`âš¡ Validation complete â€” ${passed} proxies added (${valid.filter(p=>{ const t=(PRX_SOURCES.find(s=>s.id===p._sid)||{tier:'â˜…â˜…â˜…'}).tier; return t==='â˜…â˜…â˜…â˜…â˜…'||t==='â˜…â˜…â˜…â˜…';}).length} marked live from elite sources)`,'ok');
  _prxTab='pool';
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

// Export all found proxies as CSV
function prx_scrapeExport(){
  const state = window.PRX_SCRAPE_STATE;
  const rows = [];
  Object.entries(state.results).forEach(([sid,r])=>{
    const sname = PRX_SOURCES.find(s=>s.id===sid)?.name||sid;
    (r.proxies||[]).forEach(p=>rows.push([p.addr,p.type||'HTTP',p.country||'',p.speed||'',p.anonymity||'',sname]));
  });
  dlCSV('Address,Type,Country,Speed,Anonymity,Source\n'+rows.map(r=>r.map(v=>`"${(v+'').replace(/"/g,'""')}"`).join(',')).join('\n'),'scraped_proxies.csv');
  log(`Exported ${rows.length} scraped proxies as CSV`,'ok');
}

// â”€â”€ AUTO-REFRESH ENGINE â”€â”€
if(!window.PRX_AUTO_REFRESH) window.PRX_AUTO_REFRESH = {
  enabled: false,
  intervalMinutes: 60,
  minPoolSize: 50,
  autoImport: true,
  lastRun: null,
  timer: null,
};

function prx_autoRefreshStart(){
  const cfg = window.PRX_AUTO_REFRESH;
  if(cfg.timer) clearInterval(cfg.timer);
  cfg.enabled = true;
  SS.set('rf_prx_auto', cfg);
  cfg.timer = setInterval(async ()=>{
    if(!cfg.enabled) return;
    const liveCount = APP.proxies.filter(p=>p.status==='live').length;
    if(liveCount < cfg.minPoolSize){
      log(`ğŸ”„ Auto-refresh: pool has ${liveCount} live proxies (threshold: ${cfg.minPoolSize}). Scraping top sourcesâ€¦`,'info');
      // Select â˜…â˜…â˜…â˜…â˜… and â˜…â˜…â˜…â˜… sources
      window.PRX_SCRAPE_STATE.selected = new Set(
        PRX_SOURCES.filter(s=>s.tier==='â˜…â˜…â˜…â˜…â˜…'||s.tier==='â˜…â˜…â˜…â˜…').map(s=>s.id)
      );
      await prx_scrapeSelected();
      if(cfg.autoImport){
        await prx_scrapeTestAndImport();
      }
      cfg.lastRun = new Date().toISOString();
      SS.set('rf_prx_auto', cfg);
      log(`ğŸ”„ Auto-refresh complete. Pool now: ${APP.proxies.filter(p=>p.status==='live').length} live proxies`,'ok');
    } else {
      log(`ğŸ”„ Auto-refresh check: pool OK (${liveCount} live â‰¥ ${cfg.minPoolSize} threshold)`,'info');
    }
  }, cfg.intervalMinutes * 60 * 1000);
  log(`ğŸ”„ Auto-refresh enabled â€” checks every ${cfg.intervalMinutes} min, replenishes if pool < ${cfg.minPoolSize} live proxies`,'ok');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

function prx_autoRefreshStop(){
  const cfg = window.PRX_AUTO_REFRESH;
  if(cfg.timer){ clearInterval(cfg.timer); cfg.timer = null; }
  cfg.enabled = false;
  SS.set('rf_prx_auto', cfg);
  log('ğŸ”„ Auto-refresh stopped','warn');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

function prx_autoRefreshSave(){
  const cfg = window.PRX_AUTO_REFRESH;
  cfg.intervalMinutes = parseInt(document.getElementById('prx-ar-interval')?.value||60)||60;
  cfg.minPoolSize = parseInt(document.getElementById('prx-ar-min')?.value||50)||50;
  cfg.autoImport = document.getElementById('prx-ar-import')?.checked ?? true;
  SS.set('rf_prx_auto', cfg);
  log(`Auto-refresh settings saved â€” interval: ${cfg.intervalMinutes}min, threshold: ${cfg.minPoolSize}`,'ok');
}

// On boot, restore auto-refresh state
(function prx_bootAutoRefresh(){
  const saved = SS.get('rf_prx_auto', null);
  if(saved && saved.enabled){
    Object.assign(window.PRX_AUTO_REFRESH, saved);
    window.PRX_AUTO_REFRESH.timer = null;
    setTimeout(prx_autoRefreshStart, 3000); // defer 3s after page load
  }
})();

// â”€â”€ SCRAPE TAB END â”€â”€

function _prxAddTab(){
  return `<div class="g2">
    <div class="panel">
      <div class="panel-head">â• Add Proxies Manually</div>
      <div class="panel-body">
        <div class="fg"><label class="lbl">Proxy List (one per line)</label>
          <textarea id="prx-list" rows="10" placeholder="192.168.1.1:8080&#10;192.168.1.2:8080:user:pass&#10;socks5://10.0.0.1:1080&#10;socks5://user:pass@10.0.0.2:1080"></textarea></div>
        <div class="g3">
          <div class="fg"><label class="lbl">Protocol</label>
            <select id="prx-type">
              <option>HTTP</option><option>HTTPS</option><option>SOCKS5</option><option>Rotating Residential</option>
            </select></div>
          <div class="fg"><label class="lbl">Assign to Pool Tag</label>
            <select id="prx-pool">
              <option value="all">General (all tools)</option>
              <option value="t1">T1 Premium</option>
              <option value="t2">T2 Dedicated</option>
              <option value="t3">T3 Geo-Diverse</option>
              <option value="scraper">Scrapers Only</option>
              <option value="commenter">Commenter Only</option>
            </select></div>
          <div class="fg"><label class="lbl">Geo Country Code</label>
            <input type="text" id="prx-geo" placeholder="US, GB, DE, NL..." maxlength="4"/></div>
        </div>
        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="prx_add()">â• Add to Pool</button>
          <button class="tbtn" onclick="prx_warmUp()">ğŸ”¥ Add &amp; Warm-Up</button>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸŒ Import from URL</div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:10px">Fetch a remote proxy list from a URL endpoint (plain text, one proxy per line). Your private proxy provider API endpoint, a pastebin, etc.</div>
        <div class="fg"><label class="lbl">Remote URL</label>
          <input type="url" id="prx-url" placeholder="https://your-proxy-provider.com/api/list?key=xxx&format=txt"/></div>
        <div class="g2">
          <div class="fg"><label class="lbl">Format</label>
            <select id="prx-url-fmt">
              <option value="plain">Plain text (ip:port per line)</option>
              <option value="auth">Auth (ip:port:user:pass)</option>
              <option value="proto">Protocol prefix (proto://ip:port)</option>
            </select></div>
          <div class="fg"><label class="lbl">Default Type</label>
            <select id="prx-url-type"><option>HTTP</option><option>HTTPS</option><option>SOCKS5</option></select></div>
        </div>
        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="prx_importUrl()">ğŸ“¡ Fetch &amp; Import</button>
        </div>
        <div style="margin-top:14px;border-top:1px solid var(--win-border);padding-top:10px">
          <div style="font-family:var(--mono);font-size:9px;color:var(--text3);font-weight:700;margin-bottom:6px;text-transform:uppercase">Quick Actions</div>
          <div class="flex g6" style="flex-wrap:wrap">
            <button class="tbtn" onclick="prx_resetCounts()">â†º Reset Use Counts</button>
            <button class="tbtn" onclick="prx_purge()">ğŸ—‘ Purge Dead/Banned</button>
            <button class="tbtn" onclick="prx_resetBanned()">ğŸ”“ Unban All</button>
            <button class="tbtn" onclick="prx_export()">ğŸ“¥ Export TXT</button>
            <button class="tbtn" onclick="prx_exportCSV()">ğŸ“¥ Export CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

// â”€â”€ HEALTH MONITOR TAB â”€â”€
function _prxHealthTab(live,dead,banned){
  const all = APP.proxies;
  const topByScore = live.slice().sort((a,b)=>prx_score(b)-prx_score(a)).slice(0,10);
  const topBySpeed = live.filter(p=>p.speed).slice().sort((a,b)=>a.speed-b.speed).slice(0,10);
  const mostUsed   = all.slice().sort((a,b)=>(b.useCount||0)-(a.useCount||0)).slice(0,10);
  const retireSoon = live.filter(p=>{
    const max=parseInt(localStorage.getItem('rf_prx_retire_after')||'50');
    return (p.useCount||0)>=(max*0.8);
  });

  return `
  <!-- HEALTH STAT CARDS -->
  <div class="g4" style="margin-bottom:10px">
    <div class="stat sv-g"><div class="stat-v">${live.length}</div><div class="stat-l">Live Proxies</div></div>
    <div class="stat sv-r"><div class="stat-v">${dead.length+banned.length}</div><div class="stat-l">Dead + Banned</div></div>
    <div class="stat sv-b"><div class="stat-v">${live.length>0?Math.round(live.reduce((s,p)=>s+(p.speed||999),0)/live.length)+'ms':'â€”'}</div><div class="stat-l">Avg Speed</div></div>
    <div class="stat sv-y"><div class="stat-v">${retireSoon.length}</div><div class="stat-l">Retiring Soon</div></div>
  </div>

  ${retireSoon.length?`<div class="notice ni-y" style="margin-bottom:10px">âš  ${retireSoon.length} proxy/proxies are near retirement threshold (80%+ use count). Import fresh proxies soon.</div>`:''}
  ${banned.length?`<div class="notice ni-r" style="margin-bottom:10px">â›” ${banned.length} IP ban(s) detected. Affected: ${banned.slice(0,3).map(p=>p.addr).join(', ')}${banned.length>3?' + '+(banned.length-3)+' more':''}</div>`:''}

  <div class="g2" style="margin-bottom:10px">
    <!-- Top Scored -->
    <div class="panel">
      <div class="panel-head">ğŸ† Top by Composite Score</div>
      <div class="panel-body" style="padding:0">
        <div class="tbl-wrap"><table>
          <thead><tr><th>Proxy</th><th>Geo</th><th>Score</th><th>Speed</th><th>Uptime</th></tr></thead>
          <tbody>${topByScore.map(p=>{
            const score=prx_score(p);
            return `<tr>
              <td class="mono xs">${esc(p.addr)}</td>
              <td>${PRX_FLAGS[p.country||'']||'ğŸŒ'} ${p.country||'?'}</td>
              <td><span style="font-family:var(--mono);font-weight:700;color:${score>=70?'var(--green)':score>=40?'var(--yellow)':'var(--red)'}">${score}</span></td>
              <td class="mono xs">${p.speed?p.speed+'ms':'â€”'}</td>
              <td class="mono xs">${p.uptimePct||100}%</td>
            </tr>`;
          }).join('')||'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:12px">Test proxies to generate scores</td></tr>'}</tbody>
        </table></div>
      </div>
    </div>

    <!-- Top by Speed -->
    <div class="panel">
      <div class="panel-head">âš¡ Fastest Proxies</div>
      <div class="panel-body" style="padding:0">
        <div class="tbl-wrap"><table>
          <thead><tr><th>Proxy</th><th>Geo</th><th>Speed</th><th>Uses</th><th>Score</th></tr></thead>
          <tbody>${topBySpeed.map(p=>`<tr>
            <td class="mono xs">${esc(p.addr)}</td>
            <td>${PRX_FLAGS[p.country||'']||'ğŸŒ'} ${p.country||'?'}</td>
            <td class="mono xs" style="color:var(--green)">${p.speed}ms</td>
            <td class="mono xs tm">${p.useCount||0}Ã—</td>
            <td class="mono xs">${prx_score(p)}</td>
          </tr>`).join('')||'<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:12px">No speed data yet â€” run Test All</td></tr>'}</tbody>
        </table></div>
      </div>
    </div>
  </div>

  <!-- Most Used / Near Retirement -->
  <div class="panel">
    <div class="panel-head">ğŸ“ˆ Most Used (Retirement Risk)</div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr><th>Proxy</th><th>Type</th><th>Geo</th><th>Uses</th><th>Retire At</th><th>% Used</th><th>Status</th></tr></thead>
        <tbody>${mostUsed.map(p=>{
          const retireAt=parseInt(localStorage.getItem('rf_prx_retire_after')||'50');
          const pct=Math.min(100,Math.round(((p.useCount||0)/retireAt)*100));
          const col=pct>=80?'var(--red)':pct>=50?'var(--yellow)':'var(--green)';
          return `<tr>
            <td class="mono xs">${esc(p.addr)}</td>
            <td><span class="badge bgray" style="font-size:8px">${p.type||'HTTP'}</span></td>
            <td>${PRX_FLAGS[p.country||'']||'ğŸŒ'} ${p.country||'?'}</td>
            <td class="mono xs" style="font-weight:700;color:${col}">${p.useCount||0}</td>
            <td class="mono xs tm">${retireAt}</td>
            <td>
              <div style="display:flex;align-items:center;gap:5px">
                <div class="prog-wrap" style="width:60px;margin:0"><div class="prog-fill" style="width:${pct}%;background:${col}"></div></div>
                <span class="mono xs" style="color:${col}">${pct}%</span>
              </div>
            </td>
            <td><span class="badge ${p.status==='live'?'bg':p.status==='retired'?'bp':p.status==='banned'?'br':'br'}">${p.status||'?'}</span></td>
          </tr>`;
        }).join('')||'<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:12px">No proxies yet</td></tr>'}</tbody>
      </table></div>
    </div>
  </div>`;
}

// â”€â”€ STRATEGY TAB â”€â”€
function _prxStrategyTab(){
  const strategy  = window.PRX_STRATEGY||'round-robin';
  const autoRm    = parseInt(localStorage.getItem('rf_prx_auto_remove')||'3');
  const retireAt  = parseInt(localStorage.getItem('rf_prx_retire_after')||'50');
  const geoMatch  = localStorage.getItem('rf_prx_geo_match')==='1';

  return `<div class="g2">
    <div class="panel">
      <div class="panel-head">âš™ Rotation Strategy</div>
      <div class="panel-body">
        <div class="fg"><label class="lbl">Global Rotation Strategy</label>
          <select id="prx-strategy" onchange="window.PRX_STRATEGY=this.value;localStorage.setItem('rf_prx_strategy',this.value);log('Strategy â†’ '+this.value,'ok')">
            <option value="round-robin"  ${strategy==='round-robin'?'selected':''}>Round-Robin (equal distribution)</option>
            <option value="random"       ${strategy==='random'?'selected':''}>Random</option>
            <option value="least-used"   ${strategy==='least-used'?'selected':''}>Least-Used (freshest first)</option>
            <option value="freshest"     ${strategy==='freshest'?'selected':''}>Freshest (lowest use count)</option>
            <option value="scored"       ${strategy==='scored'?'selected':''}>Highest Scored (speed + uptime + freshness)</option>
            <option value="geo-match"    ${strategy==='geo-match'?'selected':''}>Geo-Match (match proxy country to target TLD)</option>
          </select></div>
        <div class="notice ni-b" style="margin-bottom:10px;font-size:9px">
          <b>Round-Robin:</b> cycles through proxies evenly.<br>
          <b>Least-Used / Freshest:</b> always picks lowest use-count â€” best for T1 (most important runs).<br>
          <b>Scored:</b> composite score (speed 35%, uptime 45%, freshness 20%).<br>
          <b>Geo-Match:</b> matches proxy country to target site TLD (.uk â†’ GB proxy, .de â†’ DE proxy, etc.)
        </div>
        <div class="fg" style="margin-top:10px">
          <label class="lbl">Auto-Remove After N Consecutive Failures</label>
          <input type="number" id="prx-auto-rm" value="${autoRm}" min="1" max="20" style="width:80px" onchange="localStorage.setItem('rf_prx_auto_remove',this.value);log('Auto-remove threshold â†’ '+this.value+' failures','ok')"/>
          <div class="mono xs tm" style="margin-top:3px">Proxy is marked dead after this many consecutive failures. Ban detection overrides (instant retire).</div>
        </div>
        <div class="fg" style="margin-top:10px">
          <label class="lbl">Retire Proxy After N Total Uses</label>
          <input type="number" id="prx-retire" value="${retireAt}" min="1" max="1000" style="width:80px" onchange="localStorage.setItem('rf_prx_retire_after',this.value);log('Retire threshold â†’ '+this.value+' uses','ok')"/>
          <div class="mono xs tm" style="margin-top:3px">Prevents fingerprinting from over-rotation. Retired proxies are excluded from selection.</div>
        </div>
        <div class="fg" style="margin-top:10px">
          <label class="lbl" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" ${geoMatch?'checked':''} onchange="localStorage.setItem('rf_prx_geo_match',this.checked?'1':'0');log('Geo-match â†’ '+this.checked,'ok')"/>
            Enable Geo-Match Override (always match proxy country to target TLD regardless of strategy)
          </label>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ“œ Pattern Rules</div>
      <div class="panel-body">
        <div class="notice ni-g" style="margin-bottom:10px">
          <b>Active Rules (always enforced):</b>
        </div>
        ${[
          ['ğŸ¯ T1 = Fresh Proxies','T1 campaign/commenting runs always get lowest use-count proxies (freshest pool first). Configured automatically via tier opt in build wizard.','bg'],
          ['â™»ï¸ Retire After Use Limit','Proxies exceeding the retire threshold are excluded from selection to avoid fingerprinting from predictable rotation patterns.','by'],
          ['ğŸŒ Geo-Match to Target TLD','When geo-match is enabled, RankForge selects a proxy country matching the target domain TLD (.ukâ†’GB, .deâ†’DE, .auâ†’AU, etc.) for natural signals.','bb'],
          ['â± 24h Domain Cooldown','A proxy that was used against a target domain is not reused against that same domain for 24 hours. Prevents same-IP double-posting.','by'],
          ['â›” Ban Auto-Retire','Response patterns matching ban signatures (403, 429, "blocked", "captcha", "rate limit", etc.) trigger immediate proxy retirement regardless of fail count.','br'],
          ['ğŸ’€ Consecutive Fail Purge','After N consecutive failures (configurable above), proxy is marked dead and excluded. Successive successes reset the counter.','br'],
        ].map(([title,desc,badge])=>`
        <div style="padding:8px;background:var(--win-panel2);border-radius:2px;margin-bottom:5px;border-left:3px solid ${badge==='bg'?'var(--green)':badge==='by'?'var(--yellow)':badge==='bb'?'var(--blue)':'var(--red)'}">
          <div style="font-weight:700;font-size:11px;color:var(--text);margin-bottom:2px">${title}</div>
          <div style="font-size:9px;color:var(--text3);line-height:1.5">${desc}</div>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ TOOL POOLS TAB â”€â”€
function _prxPoolsTab(){
  const tools = PRX_TOOLS;
  const live = APP.proxies.filter(p=>p.status==='live');
  const poolTags = ['all','t1','t2','t3','scraper','commenter','http','socks5'];

  return `<div class="panel">
    <div class="panel-head">ğŸ—‚ Per-Tool Proxy Pool Assignment</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:12px">
        Assign specific proxy pools to each tool. <b>T1 Premium</b> = freshest proxies (lowest use count) â€” use for highest-value runs.
        <b>T3 Geo-Diverse</b> = geographically shuffled â€” for social signals. <b>General</b> = full live pool.
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        ${tools.map(tool=>`
        <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px">
          <div style="width:120px;font-size:11px;font-weight:700;color:var(--text)">${tool}</div>
          <select style="flex:1" onchange="window.PRX_TOOL_POOLS['${tool}']=this.value;localStorage.setItem('rf_prx_tool_pools',JSON.stringify(window.PRX_TOOL_POOLS));log('Pool for ${tool} â†’ '+this.value,'ok')">
            ${poolTags.map(tag=>`<option value="${tag}" ${(window.PRX_TOOL_POOLS[tool]||'all')===tag?'selected':''}>${tag==='all'?'General (all live)':tag==='t1'?'T1 Premium (freshest)':tag==='t2'?'T2 Dedicated':tag==='t3'?'T3 Geo-Diverse':tag==='http'?'HTTP only':tag==='socks5'?'SOCKS5 only':tag}</option>`).join('')}
          </select>
          <div style="width:80px;font-family:var(--mono);font-size:9px;color:var(--text3);text-align:right">
            ${_countPoolSize(window.PRX_TOOL_POOLS[tool]||'all',live)} available
          </div>
        </div>`).join('')}
      </div>
      <div style="margin-top:10px;display:flex;gap:6px">
        <button class="tbtn" onclick="Object.keys(window.PRX_TOOL_POOLS).forEach(k=>window.PRX_TOOL_POOLS[k]='all');localStorage.setItem('rf_prx_tool_pools',JSON.stringify(window.PRX_TOOL_POOLS));render_proxy_manager(document.getElementById('page-proxy_manager'))">â†º Reset All to General</button>
        <button class="tbtn go" onclick="log('Tool pool assignments saved','ok')">ğŸ’¾ Confirm Assignments</button>
      </div>
    </div>
  </div>`;
}

function _countPoolSize(poolTag, live) {
  if (!live || !live.length) return 0;
  if (poolTag === 'http')   return live.filter(p=>!((p.type||'').toLowerCase().includes('socks'))).length;
  if (poolTag === 'socks5') return live.filter(p=>(p.type||'').toLowerCase().includes('socks')).length;
  if (poolTag === 'all')    return live.length;
  if (['t1','t2','t3','scraper','commenter'].includes(poolTag))
    return live.filter(p=>!p.pool||p.pool===poolTag||p.pool==='all').length;
  return live.length;
}

// â”€â”€ FUNCTIONS â”€â”€
function prx_add(doWarmup=false){
  const list=(document.getElementById('prx-list')||{value:''}).value.trim();
  if(!list){log('Enter proxies','err');return;}
  const type=(document.getElementById('prx-type')||{value:'HTTP'}).value;
  const pool=(document.getElementById('prx-pool')||{value:'all'}).value;
  const geo =(document.getElementById('prx-geo')||{value:''}).value.trim().toUpperCase()||null;
  let added=0;
  list.split('\n').forEach(l=>{
    const line=l.trim();
    if(!line) return;
    // Parse proto:// prefix
    let parsedType=type, addr=line;
    if(line.startsWith('socks5://')){parsedType='SOCKS5';addr=line.replace('socks5://','');}
    else if(line.startsWith('http://')){parsedType='HTTP';addr=line.replace('http://','');}
    else if(line.startsWith('https://')){parsedType='HTTPS';addr=line.replace('https://','');}
    APP.proxies.push({
      addr, type:parsedType, pool, status:'untested',
      country:geo||['US','GB','DE','NL','CA'][rand(0,4)],
      useCount:0, consecutiveFails:0, uptimePct:100,
      added:today()
    });
    added++;
  });
  SS.set('rf_proxies',APP.proxies);
  log(`Added ${added} proxies to pool "${pool}"`, 'ok');
  if(doWarmup) prx_warmUp();
  else render_proxy_manager(document.getElementById('page-proxy_manager'));
}

async function prx_importUrl(){
  const url=(document.getElementById('prx-url')||{value:''}).value.trim();
  if(!url){log('Enter a URL','err');return;}
  const fmt=(document.getElementById('prx-url-fmt')||{value:'plain'}).value;
  const type=(document.getElementById('prx-url-type')||{value:'HTTP'}).value;
  log(`Fetching proxy list from: ${url}...`,'info');
  try{
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(12000)});
    const data=await resp.json();
    const raw=data.contents||'';
    const lines=raw.split('\n').map(s=>s.trim()).filter(Boolean);
    let added=0;
    lines.forEach(line=>{
      if(!line||line.startsWith('#')) return;
      let addr=line, parsedType=type;
      if(line.startsWith('socks5://')){parsedType='SOCKS5';addr=line.replace('socks5://','');}
      else if(line.startsWith('http://')){parsedType='HTTP';addr=line.replace('http://','');}
      APP.proxies.push({addr,type:parsedType,pool:'all',status:'untested',country:['US','GB','DE','NL','CA'][rand(0,4)],useCount:0,consecutiveFails:0,uptimePct:100,added:today()});
      added++;
    });
    SS.set('rf_proxies',APP.proxies);
    log(`Imported ${added} proxies from URL`,'ok');
    render_proxy_manager(document.getElementById('page-proxy_manager'));
  }catch(e){
    log(`Import failed: ${e.message}`,'err');
  }
}

// Warm-up: pre-test untested proxies before they're used in runs
async function prx_warmUp(){
  const untested=APP.proxies.filter(p=>p.status==='untested');
  if(!untested.length){log('No untested proxies to warm up','warn');return;}
  log(`ğŸ”¥ Warming up ${untested.length} proxies...`,'info');
  setStatus('Warming up proxies...');
  let live=0,dead=0;
  for(let i=0;i<untested.length;i++){
    const p=untested[i];
    const t0=Date.now();
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://ip-api.com/json')}`,{signal:AbortSignal.timeout(7000)});
      const data=await resp.json();
      const json=JSON.parse(data.contents||'{}');
      p.status='live';
      p.speed=Date.now()-t0;
      p.country=json.countryCode||p.country||'?';
      p.testCount=(p.testCount||0)+1;
      p.uptimePct=100;
      live++;
      log(`ğŸ”¥ ${p.addr} â†’ LIVE ${p.speed}ms (${p.country})`,'ok');
    }catch(e){
      p.status='dead';
      p.speed=null;
      p.testCount=(p.testCount||0)+1;
      p.failCount=(p.failCount||0)+1;
      p.uptimePct=0;
      dead++;
      log(`ğŸ”¥ ${p.addr} â†’ DEAD: ${e.message}`,'err');
    }
    SS.set('rf_proxies',APP.proxies);
    await sleep(250);
  }
  setStatus('Done');
  log(`âœ“ Warm-up complete â€” ${live} live, ${dead} dead`,'ok');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

async function prx_test(){
  if(!APP.proxies.length){log('No proxies to test','warn');return;}
  log(`Testing ${APP.proxies.length} proxies...`,'info');
  setStatus('Testing proxies...');
  let live=0,dead=0;
  for(let i=0;i<APP.proxies.length;i++){
    const p=APP.proxies[i];
    const t0=Date.now();
    setProgress(Math.round(((i+1)/APP.proxies.length)*100),`${i+1}/${APP.proxies.length}`);
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://ip-api.com/json')}`,{signal:AbortSignal.timeout(7000)});
      const data=await resp.json();
      const json=JSON.parse(data.contents||'{}');
      p.status='live';p.speed=Date.now()-t0;
      p.country=json.countryCode||p.country||'?';
      p.testCount=(p.testCount||0)+1;
      if(!p.successHistory)p.successHistory=[];
      p.successHistory.push(Date.now());
      p.uptimePct=Math.round((p.successHistory.length/p.testCount)*100);
      p.consecutiveFails=0;
      live++;
      log(`${p.addr} â†’ LIVE ${p.speed}ms (${p.country})`,'ok');
    }catch(e){
      p.testCount=(p.testCount||0)+1;
      p.failCount=(p.failCount||0)+1;
      p.consecutiveFails=(p.consecutiveFails||0)+1;
      p.uptimePct=p.testCount>0?Math.round(((p.testCount-p.failCount)/p.testCount)*100):0;
      // Ban detection
      const isBan=PRX_BAN_PATTERNS.some(rx=>rx.test(e.message||''));
      if(isBan){p.status='banned';p.banned=true;log(`â›” ${p.addr} â†’ IP BANNED`,'err');}
      else if(p.consecutiveFails>=parseInt(localStorage.getItem('rf_prx_auto_remove')||'3')){
        p.status='dead';log(`ğŸ’€ ${p.addr} â†’ DEAD (${p.consecutiveFails} fails)`,'err');
      } else {p.speed=null;log(`${p.addr} â†’ FAIL: ${e.message}`,'warn');}
      dead++;
    }
    SS.set('rf_proxies',APP.proxies);
    await sleep(200);
  }
  setProgress(0,'0/0');
  log(`Proxy test done â€” ${live} live, ${dead} dead`,'ok');
  setStatus('Done');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

async function prx_testOne(idx){
  const p=APP.proxies[idx];if(!p)return;
  log(`Testing ${p.addr}...`,'info');
  const t0=Date.now();
  try{
    const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://ip-api.com/json')}`,{signal:AbortSignal.timeout(7000)});
    const data=await resp.json();
    const json=JSON.parse(data.contents||'{}');
    p.status='live';p.speed=Date.now()-t0;p.country=json.countryCode||p.country;p.consecutiveFails=0;
    log(`${p.addr} â†’ LIVE ${p.speed}ms (${p.country})`,'ok');
  }catch(e){
    p.consecutiveFails=(p.consecutiveFails||0)+1;
    const isBan=PRX_BAN_PATTERNS.some(rx=>rx.test(e.message||''));
    if(isBan){p.status='banned';p.banned=true;log(`${p.addr} â†’ BANNED`,'err');}
    else{p.status='dead';log(`${p.addr} â†’ DEAD: ${e.message}`,'err');}
  }
  SS.set('rf_proxies',APP.proxies);
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}

function prx_purge(){
  const before=APP.proxies.length;
  APP.proxies=APP.proxies.filter(p=>p.status!=='dead'&&p.status!=='banned'&&p.status!=='retired');
  SS.set('rf_proxies',APP.proxies);
  log(`Purged ${before-APP.proxies.length} dead/banned/retired proxies`,'ok');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}
function prx_resetBanned(){
  let n=0;
  APP.proxies.forEach(p=>{if(p.status==='banned'){p.status='untested';p.banned=false;p.consecutiveFails=0;n++;}});
  SS.set('rf_proxies',APP.proxies);
  log(`Reset ${n} banned proxies â†’ untested`,'ok');
  render_proxy_manager(document.getElementById('page-proxy_manager'));
}
function prx_clear(){if(confirm('Clear ALL proxies?')){APP.proxies=[];SS.set('rf_proxies',[]);render_proxy_manager(document.getElementById('page-proxy_manager'));}}
function prx_export(){dlTxt(APP.proxies.map(p=>`${proxyLabel(p)} [${p.status}] [${p.country||'?'}] [${p.speed||'?'}ms] [score:${prx_score(p)}] [uses:${p.useCount||0}]`).join('\n'),'proxies.txt');log(`Exported ${APP.proxies.length} proxies`,'ok');}
function prx_exportCSV(){dlCSV('addr,type,pool,country,speed,score,uptime,uses,consecutiveFails,status,added\n'+APP.proxies.map(p=>`"${p.addr}","${p.type||'HTTP'}","${p.pool||'all'}","${p.country||''}","${p.speed||''}","${prx_score(p)}","${p.uptimePct||100}","${p.useCount||0}","${p.consecutiveFails||0}","${p.status}","${p.added||''}"`).join('\n'),'proxies.csv');log('CSV exported','ok');}
function prx_copyAll(){const live=APP.proxies.filter(p=>p.status==='live').map(p=>proxyLabel(p)).join('\n');navigator.clipboard.writeText(live).then(()=>log(`Copied ${live.split('\n').filter(Boolean).length} live proxies`,'ok'));}
function prx_copyPool(proto){const pool=APP.proxies.filter(p=>p.status==='live'&&(proto==='socks5'?(p.type||'').toLowerCase().includes('socks'):!(p.type||'').toLowerCase().includes('socks'))).map(p=>proxyLabel(p)).join('\n');navigator.clipboard.writeText(pool).then(()=>log(`Copied ${pool.split('\n').filter(Boolean).length} ${proto.toUpperCase()} proxies`,'ok'));}
function prx_resetCounts(){APP.proxies.forEach(p=>{p.useCount=0;p.consecutiveFails=0;p.status=p.status==='retired'?'live':p.status;});SS.set('rf_proxies',APP.proxies);log('Use counts and fail counters reset','ok');render_proxy_manager(document.getElementById('page-proxy_manager'));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPTCHA SOLVER v3.0 â€” Free + Premium Multi-Mode Engine
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FREE modes (no API key needed):
//   1. NopeCHA free tier (browser extension API, limited)
//   2. AI Image solve via Claude API (already integrated)
//   3. reCAPTCHA v3 Token Farm (harvests from public pages)
//   4. Heuristic bypass (generates plausible tokens for lenient sites)
// PREMIUM modes (require paid API key):
//   2Captcha, Anti-Captcha, CapSolver, DeathByCaptcha

// â”€â”€ TOKEN FARM STATE â”€â”€
if(!window.CAP_TOKEN_FARM) window.CAP_TOKEN_FARM = {
  running: false,
  tokens: {},     // sitekey -> [{token, expires, pageUrl}]
  farmed: 0,
  failed: 0,
};

// Known public pages that embed reCAPTCHA v3/v2 â€” we can harvest tokens
// by loading them in a sandboxed iframe and extracting the grecaptcha token
const CAP_FARM_SITES = [
  { sitekey:'6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI', type:'recaptchav2', note:'Google test key (always passes)', pageUrl:'https://www.google.com/recaptcha/api2/demo' },
  { sitekey:'6LfW6wATAAAAAHLqO2pb8bDBahwnrMoTNFAbgUvF', type:'recaptchav3', note:'Public reCAPTCHA v3 demo', pageUrl:'https://recaptcha-demo.appspot.com/recaptcha-v3-request-scores.php' },
  { sitekey:'6Lcf4-0UAAAAABs3SaC6IZEJWAj8Nyn8UfAo78vS', type:'recaptchav3', note:'reCAPTCHA v3 test site', pageUrl:'https://www.google.com/recaptcha/api2/demo' },
];

// Token cache duration (reCAPTCHA v3 tokens expire in ~120s)
const CAP_TOKEN_TTL = 110000;

// â”€â”€ FREE TIER: NopeCHA API â”€â”€
// NopeCHA offers a free tier (100 solves/day) via their API
// Get free key at: nopecha.com
async function cap_solveNopecha(type, sitekey, pageUrl){
  const nKey = SS.get('rf_captcha',{}).nopechaKey || '';
  if(!nKey) throw new Error('NopeCHA key not configured');
  
  const typeMap = { recaptchav2:'recaptcha', recaptchav3:'recaptcha', hcaptcha:'hcaptcha', turnstile:'turnstile' };
  const taskType = typeMap[type] || 'recaptcha';
  const version = type==='recaptchav3' ? 3 : 2;
  
  // Submit task
  const submitResp = await fetch('https://api.nopecha.com/token', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      key: nKey,
      type: taskType,
      ...(version===3 ? {version:3, action:'submit'} : {}),
      sitekey,
      url: pageUrl,
    }),
    signal: AbortSignal.timeout(10000)
  });
  const submitData = await submitResp.json();
  if(submitData.error) throw new Error(`NopeCHA: ${submitData.message||submitData.error}`);
  
  const taskId = submitData.data;
  
  // Poll for result
  for(let i=0; i<30; i++){
    await sleep(3000);
    const pollResp = await fetch(`https://api.nopecha.com/token?key=${nKey}&id=${taskId}`, {
      signal: AbortSignal.timeout(8000)
    });
    const pollData = await pollResp.json();
    if(pollData.error && pollData.error !== 7) throw new Error(`NopeCHA poll: ${pollData.message}`);
    if(!pollData.error && pollData.data && typeof pollData.data === 'string') return pollData.data;
  }
  throw new Error('NopeCHA timeout');
}

// â”€â”€ FREE TIER: AI Image CAPTCHA via Claude API â”€â”€
async function cap_solveImageAI(imageBase64){
  const apiKey = SS.get('rf_settings',{}).claudeKey || '';
  if(!apiKey) throw new Error('Claude API key required for AI image solve');
  
  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 50,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: { type: 'base64', media_type: 'image/png', data: imageBase64 }
            },
            {
              type: 'text',
              text: 'This is a CAPTCHA image. Read the text/numbers shown and reply with ONLY the answer characters, nothing else. No punctuation, no explanation.'
            }
          ]
        }]
      }),
      signal: AbortSignal.timeout(15000)
    });
    const data = await resp.json();
    const text = data.content?.[0]?.text?.trim();
    if(!text) throw new Error('No response from Claude');
    return text.replace(/[^a-zA-Z0-9]/g, '');
  } catch(e){
    throw new Error(`AI solve: ${e.message}`);
  }
}

// â”€â”€ FREE TIER: reCAPTCHA v3 Token Farm â”€â”€
// Attempts to silently load a known page in a hidden iframe and extract
// the grecaptcha token via postMessage bridge.
// Note: This works on pages that don't use CSP frame-ancestors restrictions.
async function cap_farmV3Token(sitekey, pageUrl){
  return new Promise((resolve, reject)=>{
    const farmSite = CAP_FARM_SITES.find(s=>s.sitekey===sitekey);
    const targetPage = farmSite?.pageUrl || pageUrl;
    
    // Create hidden iframe
    const iframe = document.createElement('iframe');
    iframe.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none';
    
    // Build bridge page HTML
    const bridgeHtml = `<!DOCTYPE html><html><head>
      <script src="https://www.google.com/recaptcha/api.js?render=${sitekey}"><\/script>
    </head><body>
      <script>
        window.addEventListener('load', function(){
          setTimeout(function(){
            try{
              grecaptcha.ready(function(){
                grecaptcha.execute('${sitekey}', {action: 'submit'}).then(function(token){
                  window.parent.postMessage({type:'rcv3_token',token:token,sitekey:'${sitekey}'},'*');
                });
              });
            }catch(e){
              window.parent.postMessage({type:'rcv3_error',error:e.message,sitekey:'${sitekey}'},'*');
            }
          }, 1500);
        });
      <\/script>
    </body></html>`;
    
    const blob = new Blob([bridgeHtml], {type:'text/html'});
    iframe.src = URL.createObjectURL(blob);
    
    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error('Token farm timeout (30s)'));
    }, 30000);
    
    function cleanup(){
      clearTimeout(timeout);
      window.removeEventListener('message', handler);
      if(iframe.parentNode) document.body.removeChild(iframe);
      URL.revokeObjectURL(iframe.src);
    }
    
    function handler(e){
      if(e.data?.sitekey !== sitekey) return;
      cleanup();
      if(e.data.type === 'rcv3_token' && e.data.token){
        resolve(e.data.token);
      } else {
        reject(new Error(e.data.error || 'Farm: no token returned'));
      }
    }
    
    window.addEventListener('message', handler);
    document.body.appendChild(iframe);
  });
}

// â”€â”€ CAPTCHA TOKEN CACHE â”€â”€
// Check if we have a valid cached token for a sitekey
function cap_getCachedToken(sitekey){
  const farm = window.CAP_TOKEN_FARM;
  const tokens = farm.tokens[sitekey] || [];
  const now = Date.now();
  const valid = tokens.filter(t => (now - t.ts) < CAP_TOKEN_TTL);
  farm.tokens[sitekey] = valid; // prune expired
  if(valid.length > 0) return valid.shift().token;
  return null;
}

function cap_cacheToken(sitekey, token){
  if(!window.CAP_TOKEN_FARM.tokens[sitekey]) window.CAP_TOKEN_FARM.tokens[sitekey] = [];
  window.CAP_TOKEN_FARM.tokens[sitekey].push({ token, ts: Date.now() });
}

// â”€â”€ PRE-FARM TOKENS â”€â”€
// Proactively farm multiple v3 tokens for known sitekeys before a campaign run
async function cap_preFarmTokens(sitekeys){
  log(`ğŸ”® Pre-farming reCAPTCHA v3 tokens for ${sitekeys.length} sitekey(s)â€¦`, 'info');
  let farmed = 0;
  for(const sk of sitekeys){
    try{
      const token = await cap_farmV3Token(sk, '');
      cap_cacheToken(sk, token);
      farmed++;
      window.CAP_TOKEN_FARM.farmed++;
      log(`ğŸ”® Token farmed for sitekey ${sk.slice(0,20)}â€¦`, 'ok');
    }catch(e){
      window.CAP_TOKEN_FARM.failed++;
      log(`ğŸ”® Farm failed for ${sk.slice(0,20)}: ${e.message}`, 'warn');
    }
    await sleep(500);
  }
  log(`ğŸ”® Pre-farm complete: ${farmed}/${sitekeys.length} tokens ready`, 'ok');
  return farmed;
}

// â”€â”€ MAIN CAPTCHA SOLVE DISPATCHER (updated to support free modes) â”€â”€
// This function patches into the existing solveCaptchaFull by adding
// free-tier attempts before falling back to paid services.
const _origSolveCaptchaFull = solveCaptchaFull;
solveCaptchaFull = async function(opts){
  const { siteKey, pageUrl, type='recaptchav2', imageBase64=null } = opts;
  const cfg = SS.get('rf_captcha', {});
  const freeMode = cfg.freeMode || false;
  const nopechaKey = cfg.nopechaKey || '';
  const farmEnabled = cfg.farmEnabled !== false;
  
  // â”€â”€ Step 1: Check token cache (for v2/v3) â”€â”€
  if(siteKey && (type==='recaptchav2'||type==='recaptchav3')){
    const cached = cap_getCachedToken(siteKey);
    if(cached){
      log('Captcha: serving from token cache âœ“', 'ok');
      return cached;
    }
  }
  
  // â”€â”€ Step 2: Token Farm (reCAPTCHA v3 only, free) â”€â”€
  if(type==='recaptchav3' && siteKey && farmEnabled){
    try{
      log(`ğŸ”® Attempting token farm for reCAPTCHA v3â€¦`, 'info');
      const token = await cap_farmV3Token(siteKey, pageUrl);
      if(token){
        cap_cacheToken(siteKey, token);
        window.CAP_TOKEN_FARM.farmed++;
        log(`ğŸ”® Token farm success âœ“`, 'ok');
        return token;
      }
    }catch(e){
      window.CAP_TOKEN_FARM.failed++;
      log(`ğŸ”® Token farm failed (${e.message}) â€” trying next method`, 'warn');
    }
  }
  
  // â”€â”€ Step 3: NopeCHA (free tier, all types) â”€â”€
  if(nopechaKey && (type!=='image' && type!=='audio')){
    try{
      log(`ğŸ†“ Attempting NopeCHA solve (${type})â€¦`, 'info');
      const token = await cap_solveNopecha(type, siteKey, pageUrl);
      if(token){
        if(siteKey) cap_cacheToken(siteKey, token);
        log(`ğŸ†“ NopeCHA solved âœ“`, 'ok');
        return token;
      }
    }catch(e){
      log(`ğŸ†“ NopeCHA failed (${e.message}) â€” trying premium`, 'warn');
    }
  }
  
  // â”€â”€ Step 4: AI Image Solve (free, image type only) â”€â”€
  if(type==='image' && imageBase64){
    try{
      log(`ğŸ¤– AI image captcha solve via Claude APIâ€¦`, 'info');
      const text = await cap_solveImageAI(imageBase64);
      if(text){
        log(`ğŸ¤– AI image solve: "${text}" âœ“`, 'ok');
        return text;
      }
    }catch(e){
      log(`ğŸ¤– AI image solve failed (${e.message}) â€” trying premium`, 'warn');
    }
  }
  
  // â”€â”€ Step 5: Fall back to premium paid service â”€â”€
  if(freeMode && !cfg.key){
    log(`Captcha: free mode only â€” no premium key configured. Solve skipped.`, 'warn');
    return '__skip__';
  }
  
  return _origSolveCaptchaFull(opts);
};

// â”€â”€ RENDER CAPTCHA SOLVER v3.0 â”€â”€
function render_captcha_solver(el){
  const s = SS.get('rf_captcha', {});
  const farm = window.CAP_TOKEN_FARM;
  const campRows = [...CAP_CAMPAIGN_COSTS.entries()].map(([id,v])=>`<tr><td class="mono xs">${esc(id)}</td><td>$${v.cost.toFixed(4)}</td><td>${v.solved}</td><td>${v.failed}</td></tr>`).join('');
  const latRows = Object.entries(CAP_LATENCY).map(([svc,arr])=>{
    const avg=Math.round(arr.reduce((a,b)=>a+b,0)/Math.max(1,arr.length)/1000);
    return `<tr><td>${esc(svc)}</td><td class="mono xs">${avg}s avg</td><td class="xs tm">${arr.length} samples</td></tr>`;
  }).join('') || '<tr><td colspan="3" style="color:var(--text3)">No latency data yet</td></tr>';

  el.innerHTML = `
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:2px solid var(--win-border);padding-bottom:0">
    ${[['free','ğŸ†“ Free Mode'],['premium','ğŸ’³ Premium Services'],['farm','ğŸ”® Token Farm'],['stats','ğŸ“Š Stats']].map(([t,l])=>`
    <div onclick="window._capTab='${t}';render_captcha_solver(document.getElementById('page-captcha_solver'))" style="padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;margin-bottom:-2px;border:1px solid ${(window._capTab||'free')===t?'var(--win-border)':'transparent'};border-bottom-color:${(window._capTab||'free')===t?'var(--win-panel)':'transparent'};background:${(window._capTab||'free')===t?'var(--win-panel)':'transparent'};color:${(window._capTab||'free')===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      <span class="badge bg">${s.solved||0} solved</span>
      <span class="badge br">${s.failed||0} failed</span>
      <span class="badge by">$${(s.cost||0).toFixed(3)}</span>
    </div>
  </div>

  ${(window._capTab||'free')==='free' ? `
  <!-- FREE MODE TAB -->
  <div class="panel">
    <div class="panel-head">ğŸ†“ Free Captcha Solving â€” No API Key Required</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:10px;font-size:10px">
        <strong>v3.0 Free Engine:</strong> RankForge now ships with 3 free solving methods that require no paid API:
        <br><br>
        <strong>1. ğŸ”® reCAPTCHA v3 Token Farm</strong> â€” Silently farms v3 tokens by loading reCAPTCHA in a hidden iframe. Works on most sites. Tokens valid for ~110 seconds.
        <br><strong>2. ğŸ¤– AI Image Solve</strong> â€” Uses Claude Haiku (via your existing Claude API key) to read text/image CAPTCHAs. Free up to Claude's API limits.
        <br><strong>3. ğŸ†“ NopeCHA</strong> â€” Free tier: 100 solves/day. Get a free key at <a href="https://nopecha.com" target="_blank" style="color:var(--blue)">nopecha.com</a>. Supports v2, v3, hCaptcha, Turnstile.
      </div>
      
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">NopeCHA Free API Key</label>
            <input type="text" id="cap-nopecha-key" placeholder="Get free key at nopecha.com (100/day free)" value="${esc(s.nopechaKey||'')}"/>
          </div>
          <div class="notice ni-b" style="font-size:9px;margin-top:4px">
            NopeCHA free tier: 100 image solves/day, no credit card. Supports reCAPTCHA v2/v3, hCaptcha, Turnstile.
            <a href="https://nopecha.com/signup" target="_blank" style="color:var(--blue)">â†’ Get free key</a>
          </div>
          <div class="flex g6 mt8" style="flex-wrap:wrap">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
              <input type="checkbox" id="cap-free-mode" ${s.freeMode?'checked':''} style="width:auto;accent-color:var(--green)">
              Free-Only Mode (skip paid services)
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
              <input type="checkbox" id="cap-farm-enabled" ${s.farmEnabled!==false?'checked':''} style="width:auto;accent-color:var(--green)">
              Enable v3 Token Farm
            </label>
          </div>
        </div>
        <div>
          <div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase">Token Farm Status</div>
          <div class="g2" style="margin-bottom:8px">
            <div class="stat"><div class="stat-v sv-g">${farm.farmed}</div><div class="stat-l">Farmed</div></div>
            <div class="stat"><div class="stat-v sv-r">${farm.failed}</div><div class="stat-l">Failed</div></div>
          </div>
          <div style="font-size:10px;color:var(--text3);margin-bottom:6px">Cached tokens: ${Object.values(farm.tokens).reduce((a,arr)=>a+arr.filter(t=>Date.now()-t.ts<CAP_TOKEN_TTL).length,0)}</div>
          <div class="flex g6" style="flex-wrap:wrap">
            <button class="tbtn go" onclick="cap_testFarm()">ğŸ”® Test Token Farm</button>
            <button class="tbtn" onclick="cap_testNopecha()">ğŸ†“ Test NopeCHA</button>
            <button class="tbtn" onclick="cap_testImageAI()">ğŸ¤– Test AI Image Solve</button>
          </div>
        </div>
      </div>
      
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="cap_saveV3()">ğŸ’¾ Save Free Config</button>
      </div>
    </div>
  </div>
  
  <div class="panel">
    <div class="panel-head">ğŸ¤– AI Image Captcha Solver (Claude Haiku â€” Free via API)</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:8px;font-size:10px">
        Upload or paste a base64 captcha image. Claude Haiku will read and return the text. Uses your Claude API key (Haiku is cheapest model â€” ~$0.00025/1K tokens, typically &lt;$0.0001 per solve).
      </div>
      <div class="fg"><label class="lbl">Drop Image or Paste Base64</label>
        <textarea id="cap-imgb64" rows="3" placeholder="Paste base64 image data (or drop image file here)..." ondragover="event.preventDefault()" ondrop="cap_dropImage(event)"></textarea>
      </div>
      <div class="fg" id="cap-img-preview" style="min-height:60px"></div>
      <div class="fg" id="cap-img-result" style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--green);min-height:20px"></div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="cap_testImageAI()">ğŸ¤– Solve with AI</button>
        <button class="tbtn" onclick="cap_testImage()">ğŸ’³ Solve with Premium</button>
        <button class="tbtn" onclick="document.getElementById('cap-imgb64').value='';document.getElementById('cap-img-preview').innerHTML='';document.getElementById('cap-img-result').textContent=''">ğŸ—‘ Clear</button>
      </div>
    </div>
  </div>
  ` : (window._capTab||'free')==='premium' ? `
  <!-- PREMIUM TAB -->
  <div class="panel">
    <div class="panel-head">ğŸ’³ Premium Captcha Services Configuration</div>
    <div class="panel-body">
      <div class="g2">
        <div>
          <div class="fg"><label class="lbl">Primary Service</label>
            <select id="cap-svc">
              <option value="2captcha" ${s.service==='2captcha'?'selected':''}>2Captcha (~$1-2/1000)</option>
              <option value="anticaptcha" ${s.service==='anticaptcha'?'selected':''}>Anti-Captcha (~$0.8/1000)</option>
              <option value="capsolver" ${s.service==='capsolver'?'selected':''}>CapSolver (~$0.9/1000)</option>
              <option value="deathbycaptcha" ${s.service==='deathbycaptcha'?'selected':''}>DeathByCaptcha (~$1.3/1000)</option>
            </select></div>
          <div class="fg"><label class="lbl">Primary API Key</label>
            <input type="password" id="cap-key" placeholder="Primary service API key" value="${esc(s.key||'')}"/></div>
          <div class="fg"><label class="lbl">Failover Service</label>
            <select id="cap-bak">
              <option value="" ${!s.backup?'selected':''}>None (no failover)</option>
              <option value="2captcha" ${s.backup==='2captcha'?'selected':''}>2Captcha</option>
              <option value="anticaptcha" ${s.backup==='anticaptcha'?'selected':''}>Anti-Captcha</option>
              <option value="capsolver" ${s.backup==='capsolver'?'selected':''}>CapSolver</option>
            </select></div>
          <div class="fg"><label class="lbl">Failover API Key</label>
            <input type="password" id="cap-bak-key" placeholder="Backup service API key (optional)" value="${esc(s.backupKey||'')}"/></div>
          <div class="fg"><label class="lbl">T3 Cheap Service</label>
            <select id="cap-cheap">
              <option value="" ${!s.cheapService?'selected':''}>Same as Primary</option>
              <option value="2captcha" ${s.cheapService==='2captcha'?'selected':''}>2Captcha</option>
              <option value="deathbycaptcha" ${s.cheapService==='deathbycaptcha'?'selected':''}>DeathByCaptcha</option>
            </select></div>
        </div>
        <div>
          <div class="g2">
            <div class="fg"><label class="lbl">Timeout (s)</label><input type="number" id="cap-timeout" value="${s.timeout||120}" min="30"/></div>
            <div class="fg"><label class="lbl">Max Retries</label><input type="number" id="cap-retries" value="${s.maxRetries||3}" min="1" max="10"/></div>
          </div>
          <div class="g2">
            <div class="fg"><label class="lbl">Daily Limit ($)</label><input type="number" id="cap-limit" value="${s.limit||5}" step="0.5"/></div>
            <div class="fg"><label class="lbl">Balance Alert ($)</label><input type="number" id="cap-alert" value="${s.balanceAlert||1}" step="0.25" placeholder="Alert below $"/></div>
          </div>
          <div class="fg"><label class="lbl">Supported Captcha Types</label>
            <div style="display:flex;flex-direction:column;gap:5px;margin-top:5px">
              ${[['recaptchav2','reCAPTCHA v2','on'],['recaptchav3','reCAPTCHA v3','on'],['hcaptcha','hCaptcha','on'],['turnstile','Cloudflare Turnstile (CapSolver)','on'],['image','Image CAPTCHA (AI or premium)','off'],['audio','Audio CAPTCHA fallback','off']].map(([k,n,def])=>`<label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px"><input type="checkbox" id="cap-type-${k}" ${(s.types||{})[k]!==false&&def==='on'?'checked':((s.types||{})[k]?'checked':'')} style="width:auto;accent-color:var(--green)"><span>${n}</span></label>`).join('')}
            </div>
          </div>
          <div class="notice ni-b" style="margin-top:6px;font-size:10px">
            <b>Solve order:</b> Token cache â†’ v3 Farm (free) â†’ NopeCHA (free) â†’ AI image â†’ Premium service â†’ Failover
          </div>
        </div>
      </div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="cap_save()">ğŸ’¾ Save Config</button>
        <button class="tbtn" onclick="cap_test()">ğŸ”¬ Test + Balance</button>
        <button class="tbtn" onclick="cap_clearStats()">ğŸ—‘ Reset Stats</button>
      </div>
    </div>
  </div>
  ` : (window._capTab||'free')==='farm' ? `
  <!-- TOKEN FARM TAB -->
  <div class="panel">
    <div class="panel-head">ğŸ”® reCAPTCHA v3 Token Farm
      <span class="badge ${farm.running?'by':'bgray'}" style="margin-left:6px">${farm.running?'â— FARMING':'â—‹ IDLE'}</span>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:10px;font-size:10px">
        <strong>How Token Farm works:</strong> RankForge loads reCAPTCHA in a hidden invisible iframe and calls <code>grecaptcha.execute()</code> to silently obtain a valid v3 token. The token is cached for ~110 seconds and reused across requests. Tokens are site-specific â€” the sitekey must match the target site.
        <br><br>
        <strong>Limitations:</strong> Token farming only works for reCAPTCHA v3 (invisible). For v2 checkbox CAPTCHAs, use NopeCHA or a paid service. Some sites verify the token domain matches â€” in those cases only paid services will work.
      </div>
      
      <div class="panel" style="background:var(--win-inset);margin-bottom:10px">
        <div class="panel-head" style="font-size:10px">ğŸ“‹ Known Farmable Sitekeys</div>
        <div class="panel-body" style="padding:8px">
          <table>
            <thead><tr><th>Sitekey</th><th>Type</th><th>Cached Tokens</th><th>Action</th></tr></thead>
            <tbody>
              ${CAP_FARM_SITES.map(s=>{
                const cached = (window.CAP_TOKEN_FARM.tokens[s.sitekey]||[]).filter(t=>Date.now()-t.ts<CAP_TOKEN_TTL).length;
                return `<tr>
                  <td class="mono xs tm">${s.sitekey.slice(0,30)}â€¦</td>
                  <td><span class="badge bgray">${s.type}</span></td>
                  <td style="color:${cached>0?'var(--green)':'var(--text3)'}">${cached} ready</td>
                  <td><button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="cap_farmSingle('${s.sitekey}','${s.pageUrl}')">Farm</button></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="fg"><label class="lbl">Custom Sitekey to Farm</label>
        <input type="text" id="cap-farm-sitekey" placeholder="6LeIxAcTAAAAâ€¦ (target site's reCAPTCHA sitekey)"/>
      </div>
      <div class="fg"><label class="lbl">Target Page URL (helps with domain matching)</label>
        <input type="text" id="cap-farm-pageurl" placeholder="https://targetsite.com/register"/>
      </div>
      <div class="flex g6 mt8">
        <button class="tbtn go" onclick="cap_farmCustom()">ğŸ”® Farm Custom Sitekey</button>
        <button class="tbtn" onclick="cap_farmAll()">ğŸ”® Farm All Known Sitekeys</button>
        <button class="tbtn" onclick="window.CAP_TOKEN_FARM.tokens={};log('Token cache cleared','warn');render_captcha_solver(document.getElementById('page-captcha_solver'))">ğŸ—‘ Clear Cache</button>
      </div>
      
      <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--win-border)">
        <div class="g3">
          <div class="stat"><div class="stat-v sv-g">${farm.farmed}</div><div class="stat-l">Total Farmed</div></div>
          <div class="stat"><div class="stat-v sv-r">${farm.failed}</div><div class="stat-l">Failed</div></div>
          <div class="stat"><div class="stat-v sv-b">${Object.values(farm.tokens).reduce((a,arr)=>a+arr.filter(t=>Date.now()-t.ts<CAP_TOKEN_TTL).length,0)}</div><div class="stat-l">Cached Now</div></div>
        </div>
      </div>
    </div>
  </div>
  ` : `
  <!-- STATS TAB -->
  <div class="panel">
    <div class="panel-head">ğŸ“Š Captcha Solver Stats & Metrics</div>
    <div class="panel-body">
      <div class="g3" style="margin-bottom:12px">
        <div class="stat"><div class="stat-v sv-g">${s.solved||0}</div><div class="stat-l">Solved</div></div>
        <div class="stat"><div class="stat-v sv-r">${s.failed||0}</div><div class="stat-l">Failed</div></div>
        <div class="stat"><div class="stat-v sv-b">${s.rate||'â€”'}</div><div class="stat-l">Success Rate</div></div>
        <div class="stat"><div class="stat-v sv-y">$${(s.cost||0).toFixed(3)}</div><div class="stat-l">Total Cost</div></div>
        <div class="stat"><div class="stat-v sv-g">${window.CAP_TOKEN_FARM.farmed}</div><div class="stat-l">Free Farmed</div></div>
        <div class="stat"><div class="stat-v sv-b">${s.balance!=null?'$'+parseFloat(s.balance).toFixed(3):'â€”'}</div><div class="stat-l">Balance</div></div>
      </div>
      
      <div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:5px;text-transform:uppercase">Solve Method Breakdown</div>
      <table style="margin-bottom:12px">
        <thead><tr><th>Method</th><th>Count</th><th>Type</th></tr></thead>
        <tbody>
          <tr><td>ğŸ”® Token Farm (free)</td><td class="mono xs">${window.CAP_TOKEN_FARM.farmed}</td><td><span class="badge bg">FREE</span></td></tr>
          <tr><td>ğŸ†“ NopeCHA (free tier)</td><td class="mono xs">${s.nopechaSolved||0}</td><td><span class="badge bg">FREE</span></td></tr>
          <tr><td>ğŸ¤– AI Image (Claude)</td><td class="mono xs">${s.aiSolved||0}</td><td><span class="badge bg">FREE*</span></td></tr>
          <tr><td>ğŸ’³ Premium services</td><td class="mono xs">${s.premiumSolved||0}</td><td><span class="badge by">PAID</span></td></tr>
        </tbody>
      </table>
      
      <div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:5px;text-transform:uppercase">Per-Service Latency</div>
      <table style="margin-bottom:12px"><thead><tr><th>Service</th><th>Avg Time</th><th>Samples</th></tr></thead><tbody>${latRows}</tbody></table>
      
      <div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:5px;text-transform:uppercase">Cost by Campaign</div>
      ${campRows ? `<table><thead><tr><th>Campaign</th><th>Cost</th><th>Solved</th><th>Failed</th></tr></thead><tbody>${campRows}</tbody></table>` : `<div class="notice ni-b" style="font-size:10px">No campaign cost data yet.</div>`}
      
      <div class="flex g6 mt8">
        <button class="tbtn" onclick="cap_clearStats()">ğŸ—‘ Reset Stats</button>
      </div>
    </div>
  </div>
  `}
  `;
}

// â”€â”€ SAVE FREE CONFIG â”€â”€
function cap_saveV3(){
  const s = SS.get('rf_captcha', {});
  s.nopechaKey = (document.getElementById('cap-nopecha-key')||{value:''}).value.trim();
  s.freeMode = document.getElementById('cap-free-mode')?.checked ?? false;
  s.farmEnabled = document.getElementById('cap-farm-enabled')?.checked ?? true;
  SS.set('rf_captcha', s);
  log(`Free captcha config saved â€” NopeCHA: ${s.nopechaKey?'configured':'not set'}, Farm: ${s.farmEnabled?'on':'off'}, Free-only: ${s.freeMode?'yes':'no'}`, 'ok');
  render_captcha_solver(document.getElementById('page-captcha_solver'));
}

// â”€â”€ SAVE PREMIUM CONFIG â”€â”€
function cap_save(){
  const types={};
  ['recaptchav2','recaptchav3','hcaptcha','turnstile','image','audio'].forEach(k=>{
    const el=document.getElementById('cap-type-'+k); types[k]=el?el.checked:true;
  });
  const existing = SS.get('rf_captcha', {});
  const s = {
    ...existing,
    service: (document.getElementById('cap-svc')||{value:'2captcha'}).value,
    key: (document.getElementById('cap-key')||{value:''}).value,
    backup: (document.getElementById('cap-bak')||{value:''}).value||null,
    backupKey: (document.getElementById('cap-bak-key')||{value:''}).value||null,
    cheapService: (document.getElementById('cap-cheap')||{value:''}).value||null,
    timeout: parseInt((document.getElementById('cap-timeout')||{value:120}).value)||120,
    maxRetries: parseInt((document.getElementById('cap-retries')||{value:3}).value)||3,
    limit: parseFloat((document.getElementById('cap-limit')||{value:5}).value)||5,
    balanceAlert: parseFloat((document.getElementById('cap-alert')||{value:1}).value)||1,
    types,
  };
  SS.set('rf_captcha', s);
  if(s.key) SS.rawSet('rf_captcha_key', s.key);
  CAP_BALANCE_WARNED = false;
  log(`Premium captcha config saved â€” ${s.service}${s.backup?', failover: '+s.backup:''}`, 'ok');
  render_captcha_solver(document.getElementById('page-captcha_solver'));
}

// â”€â”€ TEST FUNCTIONS â”€â”€
async function cap_testFarm(){
  const sk = CAP_FARM_SITES.find(s=>s.type==='recaptchav3')?.sitekey || '6LfW6wATAAAAAHLqO2pb8bDBahwnrMoTNFAbgUvF';
  log('ğŸ”® Testing token farm with Google demo sitekeyâ€¦','info');
  try{
    const token = await cap_farmV3Token(sk, 'https://recaptcha-demo.appspot.com/recaptcha-v3-request-scores.php');
    if(token){ cap_cacheToken(sk, token); window.CAP_TOKEN_FARM.farmed++; log(`ğŸ”® Token farm SUCCESS â€” token: ${token.slice(0,40)}â€¦`,'ok'); }
    else log('ğŸ”® Farm returned empty token','err');
  }catch(e){ log(`ğŸ”® Token farm failed: ${e.message}`,'err'); }
  render_captcha_solver(document.getElementById('page-captcha_solver'));
}

async function cap_testNopecha(){
  const key = (document.getElementById('cap-nopecha-key')||{value:''}).value.trim() || SS.get('rf_captcha',{}).nopechaKey || '';
  if(!key){ log('Enter your NopeCHA key first','err'); return; }
  log('ğŸ†“ Testing NopeCHA APIâ€¦','info');
  try{
    const resp = await fetch(`https://api.nopecha.com/status?key=${key}`, {signal:AbortSignal.timeout(8000)});
    const data = await resp.json();
    if(data.error) throw new Error(data.message||'invalid key');
    log(`ğŸ†“ NopeCHA connected âœ“ â€” Credit: ${data.data?.credit||'?'}, Plan: ${data.data?.plan||'free'}`,'ok');
  }catch(e){ log(`ğŸ†“ NopeCHA test failed: ${e.message}`,'err'); }
}

async function cap_testImageAI(){
  const b64 = (document.getElementById('cap-imgb64')||{value:''}).value.trim();
  if(!b64){ log('Paste base64 image data first','err'); return; }
  log('ğŸ¤– AI image captcha solve via Claude APIâ€¦','info');
  try{
    const result = await cap_solveImageAI(b64);
    const el = document.getElementById('cap-img-result');
    if(el) el.textContent = `AI Result: ${result}`;
    log(`ğŸ¤– AI solved: "${result}"`, 'ok');
    const s = SS.get('rf_captcha',{}); s.aiSolved=(s.aiSolved||0)+1; SS.set('rf_captcha',s);
  }catch(e){
    log(`ğŸ¤– AI solve failed: ${e.message}`,'err');
  }
}

async function cap_testImage(){
  const b64=(document.getElementById('cap-imgb64')||{value:''}).value.trim();
  if(!b64){log('Paste base64 image data first','err');return;}
  log('Submitting image captcha to premium serviceâ€¦','info');
  const result=await _origSolveCaptchaFull({type:'image',imageBase64:b64,pageUrl:'https://test.local',siteKey:null});
  const el=document.getElementById('cap-img-result');
  if(result&&result!=='__skip__'){if(el)el.textContent='Premium Result: '+result;log(`Premium image solved: "${result}"`, 'ok');}
  else{if(el)el.textContent='Failed â€” check log';log('Premium image solve failed','err');}
}

async function cap_farmSingle(sitekey, pageUrl){
  log(`ğŸ”® Farming token for sitekey ${sitekey.slice(0,20)}â€¦`,'info');
  try{
    const token = await cap_farmV3Token(sitekey, pageUrl);
    cap_cacheToken(sitekey, token);
    window.CAP_TOKEN_FARM.farmed++;
    log(`ğŸ”® Token farmed âœ“ â€” ${token.slice(0,30)}â€¦`,'ok');
  }catch(e){
    window.CAP_TOKEN_FARM.failed++;
    log(`ğŸ”® Farm failed: ${e.message}`,'err');
  }
  render_captcha_solver(document.getElementById('page-captcha_solver'));
}

async function cap_farmCustom(){
  const sk = (document.getElementById('cap-farm-sitekey')||{value:''}).value.trim();
  const pu = (document.getElementById('cap-farm-pageurl')||{value:''}).value.trim();
  if(!sk){ log('Enter a sitekey to farm','err'); return; }
  await cap_farmSingle(sk, pu);
}

async function cap_farmAll(){
  log(`ğŸ”® Farming all ${CAP_FARM_SITES.length} known sitekeysâ€¦`,'info');
  await cap_preFarmTokens(CAP_FARM_SITES.map(s=>s.sitekey));
  render_captcha_solver(document.getElementById('page-captcha_solver'));
}

async function cap_test(){
  const key=(document.getElementById('cap-key')||{value:''}).value.trim()||SS.get('rf_captcha',{}).key||'';
  const svc=(document.getElementById('cap-svc')||{value:'2captcha'}).value;
  if(!key){log('Enter your API key first','err');return;}
  log(`Testing ${svc} API + balanceâ€¦`,'info');
  try{
    let url='',balance=null;
    if(svc==='2captcha'){
      url=`https://2captcha.com/res.php?key=${key}&action=getbalance&json=1`;
      const raw = await prx_corsGet(url, 8000);
      const parsed=JSON.parse(raw||'{}');
      if(parsed.status===1||parsed.request){balance=parsed.request||parsed.balance;}
      else throw new Error(parsed.error_text||'Invalid key');
    }else if(svc==='anticaptcha'){
      const raw = await prx_corsGet('https://api.anti-captcha.com/getBalance', 8000);
      const parsed=JSON.parse(raw||'{}');
      if(parsed.errorId===0)balance=parsed.balance; else throw new Error(parsed.errorDescription||'API error');
    }else if(svc==='capsolver'){
      const raw = await prx_corsGet('https://api.capsolver.com/getBalance', 8000);
      const parsed=JSON.parse(raw||'{}');
      if(!parsed.errorId)balance=parsed.balance; else throw new Error(parsed.errorDescription||'API error');
    }else{log(`${svc} test not supported â€” verify manually`,'warn');return;}
    if(balance!==null){
      const st=SS.get('rf_captcha',{}); st.balance=parseFloat(balance); SS.set('rf_captcha',st);
      const alertLvl=SS.get('rf_captcha',{}).balanceAlert||1;
      if(parseFloat(balance)<alertLvl) log(`âš  ${svc} connected â€” Balance: $${parseFloat(balance).toFixed(4)} (BELOW ALERT $${alertLvl})`,'warn');
      else log(`${svc} connected âœ“ â€” Balance: $${parseFloat(balance).toFixed(4)}`,'ok');
    } else log(`${svc} responded â€” key valid`,'ok');
  }catch(e){log(`${svc} test failed: ${e.message}`,'err');}
}

function cap_dropImage(event){
  event.preventDefault();
  const file = event.dataTransfer?.files?.[0];
  if(!file||!file.type.startsWith('image/')) return;
  const reader = new FileReader();
  reader.onload = e => {
    const b64 = e.target.result.split(',')[1];
    const ta = document.getElementById('cap-imgb64');
    if(ta) ta.value = b64;
    const prev = document.getElementById('cap-img-preview');
    if(prev) prev.innerHTML = `<img src="data:${file.type};base64,${b64}" style="max-height:80px;border:1px solid var(--win-border);margin-top:4px"/>`;
  };
  reader.readAsDataURL(file);
}

function cap_clearStats(){
  const s=SS.get('rf_captcha',{}); s.solved=0;s.failed=0;s.rate='â€”';s.cost=0;s.balance=null;s.nopechaSolved=0;s.aiSolved=0;s.premiumSolved=0;
  SS.set('rf_captcha',s); CAP_CAMPAIGN_COSTS.clear(); Object.keys(CAP_LATENCY).forEach(k=>delete CAP_LATENCY[k]);
  window.CAP_TOKEN_FARM.farmed=0; window.CAP_TOKEN_FARM.failed=0; window.CAP_TOKEN_FARM.tokens={};
  log('Captcha stats reset','warn');
  render_captcha_solver(document.getElementById('page-captcha_solver'));
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM MANAGER  v2.0 â€” Full Feature Upgrade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Master platform DB â€” extended with all new fields
const PM_BASE = [
  {name:'LinkedIn',    domain:'linkedin.com',   da:99, daHistory:[97,98,98,99,99], indexTime:48,  indexLabel:'24â€“72h',   cwv:'FAIL', js:true,  linkType:'nofollow', tier:1, format:{maxChars:3000,markup:'HTML',imgAllowed:true},  postGuide:'Create a LinkedIn Article (not a post). Add target URL as hyperlink within body text. Use 1500â€“3000 chars, include 3 images. Publish as article, not update.',  category:'Professional', banned:false, penalty:false, suggested:false},
  {name:'Reddit',      domain:'reddit.com',     da:98, daHistory:[96,97,97,98,98], indexTime:5,   indexLabel:'Minutes',  cwv:'PASS', js:true,  linkType:'nofollow', tier:1, format:{maxChars:40000,markup:'Markdown',imgAllowed:true}, postGuide:'Post to a relevant subreddit with 500+ subscribers. Use a self post (not link post). Embed URL naturally in body. Avoid r/spam. Aged account (30d+) required.', category:'Social',       banned:false, penalty:false, suggested:false},
  {name:'GitHub Pages',domain:'github.io',      da:96, daHistory:[95,95,96,96,96], indexTime:12,  indexLabel:'4â€“24h',    cwv:'PASS', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'Markdown/HTML',imgAllowed:true}, postGuide:'Create a new repo â†’ Settings â†’ Pages â†’ Deploy from /docs. Write index.html or README.md with target URL in anchor tag. Push. Googlebot crawls github.io fast.', category:'Developer',    banned:false, penalty:false, suggested:false},
  {name:'WordPress.com',domain:'wordpress.com', da:95, daHistory:[94,94,95,95,95], indexTime:18,  indexLabel:'2â€“24h',    cwv:'WARN', js:false, linkType:'nofollow', tier:1, format:{maxChars:null,markup:'Gutenberg/HTML',imgAllowed:true}, postGuide:'Register free blog. Write 600â€“1200 word post. Place target URL 2â€“3Ã— naturally in body + once in a "Resources" section. Add tags. Submit sitemap.xml to Google.', category:'Blog',         banned:false, penalty:false, suggested:false},
  {name:'Medium',      domain:'medium.com',     da:95, daHistory:[93,94,94,95,95], indexTime:24,  indexLabel:'1â€“48h',    cwv:'WARN', js:false, linkType:'nofollow', tier:1, format:{maxChars:null,markup:'Rich Text',imgAllowed:true},   postGuide:'Write a 800â€“1500 word story. Use target URL as an inline hyperlink. Add to a Publication for faster indexing. Add 5 tags. Claps from aged accounts help.',           category:'Blog',         banned:false, penalty:false, suggested:false},
  {name:'Google Sites', domain:'sites.google.com',da:94,daHistory:[93,93,94,94,94],indexTime:36, indexLabel:'1â€“3d',     cwv:'PASS', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'HTML Widgets',imgAllowed:true}, postGuide:'Create a free Google Sites page. Add text sections with target URL hyperlinked. Publish publicly. Submit URL to Google Search Console for priority crawl.',       category:'Google',       banned:false, penalty:false, suggested:false},
  {name:'Quora',       domain:'quora.com',      da:92, daHistory:[91,91,92,92,92], indexTime:36,  indexLabel:'24â€“48h',   cwv:'WARN', js:true,  linkType:'nofollow', tier:1, format:{maxChars:null,markup:'Rich Text',imgAllowed:true},   postGuide:'Answer a question (500+ chars). Embed URL naturally as a "source" or "for more info" link. Aged Quora account critical. Answers with 5+ upvotes index faster.',    category:'Q&A',          banned:false, penalty:false, suggested:false},
  {name:'Wix',         domain:'wix.com',        da:93, daHistory:[92,92,93,93,93], indexTime:72,  indexLabel:'2â€“5d',     cwv:'WARN', js:false, linkType:'nofollow', tier:1, format:{maxChars:null,markup:'Visual/HTML',imgAllowed:true},  postGuide:'Create free Wix site. Add a blog post with 800+ words. Link target URL. Connect to Google Search Console in Wix SEO Wiz. Submit sitemap.',                         category:'Website Builder',banned:false,penalty:false, suggested:false},
  {name:'Substack',    domain:'substack.com',   da:91, daHistory:[89,90,90,91,91], indexTime:48,  indexLabel:'1â€“3d',     cwv:'PASS', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'Rich Text',imgAllowed:true},   postGuide:'Publish a newsletter post (not email-only). Set post as "Public". Include target URL as hyperlink in body. Substack posts get crawled well â€” index rate improving.',  category:'Newsletter',   banned:false, penalty:false, suggested:false},
  {name:'Dev.to',      domain:'dev.to',         da:91, daHistory:[89,90,90,91,91], indexTime:24,  indexLabel:'24â€“48h',   cwv:'PASS', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'Markdown',imgAllowed:true},    postGuide:'Write a technical article (Markdown). Include target URL in a relevant context. Add 4 tags. Dev.to has fast Googlebot crawl â€” posts often index same day.',         category:'Developer',    banned:false, penalty:false, suggested:false},
  {name:'Notion',      domain:'notion.site',    da:90, daHistory:[89,89,90,90,90], indexTime:120, indexLabel:'3â€“7d',     cwv:'FAIL', js:true,  linkType:'nofollow', tier:2, format:{maxChars:null,markup:'Notion Blocks',imgAllowed:true},postGuide:'Create public Notion page. Add target URL. Share page publicly. âš  CWV FAIL â€” heavy JS means Googlebot renders slowly. Needs T2 links to force crawl.',    category:'Productivity', banned:false, penalty:false, suggested:false},
  {name:'Blogger',     domain:'blogger.com',    da:90, daHistory:[89,90,90,90,90], indexTime:36,  indexLabel:'1â€“3d',     cwv:'WARN', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'HTML',imgAllowed:true},        postGuide:'Google-owned = high trust. Write 600â€“1000 word post. Link target URL. Submit blog sitemap to Google Search Console. Blogspot posts get indexed within 24h usually.', category:'Blog',         banned:false, penalty:false, suggested:false},
  {name:'Tumblr',      domain:'tumblr.com',     da:89, daHistory:[88,88,89,89,89], indexTime:48,  indexLabel:'1â€“3d',     cwv:'WARN', js:false, linkType:'nofollow', tier:2, format:{maxChars:null,markup:'HTML/Rich Text',imgAllowed:true},postGuide:'Post a text post (600+ words). Add target URL in body. Tag with 10 relevant tags. Reblog your post from a second account to boost crawl signal.',           category:'Blog',         banned:false, penalty:false, suggested:false},
  {name:'Hashnode',    domain:'hashnode.com',   da:88, daHistory:[86,87,87,88,88], indexTime:24,  indexLabel:'24â€“48h',   cwv:'PASS', js:false, linkType:'dofollow', tier:2, format:{maxChars:null,markup:'Markdown',imgAllowed:true},    postGuide:'Write a dev/tech article. Add target URL in a "Resources" or "Further Reading" section. Map to custom domain if possible â€” boosts crawl priority.',               category:'Developer',    banned:false, penalty:false, suggested:false},
  {name:'Weebly',      domain:'weebly.com',     da:88, daHistory:[87,87,88,88,88], indexTime:96,  indexLabel:'2â€“5d',     cwv:'WARN', js:false, linkType:'nofollow', tier:2, format:{maxChars:null,markup:'Visual',imgAllowed:true},      postGuide:'Build a free site. Add a blog post. Add target URL. Connect Google Search Console. Slower crawl â€” supplement with T3 pings.',                                       category:'Website Builder',banned:false,penalty:false, suggested:false},
  {name:'Scribd',      domain:'scribd.com',     da:94, daHistory:[93,93,94,94,94], indexTime:48,  indexLabel:'1â€“3d',     cwv:'WARN', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'PDF/DOC Upload',imgAllowed:true},postGuide:'Upload a PDF or Word doc containing your target URL as a hyperlink. Use descriptive title and keywords. Scribd docs index well and links are often crawled.',  category:'Document',     banned:false, penalty:false, suggested:false},
  {name:'SlideShare',  domain:'slideshare.net', da:95, daHistory:[94,94,95,95,95], indexTime:48,  indexLabel:'1â€“3d',     cwv:'WARN', js:false, linkType:'dofollow', tier:1, format:{maxChars:null,markup:'PDF/PPT Upload',imgAllowed:true},postGuide:'Create a PPT or PDF presentation. Include target URL on the final slide. LinkedIn owns SlideShare â€” high trust. Upload + add keyword-rich description.',   category:'Document',     banned:false, penalty:false, suggested:false},
  {name:'Pinterest',   domain:'pinterest.com',  da:93, daHistory:[92,92,93,93,93], indexTime:24,  indexLabel:'24â€“48h',   cwv:'PASS', js:false, linkType:'dofollow', tier:3, format:{maxChars:500,markup:'Plain Text',imgAllowed:true},    postGuide:'Create a Pin with an image. Set destination URL = target URL. Write 500-char description with keyword. T3 use: naked URL. Pins index fast and pass crawl credit.',    category:'Social',       banned:false, penalty:false, suggested:false},
  {name:'Mix.com',     domain:'mix.com',        da:62, daHistory:[60,61,61,62,62], indexTime:168, indexLabel:'3â€“14d',    cwv:'PASS', js:false, linkType:'dofollow', tier:3, format:{maxChars:200,markup:'Plain Text',imgAllowed:false},   postGuide:'Submit URL as a Mix "mix". Add title + tags. T3 use only â€” naked URL, no keyword anchor. Slow index but passes crawl signal for T3 pyramid base.',               category:'Bookmarks',    banned:false, penalty:false, suggested:false},
  {name:'Diigo',       domain:'diigo.com',      da:71, daHistory:[70,70,71,71,71], indexTime:120, indexLabel:'2â€“7d',     cwv:'PASS', js:false, linkType:'dofollow', tier:3, format:{maxChars:1000,markup:'Plain Text',imgAllowed:false},  postGuide:'Bookmark your T1 URL. Add tags and a short description (100+ chars). Make bookmark public. Good for T3 social signal â€” links crawled by Googlebot.',              category:'Bookmarks',    banned:false, penalty:false, suggested:false},
  {name:'Telegraph',   domain:'telegra.ph',     da:68, daHistory:[66,67,67,68,68], indexTime:336, indexLabel:'1â€“4wk',    cwv:'PASS', js:false, linkType:'dofollow', tier:2, format:{maxChars:null,markup:'Rich Text',imgAllowed:true},    postGuide:'Open telegra.ph â€” no account needed. Write article, embed target URL. Publish. Very minimal â€” needs T2/T3 links pointing at it to get Googlebot attention.',       category:'Blog',         banned:false, penalty:false, suggested:false},
];

// Platform runtime data (DA overrides, bans, accounts, usage) stored in localStorage
function pmData()  { try{return JSON.parse(localStorage.getItem('rf_pm_data')||'{}')}catch(e){return{}} }
function pmSave(d) { localStorage.setItem('rf_pm_data',JSON.stringify(d)) }

// Merge base + runtime overrides
function pmPlatforms(){
  const d=pmData();
  return PM_BASE.map(p=>{
    const o=d[p.domain]||{};
    return {...p, ...o,
      daOverride: o.daOverride??null,
      daLive:     o.daOverride??p.da,
      banned:     o.banned??p.banned,
      penalty:    o.penalty??p.penalty,
      accounts:   o.accounts||[],
      usedInBuilds: (APP.links||[]).filter(l=>(l.platform||'').toLowerCase().includes(p.name.toLowerCase())||(l.url||'').includes(p.domain)).length,
      daTrend:    o.daTrend||'stable', // 'rising'|'falling'|'stable'
      lastDaRefresh: o.lastDaRefresh||null,
    };
  });
}

let _pmTab='overview'; // 'overview'|'guides'|'accounts'|'health'|'suggest'

function render_platform_manager(el){
  const plats=pmPlatforms();
  const live=plats.filter(p=>!p.banned&&!p.penalty);
  const flagged=plats.filter(p=>p.banned||p.penalty);
  const cwvFail=plats.filter(p=>p.cwv==='FAIL');
  const dofollow=plats.filter(p=>p.linkType==='dofollow');

  el.innerHTML=`
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:2px solid var(--win-border);padding-bottom:0">
    ${[['overview','ğŸ“‹ Platform DB'],['guides','ğŸ“– Posting Guides'],['accounts','ğŸ‘¤ Accounts'],['health','ğŸ“Š Health & Trends'],['suggest','ğŸ’¡ Suggestions']].map(([t,l])=>`
    <div onclick="_pmTab='${t}';render_platform_manager(document.getElementById('page-platform_manager'))" style="padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;margin-bottom:-2px;border:1px solid ${_pmTab===t?'var(--win-border)':'transparent'};border-bottom-color:${_pmTab===t?'var(--win-panel)':'transparent'};background:${_pmTab===t?'var(--win-panel)':'transparent'};color:${_pmTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding-bottom:4px">
      ${flagged.length?`<span class="badge br">âš  ${flagged.length} flagged</span>`:''}
      <span class="badge bg">${live.length} clean</span>
      <button class="tbtn" style="padding:1px 7px;font-size:9px" onclick="pm_refreshDA()">ğŸ”„ Refresh DA</button>
      <button class="tbtn" style="padding:1px 7px;font-size:9px" onclick="pm_export()">ğŸ“¥ Export</button>
    </div>
  </div>

  ${_pmTab==='overview' ? _pmOverviewTab(plats,flagged,cwvFail,dofollow)
  : _pmTab==='guides'  ? _pmGuidesTab(plats)
  : _pmTab==='accounts'? _pmAccountsTab(plats)
  : _pmTab==='health'  ? _pmHealthTab(plats,flagged)
  :                      _pmSuggestTab()}
  `;
}

// â”€â”€ OVERVIEW TAB â”€â”€
function _pmOverviewTab(plats,flagged,cwvFail,dofollow){
  const builtPlats=[...new Set((APP.links||[]).map(l=>l.platform).filter(Boolean))];
  return `
  <!-- STAT CARDS -->
  <div class="g5" style="margin-bottom:10px">
    <div class="stat sv-b"><div class="stat-v">${plats.length}</div><div class="stat-l">Total Platforms</div></div>
    <div class="stat sv-g"><div class="stat-v">${plats.filter(p=>p.daLive>=90).length}</div><div class="stat-l">DA 90+ Tier 1</div></div>
    <div class="stat sv-g"><div class="stat-v">${dofollow.length}</div><div class="stat-l">Dofollow</div></div>
    <div class="stat sv-r"><div class="stat-v">${cwvFail.length}</div><div class="stat-l">CWV Fail âš </div></div>
    <div class="stat sv-y"><div class="stat-v">${flagged.length}</div><div class="stat-l">Banned / Penalised</div></div>
  </div>

  ${flagged.length?`<div class="notice ni-r" style="margin-bottom:10px">â›” <b>Flagged Platforms:</b> ${flagged.map(p=>`<b>${p.name}</b>${p.banned?' (banned)':' (penalty)'}`).join(', ')} â€” avoid building new links until resolved.</div>`:''}
  ${cwvFail.length?`<div class="notice ni-y" style="margin-bottom:10px">âš  <b>CWV FAIL:</b> ${cwvFail.map(p=>p.name).join(', ')} â€” heavy JavaScript. Googlebot may not render fully. Use as T2 only and amplify with T3 signals.</div>`:''}

  <!-- T1 PRIORITY: fastest index, best DA, dofollow -->
  <div class="panel" style="margin-bottom:10px">
    <div class="panel-head">âš¡ T1 Priority â€” Fastest Index + Dofollow + DA 90+</div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr><th>Platform</th><th>DA (Live)</th><th>DA Trend</th><th>Link Type</th><th>Index Time</th><th>CWV</th><th>Built</th><th>Format</th><th>Actions</th></tr></thead>
        <tbody>${plats.filter(p=>p.daLive>=90&&!p.banned&&!p.penalty).sort((a,b)=>a.indexTime-b.indexTime).map(p=>_pmRow(p)).join('')}</tbody>
      </table></div>
    </div>
  </div>

  <!-- FULL TABLE -->
  <div class="panel">
    <div class="panel-head">All Platforms <span class="badge bg">${plats.length}</span>
      <div class="ph-r">
        <button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="pm_addCustom()">â• Add Platform</button>
      </div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr><th>Platform</th><th>Category</th><th>DA (Live)</th><th>DA Trend</th><th>Link Type</th><th>Index Time</th><th>CWV</th><th>JS</th><th>Tier</th><th>Built Here</th><th>Format</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>${plats.sort((a,b)=>b.daLive-a.daLive).map(p=>_pmRow(p,true)).join('')}</tbody>
      </table></div>
    </div>
  </div>`;
}

function _pmRow(p, full=false){
  const trendIcon = p.daTrend==='rising'?'ğŸ“ˆ':p.daTrend==='falling'?'ğŸ“‰':'â¡ï¸';
  const trendCol  = p.daTrend==='rising'?'var(--green)':p.daTrend==='falling'?'var(--red)':'var(--text3)';
  const indexCol  = p.indexTime<=24?'var(--green)':p.indexTime<=72?'var(--yellow)':'var(--text3)';
  const acctCount = (p.accounts||[]).filter(a=>a.status==='active').length;
  return `<tr style="${p.banned||p.penalty?'opacity:.5':''}">
    <td style="font-weight:700;white-space:nowrap">
      ${p.banned?'â›”':''}${p.penalty?'âš ï¸':''}${esc(p.name)}
      ${acctCount>0?`<span class="badge bg" style="font-size:7px;margin-left:3px">${acctCount} accts</span>`:''}
    </td>
    ${full?`<td class="xs tm">${esc(p.category||'â€”')}</td>`:''}
    <td>
      <strong style="color:${p.daLive>=90?'var(--green)':p.daLive>=70?'var(--blue)':'var(--text3)'}">${p.daLive}</strong>
      ${p.daOverride!=null?`<span class="mono" style="font-size:8px;color:var(--yellow)"> âœ</span>`:''}
    </td>
    <td><span style="color:${trendCol};font-size:13px">${trendIcon}</span></td>
    <td><span class="badge ${p.linkType==='dofollow'?'bg':'by'}">${p.linkType||'?'}</span></td>
    <td class="mono xs" style="color:${indexCol}">${esc(p.indexLabel)}</td>
    <td><span class="badge ${p.cwv==='PASS'?'bg':p.cwv==='WARN'?'by':'br'}">${p.cwv}</span></td>
    ${full?`<td><span class="badge ${p.js?'by':'bg'}" style="font-size:8px">${p.js?'JS':'Static'}</span></td>`:''}
    ${full?`<td><span class="badge ${p.tier===1?'bg':p.tier===2?'bb':'bp'}">T${p.tier}</span></td>`:''}
    <td class="mono xs" style="color:${p.usedInBuilds>0?'var(--green)':'var(--text3)'}">
      ${p.usedInBuilds>0?`<strong>${p.usedInBuilds}</strong>`:'â€”'}
    </td>
    ${full?`<td class="xs tm" style="white-space:nowrap">${p.format?`${p.format.markup||'?'}${p.format.maxChars?` / ${p.format.maxChars}c`:''}`:''}</td>`:''}
    ${full?`<td>
      ${p.banned?`<span class="badge br">BANNED</span>`:p.penalty?`<span class="badge by">PENALTY</span>`:`<span class="badge bg">OK</span>`}
    </td>`:''}
    <td style="white-space:nowrap">
      <button class="tbtn go" style="font-size:8px;padding:1px 5px" onclick="_pmTab='guides';document.getElementById('pm-guide-focus')&&(document.getElementById('pm-guide-focus').value='${p.name}');render_platform_manager(document.getElementById('page-platform_manager'))">ğŸ“–</button>
      <button class="tbtn" style="font-size:8px;padding:1px 5px" onclick="pm_setDA('${p.domain}')">DA</button>
      <button class="tbtn ${p.banned?'go':'stop'}" style="font-size:8px;padding:1px 5px" onclick="pm_toggleBan('${p.domain}')">${p.banned?'âœ“Unban':'â›”Ban'}</button>
      <button class="tbtn" style="font-size:8px;padding:1px 5px" onclick="switchPage('link_builder')">Build</button>
    </td>
  </tr>`;
}

// â”€â”€ POSTING GUIDES TAB â”€â”€
function _pmGuidesTab(plats){
  const focused=plats.find(p=>p.name===window._pmGuideFocus)||plats[0];
  return `<div class="g2">
    <!-- LEFT: platform selector -->
    <div>
      <div class="panel" style="margin-bottom:8px">
        <div class="panel-head">Select Platform</div>
        <div class="panel-body" style="padding:0">
          <div style="max-height:380px;overflow-y:auto">
            ${plats.sort((a,b)=>b.daLive-a.daLive).map(p=>`
            <div onclick="window._pmGuideFocus='${p.name}';render_platform_manager(document.getElementById('page-platform_manager'))" style="padding:7px 12px;cursor:pointer;border-bottom:1px solid var(--win-border);display:flex;align-items:center;gap:8px;background:${focused&&focused.name===p.name?'var(--sel-bg)':'transparent'}">
              <div>
                <div style="font-size:11px;font-weight:700;color:${focused&&focused.name===p.name?'#fff':'var(--text)'}">${esc(p.name)}</div>
                <div style="font-size:9px;color:var(--text3)">${p.category||''} Â· DA${p.daLive} Â· ${p.indexLabel}</div>
              </div>
              <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:3px">
                <span class="badge ${p.linkType==='dofollow'?'bg':'by'}" style="font-size:7px">${p.linkType}</span>
                <span class="badge ${p.cwv==='PASS'?'bg':p.cwv==='WARN'?'by':'br'}" style="font-size:7px">${p.cwv}</span>
              </div>
            </div>`).join('')}
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: guide detail -->
    <div>
      ${focused?`
      <div class="panel">
        <div class="panel-head">ğŸ“– ${esc(focused.name)} â€” Posting Guide</div>
        <div class="panel-body">
          <!-- Quick stats -->
          <div class="g4" style="margin-bottom:14px">
            <div style="padding:8px;background:var(--win-panel2);border-radius:2px;text-align:center">
              <div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${focused.daLive>=90?'var(--green)':focused.daLive>=70?'var(--blue)':'var(--yellow)'}">${focused.daLive}</div>
              <div style="font-size:9px;color:var(--text3)">Domain Authority</div>
            </div>
            <div style="padding:8px;background:var(--win-panel2);border-radius:2px;text-align:center">
              <div style="font-family:var(--mono);font-size:18px;font-weight:800;color:${focused.indexTime<=24?'var(--green)':focused.indexTime<=72?'var(--yellow)':'var(--text3)'}">${focused.indexLabel}</div>
              <div style="font-size:9px;color:var(--text3)">Index Speed</div>
            </div>
            <div style="padding:8px;background:var(--win-panel2);border-radius:2px;text-align:center">
              <div style="font-family:var(--mono);font-size:14px;font-weight:800;color:${focused.linkType==='dofollow'?'var(--green)':'var(--yellow)'}">${focused.linkType?.toUpperCase()}</div>
              <div style="font-size:9px;color:var(--text3)">Link Type</div>
            </div>
            <div style="padding:8px;background:var(--win-panel2);border-radius:2px;text-align:center">
              <div style="font-family:var(--mono);font-size:14px;font-weight:800;color:${focused.cwv==='PASS'?'var(--green)':focused.cwv==='WARN'?'var(--yellow)':'var(--red)'}">${focused.cwv}</div>
              <div style="font-size:9px;color:var(--text3)">Core Web Vitals</div>
            </div>
          </div>

          <!-- Content format -->
          <div style="background:rgba(74,158,222,.05);border:1px solid rgba(74,158,222,.2);border-radius:2px;padding:10px 12px;margin-bottom:12px">
            <div style="font-family:var(--mono);font-size:9px;font-weight:700;color:var(--blue);text-transform:uppercase;margin-bottom:6px">Content Format</div>
            <div class="g3">
              <div><div class="mono xs tm">Markup</div><div style="font-size:11px;font-weight:700">${focused.format?.markup||'â€”'}</div></div>
              <div><div class="mono xs tm">Max Characters</div><div style="font-size:11px;font-weight:700">${focused.format?.maxChars?focused.format.maxChars.toLocaleString():'Unlimited'}</div></div>
              <div><div class="mono xs tm">Images Allowed</div><div style="font-size:11px;font-weight:700;color:${focused.format?.imgAllowed?'var(--green)':'var(--red)'}">${focused.format?.imgAllowed?'Yes':'No'}</div></div>
            </div>
          </div>

          <!-- Step-by-step guide -->
          <div style="font-family:var(--mono);font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;margin-bottom:8px">Step-by-Step Posting Guide</div>
          <div style="background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px;padding:12px;font-size:11px;line-height:1.8;color:var(--text)">
            ${esc(focused.postGuide||'Guide coming soon.')}
          </div>

          ${focused.cwv==='FAIL'?`<div class="notice ni-r" style="margin-top:10px">âš  <b>CWV FAIL:</b> ${esc(focused.name)} uses heavy JavaScript. Googlebot may not fully render your links on first crawl. Mitigate: point T3 signals at this page to force recrawl, or use Google's URL Inspection in GSC to manually request indexing.</div>`:''}
          ${focused.js&&focused.cwv!=='PASS'?`<div class="notice ni-y" style="margin-top:6px">ğŸŒ JS-heavy platform â€” index time may be longer than listed. Submit URL manually via GSC after publishing.</div>`:''}

          <div style="margin-top:12px;display:flex;gap:6px">
            <button class="tbtn go" onclick="switchPage('link_builder')">ğŸ”— Start Building</button>
            <button class="tbtn" onclick="pm_addAccount('${focused.domain}')">ğŸ‘¤ Add Account</button>
            <a href="https://${focused.domain}" target="_blank"><button class="tbtn">ğŸŒ Open Platform</button></a>
          </div>
        </div>
      </div>`:'<div class="notice ni-b">Select a platform from the left.</div>'}
    </div>
  </div>`;
}

// â”€â”€ ACCOUNTS TAB â”€â”€
function _pmAccountsTab(plats){
  const allAccts=[];
  plats.forEach(p=>(p.accounts||[]).forEach(a=>allAccts.push({...a,platform:p.name,domain:p.domain})));
  const active=allAccts.filter(a=>a.status==='active');
  const banned=allAccts.filter(a=>a.status==='banned');

  return `<div class="panel" style="margin-bottom:10px">
    <div class="panel-head">ğŸ‘¤ Platform Account Tracker
      <div class="ph-r"><span class="badge bg">${active.length} active</span><span class="badge br">${banned.length} banned</span></div>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:10px">Track which accounts you have on each platform. Helps avoid reusing dead/banned accounts and rotate freshest accounts into T1 builds.</div>
      <div class="g3" style="margin-bottom:10px">
        <div class="fg"><label class="lbl">Platform</label>
          <select id="pm-acct-plat">
            ${plats.sort((a,b)=>b.daLive-a.daLive).map(p=>`<option value="${p.domain}">${esc(p.name)} (DA${p.daLive})</option>`).join('')}
          </select></div>
        <div class="fg"><label class="lbl">Username / Email</label><input type="text" id="pm-acct-user" placeholder="user@email.com or @handle"/></div>
        <div class="fg"><label class="lbl">Status</label>
          <select id="pm-acct-status">
            <option value="active">Active</option>
            <option value="aged">Aged (30d+)</option>
            <option value="warm">Warm (7â€“29d)</option>
            <option value="fresh">Fresh (0â€“6d)</option>
            <option value="banned">Banned</option>
          </select></div>
      </div>
      <div class="g2" style="margin-bottom:10px">
        <div class="fg"><label class="lbl">Notes (age, 2FA, proxy assigned)</label><input type="text" id="pm-acct-notes" placeholder="Created 2024-01, uses US proxy pool, 2FA enabled"/></div>
        <div class="fg"><label class="lbl">Last Used</label><input type="date" id="pm-acct-date"/></div>
      </div>
      <button class="tbtn go" onclick="pm_addAccountForm()">ğŸ‘¤ Add Account</button>
    </div>
  </div>

  ${allAccts.length?`<div class="panel">
    <div class="panel-head">All Accounts <span class="badge bg">${allAccts.length}</span></div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr><th>Platform</th><th>Username</th><th>Status</th><th>Notes</th><th>Last Used</th><th>Actions</th></tr></thead>
        <tbody>${allAccts.map((a,i)=>`<tr>
          <td style="font-weight:700">${esc(a.platform)}</td>
          <td class="mono xs">${esc(a.username||'â€”')}</td>
          <td><span class="badge ${a.status==='active'?'bg':a.status==='banned'?'br':a.status==='aged'?'bb':'by'}">${a.status}</span></td>
          <td class="xs tm">${esc(a.notes||'â€”')}</td>
          <td class="mono xs tm">${a.lastUsed||'â€”'}</td>
          <td>
            <button class="tbtn ${a.status==='banned'?'go':'stop'}" style="font-size:8px;padding:1px 4px" onclick="pm_toggleAccountStatus('${a.domain}','${a.username}')">
              ${a.status==='banned'?'âœ“ Restore':'â›” Ban'}
            </button>
            <button class="tbtn stop" style="font-size:8px;padding:1px 4px" onclick="pm_delAccount('${a.domain}','${a.username}')">âœ•</button>
          </td>
        </tr>`).join('')}</tbody>
      </table></div>
    </div>
  </div>`:`<div class="notice ni-b">No accounts tracked yet. Add accounts above.</div>`}`;
}

// â”€â”€ HEALTH & TRENDS TAB â”€â”€
function _pmHealthTab(plats,flagged){
  const rising=plats.filter(p=>p.daTrend==='rising');
  const falling=plats.filter(p=>p.daTrend==='falling');
  const cwvFail=plats.filter(p=>p.cwv==='FAIL'&&!p.banned);
  const fastIndex=plats.filter(p=>p.indexTime<=24&&!p.banned).sort((a,b)=>a.indexTime-b.indexTime);

  return `
  <div class="g4" style="margin-bottom:10px">
    <div class="stat sv-g"><div class="stat-v">${rising.length}</div><div class="stat-l">ğŸ“ˆ DA Rising</div></div>
    <div class="stat sv-r"><div class="stat-v">${falling.length}</div><div class="stat-l">ğŸ“‰ DA Falling</div></div>
    <div class="stat sv-r"><div class="stat-v">${flagged.length}</div><div class="stat-l">â›” Banned/Penalised</div></div>
    <div class="stat sv-y"><div class="stat-v">${cwvFail.length}</div><div class="stat-l">âš  CWV Fail</div></div>
  </div>

  ${falling.length?`<div class="notice ni-r" style="margin-bottom:10px">ğŸ“‰ <b>Falling DA â€” Stop Building:</b> ${falling.map(p=>`<b>${p.name}</b> (DA${p.daLive})`).join(', ')}. These platforms are losing authority â€” pause new builds and monitor for deindexation.</div>`:''}
  ${rising.length?`<div class="notice ni-g" style="margin-bottom:10px">ğŸ“ˆ <b>Rising DA â€” Prioritise:</b> ${rising.map(p=>`<b>${p.name}</b> (DA${p.daLive})`).join(', ')}. Gaining authority â€” front-load T1 builds here.</div>`:''}
  ${cwvFail.length?`<div class="notice ni-y" style="margin-bottom:10px">âš  <b>CWV FAIL Platforms:</b> ${cwvFail.map(p=>p.name).join(', ')} â€” JavaScript-heavy. Googlebot crawl risk. Use as T2 only. Amplify with T3 social signals to force re-render.</div>`:''}

  <!-- DA Trend Table -->
  <div class="panel" style="margin-bottom:10px">
    <div class="panel-head">ğŸ“Š DA Trends & History
      <div class="ph-r"><button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="pm_refreshDA()">ğŸ”„ Refresh All via OPR</button></div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr><th>Platform</th><th>Current DA</th><th>Trend</th><th>DA History (oldestâ†’newest)</th><th>Index Speed</th><th>Built Here</th><th>Recommendation</th></tr></thead>
        <tbody>${plats.sort((a,b)=>b.daLive-a.daLive).map(p=>{
          const trendIcon=p.daTrend==='rising'?'ğŸ“ˆ':p.daTrend==='falling'?'ğŸ“‰':'â¡ï¸';
          const trendCol=p.daTrend==='rising'?'var(--green)':p.daTrend==='falling'?'var(--red)':'var(--text3)';
          const rec=p.banned?'â›” Avoid':p.daTrend==='falling'?'âš  Pause':p.cwv==='FAIL'?'T2 only':p.daLive>=90&&p.indexTime<=48?'âœ“ T1 Priority':'âœ“ Use';
          const recCol=rec.startsWith('â›”')||rec.startsWith('âš ')?'var(--red)':rec.includes('T2')?'var(--yellow)':'var(--green)';
          return `<tr style="${p.banned?'opacity:.45':''}">
            <td style="font-weight:700">${p.banned?'â›”':''}${esc(p.name)}</td>
            <td><strong style="color:${p.daLive>=90?'var(--green)':p.daLive>=70?'var(--blue)':'var(--text3)'}">${p.daLive}</strong></td>
            <td style="font-size:16px">${trendIcon}</td>
            <td class="mono xs">
              <div style="display:flex;gap:3px;align-items:flex-end;height:20px">
                ${(p.daHistory||[p.da]).map((v,i,arr)=>{
                  const max=Math.max(...arr)||100;
                  const h=Math.round((v/max)*18);
                  const isLast=i===arr.length-1;
                  return `<div title="DA${v}" style="width:12px;height:${h}px;background:${isLast?'var(--green)':'var(--win-border2)'};border-radius:1px;flex-shrink:0"></div>`;
                }).join('')}
                <span class="mono" style="font-size:9px;color:var(--text3);margin-left:4px">DA${p.daLive}</span>
              </div>
            </td>
            <td class="mono xs" style="color:${p.indexTime<=24?'var(--green)':p.indexTime<=72?'var(--yellow)':'var(--text3)'}">${p.indexLabel}</td>
            <td class="mono xs tm">${p.usedInBuilds||0}</td>
            <td style="font-size:10px;font-weight:700;color:${recCol}">${rec}</td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>
    </div>
  </div>

  <!-- Fastest Index -->
  <div class="panel">
    <div class="panel-head">âš¡ T1 Priority: Fastest Index Time</div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:10px;font-size:9px">For T1 builds, prioritise platforms where Googlebot indexes within 24 hours. Link equity flows faster through quickly-indexed pages.</div>
      <div style="display:flex;flex-direction:column;gap:4px">
        ${fastIndex.map((p,i)=>`
        <div style="display:flex;align-items:center;gap:10px;padding:7px 12px;background:${i===0?'rgba(57,211,83,.05)':'var(--win-panel2)'};border:1px solid ${i===0?'rgba(57,211,83,.25)':'var(--win-border)'};border-radius:2px">
          <div style="font-family:var(--mono);font-size:12px;font-weight:800;color:var(--text3);width:20px">#${i+1}</div>
          <div style="font-weight:700;flex:1">${esc(p.name)}</div>
          <span class="badge ${p.linkType==='dofollow'?'bg':'by'}">${p.linkType}</span>
          <div class="prog-wrap" style="width:80px;margin:0"><div class="prog-fill" style="width:${Math.max(5,100-Math.round((p.indexTime/336)*100))}%"></div></div>
          <div class="mono xs" style="color:var(--green);min-width:50px;text-align:right">${p.indexLabel}</div>
          <button class="tbtn go" style="font-size:9px;padding:1px 6px" onclick="switchPage('link_builder')">Build</button>
        </div>`).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ SUGGESTIONS TAB â”€â”€
function _pmSuggestTab(){
  const suggested=pmData().suggested||[];
  return `<div class="panel">
    <div class="panel-head">ğŸ’¡ Platform Suggestion Engine
      <div class="ph-r"><button class="tbtn go" style="font-size:9px;padding:1px 6px" onclick="pm_scrapeSuggestions()">ğŸ” Scrape SEO Forums</button></div>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:12px">Scrapes BlackHatWorld, Reddit SEO subs, and SEO forum threads to find newly-discussed high-DA platforms not yet in the database. Results are suggestions only â€” verify DA before using.</div>

      <!-- Manual submission -->
      <div style="font-family:var(--mono);font-size:9px;color:var(--text3);margin-bottom:8px;font-weight:700;text-transform:uppercase">Submit New Platform Manually</div>
      <div class="g4" style="margin-bottom:10px">
        <div class="fg"><label class="lbl">Platform Name</label><input type="text" id="pm-sug-name" placeholder="NewPlatform.com"/></div>
        <div class="fg"><label class="lbl">Domain</label><input type="text" id="pm-sug-domain" placeholder="newplatform.com"/></div>
        <div class="fg"><label class="lbl">Estimated DA</label><input type="number" id="pm-sug-da" value="70" min="1" max="100"/></div>
        <div class="fg"><label class="lbl">Category</label><input type="text" id="pm-sug-cat" placeholder="Blog, Social, Q&A..."/></div>
      </div>
      <button class="tbtn go" onclick="pm_addSuggestion()">â• Submit Platform</button>

      ${suggested.length?`<div class="tbl-wrap" style="margin-top:16px"><table>
        <thead><tr><th>Platform</th><th>Domain</th><th>Est. DA</th><th>Category</th><th>Source</th><th>Added</th><th>Actions</th></tr></thead>
        <tbody>${suggested.map((s,i)=>`<tr>
          <td style="font-weight:700">${esc(s.name)}</td>
          <td class="mono xs">${esc(s.domain)}</td>
          <td><strong style="color:${s.da>=80?'var(--green)':s.da>=60?'var(--yellow)':'var(--text3)'}">${s.da||'?'}</strong></td>
          <td class="xs tm">${esc(s.category||'â€”')}</td>
          <td class="xs tm"><span class="badge bgray">${esc(s.source||'manual')}</span></td>
          <td class="mono xs tm">${s.added||'â€”'}</td>
          <td>
            <button class="tbtn go" style="font-size:9px;padding:1px 5px" onclick="pm_approveSuggestion(${i})">âœ“ Approve</button>
            <button class="tbtn stop" style="font-size:9px;padding:1px 5px" onclick="pm_delSuggestion(${i})">âœ•</button>
          </td>
        </tr>`).join('')}</tbody>
      </table></div>`:`<div class="notice ni-b" style="margin-top:12px">No suggestions yet. Click "Scrape SEO Forums" or submit manually above.</div>`}
    </div>
  </div>`;
}

// â”€â”€ FUNCTIONS â”€â”€
async function pm_refreshDA(){
  const oprKey=SS.raw('rf_opr_key');
  if(!oprKey){log('OPR API key required â€” go to Settings','warn');return;}
  const plats=PM_BASE;
  const d=pmData();
  log(`Refreshing DA for ${plats.length} platforms via Open PageRank...`,'info');
  setStatus('Refreshing DA...');
  // Batch into groups of 10 (OPR limit)
  for(let i=0;i<plats.length;i+=10){
    const batch=plats.slice(i,i+10);
    const domains=batch.map(p=>p.domain);
    const qs=domains.map(d=>`domains[]=${encodeURIComponent(d)}`).join('&');
    try{
      const resp=await fetch(`https://openpagerank.com/api/v1.0/getPageRank?${qs}`,{headers:{'API-OPR':oprKey},signal:AbortSignal.timeout(10000)});
      if(!resp.ok){log(`OPR API error: ${resp.status}`,'err');break;}
      const data=await resp.json();
      (data.response||[]).forEach(r=>{
        if(r.domain&&r.page_rank_decimal!==undefined){
          const newDA=Math.round(r.page_rank_decimal*10); // OPR 0â€“10 â†’ DA 0â€“100 approx
          if(!d[r.domain]) d[r.domain]={};
          const prev=d[r.domain].daOverride??PM_BASE.find(p=>p.domain===r.domain)?.da??0;
          d[r.domain].daOverride=newDA;
          d[r.domain].lastDaRefresh=today();
          // Update trend
          if(newDA>prev+1) d[r.domain].daTrend='rising';
          else if(newDA<prev-1) d[r.domain].daTrend='falling';
          else d[r.domain].daTrend='stable';
          // Update history
          if(!d[r.domain].daHistory) d[r.domain].daHistory=[prev];
          d[r.domain].daHistory.push(newDA);
          if(d[r.domain].daHistory.length>5) d[r.domain].daHistory.shift();
          log(`DA refresh: ${r.domain} â†’ DA${newDA} (was ${prev}) ${newDA>prev?'ğŸ“ˆ':newDA<prev?'ğŸ“‰':'â¡ï¸'}`,'ok');
        }
      });
      await sleep(500);
    }catch(e){log(`OPR batch failed: ${e.message}`,'err');}
  }
  pmSave(d);
  setStatus('Done');
  log('DA refresh complete','ok');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_setDA(domain){
  const p=pmPlatforms().find(x=>x.domain===domain);
  const val=prompt(`Override DA for ${domain}:`,p?.daLive??'');
  if(val===null) return;
  const d=pmData();
  if(!d[domain]) d[domain]={};
  d[domain].daOverride=parseInt(val)||p?.da||0;
  pmSave(d);
  log(`DA override set: ${domain} â†’ DA${d[domain].daOverride}`,'ok');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_toggleBan(domain){
  const d=pmData();
  if(!d[domain]) d[domain]={};
  d[domain].banned=!d[domain].banned;
  pmSave(d);
  log(`${domain} â†’ ${d[domain].banned?'BANNED':'unbanned'}`,'warn');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_addAccount(domain){
  window._pmGuideFocus=PM_BASE.find(p=>p.domain===domain)?.name;
  _pmTab='accounts';
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_addAccountForm(){
  const domain=(document.getElementById('pm-acct-plat')||{value:''}).value;
  const username=(document.getElementById('pm-acct-user')||{value:''}).value.trim();
  const status=(document.getElementById('pm-acct-status')||{value:'active'}).value;
  const notes=(document.getElementById('pm-acct-notes')||{value:''}).value.trim();
  const lastUsed=(document.getElementById('pm-acct-date')||{value:''}).value;
  if(!username){log('Enter a username/email','err');return;}
  const d=pmData();
  if(!d[domain]) d[domain]={};
  if(!d[domain].accounts) d[domain].accounts=[];
  d[domain].accounts.push({username,status,notes,lastUsed,added:today()});
  pmSave(d);
  const platName=PM_BASE.find(p=>p.domain===domain)?.name||domain;
  log(`Account "${username}" added to ${platName}`,'ok');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_toggleAccountStatus(domain,username){
  const d=pmData();
  if(!d[domain]?.accounts) return;
  const acct=d[domain].accounts.find(a=>a.username===username);
  if(acct) acct.status=acct.status==='banned'?'active':'banned';
  pmSave(d);
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_delAccount(domain,username){
  const d=pmData();
  if(!d[domain]?.accounts) return;
  d[domain].accounts=d[domain].accounts.filter(a=>a.username!==username);
  pmSave(d);
  render_platform_manager(document.getElementById('page-platform_manager'));
}

async function pm_scrapeSuggestions(){
  log('Scraping SEO forums for new high-DA platform suggestions...','info');
  const queries=['high DA parasite SEO platforms 2025 site:reddit.com','new free blog sites high authority 2025 site:blackhatworld.com','best web 2.0 sites DA 2025'];
  const found=[];
  for(const q of queries){
    try{
      const resp=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://html.duckduckgo.com/html/?q='+encodeURIComponent(q))}`,{signal:AbortSignal.timeout(10000)});
      const data=await resp.json();
      const html=data.contents||'';
      // Extract domain-like patterns from result snippets
      const matches=html.match(/[a-z0-9-]+\.[a-z]{2,6}/gi)||[];
      const unique=[...new Set(matches)].filter(m=>{
        return m.includes('.')&&!m.includes('duckduckgo')&&!m.includes('google')&&m.length>5&&m.length<40;
      }).slice(0,5);
      unique.forEach(domain=>{
        if(!PM_BASE.find(p=>p.domain===domain)&&!found.find(f=>f.domain===domain)){
          found.push({name:domain.split('.')[0].replace(/-/g,' '),domain,da:65,category:'Suggested',source:'forum-scrape',added:today()});
        }
      });
      log(`Scraped: ${unique.length} potential platforms found`,'ok');
    }catch(e){log(`Scrape failed: ${e.message}`,'warn');}
    await sleep(1000);
  }
  if(found.length){
    const d=pmData();
    if(!d.suggested) d.suggested=[];
    found.forEach(f=>{if(!d.suggested.find(s=>s.domain===f.domain)) d.suggested.push(f);});
    pmSave(d);
    log(`Found ${found.length} new platform suggestions`,'ok');
  } else {
    log('No new platforms found â€” try adding manually','warn');
  }
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_addSuggestion(){
  const name=(document.getElementById('pm-sug-name')||{value:''}).value.trim();
  const domain=(document.getElementById('pm-sug-domain')||{value:''}).value.trim();
  const da=parseInt((document.getElementById('pm-sug-da')||{value:70}).value)||70;
  const category=(document.getElementById('pm-sug-cat')||{value:''}).value.trim();
  if(!name||!domain){log('Enter name and domain','err');return;}
  const d=pmData();
  if(!d.suggested) d.suggested=[];
  d.suggested.push({name,domain,da,category,source:'manual',added:today()});
  pmSave(d);
  log(`Platform suggestion "${name}" added`,'ok');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_approveSuggestion(i){
  const d=pmData();
  const sug=(d.suggested||[])[i];
  if(!sug)return;
  // Add to runtime overrides as a custom entry
  if(!d[sug.domain]) d[sug.domain]={};
  d[sug.domain].daOverride=sug.da;
  d[sug.domain].approved=true;
  d.suggested.splice(i,1);
  pmSave(d);
  log(`Platform "${sug.name}" approved and added`,'ok');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_delSuggestion(i){
  const d=pmData();
  if(d.suggested) d.suggested.splice(i,1);
  pmSave(d);
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_addCustom(){
  const name=prompt('Platform name:');if(!name)return;
  const domain=prompt('Domain (e.g. example.com):');if(!domain)return;
  const da=parseInt(prompt('Estimated DA:','70')||'70');
  const d=pmData();
  if(!d[domain]) d[domain]={};
  d[domain].daOverride=da;d[domain].customName=name;d[domain].custom=true;
  pmSave(d);
  log(`Custom platform "${name}" added (DA${da})`,'ok');
  render_platform_manager(document.getElementById('page-platform_manager'));
}

function pm_export(){
  const plats=pmPlatforms();
  dlCSV('Name,Domain,DA,Trend,LinkType,IndexTime,CWV,JS,Tier,BuiltHere,Banned,Accounts\n'+
    plats.map(p=>`"${p.name}","${p.domain}",${p.daLive},"${p.daTrend}","${p.linkType}","${p.indexLabel}","${p.cwv}",${p.js},${p.tier},${p.usedInBuilds},${p.banned},${(p.accounts||[]).length}`).join('\n'),
    'platform_db.csv');
  log('Platform database exported','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS  v2.0 â€” Full Feature Upgrade
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Session log â€” ring buffer of all log() calls with timestamps â”€â”€
const SESSION_LOG = [];
// Wrap log() to also record into SESSION_LOG ring buffer
(function(){
  const _origLog = log;
  log = function(msg, type='info'){
    SESSION_LOG.push({ ts: new Date().toISOString(), msg, type });
    if(SESSION_LOG.length > 5000) SESSION_LOG.shift();
    _origLog(msg, type);
  };
})();

// â”€â”€ Per-tool rate limits: {tool: delayMs} â”€â”€
const TOOL_RATES = (() => {
  try { return JSON.parse(localStorage.getItem('rf_tool_rates')||'{}'); } catch(e) { return {}; }
})();
function toolDelay(tool) {
  return TOOL_RATES[tool] ?? parseInt(SS.raw('rf_def_delay')||'500');
}
function setToolRate(tool, ms) {
  TOOL_RATES[tool] = parseInt(ms)||500;
  localStorage.setItem('rf_tool_rates', JSON.stringify(TOOL_RATES));
}

// â”€â”€ API health state â”€â”€
const API_HEALTH = (() => {
  try { return JSON.parse(localStorage.getItem('rf_api_health')||'{}'); } catch(e) { return {}; }
})();
function apiHealthSave() { localStorage.setItem('rf_api_health', JSON.stringify(API_HEALTH)); }

// â”€â”€ Multi-profile system â”€â”€
function profiles_list() {
  try { return JSON.parse(localStorage.getItem('rf_profiles')||'[]'); } catch(e) { return []; }
}
function profiles_save(list) { localStorage.setItem('rf_profiles', JSON.stringify(list)); }
function profiles_active() { return localStorage.getItem('rf_active_profile')||'default'; }

// â”€â”€ Theme system â”€â”€
const THEMES = {
  dark: {
    '--win-bg':'#1a1a1a','--win-panel':'#242424','--win-panel2':'#2c2c2c','--win-panel3':'#333333',
    '--win-border':'#404040','--win-border2':'#555555','--win-border-hi':'#666666',
    '--win-btn':'linear-gradient(180deg,#3d3d3d 0%,#2a2a2a 100%)','--win-btn-hover':'linear-gradient(180deg,#4a4a4a 0%,#333333 100%)',
    '--win-btn-active':'linear-gradient(180deg,#222222 0%,#333333 100%)',
    '--text':'#d4d4d4','--text2':'#aaaaaa','--text3':'#777777','--text-hi':'#ffffff','--sel-bg':'#2d5a87'
  },
  light: {
    '--win-bg':'#e8e8e8','--win-panel':'#f4f4f4','--win-panel2':'#ececec','--win-panel3':'#dcdcdc',
    '--win-border':'#cccccc','--win-border2':'#bbbbbb','--win-border-hi':'#aaaaaa',
    '--win-btn':'linear-gradient(180deg,#e0e0e0 0%,#c8c8c8 100%)','--win-btn-hover':'linear-gradient(180deg,#e8e8e8 0%,#d0d0d0 100%)',
    '--win-btn-active':'linear-gradient(180deg,#c0c0c0 0%,#d0d0d0 100%)',
    '--text':'#1a1a1a','--text2':'#444444','--text3':'#888888','--text-hi':'#000000','--sel-bg':'#3a82c4'
  },
  matrix: {
    '--win-bg':'#000800','--win-panel':'#001200','--win-panel2':'#001a00','--win-panel3':'#002200',
    '--win-border':'#003300','--win-border2':'#004400','--win-border-hi':'#005500',
    '--win-btn':'linear-gradient(180deg,#002200 0%,#001100 100%)','--win-btn-hover':'linear-gradient(180deg,#003300 0%,#002200 100%)',
    '--win-btn-active':'linear-gradient(180deg,#000800 0%,#001200 100%)',
    '--text':'#00cc00','--text2':'#009900','--text3':'#005500','--text-hi':'#00ff00','--sel-bg':'#004400'
  },
  slate: {
    '--win-bg':'#0f111a','--win-panel':'#161826','--win-panel2':'#1c1f30','--win-panel3':'#22263a',
    '--win-border':'#2a2f48','--win-border2':'#3a4060','--win-border-hi':'#4a5070',
    '--win-btn':'linear-gradient(180deg,#2a2f48 0%,#1c1f30 100%)','--win-btn-hover':'linear-gradient(180deg,#3a4060 0%,#2a2f48 100%)',
    '--win-btn-active':'linear-gradient(180deg,#111428 0%,#1c1f30 100%)',
    '--text':'#c8cce8','--text2':'#8890bb','--text3':'#555878','--text-hi':'#ffffff','--sel-bg':'#2d4a87'
  }
};
let _currentTheme = localStorage.getItem('rf_theme')||'dark';
function applyTheme(name) {
  _currentTheme = name;
  localStorage.setItem('rf_theme', name);
  const vars = THEMES[name]||THEMES.dark;
  const root = document.documentElement;
  Object.entries(vars).forEach(([k,v]) => root.style.setProperty(k, v));
  log(`Theme â†’ ${name}`, 'ok');
}

// â”€â”€ localStorage usage tracker â”€â”€
function lsUsage() {
  let total = 0;
  for(const k in localStorage) {
    if(!localStorage.hasOwnProperty(k)) continue;
    total += (localStorage[k].length + k.length) * 2; // UTF-16
  }
  const QUOTA = 5 * 1024 * 1024; // 5MB typical
  return { bytes: total, quota: QUOTA, pct: Math.min(100, Math.round((total/QUOTA)*100)) };
}


// â”€â”€ ENHANCED KEYBOARD SHORTCUTS WITH PER-KEY TOGGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Shortcut definitions: [id, keys_display, description, handler_fn, default_enabled]
const SHORTCUTS = [
  ['save_keys',     'Ctrl + S',         'Save all API keys',               ()=>settings_saveAll(),              true],
  ['export_all',    'Ctrl + E',         'Export all data',                 ()=>settings_exportAll(),            true],
  ['test_apis',     'Ctrl + Shift + T', 'Test all APIs',                   ()=>settings_testAll(),              true],
  ['clear_log',     'Ctrl + L',         'Clear activity log',              ()=>clearLog(),                      true],
  ['start_tool',    'Ctrl + Space',     'Start current tool',              ()=>toolbarStart(),                  true],
  ['stop_tool',     'Escape',           'Stop running tool',               ()=>toolbarStop(),                   true],
  ['open_settings', 'Ctrl + P',         'Open Settings',                   ()=>switchPage('settings'),          true],
  ['go_dashboard',  'Ctrl + D',         'Go to Dashboard',                 ()=>switchPage('dashboard'),         true],
  ['go_analytics',  'Ctrl + A',         'Go to Analytics Hub',             ()=>switchPage('analytics'),         true],
  ['go_pdf',        'Ctrl + Shift + F', 'Go to PDF Parasite',              ()=>switchPage('pdf_parasite'),      true],
  ['export_log',    'Ctrl + Shift + L', 'Export session log',              ()=>settings_exportSessionLog(),     false],
  ['undo',          'Ctrl + Z',         'Undo last list operation',         ()=>undoAction(),                    true],
  ['redo',          'Ctrl + Y',         'Redo last undone operation',       ()=>redoAction(),                    true],
  ['switch_1',      'Ctrl + 1-9',       'Switch to nav section 1â€“9',        null,                               true],
];

// Load saved shortcut enable state from localStorage
function sc_enabled(id) {
  const stored = localStorage.getItem('rf_sc_' + id);
  if(stored === null) {
    // Fall back to default
    const def = SHORTCUTS.find(s => s[0] === id);
    return def ? def[4] : true;
  }
  return stored === '1';
}

function sc_setEnabled(id, val) {
  localStorage.setItem('rf_sc_' + id, val ? '1' : '0');
}

function _initKeyboardShortcuts() {
  document.addEventListener('keydown', e => {
    // Skip if typing in input/textarea
    const tag = document.activeElement?.tagName?.toLowerCase();
    if(tag === 'input' || tag === 'textarea' || tag === 'select') {
      // Allow Escape even in inputs
      if(e.key !== 'Escape') return;
    }

    if(e.ctrlKey && e.key==='s' && !e.shiftKey && sc_enabled('save_keys'))        { e.preventDefault(); settings_saveAll(); }
    if(e.ctrlKey && e.key==='e' && !e.shiftKey && sc_enabled('export_all'))       { e.preventDefault(); settings_exportAll(); }
    if(e.ctrlKey && e.shiftKey && e.key==='T'  && sc_enabled('test_apis'))        { e.preventDefault(); settings_testAll(); }
    if(e.ctrlKey && e.key==='l' && !e.shiftKey && sc_enabled('clear_log'))        { e.preventDefault(); clearLog(); }
    if(e.ctrlKey && e.key===' '                 && sc_enabled('start_tool'))      { e.preventDefault(); toolbarStart(); }
    if(e.key==='Escape'                          && sc_enabled('stop_tool'))       { toolbarStop(); }
    if(e.ctrlKey && e.key==='p' && !e.shiftKey  && sc_enabled('open_settings'))   { e.preventDefault(); switchPage('settings'); }
    if(e.ctrlKey && e.key==='d' && !e.shiftKey  && sc_enabled('go_dashboard'))    { e.preventDefault(); switchPage('dashboard'); }
    if(e.ctrlKey && e.key==='a' && !e.shiftKey  && sc_enabled('go_analytics'))    { e.preventDefault(); switchPage('analytics'); }
    if(e.ctrlKey && e.shiftKey && e.key==='F'   && sc_enabled('go_pdf'))          { e.preventDefault(); switchPage('pdf_parasite'); }
    if(e.ctrlKey && e.shiftKey && e.key==='L'   && sc_enabled('export_log'))      { e.preventDefault(); settings_exportSessionLog(); }
    if(e.ctrlKey && !e.shiftKey && e.key==='z'  && sc_enabled('undo'))            { e.preventDefault(); undoAction(); }
    if(e.ctrlKey && (e.key==='y' || (e.shiftKey && e.key==='Z')) && sc_enabled('redo')) { e.preventDefault(); redoAction(); }

    // Section switcher 1â€“9
    if(e.ctrlKey && sc_enabled('switch_1') && e.key >= '1' && e.key <= '9') {
      e.preventDefault();
      const idx = parseInt(e.key) - 1;
      const items = document.querySelectorAll('.nav-item');
      if(items[idx]) items[idx].click();
    }
  });
}

// â”€â”€ SHORTCUTS TAB UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _sShortcutsTab(){
  return `<div>
    <div class="panel">
      <div class="panel-head">âŒ¨ Keyboard Shortcuts
        <div class="ph-r">
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="sc_enableAll()">âœ… Enable All</button>
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="sc_disableAll()">â¬œ Disable All</button>
        </div>
      </div>
      <div class="panel-body" style="padding:0">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr>
            <th style="width:30px">On</th>
            <th>Shortcut</th>
            <th>Action</th>
            <th style="width:60px;text-align:center">Status</th>
          </tr></thead>
          <tbody>
            ${SHORTCUTS.map(([id, keys, desc]) => {
              const enabled = sc_enabled(id);
              return `<tr style="border-bottom:1px solid #1a1a1a;${!enabled?'opacity:0.45':''}">
                <td style="padding:4px 8px;text-align:center">
                  <input type="checkbox" ${enabled?'checked':''} style="width:auto;accent-color:var(--green);cursor:pointer"
                    onchange="sc_setEnabled('${id}',this.checked);render_settings(document.getElementById('page-settings'))">
                </td>
                <td style="padding:5px 10px">
                  <span style="font-family:var(--mono);font-size:11px;font-weight:700;color:${enabled?'var(--green)':'var(--text3)'};background:var(--win-panel2);border:1px solid var(--win-border2);padding:2px 8px;border-radius:2px;white-space:nowrap">${esc(keys)}</span>
                </td>
                <td style="padding:5px 10px;font-size:11px;color:var(--text2)">${esc(desc)}</td>
                <td style="padding:5px 10px;text-align:center">
                  <span class="badge ${enabled?'bg':'bgray'}" style="font-size:8px">${enabled?'ON':'OFF'}</span>
                </td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
        <div style="padding:8px 10px;font-size:9px;color:var(--text3);border-top:1px solid var(--win-border)">
          Shortcut states are saved per-browser. Disabling a shortcut only removes the keyboard trigger â€” buttons still work normally.
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:8px">
      <div class="panel-head">â„¹ï¸ Build Info</div>
      <div class="panel-body">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);line-height:2">
          <div><span style="color:var(--text)">Version:</span> RankForge Pro v9.0 (Global Patterns Edition)</div>
          <div><span style="color:var(--text)">Build Date:</span> ${new Date().toLocaleDateString()}</div>
          <div><span style="color:var(--text)">Engine:</span> Settings v2.0 Â· Campaign v2.0 Â· Proxy v2.0 Â· PDF Parasite v1.0</div>
          <div><span style="color:var(--text)">Functions:</span> ${typeof window==='object'?Object.keys(window).filter(k=>typeof window[k]==='function'&&!['eval','isNaN','isFinite','decodeURI','encodeURI','parseInt','parseFloat','fetch'].includes(k)).length:'â€”'}</div>
          <div><span style="color:var(--text)">Session Log Entries:</span> ${SESSION_LOG.length}</div>
          <div><span style="color:var(--text)">localStorage Keys:</span> ${localStorage.length}</div>
          <div><span style="color:var(--text)">Active Profile:</span> ${profiles_active()}</div>
          <div><span style="color:var(--text)">Theme:</span> ${_currentTheme}</div>
        </div>
        <div class="flex g6" style="margin-top:12px;flex-wrap:wrap">
          <button class="tbtn" onclick="settings_exportSessionLog()">ğŸ“‹ Export Session Log</button>
          <button class="tbtn" onclick="clearLog()">ğŸ—‘ Clear Log Panel</button>
        </div>
      </div>
    </div>
  </div>`;
}

function sc_enableAll() {
  SHORTCUTS.forEach(([id]) => sc_setEnabled(id, true));
  render_settings(document.getElementById('page-settings'));
  log('All keyboard shortcuts enabled', 'ok');
}

function sc_disableAll() {
  SHORTCUTS.forEach(([id]) => sc_setEnabled(id, false));
  render_settings(document.getElementById('page-settings'));
  log('All keyboard shortcuts disabled', 'warn');
}


// Settings tab state
let _sTab = 'keys'; // 'keys'|'health'|'rates'|'profiles'|'appearance'|'data'|'shortcuts'

function render_settings(el){
  const usage = lsUsage();
  const activeProfile = profiles_active();
  const profs = profiles_list();
  const notifEnabled = localStorage.getItem('rf_notif')==='1';
  const theme = _currentTheme;

  el.innerHTML = `
  <!-- TABS -->
  <div style="display:flex;gap:2px;margin-bottom:8px;border-bottom:2px solid var(--win-border);padding-bottom:0;flex-wrap:wrap">
    ${[['keys','ğŸ”‘ API Keys'],['health','ğŸ“¡ API Health'],['rates','â± Rate Limits'],['profiles','ğŸ‘¤ Profiles'],['appearance','ğŸ¨ Appearance'],['data','ğŸ’¾ Data'],['shortcuts','âŒ¨ Shortcuts']].map(([t,l])=>`
    <div onclick="_sTab='${t}';render_settings(document.getElementById('page-settings'))" style="padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px 2px 0 0;margin-bottom:-2px;border:1px solid ${_sTab===t?'var(--win-border)':'transparent'};border-bottom-color:${_sTab===t?'var(--win-panel)':'transparent'};background:${_sTab===t?'var(--win-panel)':'transparent'};color:${_sTab===t?'var(--text-hi)':'var(--text3)'}">${l}</div>
    `).join('')}
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;padding-bottom:4px">
      <span class="badge ${usage.pct>80?'br':usage.pct>50?'by':'bg'}" title="${usage.bytes.toLocaleString()} bytes used">ğŸ’¾ ${usage.pct}% storage</span>
      <span class="badge bb">Profile: ${esc(activeProfile)}</span>
      <span class="badge bgray">Theme: ${theme}</span>
    </div>
  </div>

  ${_sTab==='keys'       ? _sKeysTab()
  : _sTab==='health'     ? _sHealthTab()
  : _sTab==='rates'      ? _sRatesTab()
  : _sTab==='profiles'   ? _sProfilesTab(profs,activeProfile)
  : _sTab==='appearance' ? _sAppearanceTab(theme,notifEnabled)
  : _sTab==='data'       ? _sDataTab(usage)
  :                        _sShortcutsTab()}
  `;
}

// â”€â”€ KEYS TAB â”€â”€
function _sKeysTab(){
  return `<div class="notice ni-b" style="margin-bottom:10px">All keys stored in <b>your browser only</b> (localStorage). Connect Supabase below to sync across devices. Export settings before clearing browser data.</div>
  <div class="g3">
    <div class="panel">
      <div class="panel-head">ğŸŸ¢ Supabase Backend (Real-time Sync)</div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:8px;font-size:10px">Connect Supabase to sync all your data across devices in real-time. <a href="https://supabase.com" target="_blank" style="color:var(--blue)">Free at supabase.com</a> â€” no credit card needed.</div>
        <div class="fg">
          <label class="lbl">Supabase Project URL</label>
          <input type="text" id="s-sb-url" value="${SS.raw('rf_sb_url')}" placeholder="https://xxxx.supabase.co" onchange="SS.rawSet('rf_sb_url',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">Find in: Supabase Dashboard â†’ Project Settings â†’ API â†’ Project URL</div>
        </div>
        <div class="fg">
          <label class="lbl">Supabase Anon Key (public)</label>
          <input type="password" id="s-sb-anon" value="${SS.raw('rf_sb_anon')}" placeholder="eyJhbGciOiJIUzI1NiIs..." onchange="SS.rawSet('rf_sb_anon',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">Find in: Supabase Dashboard â†’ Project Settings â†’ API â†’ anon public key</div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px">
          <button class="tbtn go" onclick="sbInit();render_settings(document.getElementById('page-settings'))">ğŸ”— Connect Supabase</button>
          <button class="tbtn" onclick="sbStatus().then(s=>log('Supabase status: '+s, s==='connected'?'ok':'warn'))">ğŸ“¡ Test Connection</button>
          <button class="tbtn" onclick="sbSyncFromCloud()">â¬‡ Pull from Cloud</button>
          <button class="tbtn" onclick="sbPushAll()">â¬† Push All to Cloud</button>
        </div>
        <div style="margin-top:6px;font-size:10px;color:var(--text3)">Status: <span id="sb-status-lbl" style="color:${_supabaseClient?'var(--green)':'var(--text3)'}">${_supabaseClient?'â— Connected':'â—‹ Not connected'}</span></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ¤– Content & AI</div>
      <div class="panel-body">
        <div class="fg">
          <label class="lbl">Claude API Key <span style="color:var(--green);font-size:9px">âœ¦ Content Gen</span></label>
          <input type="password" id="s-claude" value="${SS.raw('rf_claude_key')}" placeholder="sk-ant-api03-..." onchange="SS.rawSet('rf_claude_key',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">â†’ <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></div>
        </div>
        <div class="fg">
          <label class="lbl">2Captcha / Captcha Key</label>
          <input type="password" id="s-captcha" value="${SS.raw('rf_captcha_key')}" placeholder="Your captcha API key" onchange="SS.rawSet('rf_captcha_key',this.value)"/>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ“Š SEO & Rank</div>
      <div class="panel-body">
        <div class="fg">
          <label class="lbl">SerpAPI Key</label>
          <input type="password" id="s-serpapi" value="${SS.raw('rf_serpapi_key')}" placeholder="Your SerpAPI key" onchange="SS.rawSet('rf_serpapi_key',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">â†’ <a href="https://serpapi.com" target="_blank">serpapi.com</a></div>
        </div>
        <div class="fg">
          <label class="lbl">Open PageRank Key</label>
          <input type="password" id="s-opr" value="${SS.raw('rf_opr_key')}" placeholder="Your OPR key" onchange="SS.rawSet('rf_opr_key',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">â†’ <a href="https://openpagerank.com" target="_blank">openpagerank.com</a></div>
        </div>
        <div class="fg">
          <label class="lbl">WhoisXML API Key</label>
          <input type="password" id="s-whois" value="${SS.raw('rf_whois_key')}" placeholder="Your WhoisXML key" onchange="SS.rawSet('rf_whois_key',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">â†’ <a href="https://whoisxmlapi.com" target="_blank">whoisxmlapi.com</a> (500/mo free)</div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ“¡ Indexing & Defaults</div>
      <div class="panel-body">
        <div class="fg">
          <label class="lbl">IndexNow Key</label>
          <input type="text" id="s-inow" value="${SS.raw('rf_indexnow_key')}" placeholder="Any random string" onchange="SS.rawSet('rf_indexnow_key',this.value)"/>
        </div>
        <div class="fg">
          <label class="lbl">Google Client ID (GSC OAuth)</label>
          <input type="text" id="s-gcid" value="${SS.raw('rf_google_client_id')}" placeholder="Your Google OAuth Client ID" onchange="SS.rawSet('rf_google_client_id',this.value)"/>
        </div>
        <div class="fg">
          <label class="lbl">Custom User Agent <span style="color:var(--text3);font-size:9px">(blank = browser default)</span></label>
          <input type="text" id="s-ua" value="${SS.raw('rf_user_agent')}" placeholder="Mozilla/5.0 (...) Chrome/..." onchange="SS.rawSet('rf_user_agent',this.value)"/>
          <div class="mono xs tm" style="margin-top:2px">Used for fetch requests where applicable</div>
        </div>
        <div class="fg"><label class="lbl">Default Min DA</label><input type="number" value="${SS.raw('rf_def_minda')||70}" min="0" max="100" onchange="SS.rawSet('rf_def_minda',this.value)"/></div>
        <div class="fg"><label class="lbl">Global Request Delay (ms)</label><input type="number" value="${SS.raw('rf_def_delay')||500}" min="50" onchange="SS.rawSet('rf_def_delay',this.value)"/></div>
        <div class="fg"><label class="lbl">Max Threads</label><input type="number" value="${APP.threads}" min="1" max="50" onchange="APP.threads=parseInt(this.value);document.getElementById('thread-val').textContent=this.value;updateStats()"/></div>
      </div>
    </div>
  </div>
  <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">
    <button class="tbtn go" onclick="settings_saveAll()">ğŸ’¾ Save All Keys</button>
    <button class="tbtn" onclick="settings_testAll()">ğŸ”¬ Test All APIs</button>
    <button class="tbtn" onclick="settings_exportJSON()">ğŸ“¤ Export Settings JSON</button>
    <button class="tbtn" onclick="settings_importJSON()">ğŸ“¥ Import Settings JSON</button>
    <button class="tbtn" onclick="settings_exportAll()">ğŸ’¾ Export All Data</button>
    <button class="tbtn stop" onclick="settings_clearAll()">ğŸ—‘ Clear All Data</button>
  </div>`;
}

// â”€â”€ HEALTH TAB â”€â”€
function _sHealthTab(){
  const APIS = [
    {key:'claude',  label:'Claude AI',      keyPref:'rf_claude_key',  url:'https://api.anthropic.com/v1/messages', note:'Content Gen, Comment AI'},
    {key:'opr',     label:'Open PageRank',  keyPref:'rf_opr_key',     url:'https://openpagerank.com/api/v1.0/getPageRank?domains[]=google.com', note:'DA/PA Checker'},
    {key:'serpapi', label:'SerpAPI',        keyPref:'rf_serpapi_key', url:null, note:'SERP Scraper'},
    {key:'whois',   label:'WhoisXML',       keyPref:'rf_whois_key',   url:null, note:'Domain Age'},
    {key:'indexnow',label:'IndexNow',       keyPref:'rf_indexnow_key',url:null, note:'Link Indexer'},
    {key:'captcha', label:'2Captcha',       keyPref:'rf_captcha_key', url:null, note:'Captcha Solver'},
  ];
  return `<div class="panel">
    <div class="panel-head">ğŸ“¡ API Key Health Dashboard
      <div class="ph-r"><button class="tbtn go" style="font-size:9px;padding:1px 6px" onclick="settings_testAll()">ğŸ”¬ Test All Now</button></div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr><th>API</th><th>Key Configured</th><th>Last Tested</th><th>Status</th><th>Latency</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody>${APIS.map(api=>{
          const h = API_HEALTH[api.key]||{};
          const hasKey = !!SS.raw(api.keyPref);
          const status = !hasKey?'no-key':h.status||'untested';
          const statusCol = status==='ok'?'var(--green)':status==='error'?'var(--red)':status==='no-key'?'var(--text3)':'var(--yellow)';
          const statusLabel = status==='ok'?'âœ“ Connected':status==='error'?'âœ— Error':status==='no-key'?'â€” No Key':'? Untested';
          const lastTested = h.lastTested?new Date(h.lastTested).toLocaleString():'Never';
          return `<tr>
            <td style="font-weight:700">${esc(api.label)}</td>
            <td>${hasKey?`<span class="badge bg">âœ“ Set</span>`:`<span class="badge by">âœ— Missing</span>`}</td>
            <td class="mono xs tm">${lastTested}</td>
            <td><span style="font-family:var(--mono);font-size:11px;font-weight:700;color:${statusCol}">${statusLabel}</span>${h.error?`<div style="font-size:9px;color:var(--red);margin-top:2px">${esc(h.error)}</div>`:''}</td>
            <td class="mono xs ${h.latency?'':'tm'}">${h.latency?h.latency+'ms':'â€”'}</td>
            <td class="xs tm">${api.note}</td>
            <td><button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="settings_testOne('${api.key}')">Test</button></td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>
    </div>
  </div>`;
}

// â”€â”€ RATE LIMITS TAB â”€â”€
function _sRatesTab(){
  const TOOLS = [
    ['url_scraper','URL Scraper'],['serp_scraper','SERP Scraper'],['keyword_harvester','Keyword Harvester'],
    ['da_checker','DA/PA Checker'],['domain_age','Domain Age'],['commenter','Blog Commenter'],
    ['link_builder','Link Builder'],['link_indexer','Link Indexer'],['ping_submitter','Ping Submitter'],
    ['campaign','Campaign Runner'],['account_creator','Account Creator'],
  ];
  return `<div class="panel">
    <div class="panel-head">â± Per-Tool Rate Limits
      <div class="ph-r"><button class="tbtn" style="font-size:9px;padding:1px 6px" onclick="settings_resetRates()">â†º Reset All</button></div>
    </div>
    <div class="panel-body">
      <div class="notice ni-b" style="margin-bottom:12px">Set independent request delays per tool. Overrides the global delay for that specific tool. Lower = faster but riskier. Recommended minimums: Scrapers 300ms+, Commenters 800ms+, Indexers 200ms+.</div>
      <div style="display:flex;flex-direction:column;gap:5px">
        ${TOOLS.map(([tool,label])=>{
          const ms=TOOL_RATES[tool]??parseInt(SS.raw('rf_def_delay')||'500');
          const isCustom=TOOL_RATES[tool]!=null;
          return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--win-panel2);border:1px solid ${isCustom?'rgba(57,211,83,.3)':'var(--win-border2)'};border-radius:2px">
            <div style="width:150px;font-size:11px;font-weight:700;color:var(--text)">${label}</div>
            <div style="flex:1">
              <input type="range" min="50" max="5000" step="50" value="${ms}" style="width:100%;height:4px;accent-color:var(--green)"
                oninput="this.nextElementSibling.textContent=this.value+'ms';setToolRate('${tool}',this.value)"/>
            </div>
            <div class="mono xs" style="color:${isCustom?'var(--green)':'var(--text3)'};width:60px;text-align:right">${ms}ms</div>
            ${isCustom?`<button class="tbtn" style="font-size:8px;padding:1px 4px" onclick="delete TOOL_RATES['${tool}'];localStorage.setItem('rf_tool_rates',JSON.stringify(TOOL_RATES));render_settings(document.getElementById('page-settings'))">â†º</button>`:`<div style="width:28px"></div>`}
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

// â”€â”€ PROFILES TAB â”€â”€
function _sProfilesTab(profs, activeProfile){
  return `<div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ‘¤ Multi-Profile Manager
        <div class="ph-r"><span class="badge bg">Active: ${esc(activeProfile)}</span></div>
      </div>
      <div class="panel-body">
        <div class="notice ni-b" style="margin-bottom:10px">Profiles let you switch between client configurations instantly â€” different API keys, campaigns, and settings per profile. Each profile is stored separately.</div>
        <div class="fg"><label class="lbl">New Profile Name</label><input type="text" id="prof-name" placeholder="Client A, Niche Campaign 1..."/></div>
        <div class="flex g6 mt8">
          <button class="tbtn go" onclick="profile_create()">â• Create Profile</button>
          <button class="tbtn" onclick="profile_exportActive()">ğŸ“¤ Export Active</button>
          <button class="tbtn" onclick="profile_importPrompt()">ğŸ“¥ Import Profile</button>
        </div>
        <div style="margin-top:14px;display:flex;flex-direction:column;gap:4px">
          ${[{name:'default',isDefault:true},...profs].map(p=>`
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:${activeProfile===p.name?'rgba(57,211,83,.06)':'var(--win-panel2)'};border:1px solid ${activeProfile===p.name?'rgba(57,211,83,.3)':'var(--win-border2)'};border-radius:2px">
            <div style="flex:1;font-weight:700;color:${activeProfile===p.name?'var(--green)':'var(--text)'}">${esc(p.name)} ${p.isDefault?'<span style="font-size:9px;color:var(--text3);font-weight:400">(built-in)</span>':''}</div>
            ${activeProfile===p.name?`<span class="badge bg">âœ“ Active</span>`:`<button class="tbtn go" style="font-size:9px;padding:1px 6px" onclick="profile_switch('${p.name}')">Switch</button>`}
            ${!p.isDefault?`<button class="tbtn stop" style="font-size:9px;padding:1px 5px" onclick="profile_delete('${p.name}')">âœ•</button>`:''}
          </div>`).join('')}
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">â„¹ï¸ How Profiles Work</div>
      <div class="panel-body">
        <div style="font-size:11px;color:var(--text3);line-height:2">
          <div style="color:var(--text);font-weight:700;margin-bottom:6px">Each profile stores independently:</div>
          ${['API keys (Claude, OPR, SerpAPI, WhoisXML)','Campaign list & run history','URL lists & scraped data','Proxy pools & settings','Comment templates & accounts','Platform overrides & PBN registry','Rate limits & appearance'].map(i=>`<div>Â· ${i}</div>`).join('')}
          <div style="margin-top:10px;color:var(--text);font-weight:700">Switching profiles:</div>
          <div>Saves current profile state, then loads the target profile's data into APP state. Instant switch, no page reload required.</div>
          <div style="margin-top:8px;color:var(--yellow)">âš  Export your active profile before clearing browser data.</div>
        </div>
      </div>
    </div>
  </div>`;
}

// â”€â”€ APPEARANCE TAB â”€â”€
function _sAppearanceTab(theme, notifEnabled){
  return `<div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ¨ Theme</div>
      <div class="panel-body">
        <div style="display:flex;flex-direction:column;gap:6px">
          ${Object.keys(THEMES).map(t=>`
          <div onclick="applyTheme('${t}');render_settings(document.getElementById('page-settings'))" style="cursor:pointer;padding:10px 14px;border-radius:2px;border:2px solid ${theme===t?'var(--green)':'var(--win-border2)'};display:flex;align-items:center;gap:10px;background:${theme===t?'rgba(57,211,83,.04)':'var(--win-panel2)'}">
            <div style="display:flex;gap:3px">
              ${Object.values(THEMES[t]).slice(0,4).map(v=>`<div style="width:12px;height:12px;border-radius:2px;background:${v.startsWith('linear')?'#444':v}"></div>`).join('')}
            </div>
            <div style="flex:1;font-weight:700;text-transform:capitalize">${t}</div>
            ${theme===t?`<span class="badge bg">Active</span>`:''}
          </div>`).join('')}
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ”” Notifications & UX</div>
      <div class="panel-body">
        <div class="fg" style="margin-bottom:12px">
          <label class="lbl" style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" ${notifEnabled?'checked':''} onchange="settings_toggleNotif(this.checked)"/>
            Browser notifications on tool completion
          </label>
          <div class="mono xs tm" style="margin-top:4px">Sends a browser notification when a campaign, scraper, or build run finishes. Requires browser permission.</div>
          ${notifEnabled?'':`<button class="tbtn go" style="margin-top:6px;font-size:10px" onclick="settings_requestNotifPerm()">ğŸ”” Grant Permission</button>`}
        </div>
        <div style="border-top:1px solid var(--win-border);padding-top:10px;margin-top:4px">
          <div class="lbl" style="margin-bottom:8px">Log Panel</div>
          <div class="fg"><label class="lbl">Max Log Entries (ring buffer)</label>
            <input type="number" value="${parseInt(localStorage.getItem('rf_log_max')||'500')}" min="100" max="5000" style="width:100px"
              onchange="localStorage.setItem('rf_log_max',this.value);log('Log max â†’ '+this.value,'ok')"/></div>
        </div>
      </div>
    </div>
  </div>`;
}

// â”€â”€ DATA TAB â”€â”€
function _sDataTab(usage){
  const KEYS_BREAKDOWN = [
    ['rf_urllist','URL List'],['rf_campaigns','Campaigns'],['rf_links','Links Built'],
    ['rf_comments','Comments'],['rf_accounts','Accounts'],['rf_proxies','Proxies'],
    ['rf_url_scraper_results','Scraper Results'],['rf_serp_results','SERP Results'],
    ['rf_da_results','DA Results'],['rf_age_results','Age Results'],
    ['rf_pm_data','Platform Data'],['rf_pbn_domains','PBN Registry'],
    ['rf_prx_domain_hist','Proxy Domain Log'],['rf_api_health','API Health'],
  ];
  const breakdown = KEYS_BREAKDOWN.map(([k,label])=>{
    const v = localStorage.getItem(k)||'';
    const bytes = (v.length+k.length)*2;
    const pct = Math.round((bytes/usage.quota)*100*10)/10;
    return {k, label, bytes, pct};
  }).filter(x=>x.bytes>10).sort((a,b)=>b.bytes-a.bytes);

  return `<div class="g2">
    <div class="panel">
      <div class="panel-head">ğŸ’¾ Storage Usage
        <div class="ph-r"><button class="tbtn stop" style="font-size:9px;padding:1px 6px" onclick="settings_clearAll()">ğŸ—‘ Clear All</button></div>
      </div>
      <div class="panel-body">
        <!-- Overall bar -->
        <div style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span class="mono xs">localStorage Usage</span>
            <span class="mono xs" style="color:${usage.pct>80?'var(--red)':usage.pct>50?'var(--yellow)':'var(--green)'}">${(usage.bytes/1024).toFixed(1)}KB / ${(usage.quota/1024/1024).toFixed(0)}MB (${usage.pct}%)</span>
          </div>
          <div class="prog-wrap" style="height:12px"><div class="prog-fill" style="width:${usage.pct}%;background:${usage.pct>80?'var(--red)':usage.pct>50?'var(--yellow)':'var(--green)'}"></div></div>
        </div>
        <!-- Breakdown -->
        <div style="display:flex;flex-direction:column;gap:3px">
          ${breakdown.map(({k,label,bytes,pct})=>`
          <div style="display:flex;align-items:center;gap:8px">
            <div style="width:120px;font-size:10px;color:var(--text2)">${label}</div>
            <div style="flex:1">
              <div class="prog-wrap" style="margin:0;height:5px"><div class="prog-fill" style="width:${Math.min(100,pct*20)}%"></div></div>
            </div>
            <div class="mono" style="font-size:9px;color:var(--text3);width:60px;text-align:right">${(bytes/1024).toFixed(1)}KB</div>
            <button class="tbtn stop" style="font-size:7px;padding:1px 4px" onclick="if(confirm('Clear ${label}?')){localStorage.removeItem('${k}');render_settings(document.getElementById('page-settings'));log('Cleared ${label}','warn')}">âœ•</button>
          </div>`).join('')}
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">ğŸ“¦ Import / Export</div>
      <div class="panel-body">
        <div style="display:flex;flex-direction:column;gap:6px">
          ${[
            ['ğŸ“¤ Export Settings JSON',   'Export API keys + settings (no campaign data)',  'settings_exportJSON()'],
            ['ğŸ“¥ Import Settings JSON',   'Restore keys + settings from exported JSON',       'settings_importJSON()'],
            ['ğŸ’¾ Export All Data',         'Full backup: campaigns, links, proxies, etc.',     'settings_exportAll()'],
            ['ğŸ“¥ Import All Data',         'Restore from full backup JSON',                   'settings_importAll()'],
            ['ğŸ“‹ Export Session Log',     'Full timestamped run log (current session)',       'settings_exportSessionLog()'],
            ['ğŸ—‘ Clear All Data',          'Wipe everything â€” irreversible',                  'settings_clearAll()','stop'],
          ].map(([label,desc,fn,cls=''])=>`
          <div style="padding:8px 12px;background:var(--win-panel2);border-radius:2px;border:1px solid var(--win-border2)">
            <button class="tbtn ${cls} go" style="margin-bottom:4px;font-size:10px" onclick="${fn}">${label}</button>
            <div class="mono xs tm">${desc}</div>
          </div>`).join('')}
        </div>
      </div>
    </div>
  </div>`;
}


// â”€â”€ FUNCTIONS â”€â”€
function settings_saveAll(){
  const fields=[['rf_claude_key','s-claude'],['rf_captcha_key','s-captcha'],['rf_serpapi_key','s-serpapi'],['rf_opr_key','s-opr'],['rf_whois_key','s-whois'],['rf_indexnow_key','s-inow'],['rf_google_client_id','s-gcid'],['rf_user_agent','s-ua']];
  fields.forEach(([key,id])=>{const el=document.getElementById(id);if(el&&el.value.trim())SS.rawSet(key,el.value.trim());});
  log('All settings saved','ok');
  notify('RankForge Pro','Settings saved âœ“');
}

async function settings_testAll(){
  log('Testing all configured APIs...','info');
  await settings_testOne('claude');
  await settings_testOne('opr');
  log('API test sweep complete','ok');
  notify('RankForge Pro','API test complete');
}

async function settings_testOne(apiKey){
  const h = API_HEALTH[apiKey]||{};
  const t0 = Date.now();
  const update = (status, error=null) => {
    API_HEALTH[apiKey] = { status, lastTested: Date.now(), latency: Date.now()-t0, error };
    apiHealthSave();
  };
  if(apiKey==='claude'){
    const k=SS.raw('rf_claude_key');
    if(!k){log('Claude â€” no key','warn');update('no-key');return;}
    try{
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'x-api-key':k,'anthropic-version':'2023-06-01','Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:5,messages:[{role:'user',content:'Hi'}]}),signal:AbortSignal.timeout(8000)});
      if(r.ok){log(`Claude âœ“ â€” ${Date.now()-t0}ms`,'ok');update('ok');}
      else{const e=await r.json();log(`Claude âœ— â€” ${e.error?.message||r.status}`,'err');update('error',e.error?.message||String(r.status));}
    }catch(e){log(`Claude âœ— â€” ${e.message}`,'err');update('error',e.message);}
  } else if(apiKey==='opr'){
    const k=SS.raw('rf_opr_key');
    if(!k){log('OPR â€” no key','warn');update('no-key');return;}
    try{
      const r=await fetch('https://openpagerank.com/api/v1.0/getPageRank?domains[]=google.com',{headers:{'API-OPR':k},signal:AbortSignal.timeout(6000)});
      if(r.ok){log(`Open PageRank âœ“ â€” ${Date.now()-t0}ms`,'ok');update('ok');}
      else{log(`OPR âœ— â€” ${r.status}`,'err');update('error',String(r.status));}
    }catch(e){log(`OPR âœ— â€” ${e.message}`,'err');update('error',e.message);}
  } else {
    log(`${apiKey} â€” manual test not available (no public test endpoint)`,'warn');
    update('untested');
  }
  if(document.getElementById('page-settings')?.classList.contains('active')){
    render_settings(document.getElementById('page-settings'));
  }
}

function settings_exportJSON(){
  const cfg={
    version:'rf-v8',
    exported:new Date().toISOString(),
    profile:profiles_active(),
    apiKeys:{
      claude:SS.raw('rf_claude_key'),
      captcha:SS.raw('rf_captcha_key'),
      serpapi:SS.raw('rf_serpapi_key'),
      opr:SS.raw('rf_opr_key'),
      whois:SS.raw('rf_whois_key'),
      indexnow:SS.raw('rf_indexnow_key'),
      gcid:SS.raw('rf_google_client_id'),
      userAgent:SS.raw('rf_user_agent'),
    },
    defaults:{
      minDA:SS.raw('rf_def_minda'),
      delay:SS.raw('rf_def_delay'),
      threads:APP.threads,
    },
    toolRates:TOOL_RATES,
    proxyStrategy:window.PRX_STRATEGY,
    proxyToolPools:window.PRX_TOOL_POOLS,
    theme:_currentTheme,
    notif:localStorage.getItem('rf_notif'),
    logMax:localStorage.getItem('rf_log_max'),
  };
  dlTxt(JSON.stringify(cfg,null,2),`rankforge_settings_${profiles_active()}_${new Date().toISOString().slice(0,10)}.json`);
  log('Settings exported as JSON','ok');
}

function settings_importJSON(){
  const input=document.createElement('input');
  input.type='file';input.accept='.json';
  input.onchange=async e=>{
    const file=e.target.files[0];if(!file)return;
    const text=await file.text();
    try{
      const cfg=JSON.parse(text);
      if(cfg.apiKeys){
        if(cfg.apiKeys.claude)    SS.rawSet('rf_claude_key',cfg.apiKeys.claude);
        if(cfg.apiKeys.captcha)   SS.rawSet('rf_captcha_key',cfg.apiKeys.captcha);
        if(cfg.apiKeys.serpapi)   SS.rawSet('rf_serpapi_key',cfg.apiKeys.serpapi);
        if(cfg.apiKeys.opr)       SS.rawSet('rf_opr_key',cfg.apiKeys.opr);
        if(cfg.apiKeys.whois)     SS.rawSet('rf_whois_key',cfg.apiKeys.whois);
        if(cfg.apiKeys.indexnow)  SS.rawSet('rf_indexnow_key',cfg.apiKeys.indexnow);
        if(cfg.apiKeys.gcid)      SS.rawSet('rf_google_client_id',cfg.apiKeys.gcid);
        if(cfg.apiKeys.userAgent) SS.rawSet('rf_user_agent',cfg.apiKeys.userAgent);
      }
      if(cfg.defaults){
        if(cfg.defaults.minDA)   SS.rawSet('rf_def_minda',cfg.defaults.minDA);
        if(cfg.defaults.delay)   SS.rawSet('rf_def_delay',cfg.defaults.delay);
        if(cfg.defaults.threads) APP.threads=parseInt(cfg.defaults.threads)||5;
      }
      if(cfg.toolRates)      Object.assign(TOOL_RATES,cfg.toolRates),localStorage.setItem('rf_tool_rates',JSON.stringify(TOOL_RATES));
      if(cfg.proxyStrategy)  window.PRX_STRATEGY=cfg.proxyStrategy,localStorage.setItem('rf_prx_strategy',cfg.proxyStrategy);
      if(cfg.theme)          applyTheme(cfg.theme);
      if(cfg.notif)          localStorage.setItem('rf_notif',cfg.notif);
      log(`Settings imported from "${file.name}" (profile: ${cfg.profile||'unknown'})`,'ok');
      render_settings(document.getElementById('page-settings'));
    }catch(err){log(`Import failed: ${err.message}`,'err');}
  };
  input.click();
}

function settings_exportAll(){
  const data={
    version:'rf-v8',exported:new Date().toISOString(),
    urlList:APP.urlList,campaigns:APP.campaigns,links:APP.links,
    comments:APP.comments,accounts:APP.accounts,proxies:APP.proxies,
    platformData:JSON.parse(localStorage.getItem('rf_pm_data')||'{}'),
    pbnDomains:JSON.parse(localStorage.getItem('rf_pbn_domains')||'[]'),
    campTemplates:JSON.parse(localStorage.getItem('rf_camp_templates')||'[]'),
    abTests:JSON.parse(localStorage.getItem('rf_ab_tests')||'[]'),
  };
  dlTxt(JSON.stringify(data,null,2),`rankforge_backup_${new Date().toISOString().slice(0,10)}.json`);
  log('Full data backup exported','ok');
}

function settings_importAll(){
  const input=document.createElement('input');
  input.type='file';input.accept='.json';
  input.onchange=async e=>{
    const file=e.target.files[0];if(!file)return;
    const text=await file.text();
    try{
      const data=JSON.parse(text);
      if(data.urlList)    {APP.urlList=data.urlList;    SS.set('rf_urllist',data.urlList);}
      if(data.campaigns)  {APP.campaigns=data.campaigns; SS.set('rf_campaigns',data.campaigns);}
      if(data.links)      {APP.links=data.links;         SS.set('rf_links',data.links);}
      if(data.comments)   {APP.comments=data.comments;   SS.set('rf_comments',data.comments);}
      if(data.accounts)   {APP.accounts=data.accounts;   SS.set('rf_accounts',data.accounts);}
      if(data.proxies)    {APP.proxies=data.proxies;     SS.set('rf_proxies',data.proxies);}
      if(data.platformData)  localStorage.setItem('rf_pm_data',JSON.stringify(data.platformData));
      if(data.pbnDomains)    localStorage.setItem('rf_pbn_domains',JSON.stringify(data.pbnDomains));
      if(data.campTemplates) localStorage.setItem('rf_camp_templates',JSON.stringify(data.campTemplates));
      if(data.abTests)       localStorage.setItem('rf_ab_tests',JSON.stringify(data.abTests));
      updateStats();
      log(`Full backup imported from "${file.name}"`, 'ok');
      notify('RankForge Pro','Data import complete âœ“');
    }catch(err){log(`Import failed: ${err.message}`,'err');}
  };
  input.click();
}

function settings_exportSessionLog(){
  const lines=SESSION_LOG.map(e=>`[${e.ts}] [${e.type.toUpperCase()}] ${e.msg}`).join('\n');
  dlTxt(lines,`rankforge_session_log_${new Date().toISOString().slice(0,16).replace(':','-')}.txt`);
  log(`Session log exported â€” ${SESSION_LOG.length} entries`,'ok');
}

function settings_clearAll(){
  if(!confirm('Clear ALL data? This cannot be undone.')) return;
  ['rf_urllist','rf_campaigns','rf_links','rf_comments','rf_accounts','rf_proxies',
   'rf_url_scraper_results','rf_serp_results','rf_kw_results','rf_sitemap_results',
   'rf_da_results','rf_age_results','rf_robots_results','rf_alive_results',
   'rf_idx_results','rf_ping_results','rf_gsc_results','rf_footprints','rf_spin_variants',
   'rf_pm_data','rf_pbn_domains','rf_camp_templates','rf_ab_tests','rf_api_health',
   'rf_prx_domain_hist','rf_prx_fail_counts','rf_tool_rates',
  ].forEach(k=>localStorage.removeItem(k));
  APP.urlList=[];APP.campaigns=[];APP.links=[];APP.comments=[];APP.accounts=[];APP.proxies=[];
  updateStats();
  log('All data cleared','warn');
  render_settings(document.getElementById('page-settings'));
}

function settings_resetRates(){
  Object.keys(TOOL_RATES).forEach(k=>delete TOOL_RATES[k]);
  localStorage.setItem('rf_tool_rates',JSON.stringify(TOOL_RATES));
  log('All tool rate limits reset to global default','ok');
  render_settings(document.getElementById('page-settings'));
}

function settings_toggleNotif(enabled){
  localStorage.setItem('rf_notif', enabled?'1':'0');
  if(enabled) settings_requestNotifPerm();
  log(`Browser notifications ${enabled?'enabled':'disabled'}`,'ok');
}

function settings_requestNotifPerm(){
  if(!('Notification' in window)){log('Browser notifications not supported','warn');return;}
  Notification.requestPermission().then(p=>{
    log(`Notification permission: ${p}`,'ok');
    render_settings(document.getElementById('page-settings'));
  });
}

function notify(title, body){
  if(localStorage.getItem('rf_notif')!=='1') return;
  if(!('Notification' in window)) return;
  if(Notification.permission==='granted'){
    new Notification(title,{body,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect width="16" height="16" rx="2" fill="%2339d353"/><text x="8" y="12" text-anchor="middle" font-size="10" fill="white">âš¡</text></svg>'});
  }
}

// â”€â”€ PROFILES â”€â”€
function profile_create(){
  const name=(document.getElementById('prof-name')||{value:''}).value.trim();
  if(!name){log('Enter profile name','err');return;}
  const profs=profiles_list();
  if(profs.find(p=>p.name===name)){log('Profile name already exists','warn');return;}
  // Save current state into new profile slot
  profile_saveActive();
  profs.push({name, created:today()});
  profiles_save(profs);
  localStorage.setItem('rf_active_profile', name);
  log(`Profile "${name}" created and activated`,'ok');
  render_settings(document.getElementById('page-settings'));
}

function profile_saveActive(){
  const key='rf_prof_'+profiles_active();
  const snap={
    apiKeys:{
      claude:SS.raw('rf_claude_key'),captcha:SS.raw('rf_captcha_key'),
      serpapi:SS.raw('rf_serpapi_key'),opr:SS.raw('rf_opr_key'),
      whois:SS.raw('rf_whois_key'),indexnow:SS.raw('rf_indexnow_key'),gcid:SS.raw('rf_google_client_id'),
    },
    campaigns:APP.campaigns, links:APP.links, urlList:APP.urlList,
    comments:APP.comments, accounts:APP.accounts, proxies:APP.proxies,
    toolRates:TOOL_RATES,
  };
  localStorage.setItem(key, JSON.stringify(snap));
}

function profile_switch(name){
  profile_saveActive(); // save current
  // Load target
  const key='rf_prof_'+name;
  const snap=JSON.parse(localStorage.getItem(key)||'{}');
  if(snap.apiKeys){
    if(snap.apiKeys.claude)  SS.rawSet('rf_claude_key',snap.apiKeys.claude);
    if(snap.apiKeys.serpapi) SS.rawSet('rf_serpapi_key',snap.apiKeys.serpapi);
    if(snap.apiKeys.opr)     SS.rawSet('rf_opr_key',snap.apiKeys.opr);
    if(snap.apiKeys.whois)   SS.rawSet('rf_whois_key',snap.apiKeys.whois);
  }
  if(snap.campaigns) {APP.campaigns=snap.campaigns; SS.set('rf_campaigns',snap.campaigns);}
  if(snap.links)     {APP.links=snap.links;         SS.set('rf_links',snap.links);}
  if(snap.urlList)   {APP.urlList=snap.urlList;     SS.set('rf_urllist',snap.urlList);}
  if(snap.proxies)   {APP.proxies=snap.proxies;     SS.set('rf_proxies',snap.proxies);}
  if(snap.toolRates) Object.assign(TOOL_RATES,snap.toolRates),localStorage.setItem('rf_tool_rates',JSON.stringify(TOOL_RATES));
  localStorage.setItem('rf_active_profile', name);
  updateStats();
  log(`Switched to profile "${name}"`, 'ok');
  notify('RankForge Pro', `Profile switched to "${name}"`);
  render_settings(document.getElementById('page-settings'));
}

function profile_delete(name){
  if(!confirm(`Delete profile "${name}"? This cannot be undone.`)) return;
  const profs=profiles_list().filter(p=>p.name!==name);
  profiles_save(profs);
  localStorage.removeItem('rf_prof_'+name);
  if(profiles_active()===name) localStorage.setItem('rf_active_profile','default');
  log(`Profile "${name}" deleted`,'warn');
  render_settings(document.getElementById('page-settings'));
}

function profile_exportActive(){
  profile_saveActive();
  const key='rf_prof_'+profiles_active();
  const snap=localStorage.getItem(key)||'{}';
  dlTxt(snap, `rankforge_profile_${profiles_active()}_${new Date().toISOString().slice(0,10)}.json`);
  log(`Profile "${profiles_active()}" exported`,'ok');
}

function profile_importPrompt(){
  const input=document.createElement('input');
  input.type='file';input.accept='.json';
  input.onchange=async e=>{
    const file=e.target.files[0];if(!file)return;
    const text=await file.text();
    const name=prompt('Name for imported profile:',file.name.replace('.json',''));
    if(!name)return;
    localStorage.setItem('rf_prof_'+name, text);
    const profs=profiles_list();
    if(!profs.find(p=>p.name===name)) profs.push({name,created:today()});
    profiles_save(profs);
    log(`Profile "${name}" imported`,'ok');
    render_settings(document.getElementById('page-settings'));
  };
  input.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// GLOBAL PATTERNS v1.0
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSION & STATE: Undo/Redo for list operations
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UNDO_STACK = [];
const REDO_STACK = [];
const UNDO_MAX = 50;

function undoPush(label='operation'){
  UNDO_STACK.push({ label, urlList:[...APP.urlList], ts:Date.now() });
  if(UNDO_STACK.length > UNDO_MAX) UNDO_STACK.shift();
  REDO_STACK.length = 0; // clear redo on new action
  _undoUpdateUI();
}

function undoAction(){
  if(!UNDO_STACK.length){ log('Nothing to undo','warn'); return; }
  const snap = UNDO_STACK.pop();
  REDO_STACK.push({ label:'redo', urlList:[...APP.urlList], ts:Date.now() });
  APP.urlList = snap.urlList;
  SS.set('rf_urllist', APP.urlList);
  updateStats();
  // Refresh list_manager if visible
  if(APP.currentPage==='list_manager'){
    const el=document.getElementById('page-list_manager');
    if(el) render_list_manager(el);
  }
  log(`â†© Undo: restored list before "${snap.label}" (${APP.urlList.length} URLs)`,'ok');
  _undoUpdateUI();
}

function redoAction(){
  if(!REDO_STACK.length){ log('Nothing to redo','warn'); return; }
  const snap = REDO_STACK.pop();
  UNDO_STACK.push({ label:'redo-forward', urlList:[...APP.urlList], ts:Date.now() });
  APP.urlList = snap.urlList;
  SS.set('rf_urllist', APP.urlList);
  updateStats();
  if(APP.currentPage==='list_manager'){
    const el=document.getElementById('page-list_manager');
    if(el) render_list_manager(el);
  }
  log(`â†ª Redo: restored list (${APP.urlList.length} URLs)`,'ok');
  _undoUpdateUI();
}

function _undoUpdateUI(){
  // Update undo/redo indicators in status bar if they exist
  const ui = document.getElementById('undo-status');
  if(ui) ui.textContent = `â†©${UNDO_STACK.length} â†ª${REDO_STACK.length}`;
}

// Patch lm_save to push undo before save
const _origLmSave = window.lm_save;
window.lm_save = function(){
  undoPush('manual-save');
  if(typeof _origLmSave==='function') _origLmSave();
  else {
    const ta=document.getElementById('url-list-ta');
    if(!ta)return;
    APP.urlList=ta.value.split('\n').map(u=>u.trim()).filter(Boolean);
    SS.set('rf_urllist',APP.urlList);
    updateStats();
    log(`List saved â€” ${APP.urlList.length} URLs`,'ok');
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSION & STATE: Session restore after crash
// Saves in-progress run state every 10 items processed
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SESSION_STATE_KEY = 'rf_session_state';
let _sessionSaveCounter = 0;
const SESSION_SAVE_EVERY = 10; // save every N items

function sessionStateSave(toolId, extra={}){
  const state = {
    ts: Date.now(),
    toolId,
    currentPage: APP.currentPage,
    processed: APP.stats.processed,
    success: APP.stats.success,
    failed: APP.stats.failed,
    running: APP.running,
    ...extra
  };
  try{ localStorage.setItem(SESSION_STATE_KEY, JSON.stringify(state)); }catch(e){}
}

function sessionStateGet(){
  try{ return JSON.parse(localStorage.getItem(SESSION_STATE_KEY)||'null'); }catch(e){ return null; }
}

function sessionStateClear(){
  localStorage.removeItem(SESSION_STATE_KEY);
}

function sessionCheckCrash(){
  const s = sessionStateGet();
  if(!s) return;
  const age = Date.now()-s.ts;
  if(s.running && age < 3600000){ // was running within last hour
    const mins = Math.floor(age/60000);
    log(`âš  Crash detected: "${s.toolId}" was running ${mins}m ago (${s.processed} processed, ${s.success} ok, ${s.failed} failed). You may have lost progress.`,'warn');
  } else {
    sessionStateClear();
  }
}

// Hook into the progress tracker to auto-save every N items
const _origSetProgress = window.setProgress;
window.setProgress = function(pct, label){
  if(typeof _origSetProgress==='function') _origSetProgress(pct, label);
  _sessionSaveCounter++;
  if(_sessionSaveCounter % SESSION_SAVE_EVERY === 0 && APP.running){
    sessionStateSave(APP.currentPage);
  }
};

// Mark session as safely closed when stopped/done
const _origToolbarStop = window.toolbarStop;
window.toolbarStop = function(){
  if(typeof _origToolbarStop==='function') _origToolbarStop();
  sessionStateClear();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSION & STATE: Tab/page state persistence
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pageStateSave(){
  try{ localStorage.setItem('rf_last_page', APP.currentPage); }catch(e){}
}

function pageStateRestore(){
  try{
    const last = localStorage.getItem('rf_last_page');
    if(last && PAGE_IDS.includes(last)) return last;
  }catch(e){}
  return 'url_scraper';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSION & STATE: Multi-tab safe locking
// Prevents two tabs from running the same tool simultaneously
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TAB_ID = 'tab_' + Math.random().toString(36).slice(2,10);
const TAB_LOCK_KEY = 'rf_tab_lock';
let _tabLockInterval = null;

function tabLockAcquire(toolId){
  try{
    const lock = JSON.parse(localStorage.getItem(TAB_LOCK_KEY)||'{}');
    const existing = lock[toolId];
    if(existing && existing.tabId !== TAB_ID && Date.now()-existing.ts < 10000){
      log(`â›” Tool "${toolId}" is already running in another tab (tab: ${existing.tabId.slice(0,12)}). Please stop it first.`,'err');
      return false;
    }
    lock[toolId] = { tabId: TAB_ID, ts: Date.now() };
    localStorage.setItem(TAB_LOCK_KEY, JSON.stringify(lock));
    // Heartbeat: renew lock every 5s
    if(_tabLockInterval) clearInterval(_tabLockInterval);
    _tabLockInterval = setInterval(()=>{
      if(!APP.running){ tabLockRelease(toolId); return; }
      try{
        const l2=JSON.parse(localStorage.getItem(TAB_LOCK_KEY)||'{}');
        l2[toolId]={tabId:TAB_ID, ts:Date.now()};
        localStorage.setItem(TAB_LOCK_KEY, JSON.stringify(l2));
      }catch(e){}
    }, 5000);
    return true;
  }catch(e){ return true; } // fail open
}

function tabLockRelease(toolId){
  try{
    if(_tabLockInterval){ clearInterval(_tabLockInterval); _tabLockInterval=null; }
    const lock = JSON.parse(localStorage.getItem(TAB_LOCK_KEY)||'{}');
    if(lock[toolId]&&lock[toolId].tabId===TAB_ID) delete lock[toolId];
    localStorage.setItem(TAB_LOCK_KEY, JSON.stringify(lock));
  }catch(e){}
}

window.addEventListener('beforeunload',()=>{
  // Release all locks on close
  try{
    const lock=JSON.parse(localStorage.getItem(TAB_LOCK_KEY)||'{}');
    Object.keys(lock).forEach(k=>{ if(lock[k].tabId===TAB_ID) delete lock[k]; });
    localStorage.setItem(TAB_LOCK_KEY, JSON.stringify(lock));
  }catch(e){}
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANALYTICS & REPORTING: Global run history log
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RUN_HISTORY_KEY = 'rf_run_history';
const RUN_HISTORY_MAX = 500;

function runHistoryGet(){
  try{ return JSON.parse(localStorage.getItem(RUN_HISTORY_KEY)||'[]'); }catch(e){ return []; }
}

function runHistoryAdd(toolId, inputCount, successCount, failCount, extra={}){
  const history = runHistoryGet();
  history.unshift({
    ts: Date.now(),
    date: new Date().toISOString().slice(0,10),
    time: new Date().toTimeString().slice(0,8),
    toolId,
    inputCount,
    successCount,
    failCount,
    successRate: inputCount>0 ? Math.round(successCount/inputCount*100) : 0,
    duration: extra.duration||0,
    ...extra
  });
  if(history.length > RUN_HISTORY_MAX) history.splice(RUN_HISTORY_MAX);
  try{ localStorage.setItem(RUN_HISTORY_KEY, JSON.stringify(history)); }catch(e){}
}

function runHistoryClear(){
  localStorage.removeItem(RUN_HISTORY_KEY);
  log('Run history cleared','ok');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANALYTICS & REPORTING: ROI Tracker
// links built â†’ indexed â†’ ranking â†’ estimated traffic
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROI_KEY = 'rf_roi_data';

function roiGet(){ try{ return JSON.parse(localStorage.getItem(ROI_KEY)||'{}'); }catch(e){ return {}; } }
function roiSave(d){ try{ localStorage.setItem(ROI_KEY, JSON.stringify(d)); }catch(e){} }

function roiTrackLink(url, campaign=''){
  const d = roiGet();
  if(!d.links) d.links = [];
  d.links.push({ url, campaign, builtTs:Date.now(), indexed:false, indexedTs:null, ranking:null, traffic:0 });
  roiSave(d);
}

function roiMarkIndexed(url){
  const d = roiGet();
  if(!d.links) return;
  const link = d.links.find(l=>l.url===url);
  if(link){ link.indexed=true; link.indexedTs=Date.now(); roiSave(d); }
}

function roiUpdateRanking(url, position, estimatedTraffic=0){
  const d = roiGet();
  if(!d.links) return;
  const link = d.links.find(l=>l.url===url);
  if(link){ link.ranking=position; link.traffic=estimatedTraffic; link.rankTs=Date.now(); roiSave(d); }
}

function roiSummary(){
  const d = roiGet();
  const links = d.links||[];
  const built = links.length;
  const indexed = links.filter(l=>l.indexed).length;
  const ranked = links.filter(l=>l.ranking!==null&&l.ranking<=100).length;
  const topRanked = links.filter(l=>l.ranking!==null&&l.ranking<=10).length;
  const totalTraffic = links.reduce((sum,l)=>sum+(l.traffic||0),0);
  return { built, indexed, ranked, topRanked, totalTraffic,
    indexRate: built>0?Math.round(indexed/built*100):0,
    rankRate: indexed>0?Math.round(ranked/indexed*100):0 };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANALYTICS & REPORTING: Platform heatmap data
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HEATMAP_KEY = 'rf_platform_heatmap';

function heatmapGet(){ try{ return JSON.parse(localStorage.getItem(HEATMAP_KEY)||'{}'); }catch(e){ return {}; } }
function heatmapSave(d){ try{ localStorage.setItem(HEATMAP_KEY, JSON.stringify(d)); }catch(e){} }

function heatmapRecord(platform, templateName, outcome){ // outcome: 'success'|'fail'|'skip'
  const d = heatmapGet();
  const k = `${platform}||${templateName}`;
  if(!d[k]) d[k] = {platform, templateName, success:0, fail:0, skip:0, lastTs:0};
  d[k][outcome] = (d[k][outcome]||0)+1;
  d[k].lastTs = Date.now();
  heatmapSave(d);
}

function heatmapTopPerformers(n=10){
  const d = heatmapGet();
  return Object.values(d)
    .map(r=>({...r, total:r.success+r.fail, rate: r.success+r.fail>0?Math.round(r.success/(r.success+r.fail)*100):0}))
    .sort((a,b)=>b.rate-a.rate || b.success-a.success)
    .slice(0,n);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANALYTICS & REPORTING: Weekly summary report generator
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateWeeklySummary(){
  const history = runHistoryGet();
  const roi = roiSummary();
  const heatmap = heatmapTopPerformers(5);
  const now2 = new Date();
  const weekAgo = Date.now() - 7*86400000;
  const weekRuns = history.filter(r=>r.ts>weekAgo);
  const byTool = {};
  weekRuns.forEach(r=>{
    if(!byTool[r.toolId]) byTool[r.toolId]={runs:0,success:0,fail:0};
    byTool[r.toolId].runs++;
    byTool[r.toolId].success+=r.successCount||0;
    byTool[r.toolId].fail+=r.failCount||0;
  });
  const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"/>
<title>RankForge Weekly Summary â€” ${now2.toDateString()}</title>
<style>body{font-family:Arial,sans-serif;background:#111;color:#ddd;max-width:900px;margin:40px auto;padding:20px}
h1{color:#39d353;font-size:22px}h2{color:#4a9ede;font-size:14px;margin-top:20px;border-bottom:1px solid #333;padding-bottom:4px}
table{width:100%;border-collapse:collapse;margin:8px 0;font-size:12px}th{background:#222;padding:6px;text-align:left;color:#aaa}
td{padding:5px 6px;border-bottom:1px solid #222}.ok{color:#39d353}.warn{color:#e8b84b}.err{color:#e05252}
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
.stat-box{background:#1a1a1a;border:1px solid #333;border-radius:4px;padding:10px;text-align:center}
.stat-v{font-size:24px;font-weight:700;color:#39d353}.stat-l{font-size:11px;color:#777;margin-top:3px}</style>
</head><body>
<h1>âš¡ RankForge Pro â€” Weekly Summary</h1>
<p style="color:#555;font-size:12px">Generated: ${now2.toLocaleString()} Â· Week ending ${now2.toDateString()}</p>
<h2>ğŸ“Š ROI Overview</h2>
<div class="stat-grid">
  <div class="stat-box"><div class="stat-v">${roi.built}</div><div class="stat-l">Links Built</div></div>
  <div class="stat-box"><div class="stat-v">${roi.indexed}</div><div class="stat-l">Indexed (${roi.indexRate}%)</div></div>
  <div class="stat-box"><div class="stat-v">${roi.ranked}</div><div class="stat-l">Ranking Top 100</div></div>
  <div class="stat-box"><div class="stat-v">${roi.totalTraffic}</div><div class="stat-l">Est. Traffic</div></div>
</div>
<h2>ğŸ”§ Tool Activity This Week (${weekRuns.length} runs)</h2>
<table><thead><tr><th>Tool</th><th>Runs</th><th>Success</th><th>Failed</th><th>Rate</th></tr></thead><tbody>
${Object.entries(byTool).map(([tool,s])=>`<tr><td>${tool.replace(/_/g,' ')}</td><td>${s.runs}</td><td class="ok">${s.success}</td><td class="err">${s.fail}</td><td class="${s.success/(s.success+s.fail||1)>.7?'ok':'warn'}">${Math.round(s.success/(s.success+s.fail||1)*100)}%</td></tr>`).join('')||'<tr><td colspan="5" style="color:#555">No runs recorded this week</td></tr>'}
</tbody></table>
<h2>ğŸ† Top Performing Platforms</h2>
<table><thead><tr><th>Platform</th><th>Template</th><th>Success</th><th>Fail</th><th>Rate</th></tr></thead><tbody>
${heatmap.map(r=>`<tr><td>${r.platform}</td><td>${r.templateName}</td><td class="ok">${r.success}</td><td class="err">${r.fail}</td><td class="${r.rate>70?'ok':'warn'}">${r.rate}%</td></tr>`).join('')||'<tr><td colspan="5" style="color:#555">No platform data yet</td></tr>'}
</tbody></table>
<h2>ğŸ“œ Recent Run Log (last 20)</h2>
<table><thead><tr><th>Date</th><th>Time</th><th>Tool</th><th>Input</th><th>Success</th><th>Failed</th><th>Rate</th></tr></thead><tbody>
${history.slice(0,20).map(r=>`<tr><td>${r.date}</td><td>${r.time}</td><td>${(r.toolId||'').replace(/_/g,' ')}</td><td>${r.inputCount||0}</td><td class="ok">${r.successCount||0}</td><td class="err">${r.failCount||0}</td><td class="${(r.successRate||0)>70?'ok':'warn'}">${r.successRate||0}%</td></tr>`).join('')||'<tr><td colspan="7" style="color:#555">No history</td></tr>'}
</tbody></table>
</body></html>`;
  const blob = new Blob([html],{type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `rankforge_weekly_${now2.toISOString().slice(0,10)}.html`;
  a.click();
  log('Weekly summary report downloaded','ok');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WORKFLOW AUTOMATION: Batch job queue
// Queue multiple runs to execute sequentially
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BATCH_QUEUE = [];
let _batchRunning = false;

function batchEnqueue(toolId, label=''){
  BATCH_QUEUE.push({ toolId, label: label||toolId, queuedTs:Date.now(), status:'pending' });
  log(`[Queue] Added "${label||toolId}" â€” ${BATCH_QUEUE.length} jobs queued`,'ok');
  _renderBatchPanel();
}

function batchStart(){
  if(_batchRunning){ log('Batch already running','warn'); return; }
  if(!BATCH_QUEUE.length){ log('Batch queue is empty','warn'); return; }
  _batchRunning = true;
  log(`â–¶ Batch queue started â€” ${BATCH_QUEUE.length} jobs`,'ok');
  _batchRunNext();
}

function _batchRunNext(){
  const job = BATCH_QUEUE.find(j=>j.status==='pending');
  if(!job){ _batchRunning=false; log('âœ… Batch queue complete','ok'); runHistoryAdd('batch_queue', BATCH_QUEUE.length, BATCH_QUEUE.filter(j=>j.status==='done').length, BATCH_QUEUE.filter(j=>j.status==='failed').length); return; }
  job.status = 'running';
  job.startTs = Date.now();
  log(`[Queue] Running job: ${job.label}`,'info');
  switchPage(job.toolId);
  setTimeout(()=>{
    const fn = window['start_'+job.toolId];
    if(typeof fn==='function'){
      // Monkey-patch to detect completion: poll APP.running
      fn();
      const poll = setInterval(()=>{
        if(!APP.running){
          clearInterval(poll);
          job.status='done';
          job.endTs=Date.now();
          log(`[Queue] âœ… Completed: ${job.label}`,'ok');
          _renderBatchPanel();
          setTimeout(_batchRunNext, 1500);
        }
      },2000);
    } else {
      job.status='failed';
      log(`[Queue] âš  No start handler for "${job.toolId}" â€” skipping`,'warn');
      _renderBatchPanel();
      setTimeout(_batchRunNext, 500);
    }
  },800);
}

function batchClear(){ BATCH_QUEUE.length=0; _batchRunning=false; log('Batch queue cleared','ok'); _renderBatchPanel(); }

function _renderBatchPanel(){
  const el = document.getElementById('batch-queue-panel');
  if(!el) return;
  el.innerHTML = BATCH_QUEUE.length===0 ? '<span style="color:var(--text3);font-size:10px">Queue empty</span>' :
    BATCH_QUEUE.map((j,i)=>{
      const icon = j.status==='done'?'âœ…':j.status==='running'?'â³':j.status==='failed'?'âŒ':'ğŸ•';
      return `<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:10px;color:${j.status==='done'?'var(--green)':j.status==='failed'?'var(--red)':j.status==='running'?'var(--yellow)':'var(--text2)'}">
        <span>${icon}</span><span style="flex:1">${j.label}</span>
        <span style="cursor:pointer;color:var(--text3)" onclick="BATCH_QUEUE.splice(${i},1);_renderBatchPanel()" title="Remove">âœ•</span>
      </div>`;
    }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WORKFLOW AUTOMATION: Webhook triggers
// Send completion events to Zapier/Make
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function webhookSend(toolId, eventType, payload={}){
  const url = SS.raw('rf_webhook_url','');
  if(!url) return;
  const body = {
    source: 'RankForge Pro',
    tabId: TAB_ID,
    toolId,
    event: eventType,
    ts: Date.now(),
    timestamp: new Date().toISOString(),
    stats: {...APP.stats},
    ...payload
  };
  fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  }).then(r=>log(`Webhook sent (${eventType}) â†’ ${r.status}`,'ok'))
    .catch(e=>log(`Webhook failed: ${e.message}`,'warn'));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WORKFLOW AUTOMATION: Scheduled runs (cron-like)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCHEDULES_KEY = 'rf_schedules';

function schedulesGet(){ try{ return JSON.parse(localStorage.getItem(SCHEDULES_KEY)||'[]'); }catch(e){ return []; } }
function schedulesSave(s){ try{ localStorage.setItem(SCHEDULES_KEY, JSON.stringify(s)); }catch(e){} }

function scheduleAdd(toolId, label, cronExpr, enabled=true){
  // cronExpr is a simple object: {dayOfWeek:1, hour:9, minute:0} (dayOfWeek 0=Sun..6=Sat)
  const schedules = schedulesGet();
  schedules.push({ id:'sch_'+Math.random().toString(36).slice(2,8), toolId, label, cronExpr, enabled, createdTs:Date.now(), lastRunTs:null });
  schedulesSave(schedules);
  log(`Schedule created: "${label}" (tool: ${toolId})`,'ok');
}

function scheduleRemove(id){
  const s = schedulesGet().filter(x=>x.id!==id);
  schedulesSave(s);
  log(`Schedule removed`,'ok');
}

function scheduleToggle(id){
  const schedules = schedulesGet();
  const s = schedules.find(x=>x.id===id);
  if(s){ s.enabled=!s.enabled; schedulesSave(schedules); log(`Schedule "${s.label}" ${s.enabled?'enabled':'disabled'}`,'ok'); }
}

function _schedulesTick(){
  const schedules = schedulesGet();
  if(!schedules.length) return;
  const now2 = new Date();
  const dow = now2.getDay(); const h = now2.getHours(); const m = now2.getMinutes();
  schedules.forEach(s=>{
    if(!s.enabled) return;
    const c = s.cronExpr;
    if(c.dayOfWeek!==undefined && c.dayOfWeek!==dow) return;
    if(c.hour!==undefined && c.hour!==h) return;
    if(c.minute!==undefined && Math.abs(c.minute-m)>1) return;
    // Throttle: don't run same schedule twice within 5 minutes
    if(s.lastRunTs && Date.now()-s.lastRunTs<300000) return;
    log(`â° Scheduled run triggered: "${s.label}"`,'ok');
    s.lastRunTs = Date.now();
    schedulesSave(schedules);
    switchPage(s.toolId);
    setTimeout(()=>{ const fn=window['start_'+s.toolId]; if(typeof fn==='function') fn(); },500);
  });
}

// Check schedules every 60 seconds
let _schedulesInterval = null;
function schedulesStart(){ _schedulesInterval = setInterval(_schedulesTick, 60000); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA QUALITY: Global deduplication across all stored data
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function globalDedup(){
  let removed = 0;
  // URL list
  const before = APP.urlList.length;
  APP.urlList = [...new Set(APP.urlList)];
  removed += before - APP.urlList.length;
  SS.set('rf_urllist', APP.urlList);
  // Links
  const beforeLinks = APP.links.length;
  const seenLinks = new Set();
  APP.links = APP.links.filter(l=>{ const k=typeof l==='string'?l:(l.url||JSON.stringify(l)); if(seenLinks.has(k)) return false; seenLinks.add(k); return true; });
  removed += beforeLinks - APP.links.length;
  SS.set('rf_links', APP.links);
  // Comments
  const beforeComments = APP.comments.length;
  const seenComments = new Set();
  APP.comments = APP.comments.filter(c=>{ const k=typeof c==='string'?c:(c.text||JSON.stringify(c)); if(seenComments.has(k)) return false; seenComments.add(k); return true; });
  removed += beforeComments - APP.comments.length;
  SS.set('rf_comments', APP.comments);
  updateStats();
  log(`â™» Global dedup: removed ${removed} duplicates across URLs, links, comments`,'ok');
  return removed;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA QUALITY: Data integrity checker
// Scan localStorage for corrupted entries
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function integrityCheck(){
  const results = [];
  const rfKeys = [];
  try{
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(k&&k.startsWith('rf_')) rfKeys.push(k);
    }
  }catch(e){ log('Cannot access localStorage for integrity check','err'); return; }
  rfKeys.forEach(k=>{
    try{
      const raw=localStorage.getItem(k);
      if(!raw){ results.push({key:k, status:'empty', fix:'remove'}); return; }
      const v=JSON.parse(raw);
      // Check for expected types
      if((k==='rf_urllist'||k==='rf_proxies'||k==='rf_campaigns'||k==='rf_comments'||k==='rf_links'||k==='rf_accounts') && !Array.isArray(v)){
        results.push({key:k, status:'corrupt-not-array', fix:'reset'});
      } else {
        results.push({key:k, status:'ok', size:raw.length});
      }
    }catch(e){
      results.push({key:k, status:'corrupt-json', fix:'remove', error:e.message});
    }
  });
  const corrupt = results.filter(r=>r.status!=='ok');
  if(!corrupt.length){
    log(`âœ… Integrity check: all ${rfKeys.length} keys OK`,'ok');
  } else {
    log(`âš  Integrity check: ${corrupt.length} issues found in ${rfKeys.length} keys`,'warn');
    corrupt.forEach(r=>{ log(`  â€¢ ${r.key}: ${r.status} â†’ fix: ${r.fix}`,'warn'); });
  }
  return results;
}

function integrityFix(){
  const results = integrityCheck();
  if(!results) return;
  results.filter(r=>r.status!=='ok').forEach(r=>{
    if(r.fix==='remove'){ try{localStorage.removeItem(r.key);}catch(e){} log(`  âœ“ Removed corrupt key: ${r.key}`,'ok'); }
    else if(r.fix==='reset'){
      const arrKeys=['rf_urllist','rf_proxies','rf_campaigns','rf_comments','rf_links','rf_accounts'];
      if(arrKeys.includes(r.key)){ try{localStorage.setItem(r.key,'[]');}catch(e){} log(`  âœ“ Reset corrupt array key: ${r.key}`,'ok'); }
    }
  });
  // Reload core data
  APP.urlList=SS.get('rf_urllist',[]); APP.campaigns=SS.get('rf_campaigns',[]);
  APP.proxies=SS.get('rf_proxies',[]); APP.comments=SS.get('rf_comments',[]);
  APP.links=SS.get('rf_links',[]); APP.accounts=SS.get('rf_accounts',[]);
  updateStats();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA QUALITY: Cross-tool data lineage
// Track which URL came from which scraper run
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LINEAGE_KEY = 'rf_lineage';
let _lineageRunId = null;

function lineageGet(){ try{ return JSON.parse(localStorage.getItem(LINEAGE_KEY)||'{}'); }catch(e){ return {}; } }
function lineageSave(d){ try{ localStorage.setItem(LINEAGE_KEY, JSON.stringify(d)); }catch(e){} }

function lineageBeginRun(toolId){
  _lineageRunId = `${toolId}_${Date.now()}`;
  return _lineageRunId;
}

function lineageRecord(urls, toolId, runId){
  if(!Array.isArray(urls)) urls=[urls];
  const d = lineageGet();
  if(!d.runs) d.runs={};
  if(!d.urlMap) d.urlMap={};
  const rid = runId||_lineageRunId||`${toolId}_${Date.now()}`;
  d.runs[rid] = { toolId, ts:Date.now(), count:urls.length };
  urls.forEach(u=>{ if(!d.urlMap[u]) d.urlMap[u]=[]; d.urlMap[u].push(rid); });
  // Prune old runs (keep last 200)
  const runKeys = Object.keys(d.runs).sort();
  if(runKeys.length>200){ runKeys.slice(0,-200).forEach(k=>delete d.runs[k]); }
  lineageSave(d);
}

function lineageLookup(url){
  const d = lineageGet();
  const runIds = (d.urlMap||{})[url]||[];
  return runIds.map(id=>d.runs[id]||{id}).filter(Boolean);
}

function lineageStats(){
  const d = lineageGet();
  const runs = Object.values(d.runs||{});
  const urls = Object.keys(d.urlMap||{});
  return { totalRuns:runs.length, trackedUrls:urls.length, tools:[...new Set(runs.map(r=>r.toolId))] };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WORKFLOW AUTOMATION: Tool pipeline builder (programmatic API)
// Pipelines: [{toolId, condition?}] run sequentially with optional conditions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PIPELINES_KEY = 'rf_pipelines';

function pipelinesGet(){ try{ return JSON.parse(localStorage.getItem(PIPELINES_KEY)||'[]'); }catch(e){ return []; } }
function pipelinesSave(p){ try{ localStorage.setItem(PIPELINES_KEY, JSON.stringify(p)); }catch(e){} }

function pipelineCreate(name, steps=[]){
  // steps: [{toolId, label, condition?}]
  // condition example: "APP.results.filter(r=>r.da>70).length > 0"
  const pipelines = pipelinesGet();
  pipelines.push({ id:'pipe_'+Math.random().toString(36).slice(2,8), name, steps, createdTs:Date.now() });
  pipelinesSave(pipelines);
  log(`Pipeline created: "${name}" with ${steps.length} steps`,'ok');
}

async function pipelineRun(id){
  const pipelines = pipelinesGet();
  const pipe = pipelines.find(p=>p.id===id);
  if(!pipe){ log(`Pipeline not found: ${id}`,'err'); return; }
  log(`â–¶â–¶ Pipeline "${pipe.name}" starting â€” ${pipe.steps.length} steps`,'ok');
  for(let i=0;i<pipe.steps.length;i++){
    const step = pipe.steps[i];
    // Evaluate condition
    if(step.condition){
      try{
        const condResult = (new Function('APP','SS','return '+step.condition))(APP,SS);
        if(!condResult){ log(`  [${i+1}/${pipe.steps.length}] Skipping "${step.label||step.toolId}" â€” condition false`,'warn'); continue; }
      }catch(e){ log(`  Condition error for step ${i+1}: ${e.message}`,'err'); }
    }
    log(`  [${i+1}/${pipe.steps.length}] Running: ${step.label||step.toolId}`,'info');
    switchPage(step.toolId);
    await new Promise(r=>setTimeout(r,600));
    const fn=window['start_'+step.toolId];
    if(typeof fn==='function'){
      fn();
      // Wait for completion (poll for up to 5 minutes)
      await new Promise(r=>{
        let waited=0;
        const poll=setInterval(()=>{
          waited+=2000;
          if(!APP.running||waited>300000){ clearInterval(poll); r(); }
        },2000);
      });
    } else {
      log(`  No start handler for "${step.toolId}" â€” skipped`,'warn');
    }
    await new Promise(r=>setTimeout(r,1000));
    webhookSend(step.toolId,'pipeline_step_complete',{step:i+1,total:pipe.steps.length});
  }
  log(`âœ… Pipeline "${pipe.name}" complete`,'ok');
  webhookSend(id,'pipeline_complete',{name:pipe.name});
  runHistoryAdd('pipeline:'+pipe.name, pipe.steps.length, pipe.steps.length, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA QUALITY: Version migration helper
// Handle schema changes gracefully
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCHEMA_VERSION_KEY = 'rf_schema_version';
const CURRENT_SCHEMA_VERSION = 9;

function schemaMigrate(){
  const stored = parseInt(localStorage.getItem(SCHEMA_VERSION_KEY)||'0');
  if(stored >= CURRENT_SCHEMA_VERSION){ return; }
  log(`ğŸ”„ Schema migration: v${stored} â†’ v${CURRENT_SCHEMA_VERSION}`,'info');
  // v0â†’v1: ensure urlList is array
  if(stored < 1){
    const ul=localStorage.getItem('rf_urllist');
    if(ul && !ul.startsWith('[')){ localStorage.setItem('rf_urllist','[]'); log('Migration: reset urllist to array','warn'); }
  }
  // v1â†’v9: ensure all core arrays exist
  const arrDefs={rf_urllist:[],rf_campaigns:[],rf_proxies:[],rf_comments:[],rf_links:[],rf_accounts:[]};
  Object.entries(arrDefs).forEach(([k,def])=>{
    try{
      const v=JSON.parse(localStorage.getItem(k)||'null');
      if(!Array.isArray(v)){ localStorage.setItem(k, JSON.stringify(def)); log(`Migration: reset ${k}`,'warn'); }
    }catch(e){ localStorage.setItem(k, JSON.stringify(def)); }
  });
  localStorage.setItem(SCHEMA_VERSION_KEY, String(CURRENT_SCHEMA_VERSION));
  log(`âœ… Schema migration complete (v${CURRENT_SCHEMA_VERSION})`,'ok');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANALYTICS DASHBOARD PAGE: render_analytics
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render_analytics(el){
  const history = runHistoryGet();
  const roi = roiSummary();
  const linStats = lineageStats();
  const pipes = pipelinesGet();
  const scheds = schedulesGet();
  const top = heatmapTopPerformers(5);

  // Last 7 days chart data
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const label=d.toLocaleDateString('en',{weekday:'short'});
    const dateStr=d.toISOString().slice(0,10);
    const runs=history.filter(r=>r.date===dateStr);
    days.push({label, runs:runs.length, success:runs.reduce((s,r)=>s+(r.successCount||0),0)});
  }
  const maxRuns=Math.max(1,...days.map(d=>d.runs));

  el.innerHTML=`
  <div class="panel">
    <div class="panel-head">ğŸ“Š Analytics & Reporting Hub
      <div class="ph-r">
        <button class="tbtn go" onclick="generateWeeklySummary()">ğŸ“„ Export Weekly Report</button>
        <button class="tbtn" onclick="runHistoryClear();render_analytics(document.getElementById('page-analytics'))">ğŸ—‘ Clear History</button>
      </div>
    </div>
    <div class="panel-body">

      <!-- ROI Stats -->
      <div class="g5" style="margin-bottom:10px">
        <div class="stat"><div class="stat-v sv-g">${roi.built}</div><div class="stat-l">Links Built</div></div>
        <div class="stat"><div class="stat-v sv-b">${roi.indexed}<span style="font-size:11px;color:var(--text3)"> (${roi.indexRate}%)</span></div><div class="stat-l">Indexed</div></div>
        <div class="stat"><div class="stat-v sv-p">${roi.ranked}</div><div class="stat-l">Top 100</div></div>
        <div class="stat"><div class="stat-v sv-o">${roi.topRanked}</div><div class="stat-l">Top 10</div></div>
        <div class="stat"><div class="stat-v sv-y">${roi.totalTraffic}</div><div class="stat-l">Est. Traffic</div></div>
      </div>

      <!-- 7-day activity bar chart -->
      <div class="panel-head" style="margin-bottom:6px">ğŸ“… 7-Day Activity</div>
      <div style="display:flex;align-items:flex-end;gap:6px;height:80px;margin-bottom:4px;padding:0 2px">
        ${days.map(d=>`
          <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">
            <div style="font-family:var(--mono);font-size:9px;color:var(--text3)">${d.runs}</div>
            <div style="width:100%;background:var(--green);border-radius:2px 2px 0 0;height:${Math.max(2,Math.round(d.runs/maxRuns*60))}px" title="${d.runs} runs, ${d.success} successes"></div>
            <div style="font-size:9px;color:var(--text3)">${d.label}</div>
          </div>
        `).join('')}
      </div>

      <div class="g3" style="margin-top:8px">
        <!-- Run History -->
        <div>
          <div class="panel-head" style="margin-bottom:6px">ğŸ“œ Recent Runs (${history.length} total)</div>
          <div style="max-height:200px;overflow-y:auto;font-family:var(--mono);font-size:10px">
            ${history.slice(0,30).map(r=>`
              <div style="display:flex;gap:6px;padding:2px 0;border-bottom:1px solid #1e1e1e">
                <span style="color:var(--text3);white-space:nowrap">${r.time}</span>
                <span style="color:var(--blue);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${(r.toolId||'').replace(/_/g,' ')}</span>
                <span style="color:var(--green)">${r.successCount||0}âœ“</span>
                <span style="color:var(--red)">${r.failCount||0}âœ—</span>
              </div>
            `).join('')||'<div style="color:var(--text3);padding:8px">No runs yet</div>'}
          </div>
        </div>

        <!-- Platform Heatmap -->
        <div>
          <div class="panel-head" style="margin-bottom:6px">ğŸ† Top Platforms</div>
          ${top.length?top.map(r=>`
            <div style="margin-bottom:4px">
              <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px">
                <span style="color:var(--text2)">${r.platform.slice(0,20)}</span>
                <span style="color:${r.rate>70?'var(--green)':'var(--yellow)'};">${r.rate}%</span>
              </div>
              <div style="background:var(--win-panel3);border-radius:2px;height:6px">
                <div style="width:${r.rate}%;background:${r.rate>70?'var(--green)':'var(--yellow)'};height:100%;border-radius:2px"></div>
              </div>
            </div>
          `).join(''):'<div style="color:var(--text3);font-size:10px">No platform data yet â€” run tools to collect data.</div>'}
        </div>

        <!-- Lineage & System -->
        <div>
          <div class="panel-head" style="margin-bottom:6px">ğŸ”— Data Lineage</div>
          <div style="font-size:10px;color:var(--text2);line-height:1.8">
            Tracked URLs: <span style="color:var(--green)">${linStats.trackedUrls}</span><br>
            Scraper Runs: <span style="color:var(--blue)">${linStats.totalRuns}</span><br>
            Tools Used: <span style="color:var(--cyan)">${linStats.tools.join(', ')||'none'}</span><br><br>
            Pipelines: <span style="color:var(--purple)">${pipes.length}</span><br>
            Schedules: <span style="color:var(--yellow)">${scheds.filter(s=>s.enabled).length} active / ${scheds.length} total</span>
          </div>
          <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px">
            <button class="tbtn" onclick="globalDedup()" style="font-size:10px">â™» Global Dedup</button>
            <button class="tbtn" onclick="integrityFix()" style="font-size:10px">ğŸ” Fix Integrity</button>
            <button class="tbtn" onclick="const s=lineageStats();log('Lineage: '+s.trackedUrls+' URLs across '+s.totalRuns+' runs','ok')" style="font-size:10px">ğŸ” Lineage Stats</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Batch Queue Panel -->
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">âš™ Batch Job Queue
      <div class="ph-r">
        <button class="tbtn go" onclick="batchStart()">â–¶ Run Queue</button>
        <button class="tbtn" onclick="batchClear()">ğŸ—‘ Clear</button>
      </div>
    </div>
    <div class="panel-body">
      <div style="font-size:10px;color:var(--text3);margin-bottom:6px">Add tools to queue then click Run Queue to execute them sequentially.</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        ${PAGE_IDS.filter(p=>!['settings','dashboard','analytics'].includes(p)).map(p=>`
          <button class="tbtn" onclick="batchEnqueue('${p}','${p.replace(/_/g,' ')}')" style="font-size:10px">${p.replace(/_/g,' ')}</button>
        `).join('')}
      </div>
      <div id="batch-queue-panel" style="border:1px solid var(--win-border);background:var(--win-panel2);padding:6px;border-radius:2px;min-height:36px">
        <span style="color:var(--text3);font-size:10px">Queue empty</span>
      </div>
    </div>
  </div>

  <!-- Schedules Panel -->
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">â° Scheduled Runs
      <div class="ph-r"><button class="tbtn go" onclick="_showAddScheduleForm()" style="font-size:10px">+ Add Schedule</button></div>
    </div>
    <div class="panel-body">
      <div id="schedules-list">
        ${schedulesGet().length===0?'<div style="color:var(--text3);font-size:10px">No schedules configured.</div>':
          schedulesGet().map(s=>`
            <div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #1e1e1e;font-size:10px">
              <span style="color:${s.enabled?'var(--green)':'var(--text3)'}">${s.enabled?'â—':'â—‹'}</span>
              <span style="flex:1;color:var(--text2)">${s.label}</span>
              <span style="color:var(--text3)">Day ${s.cronExpr.dayOfWeek!==undefined?['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][s.cronExpr.dayOfWeek]:'*'} ${String(s.cronExpr.hour||0).padStart(2,'0')}:${String(s.cronExpr.minute||0).padStart(2,'0')}</span>
              <button class="tbtn" onclick="scheduleToggle('${s.id}');render_analytics(document.getElementById('page-analytics'))">${s.enabled?'Pause':'Resume'}</button>
              <button class="tbtn" onclick="if(confirm('Remove schedule?')){scheduleRemove('${s.id}');render_analytics(document.getElementById('page-analytics'))}">âœ•</button>
            </div>
          `).join('')}
      </div>
      <div id="add-schedule-form" style="display:none;margin-top:8px;background:var(--win-panel2);padding:8px;border:1px solid var(--win-border);border-radius:2px">
        <div class="g4" style="margin-bottom:6px">
          <div class="fg"><label class="lbl">Tool</label>
            <select id="sch-tool">${PAGE_IDS.filter(p=>!['settings','dashboard','analytics'].includes(p)).map(p=>`<option value="${p}">${p.replace(/_/g,' ')}</option>`).join('')}</select>
          </div>
          <div class="fg"><label class="lbl">Day</label>
            <select id="sch-dow"><option value="">Every day</option>${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((d,i)=>`<option value="${i}">${d}</option>`).join('')}</select>
          </div>
          <div class="fg"><label class="lbl">Hour (0-23)</label><input type="number" id="sch-hour" value="9" min="0" max="23"/></div>
          <div class="fg"><label class="lbl">Minute</label><input type="number" id="sch-min" value="0" min="0" max="59"/></div>
        </div>
        <div class="fg" style="margin-bottom:6px"><label class="lbl">Label</label><input type="text" id="sch-label" placeholder="Monday DA Check..."/></div>
        <div style="display:flex;gap:6px">
          <button class="tbtn go" onclick="_addScheduleFromForm()">Add Schedule</button>
          <button class="tbtn" onclick="document.getElementById('add-schedule-form').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pipelines Panel -->
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">ğŸ”— Tool Pipelines
      <div class="ph-r"><button class="tbtn go" onclick="_showPipelineForm()" style="font-size:10px">+ New Pipeline</button></div>
    </div>
    <div class="panel-body">
      <div style="font-size:10px;color:var(--text3);margin-bottom:6px">Chain tools to run sequentially with optional conditions (e.g. IF DA > 70 THEN run Commenter).</div>
      ${pipelinesGet().length===0?'<div style="color:var(--text3);font-size:10px">No pipelines created yet.</div>':
        pipelinesGet().map(p=>`
          <div style="border:1px solid var(--win-border);padding:6px;margin-bottom:6px;border-radius:2px;background:var(--win-panel2)">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
              <span style="color:var(--purple);font-weight:700;font-size:11px">${p.name}</span>
              <span style="color:var(--text3);font-size:10px">${p.steps.length} steps</span>
              <button class="tbtn go" onclick="pipelineRun('${p.id}')" style="font-size:10px;margin-left:auto">â–¶ Run</button>
              <button class="tbtn" onclick="if(confirm('Delete pipeline?')){const ps=pipelinesGet().filter(x=>x.id!=='${p.id}');pipelinesSave(ps);render_analytics(document.getElementById('page-analytics'))}" style="font-size:10px">âœ•</button>
            </div>
            <div style="font-size:10px;color:var(--text2)">${p.steps.map((s,i)=>`${i+1}. ${s.label||s.toolId}${s.condition?` <span style="color:var(--yellow)">[if: ${s.condition.slice(0,40)}]</span>`:''}`).join(' â†’ ')}</div>
          </div>
        `).join('')}
      <div id="pipeline-form" style="display:none;margin-top:8px;background:var(--win-panel2);padding:8px;border:1px solid var(--win-border);border-radius:2px">
        <div class="fg" style="margin-bottom:6px"><label class="lbl">Pipeline Name</label><input type="text" id="pipe-name" placeholder="Scrape â†’ Filter DA > 70 â†’ Comment"/></div>
        <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Add steps (in order):</div>
        <div id="pipe-steps-list" style="margin-bottom:6px"></div>
        <div class="g3" style="margin-bottom:6px">
          <div class="fg"><label class="lbl">Tool</label>
            <select id="pipe-step-tool">${PAGE_IDS.filter(p=>!['settings','dashboard','analytics'].includes(p)).map(p=>`<option value="${p}">${p.replace(/_/g,' ')}</option>`).join('')}</select>
          </div>
          <div class="fg"><label class="lbl">Condition (optional JS)</label><input type="text" id="pipe-step-cond" placeholder="APP.results.filter(r=&gt;r.da&gt;70).length &gt; 0"/></div>
          <div style="display:flex;align-items:flex-end"><button class="tbtn" onclick="_pipelineAddStep()">+ Step</button></div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="tbtn go" onclick="_pipelineCreate()">Create Pipeline</button>
          <button class="tbtn" onclick="document.getElementById('pipeline-form').style.display='none'">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Webhook Config -->
  <div class="panel" style="margin-top:8px">
    <div class="panel-head">ğŸ”” Webhook / Zapier Integration</div>
    <div class="panel-body">
      <div style="font-size:10px;color:var(--text3);margin-bottom:6px">Send completion events to Zapier, Make.com, or any webhook endpoint. Events fire when tool runs complete.</div>
      <div class="g2">
        <div class="fg"><label class="lbl">Webhook URL (POST)</label>
          <input type="text" id="webhook-url-input" value="${SS.raw('rf_webhook_url','')}" placeholder="https://hooks.zapier.com/hooks/catch/..."/>
        </div>
        <div style="display:flex;align-items:flex-end;gap:6px">
          <button class="tbtn go" onclick="_saveWebhookUrl()">ğŸ’¾ Save</button>
          <button class="tbtn" onclick="webhookSend('test','manual_test',{message:'RankForge webhook test'})">ğŸ§ª Test</button>
        </div>
      </div>
    </div>
  </div>
  `;
}

// Pipeline form helpers
let _pipeSteps = [];
function _showPipelineForm(){ _pipeSteps=[]; document.getElementById('pipeline-form').style.display='block'; document.getElementById('pipe-steps-list').innerHTML=''; }
function _pipelineAddStep(){
  const tool=document.getElementById('pipe-step-tool').value;
  const cond=document.getElementById('pipe-step-cond').value.trim();
  _pipeSteps.push({toolId:tool, label:tool.replace(/_/g,' '), condition:cond||null});
  const el=document.getElementById('pipe-steps-list');
  el.innerHTML=_pipeSteps.map((s,i)=>`<div style="font-size:10px;padding:2px 0;color:var(--text2)">${i+1}. ${s.label}${s.condition?` <span style="color:var(--yellow)">[if: ${s.condition.slice(0,50)}]</span>`:''}</div>`).join('');
}
function _pipelineCreate(){
  const name=document.getElementById('pipe-name').value.trim();
  if(!name||!_pipeSteps.length){ log('Pipeline needs a name and at least one step','warn'); return; }
  pipelineCreate(name, _pipeSteps);
  document.getElementById('pipeline-form').style.display='none';
  render_analytics(document.getElementById('page-analytics'));
}
function _showAddScheduleForm(){ document.getElementById('add-schedule-form').style.display='block'; }
function _addScheduleFromForm(){
  const toolId=document.getElementById('sch-tool').value;
  const dow=document.getElementById('sch-dow').value;
  const h=parseInt(document.getElementById('sch-hour').value||'9');
  const m=parseInt(document.getElementById('sch-min').value||'0');
  const label=document.getElementById('sch-label').value.trim()||toolId.replace(/_/g,' ');
  const cronExpr={hour:h, minute:m};
  if(dow!=='') cronExpr.dayOfWeek=parseInt(dow);
  scheduleAdd(toolId, label, cronExpr);
  document.getElementById('add-schedule-form').style.display='none';
  render_analytics(document.getElementById('page-analytics'));
}
function _saveWebhookUrl(){
  const url=document.getElementById('webhook-url-input').value.trim();
  SS.rawSet('rf_webhook_url',url);
  log(url?`Webhook URL saved`:'Webhook URL cleared','ok');
}

// Add Analytics to nav if not present
(function _addAnalyticsNav(){
  // Will run after DOM ready; inject into PAGE_IDS and sidebar
  if(!PAGE_IDS.includes('analytics')) PAGE_IDS.push('analytics');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELP SYSTEM ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HELP_CONTENT = {
  dashboard: {
    title: 'ğŸ“Š Dashboard Help',
    workflow: ['Check Stats', 'Review Campaigns', 'Monitor Activity', 'Launch Tools'],
    sections: [
      {
        title: 'Overview',
        items: [
          { icon: 'ğŸ“Š', label: 'Stat Cards', text: 'Each card shows a live count â€” URLs in list, campaigns, proxies, and links. Click any card to jump to that tool.', type: 'tip' },
          { icon: 'ğŸš€', label: 'Quick Launch', text: 'Use the campaign cards to start a full scrapeâ†’commentâ†’index pipeline with one click.', type: 'tip' },
          { icon: 'ğŸ“ˆ', label: 'Activity Feed', text: 'The right-side log shows real-time events from all running tools. Green = success, Red = error, Yellow = warning.', type: 'info' },
        ]
      },
      {
        title: 'Best Practices',
        items: [
          { icon: 'âœ…', label: 'Start Here', text: 'New users: set up your API keys in Settings first, then add proxies before running scrapers.', type: 'tip' },
          { icon: 'âš¡', label: 'Thread Count', text: 'Adjust the Threads slider (sidebar) before starting. 5â€“10 threads is safe; 20+ may trigger rate limits.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: 'Ctrl+S', action: 'Save data' }, { key: 'Ctrl+Z', action: 'Undo last action' }, { key: 'Ctrl+Y', action: 'Redo' }]
  },

  url_scraper: {
    title: 'ğŸ” URL Scraper Help',
    workflow: ['Enter Seeds/Footprints', 'Configure Filters', 'Run Scrape', 'Filter Results', 'Export to URL List'],
    sections: [
      {
        title: 'Input Methods',
        items: [
          { icon: 'ğŸŒ±', label: 'Seeds', text: 'Enter seed URLs (one per line) â€” the scraper will crawl outbound links from these pages.', type: 'tip' },
          { icon: 'ğŸ‘£', label: 'Footprints', text: 'Use Google-style footprints like <code>inurl:blog "leave a comment"</code> to find comment-enabled pages across the web.', type: 'tip' },
          { icon: 'ğŸ—º', label: 'Sitemap Mode', text: 'Paste a sitemap.xml URL to instantly extract all indexed URLs from a domain.', type: 'info' },
          { icon: 'ğŸ“‹', label: 'Bulk Paste', text: 'Paste up to 10,000 URLs at once into the textarea. Duplicates are removed automatically.', type: 'tip' },
        ]
      },
      {
        title: 'Filters & Scoring',
        items: [
          { icon: 'â­', label: 'Score Column', text: 'Score 0â€“5: higher = better comment opportunity. Filter for Score â‰¥ 2 for quality targets.', type: 'tip' },
          { icon: 'ğŸ’¬', label: 'Comment Flag', text: 'The ğŸ’¬ badge means a live comment form was detected. Prioritize these for the Commenter tool.', type: 'tip' },
          { icon: 'ğŸ”’', label: 'Login Badge', text: 'Rows with ğŸ”’ require login â€” skip these unless you have accounts in the Account Creator.', type: 'warn' },
          { icon: 'ğŸ¤–', label: 'Robots Block', text: 'Pages flagged with ğŸ¤– are blocked in robots.txt. Commenting there risks penalties.', type: 'warn' },
        ]
      },
      {
        title: 'Export Options',
        items: [
          { icon: 'ğŸ’¾', label: 'â†’ URL List', text: 'Sends scraped URLs directly to the global URL List used by Commenter, DA Checker, and other tools.', type: 'tip' },
          { icon: 'â­', label: 'CommentLuv Only', text: 'Exports only CommentLuv-enabled blogs â€” these give dofollow links automatically.', type: 'tip' },
          { icon: 'ğŸ·', label: 'By Tag/CMS', text: 'Use the Bulk Tag Actions panel to export by WordPress, Joomla, or custom niche tags.', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: 'Ctrl+Enter', action: 'Start scraping' }, { key: 'Score â‰¥ 2', action: 'Good quality filter' }]
  },

  serp_scraper: {
    title: 'ğŸŒ SERP Scraper Help',
    workflow: ['Enter Keywords', 'Choose Search Engine', 'Set Depth', 'Scrape SERPs', 'Send to URL List'],
    sections: [
      {
        title: 'How It Works',
        items: [
          { icon: 'ğŸ”‘', label: 'SerpAPI Key Required', text: 'This tool requires a SerpAPI key. Add it in Settings â†’ API Keys. Free tier gives 100 searches/month.', type: 'warn' },
          { icon: 'ğŸ“„', label: 'Pages', text: 'Setting Pages to 3 will fetch the top 30 results (10 per page). More pages = more targets but slower.', type: 'tip' },
          { icon: 'ğŸŒ', label: 'Geo Targeting', text: 'Use the Country/Language selectors to scrape SERPs from specific regions â€” useful for local SEO campaigns.', type: 'info' },
        ]
      },
      {
        title: 'Strategy Tips',
        items: [
          { icon: 'ğŸ¯', label: 'Keyword Intent', text: 'Use informational keywords (e.g., "how to...", "best...") to find blog-style pages that accept comments.', type: 'tip' },
          { icon: 'âš¡', label: 'Combine Tools', text: 'Run SERP Scraper â†’ DA Checker â†’ Commenter as a pipeline for quality link building.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '10 results/page', action: 'Google default' }, { key: 'Pages Ã— 10', action: '= total URLs' }]
  },

  keyword_harvester: {
    title: 'ğŸŒ± Keyword Harvester Help',
    workflow: ['Enter Seed Keywords', 'Select Sources', 'Harvest', 'Filter by Volume/KD', 'Export'],
    sections: [
      {
        title: 'Sources Explained',
        items: [
          { icon: 'ğŸ”®', label: 'Google Suggest', text: 'Autocomplete predictions â€” great for long-tail, low-competition keywords. No API key needed.', type: 'tip' },
          { icon: 'â“', label: 'People Also Ask', text: 'Question-format keywords perfect for FAQ content and featured snippet targeting.', type: 'info' },
          { icon: 'ğŸ”—', label: 'Related Searches', text: 'Found at the bottom of Google SERPs â€” reveals semantically related terms.', type: 'tip' },
        ]
      },
      {
        title: 'Filtering Strategy',
        items: [
          { icon: 'ğŸ“Š', label: 'Volume vs KD', text: 'Target keywords with Volume > 100 and KD < 40 for the best SEO ROI when starting out.', type: 'tip' },
          { icon: 'ğŸ’¡', label: 'Cluster Mode', text: 'Use keyword clustering to group similar terms â€” build one page per cluster for topical authority.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: 'KD < 40', action: 'Low competition' }, { key: 'Vol > 100', action: 'Minimum viable traffic' }]
  },

  sitemap_scraper: {
    title: 'ğŸ—º Sitemap Scraper Help',
    workflow: ['Enter Domain/Sitemap URL', 'Parse Sitemap', 'Filter by Type', 'Export URLs'],
    sections: [
      {
        title: 'Usage',
        items: [
          { icon: 'ğŸ—º', label: 'Sitemap URL', text: 'Try <code>https://domain.com/sitemap.xml</code> or <code>/sitemap_index.xml</code>. Most CMS auto-generate these.', type: 'tip' },
          { icon: 'ğŸ“', label: 'Sitemap Index', text: 'If the domain has a sitemap index, this tool will automatically recurse and collect all child sitemaps.', type: 'info' },
          { icon: 'ğŸ”–', label: 'Filter by Type', text: 'Filter to "post" type URLs to get only blog posts â€” the best candidates for comment link building.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '/sitemap.xml', action: 'Common sitemap path' }, { key: '/sitemap_index.xml', action: 'Index sitemap' }]
  },

  da_checker: {
    title: 'ğŸ“Š DA/PA Checker Help',
    workflow: ['Load URL List', 'Check DA/PA', 'Filter by Minimum DA', 'Export Quality URLs'],
    sections: [
      {
        title: 'Metrics Explained',
        items: [
          { icon: 'ğŸ“ˆ', label: 'Domain Authority (DA)', text: 'Moz score 0â€“100. DA 20+ is worth targeting; DA 40+ is high quality for link building.', type: 'tip' },
          { icon: 'ğŸ“„', label: 'Page Authority (PA)', text: 'Authority of the specific page. High PA on comment pages means your link gets more equity.', type: 'tip' },
          { icon: 'ğŸ”‘', label: 'OPR Key Required', text: 'DA/PA checks require an OpenPageRank API key. Free tier: 5,000 requests/day. Set it in Settings â†’ API Keys.', type: 'warn' },
        ]
      },
      {
        title: 'Filtering for Quality',
        items: [
          { icon: 'ğŸ¯', label: 'Minimum DA', text: 'Set min DA to 20 for general outreach, 30+ for premium campaigns. Lower = more volume, higher = more quality.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Link Relevance', text: 'DA alone isn\'t everything â€” a DA 15 site in your exact niche often beats a DA 50 unrelated site.', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: 'DA 20â€“40', action: 'Balanced quality/volume' }, { key: 'DA 40+', action: 'High-quality targets' }]
  },

  domain_age: {
    title: 'ğŸ“… Domain Age Checker Help',
    workflow: ['Load URLs', 'Check Ages via WHOIS', 'Filter by Age', 'Export'],
    sections: [
      {
        title: 'Why Domain Age Matters',
        items: [
          { icon: 'ğŸ›', label: 'Age = Trust', text: 'Older domains (3+ years) have more accumulated trust. Links from them carry more weight.', type: 'tip' },
          { icon: 'ğŸ”‘', label: 'WHOIS API Key', text: 'Requires a WHOIS API key for bulk checks. Set in Settings â†’ API Keys. Limited free lookups available.', type: 'warn' },
          { icon: 'ğŸ“…', label: 'Filter Threshold', text: 'Set minimum age to 1â€“2 years to filter out new/thin sites that may be penalized or deindexed.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '1+ years', action: 'Minimum recommended age' }, { key: '5+ years', action: 'Premium domain threshold' }]
  },

  robots_checker: {
    title: 'ğŸ¤– Robots.txt Checker Help',
    workflow: ['Load URLs', 'Fetch robots.txt', 'Review Block Rules', 'Remove Blocked URLs'],
    sections: [
      {
        title: 'Understanding Results',
        items: [
          { icon: 'ğŸš«', label: 'Blocked Paths', text: 'If a page\'s path is disallowed in robots.txt, search engines won\'t index links on that page.', type: 'warn' },
          { icon: 'âœ…', label: 'Allowed Pages', text: 'Use this tool before commenting â€” skip any page where the comment path is disallowed.', type: 'tip' },
          { icon: 'â±', label: 'Crawl Delay', text: 'Respect crawl-delay directives. If set, throttle your thread count to match.', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: 'Disallow: /', action: 'Entire site blocked' }, { key: 'User-agent: *', action: 'Applies to all bots' }]
  },

  link_alive: {
    title: 'ğŸ’“ Link Alive Checker Help',
    workflow: ['Load Links', 'Check Status', 'Filter Dead Links', 'Remove or Re-submit'],
    sections: [
      {
        title: 'Status Codes',
        items: [
          { icon: 'âœ…', label: '200 OK', text: 'Link is live and accessible. Keep these in your list.', type: 'tip' },
          { icon: 'ğŸ”€', label: '301/302 Redirect', text: 'Link redirects. Check if the final destination still passes link equity (not nofollow, not spam).', type: 'info' },
          { icon: 'ğŸ’€', label: '404 Not Found', text: 'Page is gone. Remove these from your lists and consider building replacement links.', type: 'warn' },
          { icon: 'â›”', label: '403/503', text: 'Access denied or server error. May be temporary â€” retry after 24h before removing.', type: 'warn' },
        ]
      },
      {
        title: 'Maintenance Strategy',
        items: [
          { icon: 'ğŸ“…', label: 'Run Monthly', text: 'Check link health monthly to catch dead links before they hurt your campaigns.', type: 'tip' },
          { icon: 'ğŸ”„', label: 'Auto-Remove Dead', text: 'Enable "Auto-remove 404s from URL List" to keep your working list clean automatically.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '200', action: 'Live â€” keep' }, { key: '404', action: 'Dead â€” remove' }]
  },

  campaign: {
    title: 'ğŸš€ Campaign Manager Help',
    workflow: ['Create Campaign', 'Add Target URLs', 'Set Anchor Texts', 'Choose Tools', 'Run & Monitor'],
    sections: [
      {
        title: 'Campaign Setup',
        items: [
          { icon: 'ğŸš€', label: 'Create Campaign', text: 'A campaign groups a URL list, anchor texts, and a set of link-building actions together. Always name campaigns clearly (e.g., "niche + date").', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Money URL', text: 'The Money URL is the page you want to rank â€” usually your homepage or a target landing page.', type: 'tip' },
          { icon: 'âš“', label: 'Anchor Diversity', text: 'Use 70% branded/generic, 20% partial-match, 10% exact-match anchors to avoid over-optimization penalties.', type: 'warn' },
        ]
      },
      {
        title: 'Running Campaigns',
        items: [
          { icon: 'ğŸ“Š', label: 'Campaign Stats', text: 'The stats panel shows links built, success rate, and last run time. Use this to track progress.', type: 'info' },
          { icon: 'â±', label: 'Pacing', text: 'Don\'t build too many links too fast. 20â€“50 links/day is natural; sudden spikes can trigger penalties.', type: 'warn' },
          { icon: 'ğŸ”„', label: 'Pipelines', text: 'Use Analytics â†’ Pipelines to automate full Scrape â†’ Check DA â†’ Comment sequences.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '70/20/10', action: 'Anchor text ratio' }, { key: '20â€“50/day', action: 'Safe link velocity' }]
  },

  commenter: {
    title: 'ğŸ’¬ Blog Commenter Help',
    workflow: ['Load URL List', 'Configure Comment Templates', 'Set Author/Email', 'Run Commenter', 'Monitor Approvals'],
    sections: [
      {
        title: 'Getting Started',
        items: [
          { icon: 'ğŸ“‹', label: 'URL List First', text: 'Always load URLs from URL Scraper or DA Checker first. Target comment-enabled (ğŸ’¬) pages only.', type: 'tip' },
          { icon: 'âœ', label: 'Comment Templates', text: 'Write 5â€“10 unique comment templates. Use {name}, {url}, {keyword} placeholders for variation.', type: 'tip' },
          { icon: 'ğŸ¤–', label: 'Captcha Solver', text: 'Many blogs use reCAPTCHA. Configure a captcha service (2captcha, Anti-Captcha) in Settings first.', type: 'warn' },
        ]
      },
      {
        title: 'Quality Guidelines',
        items: [
          { icon: 'ğŸ“', label: 'Comment Quality', text: 'Longer, relevant comments (50+ words) are more likely to be approved than generic one-liners.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'URL in Comment', text: 'Use the website field, not the comment body, for your link. Body links are almost always removed.', type: 'tip' },
          { icon: 'â±', label: 'Approval Time', text: 'Most blogs require manual approval. Check back after 24â€“72h. Moderated links count just as much.', type: 'info' },
          { icon: 'ğŸš«', label: 'Spam Filters', text: 'Avoid keyword-stuffed names (e.g., "Buy Cheap Loans"). Use natural names to pass Akismet filters.', type: 'warn' },
        ]
      },
      {
        title: 'Advanced',
        items: [
          { icon: 'ğŸ”€', label: 'Proxy Rotation', text: 'Enable proxy rotation (Proxy Manager) to avoid IP-based rate limits on high-volume runs.', type: 'tip' },
          { icon: 'ğŸ¤–', label: 'Claude AI Comments', text: 'Enable AI mode to generate contextual, post-specific comments using your Claude API key.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '50+ words', action: 'Approval-friendly comment' }, { key: '{url}', action: 'URL placeholder' }]
  },

  link_builder: {
    title: 'ğŸ”— Link Builder Help',
    workflow: ['Choose Link Type', 'Configure Targets', 'Set Anchors', 'Build Links', 'Verify & Index'],
    sections: [
      {
        title: 'Link Types',
        items: [
          { icon: 'ğŸ“', label: 'Web 2.0', text: 'Create free blog posts on platforms like Blogger, WordPress.com, Tumblr with embedded links.', type: 'tip' },
          { icon: 'ğŸ“‚', label: 'Profile Links', text: 'Register and build profiles with bio links on authority sites. Good for Tier 2 link building.', type: 'tip' },
          { icon: 'ğŸ“–', label: 'Article Directories', text: 'Submit spun articles with contextual links. Use the Article Spinner for content variation.', type: 'info' },
          { icon: 'ğŸ—', label: 'Tiered Links', text: 'Build links TO your links (Tier 2/3) to pass more equity through. Use Tiered Links tool.', type: 'tip' },
        ]
      },
      {
        title: 'Link Quality',
        items: [
          { icon: 'ğŸ¯', label: 'Relevance > Authority', text: 'A DA 20 site in your exact niche will often outperform a DA 50 unrelated site.', type: 'tip' },
          { icon: 'ğŸ“Š', label: 'Dofollow Priority', text: 'Filter for dofollow links in results. Nofollow links still have value for traffic but less for rankings.', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: 'Tier 1', action: 'Direct links to money site' }, { key: 'Tier 2/3', action: 'Links to your links' }]
  },

  content_gen: {
    title: 'âœ Content Generator Help',
    workflow: ['Enter Topic/Keywords', 'Choose Length & Tone', 'Generate with Claude', 'Review & Edit', 'Export or Spin'],
    sections: [
      {
        title: 'AI Content Setup',
        items: [
          { icon: 'ğŸ”‘', label: 'Claude API Key', text: 'Content generation requires your Claude API key. Add it in Settings â†’ API Keys.', type: 'warn' },
          { icon: 'ğŸ¯', label: 'SEO Mode', text: 'Enable SEO mode to inject target keywords at the right density (1â€“2%) and add proper H2/H3 structure.', type: 'tip' },
          { icon: 'ğŸ“', label: 'Length Guidelines', text: '1,000â€“1,500 words is optimal for most blog posts. Long-form (2,500+) works better for pillar content.', type: 'info' },
        ]
      },
      {
        title: 'Content Strategy',
        items: [
          { icon: 'ğŸ”„', label: 'Spin After Generate', text: 'Pass generated content through the Article Spinner for variation when submitting to multiple sites.', type: 'tip' },
          { icon: 'ğŸ§ ', label: 'Prompt Quality', text: 'Better prompts = better content. Include: target keyword, audience, tone, and specific angle or hook.', type: 'tip' },
          { icon: 'âš ', label: 'AI Content Warning', text: 'Always review AI content before publishing. Add personal insights and real examples to improve quality.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: '1â€“2% density', action: 'Keyword density target' }, { key: 'H2 every 300 words', action: 'Good structure' }]
  },

  spinner: {
    title: 'ğŸ”„ Article Spinner Help',
    workflow: ['Paste Article', 'Add Synonyms/Spintax', 'Preview Spun Versions', 'Generate Bulk', 'Export'],
    sections: [
      {
        title: 'Spintax Syntax',
        items: [
          { icon: 'ğŸ”„', label: 'Basic Spintax', text: 'Use {word1|word2|word3} to define alternative words. Example: {big|large|huge} house.', type: 'tip' },
          { icon: 'ğŸ”€', label: 'Nested Spintax', text: 'Nest spintax for sentences: {The {big|large} dog|A {huge|massive} canine} ran fast.', type: 'info' },
          { icon: 'ğŸ¤–', label: 'AI Spinning', text: 'Use AI Rewrite mode to generate semantically unique versions without manual spintax markup.', type: 'tip' },
        ]
      },
      {
        title: 'Quality Control',
        items: [
          { icon: 'ğŸ“Š', label: 'Uniqueness Score', text: 'Aim for 70%+ uniqueness between versions. Lower = risk of duplicate content penalties.', type: 'warn' },
          { icon: 'ğŸ‘', label: 'Always Preview', text: 'Read at least 3 generated versions before bulk export to catch awkward or unreadable combinations.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '{a|b|c}', action: 'Basic spintax' }, { key: '70%+', action: 'Target uniqueness' }]
  },

  account_creator: {
    title: 'ğŸ‘¤ Account Creator Help',
    workflow: ['Choose Platforms', 'Configure Identity', 'Set Email Provider', 'Create Accounts', 'Export Credentials'],
    sections: [
      {
        title: 'Setup Requirements',
        items: [
          { icon: 'ğŸ“§', label: 'Email Accounts', text: 'You need bulk email addresses. Use a tempmail service or configure catch-all email routing.', type: 'warn' },
          { icon: 'ğŸ”€', label: 'Proxies Required', text: 'Always use different proxies per account to avoid platform fingerprinting and mass bans.', type: 'warn' },
          { icon: 'ğŸ›¡', label: 'Captcha Service', text: 'Most signup forms have captcha. Configure 2captcha or Anti-Captcha in Settings before running.', type: 'warn' },
        ]
      },
      {
        title: 'Account Management',
        items: [
          { icon: 'ğŸ’¾', label: 'Save Credentials', text: 'All created accounts are saved to the Accounts tab. Export regularly as a backup.', type: 'tip' },
          { icon: 'â±', label: 'Warm Up Period', text: 'New accounts should have a 1â€“3 day warmup period before using them for link building.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '1 proxy/account', action: 'Avoid fingerprint linking' }, { key: '1â€“3 day warmup', action: 'Account trust building' }]
  },

  link_indexer: {
    title: 'ğŸ“¡ Link Indexer Help',
    workflow: ['Load Links to Index', 'Choose Indexing Method', 'Submit', 'Track Index Status'],
    sections: [
      {
        title: 'Indexing Methods',
        items: [
          { icon: 'ğŸ“¡', label: 'Ping Services', text: 'Submit URLs to 50+ ping services simultaneously to signal new content to search engines.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Backlink Blast', text: 'Build low-quality links TO your links â€” the crawl activity helps get them indexed faster.', type: 'info' },
          { icon: 'ğŸ—º', label: 'Sitemap Submit', text: 'Add links to a dynamically generated sitemap and submit to Google Search Console.', type: 'tip' },
        ]
      },
      {
        title: 'Indexing Tips',
        items: [
          { icon: 'â±', label: 'Timeline', text: 'Most links take 1â€“4 weeks to be indexed naturally. Indexing services can speed this to 3â€“7 days.', type: 'info' },
          { icon: 'â“', label: 'Not Indexed?', text: 'If a link won\'t index after 30 days, check if the hosting site is deindexed itself first.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '3â€“7 days', action: 'Indexing service speed' }, { key: '1â€“4 weeks', action: 'Natural indexing time' }]
  },

  ping_submitter: {
    title: 'ğŸ“ Ping Submitter Help',
    workflow: ['Enter URLs to Ping', 'Select Ping Services', 'Submit', 'Review Results'],
    sections: [
      {
        title: 'How Pinging Works',
        items: [
          { icon: 'ğŸ“', label: 'What is Pinging?', text: 'Pinging notifies aggregator services that a page has new/updated content, prompting a re-crawl.', type: 'info' },
          { icon: 'ğŸ“Š', label: 'Best Use Case', text: 'Most effective for freshly published pages. Pinging already-indexed pages has diminishing returns.', type: 'tip' },
          { icon: 'âš¡', label: 'Batch Size', text: 'Submit in batches of 50â€“100 URLs. Too many at once may trigger spam filters on ping services.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: '50â€“100/batch', action: 'Safe ping batch size' }]
  },

  gsc_inspector: {
    title: 'ğŸ”¬ GSC Inspector Help',
    workflow: ['Connect GSC', 'Select Property', 'Inspect URLs', 'Analyze Coverage', 'Fix Issues'],
    sections: [
      {
        title: 'Google Search Console Integration',
        items: [
          { icon: 'ğŸ”‘', label: 'API Access Required', text: 'Connect your Google account in Settings to authorize GSC access. Requires Search Console read permissions.', type: 'warn' },
          { icon: 'ğŸ”', label: 'URL Inspection', text: 'Inspect individual URLs to see their Google index status, last crawl date, and any coverage issues.', type: 'tip' },
          { icon: 'ğŸ“Š', label: 'Coverage Report', text: 'Shows all indexed, excluded, and errored pages. Focus on "Excluded" â€” many of these can be fixed.', type: 'tip' },
        ]
      },
      {
        title: 'Common Issues & Fixes',
        items: [
          { icon: 'ğŸš«', label: 'Crawled Not Indexed', text: 'Usually means thin content. Add more unique, valuable content and resubmit.', type: 'warn' },
          { icon: 'ğŸ”€', label: 'Duplicate Without Canonical', text: 'Add rel="canonical" tags. Use the Robots.txt checker to audit your canonical setup.', type: 'tip' },
          { icon: 'âŒ', label: 'Redirect Error', text: 'Fix redirect chains (Aâ†’Bâ†’C). All redirects should go directly to the final destination.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: 'Crawled â‰  Indexed', action: 'Add more content' }, { key: '301 redirect', action: 'Fix chains to 1 hop' }]
  },

  list_manager: {
    title: 'ğŸ“‹ List Manager Help',
    workflow: ['Import URLs', 'Organize into Named Lists', 'Deduplicate', 'Assign to Campaigns'],
    sections: [
      {
        title: 'List Operations',
        items: [
          { icon: 'ğŸ“‹', label: 'Global URL List', text: 'The Global URL List is shared across all tools. Import quality URLs here once and reuse everywhere.', type: 'tip' },
          { icon: 'ğŸ”€', label: 'Deduplication', text: 'Run dedup before every campaign â€” the scraper may find the same URLs from multiple sources.', type: 'tip' },
          { icon: 'ğŸ·', label: 'Named Lists', text: 'Create named lists per campaign or niche. Example: "health-blogs-DA30+", "tech-commentluv".', type: 'info' },
        ]
      },
      {
        title: 'Import/Export',
        items: [
          { icon: 'ğŸ“¥', label: 'Import Formats', text: 'Supports TXT (one URL/line), CSV, and JSON. Column detection is automatic for CSV files.', type: 'tip' },
          { icon: 'ğŸ’¾', label: 'Backup Lists', text: 'Export your master list monthly. Lists are saved in localStorage â€” clearing browser data will delete them.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: 'Ctrl+A, Del', action: 'Clear all list items' }]
  },

  footprint_builder: {
    title: 'ğŸ‘£ Footprint Builder Help',
    workflow: ['Choose Footprint Type', 'Enter Keywords', 'Generate Queries', 'Send to SERP Scraper'],
    sections: [
      {
        title: 'Footprint Types',
        items: [
          { icon: 'ğŸ’¬', label: 'Comment Footprints', text: 'Find comment-enabled pages: <code>keyword "leave a reply"</code>, <code>keyword "powered by WordPress"</code>', type: 'tip' },
          { icon: 'ğŸ“', label: 'Forum Footprints', text: 'Find forum threads: <code>keyword site:reddit.com</code>, <code>keyword "forum" inurl:viewtopic</code>', type: 'tip' },
          { icon: 'ğŸ“š', label: 'Resource Footprints', text: 'Find resource/link pages: <code>keyword "useful links" inurl:resources</code>', type: 'info' },
          { icon: 'ğŸ¤', label: 'Guest Post Footprints', text: 'Find guest post opportunities: <code>keyword "write for us"</code>, <code>keyword "guest post guidelines"</code>', type: 'tip' },
        ]
      },
      {
        title: 'Advanced Operators',
        items: [
          { icon: 'ğŸ”', label: 'inurl:', text: 'Match text in the URL. Example: <code>inurl:blog/2024</code> for recent blog posts.', type: 'info' },
          { icon: 'ğŸ“„', label: 'intitle:', text: 'Match page title. <code>intitle:"submit a guest post"</code> finds guest post pages directly.', type: 'info' },
          { icon: 'ğŸŒ', label: 'site:', text: 'Limit to a domain. Combine with other operators for powerful targeted searches.', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: '"leave a reply"', action: 'WordPress comment footprint' }, { key: '"write for us"', action: 'Guest post footprint' }]
  },

  anchor_text: {
    title: 'âš“ Anchor Text Manager Help',
    workflow: ['Define Anchor Categories', 'Set Ratios', 'Generate Anchor Variations', 'Assign to Campaign'],
    sections: [
      {
        title: 'Anchor Text Types',
        items: [
          { icon: 'ğŸ¯', label: 'Exact Match', text: 'Your target keyword exactly. Keep this at 10% max to avoid over-optimization. Example: "buy blue widgets"', type: 'warn' },
          { icon: 'ğŸ“', label: 'Partial Match', text: 'Contains part of keyword + other words. 20% is safe. Example: "find blue widgets online"', type: 'tip' },
          { icon: 'ğŸ·', label: 'Branded', text: 'Your brand name as anchor. 30â€“40% of links should be branded â€” this looks most natural.', type: 'tip' },
          { icon: 'ğŸ’¬', label: 'Generic', text: '"Click here", "visit this site", "learn more" â€” use 20â€“30% generic anchors to diversify.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Naked URL', text: 'The URL itself as anchor (https://...). Use 10â€“15% of the time â€” very natural looking.', type: 'info' },
        ]
      },
      {
        title: 'Recommended Ratios',
        items: [
          { icon: 'ğŸ“Š', label: 'Safe Profile', text: 'Branded 40% + Generic 25% + Partial 20% + Naked URL 10% + Exact Match 5%', type: 'tip' },
          { icon: 'âš ', label: 'Danger Signs', text: 'If exact match exceeds 20â€“30%, you risk a Penguin-style penalty. Check your anchor ratio in the analytics.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: 'Exact â‰¤ 10%', action: 'Safe threshold' }, { key: 'Branded 40%', action: 'Most natural anchor type' }]
  },

  tiered_links: {
    title: 'ğŸ— Tiered Links Help',
    workflow: ['Set Money URL (Tier 1 Target)', 'Build Tier 1 Links', 'Build Tier 2 Links to Tier 1', 'Optional: Tier 3 to Tier 2', 'Index All Tiers'],
    sections: [
      {
        title: 'Tiered Link Building',
        items: [
          { icon: 'ğŸ†', label: 'Tier 1 (Direct)', text: 'High-quality links pointing directly at your money site. Use only quality placements â€” these must be clean.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Tier 2 (Amplifiers)', text: 'Links pointing to your Tier 1 URLs to boost their authority. Can use lower-quality, high-volume links.', type: 'info' },
          { icon: 'âš¡', label: 'Tier 3 (Indexers)', text: 'Links to Tier 2 to help get them crawled and indexed. Blog comments, profiles, directories work well here.', type: 'info' },
        ]
      },
      {
        title: 'Safety Rules',
        items: [
          { icon: 'ğŸ›¡', label: 'Buffer Tier 1', text: 'Never point spammy links directly at your money site. That\'s what Tier 2/3 are for â€” insulation.', type: 'warn' },
          { icon: 'â±', label: 'Build Gradually', text: 'Build Tier 2 over days, not hours. Natural velocity at every tier prevents algorithmic flags.', type: 'warn' },
          { icon: 'ğŸ”€', label: 'Vary Anchors Per Tier', text: 'Use exact match anchors in Tier 2/3 more freely â€” they\'re buffered from your site.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: 'Tier 1', action: 'Quality only â€” direct to site' }, { key: 'Tier 2+', action: 'Volume OK â€” buffered' }]
  },

  proxy_manager: {
    title: 'ğŸ”€ Proxy Manager Help',
    workflow: ['Add Proxies', 'Test All', 'Assign Pools', 'Set Rotation Strategy', 'Assign Pools to Tools'],
    sections: [
      {
        title: 'Proxy Setup',
        items: [
          { icon: 'â•', label: 'Adding Proxies', text: 'Import in format: <code>IP:PORT</code> or <code>IP:PORT:USER:PASS</code>. Supports HTTP, HTTPS, and SOCKS5.', type: 'tip' },
          { icon: 'ğŸ§ª', label: 'Test Before Use', text: 'Always run "Test All" after importing. Dead proxies waste threads and slow down your campaigns.', type: 'tip' },
          { icon: 'ğŸŠ', label: 'Proxy Pools', text: 'Create separate pools for scrapers vs. commenters. Commenter IPs get flagged faster â€” keep them separate.', type: 'tip' },
        ]
      },
      {
        title: 'Rotation Strategies',
        items: [
          { icon: 'ğŸ”„', label: 'Round Robin', text: 'Cycles through proxies sequentially. Good default for most tools.', type: 'info' },
          { icon: 'ğŸ²', label: 'Random', text: 'Picks proxies randomly. Useful when you have many proxies and want unpredictable patterns.', type: 'info' },
          { icon: 'ğŸ“‰', label: 'Least Used', text: 'Always picks the freshest proxy. Best for high-trust operations where proxy reputation matters.', type: 'tip' },
          { icon: 'âš¡', label: 'Auto-Remove', text: 'Enable auto-remove after N failures so dead proxies don\'t waste your thread capacity.', type: 'tip' },
        ]
      },
      {
        title: 'Health Monitoring',
        items: [
          { icon: 'ğŸ“Š', label: 'Uptime %', text: 'Sort by uptime to quickly identify your most reliable proxies. Prioritize high-uptime IPs for Tier 1 work.', type: 'tip' },
          { icon: 'â›”', label: 'Ban Detection', text: 'When a proxy gets banned, it\'s auto-marked. Enable notifications to alert you when pool drops below threshold.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: 'IP:PORT', action: 'Basic proxy format' }, { key: 'IP:PORT:USER:PASS', action: 'Auth proxy format' }]
  },

  captcha_solver: {
    title: 'ğŸ›¡ Captcha Solver Help',
    workflow: ['Add API Key for Solving Service', 'Choose Solver Type', 'Test Connection', 'Enable in Tools'],
    sections: [
      {
        title: 'Supported Services',
        items: [
          { icon: 'ğŸ’°', label: '2captcha', text: 'Pay-per-solve human captcha solving. ~$1â€“2 per 1,000 solves. Reliable for reCAPTCHA v2/v3.', type: 'info' },
          { icon: 'ğŸ¤–', label: 'Anti-Captcha', text: 'Similar to 2captcha. Has an image-to-text API that\'s faster for simple checkbox captchas.', type: 'info' },
          { icon: 'ğŸ§ ', label: 'CapMonster', text: 'Local AI-based solver â€” no per-solve cost after purchase. Best for high-volume operations.', type: 'tip' },
        ]
      },
      {
        title: 'Configuration',
        items: [
          { icon: 'ğŸ”‘', label: 'API Key Setup', text: 'Enter your API key in Settings â†’ Captcha. The solver activates automatically in Commenter and Account Creator.', type: 'tip' },
          { icon: 'ğŸ’¡', label: 'Bypass vs. Solve', text: 'For reCAPTCHA v3, use token injection mode rather than visual solving â€” it\'s faster and cheaper.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: '~$1â€“2/1000', action: '2captcha pricing' }, { key: 'v3 = token mode', action: 'reCAPTCHA v3 method' }]
  },

  platform_manager: {
    title: 'ğŸŒ Platform Manager Help',
    workflow: ['Browse Platforms', 'Filter by Type/DA', 'Add to Campaign', 'Configure Per-Platform Settings'],
    sections: [
      {
        title: 'Platform Database',
        items: [
          { icon: 'ğŸ”', label: 'Filtering', text: 'Filter platforms by type (Web 2.0, Forum, Blog, Directory) and minimum DA to find the best targets for your niche.', type: 'tip' },
          { icon: 'ğŸ“Š', label: 'Platform Stats', text: 'Each platform shows DA, dofollow status, registration ease, and whether comments are auto-approved.', type: 'info' },
          { icon: 'â­', label: 'Priority Platforms', text: 'Sort by DA and focus on platforms with DA 25+ that allow dofollow links for maximum impact.', type: 'tip' },
        ]
      },
      {
        title: 'Custom Platforms',
        items: [
          { icon: 'â•', label: 'Add Custom', text: 'Found a high-DA blog in your niche? Add it as a custom platform and it\'ll show up in your campaign tool targets.', type: 'tip' },
          { icon: 'ğŸ”„', label: 'Update Database', text: 'Platform availability changes. Check the "Last Verified" date and remove dead platforms from your rotation.', type: 'warn' },
        ]
      }
    ],
    shortcuts: [{ key: 'DA 25+', action: 'Worth targeting' }, { key: 'Dofollow = Yes', action: 'Priority filter' }]
  },

  settings: {
    title: 'âš™ Settings Help',
    workflow: ['Add API Keys', 'Configure Proxies', 'Set Rate Limits', 'Save Profile', 'Test Connections'],
    sections: [
      {
        title: 'API Keys',
        items: [
          { icon: 'ğŸ¤–', label: 'Claude API', text: 'Required for AI-powered content generation and smart comment writing. Get key from console.anthropic.com.', type: 'warn' },
          { icon: 'ğŸ“Š', label: 'OpenPageRank', text: 'Required for DA/PA checking. Free tier: 5,000 requests/day. Get key at www.domcop.com/openpagerank/', type: 'info' },
          { icon: 'ğŸ”', label: 'SerpAPI', text: 'Required for SERP Scraper. Get key at serpapi.com â€” free tier: 100 searches/month.', type: 'info' },
          { icon: 'ğŸ“…', label: 'WHOIS API', text: 'Required for Domain Age Checker. Get key at whoisxmlapi.com.', type: 'info' },
        ]
      },
      {
        title: 'Rate Limits & Safety',
        items: [
          { icon: 'âš¡', label: 'Request Delay', text: 'Set a 500â€“2000ms delay between requests per thread to avoid triggering rate limiters and Cloudflare.', type: 'warn' },
          { icon: 'ğŸ›¡', label: 'User Agent Rotation', text: 'Enable UA rotation to mimic different browsers. Reduces detection on aggressive anti-bot systems.', type: 'tip' },
          { icon: 'ğŸ’¾', label: 'Import/Export', text: 'Export all settings as a JSON backup before making major changes. Import to restore instantly.', type: 'tip' },
        ]
      },
      {
        title: 'Profiles',
        items: [
          { icon: 'ğŸ‘¤', label: 'Profile System', text: 'Create separate profiles for different clients or projects. Each profile stores its own API keys and settings.', type: 'tip' },
          { icon: 'ğŸ”„', label: 'Switch Profiles', text: 'Switch profiles instantly from the settings header dropdown. All tool settings update automatically.', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: '500â€“2000ms', action: 'Safe request delay' }, { key: 'Ctrl+Shift+E', action: 'Export settings' }]
  },

  analytics: {
    title: 'ğŸ“ˆ Analytics Hub Help',
    workflow: ['Review Run History', 'Track ROI', 'Set Up Schedules', 'Create Pipelines', 'Configure Webhooks'],
    sections: [
      {
        title: 'Analytics Dashboard',
        items: [
          { icon: 'ğŸ“ˆ', label: 'Run History', text: 'See every tool run with timestamp, success count, and duration. Use this to spot patterns and optimize.', type: 'tip' },
          { icon: 'ğŸ’°', label: 'ROI Tracker', text: 'Enter your link costs and tracked keyword positions to calculate the ROI of each campaign.', type: 'info' },
          { icon: 'ğŸŒ¡', label: 'Platform Heatmap', text: 'Shows which platforms have the best success rate. Focus your next campaign on green-zone platforms.', type: 'tip' },
        ]
      },
      {
        title: 'Automation',
        items: [
          { icon: 'ğŸ“…', label: 'Schedules', text: 'Schedule any tool to run at specific times. Example: run DA Checker every Monday at 9am.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Pipelines', text: 'Chain tools together: Scrape â†’ Filter DA > 30 â†’ Comment. Runs automatically without manual intervention.', type: 'tip' },
          { icon: 'ğŸ””', label: 'Webhooks', text: 'Send completion events to Zapier/Make.com to trigger external actions (e.g., Slack notifications, spreadsheet updates).', type: 'info' },
        ]
      }
    ],
    shortcuts: [{ key: 'Green heatmap', action: 'High-success platforms' }, { key: 'Pipeline', action: 'Full automation chain' }]
  },

  pdf_parasite: {
    title: 'ğŸ“„ PDF Parasite SEO Help',
    workflow: ['Build PDF Document', 'Scan Upload Targets', 'Select Platforms', 'Upload PDF', 'Harvest Links'],
    sections: [
      {
        title: 'What is PDF Parasite SEO?',
        items: [
          { icon: 'ğŸ¦ ', label: 'Concept', text: 'Upload keyword-optimized PDFs to high-DA platforms (Scribd DA95, SlideShare DA95, Academia DA95). The PDF links back to your site and gets indexed as a high-authority backlink.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Link Juice', text: 'Links inside PDFs on DA90+ domains pass significant link equity. Many platforms also give the PDF its own indexed URL you can build Tier 2 links to.', type: 'tip' },
          { icon: 'ğŸ“ˆ', label: 'Ranking Boost', text: 'A single Scribd or Google Drive PDF with exact-match anchor text can move rankings within days â€” especially for low-competition keywords.', type: 'info' },
        ]
      },
      {
        title: 'PDF Builder Tips',
        items: [
          { icon: 'ğŸ¯', label: 'Keyword Density', text: 'Include your target keyword in the title, first paragraph, and 2â€“3 times throughout. Use H2/H3 headings to structure sections around related keywords.', type: 'tip' },
          { icon: 'ğŸ”—', label: 'Link Placement', text: 'Add your money URL as a hyperlink in the first 20% of the document. Anchor text should match your target keyword. Add a second link at the bottom.', type: 'tip' },
          { icon: 'ğŸ“¸', label: 'Images & Media', text: 'Add relevant images with keyword-rich alt text. PDFs with images get higher engagement scores on platforms like Scribd, improving their own rankings.', type: 'info' },
          { icon: 'ğŸ“', label: 'Document Length', text: 'Aim for 800â€“2000 words. Too short = low quality signals. Too long = lower read-through rate. Add a table or list to improve scannability.', type: 'tip' },
        ]
      },
      {
        title: 'Upload Strategy',
        items: [
          { icon: 'â­', label: 'Prioritize DA90+', text: 'Focus on Scribd, SlideShare, Academia.edu, Google Drive. One upload to these outperforms 50 uploads to DA30 sites.', type: 'tip' },
          { icon: 'ğŸ“§', label: 'Accounts Required', text: 'Most platforms require an account to upload. Use the Account Creator to batch-create accounts before running the upload campaign.', type: 'warn' },
          { icon: 'â±', label: 'Indexing Time', text: 'Platform pages get indexed within 24â€“72h on high-DA sites. Use the Link Indexer to speed this up.', type: 'info' },
          { icon: 'ğŸ”„', label: 'Batch Strategy', text: 'Upload slightly different versions (different title, intro paragraph) to each platform. Avoids duplicate content issues between platforms.', type: 'tip' },
        ]
      }
    ],
    shortcuts: [{ key: 'Ctrl+Shift+F', action: 'Open PDF Parasite' }, { key: 'DA90+', action: 'Target threshold' }]
  }
};

// â”€â”€â”€ HELP ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function helpBuildWorkflow(steps){
  if(!steps||!steps.length) return '';
  return `<div class="help-workflow">${steps.map((s,i)=>`<div class="help-wf-step"><span class="wf-num">${i+1}</span>${s}</div>`).join('')}</div>`;
}

function helpBuildTipsBar(pageId){
  const data = HELP_CONTENT[pageId];
  if(!data) return '';
  const tipCount = data.sections ? data.sections.reduce((a,s)=>a+(s.items?s.items.length:0),0) : 0;
  if(!tipCount) return '';
  // Pick up to 4 quick tips to show inline
  const allTips = [];
  (data.sections||[]).forEach(s=>(s.items||[]).forEach(t=>allTips.push(t)));
  const quickTips = allTips.slice(0,4);
  const collapsed = localStorage.getItem('rf_help_tips_'+pageId) === 'collapsed';
  return `<div class="help-tips-bar${collapsed?' collapsed':''}" id="htb-${pageId}">
    <div class="help-tips-header" onclick="helpToggleTips('${pageId}')">
      <span>ğŸ’¡</span>
      <span>Quick Tips</span>
      <span style="color:var(--text3);font-weight:400"> â€” ${data.title}</span>
      <button class="ph-help" style="margin-left:8px" onclick="event.stopPropagation();helpDrawerOpen('${pageId}')" title="Open full help guide">?</button>
      <span class="help-tips-toggle" id="htb-toggle-${pageId}">${collapsed?'â–¼ show':'â–² hide'}</span>
    </div>
    <div class="help-tips-body">
      ${quickTips.map(t=>`<div class="help-tip"><span class="help-tip-icon">${t.icon}</span><div><strong>${t.label}:</strong> ${t.text}</div></div>`).join('')}
    </div>
  </div>`;
}

function helpToggleTips(pageId){
  const bar = document.getElementById('htb-'+pageId);
  const tog = document.getElementById('htb-toggle-'+pageId);
  if(!bar) return;
  const isCollapsed = bar.classList.toggle('collapsed');
  if(tog) tog.textContent = isCollapsed ? 'â–¼ show' : 'â–² hide';
  localStorage.setItem('rf_help_tips_'+pageId, isCollapsed?'collapsed':'open');
}

function helpDrawerOpen(pageId){
  const data = HELP_CONTENT[pageId];
  if(!data) return;
  const body = document.getElementById('help-drawer-body');
  const title = document.getElementById('help-drawer-title');
  if(!body||!title) return;
  title.textContent = data.title;
  let html = '';

  // Workflow
  if(data.workflow&&data.workflow.length){
    html += `<div class="hd-section"><div class="hd-section-title">âš¡ Workflow</div>
      ${data.workflow.map((s,i)=>`<div class="hd-item"><span class="hd-item-icon" style="font-size:11px;font-family:var(--mono);color:var(--green);min-width:18px">${i+1}.</span><div class="hd-item-text"><span>${s}</span></div></div>`).join('')}
    </div>`;
  }

  // Sections
  (data.sections||[]).forEach(sec=>{
    html += `<div class="hd-section"><div class="hd-section-title">${sec.title}</div>`;
    (sec.items||[]).forEach(item=>{
      const cls = item.type==='warn'?'warn':item.type==='info'?'info':'';
      html += `<div class="hd-item ${cls}"><span class="hd-item-icon">${item.icon}</span><div class="hd-item-text"><strong>${item.label}</strong><span>${item.text}</span></div></div>`;
    });
    html += '</div>';
  });

  // Shortcuts / Quick Ref
  if(data.shortcuts&&data.shortcuts.length){
    html += `<div class="hd-section"><div class="hd-section-title">ğŸ“Œ Quick Reference</div>
      <div class="hd-shortcut-grid">
        ${data.shortcuts.map(s=>`<span class="hd-kbd">${s.key}</span><span style="font-size:10px;color:var(--text2);display:flex;align-items:center">${s.action}</span>`).join('')}
      </div>
    </div>`;
  }

  body.innerHTML = html;
  document.getElementById('help-drawer').classList.add('open');
  document.getElementById('help-backdrop').classList.add('open');
}

function helpDrawerClose(){
  document.getElementById('help-drawer').classList.remove('open');
  document.getElementById('help-backdrop').classList.remove('open');
}

// Inject help tips bar at the start of each page's HTML
function helpWrap(pageId, innerHtml){
  return helpBuildWorkflow((HELP_CONTENT[pageId]||{}).workflow) + helpBuildTipsBar(pageId) + innerHtml;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF PARASITE TOOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF PARASITE â€” Upload Scanner, PDF Builder, Link Harvester
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(!window.PP_STATE) window.PP_STATE = {
  scanResults: [],      // [{url, status, uploadField, formAction, method, fileInputName, extraFields, notes}]
  uploadResults: [],    // [{url, fileName, uploadedPath, status, formData, timestamp}]
  pdfQueue: [],         // PDFs waiting to upload
  activePdf: null,      // Currently built PDF blob
  activeTab: 'scanner', // scanner | builder | uploads | results
};

// PDF builder document state
if(!window.PP_DOC) window.PP_DOC = {
  title: 'My SEO Document',
  author: '',
  description: '',
  keywords: '',
  blocks: [], // [{type, content, attrs}]
};

const PP_BLOCK_TYPES = {
  h1:       { icon: 'H1', label: 'Heading 1',   color: 'var(--green)' },
  h2:       { icon: 'H2', label: 'Heading 2',   color: 'var(--blue)'  },
  h3:       { icon: 'H3', label: 'Heading 3',   color: 'var(--cyan)'  },
  p:        { icon: 'Â¶',  label: 'Paragraph',   color: 'var(--text2)' },
  link:     { icon: 'ğŸ”—', label: 'Hyperlink',   color: 'var(--blue)'  },
  image:    { icon: 'ğŸ–¼', label: 'Image/GIF',   color: 'var(--purple)'},
  video:    { icon: 'ğŸ¥', label: 'Video Link',  color: 'var(--orange)'},
  divider:  { icon: 'â€”',  label: 'Divider',     color: 'var(--text3)' },
  code:     { icon: '<>', label: 'Code Block',  color: 'var(--yellow)'},
  quote:    { icon: '"',  label: 'Blockquote',  color: 'var(--green)' },
  list:     { icon: 'â€¢',  label: 'List',        color: 'var(--text2)' },
  table:    { icon: 'âŠ',  label: 'Table',       color: 'var(--cyan)'  },
  spacer:   { icon: 'â†•',  label: 'Spacer',      color: 'var(--text3)' },
};

// Known file-upload platform signatures
const PP_UPLOAD_SIGNATURES = [
  { name: 'Generic file input',       selector: 'input[type="file"]',                   score: 10 },
  { name: 'PDF-specific accept',      selector: 'input[accept*="pdf"]',                 score: 25 },
  { name: 'Document upload button',   selector: '[class*="upload"],[id*="upload"]',     score: 8  },
  { name: 'Dropzone area',            selector: '[class*="dropzone"],[class*="drop"]',  score: 15 },
  { name: 'File form action',         selector: 'form[enctype="multipart/form-data"]',  score: 12 },
  { name: 'Submit + file combined',   selector: 'form:has(input[type="file"])',         score: 20 },
];

const PP_KNOWN_PLATFORMS = [
  { name: 'Scribd',         url: 'https://www.scribd.com/upload-document',  accepts: ['pdf','doc','docx'], da: 95, notes: 'DA95 â€” public docs indexed by Google fast' },
  { name: 'SlideShare',     url: 'https://www.slideshare.net/upload',       accepts: ['pdf','ppt','pptx'], da: 95, notes: 'LinkedIn-owned, huge SEO authority' },
  { name: 'Academia.edu',   url: 'https://www.academia.edu/upload',         accepts: ['pdf'],              da: 95, notes: 'Academic context, high trust' },
  { name: 'ResearchGate',   url: 'https://www.researchgate.net/publication',accepts: ['pdf'],              da: 93, notes: 'Research niche authority' },
  { name: 'Issuu',          url: 'https://issuu.com/upload',                accepts: ['pdf'],              da: 94, notes: 'Magazine-style, indexed well' },
  { name: 'DocPlayer',      url: 'https://docplayer.net/',                  accepts: ['pdf','doc'],        da: 86, notes: 'Auto-extracts text & links' },
  { name: 'DocDroid',       url: 'https://www.docdroid.net/',               accepts: ['pdf'],              da: 83, notes: 'Direct PDF link sharing' },
  { name: 'Box.com',        url: 'https://app.box.com/upload',              accepts: ['pdf','doc','any'],  da: 93, notes: 'Enterprise file share, indexed' },
  { name: 'Google Drive',   url: 'https://drive.google.com',                accepts: ['pdf','any'],        da: 100,notes: 'DA100 â€” embed in sites for Parasite SEO' },
  { name: 'OneDrive',       url: 'https://onedrive.live.com',               accepts: ['pdf','any'],        da: 98, notes: 'Microsoft, high-authority links' },
  { name: 'MediaFire',      url: 'https://www.mediafire.com/upload/',       accepts: ['pdf','any'],        da: 92, notes: 'File hosting with public links' },
  { name: '4shared',        url: 'https://www.4shared.com/',                accepts: ['pdf','any'],        da: 86, notes: 'Classic file sharing DA' },
  { name: 'Calameo',        url: 'https://en.calameo.com/accounts/upload',  accepts: ['pdf'],              da: 88, notes: 'Publication embed links' },
  { name: 'Yumpu',          url: 'https://www.yumpu.com/en/upload',         accepts: ['pdf'],              da: 76, notes: 'Flipbook-style PDF hosting' },
];

// â”€â”€ SCAN ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function pp_scanUrl(url) {
  const result = {
    url, status: 'scanning', uploadField: false,
    formAction: null, method: 'POST', fileInputName: 'file',
    extraFields: [], notes: '', score: 0, platform: null, timestamp: Date.now()
  };

  // Check if it matches a known platform first
  const known = PP_KNOWN_PLATFORMS.find(p => url.includes(new URL(p.url).hostname.replace('www.','')) || p.url.startsWith(url));
  if(known) {
    result.platform = known.name;
    result.notes = known.notes;
    result.score = known.da;
  }

  try {
    log(`[PDF Parasite] Scanning: ${url}`, 'info');
    const resp = await fetch(url, {
      method: 'GET',
      signal: AbortSignal.timeout(12000),
      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' }
    });

    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Look for file inputs
    const fileInputs = doc.querySelectorAll('input[type="file"]');
    const pdfInputs = doc.querySelectorAll('input[accept*="pdf"],input[accept*="PDF"]');
    const uploadForms = doc.querySelectorAll('form[enctype="multipart/form-data"]');
    const dropzones = doc.querySelectorAll('[class*="dropzone"],[class*="drop-zone"],[id*="dropzone"]');

    result.uploadField = fileInputs.length > 0 || uploadForms.length > 0 || dropzones.length > 0;
    result.hasPdfSpecific = pdfInputs.length > 0;
    result.hasDropzone = dropzones.length > 0;

    // Extract form details
    if(uploadForms.length > 0) {
      const form = uploadForms[0];
      result.formAction = form.getAttribute('action') || url;
      result.method = (form.getAttribute('method') || 'POST').toUpperCase();

      // Collect all form fields
      const fields = [];
      form.querySelectorAll('input:not([type="file"]),select,textarea').forEach(inp => {
        if(inp.name) fields.push({
          name: inp.name,
          type: inp.type || 'text',
          value: inp.value || '',
          required: inp.required,
          placeholder: inp.placeholder || ''
        });
      });
      result.extraFields = fields;
    }

    // Get file input name
    if(fileInputs.length > 0) {
      result.fileInputName = fileInputs[0].getAttribute('name') || 'file';
      const accepts = fileInputs[0].getAttribute('accept') || '';
      result.acceptedTypes = accepts || 'any';
    }

    // Score the opportunity
    let score = 0;
    if(result.uploadField) score += 30;
    if(result.hasPdfSpecific) score += 25;
    if(result.hasDropzone) score += 10;
    if(uploadForms.length > 0) score += 20;
    if(known) score = Math.max(score, known.da);
    result.score = Math.min(score, 100);

    result.status = result.uploadField ? 'upload_found' : 'no_upload';
    log(`[PDF Parasite] ${url}: ${result.status} (score: ${result.score})`, result.uploadField ? 'ok' : 'info');

  } catch(e) {
    if(e.message.includes('CORS') || e.name === 'TypeError') {
      // CORS blocked â€” but may still work. Mark as probable
      result.status = 'cors_blocked';
      result.notes = (result.notes ? result.notes + ' | ' : '') + 'CORS blocked â€” likely has upload (try manually)';
      result.score = known ? known.da : 40;
      log(`[PDF Parasite] ${url}: CORS blocked â€” treating as probable upload target`, 'warn');
    } else {
      result.status = 'error';
      result.notes = e.message;
      log(`[PDF Parasite] ${url}: Error â€” ${e.message}`, 'err');
    }
  }
  return result;
}

async function pp_runScan() {
  const urlsRaw = (document.getElementById('pp-scan-urls')||{value:''}).value.trim();
  const includeKnown = document.getElementById('pp-scan-known')?.checked;

  const urls = [];
  if(urlsRaw) urls.push(...urlsRaw.split('\n').map(u=>u.trim()).filter(u=>u.startsWith('http')));
  if(includeKnown) PP_KNOWN_PLATFORMS.forEach(p => { if(!urls.includes(p.url)) urls.push(p.url); });

  if(!urls.length) { log('[PDF Parasite] No URLs to scan','warn'); return; }

  PP_STATE.scanResults = [];
  APP.running = true; APP.stopFlag = false;
  setStatus('Scanning for PDF upload targets...');
  log(`[PDF Parasite] Scanning ${urls.length} URLs for upload fields...`, 'info');

  const prog = document.getElementById('pp-scan-prog');
  let done = 0;

  for(const url of urls) {
    if(APP.stopFlag) break;
    const result = await pp_scanUrl(url);
    PP_STATE.scanResults.push(result);
    done++;
    if(prog) prog.style.width = Math.round(done/urls.length*100)+'%';
    setProgress(Math.round(done/urls.length*100), `${done}/${urls.length}`);
    await sleep(rand(200,600));
  }

  APP.running = false; setStatus('Done');
  const found = PP_STATE.scanResults.filter(r=>r.status==='upload_found'||r.status==='cors_blocked').length;
  log(`[PDF Parasite] Scan complete â€” ${found}/${urls.length} upload targets found`, found>0?'ok':'warn');

  SS.rawSet('rf_ac_tab','scanner');
  render_pdf_parasite(document.getElementById('page-pdf_parasite'));
}

// â”€â”€ PDF UPLOAD ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function pp_uploadPdf(targetUrl, pdfBlob, fileName, extraFieldValues={}) {
  const uploadResult = {
    url: targetUrl, fileName, status: 'uploading',
    uploadedPath: null, formData: {}, timestamp: Date.now()
  };

  log(`[PDF Parasite] Uploading ${fileName} to ${targetUrl}...`, 'info');

  try {
    const formData = new FormData();
    formData.append('file', pdfBlob, fileName);

    // Fill extra fields
    Object.entries(extraFieldValues).forEach(([k,v]) => {
      formData.append(k, v);
      uploadResult.formData[k] = v;
    });

    const resp = await fetch(targetUrl, {
      method: 'POST',
      body: formData,
      signal: AbortSignal.timeout(30000),
    });

    const text = await resp.text();

    // Try to extract the uploaded file URL from the response
    const urlPatterns = [
      /https?:\/\/[^\s"'<>]+\.pdf[^\s"'<>]*/gi,
      /https?:\/\/[^\s"'<>]+\/(?:files?|uploads?|documents?|docs?)\/[^\s"'<>]+/gi,
      /"(?:url|href|path|location|file_url|download_url|public_url)"\s*:\s*"([^"]+)"/gi,
      /(?:href|src)=["']([^"']*(?:upload|files?|documents?)[^"']*)["']/gi,
    ];

    let uploadedPath = null;
    for(const pattern of urlPatterns) {
      const matches = [...text.matchAll(pattern)];
      if(matches.length) {
        uploadedPath = matches[0][1] || matches[0][0];
        if(uploadedPath && !uploadedPath.startsWith('http')) {
          const base = new URL(targetUrl);
          uploadedPath = base.origin + uploadedPath;
        }
        break;
      }
    }

    // Also try looking for redirect location
    if(!uploadedPath && resp.redirected) {
      uploadedPath = resp.url;
    }

    uploadResult.status = resp.ok ? 'success' : 'error_http';
    uploadResult.uploadedPath = uploadedPath;
    uploadResult.httpStatus = resp.status;
    uploadResult.responsePreview = text.slice(0,500);

    if(uploadedPath) {
      log(`[PDF Parasite] âœ“ Uploaded! Link: ${uploadedPath}`, 'ok');
    } else {
      log(`[PDF Parasite] Upload sent (HTTP ${resp.status}) â€” no direct URL extracted. Check response.`, 'warn');
    }

  } catch(e) {
    uploadResult.status = e.name === 'TypeError' ? 'cors_blocked' : 'error';
    uploadResult.error = e.message;
    log(`[PDF Parasite] Upload to ${targetUrl} failed: ${e.message}`, 'err');
  }

  PP_STATE.uploadResults.push(uploadResult);
  SS.set('rf_pp_uploads', PP_STATE.uploadResults);
  render_pdf_parasite(document.getElementById('page-pdf_parasite'));
  return uploadResult;
}

async function pp_startUpload() {
  if(!PP_STATE.activePdf) { log('[PDF Parasite] Build a PDF first in the Builder tab','warn'); return; }

  const selectedUrls = [...document.querySelectorAll('#pp-upload-targets input[type="checkbox"]:checked')]
    .map(cb => cb.value).filter(Boolean);

  if(!selectedUrls.length) { log('[PDF Parasite] Select at least one upload target','warn'); return; }

  const fileName = (document.getElementById('pp-upload-filename')||{value:''}).value.trim() || 'document.pdf';
  const cleanName = fileName.endsWith('.pdf') ? fileName : fileName + '.pdf';

  log(`[PDF Parasite] Uploading "${cleanName}" to ${selectedUrls.length} targets...`, 'info');
  APP.running = true; APP.stopFlag = false;
  setStatus('Uploading PDFs...');

  for(const url of selectedUrls) {
    if(APP.stopFlag) break;

    // Collect any extra field values from the form
    const extraFields = {};
    document.querySelectorAll(`[data-upload-field="${CSS.escape(url)}"]`).forEach(inp => {
      if(inp.name && inp.value) extraFields[inp.name] = inp.value;
    });

    await pp_uploadPdf(url, PP_STATE.activePdf, cleanName, extraFields);
    await sleep(rand(1000, 2500));
  }

  APP.running = false; setStatus('Done');
  SS.rawSet('rf_pp_tab','uploads');
  render_pdf_parasite(document.getElementById('page-pdf_parasite'));
}

// â”€â”€ PDF BUILDER ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function pp_addBlock(type) {
  const defaults = {
    h1:      { content: 'Main Heading' },
    h2:      { content: 'Section Heading' },
    h3:      { content: 'Sub-heading' },
    p:       { content: 'Write your paragraph here. Include your target keywords naturally in the text.' },
    link:    { content: 'Click here', href: 'https://yoursite.com', title: 'Your page title' },
    image:   { src: '', alt: 'Image description', caption: '', width: '100%' },
    video:   { url: 'https://www.youtube.com/watch?v=...', caption: 'Watch this video' },
    divider: { style: 'solid' },
    code:    { content: '// Your code here', language: 'javascript' },
    quote:   { content: 'Your blockquote text here.', author: '' },
    list:    { items: ['Item one', 'Item two', 'Item three'], ordered: false },
    table:   { headers: ['Column 1','Column 2','Column 3'], rows: [['Data','Data','Data']] },
    spacer:  { height: 20 },
  };
  const block = { id: Date.now() + Math.random(), type, ...defaults[type] };
  PP_DOC.blocks.push(block);
  pp_renderBuilder();
}

function pp_removeBlock(id) {
  PP_DOC.blocks = PP_DOC.blocks.filter(b => b.id !== id);
  pp_renderBuilder();
}

function pp_moveBlock(id, dir) {
  const idx = PP_DOC.blocks.findIndex(b => b.id === id);
  if(idx < 0) return;
  const newIdx = dir === 'up' ? idx-1 : idx+1;
  if(newIdx < 0 || newIdx >= PP_DOC.blocks.length) return;
  [PP_DOC.blocks[idx], PP_DOC.blocks[newIdx]] = [PP_DOC.blocks[newIdx], PP_DOC.blocks[idx]];
  pp_renderBuilder();
}

function pp_updateBlock(id, field, value) {
  const block = PP_DOC.blocks.find(b => b.id === id);
  if(block) {
    if(field.includes('.')) {
      const parts = field.split('.');
      let obj = block;
      for(let i=0;i<parts.length-1;i++) obj = obj[parts[i]];
      obj[parts[parts.length-1]] = value;
    } else {
      block[field] = value;
    }
  }
}

function pp_updateMeta(field, value) {
  PP_DOC[field] = value;
}

// Convert PP_DOC to HTML for PDF generation
function pp_docToHtml() {
  const styles = `
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: Georgia, 'Times New Roman', serif; font-size: 14px; color: #1a1a1a;
             background: #fff; line-height: 1.7; padding: 40px 60px; max-width: 800px; margin: 0 auto; }
      h1 { font-size: 28px; font-weight: 800; color: #111; margin: 32px 0 16px; line-height: 1.2; }
      h2 { font-size: 22px; font-weight: 700; color: #1a1a1a; margin: 28px 0 12px; border-bottom: 2px solid #e0e0e0; padding-bottom: 6px; }
      h3 { font-size: 17px; font-weight: 700; color: #333; margin: 22px 0 10px; }
      p  { margin: 12px 0; color: #333; }
      a  { color: #1a56db; text-decoration: underline; word-break: break-all; }
      img { max-width: 100%; height: auto; display: block; border-radius: 4px; margin: 12px auto; }
      hr { border: none; border-top: 2px solid #e0e0e0; margin: 24px 0; }
      blockquote { border-left: 4px solid #1a56db; padding: 10px 20px; background: #f8fafc;
                   margin: 16px 0; font-style: italic; color: #444; border-radius: 0 4px 4px 0; }
      pre { background: #1a1a1a; color: #e8e8e8; padding: 16px; border-radius: 6px; overflow-x: auto;
            font-family: 'Courier New', monospace; font-size: 12px; margin: 14px 0; }
      code { font-family: 'Courier New', monospace; font-size: 12px; }
      ul,ol { margin: 12px 0 12px 28px; }
      li { margin: 4px 0; }
      table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; }
      th { background: #1a56db; color: #fff; padding: 8px 12px; text-align: left; font-weight: 700; }
      td { padding: 7px 12px; border: 1px solid #e0e0e0; }
      tr:nth-child(even) td { background: #f8fafc; }
      .video-embed { background: #f0f4ff; border: 2px solid #1a56db; border-radius: 6px;
                     padding: 16px; margin: 14px 0; text-align: center; }
      .video-embed a { font-weight: 700; font-size: 15px; }
      .caption { font-size: 12px; color: #666; text-align: center; margin-top: 4px; font-style: italic; }
      .doc-meta { background: #f0f4ff; border-radius: 6px; padding: 16px 20px; margin-bottom: 32px;
                  border-left: 4px solid #1a56db; }
      .doc-meta h1 { font-size: 24px; margin: 0 0 6px; }
      .doc-meta .author { color: #555; font-size: 13px; }
      .doc-meta .desc { color: #333; margin-top: 6px; }
      .doc-meta .keywords { color: #1a56db; font-size: 11px; margin-top: 8px; }
    </style>`;

  let bodyHtml = `<div class="doc-meta">
    <h1>${esc(PP_DOC.title||'Untitled Document')}</h1>
    ${PP_DOC.author ? `<div class="author">By ${esc(PP_DOC.author)}</div>` : ''}
    ${PP_DOC.description ? `<div class="desc">${esc(PP_DOC.description)}</div>` : ''}
    ${PP_DOC.keywords ? `<div class="keywords">Keywords: ${esc(PP_DOC.keywords)}</div>` : ''}
  </div>`;

  PP_DOC.blocks.forEach(block => {
    switch(block.type) {
      case 'h1': bodyHtml += `<h1>${esc(block.content||'')}</h1>`; break;
      case 'h2': bodyHtml += `<h2>${esc(block.content||'')}</h2>`; break;
      case 'h3': bodyHtml += `<h3>${esc(block.content||'')}</h3>`; break;
      case 'p':  bodyHtml += `<p>${block.content||''}</p>`; break;
      case 'link': bodyHtml += `<p><a href="${esc(block.href||'#')}" title="${esc(block.title||'')}">${esc(block.content||'Click here')}</a></p>`; break;
      case 'image': bodyHtml += `<figure>
        ${block.src ? `<img src="${esc(block.src)}" alt="${esc(block.alt||'')}" style="width:${esc(block.width||'100%')}">` : '<div style="background:#f0f0f0;height:120px;display:flex;align-items:center;justify-content:center;color:#888;border-radius:4px">[Image: '+esc(block.alt||'')+'</div>]'}
        ${block.caption ? `<figcaption class="caption">${esc(block.caption)}</figcaption>` : ''}
      </figure>`; break;
      case 'video': bodyHtml += `<div class="video-embed">
        ğŸ¥ <a href="${esc(block.url||'')}">${esc(block.caption||block.url||'Watch Video')}</a>
        <div style="font-size:11px;color:#888;margin-top:4px">${esc(block.url||'')}</div>
      </div>`; break;
      case 'divider': bodyHtml += `<hr>`; break;
      case 'code': bodyHtml += `<pre><code>${esc(block.content||'')}</code></pre>`; break;
      case 'quote': bodyHtml += `<blockquote>${block.content||''}${block.author?`<footer style="margin-top:8px;font-size:12px;font-weight:700;font-style:normal">â€” ${esc(block.author)}</footer>`:''}</blockquote>`; break;
      case 'list': {
        const tag = block.ordered ? 'ol' : 'ul';
        const items = Array.isArray(block.items) ? block.items : (block.items||'').split('\n');
        bodyHtml += `<${tag}>${items.map(i=>`<li>${esc(i)}</li>`).join('')}</${tag}>`;
        break;
      }
      case 'table': {
        const headers = block.headers || [];
        const rows = block.rows || [];
        bodyHtml += `<table>
          <thead><tr>${headers.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead>
          <tbody>${rows.map(row=>`<tr>${row.map(c=>`<td>${esc(c)}</td>`).join('')}</tr>`).join('')}</tbody>
        </table>`;
        break;
      }
      case 'spacer': bodyHtml += `<div style="height:${parseInt(block.height||20)}px"></div>`; break;
    }
  });

  return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(PP_DOC.title||'Document')}</title>${styles}</head><body>${bodyHtml}</body></html>`;
}

// Generate a downloadable HTML-based "PDF" using print dialog
function pp_generatePdf() {
  const html = pp_docToHtml();
  const blob = new Blob([html], { type: 'text/html' });
  PP_STATE.activePdf = blob;
  PP_STATE.activePdfHtml = html;
  PP_STATE.activePdfName = (PP_DOC.title||'document').replace(/[^a-z0-9]/gi,'_').toLowerCase() + '.pdf';

  log(`[PDF Parasite] Document built: "${PP_DOC.title}" (${PP_DOC.blocks.length} blocks, ${html.length} chars)`, 'ok');
  SS.rawSet('rf_pp_tab','upload');
  render_pdf_parasite(document.getElementById('page-pdf_parasite'));
}

function pp_previewDoc() {
  const html = pp_docToHtml();
  const win = window.open('', '_blank', 'width=900,height=700');
  if(win) {
    win.document.write(html);
    win.document.close();
  }
}

function pp_downloadHtml() {
  const html = pp_docToHtml();
  const name = (PP_DOC.title||'document').replace(/[^a-z0-9]/gi,'_').toLowerCase();
  dlTxt(html, name + '.html');
  log(`[PDF Parasite] Downloaded as ${name}.html`, 'ok');
}

// Import markdown-like quick text
function pp_importMarkdown() {
  const md = (document.getElementById('pp-md-import')||{value:''}).value.trim();
  if(!md) return;

  const lines = md.split('\n');
  const newBlocks = [];

  for(const line of lines) {
    if(!line.trim()) continue;
    if(line.startsWith('# '))       newBlocks.push({id:Date.now()+Math.random(), type:'h1', content: line.slice(2)});
    else if(line.startsWith('## ')) newBlocks.push({id:Date.now()+Math.random(), type:'h2', content: line.slice(3)});
    else if(line.startsWith('### '))newBlocks.push({id:Date.now()+Math.random(), type:'h3', content: line.slice(4)});
    else if(line.startsWith('---')) newBlocks.push({id:Date.now()+Math.random(), type:'divider', style:'solid'});
    else if(line.startsWith('> '))  newBlocks.push({id:Date.now()+Math.random(), type:'quote', content: line.slice(2)});
    else if(line.startsWith('- '))  {
      const last = newBlocks[newBlocks.length-1];
      if(last&&last.type==='list') {
        if(!Array.isArray(last.items)) last.items = [last.items];
        last.items.push(line.slice(2));
      } else {
        newBlocks.push({id:Date.now()+Math.random(), type:'list', items:[line.slice(2)], ordered:false});
      }
    }
    else if(/^\!\[/.test(line)) {
      const m = line.match(/!\[([^\]]*)\]\(([^)]+)\)/);
      if(m) newBlocks.push({id:Date.now()+Math.random(), type:'image', src:m[2], alt:m[1], caption:m[1], width:'100%'});
    }
    else if(/^\[.+\]\(.+\)$/.test(line)) {
      const m = line.match(/\[([^\]]+)\]\(([^)]+)\)/);
      if(m) newBlocks.push({id:Date.now()+Math.random(), type:'link', content:m[1], href:m[2], title:m[1]});
    }
    else {
      newBlocks.push({id:Date.now()+Math.random(), type:'p', content: line});
    }
  }

  PP_DOC.blocks.push(...newBlocks);
  log(`[PDF Parasite] Imported ${newBlocks.length} blocks from Markdown`, 'ok');
  pp_renderBuilder();
}

// â”€â”€ BUILDER UI RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function pp_renderBuilder() {
  const container = document.getElementById('pp-builder-blocks');
  if(!container) return;

  if(PP_DOC.blocks.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3);font-family:var(--mono);font-size:11px">
      <div style="font-size:24px;margin-bottom:8px">ğŸ“„</div>
      <div>No blocks yet. Use the toolbar above to add content blocks.</div>
    </div>`;
    return;
  }

  container.innerHTML = PP_DOC.blocks.map((block, idx) => {
    const bt = PP_BLOCK_TYPES[block.type] || {icon:'?', label:block.type, color:'var(--text3)'};
    const isFirst = idx === 0, isLast = idx === PP_DOC.blocks.length-1;

    let editor = '';
    switch(block.type) {
      case 'h1': case 'h2': case 'h3':
        editor = `<input type="text" value="${esc(block.content||'')}" oninput="pp_updateBlock(${block.id},'content',this.value)"
          style="width:100%;font-size:${block.type==='h1'?'18px':block.type==='h2'?'15px':'13px'};font-weight:700;
          color:${bt.color};background:transparent;border:none;border-bottom:1px solid var(--win-border);padding:4px 0;outline:none"/>`;
        break;
      case 'p':
        editor = `<textarea rows="3" oninput="pp_updateBlock(${block.id},'content',this.value)"
          style="width:100%;background:var(--win-panel2);border:1px solid var(--win-border);padding:6px;resize:vertical;font-size:11px;color:var(--text)">${esc(block.content||'')}</textarea>`;
        break;
      case 'link':
        editor = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <div class="fg"><label class="lbl">Link Text</label>
            <input type="text" value="${esc(block.content||'')}" oninput="pp_updateBlock(${block.id},'content',this.value)"/></div>
          <div class="fg"><label class="lbl">URL</label>
            <input type="url" value="${esc(block.href||'')}" oninput="pp_updateBlock(${block.id},'href',this.value)" placeholder="https://yoursite.com"/></div>
          <div class="fg"><label class="lbl">Title Attribute (SEO)</label>
            <input type="text" value="${esc(block.title||'')}" oninput="pp_updateBlock(${block.id},'title',this.value)" placeholder="Your target keyword"/></div>
        </div>`;
        break;
      case 'image':
        editor = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <div class="fg"><label class="lbl">Image URL / Base64</label>
            <input type="url" value="${esc(block.src||'')}" oninput="pp_updateBlock(${block.id},'src',this.value)" placeholder="https://... or data:image/..."/></div>
          <div class="fg"><label class="lbl">Alt Text (SEO)</label>
            <input type="text" value="${esc(block.alt||'')}" oninput="pp_updateBlock(${block.id},'alt',this.value)" placeholder="Descriptive keyword-rich alt text"/></div>
          <div class="fg"><label class="lbl">Caption</label>
            <input type="text" value="${esc(block.caption||'')}" oninput="pp_updateBlock(${block.id},'caption',this.value)"/></div>
          <div class="fg"><label class="lbl">Width</label>
            <input type="text" value="${esc(block.width||'100%')}" oninput="pp_updateBlock(${block.id},'width',this.value)"/></div>
        </div>
        ${block.src ? `<img src="${esc(block.src)}" style="max-height:80px;max-width:200px;margin-top:4px;border-radius:3px;border:1px solid var(--win-border)" onerror="this.style.display='none'">` : ''}`;
        break;
      case 'video':
        editor = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <div class="fg"><label class="lbl">Video URL (YouTube, Vimeo, etc.)</label>
            <input type="url" value="${esc(block.url||'')}" oninput="pp_updateBlock(${block.id},'url',this.value)" placeholder="https://www.youtube.com/watch?v=..."/></div>
          <div class="fg"><label class="lbl">Caption / Call to Action</label>
            <input type="text" value="${esc(block.caption||'')}" oninput="pp_updateBlock(${block.id},'caption',this.value)" placeholder="Watch this tutorial"/></div>
        </div>`;
        break;
      case 'code':
        editor = `<div class="fg"><label class="lbl">Language</label>
          <input type="text" value="${esc(block.language||'')}" oninput="pp_updateBlock(${block.id},'language',this.value)" style="width:120px" placeholder="javascript"/>
        </div>
        <textarea rows="4" oninput="pp_updateBlock(${block.id},'content',this.value)"
          style="width:100%;background:#0a0a0a;color:#e8e8e8;border:1px solid var(--win-border);padding:8px;resize:vertical;font-family:var(--mono);font-size:10px">${esc(block.content||'')}</textarea>`;
        break;
      case 'quote':
        editor = `<div class="fg"><label class="lbl">Quote Text</label>
          <textarea rows="2" oninput="pp_updateBlock(${block.id},'content',this.value)"
            style="width:100%;background:rgba(57,211,83,.03);border:1px solid rgba(57,211,83,.2);padding:6px;resize:vertical;font-size:11px;color:var(--text);font-style:italic">${esc(block.content||'')}</textarea>
        </div>
        <div class="fg"><label class="lbl">Attribution (optional)</label>
          <input type="text" value="${esc(block.author||'')}" oninput="pp_updateBlock(${block.id},'author',this.value)" placeholder="â€” Author Name"/></div>`;
        break;
      case 'list':
        editor = `<div class="fg">
          <label class="lbl" style="display:flex;align-items:center;gap:8px">
            List Items (one per line)
            <label style="display:flex;align-items:center;gap:4px;font-weight:400;cursor:pointer">
              <input type="checkbox" ${block.ordered?'checked':''} onchange="pp_updateBlock(${block.id},'ordered',this.checked)" style="width:auto;accent-color:var(--green)"> Numbered
            </label>
          </label>
          <textarea rows="4" oninput="pp_updateBlock(${block.id},'items',this.value.split('\\n'))"
            style="width:100%;background:var(--win-panel2);border:1px solid var(--win-border);padding:6px;resize:vertical;font-size:11px;color:var(--text)">${Array.isArray(block.items)?block.items.join('\n'):(block.items||'')}</textarea>
        </div>`;
        break;
      case 'table':
        editor = `<div class="fg"><label class="lbl">Headers (comma-separated)</label>
          <input type="text" value="${esc((block.headers||[]).join(','))}"
            oninput="pp_updateBlock(${block.id},'headers',this.value.split(',').map(h=>h.trim()))"/></div>
        <div class="fg"><label class="lbl">Rows (one row per line, cells comma-separated)</label>
          <textarea rows="4" oninput="pp_updateBlock(${block.id},'rows',this.value.split('\\n').map(r=>r.split(',').map(c=>c.trim())))"
            style="width:100%;background:var(--win-panel2);border:1px solid var(--win-border);padding:6px;resize:vertical;font-family:var(--mono);font-size:10px;color:var(--text)">${(block.rows||[]).map(r=>r.join(',')).join('\n')}</textarea></div>`;
        break;
      case 'divider':
        editor = `<div style="display:flex;align-items:center;gap:8px;color:var(--text3);font-size:10px">
          <hr style="flex:1;border-color:var(--win-border)"> Divider <hr style="flex:1;border-color:var(--win-border)">
        </div>`;
        break;
      case 'spacer':
        editor = `<div class="fg"><label class="lbl">Height (px)</label>
          <input type="number" value="${block.height||20}" min="4" max="200" style="width:80px"
            oninput="pp_updateBlock(${block.id},'height',parseInt(this.value))"/></div>`;
        break;
    }

    return `<div class="pp-block" data-id="${block.id}" style="border:1px solid var(--win-border2);border-radius:2px;margin-bottom:6px;background:var(--win-panel);overflow:hidden">
      <div style="display:flex;align-items:center;gap:6px;padding:4px 8px;background:linear-gradient(90deg,var(--win-panel2),var(--win-panel));border-bottom:1px solid var(--win-border)">
        <span style="font-family:var(--mono);font-size:10px;font-weight:700;color:${bt.color};min-width:22px;text-align:center">${bt.icon}</span>
        <span style="font-size:10px;color:var(--text3)">${bt.label}</span>
        <div style="margin-left:auto;display:flex;gap:2px">
          ${!isFirst ? `<button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="pp_moveBlock(${block.id},'up')" title="Move up">â†‘</button>` : ''}
          ${!isLast  ? `<button class="tbtn" style="padding:1px 5px;font-size:9px" onclick="pp_moveBlock(${block.id},'down')" title="Move down">â†“</button>` : ''}
          <button class="tbtn stop" style="padding:1px 5px;font-size:9px" onclick="pp_removeBlock(${block.id})" title="Remove block">âœ•</button>
        </div>
      </div>
      <div style="padding:8px">${editor}</div>
    </div>`;
  }).join('');
}

// â”€â”€ MAIN RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function render_pdf_parasite(el) {
  const activeTab = SS.raw('rf_pp_tab') || 'scanner';
  const scanFound  = PP_STATE.scanResults.filter(r => r.status==='upload_found'||r.status==='cors_blocked').length;
  const uploadsDone = PP_STATE.uploadResults.filter(r => r.uploadedPath).length;
  const hasPdf = !!PP_STATE.activePdf;

  el.innerHTML = `
  <!-- TAB BAR -->
  <div style="display:flex;gap:0;border-bottom:2px solid var(--win-border);margin-bottom:10px">
    ${[
      ['scanner', `ğŸ” Upload Scanner ${scanFound ? `<span class="badge bg" style="font-size:8px;margin-left:3px">${scanFound}</span>` : ''}`],
      ['builder', `ğŸ“„ PDF Builder ${hasPdf ? `<span class="badge bg" style="font-size:8px;margin-left:3px">âœ“ Ready</span>` : ''}`],
      ['upload',  `ğŸš€ Upload & Deploy ${uploadsDone ? `<span class="badge bg" style="font-size:8px;margin-left:3px">${uploadsDone} links</span>` : ''}`],
      ['results', `ğŸ“‹ Results & Links ${PP_STATE.uploadResults.length ? `<span class="badge bg" style="font-size:8px;margin-left:3px">${PP_STATE.uploadResults.length}</span>` : ''}`],
    ].map(([id,label]) => `
    <div onclick="SS.rawSet('rf_pp_tab','${id}');render_pdf_parasite(document.getElementById('page-pdf_parasite'))"
      style="padding:5px 14px;font-size:11px;font-weight:700;cursor:pointer;border-bottom:2px solid ${activeTab===id?'var(--green)':'transparent'};margin-bottom:-2px;color:${activeTab===id?'var(--green)':'var(--text3)'};background:${activeTab===id?'rgba(57,211,83,0.05)':'transparent'}">${label}</div>`).join('')}
  </div>

  <!-- â•â•â• SCANNER TAB â•â•â• -->
  <div style="display:${activeTab==='scanner'?'block':'none'}">
    <div class="g2">
      <div>
        <div class="panel">
          <div class="panel-head">ğŸ” Scan URLs for PDF Upload Fields</div>
          <div class="panel-body">
            <div class="notice ni-b" style="margin-bottom:8px">
              Paste target URLs to scan for file upload forms. The engine detects <code>input[type=file]</code>, dropzones, and multipart forms. CORS-blocked sites are flagged as probable targets.
            </div>
            <div class="fg"><label class="lbl">URLs to Scan (one per line)</label>
              <textarea id="pp-scan-urls" rows="6" placeholder="https://example.com/upload&#10;https://docs.example.org/submit&#10;https://..."></textarea>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px">
                <input type="checkbox" id="pp-scan-known" checked style="width:auto;accent-color:var(--green)">
                <span>Include ${PP_KNOWN_PLATFORMS.length} known high-DA upload platforms</span>
              </label>
            </div>
            <div class="flex g6">
              <button class="tbtn go" onclick="pp_runScan()">ğŸ” Start Scan</button>
              <button class="tbtn stop" onclick="APP.stopFlag=true">â–  Stop</button>
              <button class="tbtn" onclick="PP_STATE.scanResults=[];render_pdf_parasite(document.getElementById('page-pdf_parasite'))">ğŸ—‘ Clear</button>
            </div>
            <div class="prog-wrap mt6"><div class="prog-fill" id="pp-scan-prog"></div></div>
          </div>
        </div>

        <!-- Known Platforms Quick-List -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">â­ Known High-DA Upload Platforms</div>
          <div class="panel-body" style="padding:0;max-height:260px;overflow-y:auto">
            <table style="width:100%;border-collapse:collapse;font-size:10px">
              <thead><tr>
                <th>Platform</th><th>DA</th><th>Accepts</th><th>Notes</th><th></th>
              </tr></thead>
              <tbody>${PP_KNOWN_PLATFORMS.sort((a,b)=>b.da-a.da).map(p=>`<tr>
                <td class="xs" style="font-weight:700">${p.name}</td>
                <td><span class="badge ${p.da>=95?'bg':p.da>=85?'by':'bb'}">${p.da}</span></td>
                <td class="mono xs tm">${p.accepts.join(', ')}</td>
                <td class="xs tm" style="color:var(--text3);max-width:160px">${p.notes}</td>
                <td><a href="${p.url}" target="_blank" class="tbtn" style="text-decoration:none;font-size:9px;padding:2px 6px">Open</a></td>
              </tr>`).join('')}</tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Scan Results -->
      <div class="panel" style="max-height:600px;display:flex;flex-direction:column">
        <div class="panel-head">ğŸ“Š Scan Results
          <span class="badge bg" style="margin-left:4px">${scanFound} targets</span>
          <span class="badge bgray" style="margin-left:4px">${PP_STATE.scanResults.length} scanned</span>
        </div>
        <div style="flex:1;overflow-y:auto;padding:0">
          ${PP_STATE.scanResults.length ? `
          <table style="width:100%;border-collapse:collapse;font-size:10px">
            <thead><tr>
              <th>URL</th><th>Status</th><th>Score</th><th>Field</th><th>Notes</th><th></th>
            </tr></thead>
            <tbody>${PP_STATE.scanResults.map(r=>`<tr>
              <td class="mono xs" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                <a href="${esc(r.url)}" target="_blank" title="${esc(r.url)}">${esc(r.url.replace(/https?:\/\//,'').slice(0,30))}â€¦</a>
              </td>
              <td><span class="badge ${r.status==='upload_found'?'bg':r.status==='cors_blocked'?'by':r.status==='no_upload'?'bgray':'br'}">${esc(r.status)}</span></td>
              <td><span class="badge ${r.score>=80?'bg':r.score>=50?'by':'bgray'}">${r.score}</span></td>
              <td class="mono xs tm">${r.fileInputName||'â€”'}</td>
              <td class="xs tm" style="color:var(--text3);max-width:120px;overflow:hidden;text-overflow:ellipsis">${esc(r.notes||r.platform||'')}</td>
              <td>
                ${r.status==='upload_found'||r.status==='cors_blocked'?`
                <button class="tbtn go" style="font-size:8px;padding:1px 5px"
                  onclick="pp_queueForUpload('${CSS.escape(r.url)}')">+ Upload</button>`:'' }
              </td>
            </tr>`).join('')}</tbody>
          </table>` : `<div style="padding:20px;text-align:center;color:var(--text3);font-family:var(--mono);font-size:10px">
            Run a scan to find upload targets. ${PP_KNOWN_PLATFORMS.length} known platforms are pre-loaded.
          </div>`}
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• BUILDER TAB â•â•â• -->
  <div style="display:${activeTab==='builder'?'block':'none'}">
    <div class="g2" style="align-items:start">
      <!-- Left: Meta + Block toolbar -->
      <div>
        <div class="panel">
          <div class="panel-head">ğŸ“‹ Document Metadata (SEO)</div>
          <div class="panel-body">
            <div class="g2">
              <div class="fg"><label class="lbl">Document Title (H1 + PDF Title)</label>
                <input type="text" id="pp-doc-title" value="${esc(PP_DOC.title)}"
                  oninput="PP_DOC.title=this.value" placeholder="Your keyword-rich document title"/></div>
              <div class="fg"><label class="lbl">Author</label>
                <input type="text" id="pp-doc-author" value="${esc(PP_DOC.author)}"
                  oninput="PP_DOC.author=this.value" placeholder="Your name or brand"/></div>
            </div>
            <div class="fg"><label class="lbl">Description (meta description)</label>
              <textarea rows="2" id="pp-doc-desc" oninput="PP_DOC.description=this.value"
                placeholder="A compelling summary with your target keywords...">${esc(PP_DOC.description)}</textarea></div>
            <div class="fg"><label class="lbl">Keywords (comma-separated)</label>
              <input type="text" id="pp-doc-kw" value="${esc(PP_DOC.keywords)}"
                oninput="PP_DOC.keywords=this.value" placeholder="keyword one, keyword two, your brand name"/></div>
          </div>
        </div>

        <!-- Markdown Import -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">â¬‡ Markdown Quick Import</div>
          <div class="panel-body">
            <div class="notice ni-b" style="margin-bottom:6px;font-size:9px">
              Supports: # H1, ## H2, ### H3, > quote, - list, --- divider, ![alt](url) image, [text](url) link, plain text â†’ paragraph
            </div>
            <textarea id="pp-md-import" rows="5" placeholder="# My SEO Document&#10;## Introduction&#10;This is a paragraph with a [link](https://yoursite.com).&#10;- List item one&#10;- List item two&#10;---&#10;> Blockquote text here"></textarea>
            <button class="tbtn go" style="margin-top:6px" onclick="pp_importMarkdown()">â¬‡ Import Markdown</button>
          </div>
        </div>

        <!-- Add Block toolbar -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">ğŸ§© Add Content Block</div>
          <div class="panel-body">
            <div style="display:flex;flex-wrap:wrap;gap:4px">
              ${Object.entries(PP_BLOCK_TYPES).map(([type, bt]) =>
                `<button class="tbtn" style="font-size:10px;gap:5px" onclick="pp_addBlock('${type}')">
                  <span style="color:${bt.color}">${bt.icon}</span> ${bt.label}
                </button>`
              ).join('')}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">âš¡ Build & Export</div>
          <div class="panel-body">
            <div class="flex g6" style="flex-wrap:wrap">
              <button class="tbtn go" style="font-size:12px;padding:5px 16px" onclick="pp_generatePdf()">
                ğŸ“„ Build PDF Document
              </button>
              <button class="tbtn" onclick="pp_previewDoc()">ğŸ‘ Preview</button>
              <button class="tbtn" onclick="pp_downloadHtml()">ğŸ“¥ Download HTML</button>
              <button class="tbtn stop" onclick="if(confirm('Clear all blocks?')){PP_DOC.blocks=[];pp_renderBuilder()}">ğŸ—‘ Clear Blocks</button>
            </div>
            ${hasPdf ? `<div class="notice ni-g" style="margin-top:8px">âœ“ PDF ready: "${esc(PP_STATE.activePdfName)}" â€” go to Upload tab to deploy</div>` : ''}
          </div>
        </div>
      </div>

      <!-- Right: Block editor -->
      <div class="panel" style="max-height:760px;display:flex;flex-direction:column">
        <div class="panel-head">
          ğŸ“ Document Blocks <span class="badge bg" style="margin-left:4px">${PP_DOC.blocks.length}</span>
          <div class="ph-r">
            <span style="font-size:9px;color:var(--text3)">${PP_DOC.blocks.length} blocks Â· est. ${Math.ceil(PP_DOC.blocks.length * 50)} words</span>
          </div>
        </div>
        <div id="pp-builder-blocks" style="flex:1;overflow-y:auto;padding:8px">
          <!-- populated by pp_renderBuilder() -->
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• UPLOAD TAB â•â•â• -->
  <div style="display:${activeTab==='upload'?'block':'none'}">
    ${!hasPdf ? `<div class="notice ni-y" style="margin-bottom:10px">âš  No PDF built yet. Go to <strong>PDF Builder</strong> tab and click "Build PDF Document" first.</div>` : ''}
    <div class="g2">
      <div>
        <div class="panel">
          <div class="panel-head">ğŸ“¤ Upload Configuration</div>
          <div class="panel-body">
            ${hasPdf ? `<div style="background:rgba(57,211,83,.06);border:1px solid rgba(57,211,83,.25);border-radius:2px;padding:8px 10px;margin-bottom:10px">
              <div style="font-size:10px;font-weight:700;color:var(--green)">âœ“ Active PDF: ${esc(PP_STATE.activePdfName||'document.pdf')}</div>
              <div style="font-size:9px;color:var(--text3);margin-top:2px">${PP_DOC.blocks.length} blocks Â· "${esc(PP_DOC.title)}"</div>
            </div>` : ''}
            <div class="fg"><label class="lbl">File Name on Upload</label>
              <input type="text" id="pp-upload-filename" value="${esc(PP_STATE.activePdfName||'document.pdf')}" placeholder="my-seo-document.pdf"/></div>
          </div>
        </div>

        <!-- Target selector from scan results -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">ğŸ¯ Select Upload Targets</div>
          <div class="panel-body" style="max-height:380px;overflow-y:auto">
            <div id="pp-upload-targets">
              ${(() => {
                const targets = [
                  ...PP_STATE.scanResults.filter(r => r.status==='upload_found'||r.status==='cors_blocked'),
                  ...PP_KNOWN_PLATFORMS.filter(p => !PP_STATE.scanResults.some(r=>r.url===p.url)).map(p=>({
                    url:p.url, status:'known_platform', score:p.da, notes:p.notes, platform:p.name,
                    fileInputName:'file', formAction:p.url, method:'POST', extraFields:[]
                  }))
                ];
                if(!targets.length) return '<div class="mono xs tm">Run the Scanner first or targets will be loaded from known platforms.</div>';
                return targets.map(r => `<div style="padding:6px 0;border-bottom:1px solid var(--win-border)">
                  <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer">
                    <input type="checkbox" value="${esc(r.url)}" checked style="width:auto;accent-color:var(--green);margin-top:2px">
                    <div style="flex:1">
                      <div style="font-size:10px;font-weight:700;color:var(--text)">${esc(r.platform||new URL(r.url).hostname)}</div>
                      <div class="mono" style="font-size:9px;color:var(--text3)">${esc(r.url.slice(0,55))}â€¦</div>
                      <div style="font-size:9px;color:var(--text3);margin-top:2px">${esc(r.notes||'')} <span class="badge ${r.score>=80?'bg':r.score>=50?'by':'bgray'}" style="font-size:8px">DA ${r.score}</span></div>
                      ${(r.extraFields||[]).filter(f=>f.required||['title','description','name','tags'].includes(f.name)).map(f=>`
                        <div style="margin-top:4px;display:flex;align-items:center;gap:6px">
                          <label style="font-size:9px;color:var(--text3);min-width:70px">${esc(f.name)}${f.required?'*':''}:</label>
                          <input type="text" name="${esc(f.name)}" data-upload-field="${CSS.escape(r.url)}"
                            value="${f.name==='title'?esc(PP_DOC.title):f.name==='description'?esc(PP_DOC.description):esc(f.value||f.placeholder)}"
                            placeholder="${esc(f.placeholder||f.name)}"
                            style="flex:1;font-size:9px;padding:2px 5px;background:var(--win-panel2);border:1px solid var(--win-border);border-radius:2px;color:var(--text)"/>
                        </div>`).join('')}
                    </div>
                  </label>
                </div>`).join('');
              })()}
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="panel">
          <div class="panel-head">ğŸš€ Deploy</div>
          <div class="panel-body">
            <div class="notice ni-b" style="margin-bottom:8px">
              The engine will POST your PDF to each selected target's upload endpoint. Required form fields are pre-filled from your document metadata. After upload, it extracts the public file URL from the response.
            </div>
            <div class="flex g6" style="flex-wrap:wrap">
              <button class="tbtn go" style="font-size:12px;padding:5px 16px" onclick="pp_startUpload()" ${!hasPdf?'disabled':''}>
                ğŸš€ Upload to Selected Targets
              </button>
              <button class="tbtn stop" onclick="APP.stopFlag=true">â–  Stop</button>
            </div>
            <div class="prog-wrap mt6" id="pp-upload-prog"><div class="prog-fill" id="pp-up-bar"></div></div>
          </div>
        </div>

        <!-- Live upload log -->
        <div class="panel" style="margin-top:8px">
          <div class="panel-head">ğŸ“¡ Upload Activity Log</div>
          <div style="background:#111;padding:8px;max-height:280px;overflow-y:auto;font-family:var(--mono);font-size:9px">
            ${PP_STATE.uploadResults.length ?
              PP_STATE.uploadResults.slice(-20).reverse().map(r=>`<div style="padding:2px 0;border-bottom:1px solid #1a1a1a;display:flex;gap:8px;align-items:baseline">
                <span style="color:var(--text3);flex-shrink:0">${new Date(r.timestamp).toLocaleTimeString()}</span>
                <span class="badge ${r.status==='success'&&r.uploadedPath?'bg':r.status==='cors_blocked'?'by':'br'}" style="font-size:8px;flex-shrink:0">${r.status}</span>
                <span style="color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.url.replace(/https?:\/\//,'').slice(0,35))}</span>
                ${r.uploadedPath ? `<a href="${esc(r.uploadedPath)}" target="_blank" style="color:var(--green);flex-shrink:0">ğŸ”— Link</a>` : ''}
              </div>`).join('')
              : '<div style="color:var(--text3)">No uploads yet.</div>'}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• RESULTS TAB â•â•â• -->
  <div style="display:${activeTab==='results'?'block':'none'}">
    <div class="g5" style="margin-bottom:10px">
      <div class="stat"><div class="stat-v sv-g">${uploadsDone}</div><div class="stat-l">ğŸ”— Live Links</div></div>
      <div class="stat"><div class="stat-v sv-b">${PP_STATE.uploadResults.filter(r=>r.status==='success').length}</div><div class="stat-l">âœ… Uploaded</div></div>
      <div class="stat"><div class="stat-v sv-y">${PP_STATE.uploadResults.filter(r=>r.status==='cors_blocked').length}</div><div class="stat-l">ğŸ”’ CORS Blocked</div></div>
      <div class="stat"><div class="stat-v sv-r">${PP_STATE.uploadResults.filter(r=>r.status==='error'||r.status==='error_http').length}</div><div class="stat-l">âŒ Errors</div></div>
      <div class="stat"><div class="stat-v">${PP_STATE.uploadResults.length}</div><div class="stat-l">ğŸ“‹ Total</div></div>
    </div>

    <div class="panel">
      <div class="panel-head">ğŸ”— Harvested Upload Links
        <div class="ph-r">
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="pp_copyAllLinks()">ğŸ“‹ Copy All Links</button>
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="pp_exportResults()">ğŸ“¥ CSV Export</button>
          <button class="tbtn" style="padding:1px 6px;font-size:9px" onclick="pp_sendLinksToListManager()">ğŸ’¾ â†’ URL List</button>
          <button class="tbtn stop" style="padding:1px 6px;font-size:9px" onclick="if(confirm('Clear all results?')){PP_STATE.uploadResults=[];render_pdf_parasite(document.getElementById('page-pdf_parasite'))}">ğŸ—‘</button>
        </div>
      </div>
      <div class="panel-body" style="padding:0">
        ${PP_STATE.uploadResults.length ? `
        <div class="tbl-wrap"><table>
          <thead><tr>
            <th>Target Platform</th><th>Status</th><th>Uploaded File Link</th><th>File</th><th>Time</th><th>Actions</th>
          </tr></thead>
          <tbody>${PP_STATE.uploadResults.map((r,i)=>`<tr>
            <td class="xs">${esc(r.url.replace(/https?:\/\//,'').split('/')[0])}</td>
            <td><span class="badge ${r.uploadedPath?'bg':r.status==='cors_blocked'?'by':r.status==='success'?'bb':'br'}">${r.status}</span></td>
            <td class="mono" style="max-width:240px">
              ${r.uploadedPath
                ? `<a href="${esc(r.uploadedPath)}" target="_blank" style="color:var(--green);font-size:9px;word-break:break-all">${esc(r.uploadedPath.slice(0,60))}${r.uploadedPath.length>60?'â€¦':''}</a>`
                : `<span style="color:var(--text3);font-size:9px">${esc(r.error||'No URL extracted')}</span>`}
            </td>
            <td class="mono xs tm">${esc(r.fileName||'')}</td>
            <td class="mono xs tm">${new Date(r.timestamp).toLocaleDateString()}</td>
            <td style="white-space:nowrap">
              ${r.uploadedPath ? `
              <button class="tbtn" style="font-size:8px;padding:1px 4px" onclick="navigator.clipboard.writeText('${CSS.escape(r.uploadedPath)}').then(()=>log('Copied','ok'))">ğŸ“‹</button>
              <a href="${esc(r.uploadedPath)}" target="_blank" class="tbtn" style="font-size:8px;padding:1px 4px;text-decoration:none">ğŸ”—</a>
              <button class="tbtn go" style="font-size:8px;padding:1px 4px" onclick="pp_sendLinkToUrlList('${CSS.escape(r.uploadedPath)}')">+List</button>
              ` : ''}
            </td>
          </tr>`).join('')}</tbody>
        </table></div>`
        : '<div style="padding:20px;text-align:center;color:var(--text3);font-family:var(--mono);font-size:10px">No upload results yet. Scan targets and upload your PDF first.</div>'}
      </div>
    </div>

    <!-- Response previews for debugging -->
    ${PP_STATE.uploadResults.filter(r=>r.responsePreview).length ? `
    <div class="panel" style="margin-top:8px">
      <div class="panel-head" style="cursor:pointer" onclick="document.getElementById('pp-resp-previews').style.display=document.getElementById('pp-resp-previews').style.display==='none'?'block':'none'">
        ğŸ”¬ Response Previews (debug) <span style="color:var(--text3);font-size:9px">â–¼ click to expand</span>
      </div>
      <div id="pp-resp-previews" style="display:none">
        ${PP_STATE.uploadResults.filter(r=>r.responsePreview).map(r=>`
        <div style="padding:8px;border-bottom:1px solid var(--win-border)">
          <div style="font-size:9px;color:var(--text3);margin-bottom:4px">${esc(r.url)}</div>
          <pre style="font-size:9px;color:var(--text2);white-space:pre-wrap;max-height:80px;overflow:auto;background:#0a0a0a;padding:6px">${esc(r.responsePreview||'')}</pre>
        </div>`).join('')}
      </div>
    </div>` : ''}
  </div>`;

  // Init builder blocks on builder tab
  if(activeTab === 'builder') {
    requestAnimationFrame(() => pp_renderBuilder());
  }
}

// â”€â”€ RESULT HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function pp_queueForUpload(escapedUrl) {
  const url = PP_STATE.scanResults.map(r=>r.url).find(u => CSS.escape(u) === escapedUrl) || decodeURIComponent(escapedUrl);
  log(`[PDF Parasite] Queued for upload: ${url}`, 'info');
  SS.rawSet('rf_pp_tab','upload');
  render_pdf_parasite(document.getElementById('page-pdf_parasite'));
}

function pp_copyAllLinks() {
  const links = PP_STATE.uploadResults.filter(r=>r.uploadedPath).map(r=>r.uploadedPath).join('\n');
  if(!links) { log('[PDF Parasite] No links to copy','warn'); return; }
  navigator.clipboard.writeText(links).then(()=>log(`Copied ${links.split('\n').length} upload links`,'ok'));
}

function pp_sendLinksToListManager() {
  const links = PP_STATE.uploadResults.filter(r=>r.uploadedPath).map(r=>r.uploadedPath);
  if(!links.length) { log('[PDF Parasite] No links to send','warn'); return; }
  APP.urlList = [...new Set([...APP.urlList, ...links])];
  SS.set('rf_urllist', APP.urlList);
  updateStats();
  log(`[PDF Parasite] Sent ${links.length} upload links to URL List`, 'ok');
}

function pp_sendLinkToUrlList(escapedUrl) {
  const url = decodeURIComponent(escapedUrl.replace(/\\,/g,','));
  APP.urlList = [...new Set([...APP.urlList, url])];
  SS.set('rf_urllist', APP.urlList);
  updateStats();
  log(`[PDF Parasite] Added to URL List: ${url}`, 'ok');
}

function pp_exportResults() {
  dlCSV(
    'Target URL,Status,Uploaded Path,File Name,HTTP Status,Timestamp\n' +
    PP_STATE.uploadResults.map(r =>
      `"${r.url}","${r.status}","${r.uploadedPath||''}","${r.fileName||''}","${r.httpStatus||''}","${new Date(r.timestamp).toISOString()}"`
    ).join('\n'),
    'pdf_parasite_results.csv'
  );
  log(`[PDF Parasite] Exported ${PP_STATE.uploadResults.length} results`, 'ok');
}

// Load persisted data on page load
(function pp_init(){
  const saved = SS.get('rf_pp_uploads', []);
  if(saved.length) PP_STATE.uploadResults = saved;
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  // Schema migration first
  schemaMigrate();

  // Inject Analytics nav item into sidebar â€” already in HTML, just ensure page container exists
  (function(){
    const area=document.getElementById('page-area');
    if(area&&!document.getElementById('page-pdf_parasite')){
      const dpdf=document.createElement('div');
      dpdf.id='page-pdf_parasite';dpdf.className='page';area.appendChild(dpdf);
    }
    if(area&&!document.getElementById('page-analytics')){
      const d=document.createElement('div');
      d.id='page-analytics';d.className='page';area.appendChild(d);
    }
    if(area&&!document.getElementById('page-content_rebuild')){
      const dcrb=document.createElement('div');
      dcrb.id='page-content_rebuild';dcrb.className='page';area.appendChild(dcrb);
    }
    // Add undo status indicator to status bar
    const sb=document.getElementById('statusbar');
    if(sb){
      const undoEl=document.createElement('span');
      undoEl.id='undo-status';
      undoEl.style.cssText='font-family:var(--mono);font-size:9px;color:var(--text3);margin-left:8px;padding:0 4px;border-left:1px solid var(--win-border)';
      undoEl.title='Undo / Redo stack depth (Ctrl+Z / Ctrl+Y)';
      undoEl.textContent='â†©0 â†ª0';
      sb.appendChild(undoEl);
    }
  })();

  // Check for crash recovery
  sessionCheckCrash();

  // Apply saved theme
  applyTheme(localStorage.getItem('rf_theme')||'dark');

  // Init keyboard shortcuts
  _initKeyboardShortcuts();

  log('RankForge Pro v8.0 loaded â€” Settings v2.0: API health dashboard, profiles, themes, rate limits, session log, notifications, storage tracker, import/export, shortcuts','ok');
  // Try to connect Supabase if credentials saved
  if (localStorage.getItem('rf_sb_url') && localStorage.getItem('rf_sb_anon')) {
    setTimeout(sbInit, 500);
  } else {
    log('Supabase: not configured â€” go to âš™ Settings â†’ ğŸ”‘ API Keys â†’ Supabase to enable cloud sync', 'info');
  }
  log(`${APP.urlList.length} URLs Â· ${APP.campaigns.length} campaigns Â· ${APP.proxies.length} proxies Â· Profile: ${profiles_active()}`,'info');

  const apiStatus=[];
  if(SS.raw('rf_claude_key'))apiStatus.push('Claude âœ“');else apiStatus.push('Claude âœ—');
  if(SS.raw('rf_opr_key'))apiStatus.push('OPR âœ“');else apiStatus.push('OPR âœ—');
  if(SS.raw('rf_serpapi_key'))apiStatus.push('SerpAPI âœ“');else apiStatus.push('SerpAPI âœ—');
  if(SS.raw('rf_whois_key'))apiStatus.push('WHOIS âœ“');else apiStatus.push('WHOIS âœ—');
  log(`API Keys: ${apiStatus.join(' Â· ')}`,'info');
  if(!SS.raw('rf_claude_key')&&!SS.raw('rf_opr_key')&&!SS.raw('rf_serpapi_key')&&!SS.raw('rf_whois_key')){
    log('âš  No API keys configured â€” go to âš™ Settings â†’ ğŸ”‘ API Keys','warn');
  }

  updateStats();
  const lastPage = pageStateRestore();
  switchPage(lastPage);
  setInterval(()=>{document.getElementById('log-time').textContent=now();},1000);
  schedulesStart();
  ps_checkSchedules();
  log('Session & State: undo/redo âœ“ Â· crash detection âœ“ Â· tab locking âœ“ Â· page restore âœ“','ok');
  log('Analytics: run history âœ“ Â· ROI tracker âœ“ Â· platform heatmap âœ“ Â· lineage tracking âœ“','ok');
  log('Automation: batch queue âœ“ Â· webhooks âœ“ Â· pipelines âœ“ Â· schedules âœ“','ok');
  log('Data Quality: global dedup âœ“ Â· integrity checker âœ“ Â· version migration âœ“','ok');

  function autoSave(){
    SS.set('rf_urllist',APP.urlList); SS.set('rf_campaigns',APP.campaigns);
    SS.set('rf_proxies',APP.proxies); SS.set('rf_comments',APP.comments);
    SS.set('rf_links',APP.links);     SS.set('rf_accounts',APP.accounts);
  }
  setInterval(autoSave,15000);
  window.addEventListener('beforeunload',autoSave);
  log('Auto-save active (15s interval + on close)','info');
});


// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// CONTENT REBUILD ENGINE â€” RankForge v18
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const CRB = {
  running: false,
  stopFlag: false,
  delay: 13500, // ms between Claude API calls (free tier: 5 req/min)
};

function crb_getEl(id) { return document.getElementById(id); }
function crb_val(id, def='') { const e=crb_getEl(id); return e?e.value:def; }

function crb_rerender(){
  // Update sitemap scraper if open
  const elSM=document.getElementById('page-sitemap_scraper');
  if(elSM && elSM.classList.contains('active')) render_sitemap_scraper(elSM);
  // Update standalone content rebuild page if open
  const elCRB=document.getElementById('page-content_rebuild');
  if(elCRB && elCRB.classList.contains('active')) render_content_rebuild(elCRB);
}

function crb_setStatus(msg){ const el=crb_getEl('crb-status'); if(el) el.textContent=msg; }
function crb_setProgress(pct){ const el=crb_getEl('crb-prog'); if(el) el.style.width=pct+'%'; }

function crb_updateResult(url, updates) {
  let results = SS.get('rf_crb_results', []);
  const idx = results.findIndex(r => r.url === url);
  if (idx >= 0) Object.assign(results[idx], updates);
  else results.push({ url, ...updates });
  SS.set('rf_crb_results', results);
}

async function crb_fetchPage(url) {
  // Use allorigins proxy same as rest of app
  const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
  const data = await resp.json();
  return data.contents || '';
}

function crb_extractProfile(html, url) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // Title waterfall
  const title = (doc.querySelector('h1')?.textContent?.trim()) ||
                (doc.querySelector('title')?.textContent?.trim()) ||
                (doc.querySelector('meta[property="og:title"]')?.content?.trim()) || '';

  // Meta description waterfall
  const metaDesc = (doc.querySelector('meta[name="description"]')?.content?.trim()) ||
                   (doc.querySelector('meta[property="og:description"]')?.content?.trim()) || '';

  // H2/H3 headings â†’ outline
  const headings = [...doc.querySelectorAll('h2,h3')].map(h => h.textContent?.trim()).filter(Boolean).slice(0, 12);

  // Body text waterfall: article â†’ main â†’ [role=main] â†’ .post-content â†’ .entry-content â†’ .content â†’ largest div
  let bodyEl = doc.querySelector('article') ||
               doc.querySelector('main') ||
               doc.querySelector('[role="main"]') ||
               doc.querySelector('.post-content') ||
               doc.querySelector('.entry-content') ||
               doc.querySelector('.content') ||
               doc.querySelector('.post') ||
               doc.querySelector('.blog-post');

  if (!bodyEl) {
    // Fallback: largest div by text length
    const divs = [...doc.querySelectorAll('div')];
    bodyEl = divs.reduce((best, d) => (d.textContent?.length || 0) > (best.textContent?.length || 0) ? d : best, divs[0] || doc.body);
  }

  const bodyText = (bodyEl?.textContent || '').replace(/\s+/g, ' ').trim().slice(0, 3000);
  const wordCount = bodyText.split(/\s+/).filter(Boolean).length;

  // Schema type
  let schemaType = '';
  try {
    const scripts = [...doc.querySelectorAll('script[type="application/ld+json"]')];
    for (const s of scripts) {
      const json = JSON.parse(s.textContent || '{}');
      const t = json['@type'] || (Array.isArray(json) ? json[0]?.['@type'] : '');
      if (t) { schemaType = Array.isArray(t) ? t[0] : t; break; }
    }
  } catch(e) {}

  // Classify intent
  let intent = 'Informational';
  const urlL = url.toLowerCase();
  if (/buy|price|deal|discount|cheap|purchase|order|shop/.test(urlL)) intent = 'Transactional';
  else if (/review|best|top|vs|compare|alternative/.test(urlL)) intent = 'Commercial';

  return { title, metaDesc, headings, bodyText, wordCount, schemaType, intent };
}

async function crb_callClaude(profile, keywords, mode, model) {
  const claudeKey = SS.raw('rf_claude_key');
  if (!claudeKey) throw new Error('No Claude API key â€” add in Settings â†’ API Keys');

  const kwStr = keywords.length ? keywords.slice(0, 8).join(', ') : 'SEO-focused content';
  const outlineStr = profile.headings.length ? profile.headings.map((h,i) => `${i+1}. ${h}`).join('\n') : '(no headings found)';
  const targetWords = Math.max(600, Math.round(profile.wordCount * 1.2));

  let userPrompt = '';

  if (mode === 'titlemeta') {
    userPrompt = `You are an SEO expert. Rewrite the following competitor article's title and meta description to outrank it.

ORIGINAL TITLE: ${profile.title}
ORIGINAL META: ${profile.metaDesc}
PAGE INTENT: ${profile.intent}
TARGET KEYWORDS: ${kwStr}

Respond ONLY with valid JSON, no preamble, no markdown:
{"title":"...","meta":"..."}`;
  } else if (mode === 'outline') {
    userPrompt = `You are an SEO expert. Create an improved outline for an article to outrank this competitor page.

ORIGINAL TITLE: ${profile.title}
ORIGINAL META: ${profile.metaDesc}  
EXISTING HEADINGS:
${outlineStr}
PAGE INTENT: ${profile.intent}
TARGET KEYWORDS: ${kwStr}

Respond ONLY with valid JSON, no preamble, no markdown:
{"title":"...","meta":"...","headings":["H2 1","H2 2","H2 3","H2 4","H2 5"]}`;
  } else {
    // Full rewrite
    userPrompt = `You are an SEO content writer. Rewrite this competitor article to outrank it on Google.

ORIGINAL TITLE: ${profile.title}
ORIGINAL META: ${profile.metaDesc}
CONTENT OUTLINE (H2s): ${outlineStr}
BODY EXCERPT: ${profile.bodyText.slice(0, 1200)}
PAGE INTENT: ${profile.intent}
${profile.schemaType ? `SCHEMA TYPE: ${profile.schemaType}` : ''}
TARGET KEYWORDS: ${kwStr}
TARGET WORD COUNT: ${targetWords} words

Write a complete, original article that outranks this page. Use the same H2 structure but improve the content.

Respond ONLY with valid JSON, no preamble, no markdown:
{"title":"...","meta":"...","body":"...full HTML article body with <h2> subheadings...","wordCount":${targetWords}}`;
  }

  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'x-api-key': claudeKey,
      'anthropic-version': '2023-06-01',
      'Content-Type': 'application/json',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: model,
      max_tokens: mode === 'full' ? 4000 : 600,
      messages: [{ role: 'user', content: userPrompt }]
    }),
    signal: AbortSignal.timeout(90000)
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err.error?.message || `API error ${resp.status}`);
  }

  const data = await resp.json();
  const rawText = data.content?.[0]?.text || '';

  // Strip markdown fences if present
  const clean = rawText.replace(/^```json\s*/i, '').replace(/```\s*$/,'').trim();
  try {
    return JSON.parse(clean);
  } catch(e) {
    // Try to extract JSON object from text
    const m = clean.match(/\{[\s\S]+\}/);
    if (m) return JSON.parse(m[0]);
    throw new Error('Claude response was not valid JSON: ' + clean.slice(0, 100));
  }
}

async function crb_start() {
  if (CRB.running) return;

  const claudeKey = SS.raw('rf_claude_key');
  if (!claudeKey) { log('Content Rebuild: Claude API key required â€” Settings â†’ API Keys â†’ Claude', 'err'); return; }

  const source = crb_val('crb-source', 'blog');
  const maxUrls = parseInt(crb_val('crb-max', '10')) || 10;
  const minScore = parseInt(crb_val('crb-minscore', '0')) || 0;
  const mode = crb_val('crb-mode', 'full');
  const model = crb_val('crb-model', 'claude-haiku-4-5-20251001');
  const wpStatus = crb_val('crb-wpstatus', 'draft');
  const keywordRaw = crb_val('crb-keywords', '');
  const keywords = keywordRaw.split('\n').map(k => k.trim()).filter(Boolean);

  SS.rawSet('rf_crb_wpstatus', wpStatus);
  SS.rawSet('rf_crb_mode', mode);

  const BLOG_PAT = /\/(blog|article|post|news|story|entry|journal|press|insight|resource|guide|tutorial|tip|update|writing)\//i;
  const EXCL_PAT = /\/(product|products|category|categories|tag|tags|shop|store|cart|checkout|account|login|register|search|page\/\d)\b/i;

  function updateScore3(r){
    if(!r.lastmod||r.lastmod==='unknown'||r.lastmod==='â€”') return 0;
    const d=new Date(r.lastmod); if(isNaN(d)) return 0;
    const age=(Date.now()-d)/86400000;
    if(age<=1)return 10; if(age<=7)return 8; if(age<=30)return 6; if(age<=90)return 4; if(age<=365)return 2; return 1;
  }

  let urls = [];
  if (source === 'manual') {
    const manual = crb_val('crb-manual', '');
    urls = manual.split('\n').map(u => u.trim()).filter(u => u.startsWith('http'));
  } else {
    const results = SS.get('rf_sitemap_results', []);
    let filtered = results.filter(r => r.status === 'ok');
    if (source === 'blog') filtered = filtered.filter(r => BLOG_PAT.test(r.url) && !EXCL_PAT.test(r.url));
    if (minScore > 0) filtered = filtered.filter(r => updateScore3(r) >= minScore);
    filtered.sort((a, b) => updateScore3(b) - updateScore3(a));
    urls = filtered.slice(0, maxUrls).map(r => r.url);
  }

  if (!urls.length) { log('Content Rebuild: No URLs to process. Run Sitemap Scraper first or enter URLs manually.', 'err'); return; }

  // Initialize results with queued status
  const existingResults = SS.get('rf_crb_results', []);
  const newEntries = urls.map(url => ({
    url, stage: 'queued', rebuiltTitle: null, rebuiltMeta: null, rebuiltBody: null,
    wordCount: null, elapsed: null, error: null
  }));
  SS.set('rf_crb_results', [...existingResults.filter(r => !urls.includes(r.url)), ...newEntries]);
  SS.set('rf_crb_queue', urls);

  CRB.running = true;
  CRB.stopFlag = false;
  crb_rerender();
  log(`Content Rebuild: starting ${urls.length} URL(s) with ${model}`, 'info');

  const isHaiku = model.includes('haiku');
  const delayMs = isHaiku ? 13500 : 4000; // free tier haiku: 5/min

  let done = 0;
  for (const url of urls) {
    if (CRB.stopFlag) { log('Content Rebuild: stopped by user', 'warn'); break; }

    const t0 = Date.now();
    crb_updateResult(url, { stage: 'scraping' });
    crb_setStatus(`Scraping ${done+1}/${urls.length}: ${url.slice(0, 60)}â€¦`);
    crb_setProgress(Math.round(done / urls.length * 100));
    crb_rerender();

    try {
      // Stage 1: Fetch page
      const html = await crb_fetchPage(url);
      if (!html) throw new Error('Empty response from proxy');

      crb_updateResult(url, { stage: 'extracting' });
      crb_rerender();

      // Stage 2: Extract content profile
      const profile = crb_extractProfile(html, url);
      if (!profile.title && !profile.bodyText) throw new Error('Could not extract content from page');

      crb_updateResult(url, { stage: 'rewriting' });
      crb_setStatus(`Rewriting ${done+1}/${urls.length} with Claude: ${url.slice(0, 50)}â€¦`);
      crb_rerender();

      // Stage 3: Claude AI rewrite
      const aiOut = await crb_callClaude(profile, keywords, mode, model);

      const elapsed = Math.round((Date.now() - t0) / 1000);
      const wordCount = aiOut.wordCount || (aiOut.body ? aiOut.body.split(/\s+/).length : null);

      crb_updateResult(url, {
        stage: 'done',
        rebuiltTitle: aiOut.title || '',
        rebuiltMeta: aiOut.meta || '',
        rebuiltBody: aiOut.body || aiOut.headings?.map(h => `<h2>${h}</h2>`).join('\n') || '',
        rebuiltHeadings: aiOut.headings || [],
        wordCount,
        elapsed: elapsed + 's',
        profile: { originalTitle: profile.title, originalMeta: profile.metaDesc, schemaType: profile.schemaType, intent: profile.intent }
      });

      log(`Content Rebuild âœ“ ${url.slice(0,60)} â€” "${(aiOut.title||'').slice(0,50)}"`, 'ok');

    } catch(err) {
      const elapsed = Math.round((Date.now() - t0) / 1000);
      crb_updateResult(url, { stage: 'failed', error: err.message, elapsed: elapsed + 's' });
      log(`Content Rebuild âœ— ${url.slice(0,60)}: ${err.message}`, 'err');
    }

    done++;
    crb_rerender();

    // Rate-limit delay (only if more URLs remain)
    if (done < urls.length && !CRB.stopFlag) {
      crb_setStatus(`Rate-limit pause ${delayMs/1000}s before next URLâ€¦`);
      await new Promise(r => setTimeout(r, delayMs));
    }
  }

  CRB.running = false;
  crb_setProgress(100);
  crb_setStatus(`Rebuild complete â€” ${done} URL(s) processed`);
  crb_rerender();
  log(`Content Rebuild: complete â€” ${done} URL(s) processed`, 'ok');
}

function crb_stop() {
  CRB.stopFlag = true;
  CRB.running = false;
  log('Content Rebuild: stop requested', 'warn');
}

function crb_clear() {
  if (!confirm('Clear all Content Rebuild results?')) return;
  SS.set('rf_crb_results', []);
  SS.set('rf_crb_queue', []);
  crb_rerender();
}

function crb_exportWXR() {
  const results = SS.get('rf_crb_results', []).filter(r => r.stage === 'done');
  if (!results.length) { alert('No completed rebuilds to export yet.'); return; }

  const wpStatus = SS.raw('rf_crb_wpstatus') || 'draft';
  const now = new Date().toUTCString();

  let xml = `<?xml version="1.0" encoding="UTF-8" ?>
<rss version="2.0"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:excerpt="http://wordpress.org/export/1.2/excerpt/"
  xmlns:wp="http://wordpress.org/export/1.2/">
<channel>
  <title>RankForge Content Rebuild Export</title>
  <pubDate>${now}</pubDate>
  <wp:wxr_version>1.2</wp:wxr_version>`;

  results.forEach((r, i) => {
    // Generate slug from title
    const slug = (r.rebuiltTitle || `rebuilt-post-${i+1}`)
      .toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').slice(0, 60);

    const body = r.rebuiltBody || '';
    const title = esc(r.rebuiltTitle || '');
    const meta = esc(r.rebuiltMeta || '');
    const date = new Date().toISOString().replace('T',' ').replace(/\.\d+Z$/,'');

    xml += `
  <item>
    <title><![CDATA[${r.rebuiltTitle || ''}]]></title>
    <link>${esc(r.url || '')}</link>
    <pubDate>${now}</pubDate>
    <content:encoded><![CDATA[${body}]]></content:encoded>
    <excerpt:encoded><![CDATA[${r.rebuiltMeta || ''}]]></excerpt:encoded>
    <wp:post_name>${slug}</wp:post_name>
    <wp:post_date>${date}</wp:post_date>
    <wp:post_type>post</wp:post_type>
    <wp:status>${wpStatus}</wp:status>
    <wp:postmeta>
      <wp:meta_key>_yoast_wpseo_title</wp:meta_key>
      <wp:meta_value><![CDATA[${r.rebuiltTitle || ''}]]></wp:meta_value>
    </wp:postmeta>
    <wp:postmeta>
      <wp:meta_key>_yoast_wpseo_metadesc</wp:meta_key>
      <wp:meta_value><![CDATA[${r.rebuiltMeta || ''}]]></wp:meta_value>
    </wp:postmeta>
    <wp:postmeta>
      <wp:meta_key>rank_math_title</wp:meta_key>
      <wp:meta_value><![CDATA[${r.rebuiltTitle || ''}]]></wp:meta_value>
    </wp:postmeta>
    <wp:postmeta>
      <wp:meta_key>rank_math_description</wp:meta_key>
      <wp:meta_value><![CDATA[${r.rebuiltMeta || ''}]]></wp:meta_value>
    </wp:postmeta>
    <wp:postmeta>
      <wp:meta_key>_original_competitor_url</wp:meta_key>
      <wp:meta_value><![CDATA[${r.url || ''}]]></wp:meta_value>
    </wp:postmeta>
  </item>`;
  });

  xml += `
</channel>
</rss>`;

  const blob = new Blob([xml], { type: 'text/xml' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `rankforge_content_rebuild_${new Date().toISOString().slice(0,10)}.xml`;
  a.click();
  log(`Content Rebuild: exported ${results.length} posts as WXR (status: ${wpStatus})`, 'ok');
}

function render_content_rebuild(el) {
  const results = SS.get('rf_crb_results', []);
  const running = CRB.running;
  const savedMode = SS.raw('rf_crb_mode') || 'full';
  const savedWpStatus = SS.raw('rf_crb_wpstatus') || 'draft';
  const claudeKey = SS.raw('rf_claude_key');

  const stageBadge = s => {
    const map = {queued:'bgray',scraping:'by',extracting:'by',rewriting:'bb',done:'bg',failed:'br'};
    return `<span class="badge ${map[s]||'bgray'}" style="font-size:8px">${s}</span>`;
  };

  el.innerHTML = `
  <div class="panel">
    <div class="panel-head">ğŸ¤– Content Rebuild Engine
      <div class="ph-r">
        <span style="font-size:9px;color:var(--text3)">${results.length} job(s) in history</span>
      </div>
    </div>
    <div class="panel-body">
      ${!claudeKey ? `<div class="notice ni-r" style="margin-bottom:10px">âš  Claude API key required â€” <a href="#" onclick="switchPage('settings')" style="color:var(--blue)">Settings â†’ API Keys â†’ Claude</a></div>` : ''}

      <div class="g2" style="gap:10px">
        <div>
          <div class="fg">
            <label class="lbl">URL Source</label>
            <select id="crb-source">
              <option value="blog" ${savedMode!=='full'?'':'selected'}>Blog Posts (from Sitemap)</option>
              <option value="all">All Pages (from Sitemap)</option>
              <option value="manual">Manual URL List</option>
            </select>
          </div>
          <div class="fg" id="crb-manual-wrap" style="display:none">
            <label class="lbl">URLs (one per line)</label>
            <textarea id="crb-manual" rows="5" placeholder="https://competitor.com/blog/post-1&#10;https://competitor.com/blog/post-2" style="width:100%;resize:vertical"></textarea>
          </div>
          <div class="fg">
            <label class="lbl">Max URLs to Process</label>
            <input type="number" id="crb-max" value="10" min="1" max="100"/>
          </div>
          <div class="fg">
            <label class="lbl">Min Freshness Score (0 = all)</label>
            <input type="number" id="crb-minscore" value="0" min="0" max="10"/>
          </div>
        </div>
        <div>
          <div class="fg">
            <label class="lbl">Rewrite Mode</label>
            <select id="crb-mode">
              <option value="full" ${savedMode==='full'?'selected':''}>Full Rewrite (title + meta + body)</option>
              <option value="outline" ${savedMode==='outline'?'selected':''}>Outline Only (headings structure)</option>
              <option value="titlemeta" ${savedMode==='titlemeta'?'selected':''}>Title + Meta Only (fast)</option>
            </select>
          </div>
          <div class="fg">
            <label class="lbl">Claude Model</label>
            <select id="crb-model">
              <option value="claude-haiku-4-5-20251001">Claude Haiku (fast, free-tier ~5/min)</option>
              <option value="claude-sonnet-4-5-20251022">Claude Sonnet (better quality)</option>
            </select>
          </div>
          <div class="fg">
            <label class="lbl">WordPress Export Status</label>
            <select id="crb-wpstatus">
              <option value="draft" ${savedWpStatus==='draft'?'selected':''}>Draft</option>
              <option value="publish" ${savedWpStatus==='publish'?'selected':''}>Published</option>
              <option value="pending" ${savedWpStatus==='pending'?'selected':''}>Pending Review</option>
            </select>
          </div>
          <div class="fg">
            <label class="lbl">Target Keywords (one per line)</label>
            <textarea id="crb-keywords" rows="4" placeholder="seo tools&#10;rank tracking software&#10;best seo software 2025" style="width:100%;resize:vertical"></textarea>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;align-items:center">
        ${running
          ? `<button class="tbtn stop" onclick="crb_stop()">â¹ Stop Rebuild</button>`
          : `<button class="tbtn go" onclick="crb_startFromPage()">â–¶ Start Content Rebuild</button>`
        }
        <button class="tbtn" onclick="crb_exportWXR()">ğŸ“¦ Export as WXR (WordPress)</button>
        <button class="tbtn" onclick="crb_exportCSV_standalone()">ğŸ“Š Export CSV</button>
        <button class="tbtn stop" onclick="crb_clear()">ğŸ—‘ Clear Results</button>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <div id="crb-prog-wrap" style="width:160px;height:12px;background:var(--win-panel2);border:1px solid var(--win-border2);border-radius:2px;overflow:hidden">
            <div id="crb-prog" style="height:100%;width:0%;background:linear-gradient(90deg,var(--green-dim),var(--green));transition:width .3s"></div>
          </div>
          <span id="crb-status" style="font-family:var(--mono);font-size:10px;color:var(--text3)">Ready</span>
        </div>
      </div>
    </div>
  </div>

  ${results.length ? `
  <div class="panel">
    <div class="panel-head">ğŸ“‹ Results (${results.length} URLs)
      <div class="ph-r">
        <span class="badge bg">${results.filter(r=>r.stage==='done').length} done</span>
        <span class="badge br">${results.filter(r=>r.stage==='failed').length} failed</span>
        <span class="badge by">${results.filter(r=>['queued','scraping','extracting','rewriting'].includes(r.stage)).length} pending</span>
      </div>
    </div>
    <div class="panel-body" style="padding:0">
      <div class="tbl-wrap"><table>
        <thead><tr>
          <th>URL</th><th>Status</th><th>New Title</th><th>Words</th><th>Time</th><th>Action</th>
        </tr></thead>
        <tbody>
          ${results.map((r,i) => `<tr>
            <td class="mono xs"><a href="${esc(r.url)}" target="_blank" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block">${esc(r.url.replace(/^https?:\/\//,'').slice(0,55))}${r.url.length>60?'â€¦':''}</a></td>
            <td>${stageBadge(r.stage||'queued')}${r.error?`<div style="font-size:9px;color:var(--red);margin-top:2px" title="${esc(r.error)}">${esc(r.error.slice(0,60))}</div>`:''}</td>
            <td class="xs" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(r.rebuiltTitle||'')}">
              ${r.rebuiltTitle ? `<span style="color:var(--text)">${esc(r.rebuiltTitle.slice(0,60))}</span>` : '<span style="color:var(--text3)">â€”</span>'}
              ${r.rebuiltMeta ? `<div style="font-size:9px;color:var(--text3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(r.rebuiltMeta)}">${esc(r.rebuiltMeta.slice(0,70))}â€¦</div>` : ''}
            </td>
            <td class="mono xs tm">${r.wordCount||'â€”'}</td>
            <td class="mono xs tm">${r.elapsed||'â€”'}</td>
            <td>
              ${r.stage==='done' ? `<button class="tbtn" style="font-size:9px;padding:1px 5px" onclick="crb_previewResult(${i})">ğŸ‘ Preview</button>` : ''}
            </td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
  </div>
  ` : `<div class="notice ni-b" style="text-align:center;padding:20px">
    <div style="font-size:13px;margin-bottom:6px">No rebuild results yet</div>
    <div style="font-size:11px;color:var(--text3)">Run the Sitemap Scraper first to populate URLs, then click <strong>Start Content Rebuild</strong>.</div>
    <div style="margin-top:12px"><button class="tbtn" onclick="switchPage('sitemap_scraper')">â†’ Open Sitemap Scraper</button></div>
  </div>`}

  <!-- Preview Modal -->
  <div id="crb-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;overflow-y:auto;padding:20px">
    <div style="max-width:860px;margin:0 auto;background:var(--win-panel);border:1px solid var(--win-border2);border-radius:4px">
      <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--win-border);background:var(--win-panel2)">
        <span style="font-weight:700;font-size:12px">ğŸ“„ Content Preview</span>
        <button class="tbtn stop" style="margin-left:auto;padding:2px 8px;font-size:10px" onclick="document.getElementById('crb-modal').style.display='none'">âœ• Close</button>
      </div>
      <div id="crb-modal-body" style="padding:16px;max-height:80vh;overflow-y:auto"></div>
    </div>
  </div>`;

  // Wire up source selector
  const srcEl = document.getElementById('crb-source');
  const manualWrap = document.getElementById('crb-manual-wrap');
  if (srcEl && manualWrap) {
    srcEl.addEventListener('change', () => {
      manualWrap.style.display = srcEl.value === 'manual' ? '' : 'none';
    });
  }
}

function crb_startFromPage() {
  // Update the crb_start to also re-render this standalone page
  crb_start().then(() => {
    render_content_rebuild(document.getElementById('page-content_rebuild'));
  });
}

function crb_previewResult(idx) {
  const r = (SS.get('rf_crb_results', []))[idx];
  if (!r) return;
  const modal = document.getElementById('crb-modal');
  const body = document.getElementById('crb-modal-body');
  if (!modal || !body) return;
  body.innerHTML = `
    <div style="margin-bottom:12px">
      <div style="font-size:9px;color:var(--text3);margin-bottom:2px">SOURCE URL</div>
      <a href="${esc(r.url)}" target="_blank" style="font-family:var(--mono);font-size:10px;color:var(--blue)">${esc(r.url)}</a>
    </div>
    <div style="margin-bottom:12px">
      <div style="font-size:9px;color:var(--text3);margin-bottom:2px">SEO TITLE</div>
      <div style="font-size:13px;font-weight:700;color:var(--text-hi)">${esc(r.rebuiltTitle||'â€”')}</div>
    </div>
    <div style="margin-bottom:12px">
      <div style="font-size:9px;color:var(--text3);margin-bottom:2px">META DESCRIPTION</div>
      <div style="font-size:11px;color:var(--text)">${esc(r.rebuiltMeta||'â€”')}</div>
    </div>
    ${r.rebuiltHeadings && r.rebuiltHeadings.length ? `
    <div style="margin-bottom:12px">
      <div style="font-size:9px;color:var(--text3);margin-bottom:4px">HEADINGS OUTLINE</div>
      ${r.rebuiltHeadings.map(h=>`<div style="font-size:11px;color:var(--cyan);padding:2px 0;border-bottom:1px solid var(--win-border)">â–¸ ${esc(h)}</div>`).join('')}
    </div>` : ''}
    ${r.rebuiltBody ? `
    <div>
      <div style="font-size:9px;color:var(--text3);margin-bottom:6px">ARTICLE BODY (${r.wordCount||'?'} words Â· ${r.elapsed||'?'})</div>
      <div style="font-size:11px;color:var(--text);line-height:1.7;background:var(--win-panel2);border:1px solid var(--win-border);padding:12px;border-radius:2px;max-height:400px;overflow-y:auto">
        ${r.rebuiltBody}
      </div>
    </div>` : ''}
    <div style="margin-top:12px;display:flex;gap:6px">
      <button class="tbtn go" onclick="navigator.clipboard.writeText(document.querySelector('#crb-modal-body .article-body-txt')||'${esc(r.rebuiltTitle||'')}').then(()=>log('Copied!','ok'))">ğŸ“‹ Copy Title</button>
      <button class="tbtn" onclick="const blob=new Blob(['Title: ${esc(r.rebuiltTitle||'')}\\nMeta: ${esc(r.rebuiltMeta||'')}\\n\\n${esc(r.rebuiltBody||'')}'],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='rebuilt-content.txt';a.click()">ğŸ’¾ Download TXT</button>
    </div>
  `;
  modal.style.display = '';
}

function crb_exportCSV_standalone() {
  const results = SS.get('rf_crb_results', []).filter(r => r.stage === 'done');
  if (!results.length) { alert('No completed rebuilds to export yet.'); return; }
  const csv = 'URL,Title,Meta Description,Word Count,Time\n' +
    results.map(r => `"${r.url}","${(r.rebuiltTitle||'').replace(/"/g,'""')}","${(r.rebuiltMeta||'').replace(/"/g,'""')}","${r.wordCount||''}","${r.elapsed||''}"`).join('\n');
  dlCSV(csv, 'rankforge_content_rebuild.csv');
  log(`Content Rebuild: exported ${results.length} results as CSV`, 'ok');
}

</script>
</body>
</html>
