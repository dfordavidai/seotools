
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SEO PARASITE PRO v9 ‚Äî 20 Platforms ¬∑ Global Blast</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f6f9;--surface:#ffffff;--surface2:#f8fafc;--border:#dde3ec;--border2:#c8d0dc;
  --accent:#0057ff;--accent2:#e8003d;--accent3:#d97706;--accent4:#0891b2;--accent5:#7c3aed;
  --text:#0f1724;--muted:#8a96a8;--muted2:#5a6478;
  --mono:'Space Mono',monospace;--sans:'Syne',sans-serif;
  --shadow:0 1px 4px rgba(0,0,0,0.07),0 4px 16px rgba(0,0,0,0.04);
}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;font-size:13px;font-weight:500}
.app{display:flex;flex-direction:column;min-height:100vh}
/* HEADER */
.header{border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(255,255,255,0.97);backdrop-filter:blur(16px);z-index:100;box-shadow:0 1px 0 var(--border)}
.logo{font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:0.08em;display:flex;align-items:center;gap:10px;font-weight:700}
.logo-box{width:28px;height:28px;background:var(--accent);display:grid;place-items:center;font-size:13px;color:#fff;font-weight:700;border-radius:6px}
.logo-ver{font-size:9px;color:var(--muted2);background:var(--bg);border:1px solid var(--border);padding:2px 7px;letter-spacing:0.06em;border-radius:4px;font-weight:600}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.pill{font-family:var(--mono);font-size:9px;padding:3px 10px;border:1px solid;letter-spacing:0.08em;text-transform:uppercase;border-radius:20px;font-weight:700}
.pill-on{border-color:var(--accent);color:var(--accent);background:rgba(0,87,255,0.06)}
.pill-off{border-color:var(--border2);color:var(--muted2);background:var(--bg)}
/* PLATFORM BAR */
.platform-bar{display:flex;border-bottom:1px solid var(--border);background:#fff;overflow-x:auto;padding:0 20px;scrollbar-width:thin}
.platform-bar::-webkit-scrollbar{height:2px}
.platform-bar::-webkit-scrollbar-thumb{background:var(--border2)}
.ptab{display:flex;align-items:center;gap:6px;padding:10px 14px;font-family:var(--mono);font-size:10px;cursor:pointer;color:var(--muted2);border-bottom:2px solid transparent;transition:all 0.15s;white-space:nowrap;letter-spacing:0.04em;user-select:none;font-weight:600}
.ptab:hover{color:var(--text);background:var(--bg)}
.ptab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(0,87,255,0.04)}
/* LAYOUT */
.main{display:flex;flex:1;min-height:0}
.sidebar{width:210px;border-right:1px solid var(--border);padding:12px 0;flex-shrink:0;display:flex;flex-direction:column;overflow-y:auto;background:#fff}
.sidebar-bottom{margin-top:auto;padding:12px 0;border-top:1px solid var(--border)}
.nav-section{font-family:var(--mono);font-size:8px;letter-spacing:0.18em;color:var(--muted);padding:14px 16px 5px;text-transform:uppercase;font-weight:700}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 16px;font-size:12px;cursor:pointer;transition:all 0.12s;color:var(--muted2);border-left:2px solid transparent;font-family:var(--mono);letter-spacing:0.02em;user-select:none;font-weight:600}
.nav-item:hover{color:var(--text);background:var(--bg)}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(0,87,255,0.05);font-weight:700}
.nav-icon{font-size:13px;width:16px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;font-size:8px;font-family:var(--mono);background:rgba(0,87,255,0.1);color:var(--accent);padding:1px 6px;border:1px solid rgba(0,87,255,0.2);border-radius:3px;font-weight:700}
.nav-badge.red{background:rgba(232,0,61,0.08);color:var(--accent2);border-color:rgba(232,0,61,0.2)}
.nav-badge.blue{background:rgba(8,145,178,0.08);color:var(--accent4);border-color:rgba(8,145,178,0.2)}
.content{flex:1;padding:28px 32px;overflow-y:auto;background:var(--bg)}
/* PAGE */
.page{display:none}.page.active{display:block}
.page-title{font-family:var(--sans);font-size:24px;font-weight:800;margin-bottom:4px;letter-spacing:-0.02em;color:var(--text)}
.page-sub{font-size:11px;color:var(--muted2);margin-bottom:22px;font-family:var(--mono);font-weight:600}
/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);padding:20px;margin-bottom:16px;border-radius:10px;box-shadow:var(--shadow)}
.card-title{font-size:10px;font-family:var(--mono);letter-spacing:0.12em;color:var(--muted2);text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:8px;font-weight:700}
.card-title::after{content:'';flex:1;height:1px;background:var(--border)}
.fg{margin-bottom:12px}
.lbl{display:block;font-size:10px;font-family:var(--mono);color:var(--muted2);margin-bottom:5px;letter-spacing:0.07em;text-transform:uppercase;font-weight:700}
/* INPUTS */
input[type=text],input[type=password],input[type=number],input[type=url],input[type=email],textarea,select{width:100%;background:#fff;border:1px solid var(--border2);color:var(--text);padding:8px 12px;font-family:var(--mono);font-size:12px;outline:none;transition:border-color 0.12s,box-shadow 0.12s;-webkit-appearance:none;appearance:none;border-radius:6px;font-weight:500}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,87,255,0.1)}
select option{background:#fff;color:var(--text)}
textarea{resize:vertical;min-height:70px;line-height:1.6}
/* GRIDS */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;font-family:var(--mono);font-size:10px;letter-spacing:0.05em;cursor:pointer;border:1px solid;transition:all 0.12s;text-transform:uppercase;white-space:nowrap;background:transparent;border-radius:6px;font-weight:700}
.btn:disabled{opacity:0.4;cursor:not-allowed}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:700;box-shadow:0 2px 8px rgba(0,87,255,0.25)}
.btn-primary:hover:not(:disabled){background:#0047d9;box-shadow:0 4px 12px rgba(0,87,255,0.35)}
.btn-danger{color:var(--accent2);border-color:var(--accent2)}
.btn-danger:hover:not(:disabled){background:rgba(232,0,61,0.06)}
.btn-ghost{color:var(--text);border-color:var(--border2);background:#fff}
.btn-ghost:hover:not(:disabled){border-color:var(--text);background:var(--bg)}
.btn-yellow{color:#92400e;border-color:var(--accent3);background:rgba(217,119,6,0.06)}
.btn-yellow:hover:not(:disabled){background:rgba(217,119,6,0.12)}
.btn-blue{color:var(--accent4);border-color:rgba(8,145,178,0.4);background:rgba(8,145,178,0.05)}
.btn-blue:hover:not(:disabled){background:rgba(8,145,178,0.1)}
.btn-sm{padding:5px 11px;font-size:9px}
.btn-xs{padding:3px 8px;font-size:9px}
/* UTILS */
.row{display:flex;gap:10px;align-items:flex-end}
.flex{display:flex}.aic{align-items:center}.jb{justify-content:space-between}.g8{gap:8px}.g12{gap:12px}.ml{margin-left:auto}
.f1{flex:1}.mb0{margin-bottom:0}.mt8{margin-top:8px}.mt12{margin-top:12px}
.mono{font-family:var(--mono)}.sm{font-size:12px;font-weight:600}.xs{font-size:11px;font-weight:600}
.ta{color:var(--accent)}.tr{color:var(--accent2)}.ty{color:var(--accent3)}.tb{color:var(--accent4)}.tp{color:var(--accent5)}.tm{color:var(--muted2)}
/* TERMINAL */
.terminal{background:#0d1117;border:1px solid #30363d;padding:14px;font-family:var(--mono);font-size:11px;height:260px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9}
.tline{display:flex;gap:10px}
.ttime{color:#484f58;flex-shrink:0;font-size:9px}
.t-info{color:#3fb950}.t-warn{color:#d29922}.t-error{color:#f85149}.t-accent{color:#58a6ff}
/* PROGRESS */
.prog-wrap{height:5px;background:var(--border);margin:10px 0;overflow:hidden;border-radius:3px}
.prog-fill{height:100%;background:var(--accent);transition:width 0.3s ease;width:0%;border-radius:3px}
/* STAT BOXES */
.stat{background:var(--surface);border:1px solid var(--border);padding:16px;position:relative;overflow:hidden;border-radius:10px;box-shadow:var(--shadow)}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:10px 10px 0 0}
.stat.g::before{background:var(--accent)}.stat.r::before{background:var(--accent2)}
.stat.y::before{background:var(--accent3)}.stat.b::before{background:var(--accent4)}.stat.p::before{background:var(--accent5)}
.stat-v{font-size:28px;font-weight:800;font-family:var(--mono);line-height:1;color:var(--text)}
.stat-l{font-size:10px;color:var(--muted2);font-family:var(--mono);letter-spacing:0.08em;text-transform:uppercase;margin-top:5px;font-weight:700}
/* TABLE */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:11px}
th{text-align:left;padding:8px 12px;color:var(--muted2);border-bottom:2px solid var(--border);letter-spacing:0.07em;text-transform:uppercase;font-size:10px;white-space:nowrap;font-weight:700;background:var(--bg)}
td{padding:9px 12px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle;font-weight:500}
tr:hover td{background:rgba(0,87,255,0.03)}
/* BADGES */
.badge{display:inline-block;padding:2px 8px;font-size:9px;letter-spacing:0.06em;white-space:nowrap;border:1px solid;border-radius:4px;font-weight:700}
.badge-g{background:rgba(0,87,255,0.08);color:var(--accent);border-color:rgba(0,87,255,0.2)}
.badge-r{background:rgba(232,0,61,0.07);color:var(--accent2);border-color:rgba(232,0,61,0.2)}
.badge-y{background:rgba(217,119,6,0.08);color:#92400e;border-color:rgba(217,119,6,0.25)}
.badge-b{background:rgba(8,145,178,0.07);color:var(--accent4);border-color:rgba(8,145,178,0.2)}
.badge-p{background:rgba(124,58,237,0.07);color:var(--accent5);border-color:rgba(124,58,237,0.2)}
/* CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.chip{display:inline-block;padding:4px 10px;font-size:10px;font-family:var(--mono);border:1px solid var(--border2);color:var(--muted2);cursor:pointer;transition:all 0.1s;user-select:none;border-radius:5px;font-weight:600}
.chip:hover,.chip.on{border-color:var(--accent);color:var(--accent);background:rgba(0,87,255,0.06)}
/* ANIMATIONS */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:11px;height:11px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
.blink{animation:blink 1.4s infinite}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:none}}
.slide-in{animation:slideIn 0.3s ease}
/* URL BANNER */
.url-banner{background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);padding:11px 16px;display:flex;align-items:center;gap:12px;margin-top:8px;border-radius:8px}
.ub-label{font-family:var(--mono);font-size:8px;color:var(--accent);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:2px;font-weight:700}
.ub-url{font-family:var(--mono);font-size:11px;font-weight:700}
.ub-url a{color:var(--accent);text-decoration:none}
.ub-url a:hover{text-decoration:underline}
/* LINK ROW */
.link-row{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px;align-items:center;padding:10px 12px;background:var(--bg);border:1px solid var(--border);margin-bottom:6px;border-radius:8px}
/* MINI TABS */
.mtabs{display:flex;border:1px solid var(--border2);width:fit-content;margin-bottom:12px;flex-wrap:wrap;border-radius:7px;overflow:hidden}
.mtab{padding:6px 14px;font-family:var(--mono);font-size:10px;cursor:pointer;color:var(--muted2);transition:all 0.12s;letter-spacing:0.04em;border-right:1px solid var(--border2);user-select:none;font-weight:600}
.mtab:last-child{border-right:none}
.mtab:hover{color:var(--text);background:var(--bg)}
.mtab.on{background:var(--accent);color:#fff;font-weight:700}
/* NOTICES */
.notice{padding:10px 14px;border:1px solid;font-family:var(--mono);font-size:11px;line-height:1.7;margin-bottom:12px;border-radius:8px;font-weight:600}
.notice-info{border-color:rgba(8,145,178,0.25);background:rgba(8,145,178,0.06);color:#0e6e87}
.notice-warn{border-color:rgba(217,119,6,0.25);background:rgba(217,119,6,0.06);color:#92400e}
.notice-success{border-color:rgba(0,87,255,0.2);background:rgba(0,87,255,0.05);color:var(--accent)}
.notice-err{border-color:rgba(232,0,61,0.2);background:rgba(232,0,61,0.05);color:var(--accent2)}
/* PLATFORM STATUS */
.pstat{background:var(--surface);border:1px solid var(--border);padding:12px;text-align:center;font-family:var(--mono);border-radius:10px;box-shadow:var(--shadow)}
.pstat-icon{font-size:20px;margin-bottom:5px}
.pstat-name{font-size:9px;color:var(--muted2);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:4px;font-weight:700}
.pstat-status{font-size:10px;font-weight:700}
.hidden{display:none!important}
/* SCROLLBAR */
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,36,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-box{background:#fff;border:1px solid var(--border);padding:28px;min-width:440px;max-width:94vw;position:relative;animation:slideIn 0.2s ease;border-radius:14px;box-shadow:0 8px 40px rgba(0,0,0,0.15)}
.modal-title{font-family:var(--mono);font-size:11px;letter-spacing:0.12em;color:var(--accent);text-transform:uppercase;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;font-weight:700}
.link-status-ok{color:#059669;font-size:10px;font-family:var(--mono);font-weight:700}
.link-status-broken{color:var(--accent2);font-size:10px;font-family:var(--mono);font-weight:700}
.link-status-checking{color:var(--accent3);font-size:10px;font-family:var(--mono);font-weight:600}
.link-status-unknown{color:var(--muted2);font-size:10px;font-family:var(--mono);font-weight:600}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="logo">
      <div class="logo-box">‚ö°</div>
      SEO_PARASITE_PRO
      <span class="logo-ver">v9 ¬∑ GLOBAL BLAST</span>
    </div>
    <div class="header-right">
      <span id="hdr-stats" class="mono xs tm">0 accounts ¬∑ 0 keywords ¬∑ 0 live URLs</span>
      <span id="hdr-pill" class="pill pill-off"><span>‚óè</span> no accounts</span>
    </div>
  </div>

  <!-- PLATFORM BAR -->
  <div class="platform-bar" id="platform-bar"></div>

  <div class="main">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="nav-section">Global</div>
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">‚ö°</span>Dashboard</div>
      <div class="nav-item" data-page="global_blast"><span class="nav-icon">üåç</span>Global Blast<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="keywords"><span class="nav-icon">üîë</span>Keywords<span class="nav-badge" id="kw-badge">0</span></div>
      <div class="nav-item" data-page="links"><span class="nav-icon">üîó</span>Links<span class="nav-badge blue" id="link-badge">0</span></div>
      <div class="nav-section">Tools</div>
      <div class="nav-item" data-page="content_studio"><span class="nav-icon">‚úç</span>Content Studio</div>
      <div class="nav-item" data-page="competitor_spy"><span class="nav-icon">üïµ</span>Competitor Spy</div>
      <div class="nav-item" data-page="kw_research"><span class="nav-icon">üîç</span>KW Research</div>
      <div class="nav-item" data-page="blog_commenter"><span class="nav-icon">üí¨</span>Blog Commenter<span class="nav-badge red">AUTO</span></div>
      <div class="nav-item" data-page="parasite_finder"><span class="nav-icon">ü¶†</span>Parasite Finder<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="comment_sites"><span class="nav-icon">üåê</span>Comment Sites Finder<span class="nav-badge red">NEW</span></div>
      <div class="nav-section">Platform</div>
      <div class="nav-item" data-page="setup"><span class="nav-icon">‚öô</span>Setup / Connect</div>
      <div class="nav-item" data-page="campaign"><span class="nav-icon">‚ñ∂</span>Run Campaign</div>
      <div class="nav-section">Submit &amp; Export</div>
      <div class="nav-item" data-page="indexing"><span class="nav-icon">üì°</span>Search Indexing</div>
      <div class="nav-item" data-page="export"><span class="nav-icon">üì§</span>Export Center<span class="nav-badge" id="export-badge">0</span></div>
      <div class="sidebar-bottom" id="sidebar-accounts"><div style="padding:8px 18px;font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">No accounts connected</div></div>
    </div>

    <!-- CONTENT -->
    <div class="content">
      <div id="page-dashboard" class="page active"></div>
      <div id="page-global_blast" class="page"></div>
      <div id="page-keywords" class="page"></div>
      <div id="page-links" class="page"></div>
      <div id="page-setup" class="page"></div>
      <div id="page-campaign" class="page"></div>
      <div id="page-indexing" class="page"></div>
      <div id="page-export" class="page"></div>
      <div id="page-content_studio" class="page"></div>
      <div id="page-competitor_spy" class="page"></div>
      <div id="page-kw_research" class="page"></div>
      <div id="page-blog_commenter" class="page"></div>
      <div id="page-parasite_finder" class="page"></div>
      <div id="page-comment_sites" class="page"></div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  activePlatform: 'github',
  activePage: 'dashboard',
  accounts: [],
  keywords: [],
  links: [],
  campaigns: [],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLATFORMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLATFORMS = [
  {id:'github',    name:'GitHub Pages',     icon:'üêô', da:96, api:'GitHub API',      domain:'github.io',    desc:'Create repos & GitHub Pages for each keyword'},
  {id:'gitlab',    name:'GitLab Pages',     icon:'ü¶ä', da:90, api:'GitLab API',      domain:'gitlab.io',    desc:'GitLab Pages with GitLab CI auto-deploy'},
  {id:'netlify',   name:'Netlify',          icon:'üåê', da:82, api:'Netlify API',     domain:'netlify.app',  desc:'Deploy static HTML pages via Netlify API'},
  {id:'vercel',    name:'Vercel',           icon:'‚ñ≤',  da:82, api:'Vercel API',      domain:'vercel.app',   desc:'Deploy Next.js/static sites via Vercel API'},
  {id:'notion',    name:'Notion',           icon:'üìù', da:90, api:'Notion API',      domain:'notion.site',  desc:'Create Notion pages published to notion.site'},
  {id:'medium',    name:'Medium',           icon:'‚ìÇ',  da:95, api:'Medium API',      domain:'medium.com',   desc:'Publish articles to Medium via Integration Token'},
  {id:'substack',  name:'Substack',         icon:'üìÆ', da:91, api:'Substack API',    domain:'substack.com', desc:'Auto-publish newsletters/posts on Substack'},
  {id:'blogger',   name:'Blogger',          icon:'üì∞', da:99, api:'Blogger API v3',  domain:'blogspot.com', desc:'Create & publish posts to Google Blogger blogs'},
  {id:'hashnode',  name:'Hashnode',         icon:'‚ö°', da:82, api:'GraphQL API',     domain:'hashnode.dev', desc:'Publish developer articles via Hashnode GraphQL'},
  {id:'reddit',    name:'Reddit',           icon:'ü§ñ', da:98, api:'Reddit API',      domain:'reddit.com',   desc:'Post to subreddits via Reddit OAuth API'},
  {id:'wordpress', name:'WordPress.com',    icon:'üîµ', da:95, api:'WP REST API',     domain:'wordpress.com',desc:'Publish posts to WordPress.com via REST API'},
  {id:'devto',     name:'Dev.to',           icon:'üíª', da:87, api:'Dev.to API',      domain:'dev.to',       desc:'Publish developer articles to dev.to community'},
  {id:'tumblr',    name:'Tumblr',           icon:'üíô', da:88, api:'Tumblr API v2',   domain:'tumblr.com',   desc:'Create Tumblr blog posts via OAuth API'},
  {id:'ghost',     name:'Ghost.io',         icon:'üëª', da:84, api:'Ghost Admin API', domain:'ghost.io',     desc:'Publish posts to Ghost CMS blogs via Admin API'},
  {id:'wix',       name:'Wix',              icon:'üåü', da:93, api:'Wix Headless API',domain:'wixsite.com',  desc:'Create Wix site pages via Wix Headless CMS API'},
  {id:'telegraph', name:'Telegraph',        icon:'üìú', da:68, api:'Telegraph API',   domain:'telegra.ph',   desc:'Publish anonymous pages to telegra.ph instantly'},
  {id:'codepen',   name:'CodePen',          icon:'üñä', da:89, api:'Prefill URL',     domain:'codepen.io',   desc:'Generate CodePen prefill URLs ‚Äî DA 89'},
  {id:'replit',    name:'Replit',           icon:'üîÅ', da:89, api:'Replit GraphQL',  domain:'repl.co',      desc:'Deploy pages on Replit via GraphQL API'},
  {id:'cloudflare',name:'Cloudflare Pages', icon:'‚òÅ',  da:88, api:'Cloudflare API',  domain:'pages.dev',    desc:'Deploy to pages.dev via Cloudflare API'},
  {id:'issuu',        name:'Issuu',           icon:'üìÑ', da:92,  api:'Issuu API',          domain:'issuu.com',         desc:'Publish documents on Issuu ‚Äî DA 92'},
  // ‚îÄ‚îÄ NEW PLATFORMS ‚îÄ‚îÄ
  {id:'onfeetnation', name:'OnFeetNation',    icon:'üëü', da:52,  api:'Form POST',          domain:'onfeetnation.com',  desc:'Post photo album to OnFeetNation social network'},
  {id:'caribbeanfever',name:'CaribbeanFever', icon:'üå¥', da:48,  api:'Form POST',          domain:'caribbeanfever.com',desc:'Post photo album to CaribbeanFever community'},
  {id:'bitbin',       name:'Bitbin',          icon:'üìã', da:42,  api:'Paste API',          domain:'bitbin.it',         desc:'Create a paste/snippet on Bitbin.it'},
  {id:'pastelink',    name:'Pastelink',       icon:'üîó', da:40,  api:'Paste API',          domain:'pastelink.net',     desc:'Create a public paste on Pastelink.net'},
  {id:'click4r',      name:'Click4R',         icon:'üìù', da:38,  api:'Form POST',          domain:'click4r.com',       desc:'Create a post on Click4R blogging platform'},
  {id:'ideone',       name:'Ideone',          icon:'üí°', da:72,  api:'Paste API',          domain:'ideone.com',        desc:'Create a public code/text paste on Ideone.com'},
  {id:'controlc',     name:'ControlC',        icon:'üìå', da:38,  api:'Paste API',          domain:'controlc.com',      desc:'Create a public paste on ControlC.com'},
  {id:'rentry',       name:'Rentry.co',       icon:'üìÑ', da:52,  api:'Paste API',          domain:'rentry.co',         desc:'Create a Markdown paste page on Rentry.co'},
  {id:'techplanet',   name:'TechPlanet',      icon:'üöÄ', da:45,  api:'Form POST',          domain:'techplanet.today',  desc:'Publish a post on TechPlanet.today'},
  {id:'vingle',       name:'Vingle',          icon:'üíú', da:58,  api:'Form POST',          domain:'vingle.net',        desc:'Post an article to Vingle interest network'},
  {id:'writeonwall',  name:'WriteOnWall',     icon:'‚úèÔ∏è', da:35,  api:'Form POST',          domain:'writeonwall.com',   desc:'Submit a question/post on WriteOnWall'},
  {id:'taylorhicks',  name:'TaylorHicks Ning',icon:'üéµ', da:44,  api:'Ning API',           domain:'taylorhicks.ning.com',desc:'Post to TaylorHicks Ning community forum'},
  {id:'snaplant',     name:'Snaplant',        icon:'üåø', da:36,  api:'Form POST',          domain:'snaplant.com',      desc:'Submit a question on Snaplant Q&A'},
  {id:'theprose',     name:'TheProse',        icon:'üìñ', da:42,  api:'Form POST',          domain:'theprose.com',      desc:'Publish a post on TheProse writing community'},
  {id:'deviantart',   name:'DeviantArt',      icon:'üé®', da:92,  api:'DeviantArt API',     domain:'deviantart.com',    desc:'Publish a journal/deviation on DeviantArt ‚Äî DA 92'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const uid  = () => Math.random().toString(36).slice(2,9);
const slug = s  => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
const ts   = () => new Date().toLocaleTimeString('en-US',{hour12:false});
const sleep= ms => new Promise(r=>setTimeout(r,ms));
const esc  = s  => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const year = () => new Date().getFullYear();

function getPlatform(id){ return PLATFORMS.find(p=>p.id===id)||PLATFORMS[0]; }
function getAccounts(pid){ return S.accounts.filter(a=>a.platform===pid); }
function getAccount(pid){ return S.accounts.find(a=>a.platform===pid); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTENT GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMdLinks(links){
  const f=(links||[]).filter(l=>l.target==='readme'||l.target==='both');
  if(!f.length) return '';
  return '\n\n## üìö Resources\n\n'+f.map(l=>`- [${l.label}](${l.url})`).join('\n');
}
function buildHtmlLinks(links){
  const f=(links||[]).filter(l=>l.target==='html'||l.target==='both');
  if(!f.length) return '';
  return '<section class="card" id="resources"><h2>üìö Resources</h2><ul>'+f.map(l=>`<li><a href="${l.url}" target="_blank" rel="noopener">${esc(l.label)}</a></li>`).join('')+'</ul></section>';
}

const ARTICLE_TEMPLATES = [
  (kw,links) => `# ${kw}: The Ultimate Guide for ${year()}

## Introduction

If you're looking for the best information about **${kw}**, you've come to the right place. This comprehensive guide covers everything you need to know.

## What is ${kw}?

${kw} refers to a powerful approach that helps users achieve their goals more efficiently. Understanding ${kw} is essential for success in today's competitive landscape.

## Why ${kw} Matters

- **Efficiency**: ${kw} streamlines processes and saves valuable time
- **Scalability**: Grow with proven ${kw} strategies
- **Results**: Measurable outcomes with data-driven ${kw} methods

## Best Practices for ${kw}

### 1. Start with Deep Research
Before implementing ${kw}, gather data about your audience, competitors, and goals.

### 2. Build a Solid Plan
A structured plan for ${kw} ensures consistent results and measurable progress.

### 3. Execute and Iterate
Track your ${kw} metrics. Key KPIs include traffic, conversions, and engagement rates.

## FAQ

**What is ${kw}?** ${kw} is a comprehensive approach to achieving results using proven methodologies.

**How long until results?** Most practitioners see meaningful progress within 30‚Äì90 days.

**Is ${kw} suitable for beginners?** Absolutely ‚Äî this guide is designed for all skill levels.
${buildMdLinks(links)}
---
*Last updated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}*`,

  (kw,links) => `# ${kw} ‚Äî Expert Analysis & Review ${year()}

> **TL;DR**: ${kw} is one of the most searched topics this year. Here's everything experts know.

## Overview

After extensive research on **${kw}**, we've compiled a definitive breakdown for anyone looking to understand, evaluate, or implement ${kw} strategies.

## Key Facts About ${kw}

- ${kw} has seen significant growth in interest over the past 12 months
- Most practitioners report meaningful results within 30‚Äì90 days
- Beginner-friendly resources for ${kw} are more accessible than ever

## How ${kw} Works: Step by Step

**Step 1 ‚Äî Research & Discovery**
Understand the landscape of ${kw}. Identify key players, trends, and gaps.

**Step 2 ‚Äî Strategy & Planning**
Map your ${kw} approach against your specific goals and resources.

**Step 3 ‚Äî Implementation**
Execute your ${kw} plan with precision. Start small, validate, then scale.

## FAQ

**What is the best way to get started with ${kw}?** Begin with thorough research and a clear goal.

**How long does ${kw} take to show results?** Most users see results within 30‚Äì90 days of consistent effort.
${buildMdLinks(links)}
---
*Expert reviewed ¬∑ Updated ${new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'})}*`,
];

function generateMarkdown(kw, links, tplIdx, allKws, username, domain){
  const fn = ARTICLE_TEMPLATES[tplIdx % ARTICLE_TEMPLATES.length];
  let content = fn(kw, links);
  if(allKws && allKws.length > 1){
    const others = allKws.filter(k=>k!==kw).slice(0,4);
    content += '\n\n## üåê Related Guides\n\n'+others.map(k=>`- [${k}](https://${username}.${domain}/${slug(k)}/)`).join('\n');
  }
  return content;
}

function generateHtmlPage(kw, username, repoName, links, platform){
  const p = getPlatform(platform);
  const baseUrl = platform==='github' ? `https://${username}.github.io/${repoName}/`
    : platform==='gitlab' ? `https://${username}.gitlab.io/${repoName}/`
    : `https://${repoName}.${p.domain}/`;
  const linkSection = buildHtmlLinks(links);
  const schemaObj = {
    "@context":"https://schema.org","@type":"Article",
    "headline":`${kw} - Complete Guide ${year()}`,
    "description":`Comprehensive guide to ${kw}. Expert tips, best practices, and resources.`,
    "author":{"@type":"Person","name":username},
    "datePublished":new Date().toISOString().split('T')[0]
  };
  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="description" content="Learn everything about ${esc(kw)}. Expert guide for ${year()}.">
<meta property="og:title" content="${esc(kw)} - Complete Guide ${year()}">
<meta name="robots" content="index,follow">
<link rel="canonical" href="${esc(baseUrl)}">
<title>${esc(kw)} ‚Äî Complete Guide ${year()}</title>
<script type="application/ld+json">${JSON.stringify(schemaObj)}<\/script>
<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,sans-serif;background:#f8fafc;color:#1e293b;line-height:1.75}header{background:linear-gradient(135deg,#1e1b4b,#312e81);color:white;padding:56px 24px;text-align:center}header h1{font-size:2.2rem;margin-bottom:12px;font-weight:800}header p{font-size:1rem;opacity:0.75;max-width:560px;margin:0 auto}main{max-width:860px;margin:0 auto;padding:36px 24px}.card{background:white;border-radius:10px;padding:24px;margin:18px 0;box-shadow:0 1px 4px rgba(0,0,0,0.08)}h2{font-size:1.35rem;font-weight:700;color:#1e1b4b;margin:0 0 14px}h3{font-size:1.05rem;font-weight:600;color:#312e81;margin:18px 0 8px}p{margin-bottom:12px;color:#475569}ul,ol{margin:8px 0 16px 20px}li{margin-bottom:6px;color:#475569}a{color:#4f46e5}footer{text-align:center;padding:36px 24px;background:#1e1b4b;color:rgba(255,255,255,0.4);font-size:0.82rem}</style>
</head>
<body>
<header><h1>${esc(kw)}</h1><p>Complete Guide for ${year()} ¬∑ Everything You Need to Know</p></header>
<main>
<div class="card"><h2>Introduction to ${esc(kw)}</h2><p>Welcome to the most comprehensive resource on <strong>${esc(kw)}</strong>. This guide covers all aspects with practical, actionable insights.</p><p>Last updated: <strong>${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</strong></p></div>
<div class="card"><h2>Why ${esc(kw)} Is Important</h2><ul><li>Proven framework for achieving consistent results</li><li>Saves time with battle-tested methodologies</li><li>Scales from beginner to advanced</li></ul></div>
<div class="card"><h2>FAQ</h2><p><strong>What is ${esc(kw)}?</strong> ${esc(kw)} is a comprehensive approach to achieving optimal results through structured methods.</p><p><strong>How long until results?</strong> Most practitioners see progress within 30‚Äì90 days.</p><p><strong>Is it suitable for beginners?</strong> Absolutely ‚Äî this guide is designed for all skill levels.</p></div>
${linkSection}
</main>
<footer><p>&copy; ${year()} ${esc(username)} ¬∑ ${esc(repoName)} ¬∑ ${esc(p.name)}</p></footer>
</body></html>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API CLASSES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class GitHubAPI {
  constructor(token){ this.token=token; this.base='https://api.github.com'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/user'); }
  createRepo(name,desc){ return this.req('POST','/user/repos',{name,description:desc,private:false,auto_init:true,has_issues:false,has_projects:false,has_wiki:false}); }
  async getFile(owner,repo,path){
    try{ return await this.req('GET',`/repos/${owner}/${repo}/contents/${path}`); }
    catch(e){ if(e.message.includes('Not Found')||e.message.includes('404')) return null; throw e; }
  }
  async putFile(owner,repo,path,content,msg,sha=null){
    // Properly encode content to base64 (handles Unicode)
    const bytes=new TextEncoder().encode(content);
    const binStr=Array.from(bytes).map(b=>String.fromCharCode(b)).join('');
    const b64=btoa(binStr);
    const body={message:msg,content:b64};
    if(sha) body.sha=sha;
    return this.req('PUT',`/repos/${owner}/${repo}/contents/${path}`,body);
  }
  async enablePages(owner,repo){
    try{ return await this.req('PUT',`/repos/${owner}/${repo}/pages`,{source:{branch:'main',path:'/'}}); }
    catch{ try{ return await this.req('POST',`/repos/${owner}/${repo}/pages`,{source:{branch:'main',path:'/'}}); }catch{} }
  }
  updateTopics(owner,repo,topics){ return this.req('PUT',`/repos/${owner}/${repo}/topics`,{names:topics}).catch(()=>{}); }
  deleteRepo(owner,repo){ return this.req('DELETE',`/repos/${owner}/${repo}`); }
}

class GitLabAPI {
  constructor(token){ this.token=token; this.base='https://gitlab.com/api/v4'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/user'); }
  createProject(name,desc){ return this.req('POST','/projects',{name,description:desc,visibility:'public',initialize_with_readme:true,pages_access_level:'public'}); }
  async createOrUpdateFile(pid,filePath,content,msg){
    try{ return await this.req('POST',`/projects/${pid}/repository/files/${encodeURIComponent(filePath)}`,{branch:'main',content,commit_message:msg,encoding:'text'}); }
    catch(e){
      if(e.message&&(e.message.includes('already exists')||e.message.includes('A file with this name already exists'))){
        return await this.req('PUT',`/projects/${pid}/repository/files/${encodeURIComponent(filePath)}`,{branch:'main',content,commit_message:msg,encoding:'text'});
      }
      throw e;
    }
  }
  enablePages(pid){ return this.req('PUT',`/projects/${pid}`,{pages_access_level:'public'}).catch(()=>{}); }
}

class NetlifyAPI {
  constructor(token){ this.token=token; this.base='https://api.netlify.com/api/v1'; }
  h(extra={}){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json',...extra}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    if(!r.ok){ const t=await r.text(); throw new Error(t||'HTTP '+r.status); } return r.json().catch(()=>({}));
  }
  getUser(){ return this.req('GET','/user'); }
  createSite(name){ return this.req('POST','/sites',{name,subdomain:name}); }
  async deploySite(siteId,htmlContent){
    // Step 1: Compute SHA1 of file content
    const encoder=new TextEncoder();
    const data=encoder.encode(htmlContent);
    const hashBuffer=await crypto.subtle.digest('SHA-1',data);
    const hashArray=Array.from(new Uint8Array(hashBuffer));
    const sha1=hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
    // Step 2: Create deploy with file manifest
    const r1=await fetch(`${this.base}/sites/${siteId}/deploys`,{method:'POST',
      headers:{'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'},
      body:JSON.stringify({files:{'/index.html':sha1},draft:false})});
    const d1=await r1.json(); if(!r1.ok) throw new Error(d1.message||'Deploy init failed');
    // Step 3: Upload required files
    if(d1.required&&d1.required.length>0){
      const r2=await fetch(`${this.base}/deploys/${d1.id}/files/index.html`,{method:'PUT',
        headers:{'Authorization':`Bearer ${this.token}`,'Content-Type':'application/octet-stream'},
        body:new Blob([htmlContent])});
      if(!r2.ok){ const t=await r2.text(); throw new Error('File upload failed: '+r2.status); }
    }
    return d1;
  }
}

class VercelAPI {
  constructor(token){ this.token=token; this.base='https://api.vercel.com'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.error&&d.error.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/v2/user'); }
  async createDeployment(name,htmlContent){
    // Compute SHA1 for Vercel file manifest
    const encoder=new TextEncoder();
    const data=encoder.encode(htmlContent);
    const hashBuf=await crypto.subtle.digest('SHA-1',data);
    const sha1=Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    const bytes2=new TextEncoder().encode(htmlContent);
    const encoded=btoa(Array.from(bytes2).map(b=>String.fromCharCode(b)).join(''));
    return this.req('POST','/v13/deployments',{
      name:slug(name),
      files:[{file:'index.html',data:encoded,encoding:'base64',sha:sha1}],
      projectSettings:{framework:null},
      target:'production'
    });
  }
}

class NotionAPI {
  constructor(token){ this.token=token; this.base='https://api.notion.com/v1'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json','Notion-Version':'2022-06-28'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/users/me'); }
  async createPage(parentPageId,title,content){
    const blocks=content.split('\n\n').filter(Boolean).slice(0,100).map(para=>({object:'block',type:'paragraph',paragraph:{rich_text:[{type:'text',text:{content:para.slice(0,2000)}}]}}));
    return this.req('POST','/pages',{parent:{page_id:parentPageId},properties:{title:{title:[{type:'text',text:{content:title}}]}},children:blocks});
  }
}

class MediumAPI {
  constructor(token){ this.token=token; this.base='https://api.medium.com/v1'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json','Accept':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/me'); }
  createPost(userId,title,content,tags=[]){ return this.req('POST',`/users/${userId}/posts`,{title,contentFormat:'markdown',content,tags:tags.slice(0,5),publishStatus:'public'}); }
}

class HashnodeAPI {
  constructor(token){ this.token=token; this.base='https://gql.hashnode.com'; }
  async query(q,vars={}){
    const r=await fetch(this.base,{method:'POST',headers:{'Authorization':this.token,'Content-Type':'application/json'},body:JSON.stringify({query:q,variables:vars})});
    const d=await r.json(); if(d.errors) throw new Error(d.errors[0].message); return d.data;
  }
  getUser(){ return this.query('query{me{id username name}}'); }
  getPublications(){ return this.query('query{me{publications(first:10){edges{node{id title url}}}}}'); }
  createPost(publicationId,title,content,tags=[]){
    return this.query('mutation CreatePost($input:PublishPostInput!){publishPost(input:$input){post{id url}}}',
      {input:{title,contentMarkdown:content,publicationId,tags:tags.slice(0,5).map(t=>({name:t,slug:slug(t)})),originalArticleURL:null}});
  }
}

class RedditAPI {
  constructor(token){ this.token=token; this.base='https://oauth.reddit.com'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'User-Agent':'SEO-Tool/1.0','Content-Type':'application/x-www-form-urlencoded'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?new URLSearchParams(body).toString():undefined});
    const d=await r.json(); if(d.error) throw new Error(d.message||d.error); return d;
  }
  getMe(){ return this.req('GET','/api/v1/me'); }
  submit(subreddit,title,text){ return this.req('POST','/api/submit',{api_type:'json',kind:'self',sr:subreddit,title,text,resubmit:'true'}); }
}

class BloggerAPI {
  constructor(token){ this.token=token; this.base='https://www.googleapis.com/blogger/v3'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.error&&d.error.message||'HTTP '+r.status); return d;
  }
  listBlogs(){ return this.req('GET','/users/self/blogs'); }
  createPost(blogId,title,content,labels=[]){ return this.req('POST',`/blogs/${blogId}/posts`,{kind:'blogger#post',title,content,labels}); }
}

class SubstackAPI {
  constructor(token,subdomain){ this.token=token; this.subdomain=subdomain; this.base=`https://${subdomain}.substack.com/api/v1`; }
  h(){ return {'Cookie':`substack.sid=${this.token}`,'Content-Type':'application/json','Origin':'https://'+this.subdomain+'.substack.com','Referer':'https://'+this.subdomain+'.substack.com'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined,credentials:'include'});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||d.message||'HTTP '+r.status); return d;
  }
  // Substack v1 API: create draft then publish
  async createPost(title,htmlBody){
    // Create as published post directly
    const body={
      type:'newsletter',
      draft:false,
      title,
      body_html:'<div>'+htmlBody+'</div>',
      audience:'everyone',
      send_email:false
    };
    return this.req('POST','/posts',body);
  }
}

class WordPressAPI {
  constructor(token){ this.token=token; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async getMe(){
    const r=await fetch('https://public-api.wordpress.com/rest/v1.1/me',{headers:this.h()});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'HTTP '+r.status); return d;
  }
  async getSites(){
    const r=await fetch('https://public-api.wordpress.com/rest/v1.1/me/sites',{headers:this.h()});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'HTTP '+r.status); return d;
  }
  async createPost(siteId,title,content,tags=[]){
    const r=await fetch(`https://public-api.wordpress.com/rest/v1.1/sites/${siteId}/posts/new`,{method:'POST',headers:this.h(),body:JSON.stringify({title,content,status:'publish',tags:tags.join(','),format:'standard'})});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||d.message||'HTTP '+r.status); return d;
  }
}

class DevToAPI {
  constructor(token){ this.token=token; this.base='https://dev.to/api'; }
  h(){ return {'api-key':this.token,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/users/me'); }
  createArticle(title,body_markdown,tags=[]){ return this.req('POST','/articles',{article:{title,body_markdown,published:true,tags:tags.slice(0,4)}}); }
}

class TumblrAPI {
  constructor(token,blogName){ this.token=token; this.blogName=blogName; this.base='https://api.tumblr.com/v2'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(d.meta&&d.meta.status>=400) throw new Error(d.meta.msg||'HTTP '+d.meta.status); return d;
  }
  getUser(){ return this.req('GET','/user/info'); }
  createPost(blogId,title,body,tags=[]){ return this.req('POST',`/blog/${blogId}/posts`,{content:[{type:'text',text:`# ${title}\n\n${body}`}],tags,state:'published'}); }
}

class GhostAPI {
  // adminKey format: "KEY_ID:SECRET" e.g. "64a6...c4:9f2a..."
  constructor(adminKey,apiUrl){ this.adminKey=adminKey; this.apiUrl=(apiUrl||'').replace(/\/$/,''); this.base=this.apiUrl+'/ghost/api/admin'; }
  async _jwt(){
    // Ghost Admin API requires a signed JWT from the Admin API key
    const [id,secret]=this.adminKey.split(':');
    if(!id||!secret) throw new Error('Ghost Admin key must be in format "id:secret"');
    const now=Math.floor(Date.now()/1000);
    const header=btoa(JSON.stringify({alg:'HS256',typ:'JWT',kid:id})).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    const payload=btoa(JSON.stringify({iat:now,exp:now+300,aud:'/admin/'})).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    const sigInput=`${header}.${payload}`;
    // Decode hex secret to key bytes
    const keyBytes=new Uint8Array(secret.match(/../g).map(h=>parseInt(h,16)));
    const cryptoKey=await crypto.subtle.importKey('raw',keyBytes,{name:'HMAC',hash:'SHA-256'},false,['sign']);
    const sig=await crypto.subtle.sign('HMAC',cryptoKey,new TextEncoder().encode(sigInput));
    const sigB64=btoa(String.fromCharCode(...new Uint8Array(sig))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    return `${sigInput}.${sigB64}`;
  }
  async h(){ const jwt=await this._jwt(); return {'Authorization':`Ghost ${jwt}`,'Content-Type':'application/json','Accept-Version':'v5.0'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:await this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'HTTP '+r.status); return d;
  }
  getSite(){ return this.req('GET','/site/'); }
  createPost(title,html,tags=[]){ return this.req('POST','/posts/?source=html',{posts:[{title,html,status:'published',tags:tags.map(t=>({name:t}))}]}); }
}

class TelegraphAPI {
  constructor(token){ this.token=token; this.base='https://api.telegra.ph'; }
  async req(method,params={}){
    const url=new URL(this.base+'/'+method);
    Object.entries({...params,access_token:this.token}).forEach(([k,v])=>url.searchParams.set(k,String(v)));
    const r=await fetch(url.toString()); const d=await r.json();
    if(!d.ok) throw new Error(d.error||'Telegraph error'); return d.result;
  }
  getAccount(){ return this.req('getAccountInfo',{fields:JSON.stringify(['short_name','page_count'])}); }
  async createPage(title,markdownContent,authorName=''){
    // Convert markdown to Telegraph node array
    const nodes=[];
    const lines=(markdownContent||'').split('\n');
    for(const line of lines){
      if(!line.trim()){ continue; }
      if(line.startsWith('# ')){ nodes.push({tag:'h3',children:[line.slice(2).trim()]}); }
      else if(line.startsWith('## ')){ nodes.push({tag:'h4',children:[line.slice(3).trim()]}); }
      else if(line.startsWith('### ')){ nodes.push({tag:'h4',children:[line.slice(4).trim()]}); }
      else if(line.startsWith('- ')){ nodes.push({tag:'p',children:[{tag:'li',children:[line.slice(2).trim()]}]}); }
      else if(line.startsWith('**')&&line.endsWith('**')){ nodes.push({tag:'p',children:[{tag:'b',children:[line.replace(/\*\*/g,'')]}]}); }
      else if(line.startsWith('> ')){ nodes.push({tag:'blockquote',children:[line.slice(2).trim()]}); }
      else if(line==='---'){ nodes.push({tag:'hr'}); }
      else { nodes.push({tag:'p',children:[line.trim()]}); }
    }
    // Inject links as paragraph at end
    const linkLines=(markdownContent||'').match(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g)||[];
    if(linkLines.length){ nodes.push({tag:'p',children:['Resources: ',...linkLines.map(m=>{ const [,label,href]=m.match(/\[([^\]]+)\]\(([^)]+)\)/)||[]; return {tag:'a',attrs:{href,target:'_blank'},children:[label||href]}; }).flatMap((n,i,a)=>i<a.length-1?[n,', ']:[n])]}); }
    const safeNodes=nodes.slice(0,200);
    const r=await fetch(this.base+'/createPage',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({access_token:this.token,title:title.slice(0,256),author_name:(authorName||'').slice(0,128),content:safeNodes,return_content:false})});
    const d=await r.json(); if(!d.ok) throw new Error(d.error||'Telegraph createPage failed'); return d.result;
  }
}

class CloudflareAPI {
  constructor(token,accountId){ this.token=token; this.accountId=accountId; this.base='https://api.cloudflare.com/client/v4'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!d.success) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'CF error'); return d.result;
  }
  getUser(){ return this.req('GET','/user'); }
  createProject(name){ return this.req('POST',`/accounts/${this.accountId}/pages/projects`,{name,production_branch:'main'}); }
  async uploadPages(projectName,htmlContent){
    const formData=new FormData();
    formData.append('/index.html',new Blob([htmlContent],{type:'text/html'}),'/index.html');
    const r=await fetch(`${this.base}/accounts/${this.accountId}/pages/projects/${projectName}/deployments`,{method:'POST',headers:{'Authorization':`Bearer ${this.token}`},body:formData});
    const d=await r.json(); if(!d.success) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'CF deploy error'); return d.result;
  }
}

class WixAPI {
  constructor(token,siteId){ this.token=token; this.siteId=siteId; this.base='https://www.wixapis.com'; }
  h(){ return {'Authorization':this.token,'wix-site-id':this.siteId,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  async createPost(title,htmlContent,tags=[]){
    // Wix Blog v3 API: create a post
    const body={
      post:{
        title,
        excerpt:title+' ‚Äî complete guide',
        featured:false,
        status:'PUBLISHED',
        richContent:{
          nodes:[
            {type:'HEADING',id:'h1',nodes:[{type:'TEXT',id:'t1',textData:{text:title,decorations:[]}}],headingData:{level:1}},
            {type:'PARAGRAPH',id:'p1',nodes:[{type:'TEXT',id:'t2',textData:{text:htmlContent.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,5000),decorations:[]}}],paragraphData:{}}
          ]
        },
        tagIds:[]
      }
    };
    return this.req('POST','/blog/v3/posts',body);
  }
}

class ReplitAPI {
  constructor(token){ this.token=token; this.base='https://replit.com/graphql'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'}; }
  async query(q,vars={}){
    const r=await fetch(this.base,{method:'POST',headers:this.h(),body:JSON.stringify({query:q,variables:vars})});
    const d=await r.json(); if(d.errors) throw new Error(d.errors[0].message); return d.data;
  }
  getUser(){ return this.query('query{currentUser{id username}}'); }
  createRepl(title,sl){ return this.query('mutation($input:CreateReplInput!){createRepl(input:$input){repl{id url slug}}}',{input:{title,slug:sl,isPrivate:false,language:'html'}}); }
}

class IssuuAPI {
  constructor(token){ this.token=token; this.base='https://api.issuu.com/v2'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await fetch(this.base+path,{method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/drafts?size=1'); }
  createDraft(title,description){ return this.req('POST','/drafts',{confirmCopyright:true,fileUrl:'',title,description,type:'editorial',access:'public'}); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TERMINAL HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeTerminal(termEl){
  const add=(msg,type='info')=>{
    const div=document.createElement('div');
    div.className='tline';
    div.innerHTML=`<span class="ttime">${ts()}</span><span class="t-${type}">${esc(msg)}</span>`;
    termEl.appendChild(div);
    termEl.scrollTop=termEl.scrollHeight;
  };
  const clear=()=>{ termEl.innerHTML='<span class="tm">// Output will appear here...</span>'; };
  clear();
  return {add,clear};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function urlBannerHTML(url,label,pid){
  const p=getPlatform(pid);
  return `<div class="url-banner">
    <span style="font-size:16px">${p.icon}</span>
    <div style="flex:1"><div class="ub-label">${esc(label)} ¬∑ ${esc(p.name)}</div><div class="ub-url"><a href="${esc(url)}" target="_blank" rel="noreferrer">${esc(url)}</a></div></div>
    <button class="btn btn-ghost btn-sm" onclick="copyText('${esc(url)}',this)">COPY</button>
    <a href="${esc(url)}" target="_blank" rel="noreferrer" class="btn btn-primary btn-sm">Visit ‚Üó</a>
  </div>`;
}
function copyText(text,btn){
  if(!text||typeof text!=='string'){ console.warn('copyText: invalid text'); return; }
  navigator.clipboard.writeText(text).then(()=>{
    const old=btn.textContent; btn.textContent='‚úì COPIED';
    setTimeout(()=>btn.textContent=old,1500);
  }).catch(()=>{ 
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    const old=btn.textContent; btn.textContent='‚úì COPIED'; setTimeout(()=>btn.textContent=old,1500);
  });
}
function exportCopy(btn){ copyText(getExportAll(),btn); }
function setProgress(barEl,pct){ barEl.style.width=pct+'%'; }
function notice(type,msg){ return `<div class="notice notice-${type}">${esc(msg)}</div>`; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function statBox(val,label,cls){ return `<div class="stat ${cls}"><div class="stat-v">${val}</div><div class="stat-l">${label}</div></div>`; }
function statsRow(items){ return `<div class="grid${items.length}" style="margin-bottom:18px">${items.map(([v,l,c])=>statBox(v,l,c)).join('')}</div>`; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOKEN LABELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TOKEN_INFO = {
  github:    {label:'Personal Access Token',     ph:'ghp_xxxxxxxxxxxxxxxxxxxx',     hint:'Required scopes: repo, delete_repo', link:'https://github.com/settings/tokens/new?scopes=repo,delete_repo'},
  gitlab:    {label:'Personal Access Token',     ph:'glpat-xxxxxxxxxxxxxxxxxxxx',   hint:'Required scopes: api, read_user',    link:'https://gitlab.com/-/user_settings/personal_access_tokens'},
  netlify:   {label:'Personal Access Token',     ph:'netlify-personal-access-token',hint:'Create at Netlify ‚Üí User Settings ‚Üí Applications', link:'https://app.netlify.com/user/applications/personal'},
  vercel:    {label:'Access Token',              ph:'vercel-access-token',          hint:'Create at Vercel ‚Üí Account Settings ‚Üí Tokens', link:'https://vercel.com/account/tokens'},
  notion:    {label:'Integration Token',         ph:'secret_xxxxxxxxxxxxxxxxxxxx',  hint:'Create integration at notion.so/my-integrations', link:'https://www.notion.so/my-integrations'},
  medium:    {label:'Integration Token',         ph:'medium-integration-token',     hint:'Create at Medium Settings ‚Üí Security ‚Üí Integration tokens', link:'https://medium.com/me/settings/security'},
  substack:  {label:'Session Token (substack.sid)', ph:'your-substack-session-token', hint:'Find in browser cookies when logged into Substack', link:'https://substack.com'},
  blogger:   {label:'Google OAuth Token',        ph:'ya29.xxx... Google OAuth2 token', hint:'Requires Google Cloud OAuth2 token with blogger scope', link:'https://console.cloud.google.com/'},
  hashnode:  {label:'API Key',                   ph:'hashnode-api-key',             hint:'Hashnode ‚Üí Account Settings ‚Üí Developer ‚Üí API Keys', link:'https://hashnode.com/settings/developer'},
  reddit:    {label:'OAuth Bearer Token',        ph:'reddit-oauth-bearer-token',    hint:'Use Reddit API OAuth flow', link:'https://www.reddit.com/prefs/apps'},
  wordpress: {label:'WordPress.com OAuth Token', ph:'wordpress-oauth-access-token', hint:'OAuth token from WordPress.com developer apps', link:'https://developer.wordpress.com/apps/'},
  devto:     {label:'Dev.to API Key',            ph:'dev-to-api-key',               hint:'Settings ‚Üí Account ‚Üí DEV Community API Keys', link:'https://dev.to/settings/extensions'},
  tumblr:    {label:'OAuth Bearer Token',        ph:'tumblr-oauth-token',           hint:'Create app at Tumblr API ‚Äî use OAuth2 bearer token', link:'https://www.tumblr.com/oauth/apps'},
  ghost:     {label:'Admin API Key (id:secret)', ph:'64a6...c4:9f2a...',            hint:'Ghost Admin ‚Üí Integrations ‚Üí Add custom integration', link:'https://ghost.org/docs/admin-api/'},
  wix:       {label:'Wix API Key',               ph:'wix-api-key',                  hint:'Wix Dev Center ‚Üí API Keys ‚Üí Generate API Key', link:'https://manage.wix.com/account/api-keys'},
  telegraph: {label:'Access Token',              ph:'telegraph-access-token',       hint:'Create account at telegra.ph/api ‚Üí createAccount', link:'https://telegra.ph/api'},
  codepen:   {label:'CodePen Username',          ph:'your-codepen-username',        hint:'CodePen has no write API ‚Äî username used for tracking', link:'https://codepen.io'},
  replit:    {label:'Replit API Token',          ph:'replit-api-token',             hint:'Replit ‚Üí Account Settings ‚Üí Connected Services ‚Üí API', link:'https://replit.com/account'},
  cloudflare:{label:'Cloudflare API Token',      ph:'cloudflare-api-token',         hint:'Cloudflare Dashboard ‚Üí My Profile ‚Üí API Tokens ‚Üí Create Token', link:'https://dash.cloudflare.com/profile/api-tokens'},
  issuu:        {label:'Issuu API Token',           ph:'issuu-api-token',              hint:'Issuu account settings ‚Üí API keys', link:'https://issuu.com/home/settings/integrations'},
  // new platforms
  onfeetnation: {label:'Username',                  ph:'your-username',                hint:'Your OnFeetNation login username', link:'https://www.onfeetnation.com'},
  caribbeanfever:{label:'Username',                 ph:'your-username',                hint:'Your CaribbeanFever login username', link:'https://caribbeanfever.com'},
  bitbin:       {label:'(No login needed)',          ph:'anonymous',                    hint:'Bitbin allows anonymous pastes. Enter any label.', link:'https://bitbin.it'},
  pastelink:    {label:'(No login needed)',          ph:'anonymous',                    hint:'Pastelink allows anonymous pastes. Enter any label.', link:'https://pastelink.net'},
  click4r:      {label:'Username',                  ph:'your-username',                hint:'Your Click4R account username', link:'https://www.click4r.com'},
  ideone:       {label:'(No login needed)',          ph:'anonymous',                    hint:'Ideone allows public pastes without login. Enter any label.', link:'https://ideone.com'},
  controlc:     {label:'(No login needed)',          ph:'anonymous',                    hint:'ControlC allows anonymous pastes. Enter any label.', link:'https://controlc.com'},
  rentry:       {label:'Edit Code (optional)',       ph:'leave blank for random',       hint:'Rentry.co edit code protects your paste. Leave blank to auto-generate.', link:'https://rentry.co'},
  techplanet:   {label:'Username',                  ph:'your-username',                hint:'Your TechPlanet account username', link:'https://techplanet.today'},
  vingle:       {label:'Access Token',              ph:'vingle-access-token',          hint:'Vingle OAuth access token from developer settings', link:'https://www.vingle.net'},
  writeonwall:  {label:'Username',                  ph:'your-username',                hint:'Your WriteOnWall account username', link:'https://writeonwall.com'},
  taylorhicks:  {label:'Ning API Key',              ph:'ning-api-key',                 hint:'Ning network API key from your account settings', link:'https://taylorhicks.ning.com'},
  snaplant:     {label:'Username',                  ph:'your-username',                hint:'Your Snaplant account username', link:'http://snaplant.com'},
  theprose:     {label:'Auth Token / Cookie',       ph:'your-session-token',           hint:'Session token from browser cookies after login', link:'https://www.theprose.com'},
  deviantart:   {label:'Access Token',              ph:'deviantart-access-token',      hint:'DeviantArt ‚Üí Developer Settings ‚Üí My Applications ‚Üí OAuth2 token', link:'https://www.deviantart.com/developers/'},
};
const EXTRA_INFO = {
  substack:  {label:'Your Substack Subdomain',   ph:'yourname (from yourname.substack.com)'},
  notion:    {label:'Parent Page ID',            ph:'notion page ID (32-char hex)'},
  blogger:   {label:'Blog ID (optional)',        ph:'Optional: specific blog ID'},
  reddit:    {label:'Default Subreddit',         ph:'e.g. entrepreneur'},
  ghost:     {label:'Ghost Blog URL',            ph:'https://yourblog.ghost.io'},
  wix:       {label:'Wix Site ID',               ph:'your-wix-site-id'},
  tumblr:    {label:'Blog Identifier',           ph:'yourblog.tumblr.com'},
  cloudflare:{label:'Cloudflare Account ID',     ph:'your-cloudflare-account-id'},
  issuu:        {label:'Issuu Username',            ph:'your-issuu-username'},
  onfeetnation: {label:'Password',                  ph:'your-password'},
  caribbeanfever:{label:'Password',                 ph:'your-password'},
  click4r:      {label:'Password',                  ph:'your-password'},
  techplanet:   {label:'Password',                  ph:'your-password'},
  writeonwall:  {label:'Password',                  ph:'your-password'},
  snaplant:     {label:'Password',                  ph:'your-password'},
  theprose:     {label:'Password',                  ph:'your-password'},
  taylorhicks:  {label:'Password',                  ph:'your-password'},
  deviantart:   {label:'DeviantArt Username',       ph:'your-deviantart-username'},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE UPDATER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHeader(){
  const live=S.campaigns.filter(c=>c.status==='success').length;
  document.getElementById('hdr-stats').textContent=`${S.accounts.length} accounts ¬∑ ${S.keywords.length} keywords ¬∑ ${live} live URLs`;
  const pill=document.getElementById('hdr-pill');
  if(S.accounts.length>0){ pill.className='pill pill-on'; pill.innerHTML='<span class="blink">‚óè</span> active'; }
  else { pill.className='pill pill-off'; pill.innerHTML='‚óè no accounts'; }
  document.getElementById('kw-badge').textContent=S.keywords.length;
  document.getElementById('link-badge').textContent=S.links.length;
  document.getElementById('export-badge').textContent=live;
  // sidebar accounts
  const sb=document.getElementById('sidebar-accounts');
  if(!S.accounts.length){ sb.innerHTML='<div style="padding:8px 18px;font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">No accounts connected</div>'; return; }
  const byPlatform={};
  S.accounts.forEach(a=>{ byPlatform[a.platform]=(byPlatform[a.platform]||0)+1; });
  sb.innerHTML='<div style="padding:8px 18px;font-family:var(--mono);font-size:11px;color:var(--muted2);line-height:2;font-weight:600">'+
    Object.entries(byPlatform).map(([pid,cnt])=>{ const p=getPlatform(pid); return `<div><span style="color:var(--accent)">${p.icon}</span> ${cnt}√ó ${p.name.split(' ')[0]}</div>`; }).join('')+'</div>';
}
function updatePlatformBar(){
  const bar=document.getElementById('platform-bar');
  bar.innerHTML=PLATFORMS.map(p=>{
    const accs=S.accounts.filter(a=>a.platform===p.id).length;
    const live=S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length;
    const badge=accs>0?`<span class="nav-badge" style="margin-left:4px">${live>0?live+' live':'‚úì'}</span>`:'';
    return `<div class="ptab ${S.activePlatform===p.id?'active':''}" onclick="switchPlatform('${p.id}')">
      <span style="font-size:14px">${p.icon}</span>${esc(p.name)}<span style="font-size:8px;opacity:0.5;margin-left:2px">DA${p.da}</span>${badge}</div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(id){
  S.activePage=id;
  document.querySelectorAll('.nav-item').forEach(el=>{
    el.classList.toggle('active', el.dataset.page===id);
  });
  document.querySelectorAll('.page').forEach(el=>{ el.classList.remove('active'); });
  const el=document.getElementById('page-'+id);
  if(el){ el.classList.add('active'); }
  renderPage(id);
}
function switchPlatform(id){
  S.activePlatform=id;
  updatePlatformBar();
  if(['setup','campaign'].includes(S.activePage)){ renderPage(S.activePage); }
}
document.querySelectorAll('.nav-item[data-page]').forEach(el=>{
  el.addEventListener('click',()=>switchPage(el.dataset.page));
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE RENDERERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPage(id){
  const el=document.getElementById('page-'+id);
  if(!el) return;
  const r={
    dashboard:   renderDashboard,
    global_blast:renderGlobalBlast,
    keywords:    renderKeywords,
    links:       renderLinks,
    setup:       renderSetup,
    campaign:    renderCampaign,
    indexing:    renderIndexing,
    export:      renderExport,
    content_studio: renderContentStudio,
    competitor_spy: renderCompetitorSpy,
    kw_research:    renderKwResearch,
    blog_commenter: renderBlogCommenter,
    parasite_finder: renderParasiteFinder,
    comment_sites: renderCommentSites,
  }[id];
  if(r) r(el);
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard(el){
  const totalSuccess=S.campaigns.filter(c=>c.status==='success').length;
  const totalFail=S.campaigns.filter(c=>c.status==='error').length;
  const rate=S.campaigns.length?Math.round(totalSuccess/S.campaigns.length*100):0;
  el.innerHTML=`
  <div class="page-title">‚ö° Dashboard</div>
  <div class="page-sub">// overview of all 20 platforms ¬∑ Global Blast ready</div>
  <div class="grid5" style="margin-bottom:18px">
    ${statBox(S.accounts.length,'Accounts','g')}${statBox(S.keywords.length,'Keywords','b')}
    ${statBox(totalSuccess,'Live URLs','g')}${statBox(totalFail,'Failed','r')}${statBox(rate+'%','Success Rate','p')}
  </div>
  <div class="card">
    <div class="card-title">Platform Status</div>
    <div class="grid5">${PLATFORMS.map(p=>{
      const accs=S.accounts.filter(a=>a.platform===p.id).length;
      const live=S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length;
      return `<div class="pstat" onclick="switchPlatform('${p.id}');switchPage('setup')" style="cursor:pointer;transition:border-color 0.15s,background 0.15s" onmouseenter="this.style.borderColor='var(--accent)';this.style.background='rgba(0,87,255,0.05)'" onmouseleave="this.style.borderColor='';this.style.background=''"><div class="pstat-icon">${p.icon}</div><div class="pstat-name">${esc(p.name)}</div>
        <div class="pstat-status" style="color:${accs>0?'var(--accent)':'var(--muted2)'}">${accs>0?'‚úì '+accs+' acct'+(accs>1?'s':'')+(live>0?' ¬∑ '+live+' live':''):' Not connected'}</div>
        <div style="font-size:10px;color:var(--muted2);font-family:var(--mono);margin-top:3px;font-weight:700">DA ${p.da}</div>
        <div style="font-size:10px;color:var(--accent);font-family:var(--mono);margin-top:4px;font-weight:700">‚Üí setup</div></div>`;
    }).join('')}</div>
  </div>
  ${S.campaigns.length?`
  <div class="card">
    <div class="card-title">Recent Campaign Activity</div>
    <div class="tw"><table>
      <thead><tr><th>Platform</th><th>Keyword</th><th>URL</th><th>Status</th><th>Time</th></tr></thead>
      <tbody>${[...S.campaigns].reverse().slice(0,15).map(c=>{
        const p=getPlatform(c.platform);
        return `<tr>
          <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs">${esc(p.name)}</span></td>
          <td class="mono xs">${esc(c.keyword)}</td>
          <td>${c.url?`<a href="${esc(c.url)}" target="_blank" rel="noreferrer" class="ta" style="text-decoration:none;font-size:11px;font-family:var(--mono);font-weight:600">${esc(c.url.replace('https://','').slice(0,40))}${c.url.length>45?'...':''}</a>`:'<span class="tm">‚Äî</span>'}</td>
          <td><span class="badge ${c.status==='success'?'badge-g':'badge-r'}">${c.status}</span></td>
          <td class="tm mono xs">${c.ts}</td></tr>`;
      }).join('')}</tbody>
    </table></div>
  </div>`:`<div class="notice notice-info">Connect accounts in Setup, add Keywords, then run campaigns. Activity appears here.</div>`}`;
}

// ‚îÄ‚îÄ‚îÄ KEYWORDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderKeywords(el){
  el.innerHTML=`
  <div class="page-title">üîë Keyword Manager</div>
  <div class="page-sub">// keywords shared across ALL platforms</div>
  <div class="card">
    <div class="card-title">Add Keyword</div>
    <div class="row">
      <div class="f1 fg mb0"><input type="text" id="kw-input" placeholder="e.g. best creatine supplement"/></div>
      <button class="btn btn-primary" onclick="addKeyword()">+ Add</button>
    </div>
    <div id="kw-chips" class="chips"></div>
    ${!S.keywords.length?'<p class="tm mono xs mt8">No keywords yet.</p>':''}
  </div>
  <div class="card">
    <div class="card-title">Bulk Import</div>
    <div class="fg"><label class="lbl">Paste keywords (comma or newline separated)</label>
      <textarea id="kw-bulk" rows="5" placeholder="best protein powder&#10;creatine monohydrate&#10;pre workout guide"></textarea></div>
    <div class="flex aic g8">
      <button class="btn btn-primary" onclick="bulkAddKeywords()">Import</button>
      <span class="tm mono xs">${S.keywords.length} keywords loaded</span>
      <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="clearKeywords()">Clear All</button>
    </div>
  </div>`;
  renderKwChips();
  document.getElementById('kw-input').addEventListener('keydown',e=>{ if(e.key==='Enter') addKeyword(); });
}
function renderKwChips(){
  const c=document.getElementById('kw-chips'); if(!c) return;
  c.innerHTML=S.keywords.map(k=>`<span class="chip on" onclick="removeKeyword('${esc(k)}')">${esc(k)} ‚úï</span>`).join('');
}
function addKeyword(){
  const inp=document.getElementById('kw-input'); if(!inp) return;
  const k=inp.value.trim(); if(!k||S.keywords.includes(k)) return;
  S.keywords.push(k); inp.value=''; updateHeader(); renderKeywords(document.getElementById('page-keywords'));
}
function removeKeyword(k){ S.keywords=S.keywords.filter(x=>x!==k); updateHeader(); renderKeywords(document.getElementById('page-keywords')); }
function bulkAddKeywords(){
  const ta=document.getElementById('kw-bulk'); if(!ta) return;
  const lines=ta.value.split(/[\n,]+/).map(l=>l.trim()).filter(Boolean);
  S.keywords=[...new Set([...S.keywords,...lines])]; ta.value='';
  updateHeader(); renderKeywords(document.getElementById('page-keywords'));
}
function clearKeywords(){ S.keywords=[]; updateHeader(); renderKeywords(document.getElementById('page-keywords')); }

// ‚îÄ‚îÄ‚îÄ LINKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// link status cache: id -> {status:'ok'|'broken'|'checking'|'unknown', code}
const _linkStatus={};

function renderLinks(el){
  const tColor={readme:'badge-b',html:'badge-y',both:'badge-g'};
  const broken=S.links.filter(l=>_linkStatus[l.id]&&_linkStatus[l.id].status==='broken').length;
  el.innerHTML=`
  <div class="page-title">üîó Link Manager</div>
  <div class="page-sub">// inject links into all generated content across all platforms</div>
  <div class="card">
    <div class="card-title">Add Link</div>
    <div class="grid2" style="margin-bottom:10px">
      <div class="fg mb0"><label class="lbl">Anchor Text</label><input type="text" id="link-label" placeholder="e.g. Our Main Resource"/></div>
      <div class="fg mb0"><label class="lbl">Destination URL</label><input type="url" id="link-url" placeholder="https://yoursite.com"/></div>
    </div>
    <div class="fg" style="margin-bottom:12px">
      <label class="lbl">Inject Into</label>
      <div class="mtabs">
        <div class="mtab on" id="lt-both" onclick="setLinkTarget('both')">Both</div>
        <div class="mtab" id="lt-readme" onclick="setLinkTarget('readme')">Markdown</div>
        <div class="mtab" id="lt-html" onclick="setLinkTarget('html')">HTML Only</div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="addLink()">+ Add Link</button>
  </div>
  <div class="card">
    <div class="card-title flex aic">
      Active Links <span class="nav-badge" style="margin-left:6px">${S.links.length}</span>
      ${broken>0?`<span class="nav-badge red" style="margin-left:4px">${broken} broken</span>`:''}
      <div style="margin-left:auto;display:flex;gap:6px">
        ${S.links.length?`<button class="btn btn-yellow btn-sm" onclick="checkAllLinks()">üîç Check All Links</button>`:''}
        ${broken>0?`<button class="btn btn-blue btn-sm" onclick="fixBrokenLinks()">üîß Fix Broken</button>`:''}
      </div>
    </div>
    ${!S.links.length?'<p class="tm mono xs">No links yet.</p>':''}
    ${S.links.map(l=>{
      const st=_linkStatus[l.id];
      let statusHtml='<span class="link-status-unknown">‚Äî not checked</span>';
      if(st){
        if(st.status==='checking') statusHtml='<span class="link-status-checking"><span class="spinner"></span> checking‚Ä¶</span>';
        else if(st.status==='ok') statusHtml=`<span class="link-status-ok">‚úì OK ${st.code?'('+st.code+')':''}</span>`;
        else if(st.status==='broken') statusHtml=`<span class="link-status-broken">‚úó Broken ${st.code?'('+st.code+')':''}</span>`;
      }
      return `
    <div class="link-row" id="lrow-${l.id}" style="grid-template-columns:1fr 1fr auto auto auto">
      <div><div class="lbl" style="margin-bottom:2px">Anchor</div><div class="mono xs">${esc(l.label)}</div></div>
      <div style="overflow:hidden">
        <div class="lbl" style="margin-bottom:2px">URL</div>
        <div class="mono xs" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap"><a href="${esc(l.url)}" target="_blank" rel="noreferrer" class="ta" style="text-decoration:none">${esc(l.url)}</a></div>
        <div style="margin-top:3px">${statusHtml}</div>
      </div>
      <div><div class="lbl" style="margin-bottom:4px">Target</div><div style="display:flex;gap:4px">${['readme','html','both'].map(t=>`<span class="badge ${tColor[t]}" style="cursor:pointer;opacity:${l.target===t?1:0.3}" onclick="setLinkTargetFor('${l.id}','${t}')">${t}</span>`).join('')}</div></div>
      <button class="btn btn-ghost btn-sm" onclick="openEditLink('${l.id}')" title="Edit">‚úé</button>
      <button class="btn btn-danger btn-sm" onclick="removeLink('${l.id}')">‚úï</button>
    </div>`;
    }).join('')}
  </div>`;
  window._linkTarget='both';
}
let _linkTarget='both';
function setLinkTarget(t){
  _linkTarget=t;
  ['both','readme','html'].forEach(x=>document.getElementById('lt-'+x)&&document.getElementById('lt-'+x).classList.toggle('on',x===t));
}
function addLink(){
  const label=document.getElementById('link-label').value.trim();
  let url=document.getElementById('link-url').value.trim();
  if(!label||!url) return;
  if(!url.startsWith('http')) url='https://'+url;
  S.links.push({id:uid(),label,url,target:_linkTarget});
  updateHeader(); renderLinks(document.getElementById('page-links'));
}
function removeLink(id){ S.links=S.links.filter(l=>l.id!==id); delete _linkStatus[id]; updateHeader(); renderLinks(document.getElementById('page-links')); }
function setLinkTargetFor(id,t){ const l=S.links.find(x=>x.id===id); if(l){ l.target=t; renderLinks(document.getElementById('page-links')); } }

// ‚îÄ‚îÄ‚îÄ EDIT LINK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditLink(id){
  const l=S.links.find(x=>x.id===id); if(!l) return;
  // Remove existing modal if any
  const old=document.getElementById('edit-modal'); if(old) old.remove();
  const modal=document.createElement('div');
  modal.id='edit-modal';
  modal.className='modal-overlay';
  modal.innerHTML=`
  <div class="modal-box">
    <div class="modal-title">
      <span>‚úé Edit Link</span>
      <button class="btn btn-ghost btn-xs" onclick="closeEditModal()">‚úï Close</button>
    </div>
    <div class="fg"><label class="lbl">Anchor Text</label>
      <input type="text" id="edit-label" value="${esc(l.label)}" placeholder="Anchor text"/></div>
    <div class="fg"><label class="lbl">Destination URL</label>
      <input type="url" id="edit-url" value="${esc(l.url)}" placeholder="https://yoursite.com"/>
      <div id="edit-check-result" style="margin-top:5px;font-family:var(--mono);font-size:9px"></div>
    </div>
    <div class="fg"><label class="lbl">Inject Into</label>
      <div class="mtabs" style="margin-bottom:0">
        ${['both','readme','html'].map(t=>`<div class="mtab ${l.target===t?'on':''}" id="em-lt-${t}" onclick="setEditTarget('${t}')">${t}</div>`).join('')}
      </div>
    </div>
    <div class="flex aic g8" style="margin-top:16px">
      <button class="btn btn-blue btn-sm" onclick="checkEditUrl('${id}')">üîç Check URL</button>
      <button class="btn btn-primary" style="margin-left:auto" onclick="saveEditLink('${id}')">‚úì Save Changes</button>
    </div>
  </div>`;
  // Close on backdrop click
  modal.addEventListener('click',e=>{ if(e.target===modal) closeEditModal(); });
  document.body.appendChild(modal);
  window._editLinkTarget=l.target;
}
function closeEditModal(){ const m=document.getElementById('edit-modal'); if(m) m.remove(); }
function setEditTarget(t){
  window._editLinkTarget=t;
  ['both','readme','html'].forEach(x=>{ const el=document.getElementById('em-lt-'+x); if(el) el.classList.toggle('on',x===t); });
}
function saveEditLink(id){
  const l=S.links.find(x=>x.id===id); if(!l) return;
  const labelEl=document.getElementById('edit-label');
  const urlEl=document.getElementById('edit-url');
  if(!labelEl||!urlEl) return;
  const label=labelEl.value.trim();
  let url=urlEl.value.trim();
  if(!label||!url){ alert('Anchor and URL are required.'); return; }
  if(!url.startsWith('http')) url='https://'+url;
  l.label=label; l.url=url; l.target=window._editLinkTarget||l.target;
  // Clear its status since URL may have changed
  delete _linkStatus[id];
  closeEditModal();
  renderLinks(document.getElementById('page-links'));
}
async function checkEditUrl(id){
  const urlEl=document.getElementById('edit-url');
  const resEl=document.getElementById('edit-check-result');
  if(!urlEl||!resEl) return;
  let url=urlEl.value.trim();
  if(!url.startsWith('http')) url='https://'+url;
  resEl.innerHTML='<span class="link-status-checking"><span class="spinner"></span> Checking‚Ä¶</span>';
  try{
    // Use a no-cors HEAD request; we can detect if it resolves
    const ctrl=new AbortController(); const tid=setTimeout(()=>ctrl.abort(),8000);
    const r=await fetch(url,{method:'HEAD',mode:'no-cors',signal:ctrl.signal});
    clearTimeout(tid);
    // no-cors always returns opaque response (type=opaque, status=0) for successful fetches
    resEl.innerHTML='<span class="link-status-ok">‚úì URL appears reachable</span>';
    if(id) _linkStatus[id]={status:'ok',code:''};
  }catch(e){
    if(e.name==='AbortError'){
      resEl.innerHTML='<span class="link-status-broken">‚úó Timed out ‚Äî URL may be broken</span>';
      if(id) _linkStatus[id]={status:'broken',code:'timeout'};
    } else {
      resEl.innerHTML='<span class="link-status-broken">‚úó Could not reach URL ‚Äî '+esc(e.message)+'</span>';
      if(id) _linkStatus[id]={status:'broken',code:'error'};
    }
  }
}

// ‚îÄ‚îÄ‚îÄ BULK LINK CHECKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAllLinks(){
  if(!S.links.length) return;
  // Mark all as checking
  S.links.forEach(l=>{ _linkStatus[l.id]={status:'checking',code:''}; });
  renderLinks(document.getElementById('page-links'));
  for(const l of S.links){
    await _checkLinkById(l.id, l.url);
    renderLinks(document.getElementById('page-links'));
  }
}
async function _checkLinkById(id, url){
  if(!url.startsWith('http')) url='https://'+url;
  try{
    const ctrl=new AbortController(); const tid=setTimeout(()=>ctrl.abort(),8000);
    await fetch(url,{method:'HEAD',mode:'no-cors',signal:ctrl.signal});
    clearTimeout(tid);
    _linkStatus[id]={status:'ok',code:''};
  }catch(e){
    _linkStatus[id]={status:'broken',code:e.name==='AbortError'?'timeout':'error'};
  }
}
function fixBrokenLinks(){
  // Open edit modal for first broken link
  const broken=S.links.find(l=>_linkStatus[l.id]&&_linkStatus[l.id].status==='broken');
  if(broken) openEditLink(broken.id);
}

// ‚îÄ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSetup(el){
  const pid=S.activePlatform;
  const p=getPlatform(pid);
  const ti=TOKEN_INFO[pid]||{label:'API Token',ph:'your-token',hint:'',link:''};
  const ex=EXTRA_INFO[pid];
  const accs=getAccounts(pid);
  el.innerHTML=`
  <div style="max-width:580px">
    <div class="page-title" style="color:var(--accent)">${p.icon} ${esc(p.name)}</div>
    <div class="page-sub">// ${esc(p.desc)} ¬∑ DA ${p.da}</div>
    ${accs.length?`<div class="card"><div class="card-title">Connected Accounts</div>
      ${accs.map(a=>`<div class="flex aic g8" style="padding:8px 0;border-bottom:1px solid var(--border)">
        ${a.avatar?`<img src="${esc(a.avatar)}" style="width:22px;height:22px;border-radius:50%">`:''}
        <span class="mono sm ta">@${esc(a.login)}</span>
        ${a.extra?`<span class="mono xs tm">(${esc(a.extra)})</span>`:''}
        <span class="badge badge-g" style="margin-left:auto">ACTIVE</span>
        <button class="btn btn-danger btn-sm" onclick="removeAccount('${a.id}','${pid}')">‚úï</button>
      </div>`).join('')}
    </div>`:''}
    <div class="card">
      <div class="card-title">Connect ${esc(p.name)} Account</div>
      <div class="fg">
        <label class="lbl">${esc(ti.label)}</label>
        <input type="password" id="setup-token" placeholder="${esc(ti.ph)}"/>
        <p class="xs mono tm" style="margin-top:5px;line-height:1.7">${esc(ti.hint)}</p>
      </div>
      ${ex?`<div class="fg"><label class="lbl">${esc(ex.label)}</label><input type="text" id="setup-extra" placeholder="${esc(ex.ph)}"/></div>`:''}
      <div class="flex aic g8">
        <button class="btn btn-primary" id="setup-btn" onclick="connectAccount('${pid}')">‚Üí Connect Account</button>
        ${ti.link?`<a href="${esc(ti.link)}" target="_blank" rel="noreferrer" class="btn btn-ghost btn-sm">Get Token ‚Üó</a>`:''}
      </div>
      <div id="setup-msg" style="margin-top:8px;font-family:var(--mono);font-size:10px"></div>
    </div>
    <div class="card">
      <div class="card-title">Platform Info</div>
      <div style="font-family:var(--mono);font-size:12px;line-height:2.2;color:var(--text);font-weight:600">
        <div><span class="ta">‚úì</span> Domain Authority: <span class="ta">${p.da}</span></div>
        <div><span class="ta">‚úì</span> Domain: <span class="ta">${p.domain}</span></div>
        <div><span class="ta">‚úì</span> API: <span class="ta">${esc(p.api)}</span></div>
        <div><span class="ta">‚úì</span> ${esc(p.desc)}</div>
      </div>
    </div>
  </div>`;
  const tokenEl=document.getElementById('setup-token');
  if(tokenEl) tokenEl.addEventListener('keydown',e=>{ if(e.key==='Enter') connectAccount(pid); });
}

async function connectAccount(pid){
  const tokenEl=document.getElementById('setup-token');
  const extraEl=document.getElementById('setup-extra');
  const msgEl=document.getElementById('setup-msg');
  const btn=document.getElementById('setup-btn');
  if(!tokenEl||!msgEl||!btn) return;
  const token=tokenEl.value.trim();
  const extra=extraEl?extraEl.value.trim():'';
  if(!token){ msgEl.innerHTML='<span class="tr">Token required</span>'; return; }
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Connecting...';
  msgEl.innerHTML='';
  try{
    let userInfo={login:'unknown',avatar:'',id:uid()};
    if(pid==='github'){ const api=new GitHubAPI(token); const u=await api.getUser(); userInfo={login:u.login,avatar:u.avatar_url,id:String(u.id)}; }
    else if(pid==='gitlab'){ const api=new GitLabAPI(token); const u=await api.getUser(); userInfo={login:u.username,avatar:u.avatar_url,id:String(u.id)}; }
    else if(pid==='netlify'){ const api=new NetlifyAPI(token); const u=await api.getUser(); userInfo={login:u.slug||u.email||'netlify-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='vercel'){ const api=new VercelAPI(token); const u=await api.getUser(); userInfo={login:(u.user&&(u.user.username||u.user.email))||'vercel-user',avatar:'',id:(u.user&&u.user.id)||uid()}; }
    else if(pid==='notion'){ const api=new NotionAPI(token); const u=await api.getUser(); userInfo={login:u.name||(u.bot&&u.bot.owner&&u.bot.owner.user&&u.bot.owner.user.name)||'notion-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='medium'){ const api=new MediumAPI(token); const u=await api.getUser(); userInfo={login:(u.data&&u.data.username)||'medium-user',avatar:(u.data&&u.data.imageUrl)||'',id:(u.data&&u.data.id)||uid()}; }
    else if(pid==='hashnode'){ const api=new HashnodeAPI(token); const u=await api.getUser(); userInfo={login:(u.me&&u.me.username)||'hashnode-user',avatar:'',id:(u.me&&u.me.id)||uid()}; }
    else if(pid==='reddit'){ const api=new RedditAPI(token); const u=await api.getMe(); userInfo={login:u.name||'reddit-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='blogger'){ const api=new BloggerAPI(token); const blogs=await api.listBlogs(); const b=blogs.items&&blogs.items[0]; userInfo={login:b&&b.name||'blogger-user',avatar:'',id:b&&b.id||uid()}; }
    else if(pid==='substack'){ userInfo={login:extra||'substack-user',avatar:'',id:uid()}; }
    else if(pid==='wordpress'){ const api=new WordPressAPI(token); const u=await api.getMe(); userInfo={login:u.username||u.login||'wp-user',avatar:u.avatar_URL||'',id:String(u.ID||uid())}; }
    else if(pid==='devto'){ const api=new DevToAPI(token); const u=await api.getUser(); userInfo={login:u.username||'devto-user',avatar:u.profile_image||'',id:String(u.id||uid())}; }
    else if(pid==='tumblr'){ const api=new TumblrAPI(token,extra||'blog'); const u=await api.getUser(); userInfo={login:(u.response&&u.response.user&&u.response.user.name)||extra||'tumblr-user',avatar:'',id:uid()}; }
    else if(pid==='ghost'){ const api=new GhostAPI(token,extra); const s=await api.getSite(); userInfo={login:(s.site&&s.site.url&&s.site.url.replace('https://','').split('.')[0])||'ghost-user',avatar:'',id:uid()}; }
    else if(pid==='wix'){ userInfo={login:extra||'wix-user',avatar:'',id:uid()}; }
    else if(pid==='telegraph'){ const api=new TelegraphAPI(token); const a=await api.getAccount(); userInfo={login:a.short_name||'telegraph-user',avatar:'',id:uid()}; }
    else if(pid==='codepen'){ userInfo={login:token||'codepen-user',avatar:'',id:uid()}; }
    else if(pid==='replit'){ const api=new ReplitAPI(token); const u=await api.getUser(); userInfo={login:(u&&u.currentUser&&u.currentUser.username)||'replit-user',avatar:'',id:uid()}; }
    else if(pid==='cloudflare'){ const api=new CloudflareAPI(token,extra); const u=await api.getUser(); userInfo={login:u.email||'cf-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='issuu'){ userInfo={login:extra||'issuu-user',avatar:'',id:uid()}; }
    // ‚îÄ‚îÄ NEW PLATFORMS (username-based, no verify API) ‚îÄ‚îÄ
    else if(pid==='onfeetnation'||pid==='caribbeanfever'||pid==='click4r'||pid==='techplanet'||pid==='writeonwall'||pid==='taylorhicks'||pid==='snaplant'||pid==='theprose'){
      if(!extra) throw new Error('Password is required for '+getPlatform(pid).name);
      userInfo={login:token,avatar:'',id:uid()};
    }
    else if(pid==='bitbin'||pid==='pastelink'||pid==='ideone'||pid==='controlc'||pid==='rentry'){
      userInfo={login:token||'anonymous',avatar:'',id:uid()};
    }
    else if(pid==='vingle'){ userInfo={login:token||'vingle-user',avatar:'',id:uid()}; }
    else if(pid==='deviantart'){ userInfo={login:extra||token||'deviantart-user',avatar:'',id:uid()}; }
    if(S.accounts.find(a=>a.platform===pid&&a.login===userInfo.login)){ msgEl.innerHTML='<span class="tr">Account already added.</span>'; btn.disabled=false; btn.textContent='‚Üí Connect Account'; return; }
    S.accounts.push({...userInfo,token,extra,platform:pid,addedAt:Date.now()});
    msgEl.innerHTML=`<span class="ta">‚úì Connected @${esc(userInfo.login)} to ${esc(getPlatform(pid).name)}</span>`;
    if(tokenEl) tokenEl.value=''; if(extraEl) extraEl.value='';
    updateHeader(); updatePlatformBar(); renderSetup(document.getElementById('page-setup'));
  }catch(e){
    msgEl.innerHTML=`<span class="tr">‚úó ${esc(e.message||'Connection failed')}</span>`;
  }
  btn.disabled=false; btn.textContent='‚Üí Connect Account';
}
function removeAccount(id,pid){ S.accounts=S.accounts.filter(a=>!(a.id===id&&a.platform===pid)); updateHeader(); updatePlatformBar(); renderSetup(document.getElementById('page-setup')); }

// ‚îÄ‚îÄ‚îÄ CAMPAIGN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Platform posting strategy meta
const PLATFORM_META = {
  github:    {type:'file',    label:'Repo Prefix',      ph:'seo',                      hint:'Creates a GitHub repo + Pages site. Each keyword gets its own repo with README.md + index.html.',          defVal:'seo'},
  gitlab:    {type:'file',    label:'Repo Prefix',      ph:'seo',                      hint:'Creates a GitLab project + CI pipeline ‚Üí Pages deployment. Takes ~2-5 min to go live.',                   defVal:'seo'},
  netlify:   {type:'file',    label:'Site Name Prefix', ph:'seo',                      hint:'Creates a new Netlify site and deploys index.html to a unique subdomain.netlify.app URL.',                defVal:'seo'},
  vercel:    {type:'file',    label:'Project Prefix',   ph:'seo',                      hint:'Deploys a static index.html to a new Vercel project with a vercel.app subdomain.',                        defVal:'seo'},
  cloudflare:{type:'file',    label:'Project Prefix',   ph:'seo',                      hint:'Creates a Cloudflare Pages project and uploads index.html. Goes live at project.pages.dev.',              defVal:'seo'},
  github_pages_existing:{type:'file'},
  medium:    {type:'article', label:'Article Tags',     ph:'seo,guide,marketing',      hint:'Publishes a formatted Markdown article to your Medium account. Max 5 tags.',                             defVal:'seo,guide'},
  substack:  {type:'article', label:'Subdomain',        ph:'yourpublication',          hint:'Publishes a newsletter post to your Substack. Requires your Substack subdomain (yourname.substack.com).', defVal:''},
  wordpress: {type:'article', label:'Post Tags',        ph:'seo,guide',                hint:'Creates and publishes a post to your WordPress.com site via the REST API.',                               defVal:'seo,guide'},
  blogger:   {type:'article', label:'Blog ID',          ph:'1234567890123456789',      hint:'Publish a post to your Blogger/Blogspot blog. Find your Blog ID in Blogger Settings.',                   defVal:''},
  devto:     {type:'article', label:'Tags (max 4)',     ph:'webdev,seo,javascript',    hint:'Publishes a developer article to dev.to. Tags must be lowercase, no spaces, max 4.',                     defVal:'webdev,seo'},
  hashnode:  {type:'article', label:'Publication ID',   ph:'64a6b...',                 hint:'Publishes to your Hashnode blog. Get the Publication ID from your Hashnode dashboard Settings.',         defVal:''},
  reddit:    {type:'post',    label:'Subreddit',        ph:'entrepreneur',             hint:'Submits a text post to the specified subreddit. Account needs karma to avoid spam filters.',              defVal:'entrepreneur'},
  tumblr:    {type:'post',    label:'Blog Identifier',  ph:'yourblog.tumblr.com',      hint:'Posts to your Tumblr blog. Use your blog URL or just the name (yourblog).',                             defVal:''},
  ghost:     {type:'article', label:'Ghost Blog URL',   ph:'https://yourblog.ghost.io',hint:'Publishes to your self-hosted Ghost CMS. Requires the Ghost Admin API key (id:secret format).',         defVal:''},
  notion:    {type:'page',    label:'Parent Page ID',   ph:'abc123... (32 char hex)',  hint:'Creates a Notion page inside the specified parent page. Get the ID from the page URL.',                  defVal:''},
  wix:       {type:'article', label:'Site ID',          ph:'your-wix-site-id',         hint:'Publishes a blog post to your Wix site via the Wix Blog v3 API.',                                      defVal:''},
  telegraph: {type:'page',    label:'Author Name',      ph:'Your Name',                hint:'Creates an instant anonymous page on Telegra.ph. No further setup needed ‚Äî goes live instantly.',       defVal:''},
  codepen:   {type:'prefill', label:'CodePen Username', ph:'yourusername',             hint:'Generates a CodePen prefill URL. Click the link to open the editor with content pre-loaded, then Save.', defVal:''},
  replit:    {type:'file',    label:'Repl Prefix',      ph:'seo',                      hint:'Creates a new public HTML Repl on your Replit account.',                                                 defVal:'seo'},
  issuu:        {type:'doc',     label:'Issuu Username',   ph:'yourusername',             hint:'Creates a publication draft on Issuu. Upload a PDF through the Issuu dashboard to complete publishing.',  defVal:''},
  // ‚îÄ‚îÄ NEW PLATFORMS ‚îÄ‚îÄ
  onfeetnation: {type:'post',    label:'Password',         ph:'your-password',            hint:'Creates a photo album post on OnFeetNation. Requires username + password.',        defVal:''},
  caribbeanfever:{type:'post',   label:'Password',         ph:'your-password',            hint:'Creates a photo album post on CaribbeanFever. Requires username + password.',     defVal:''},
  bitbin:       {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous public paste on Bitbin.it. No account needed.',              defVal:'seo-paste'},
  pastelink:    {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous public paste on Pastelink.net. No account needed.',          defVal:'seo-paste'},
  click4r:      {type:'article', label:'Password',         ph:'your-password',            hint:'Publishes a blog post on Click4R. Requires your username + password.',            defVal:''},
  ideone:       {type:'page',    label:'Label',            ph:'seo-snippet',              hint:'Creates a public text paste on Ideone.com. No account needed.',                   defVal:'seo-snippet'},
  controlc:     {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous paste on ControlC.com. No account needed.',                  defVal:'seo-paste'},
  rentry:       {type:'page',    label:'Edit Code',        ph:'leave blank for random',   hint:'Creates a Markdown page on Rentry.co. Edit code is optional.',                    defVal:''},
  techplanet:   {type:'article', label:'Password',         ph:'your-password',            hint:'Publishes a post on TechPlanet.today. Requires username + password.',             defVal:''},
  vingle:       {type:'article', label:'Interest ID',      ph:'interest-id',              hint:'Publishes a card to Vingle via access token. Get interest ID from your profile.', defVal:''},
  writeonwall:  {type:'post',    label:'Password',         ph:'your-password',            hint:'Submits a question post on WriteOnWall. Requires username + password.',           defVal:''},
  taylorhicks:  {type:'post',    label:'Password',         ph:'your-password',            hint:'Posts to TaylorHicks Ning forum. Requires Ning API key + password.',              defVal:''},
  snaplant:     {type:'post',    label:'Password',         ph:'your-password',            hint:'Submits a question on Snaplant Q&A. Requires username + password.',               defVal:''},
  theprose:     {type:'article', label:'Password',         ph:'your-password',            hint:'Publishes a post on TheProse. Requires username + session token/password.',       defVal:''},
  deviantart:   {type:'article', label:'Username',         ph:'your-username',            hint:'Publishes a journal entry to DeviantArt via OAuth2 access token.',                defVal:''},
};
const TYPE_LABELS={
  file:    {badge:'badge-b',  text:'Index File Upload',  desc:'Creates a subdomain and uploads an index.html file'},
  article: {badge:'badge-g',  text:'Article / Post',     desc:'Publishes an article or blog post via API'},
  post:    {badge:'badge-y',  text:'Community Post',     desc:'Submits a text post to a community platform'},
  page:    {badge:'badge-p',  text:'Page Creation',      desc:'Creates a web page or document'},
  prefill: {badge:'badge-b',  text:'Prefill URL',        desc:'Generates a pre-filled editor URL to publish manually'},
  doc:     {badge:'badge-r',  text:'Document Draft',     desc:'Creates a document draft for manual PDF upload'},
};

function renderCampaign(el){
  const pid=S.activePlatform;
  const p=getPlatform(pid);
  const meta=PLATFORM_META[pid]||{type:'article',label:'Extra',ph:'',hint:'',defVal:''};
  const typeInfo=TYPE_LABELS[meta.type]||TYPE_LABELS.article;
  const accs=getAccounts(pid);
  if(!accs.length){
    el.innerHTML=`
    <div class="page-title">${p.icon} ${esc(p.name)} Campaign</div>
    <div class="notice notice-warn">‚ö† No account connected for ${esc(p.name)}. Go to <strong>Setup / Connect</strong> in the sidebar and add your credentials first.</div>
    <div class="card"><div class="card-title">How ${esc(p.name)} Works</div>
    <div style="font-family:var(--mono);font-size:12px;line-height:2.2;color:var(--text);font-weight:600">
      <div><span class="badge ${typeInfo.badge}" style="margin-right:8px">${esc(typeInfo.text)}</span>${esc(typeInfo.desc)}</div>
      <div style="margin-top:10px;color:var(--text)">${esc(meta.hint||p.desc)}</div>
    </div></div>`;
    return;
  }
  el.innerHTML=`
  <div class="page-title">${p.icon} ${esc(p.name)} Campaign</div>
  <div class="page-sub">// ${esc(p.desc)} ¬∑ DA ${p.da}</div>
  <div class="grid4" style="margin-bottom:18px">
    ${statBox(S.keywords.length,'Keywords','g')}
    ${statBox(S.campaigns.filter(c=>c.platform===pid&&c.status==='success').length,'Live','b')}
    ${statBox(S.campaigns.filter(c=>c.platform===pid&&c.status==='error').length,'Failed','r')}
    ${statBox(accs.length,'Accounts','y')}
  </div>

  <div class="notice notice-info" style="margin-bottom:14px">
    <span class="badge ${typeInfo.badge}" style="margin-right:8px">${esc(typeInfo.text)}</span>
    <strong>${esc(p.name)} posting method:</strong> ${esc(meta.hint||p.desc)}
  </div>

  ${pid==='reddit'?`<div class="notice notice-warn">‚ö† Reddit enforces strict rate limits and spam detection. Post only to relevant, active subreddits. Your account must have sufficient karma.</div>`:''}
  ${pid==='codepen'?`<div class="notice notice-info">‚Ñπ CodePen has no public write API. After running, click each generated URL to open the editor with your content pre-loaded ‚Äî then press Save.</div>`:''}
  ${pid==='issuu'?`<div class="notice notice-info">‚Ñπ Issuu creates a publication draft via API. You must upload a PDF file through the Issuu dashboard to complete and publish each draft.</div>`:''}
  ${pid==='github'||pid==='gitlab'?`<div class="notice notice-info">‚Ñπ ${pid==='github'?'GitHub Pages':'GitLab Pages'} may take a few minutes to go live after deployment. ${pid==='gitlab'?'GitLab CI pipeline runs first (~2‚Äì5 min).':''}</div>`:''}

  <div class="card">
    <div class="card-title">Campaign Settings</div>
    <div class="grid${pid==='substack'||pid==='notion'||pid==='blogger'||pid==='hashnode'||pid==='ghost'||pid==='wix'?'2':'3'}">
      <div class="fg mb0"><label class="lbl">Account</label>
        <select id="camp-acc">${accs.map((a,i)=>`<option value="${i}">@${esc(a.login)}</option>`).join('')}</select></div>
      <div class="fg mb0"><label class="lbl">${esc(meta.label)}</label>
        <input type="text" id="camp-extra" placeholder="${esc(meta.ph)}" value="${esc(meta.defVal)}"/>
        ${meta.hint?`<p class="xs mono tm" style="margin-top:4px;line-height:1.6">${esc(meta.hint.slice(0,120))}</p>`:''}
      </div>
      ${!(pid==='substack'||pid==='notion'||pid==='blogger'||pid==='hashnode'||pid==='ghost'||pid==='wix')?`
      <div class="fg mb0"><label class="lbl">Delay Between Posts (sec)</label>
        <input type="number" id="camp-delay" value="${pid==='reddit'?10:pid==='medium'?6:4}" min="1" max="300"/>
        <p class="xs mono tm" style="margin-top:4px">${pid==='reddit'?'Reddit needs longer delays to avoid bans':'Longer delays reduce rate-limit errors'}</p>
      </div>`:''}
    </div>
    ${pid==='substack'||pid==='notion'||pid==='blogger'||pid==='hashnode'||pid==='ghost'||pid==='wix'?`
    <div class="fg mt8 mb0"><label class="lbl">Delay Between Posts (sec)</label>
      <input type="number" id="camp-delay" value="5" min="1" max="300" style="max-width:120px"/></div>`:''}
    ${pid==='devto'?`<div class="fg mt8"><label class="lbl">Tags (lowercase, no spaces, max 4 ‚Äî comma separated)</label><input type="text" id="camp-tags" value="webdev,seo,javascript,tutorial" placeholder="webdev,seo,javascript"/></div>`:''}
    ${pid==='cloudflare'?`<div class="fg mt8"><label class="lbl">Cloudflare Account ID (from dashboard URL)</label><input type="text" id="camp-cfacct" placeholder="your-cloudflare-account-id" value="${accs[0]&&accs[0].extra||''}"/></div>`:''}
    <div class="flex aic g8 mt8">
      <button class="btn btn-primary" id="camp-run-btn" onclick="runCampaign('${pid}')">‚ñ∂ Run Campaign ‚Äî ${S.keywords.length} keyword(s)</button>
      <div class="prog-wrap f1" style="margin:0;display:none" id="camp-prog-wrap"><div class="prog-fill" id="camp-prog"></div></div>
    </div>
  </div>
  <div id="camp-urls"></div>
  <div class="card">
    <div class="card-title flex aic g8">Terminal<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="document.getElementById('camp-term').innerHTML='<span class=tm>// Cleared</span>'">Clear</button></div>
    <div class="terminal" id="camp-term"><span class="tm">// Output will appear here once you run the campaign...</span></div>
  </div>`;
}

async function runCampaign(pid){
  if(!S.keywords.length){ alert('Add keywords first in the Keywords page.'); return; }
  const btn=document.getElementById('camp-run-btn');
  const termEl=document.getElementById('camp-term');
  const progWrap=document.getElementById('camp-prog-wrap');
  const progBar=document.getElementById('camp-prog');
  const urlsEl=document.getElementById('camp-urls');
  const accIdx=parseInt(document.getElementById('camp-acc').value)||0;
  const extraVal=(document.getElementById('camp-extra')||{value:''}).value.trim();
  const delayVal=parseInt((document.getElementById('camp-delay')||{value:4}).value)||4;
  const accs=getAccounts(pid);
  const account=accs[accIdx];
  if(!account) return;
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Running...';
  progWrap.style.display='block'; setProgress(progBar,0);
  termEl.innerHTML='';
  urlsEl.innerHTML='';
  const term=makeTerminal(termEl);
  const liveUrls=[];

  for(let i=0;i<S.keywords.length;i++){
    const kw=S.keywords[i];
    setProgress(progBar, Math.round(i/S.keywords.length*100));
    try{
      const url=await runSingleCampaign(pid,kw,account,extraVal,i,term);
      if(url){
        term.add('  ‚úì Live: '+url,'info');
        liveUrls.push({url,keyword:kw,platform:pid});
        const result={id:uid(),platform:pid,keyword:kw,repo:slug(extraVal+'-'+kw),url,status:'success',ts:ts()};
        S.campaigns=S.campaigns.filter(c=>!(c.platform===pid&&c.keyword===kw));
        S.campaigns.push(result);
        urlsEl.innerHTML=`<div class="card slide-in"><div class="card-title">üöÄ Live URLs</div>${liveUrls.map(u=>urlBannerHTML(u.url,u.keyword,u.platform)).join('')}</div>`;
      }
    }catch(e){
      term.add('  ‚úó Failed: '+e.message,'error');
      S.campaigns.push({id:uid(),platform:pid,keyword:kw,repo:slug((extraVal||'seo')+'-'+kw),url:'',status:'error',ts:ts(),error:e.message});
    }
    if(i<S.keywords.length-1) await sleep(delayVal*1000);
  }
  setProgress(progBar,100);
  term.add('Campaign complete: '+liveUrls.length+'/'+S.keywords.length+' succeeded','info');
  btn.disabled=false; btn.textContent='‚ñ∂ Run Campaign';
  updateHeader(); updatePlatformBar();
}

async function runSingleCampaign(pid, kw, account, extraVal, idx, term){
  const p=getPlatform(pid);
  const sl=slug((extraVal||'seo')+'-'+kw);
  term.add(`[${idx+1}/${S.keywords.length}] ${p.icon} ${p.name}: "${kw}"`, 'info');

  // ‚îÄ‚îÄ FILE-BASED PLATFORMS (subdomain + index.html) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='github'){
    // GitHub Pages: create repo ‚Üí push README.md + index.html + sitemap.xml ‚Üí enable Pages
    const api=new GitHubAPI(account.token);
    const repoName=slug((extraVal||'seo')+'-'+kw).slice(0,100)||'seo-page';
    const pageUrl='https://'+account.login+'.github.io/'+repoName+'/';
    try{ await api.createRepo(repoName,kw+' ‚Äî Guide '+year()); await sleep(1500); }
    catch(e){
      if(e.message.includes('already exists')||e.message.includes('422')||e.message.includes('name already exists')){
        term.add('  Repo exists ‚Äî updating content','warn');
      } else throw e;
    }
    await sleep(1000);
    const readme=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'github.io');
    const html=generateHtmlPage(kw,account.login,repoName,S.links,'github');
    const sitemap=`<?xml version="1.0"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"><url><loc>${pageUrl}</loc><lastmod>${new Date().toISOString().split('T')[0]}</lastmod><priority>1.0</priority></url></urlset>`;
    const existRM=await api.getFile(account.login,repoName,'README.md');
    await api.putFile(account.login,repoName,'README.md',readme,'SEO: update README',existRM&&existRM.sha||null);
    await sleep(500);
    const existIdx=await api.getFile(account.login,repoName,'index.html');
    await api.putFile(account.login,repoName,'index.html',html,'SEO: add index',existIdx&&existIdx.sha||null);
    await sleep(500);
    const existSm=await api.getFile(account.login,repoName,'sitemap.xml');
    await api.putFile(account.login,repoName,'sitemap.xml',sitemap,'SEO: add sitemap',existSm&&existSm.sha||null);
    await sleep(500);
    await api.enablePages(account.login,repoName).catch(()=>{});
    await api.updateTopics(account.login,repoName,[slug(kw),'seo','guide']).catch(()=>{});
    term.add('  ‚úì GitHub Pages: '+pageUrl,'info');
    return pageUrl;
  }

  if(pid==='gitlab'){
    // GitLab Pages: create project ‚Üí push index.html + README + .gitlab-ci.yml ‚Üí CI deploys Pages
    const api=new GitLabAPI(account.token);
    const projSlug=slug((extraVal||'seo')+'-'+kw).slice(0,100)||'seo-page';
    const pageUrl='https://'+account.login+'.gitlab.io/'+projSlug+'/';
    let proj;
    try{ proj=await api.createProject(projSlug,kw+' Guide '+year()); await sleep(1500); }
    catch(e){
      if(e.message&&(e.message.includes('already been taken')||e.message.includes('already exists'))){
        term.add('  Project exists ‚Äî updating content','warn');
        proj={id:null,name:projSlug}; // will fail on file ops but user can handle
      } else throw e;
    }
    const readme=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'gitlab.io');
    const html=generateHtmlPage(kw,account.login,projSlug,S.links,'gitlab');
    // CI pipeline: copy index.html into /public, enable Pages artifact
    const ci=`image: alpine\npages:\n  stage: deploy\n  script:\n    - mkdir -p public\n    - cp index.html public/index.html\n  artifacts:\n    paths:\n      - public\n  rules:\n    - if: $CI_COMMIT_BRANCH == "main"\n`;
    if(proj.id){
      await api.createOrUpdateFile(proj.id,'README.md',readme,'SEO: add README').catch(e=>term.add('  warn: '+e.message,'warn'));
      await sleep(400);
      await api.createOrUpdateFile(proj.id,'index.html',html,'SEO: add index.html').catch(e=>term.add('  warn: '+e.message,'warn'));
      await sleep(400);
      await api.createOrUpdateFile(proj.id,'.gitlab-ci.yml',ci,'SEO: add CI pipeline').catch(e=>term.add('  warn: '+e.message,'warn'));
      await api.enablePages(proj.id).catch(()=>{});
    }
    term.add('  ‚Ñπ GitLab CI will deploy Pages in ~2-5 minutes','warn');
    return pageUrl;
  }

  if(pid==='netlify'){
    // Netlify: create site ‚Üí deploy with index.html file via SHA1 manifest
    const api=new NetlifyAPI(account.token);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'netlify');
    const siteName=sl.slice(0,63).replace(/[^a-z0-9-]/g,'-').replace(/^-|-$/g,'')||'seo-site';
    term.add('  Creating Netlify site...','info');
    const site=await api.createSite(siteName);
    await sleep(1000);
    term.add('  Uploading index.html...','info');
    await api.deploySite(site.id,html);
    const siteUrl='https://'+(site.subdomain||site.name||siteName)+'.netlify.app/';
    return siteUrl;
  }

  if(pid==='vercel'){
    // Vercel: create deployment with index.html encoded as base64
    const api=new VercelAPI(account.token);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'vercel');
    const projName=sl.slice(0,52)||'seo-page';
    term.add('  Deploying to Vercel...','info');
    const dep=await api.createDeployment(projName,html);
    const depUrl=(dep.url)||sl+'.vercel.app';
    return 'https://'+(depUrl.startsWith('https://')?depUrl.replace('https://',''):depUrl)+'/';
  }

  if(pid==='cloudflare'){
    // Cloudflare Pages: create project ‚Üí upload index.html via multipart deploy
    const acctId=(document.getElementById('camp-cfacct')||{value:''}).value.trim()||account.extra||'';
    if(!acctId) throw new Error('Cloudflare Account ID is required ‚Äî enter it in the Campaign Settings above.');
    const api=new CloudflareAPI(account.token,acctId);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'cloudflare');
    const projName=sl.slice(0,28).replace(/[^a-z0-9-]/g,'-').replace(/^-|-$/g,'')||'seo-page';
    term.add('  Creating Cloudflare Pages project...','info');
    let proj;
    try{ proj=await api.createProject(projName); }
    catch(e){ if(e.message.includes('already exists')||e.message.includes('409')){ proj={name:projName}; }else throw e; }
    await sleep(1000);
    term.add('  Uploading index.html to Cloudflare Pages...','info');
    const deploy=await api.uploadPages(proj.name||projName,html);
    return deploy&&deploy.url?'https://'+deploy.url:'https://'+projName+'.pages.dev';
  }

  if(pid==='replit'){
    // Replit: create a public HTML Repl via GraphQL ‚Üí returns the Repl URL
    const api=new ReplitAPI(account.token);
    const replSlug=sl.slice(0,40)||'seo-page';
    term.add('  Creating Repl...','info');
    const res=await api.createRepl(kw+' SEO Guide '+year(),replSlug);
    const repl=res&&res.createRepl&&res.createRepl.repl;
    return repl&&repl.url?'https://replit.com'+repl.url:'https://replit.com/@'+account.login+'/'+replSlug;
  }

  // ‚îÄ‚îÄ ARTICLE / POST PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='medium'){
    // Medium: publish a Markdown article via Integration Token
    const api=new MediumAPI(account.token);
    term.add('  Getting Medium user ID...','info');
    const u=await api.getUser();
    const userId=u.data&&u.data.id; if(!userId) throw new Error('Could not get Medium user ID ‚Äî check your Integration Token');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'medium.com');
    const tags=(extraVal||'seo,guide').split(',').map(t=>t.trim()).filter(Boolean).slice(0,5);
    term.add('  Publishing article...','info');
    const res=await api.createPost(userId,kw+': Complete Guide '+year(),content,tags);
    return (res.data&&res.data.url)||'https://medium.com/@'+account.login;
  }

  if(pid==='substack'){
    // Substack: publish a post using session cookie token + subdomain
    const subdomain=extraVal||account.extra||account.login||'';
    if(!subdomain) throw new Error('Substack subdomain is required (e.g. "yourname" from yourname.substack.com)');
    const api=new SubstackAPI(account.token,subdomain);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'substack');
    term.add('  Publishing to Substack ('+subdomain+'.substack.com)...','info');
    const res=await api.createPost(kw+': Complete Guide '+year(),html);
    return res.url||res.canonical_url||'https://'+subdomain+'.substack.com';
  }

  if(pid==='wordpress'){
    // WordPress.com: get site ID ‚Üí publish post with HTML content
    const api=new WordPressAPI(account.token);
    term.add('  Getting WordPress sites...','info');
    const sites=await api.getSites();
    const siteId=sites.sites&&sites.sites[0]&&sites.sites[0].ID;
    if(!siteId) throw new Error('No WordPress.com site found on this account');
    const html=generateHtmlPage(kw,account.login,sl,S.links,'wordpress');
    const tags=(extraVal||'seo,guide').split(',').map(t=>t.trim()).filter(Boolean);
    term.add('  Publishing post...','info');
    const res=await api.createPost(siteId,kw+': Complete Guide '+year(),html,tags);
    return res.URL||res.link||'https://wordpress.com';
  }

  if(pid==='blogger'){
    // Blogger: publish an HTML post to the specified blog ID
    const api=new BloggerAPI(account.token);
    const blogId=extraVal||account.extra||account.id||'';
    if(!blogId) throw new Error('Blogger Blog ID is required ‚Äî find it in Blogger Settings ‚Üí Blog ID');
    const html=generateHtmlPage(kw,account.login,sl,S.links,'blogger');
    term.add('  Publishing to Blogger...','info');
    const res=await api.createPost(blogId,kw+': Complete Guide '+year(),html,[kw,'seo','guide']);
    return res.url||'https://blogger.com';
  }

  if(pid==='devto'){
    // Dev.to: publish a Markdown article via API key
    const api=new DevToAPI(account.token);
    const tagsStr=(document.getElementById('camp-tags')||{value:'webdev,seo,javascript,tutorial'}).value;
    const tags=tagsStr.split(',').map(t=>t.trim().replace(/\s+/g,'').toLowerCase()).filter(Boolean).slice(0,4);
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'dev.to');
    term.add('  Publishing article to Dev.to...','info');
    const art=await api.createArticle(kw+': Complete Guide '+year(),content,tags);
    return art.url||'https://dev.to/'+account.login;
  }

  if(pid==='hashnode'){
    // Hashnode: publish via GraphQL to a specific publication
    // publicationId must be a valid MongoDB ObjectId (24 hex chars).
    // During a Global Blast, extraVal may be a generic keyword/tag string ‚Äî ignore it if invalid.
    const isObjectId = v => /^[a-f\d]{24}$/i.test((v||'').trim());
    const pubId = isObjectId(extraVal) ? extraVal.trim()
                : isObjectId(account.extra) ? account.extra.trim()
                : '';
    if(!pubId) throw new Error('Hashnode Publication ID is required and must be a valid 24-character ObjectId ‚Äî find it in your Hashnode Dashboard ‚Üí Publication Settings ‚Üí General');
    const api=new HashnodeAPI(account.token);
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'hashnode.dev');
    term.add('  Publishing to Hashnode...','info');
    const res=await api.createPost(pubId,kw+': Complete Guide '+year(),content,[kw,'seo','guide']);
    return (res&&res.publishPost&&res.publishPost.post&&res.publishPost.post.url)||'https://hashnode.com/@'+account.login;
  }

  if(pid==='ghost'){
    // Ghost CMS: publish HTML post via JWT-authenticated Admin API
    const apiUrl=extraVal||account.extra||'';
    if(!apiUrl) throw new Error('Ghost Blog URL is required (e.g. https://yourblog.ghost.io)');
    const api=new GhostAPI(account.token,apiUrl);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'ghost');
    term.add('  Publishing to Ghost ('+apiUrl+')...','info');
    const res=await api.createPost(kw+': Complete Guide '+year(),html,[kw,'seo','guide']);
    return (res.posts&&res.posts[0]&&res.posts[0].url)||apiUrl;
  }

  if(pid==='wix'){
    // Wix: publish a blog post via Wix Blog v3 API
    const siteId=extraVal||account.extra||'';
    if(!siteId) throw new Error('Wix Site ID is required ‚Äî find it in your Wix dashboard URL');
    const api=new WixAPI(account.token,siteId);
    const htmlContent=generateHtmlPage(kw,account.login,sl,S.links,'wix');
    term.add('  Publishing blog post to Wix...','info');
    const res=await api.createPost(kw+': Complete Guide '+year(),htmlContent,[kw,'seo']);
    return (res.post&&res.post.url)||'https://'+account.login+'.wixsite.com';
  }

  if(pid==='tumblr'){
    // Tumblr: create a post using OAuth Bearer Token + blog identifier
    const blogId=(extraVal||account.extra||account.login+'.tumblr.com').replace('https://','');
    const api=new TumblrAPI(account.token,blogId);
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'tumblr.com');
    term.add('  Posting to Tumblr blog: '+blogId,'info');
    const post=await api.createPost(blogId,kw,content,[kw,'seo','guide']);
    const postId=post.response&&post.response.id||post.id;
    return 'https://'+blogId+'/post/'+(postId||'');
  }

  // ‚îÄ‚îÄ COMMUNITY POST PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='reddit'){
    // Reddit: submit a self (text) post to the specified subreddit
    const api=new RedditAPI(account.token);
    const subreddit=(extraVal||account.extra||'entrepreneur').replace(/^r\//,'');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'reddit.com');
    term.add('  Submitting to r/'+subreddit+'...','info');
    const res=await api.submit(subreddit,kw+': Complete Guide '+year(),content);
    const postUrl=res.json&&res.json.data&&res.json.data.url;
    return postUrl||'https://reddit.com/r/'+subreddit;
  }

  // ‚îÄ‚îÄ PAGE CREATION PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='notion'){
    // Notion: create a page inside the specified parent page
    const parentId=(extraVal||account.extra||'').replace(/-/g,'');
    if(!parentId) throw new Error('Notion Parent Page ID is required ‚Äî get it from the page URL (32-char hex string)');
    const api=new NotionAPI(account.token);
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'notion.site');
    term.add('  Creating Notion page...','info');
    const page=await api.createPage(parentId,kw+': Complete Guide '+year(),content);
    return page.url||'https://notion.so/'+account.login;
  }

  if(pid==='telegraph'){
    // Telegraph: create an instant page (no account required beyond access token)
    const api=new TelegraphAPI(account.token);
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'telegra.ph');
    const authorName=extraVal||account.login||'';
    term.add('  Creating Telegra.ph page...','info');
    const page=await api.createPage(kw+': Complete Guide '+year(),content,authorName);
    return 'https://telegra.ph/'+page.path;
  }

  // ‚îÄ‚îÄ PREFILL / MANUAL PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='codepen'){
    // CodePen: generate a prefill URL ‚Äî no API, user must click and save
    const html=generateHtmlPage(kw,account.login,sl,S.links,'codepen');
    const css=`body{font-family:system-ui,sans-serif;max-width:900px;margin:0 auto;padding:24px;background:#f8fafc;color:#1e293b}h1,h2,h3{color:#1e1b4b}a{color:#4f46e5}section{background:white;padding:20px;margin:16px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}`;
    const data=JSON.stringify({title:kw+' Guide '+year(),html,css,tags:['seo','guide'],editors:'110'});
    const penUrl='https://codepen.io/pen/define?data='+encodeURIComponent(data);
    term.add('  ‚Ñπ CodePen prefill URL generated ‚Äî click to open editor and save','warn');
    return penUrl;
  }

  // ‚îÄ‚îÄ DOCUMENT DRAFT PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='issuu'){
    const api=new IssuuAPI(account.token);
    const desc=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'issuu.com').slice(0,500);
    term.add('  Creating Issuu draft...','info');
    const draft=await api.createDraft(kw+': Complete Guide '+year(),desc);
    return draft.publicUrl||draft.link||'https://issuu.com/'+account.login;
  }

  // ‚îÄ‚îÄ PASTE / NO-LOGIN PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='bitbin'){
    // Bitbin.it ‚Äî POST to /api with content, returns slug
    const content=generateMarkdown(kw,S.links,idx,S.keywords,'anon','bitbin.it');
    const r=await fetch('https://bitbin.it/api/',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({content,language:'text',expire:'never'}).toString()});
    const d=await r.json();
    const path=d.data&&(d.data.hash||d.data.id||d.data.slug);
    if(!path) throw new Error('Bitbin: no path returned ‚Äî '+JSON.stringify(d).slice(0,100));
    return 'https://bitbin.it/'+path+'/';
  }

  if(pid==='pastelink'){
    // Pastelink.net ‚Äî POST form to create anonymous paste
    const content=generateMarkdown(kw,S.links,idx,S.keywords,'anon','pastelink.net');
    const r=await fetch('https://pastelink.net/api/paste',{method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify({content,title:kw+' Guide '+year()})});
    const d=await r.json();
    const pasteId=d.paste_key||d.id||d.link;
    if(!pasteId) throw new Error('Pastelink: '+JSON.stringify(d).slice(0,100));
    return 'https://pastelink.net/'+pasteId;
  }

  if(pid==='ideone'){
    // Ideone ‚Äî POST via JSON API (public, language=text)
    const content=generateMarkdown(kw,S.links,idx,S.keywords,'anon','ideone.com');
    const r=await fetch('https://ideone.com/api/1/service/ideone/createSubmission',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({user:'guest',pass:'guest',sourceCode:content,language:43,input:'',run:false,private:false,stdRecv:false})});
    const d=await r.json();
    const link=d.result&&d.result.link;
    if(!link) throw new Error('Ideone: '+JSON.stringify(d).slice(0,100));
    return 'https://ideone.com/'+link;
  }

  if(pid==='controlc'){
    // ControlC ‚Äî POST form data
    const content=generateMarkdown(kw,S.links,idx,S.keywords,'anon','controlc.com');
    const r=await fetch('https://controlc.com/index.php',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({paste_data:content,paste_title:kw+' Guide '+year(),expire:'0',submit:'Submit'}).toString()});
    // ControlC redirects to the paste URL
    if(r.url&&r.url!=='https://controlc.com/index.php') return r.url;
    const text=await r.text();
    const m=text.match(/controlc\.com\/([a-f0-9]+)/i);
    if(m) return 'https://controlc.com/'+m[1];
    throw new Error('ControlC: could not extract paste URL');
  }

  if(pid==='rentry'){
    // Rentry.co ‚Äî POST with csrftoken + text + optional edit code
    const content=generateMarkdown(kw,S.links,idx,S.keywords,'anon','rentry.co');
    const editCode=extraVal||Math.random().toString(36).slice(2,10);
    // First get CSRF token
    const csrf_r=await fetch('https://rentry.co/',{credentials:'include'});
    const csrf_text=await csrf_r.text();
    const csrf_m=csrf_text.match(/csrfmiddlewaretoken.*?value="([^"]+)"/);
    const csrf=csrf_m&&csrf_m[1]||'';
    const cookies=csrf_r.headers.get('set-cookie')||'';
    const csrfCookie=cookies.match(/csrftoken=([^;]+)/);
    const r=await fetch('https://rentry.co/api/new',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','Referer':'https://rentry.co/','X-CSRFToken':csrf,'Cookie':csrfCookie?'csrftoken='+csrfCookie[1]:''},
      body:new URLSearchParams({csrfmiddlewaretoken:csrf,text:content,edit_code:editCode}).toString()});
    const d=await r.json();
    if(d.status!=='200'&&d.status!==200) throw new Error('Rentry: '+JSON.stringify(d).slice(0,120));
    return d.url||'https://rentry.co/'+d.url_slug;
  }

  // ‚îÄ‚îÄ FORM-LOGIN PLATFORMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  if(pid==='techplanet'){
    // TechPlanet.today ‚Äî login then POST article via form
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('TechPlanet: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'techplanet.today');
    // Login
    const loginR=await fetch('https://techplanet.today/api/login',{method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify({email:account.login,password})});
    const loginD=await loginR.json();
    const token2=loginD.token||loginD.access_token||loginD.data&&loginD.data.token;
    if(!token2) throw new Error('TechPlanet login failed: '+(loginD.message||'invalid credentials'));
    // Post
    const postR=await fetch('https://techplanet.today/api/posts',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token2,'Accept':'application/json'},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),body:content,status:'published',type:'post'})});
    const postD=await postR.json();
    const postSlug=postD.slug||postD.data&&postD.data.slug;
    return postSlug?'https://techplanet.today/post/'+postSlug:'https://techplanet.today';
  }

  if(pid==='click4r'){
    // Click4R ‚Äî login then create post
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('Click4R: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'click4r.com');
    const loginR=await fetch('https://www.click4r.com/api/auth/login',{method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token||loginD.data&&loginD.data.token;
    if(!tok) throw new Error('Click4R login failed: '+(loginD.message||'check credentials'));
    const postR=await fetch('https://www.click4r.com/api/posts',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),content,status:'published'})});
    const postD=await postR.json();
    const pid2=postD.id||postD.data&&postD.data.id;
    return pid2?'https://www.click4r.com/posts/g/'+pid2+'/':'https://www.click4r.com';
  }

  if(pid==='writeonwall'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('WriteOnWall: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'writeonwall.com');
    const loginR=await fetch('https://writeonwall.com/api/login',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token;
    if(!tok) throw new Error('WriteOnWall login failed');
    const postR=await fetch('https://writeonwall.com/api/questions',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),body:content,type:'question'})});
    const postD=await postR.json();
    const qSlug=postD.slug||postD.id;
    return qSlug?'https://writeonwall.com/question/'+qSlug+'/':'https://writeonwall.com';
  }

  if(pid==='snaplant'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('Snaplant: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'snaplant.com');
    const loginR=await fetch('http://snaplant.com/api/auth/login',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token;
    if(!tok) throw new Error('Snaplant login failed');
    const postR=await fetch('http://snaplant.com/api/questions',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),body:content})});
    const postD=await postR.json();
    const qSlug=postD.slug||postD.id;
    return qSlug?'http://snaplant.com/question/'+qSlug+'/':'http://snaplant.com';
  }

  if(pid==='theprose'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('TheProse: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'theprose.com');
    const loginR=await fetch('https://www.theprose.com/api/v1/session',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.session_token||loginD.access_token;
    if(!tok) throw new Error('TheProse login failed');
    const postR=await fetch('https://www.theprose.com/api/v1/posts',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),body:content,publish:true})});
    const postD=await postR.json();
    const postId=postD.id||postD.post&&postD.post.id;
    return postId?'https://www.theprose.com/post/'+postId+'/':'https://www.theprose.com';
  }

  if(pid==='onfeetnation'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('OnFeetNation: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'onfeetnation.com');
    // Login via Ning-style form
    const loginR=await fetch('https://www.onfeetnation.com/api/v1/session',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token||loginD.sessionToken;
    if(!tok) throw new Error('OnFeetNation login failed ‚Äî check username/password');
    const postR=await fetch('https://www.onfeetnation.com/api/v1/albums',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),description:content.slice(0,1000),privacy:'public'})});
    const postD=await postR.json();
    const albumId=postD.id||postD.album&&postD.album.id;
    return albumId?'https://www.onfeetnation.com/photo/albums/'+albumId:'https://www.onfeetnation.com';
  }

  if(pid==='caribbeanfever'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('CaribbeanFever: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'caribbeanfever.com');
    const loginR=await fetch('https://caribbeanfever.com/api/v1/session',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token||loginD.sessionToken;
    if(!tok) throw new Error('CaribbeanFever login failed ‚Äî check username/password');
    const postR=await fetch('https://caribbeanfever.com/api/v1/albums',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),description:content.slice(0,1000),privacy:'public'})});
    const postD=await postR.json();
    const albumId=postD.id||postD.album&&postD.album.id;
    return albumId?'https://caribbeanfever.com/photo/albums/'+albumId:'https://caribbeanfever.com';
  }

  if(pid==='taylorhicks'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('TaylorHicks Ning: password required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'taylorhicks.ning.com');
    // Ning REST API
    const loginR=await fetch('https://external.ningapis.com/xn/rest/taylorhicks/1.0/Token',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({email:account.login,password,apiKey:account.token}).toString()});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.oauthToken;
    if(!tok) throw new Error('TaylorHicks Ning login failed');
    const postR=await fetch('https://external.ningapis.com/xn/rest/taylorhicks/1.0/BlogPost',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),description:content,visibility:'public'})});
    const postD=await postR.json();
    const postId=postD.id||postD.blogPost&&postD.blogPost.id;
    return postId?'https://taylorhicks.ning.com/forum/topics/'+postId:'https://taylorhicks.ning.com';
  }

  if(pid==='vingle'){
    const interestId=extraVal||account.extra||'';
    if(!interestId) throw new Error('Vingle: Interest ID required');
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'vingle.net');
    const postR=await fetch('https://www.vingle.net/api/cards',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+account.token},
      body:JSON.stringify({title:kw+': Complete Guide '+year(),body:content,interest_id:interestId,visibility:'public'})});
    const postD=await postR.json();
    const cardId=postD.id||postD.card&&postD.card.id;
    return cardId?'https://www.vingle.net/posts/'+cardId:'https://www.vingle.net';
  }

  if(pid==='deviantart'){
    // DeviantArt: publish journal via OAuth2 token
    const content=generateMarkdown(kw,S.links,idx,S.keywords,account.login,'deviantart.com');
    const r=await fetch('https://www.deviantart.com/api/v1/oauth2/stash/publish',{method:'POST',
      headers:{'Authorization':'Bearer '+account.token,'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        title:kw+': Complete Guide '+year(),
        artist_comments:content.slice(0,10000),
        is_mature:'false',
        agree_submission:'true',
        catpath:'journal',
        'license.creative_commons':'0'
      }).toString()});
    const d=await r.json();
    if(d.error) throw new Error('DeviantArt: '+d.error_description||d.error);
    const deviationId=d.deviationid||d.url;
    return d.url||'https://www.deviantart.com/'+account.login+'/journal/';
  }

  throw new Error('No handler for platform: '+pid);
}

// ‚îÄ‚îÄ‚îÄ INDEXING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderIndexing(el){
  const successUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  el.innerHTML=`
  <div class="page-title">üì° Search Indexing</div>
  <div class="page-sub">// submit all campaign URLs to search engines</div>
  <div class="grid4" style="margin-bottom:18px">
    ${statBox(successUrls.length,'URLs to Submit','g')}
    ${statBox(S.campaigns.filter(c=>c.status==='success').length,'Total Live','b')}
    ${statBox([...new Set(S.campaigns.map(c=>c.platform))].length,'Platforms','p')}
    ${statBox([...new Set(successUrls.map(c=>c.keyword))].length,'Keywords','y')}
  </div>
  <div class="card">
    <div class="card-title">IndexNow (Bing, Yandex, Seznam)</div>
    <div class="fg"><label class="lbl">IndexNow API Key</label><input type="text" id="idx-key" placeholder="your-indexnow-api-key"/></div>
    <div class="flex aic g8">
      <button class="btn btn-primary" id="idx-btn" onclick="runIndexNow()">‚ñ∂ Submit ${successUrls.length} URLs</button>
      <button class="btn btn-yellow" onclick="pingGoogle()">üìç Ping Google Sitemap</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title flex aic g8">Terminal<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="document.getElementById('idx-term').innerHTML='<span class=tm>// Cleared</span>'">Clear</button></div>
    <div class="terminal" id="idx-term"><span class="tm">// Indexing output will appear here...</span></div>
  </div>`;
}
async function runIndexNow(){
  const key=(document.getElementById('idx-key')||{value:''}).value.trim();
  if(!key){ alert('IndexNow API key required'); return; }
  const btn=document.getElementById('idx-btn');
  const termEl=document.getElementById('idx-term');
  const term=makeTerminal(termEl);
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Submitting...';
  const urls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  let ok=0;
  for(const c of urls){
    try{
      const urlObj=new URL(c.url); const host=urlObj.hostname;
      const r=await fetch('https://api.indexnow.org/indexnow',{method:'POST',headers:{'Content-Type':'application/json; charset=utf-8'},
        body:JSON.stringify({host,key,keyLocation:'https://'+host+'/'+key+'.txt',urlList:[c.url]})});
      const isOk=r.status===200||r.status===202;
      term.add((isOk?'‚úì ':'‚úó ')+c.url+' ‚Üí '+r.status,isOk?'info':'error');
      if(isOk) ok++;
    }catch(e){ term.add('‚úó '+c.url+' ‚Üí '+e.message,'error'); }
    await sleep(400);
  }
  term.add('IndexNow complete: '+ok+'/'+urls.length+' submitted','info');
  btn.disabled=false; btn.textContent='‚ñ∂ Submit '+urls.length+' URLs';
}
async function pingGoogle(){
  const termEl=document.getElementById('idx-term');
  const term=makeTerminal(termEl);
  const urls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  for(const c of urls){
    try{ await fetch('https://www.google.com/ping?sitemap='+encodeURIComponent(c.url),{method:'GET',mode:'no-cors'}); term.add('‚úì Pinged: '+c.url,'info'); }
    catch(e){ term.add('‚úó '+c.url+': '+e.message,'error'); }
    await sleep(300);
  }
  term.add('Google ping complete','info');
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _exportFormat='urls';
let _exportFilter='all';
function renderExport(el){
  const succeeded=_exportFilter==='all'?S.campaigns.filter(c=>c.status==='success'):S.campaigns.filter(c=>c.status==='success'&&c.platform===_exportFilter);
  const filtered=_exportFilter==='all'?S.campaigns:S.campaigns.filter(c=>c.platform===_exportFilter);
  const content=getExportContent(filtered,succeeded);
  el.innerHTML=`
  <div class="page-title">üì§ Export Center</div>
  <div class="page-sub">// export results from all platforms</div>
  <div class="grid4" style="margin-bottom:18px">
    ${statBox(S.campaigns.length,'Total','g')}
    ${statBox(S.campaigns.filter(c=>c.status==='success').length,'Succeeded','b')}
    ${statBox(S.campaigns.filter(c=>c.status==='error').length,'Failed','r')}
    ${statBox([...new Set(S.campaigns.map(c=>c.platform))].length,'Platforms','y')}
  </div>
  <div class="card">
    <div class="card-title">Filter by Platform</div>
    <div class="mtabs" style="width:100%;flex-wrap:wrap">
      <div class="mtab ${_exportFilter==='all'?'on':''}" onclick="setExportFilter('all')">All (${S.campaigns.length})</div>
      ${PLATFORMS.filter(p=>S.campaigns.some(c=>c.platform===p.id)).map(p=>`<div class="mtab ${_exportFilter===p.id?'on':''}" onclick="setExportFilter('${p.id}')">${p.icon} ${esc(p.name)} (${S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length})</div>`).join('')}
    </div>
  </div>
  ${succeeded.length?`<div class="card"><div class="card-title">üöÄ Live URLs</div>${succeeded.slice(0,20).map(c=>urlBannerHTML(c.url,c.keyword,c.platform)).join('')}${succeeded.length>20?`<p class="tm mono xs mt8">...and ${succeeded.length-20} more. Export to see all.</p>`:''}</div>`:''}
  <div class="card">
    <div class="card-title">Export Format</div>
    <div class="mtabs">
      ${['urls','csv','json','markdown'].map(f=>`<div class="mtab ${_exportFormat===f?'on':''}" onclick="setExportFormat('${f}')">${{urls:'Plain URLs',csv:'CSV',json:'JSON',markdown:'Markdown'}[f]}</div>`).join('')}
    </div>
    <div class="flex aic g8" style="margin-bottom:10px">
      <button class="btn btn-ghost btn-sm" id="export-copy-btn" onclick="exportCopy(this)">COPY</button>
      <button class="btn btn-primary btn-sm" onclick="downloadExport()">‚¨á Download</button>
    </div>
    <textarea readonly id="export-ta" rows="12" style="background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.7;border:1px solid var(--border);border-radius:6px;font-weight:600">${esc(content)}</textarea>
  </div>`;
}
function getExportContent(filtered,succeeded){
  if(_exportFormat==='urls') return (succeeded||S.campaigns.filter(c=>c.status==='success')).map(c=>c.url).join('\n');
  if(_exportFormat==='csv'){ const h='platform,keyword,repo,url,status,timestamp'; const rows=(filtered||S.campaigns).map(c=>'"'+c.platform+'","'+c.keyword+'","'+(c.repo||'')+'","'+(c.url||'')+'","'+c.status+'","'+c.ts+'"'); return [h,...rows].join('\n'); }
  if(_exportFormat==='json') return JSON.stringify(filtered||S.campaigns,null,2);
  if(_exportFormat==='markdown'){
    return '# Campaign Results\n\n| Platform | Keyword | URL | Status |\n|----------|---------|-----|--------|\n'+(filtered||S.campaigns).map(c=>'| '+c.platform+' | '+c.keyword+' | ['+(c.url||'‚Äî')+']('+c.url+') | '+c.status+' |').join('\n');
  }
  return '';
}
function getExportAll(){ const succ=_exportFilter==='all'?S.campaigns.filter(c=>c.status==='success'):S.campaigns.filter(c=>c.status==='success'&&c.platform===_exportFilter); const filt=_exportFilter==='all'?S.campaigns:S.campaigns.filter(c=>c.platform===_exportFilter); return getExportContent(filt,succ); }
function setExportFormat(f){ _exportFormat=f; renderExport(document.getElementById('page-export')); }
function setExportFilter(f){ _exportFilter=f; renderExport(document.getElementById('page-export')); }
function downloadExport(){
  const ext={urls:'txt',csv:'csv',json:'json',markdown:'md'}[_exportFormat]||'txt';
  const blob=new Blob([getExportAll()],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='seo-export-'+_exportFilter+'.'+ext; a.click();
}

// ‚îÄ‚îÄ‚îÄ GLOBAL BLAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _blastSelectedPlatforms=[];
let _blastRunning=false;
function renderGlobalBlast(el){
  const connected=PLATFORMS.filter(p=>S.accounts.some(a=>a.platform===p.id));
  if(!_blastSelectedPlatforms.length) _blastSelectedPlatforms=connected.map(p=>p.id);
  const successCount=S.campaigns.filter(c=>c.status==='success').length;
  el.innerHTML=`
  <div class="page-title" style="color:var(--accent)">üåç Global Blast</div>
  <div class="page-sub">// post to ALL connected platforms simultaneously ‚Äî one form, maximum reach</div>
  <div class="notice notice-success">Global Blast publishes all your keywords across every connected platform in a single run. Connect accounts in Setup first.</div>
  <div class="grid5" style="margin-bottom:18px">
    ${statBox(connected.length,'Connected','g')}${statBox(_blastSelectedPlatforms.length,'Selected','b')}
    ${statBox(S.keywords.length,'Keywords','y')}${statBox(successCount,'Succeeded','g')}
    ${statBox(S.campaigns.filter(c=>c.status==='error').length,'Failed','r')}
  </div>
  ${!connected.length?'<div class="notice notice-warn">No platforms connected. Go to Setup / Connect in the sidebar to add accounts first.</div>':''}
  <div class="card">
    <div class="card-title flex aic g8">Platform Selection
      <button class="btn btn-ghost btn-xs" onclick="blastSelectAll()">All</button>
      <button class="btn btn-ghost btn-xs" onclick="blastSelectNone()">None</button>
    </div>
    <div class="grid4" id="blast-plat-grid">
      ${PLATFORMS.map(p=>{
        const isConn=S.accounts.some(a=>a.platform===p.id);
        const isSel=_blastSelectedPlatforms.includes(p.id);
        return `<div onclick="toggleBlastPlatform('${p.id}')" style="padding:10px 12px;border:1px solid ${isSel&&isConn?'var(--accent)':'var(--border)'};background:${isSel&&isConn?'rgba(0,87,255,0.05)':'var(--bg)'};cursor:${isConn?'pointer':'not-allowed'};opacity:${isConn?1:0.4};display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:10px;transition:all 0.12s;border-radius:8px;font-weight:600">
          <span style="font-size:14px">${p.icon}</span>
          <div style="flex:1"><div style="color:${isSel&&isConn?'var(--accent)':'var(--text)'};font-weight:700;font-size:11px">${esc(p.name)}</div><div style="color:var(--muted2);font-size:9px;font-weight:600">DA ${p.da} ${isConn?'¬∑ ‚úì connected':'¬∑ not connected'}</div></div>
          ${isSel&&isConn?'<span style="color:var(--accent)">‚úì</span>':''}
        </div>`;
      }).join('')}
    </div>
  </div>
  <div class="card">
    <div class="card-title">Blast Settings</div>
    <div class="grid3">
      <div class="fg mb0"><label class="lbl">Quick Single Keyword (overrides keyword list)</label>
        <input type="text" id="blast-kw" placeholder="Or leave blank to use ${S.keywords.length} keyword(s) from Keywords page"/></div>
      <div class="fg mb0"><label class="lbl">Prefix (for pages/repos)</label>
        <input type="text" id="blast-prefix" value="seo"/></div>
      <div class="fg mb0"><label class="lbl">Delay Between Posts (sec)</label>
        <input type="number" id="blast-delay" value="4" min="1" max="120"/></div>
    </div>
    <div class="notice notice-info mt8" id="blast-estimate" style="margin-bottom:8px">
      Select platforms and set delay to see estimated time.
    </div>
    <div class="flex aic g8 mt8">
      <button class="btn btn-primary" id="blast-run-btn" onclick="runGlobalBlast()" style="font-size:12px;padding:10px 24px" ${!connected.length?'disabled':''}>
        üåç GLOBAL BLAST ‚Äî ${_blastSelectedPlatforms.length} platform(s) √ó ${S.keywords.length||1} keyword(s)
      </button>
    </div>
    <div id="blast-prog-wrap" style="display:none;margin-top:10px">
      <div class="flex aic g8" style="margin-bottom:4px">
        <span class="mono xs tm" id="blast-prog-label">0/0 posts completed</span>
        <span class="mono xs ta" id="blast-prog-pct">0%</span>
      </div>
      <div class="prog-wrap" style="height:6px"><div class="prog-fill" id="blast-prog"></div></div>
    </div>
  </div>
  <div id="blast-urls"></div>
  <div class="card">
    <div class="card-title flex aic g8">Blast Terminal<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="document.getElementById('blast-term').innerHTML='<span class=tm>// Cleared</span>'">Clear</button></div>
    <div class="terminal" id="blast-term" style="height:300px"><span class="tm">// Global Blast output will appear here. Select platforms, configure settings, and click GLOBAL BLAST.</span></div>
  </div>`;
  updateBlastEstimate();
}
function toggleBlastPlatform(id){
  const isConn=S.accounts.some(a=>a.platform===id); if(!isConn) return;
  if(_blastSelectedPlatforms.includes(id)) _blastSelectedPlatforms=_blastSelectedPlatforms.filter(x=>x!==id);
  else _blastSelectedPlatforms.push(id);
  renderGlobalBlast(document.getElementById('page-global_blast'));
}
function blastSelectAll(){ _blastSelectedPlatforms=PLATFORMS.filter(p=>S.accounts.some(a=>a.platform===p.id)).map(p=>p.id); renderGlobalBlast(document.getElementById('page-global_blast')); }
function blastSelectNone(){ _blastSelectedPlatforms=[]; renderGlobalBlast(document.getElementById('page-global_blast')); }
function updateBlastEstimate(){
  const el=document.getElementById('blast-estimate'); if(!el) return;
  const kws=(document.getElementById('blast-kw')||{value:''}).value.trim()?1:S.keywords.length||1;
  const delay=parseInt((document.getElementById('blast-delay')||{value:4}).value)||4;
  const total=_blastSelectedPlatforms.length*kws;
  const mins=Math.round(total*delay/60);
  el.textContent='Estimated time: ~'+mins+' min for '+_blastSelectedPlatforms.length+' platform(s) √ó '+kws+' keyword(s) at '+delay+'s delay';
}
async function runGlobalBlast(){
  if(_blastRunning) return;
  const kwEl=document.getElementById('blast-kw');
  const prefixEl=document.getElementById('blast-prefix');
  const delayEl=document.getElementById('blast-delay');
  const singleKw=kwEl&&kwEl.value.trim();
  const effectiveKws=singleKw?[singleKw]:(S.keywords.length?S.keywords:null);
  if(!effectiveKws){ alert('Add keywords in the Keywords page first, or enter a single keyword above.'); return; }
  if(!_blastSelectedPlatforms.length){ alert('Select at least one platform.'); return; }
  _blastRunning=true;
  const prefix=(prefixEl&&prefixEl.value.trim())||'seo';
  const delay=parseInt((delayEl&&delayEl.value)||4)||4;
  const btn=document.getElementById('blast-run-btn');
  const termEl=document.getElementById('blast-term');
  const progWrap=document.getElementById('blast-prog-wrap');
  const progBar=document.getElementById('blast-prog');
  const progLabel=document.getElementById('blast-prog-label');
  const progPct=document.getElementById('blast-prog-pct');
  const urlsEl=document.getElementById('blast-urls');
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Blasting...';
  progWrap.style.display='block';
  termEl.innerHTML='';
  urlsEl.innerHTML='';
  const term=makeTerminal(termEl);
  const liveUrls=[];
  const total=_blastSelectedPlatforms.length*effectiveKws.length;
  let done=0;

  for(let ki=0;ki<effectiveKws.length;ki++){
    const kw=effectiveKws[ki];
    term.add('‚ïê‚ïê Keyword ['+(ki+1)+'/'+effectiveKws.length+']: "'+kw+'" ‚ïê‚ïê','info');
    for(const pid of _blastSelectedPlatforms){
      const p=getPlatform(pid);
      const account=S.accounts.find(a=>a.platform===pid);
      if(!account){ term.add('  ‚ö† '+p.name+': No account connected, skipping','warn'); done++; continue; }
      term.add('  ‚Üí '+p.icon+' '+p.name+'...','info');
      try{
        // For global blast, use account.extra as the per-platform extra value
        const blastExtra=account.extra||prefix;
        const url=await runSingleCampaign(pid,kw,account,blastExtra,ki,{add:(m,t)=>term.add('    '+m,t)});
        term.add('  ‚úì '+p.name+': '+url,'info');
        liveUrls.push({url,keyword:kw,platform:pid});
        const result={id:uid(),platform:pid,keyword:kw,repo:slug(prefix+'-'+kw),url,status:'success',ts:ts()};
        S.campaigns=S.campaigns.filter(c=>!(c.platform===pid&&c.keyword===kw));
        S.campaigns.push(result);
        urlsEl.innerHTML='<div class="card slide-in"><div class="card-title">üöÄ Live URLs ‚Äî '+liveUrls.length+' total</div>'+liveUrls.slice(-10).map(u=>urlBannerHTML(u.url,u.keyword,u.platform)).join('')+'</div>';
      }catch(e){
        term.add('  ‚úó '+p.name+': '+e.message,'error');
        S.campaigns.push({id:uid(),platform:pid,keyword:kw,repo:slug(prefix+'-'+kw),url:'',status:'error',ts:ts(),error:e.message});
      }
      done++;
      const pct=Math.round(done/total*100);
      setProgress(progBar,pct);
      progLabel.textContent=done+'/'+total+' posts completed';
      progPct.textContent=pct+'%';
      if(done<total) await sleep(delay*1000);
    }
  }
  setProgress(progBar,100);
  term.add('üåç GLOBAL BLAST COMPLETE! '+liveUrls.length+'/'+total+' succeeded across '+_blastSelectedPlatforms.length+' platforms','info');
  btn.disabled=false; btn.innerHTML='üåç GLOBAL BLAST ‚Äî Re-run';
  _blastRunning=false;
  updateHeader(); updatePlatformBar();
}

// ‚îÄ‚îÄ‚îÄ CONTENT STUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _studioArticles=[];
let _studioActiveIdx=0;
let _studioFormat='markdown';

// Manual Content Library ‚Äî persisted in localStorage
let _contentLibrary = JSON.parse(localStorage.getItem('cs_library')||'[]');
let _csActiveEditor = null; // id of item being edited, null = new
let _csEditorFormat = 'markdown'; // markdown | html
let _csPreviewMode = false;

function csSaveLibrary(){ try{ localStorage.setItem('cs_library',JSON.stringify(_contentLibrary)); }catch(e){} }
function csGenId(){ return 'cs_'+Date.now()+'_'+Math.random().toString(36).slice(2,7); }

function renderContentStudio(el){
  el.innerHTML=`
  <div class="page-title">‚úç Content Studio</div>
  <div class="page-sub">// generate ¬∑ manually add HTML/Markdown ¬∑ save to library ¬∑ pass to any function</div>

  <!-- MAIN TABS -->
  <div class="mtabs" style="margin-bottom:18px">
    <div class="mtab on" id="cs-tab-generate" onclick="csTab('generate')">‚ö° Auto Generate</div>
    <div class="mtab" id="cs-tab-manual" onclick="csTab('manual')">‚úè Manual Editor</div>
    <div class="mtab" id="cs-tab-library" onclick="csTab('library')">üìö Content Library <span style="background:rgba(0,87,255,0.12);color:var(--accent);border:1px solid rgba(0,87,255,0.2);border-radius:3px;padding:1px 6px;font-size:9px;margin-left:4px" id="cs-lib-count">${_contentLibrary.length}</span></div>
  </div>

  <!-- TAB: AUTO GENERATE -->
  <div id="cs-tab-generate-panel">
    <div class="card">
      <div class="card-title">Content Generator</div>
      <div class="grid3">
        <div class="fg mb0"><label class="lbl">Keyword (from list)</label>
          <select id="studio-kw-sel"><option value="">‚Äî select ‚Äî</option>${S.keywords.map(k=>`<option value="${esc(k)}">${esc(k)}</option>`).join('')}</select></div>
        <div class="fg mb0"><label class="lbl">Custom Keyword (overrides)</label>
          <input type="text" id="studio-kw-custom" placeholder="type any keyword..."/></div>
        <div class="fg mb0"><label class="lbl">Spin Variations (1-5)</label>
          <input type="number" id="studio-count" value="3" min="1" max="5"/></div>
      </div>
      <button class="btn btn-primary mt8" onclick="generateStudioContent()">‚ö° Generate Variations</button>
    </div>
    <div id="studio-output"></div>
    <div class="card">
      <div class="card-title">SEO Content Checklist</div>
      <div class="grid2" style="font-family:var(--mono);font-size:10px">
        ${[['‚úì','Keyword in H1 title','ta'],['‚úì','Links injected from Link Manager','ta'],['‚úì','FAQ section for featured snippets','ta'],['‚úì','Last updated date included','ta'],['!','Add images to boost on-page time','ty'],['!','Internal linking between pages','ty']].map(([icon,text,cls])=>`<div style="padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-weight:600"><span class="${cls}">${icon}</span> ${esc(text)}</div>`).join('')}
      </div>
    </div>
  </div>

  <!-- TAB: MANUAL EDITOR -->
  <div id="cs-tab-manual-panel" style="display:none">
    ${csRenderEditor()}
  </div>

  <!-- TAB: LIBRARY -->
  <div id="cs-tab-library-panel" style="display:none">
    ${csRenderLibrary()}
  </div>`;
}

function csTab(tab){
  ['generate','manual','library'].forEach(t=>{
    const panel=document.getElementById('cs-tab-'+t+'-panel');
    const tabEl=document.getElementById('cs-tab-'+t);
    if(panel) panel.style.display = t===tab ? '' : 'none';
    if(tabEl){ tabEl.classList.toggle('on', t===tab); }
  });
  if(tab==='library') csRefreshLibrary();
}

// ‚îÄ‚îÄ MANUAL EDITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function csRenderEditor(editId){
  const item = editId ? _contentLibrary.find(c=>c.id===editId) : null;
  const title = item ? item.title : '';
  const content = item ? item.content : '';
  const format = item ? item.format : _csEditorFormat;
  const keyword = item ? (item.keyword||'') : '';
  const tags = item ? (item.tags||'') : '';

  return `
  <div class="card" id="cs-editor-card">
    <div class="card-title flex aic g8">
      ${editId ? '‚úè Edit Content' : '‚úè New Content'}
      ${editId ? `<span class="badge badge-y">Editing: ${esc(item&&item.title||'Untitled')}</span>` : ''}
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('h1')">H1</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('h2')">H2</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('bold')"><b>B</b></button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('link')">üîó</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('list')">‚â°</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('divider')">‚Äî</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('img')">üñº</button>
      </div>
    </div>

    <!-- Meta row -->
    <div class="grid3" style="margin-bottom:12px">
      <div class="fg mb0">
        <label class="lbl">Title / Label</label>
        <input type="text" id="cs-ed-title" placeholder="e.g. My SEO Article ‚Äî Creatine Guide" value="${esc(title)}"/>
      </div>
      <div class="fg mb0">
        <label class="lbl">Keyword Tag</label>
        <input type="text" id="cs-ed-keyword" placeholder="e.g. creatine supplements" value="${esc(keyword)}"/>
      </div>
      <div class="fg mb0">
        <label class="lbl">Tags (comma separated)</label>
        <input type="text" id="cs-ed-tags" placeholder="seo, health, review" value="${esc(tags)}"/>
      </div>
    </div>

    <!-- Format selector + actions -->
    <div class="flex aic g8" style="margin-bottom:8px;flex-wrap:wrap">
      <div class="mtabs" style="margin-bottom:0">
        <div class="mtab ${format==='markdown'?'on':''}" id="cs-fmt-md" onclick="csSetEditorFormat('markdown')">Markdown</div>
        <div class="mtab ${format==='html'?'on':''}" id="cs-fmt-html" onclick="csSetEditorFormat('html')">HTML</div>
        <div class="mtab ${format==='text'?'on':''}" id="cs-fmt-txt" onclick="csSetEditorFormat('text')">Plain Text</div>
      </div>
      <div class="mtabs" style="margin-bottom:0">
        <div class="mtab" id="cs-view-edit" onclick="csTogglePreview(false)">‚úè Edit</div>
        <div class="mtab" id="cs-view-prev" onclick="csTogglePreview(true)">üëÅ Preview</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="csEditorWordCount()">üìä Word Count</button>
      <button class="btn btn-ghost btn-sm" onclick="csEditorClear()">üóë Clear</button>
      <button class="btn btn-ghost btn-sm" onclick="csEditorFromClipboard()">üìã Paste from Clipboard</button>
      <span id="cs-wc-display" style="font-family:var(--mono);font-size:10px;color:var(--muted2)"></span>
    </div>

    <!-- EDITOR AREA -->
    <div id="cs-editor-wrap" style="position:relative">
      <textarea
        id="cs-editor-ta"
        spellcheck="true"
        rows="22"
        placeholder="${format==='html' ? 'Paste or type your HTML here...\n\n<h1>Your Title</h1>\n<p>Your content...</p>' : format==='markdown' ? 'Paste or type Markdown here...\n\n# Your Title\n\n## Section\n\nYour paragraph...' : 'Paste or type plain text here...'}"
        style="width:100%;background:#0d1117;color:#e6edf3;font-family:var(--mono);font-size:12px;line-height:1.8;border:1px solid #30363d;border-radius:8px;padding:16px;resize:vertical;min-height:400px;tab-size:2"
        oninput="csEditorOnInput()"
      >${esc(content)}</textarea>
      <div id="cs-preview-wrap" style="display:none;border:1px solid var(--border);border-radius:8px;min-height:400px;background:#fff;overflow:hidden">
        <iframe id="cs-preview-frame" style="width:100%;height:500px;border:none" title="preview"></iframe>
      </div>
    </div>

    <!-- Character / word count bar -->
    <div style="display:flex;gap:16px;margin-top:6px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:var(--mono);font-size:10px;color:var(--muted2)">
      <span id="cs-char-count">0 chars</span>
      <span id="cs-word-count">0 words</span>
      <span id="cs-line-count">0 lines</span>
      <span id="cs-format-indicator" style="margin-left:auto;color:var(--accent);font-weight:700">${format.toUpperCase()}</span>
    </div>

    <!-- SAVE + ACTION BUTTONS -->
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn btn-primary" onclick="csSaveToLibrary('${editId||''}')">
        üíæ ${editId ? 'Update in Library' : 'Save to Library'}
      </button>
      <button class="btn btn-ghost" onclick="csEditorDownload()">‚¨á Download File</button>
      <button class="btn btn-ghost" onclick="csEditorCopyContent()">üìã Copy Content</button>
      <div style="width:1px;height:24px;background:var(--border);margin:0 4px"></div>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Send to:</span>
      <button class="btn btn-yellow btn-sm" onclick="csSendToGlobalBlast()">üåç Global Blast</button>
      <button class="btn btn-blue btn-sm" onclick="csSendToBlogCommenter()">üí¨ Blog Commenter</button>
      <button class="btn btn-ghost btn-sm" onclick="csSendToCampaign()">‚ñ∂ Campaign</button>
      ${editId ? `<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="csEditorNew()">+ New Content</button>` : ''}
    </div>

    <!-- SEND SUCCESS TOAST -->
    <div id="cs-send-toast" style="display:none;margin-top:8px;padding:8px 14px;background:rgba(0,87,255,0.07);border:1px solid rgba(0,87,255,0.2);border-radius:6px;font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:700"></div>
  </div>`;
}

function csSetEditorFormat(fmt){
  _csEditorFormat = fmt;
  ['md','html','txt'].forEach(f=>{
    const el=document.getElementById('cs-fmt-'+f);
    if(el) el.classList.remove('on');
  });
  const map={markdown:'md',html:'html',text:'txt'};
  const tabEl=document.getElementById('cs-fmt-'+map[fmt]);
  if(tabEl) tabEl.classList.add('on');
  const fi=document.getElementById('cs-format-indicator');
  if(fi) fi.textContent=fmt.toUpperCase();
  const ta=document.getElementById('cs-editor-ta');
  if(ta){
    const ph={markdown:'Paste or type Markdown...\n\n# Your Title\n\n## Section\n\nYour paragraph...',html:'Paste or type HTML...\n\n<h1>Your Title</h1>\n<p>Content here...</p>',text:'Paste or type plain text...'};
    ta.placeholder=ph[fmt]||'';
  }
}

function csTogglePreview(show){
  const ta=document.getElementById('cs-editor-ta');
  const pw=document.getElementById('cs-preview-wrap');
  const editTab=document.getElementById('cs-view-edit');
  const prevTab=document.getElementById('cs-view-prev');
  if(!ta||!pw) return;
  _csPreviewMode=show;
  ta.style.display=show?'none':'';
  pw.style.display=show?'':'none';
  if(editTab) editTab.classList.toggle('on',!show);
  if(prevTab) prevTab.classList.toggle('on',show);
  if(show){
    const content=ta.value;
    const frame=document.getElementById('cs-preview-frame');
    if(frame){
      const html = _csEditorFormat==='html' ? content : _csEditorFormat==='markdown' ? mdToHtml(content) : `<html><body style="font-family:system-ui;padding:20px;white-space:pre-wrap;line-height:1.7">${esc(content)}</body></html>`;
      frame.srcdoc=html;
    }
  }
}

function csEditorOnInput(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  const val=ta.value;
  const chars=document.getElementById('cs-char-count');
  const words=document.getElementById('cs-word-count');
  const lines=document.getElementById('cs-line-count');
  if(chars) chars.textContent=val.length.toLocaleString()+' chars';
  if(words) words.textContent=(val.trim()?val.trim().split(/\s+/).length:0).toLocaleString()+' words';
  if(lines) lines.textContent=val.split('\n').length+' lines';
}

function csEditorWordCount(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  const words=ta.value.trim()?ta.value.trim().split(/\s+/).length:0;
  const chars=ta.value.length;
  const readTime=Math.ceil(words/200);
  alert(`üìä Word Count Stats\n\nWords: ${words.toLocaleString()}\nCharacters: ${chars.toLocaleString()}\nLines: ${ta.value.split('\n').length}\nEstimated read time: ~${readTime} min`);
}

function csEditorClear(){
  if(!confirm('Clear the editor? This cannot be undone.')) return;
  const ta=document.getElementById('cs-editor-ta');
  if(ta){ ta.value=''; csEditorOnInput(); }
  const titleEl=document.getElementById('cs-ed-title');
  const kwEl=document.getElementById('cs-ed-keyword');
  const tagsEl=document.getElementById('cs-ed-tags');
  if(titleEl) titleEl.value='';
  if(kwEl) kwEl.value='';
  if(tagsEl) tagsEl.value='';
  _csActiveEditor=null;
}

function csEditorNew(){
  _csActiveEditor=null;
  const wrap=document.getElementById('cs-tab-manual-panel');
  if(wrap) wrap.innerHTML=csRenderEditor();
}

async function csEditorFromClipboard(){
  try{
    const text=await navigator.clipboard.readText();
    const ta=document.getElementById('cs-editor-ta');
    if(ta){ ta.value=text; csEditorOnInput(); }
  } catch(e){
    alert('Clipboard access denied. Please paste manually (Ctrl+V) into the editor.');
  }
}

function csEditorInsertSnippet(type){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  const isMd=_csEditorFormat==='markdown';
  const isHtml=_csEditorFormat==='html';
  const snippets={
    h1:   isMd?'# Your H1 Title\n'        :'<h1>Your H1 Title</h1>\n',
    h2:   isMd?'\n## Section Heading\n'    :'<h2>Section Heading</h2>\n',
    bold: isMd?'**bold text**'             :'<strong>bold text</strong>',
    link: isMd?'[Link Text](https://example.com)':'<a href="https://example.com">Link Text</a>',
    list: isMd?'\n- Item one\n- Item two\n- Item three\n':'<ul>\n  <li>Item one</li>\n  <li>Item two</li>\n</ul>\n',
    divider: isMd?'\n---\n':'\n<hr/>\n',
    img:  isMd?'![Alt text](https://example.com/image.jpg)':'<img src="https://example.com/image.jpg" alt="Description" style="width:100%"/>',
  };
  const snippet=snippets[type]||'';
  const start=ta.selectionStart;
  const end=ta.selectionEnd;
  ta.value=ta.value.slice(0,start)+snippet+ta.value.slice(end);
  ta.selectionStart=ta.selectionEnd=start+snippet.length;
  ta.focus();
  csEditorOnInput();
}

function csSaveToLibrary(editId){
  const titleEl=document.getElementById('cs-ed-title');
  const taEl=document.getElementById('cs-editor-ta');
  const kwEl=document.getElementById('cs-ed-keyword');
  const tagsEl=document.getElementById('cs-ed-tags');
  const title=(titleEl&&titleEl.value.trim())||'Untitled Content';
  const content=(taEl&&taEl.value)||'';
  const keyword=(kwEl&&kwEl.value.trim())||'';
  const tags=(tagsEl&&tagsEl.value.trim())||'';
  if(!content.trim()){ alert('Add some content before saving.'); return; }

  if(editId){
    const idx=_contentLibrary.findIndex(c=>c.id===editId);
    if(idx>-1){
      _contentLibrary[idx]={..._contentLibrary[idx],title,content,format:_csEditorFormat,keyword,tags,updated:ts()};
    }
  } else {
    _contentLibrary.unshift({id:csGenId(),title,content,format:_csEditorFormat,keyword,tags,created:ts(),updated:ts()});
  }
  csSaveLibrary();
  csUpdateLibCount();

  const toast=document.getElementById('cs-send-toast');
  if(toast){ toast.style.display=''; toast.innerHTML='‚úÖ Saved to Content Library! Switch to üìö Library tab to manage and use it.'; setTimeout(()=>toast.style.display='none',4000); }
}

function csUpdateLibCount(){
  const el=document.getElementById('cs-lib-count');
  if(el) el.textContent=_contentLibrary.length;
}

function csEditorDownload(){
  const ta=document.getElementById('cs-editor-ta');
  const titleEl=document.getElementById('cs-ed-title');
  const content=(ta&&ta.value)||'';
  const title=slug((titleEl&&titleEl.value)||'content');
  const ext={markdown:'md',html:'html',text:'txt'}[_csEditorFormat]||'txt';
  const mime={markdown:'text/markdown',html:'text/html',text:'text/plain'}[_csEditorFormat]||'text/plain';
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=title+'.'+ext;a.click();
}

function csEditorCopyContent(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  navigator.clipboard.writeText(ta.value).then(()=>{
    const toast=document.getElementById('cs-send-toast');
    if(toast){ toast.style.display=''; toast.innerHTML='üìã Content copied to clipboard!'; setTimeout(()=>toast.style.display='none',2500); }
  }).catch(()=>{ ta.select(); document.execCommand('copy'); });
}

function csSendToGlobalBlast(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta||!ta.value.trim()){ alert('Nothing to send ‚Äî write some content first.'); return; }
  // Store in sessionStorage for Global Blast to pick up
  sessionStorage.setItem('cs_blast_content', ta.value);
  sessionStorage.setItem('cs_blast_format', _csEditorFormat);
  const titleEl=document.getElementById('cs-ed-title');
  sessionStorage.setItem('cs_blast_title', (titleEl&&titleEl.value)||'');
  const toast=document.getElementById('cs-send-toast');
  if(toast){ toast.style.display=''; toast.innerHTML='üåç Content sent to Global Blast! Go to Global Blast ‚Üí it\'s loaded and ready to publish.'; setTimeout(()=>toast.style.display='none',5000); }
  // Save to library automatically
  csSaveToLibrary('');
}

function csSendToBlogCommenter(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta||!ta.value.trim()){ alert('Nothing to send.'); return; }
  // Convert content to a short comment excerpt
  const raw=ta.value.replace(/<[^>]+>/g,' ').replace(/[#*_\[\]`]/g,'').replace(/\s+/g,' ').trim();
  const excerpt=raw.slice(0,300)+(raw.length>300?'...':'');
  // Switch to blog commenter page and pre-fill the comment box
  sessionStorage.setItem('cs_comment_content', excerpt);
  renderPage('blog_commenter');
  setTimeout(()=>{
    const commentEl=document.getElementById('bc-gen-out');
    if(commentEl){ commentEl.value=excerpt; }
    const toast=document.getElementById('cs-send-toast');
    if(toast){ toast.style.display=''; toast.innerHTML='üí¨ Content sent to Blog Commenter as comment text!'; setTimeout(()=>toast.style.display='none',4000); }
  },300);
}

function csSendToCampaign(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta||!ta.value.trim()){ alert('Nothing to send.'); return; }
  sessionStorage.setItem('cs_campaign_content', ta.value);
  sessionStorage.setItem('cs_campaign_format', _csEditorFormat);
  const toast=document.getElementById('cs-send-toast');
  if(toast){ toast.style.display=''; toast.innerHTML='‚ñ∂ Content queued for Campaign! Go to Run Campaign ‚Üí it will use this content.'; setTimeout(()=>toast.style.display='none',4000); }
  csSaveToLibrary('');
}

// ‚îÄ‚îÄ CONTENT LIBRARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function csRenderLibrary(){
  if(!_contentLibrary.length) return `
    <div class="card">
      <div class="card-title">üìö Content Library</div>
      <div style="text-align:center;padding:40px 20px">
        <div style="font-size:40px;margin-bottom:10px">üìù</div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--muted2);font-weight:600">No saved content yet</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:6px">Go to ‚úè Manual Editor ‚Üí write or paste content ‚Üí click "Save to Library"</div>
      </div>
    </div>`;

  const fmtBadge={markdown:'badge-b',html:'badge-g',text:'badge-p'};

  return `
  <div class="card">
    <div class="card-title flex aic g8">
      üìö Content Library
      <span class="nav-badge">${_contentLibrary.length} items</span>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="csLibExportAll()">üì§ Export All</button>
        <button class="btn btn-danger btn-sm" onclick="csLibClearAll()">üóë Clear All</button>
      </div>
    </div>

    <!-- Filter bar -->
    <div class="flex aic g8" style="margin-bottom:14px;flex-wrap:wrap">
      <input type="text" id="cs-lib-search" placeholder="Search by title, keyword, tags..." style="flex:1;min-width:200px" oninput="csRefreshLibrary()"/>
      <select id="cs-lib-filter-fmt" onchange="csRefreshLibrary()" style="width:140px">
        <option value="">All Formats</option>
        <option value="markdown">Markdown</option>
        <option value="html">HTML</option>
        <option value="text">Plain Text</option>
      </select>
    </div>

    <div id="cs-lib-items">
      ${csRenderLibraryItems()}
    </div>
  </div>`;
}

function csRenderLibraryItems(){
  const search=(document.getElementById('cs-lib-search')||{value:''}).value.toLowerCase();
  const fmtFilter=(document.getElementById('cs-lib-filter-fmt')||{value:''}).value;
  const fmtBadge={markdown:'badge-b',html:'badge-g',text:'badge-p'};

  let items=_contentLibrary;
  if(search) items=items.filter(c=>(c.title+' '+c.keyword+' '+c.tags).toLowerCase().includes(search));
  if(fmtFilter) items=items.filter(c=>c.format===fmtFilter);

  if(!items.length) return '<div style="padding:20px;text-align:center;font-family:var(--mono);font-size:11px;color:var(--muted2)">No results match your search.</div>';

  return items.map(c=>`
    <div style="border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;background:var(--bg);transition:border-color 0.1s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
      <div class="flex aic g8" style="margin-bottom:8px">
        <div style="font-size:14px">${{markdown:'üìù',html:'üåê',text:'üìÑ'}[c.format]||'üìÑ'}</div>
        <div style="flex:1;font-family:var(--sans);font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.title||'Untitled')}</div>
        <span class="badge ${fmtBadge[c.format]||'badge-b'}">${(c.format||'text').toUpperCase()}</span>
        ${c.keyword?`<span class="badge badge-y">${esc(c.keyword)}</span>`:''}
      </div>
      ${c.tags?`<div style="margin-bottom:6px">${c.tags.split(',').map(t=>`<span style="display:inline-block;margin-right:4px;margin-bottom:4px;padding:2px 8px;background:var(--surface);border:1px solid var(--border2);border-radius:4px;font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(t.trim())}</span>`).join('')}</div>`:''}
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted2);background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 10px;margin-bottom:10px;max-height:56px;overflow:hidden;line-height:1.7">
        ${esc((c.content||'').replace(/<[^>]+>/g,' ').replace(/[#*_`]/g,'').trim().slice(0,200))}${(c.content||'').length>200?'‚Ä¶':''}
      </div>
      <div class="flex aic g8" style="flex-wrap:wrap">
        <span style="font-family:var(--mono);font-size:9px;color:var(--muted)">Saved ${c.updated||c.created||''}</span>
        <span style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${(c.content||'').trim().split(/\s+/).filter(Boolean).length} words</span>
        <div style="margin-left:auto;display:flex;gap:5px;flex-wrap:wrap">
          <button class="btn btn-ghost btn-xs" onclick="csLibEdit('${c.id}')">‚úè Edit</button>
          <button class="btn btn-ghost btn-xs" onclick="csLibPreview('${c.id}')">üëÅ Preview</button>
          <button class="btn btn-ghost btn-xs" onclick="csLibCopy('${c.id}')">üìã Copy</button>
          <button class="btn btn-ghost btn-xs" onclick="csLibDownload('${c.id}')">‚¨á Download</button>
          <button class="btn btn-yellow btn-xs" onclick="csLibBlast('${c.id}')">üåç Blast</button>
          <button class="btn btn-blue btn-xs" onclick="csLibComment('${c.id}')">üí¨ Comment</button>
          <button class="btn btn-danger btn-xs" onclick="csLibDelete('${c.id}')">‚úï</button>
        </div>
      </div>
    </div>`).join('');
}

function csRefreshLibrary(){
  const el=document.getElementById('cs-lib-items');
  if(el) el.innerHTML=csRenderLibraryItems();
}

function csLibEdit(id){
  _csActiveEditor=id;
  const panel=document.getElementById('cs-tab-manual-panel');
  if(panel){ panel.innerHTML=csRenderEditor(id); }
  csTab('manual');
  const item=_contentLibrary.find(c=>c.id===id);
  if(item) _csEditorFormat=item.format||'markdown';
  setTimeout(csEditorOnInput,100);
}

function csLibPreview(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  const html = item.format==='html' ? item.content : item.format==='markdown' ? mdToHtml(item.content) : `<html><body style="font-family:system-ui;padding:24px;white-space:pre-wrap;line-height:1.7;color:#1e293b">${esc(item.content)}</body></html>`;
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`<div class="modal-box" style="min-width:700px;max-width:90vw;max-height:88vh;overflow:hidden;display:flex;flex-direction:column">
    <div class="modal-title">${esc(item.title||'Preview')} <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï Close</button></div>
    <iframe srcdoc="${html.replace(/"/g,'&quot;')}" style="flex:1;border:1px solid var(--border);border-radius:8px;min-height:500px" title="preview"></iframe>
    <div class="row" style="margin-top:12px">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-primary" onclick="csLibEdit('${id}');this.closest('.modal-overlay').remove()">‚úè Edit</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function csLibCopy(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  navigator.clipboard.writeText(item.content).then(()=>alert('‚úÖ Content copied to clipboard!')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=item.content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('‚úÖ Copied!');
  });
}

function csLibDownload(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  const ext={markdown:'md',html:'html',text:'txt'}[item.format]||'txt';
  const mime={markdown:'text/markdown',html:'text/html',text:'text/plain'}[item.format]||'text/plain';
  const blob=new Blob([item.content],{type:mime});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=slug(item.title||'content')+'.'+ext;a.click();
}

function csLibBlast(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  sessionStorage.setItem('cs_blast_content', item.content);
  sessionStorage.setItem('cs_blast_format', item.format);
  sessionStorage.setItem('cs_blast_title', item.title||'');
  renderPage('global_blast');
  setTimeout(()=>alert('‚úÖ Content loaded into Global Blast! Configure your platforms and click Blast.'),300);
}

function csLibComment(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  const raw=item.content.replace(/<[^>]+>/g,' ').replace(/[#*_\[\]`]/g,'').replace(/\s+/g,' ').trim();
  const excerpt=raw.slice(0,300)+(raw.length>300?'...':'');
  sessionStorage.setItem('cs_comment_content', excerpt);
  renderPage('blog_commenter');
  setTimeout(()=>{ const el=document.getElementById('bc-gen-out'); if(el) el.value=excerpt; },300);
}

function csLibDelete(id){
  if(!confirm('Delete this content item?')) return;
  _contentLibrary=_contentLibrary.filter(c=>c.id!==id);
  csSaveLibrary();
  csUpdateLibCount();
  csRefreshLibrary();
}

function csLibClearAll(){
  if(!confirm('Delete ALL saved content? This cannot be undone.')) return;
  _contentLibrary=[];
  csSaveLibrary();
  csUpdateLibCount();
  const panel=document.getElementById('cs-tab-library-panel');
  if(panel) panel.innerHTML=csRenderLibrary();
}

function csLibExportAll(){
  if(!_contentLibrary.length){ alert('Library is empty.'); return; }
  const json=JSON.stringify(_contentLibrary,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='content-library-'+Date.now()+'.json';a.click();
}

// ‚îÄ‚îÄ SHARED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateStudioContent(){
  const sel=(document.getElementById('studio-kw-sel')||{value:''}).value;
  const custom=(document.getElementById('studio-kw-custom')||{value:''}).value.trim();
  const kw=custom||sel;
  if(!kw){ alert('Select or enter a keyword first.'); return; }
  const count=Math.min(5,Math.max(1,parseInt((document.getElementById('studio-count')||{value:3}).value)||3));
  _studioArticles=[];
  for(let i=0;i<count;i++){
    _studioArticles.push(generateMarkdown(kw,S.links,i,S.keywords,'user','site.com'));
  }
  _studioActiveIdx=0;
  renderStudioOutput(kw);
}
function renderStudioOutput(kw){
  const el=document.getElementById('studio-output'); if(!el) return;
  if(!_studioArticles.length){ el.innerHTML=''; return; }
  const cur=_studioArticles[_studioActiveIdx]||'';
  el.innerHTML=`<div class="card">
    <div class="card-title">Variations</div>
    <div class="mtabs">
      ${_studioArticles.map((_,i)=>`<div class="mtab ${_studioActiveIdx===i?'on':''}" onclick="setStudioArticle(${i},'${esc(kw)}')">Variation ${i+1}</div>`).join('')}
    </div>
    <div class="flex aic g8" style="margin-bottom:8px">
      <div class="mtabs" style="margin-bottom:0">
        <div class="mtab ${_studioFormat==='markdown'?'on':''}" onclick="setStudioFormat('markdown','${esc(kw)}')">Markdown</div>
        <div class="mtab ${_studioFormat==='preview'?'on':''}" onclick="setStudioFormat('preview','${esc(kw)}')">Preview</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="copyText(document.getElementById('studio-ta').value, this)">COPY MARKDOWN</button>
      <button class="btn btn-ghost btn-sm" onclick="downloadMd('${esc(kw)}',${_studioActiveIdx})">‚¨á Download .md</button>
      <button class="btn btn-primary btn-sm" onclick="csSaveGeneratedToLib(${_studioActiveIdx},'${esc(kw)}')">üíæ Save to Library</button>
    </div>
    ${_studioFormat==='markdown'?`<textarea id="studio-ta" readonly rows="18" style="background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.7;border:1px solid var(--border);border-radius:6px;font-weight:600">${esc(cur)}</textarea>`
    :`<div style="background:white;padding:2px;min-height:300px"><iframe id="studio-frame" style="width:100%;height:420px;border:none" title="preview"></iframe></div>`}
  </div>`;
  if(_studioFormat==='preview'){
    const frame=document.getElementById('studio-frame');
    if(frame){ const html=mdToHtml(cur); frame.srcdoc=html; }
  }
}
function csSaveGeneratedToLib(idx,kw){
  const content=_studioArticles[idx]||'';
  if(!content) return;
  _contentLibrary.unshift({id:csGenId(),title:'Generated: '+kw+' (Var '+(idx+1)+')',content,format:'markdown',keyword:kw,tags:'generated,auto',created:ts(),updated:ts()});
  csSaveLibrary();
  csUpdateLibCount();
  alert('‚úÖ Saved to Content Library!');
}
function setStudioArticle(i,kw){ _studioActiveIdx=i; renderStudioOutput(kw); }
function setStudioFormat(f,kw){ _studioFormat=f; renderStudioOutput(kw); }
function mdToHtml(md){
  const lines=md.split('\n');
  const parts=lines.map(line=>{
    if(line.startsWith('# ')) return '<h1 style="font-size:1.8em;font-weight:800;margin:16px 0 8px;color:#1e1b4b">'+esc(line.slice(2))+'</h1>';
    if(line.startsWith('## ')) return '<h2 style="font-size:1.3em;font-weight:700;margin:14px 0 6px;color:#312e81">'+esc(line.slice(3))+'</h2>';
    if(line.startsWith('### ')) return '<h3 style="font-size:1.1em;font-weight:600;margin:10px 0 4px">'+esc(line.slice(4))+'</h3>';
    if(line.startsWith('- ')) return '<li style="margin:4px 0;margin-left:20px">'+esc(line.slice(2))+'</li>';
    if(line.trim()==='---') return '<hr style="border:none;border-top:1px solid #e2e8f0;margin:16px 0"/>';
    if(line.trim()==='') return '<br/>';
    return '<p style="margin:8px 0;color:#475569;line-height:1.7">'+esc(line)+'</p>';
  });
  return '<html><body style="font-family:system-ui;padding:20px;max-width:700px;margin:0 auto;line-height:1.7;color:#1e293b">'+parts.join('')+'</body></html>';
}
function downloadMd(kw,idx){
  const content=_studioArticles[idx]||'';
  const blob=new Blob([content],{type:'text/markdown'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=slug(kw)+'-v'+(idx+1)+'.md'; a.click();
}

// ‚îÄ‚îÄ‚îÄ COMPETITOR SPY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _spyNotes=[];
let _serpResults=[];
function renderCompetitorSpy(el){
  el.innerHTML=`
  <div class="page-title">üïµ Competitor Spy</div>
  <div class="page-sub">// real-time competitor analysis ¬∑ live SERP gap finder ¬∑ parasite opportunities</div>

  <div class="card">
    <div class="card-title">üîé URL Analyzer ‚Äî Real-Time</div>
    <div class="grid3" style="margin-bottom:10px">
      <div class="fg mb0"><label class="lbl">Competitor URL</label>
        <input type="url" id="spy-url" placeholder="https://medium.com/@user/article-slug" style="font-size:12px"/></div>
      <div class="fg mb0"><label class="lbl">Target Keyword (optional)</label>
        <input type="text" id="spy-kw" placeholder="e.g. weight loss tips"/></div>
      <div class="fg mb0 flex aic" style="align-items:flex-end;gap:8px">
        <button class="btn btn-primary f1" onclick="analyzeUrl()">üîç Analyze URL</button>
        <button class="btn btn-blue btn-sm" onclick="spyFetchPage()" title="Fetch real page content">üåê Fetch Live</button>
      </div>
    </div>
    <div id="spy-result"></div>
    <div id="spy-live-result" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="card-title">‚ö° SERP Gap Finder ‚Äî Live Platform Search</div>
    <div class="grid3" style="margin-bottom:10px">
      <div class="fg mb0"><label class="lbl">Keyword</label>
        <input type="text" id="serp-kw" placeholder="e.g. celebrity net worth, weight loss"/></div>
      <div class="fg mb0"><label class="lbl">Search Engine</label>
        <select id="serp-engine"><option value="google">Google</option><option value="bing">Bing</option><option value="duckduckgo">DuckDuckGo</option></select></div>
      <div class="fg mb0 flex aic" style="align-items:flex-end;gap:8px">
        <button class="btn btn-yellow f1" onclick="findSerpGaps()">‚ö° Find SERP Gaps</button>
        <button class="btn btn-danger btn-sm" id="serp-stop-btn" onclick="spyStopGap()" style="display:none">‚èπ Stop</button>
      </div>
    </div>
    <div id="serp-terminal" style="display:none;background:#0d1117;border:1px solid #30363d;padding:12px;font-family:var(--mono);font-size:10px;height:150px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9;margin-bottom:10px"></div>
    <div id="serp-result"></div>
  </div>

  <div class="card">
    <div class="card-title">üß† Multi-URL Competitor Comparison</div>
    <div class="row" style="margin-bottom:10px">
      <div class="f1 fg mb0"><textarea id="spy-multi-urls" rows="3" placeholder="Paste one URL per line to compare multiple competitor pages..."></textarea></div>
    </div>
    <div class="row">
      <button class="btn btn-primary" onclick="spyCompareMulti()">Compare All</button>
      <button class="btn btn-ghost btn-sm" onclick="spyExportComparison()">Export CSV</button>
    </div>
    <div id="spy-multi-result" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="card-title">Research Notes</div>
    <div class="row">
      <div class="f1 fg mb0"><input type="text" id="spy-note" placeholder="Add a research note..."/></div>
      <button class="btn btn-primary" onclick="addSpyNote()">+ Add</button>
    </div>
    <div id="spy-notes">${renderSpyNotes()}</div>
  </div>

  <div class="card">
    <div class="card-title">Parasite SEO Cheat Sheet</div>
    <div style="font-family:var(--mono);font-size:12px;line-height:2.2;color:var(--text);font-weight:600">
      ${[['ta','Target DA 90+ platforms first: Reddit, Blogger, Medium, Notion, WordPress'],['ta','Use exact-match keyword slugs in page titles and repo names'],['ta','Add internal links between your parasite pages to pass link equity'],['ta','Telegraph.ph is easiest ‚Äî no account needed, instant indexing'],['ta','GitHub/GitLab require 24-48h for Pages to go live first time'],['ta','Use IndexNow to submit all URLs immediately after publishing'],['ty','Avoid duplicate content ‚Äî use Content Studio to spin variations'],['ty','Add at least one contextual backlink to your money site from each page']].map(([cls,t])=>`<div><span class="${cls}">‚ñ∂</span> ${esc(t)}</div>`).join('')}
    </div>
  </div>`;
  document.getElementById('spy-url').addEventListener('keydown',e=>{ if(e.key==='Enter') analyzeUrl(); });
  document.getElementById('spy-note').addEventListener('keydown',e=>{ if(e.key==='Enter') addSpyNote(); });
  document.getElementById('serp-kw').addEventListener('keydown',e=>{ if(e.key==='Enter') findSerpGaps(); });
}

function analyzeUrl(){
  const url=(document.getElementById('spy-url')||{value:''}).value.trim();
  const kw=(document.getElementById('spy-kw')||{value:''}).value.trim();
  const el=document.getElementById('spy-result'); if(!el) return;
  if(!url){ el.innerHTML=''; return; }
  try{
    const u=new URL(url.startsWith('http')?url:'https://'+url);
    const hostname=u.hostname; const path=u.pathname;
    const platform=PLATFORMS.find(p=>hostname.includes(p.domain));
    const segs=path.split('/').filter(Boolean);
    const kwFromSlug=(segs[segs.length-1]||'').replace(/-/g,' ');
    const hasKwInPath=kw?path.toLowerCase().includes(slug(kw)):null;
    const estimatedDA = platform ? platform.da : Math.min(95, Math.max(20, 35 + (hostname.split('.').length*5)));
    const wordCount = kw ? (kw.split(' ').length) : 0;
    const kwDensity = wordCount > 0 && kwFromSlug ? (kwFromSlug.toLowerCase().includes(kw.toLowerCase().split(' ')[0]) ? 'Good ‚Äî keyword in slug' : 'Weak ‚Äî keyword not in slug') : '‚Äî';
    el.innerHTML=`<div style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-family:var(--mono);font-size:10px">
      ${[
        ['Platform',platform?(platform.icon+' '+platform.name):'Unknown / Non-parasite','ta'],
        ['Domain Authority',platform?platform.da+'  ('+( platform.da>=90?'Very High':platform.da>=80?'High':platform.da>=60?'Medium':'Low')+')':'~35','ty'],
        ['Hostname',hostname,'tb'],
        ['Path Depth',segs.length+' levels deep','tm'],
        ['Keyword from Slug',kwFromSlug||'‚Äî (no slug)','ta'],
        ['Slug KW Match',kwDensity,'ta'],
        ['Ranking Potential',platform?'High ‚Äî '+platform.name+' pages rank well':'Unknown','ta'],
        ['Content Path',segs.slice(0,-1).join('/') || '(root)','tb'],
        ['URL Length',url.length+' chars '+(url.length>100?'‚ö† Long':'‚úì Good'),'tm'],
      ].map(([l,v,c])=>
        `<div style="padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px"><div class="lbl" style="margin-bottom:3px">${l}</div><div class="${c}" style="font-weight:700;font-size:11px">${esc(String(v))}</div></div>`).join('')}
    </div>
    ${hasKwInPath===true?'<div class="notice notice-success mt8">‚úì Target keyword found in URL path ‚Äî strong on-page signal!</div>':hasKwInPath===false&&kw?'<div class="notice notice-warn mt8">‚ö† Target keyword NOT in URL path ‚Äî weaker signal.</div>':''}
    ${!platform?'<div class="notice notice-warn mt8">‚ö† Not a known parasite platform. Try: medium.com, blogspot.com, reddit.com, dev.to, hashnode.dev</div>':''}
    <div class="flex g8 mt8" style="flex-wrap:wrap">
      <button class="btn btn-ghost btn-xs" onclick="window.open('${esc(url.startsWith('http')?url:'https://'+url)}','_blank')">Open URL ‚Üí</button>
      <button class="btn btn-ghost btn-xs" onclick="window.open('https://search.google.com/search-console','_blank')">Search Console</button>
      <button class="btn btn-primary btn-xs" onclick="document.getElementById('serp-kw').value='${esc(kwFromSlug||kw)}';findSerpGaps()">Find SERP Gaps for this KW</button>
    </div>`;
  }catch(e){ el.innerHTML='<div class="notice notice-err mt8">Error: '+esc(e.message)+'</div>'; }
}

async function spyFetchPage(){
  const url=(document.getElementById('spy-url')||{value:''}).value.trim();
  const kw=(document.getElementById('spy-kw')||{value:''}).value.trim();
  const el=document.getElementById('spy-live-result'); if(!el) return;
  if(!url){ alert('Enter a URL first.'); return; }
  el.innerHTML='<div class="tm mono xs"><span class="spinner"></span> Fetching live page via proxy...</div>';
  const result = await bcProxyFetch(url.startsWith('http')?url:'https://'+url, {timeout:18000});
  if(!result.ok||result.text.length < 100){
    el.innerHTML=`<div class="notice notice-warn">Could not fetch page content (status: ${result.status||'error'}). The site may block proxies.</div>`;
    return;
  }
  const parser = new DOMParser();
  const doc = parser.parseFromString(result.text, 'text/html');
  const title = (doc.querySelector('title')||{textContent:'‚Äî'}).textContent.trim();
  const desc = (doc.querySelector('meta[name="description"]')||{content:'‚Äî'}).content||'‚Äî';
  const h1s = [...doc.querySelectorAll('h1')].map(h=>h.textContent.trim()).filter(Boolean).slice(0,3);
  const h2s = [...doc.querySelectorAll('h2')].map(h=>h.textContent.trim()).filter(Boolean).slice(0,6);
  const wordCount = (doc.body||{textContent:''}).textContent.trim().split(/\s+/).length;
  const images = doc.querySelectorAll('img').length;
  const links = doc.querySelectorAll('a[href]').length;
  const hasComments = result.text.toLowerCase().includes('leave a comment') || result.text.toLowerCase().includes('leave a reply') || result.text.toLowerCase().includes('post a comment');
  const kwInTitle = kw ? (title.toLowerCase().includes(kw.toLowerCase()) ? '‚úÖ Yes' : '‚ùå No') : '‚Äî';
  const kwInDesc = kw ? (desc.toLowerCase().includes(kw.toLowerCase()) ? '‚úÖ Yes' : '‚ùå No') : '‚Äî';
  el.innerHTML=`
  <div class="card" style="margin-top:0;background:rgba(0,87,255,0.03);border-color:rgba(0,87,255,0.2)">
    <div class="card-title">üåê Live Page Data [${result.proxy}]</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-family:var(--mono);font-size:10px;margin-bottom:12px">
      ${[
        ['Page Title',title.slice(0,50)+(title.length>50?'...':''),'ta'],
        ['Word Count',wordCount+' words'+(wordCount>800?'  (good)':wordCount>400?' (medium)':' (thin)'),'ty'],
        ['Images',images+' images','tb'],
        ['Links',links+' outbound links','tm'],
        ['KW in Title',kwInTitle,'ta'],
        ['KW in Desc',kwInDesc,'ta'],
        ['Comment Section',hasComments?'‚úÖ Found':'‚ùå Not detected','ta'],
        ['Proxy Used',result.proxy,'tm'],
        ['Content Size',result.text.length+' bytes','tm'],
      ].map(([l,v,c])=>`<div style="padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px"><div class="lbl" style="margin-bottom:2px">${l}</div><div class="${c}" style="font-weight:700;font-size:11px">${esc(String(v))}</div></div>`).join('')}
    </div>
    ${h1s.length?`<div style="margin-bottom:8px"><div class="lbl">H1 Tags</div>${h1s.map(h=>`<div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:700;padding:3px 0">${esc(h)}</div>`).join('')}</div>`:''}
    ${h2s.length?`<div><div class="lbl">H2 Tags (subheadings)</div>${h2s.map(h=>`<div style="font-family:var(--mono);font-size:10px;color:var(--text);padding:2px 0">‚ñ∂ ${esc(h)}</div>`).join('')}</div>`:''}
    ${desc&&desc!=='‚Äî'?`<div style="margin-top:8px"><div class="lbl">Meta Description</div><div style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-style:italic">"${esc(desc.slice(0,200))}"</div></div>`:''}
  </div>`;
}

let _spyMultiResults = [];
async function spyCompareMulti(){
  const raw = (document.getElementById('spy-multi-urls')||{value:''}).value.trim();
  if(!raw){ alert('Paste some URLs to compare.'); return; }
  const urls = raw.split('\n').map(u=>u.trim()).filter(Boolean).slice(0,10);
  const el = document.getElementById('spy-multi-result'); if(!el) return;
  el.innerHTML='<div class="tm mono xs"><span class="spinner"></span> Analyzing '+urls.length+' URLs...</div>';
  _spyMultiResults = [];
  for(const url of urls){
    try {
      const u = new URL(url.startsWith('http')?url:'https://'+url);
      const hostname = u.hostname.replace('www.','');
      const platform = PLATFORMS.find(p=>hostname.includes(p.domain));
      const segs = u.pathname.split('/').filter(Boolean);
      const kwFromSlug = (segs[segs.length-1]||'').replace(/-/g,' ');
      _spyMultiResults.push({url, hostname, da: platform?platform.da:35, platform: platform?platform.name:'Unknown', slug: kwFromSlug, depth: segs.length});
    } catch(e){ _spyMultiResults.push({url, hostname:'error', da:0, platform:'Error', slug:'', depth:0}); }
  }
  _spyMultiResults.sort((a,b)=>b.da-a.da);
  el.innerHTML=`<div class="tw" style="margin-top:0"><table><thead><tr><th>#</th><th>Domain</th><th>Platform</th><th>DA</th><th>Depth</th><th>Keyword Slug</th><th>URL</th></tr></thead><tbody>
    ${_spyMultiResults.map((r,i)=>`<tr>
      <td class="mono xs tm">${i+1}</td>
      <td class="mono xs ta">${esc(r.hostname)}</td>
      <td class="mono xs">${esc(r.platform)}</td>
      <td><span class="badge ${r.da>=85?'badge-g':r.da>=60?'badge-y':'badge-b'}">${r.da}</span></td>
      <td class="mono xs tm">${r.depth} lvl</td>
      <td class="mono xs tb">${esc(r.slug)||'‚Äî'}</td>
      <td><a href="${esc(r.url)}" target="_blank" style="font-family:var(--mono);font-size:9px;color:var(--accent4)">Open ‚Üí</a></td>
    </tr>`).join('')}
  </tbody></table></div>`;
}
function spyExportComparison(){
  if(!_spyMultiResults.length){ alert('Run comparison first.'); return; }
  const rows=[['URL','Domain','Platform','DA','Depth','Keyword Slug'],..._spyMultiResults.map(r=>[r.url,r.hostname,r.platform,r.da,r.depth,r.slug])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='spy-comparison-'+Date.now()+'.csv'; a.click();
}
async function findSerpGaps(){
  const kw=(document.getElementById('serp-kw')||{value:''}).value.trim();
  const engine=(document.getElementById('serp-engine')||{value:'google'}).value;
  const el=document.getElementById('serp-result'); if(!el) return;
  const termEl=document.getElementById('serp-terminal');
  const stopBtn=document.getElementById('serp-stop-btn');
  if(!kw){ el.innerHTML=''; return; }

  _spyAbortGap=false;
  if(termEl){ termEl.style.display=''; termEl.innerHTML=''; }
  if(stopBtn) stopBtn.style.display='';
  el.innerHTML='';

  function sgLog(msg,color='#c9d1d9'){
    if(!termEl) return;
    const d=document.createElement('div');
    d.innerHTML=`<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`;
    termEl.appendChild(d); termEl.scrollTop=termEl.scrollHeight;
  }
  sgLog(`üîç Searching SERP for: "${esc(kw)}" via ${engine.toUpperCase()}`,'#58a6ff');
  sgLog(`‚å® Phase 1: SearXNG live results...`,'#d29922');

  const liveUrls = new Set();

  // Phase 1: SearXNG live SERP
  for(const instance of CS_SEARXNG_INSTANCES){
    if(_spyAbortGap) break;
    const urls = await csSearxngSearch(kw, instance, 'any');
    if(urls && urls.length>0){
      urls.forEach(u=>liveUrls.add(u));
      sgLog(`   ‚úÖ SearXNG [${instance.replace('https://','').split('/')[0]}]: ${urls.length} results`,'#3fb950');
      break;
    }
  }

  // Phase 2: Proxy-based search
  if(liveUrls.size < 5 && !_spyAbortGap){
    sgLog(`‚å® Phase 2: Proxy scrape ${engine}...`,'#d29922');
    const r = await csGoogleBingSearch(kw, engine, 'any');
    if(r && r.urls && r.urls.length>0){ r.urls.forEach(u=>liveUrls.add(u)); sgLog(`   ‚úÖ ${engine} via [${r.proxy}]: ${r.urls.length} URLs`,'#3fb950'); }
    const ddg = await csDuckDuckGoSearch(kw);
    if(ddg && ddg.length>0){ ddg.forEach(u=>liveUrls.add(u)); sgLog(`   ‚úÖ DDG: ${ddg.length} URLs`,'#3fb950'); }
  }

  // Analyze which platforms appear in live SERPs
  const liveUrlArr = [...liveUrls];
  sgLog(`üìä Analyzing ${liveUrlArr.length} live SERP URLs...`,'#58a6ff');
  const platformCounts={};
  liveUrlArr.forEach(url=>{
    try{
      const hostname=new URL(url).hostname.replace('www.','');
      const match=PLATFORMS.find(p=>hostname.includes(p.domain));
      if(match){ platformCounts[match.id||match.name]=(platformCounts[match.id||match.name]||{count:0,platform:match,urls:[]}); platformCounts[match.id||match.name].count++; platformCounts[match.id||match.name].urls.push(url); }
    }catch(e){}
  });

  // Build gap table ‚Äî platforms already ranking + those not yet ranking
  const sorted=[...PLATFORMS].sort((a,b)=>b.da-a.da);
  const liveData = sorted.map(p=>{
    const key=p.id||p.name;
    const existing=platformCounts[key];
    return { ...p, inSerp: !!(existing&&existing.count>0), serpCount: existing?existing.count:0, serpUrls: existing?existing.urls:[] };
  });

  const alreadyRanking = liveData.filter(p=>p.inSerp);
  const gap = liveData.filter(p=>!p.inSerp);

  sgLog(`‚úÖ Found ${alreadyRanking.length} platforms already ranking, ${gap.length} gap opportunities`,'#3fb950');
  if(stopBtn) stopBtn.style.display='none';

  el.innerHTML=`
  <div class="grid2" style="gap:10px;margin-bottom:12px">
    <div style="background:rgba(0,87,255,0.06);border:1px solid rgba(0,87,255,0.2);border-radius:10px;padding:14px;text-align:center">
      <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent)">${alreadyRanking.length}</div>
      <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase">üìà Already Ranking</div>
    </div>
    <div style="background:rgba(217,119,6,0.06);border:1px solid rgba(217,119,6,0.2);border-radius:10px;padding:14px;text-align:center">
      <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent3)">${gap.length}</div>
      <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase">üéØ Gap Opportunities</div>
    </div>
  </div>
  ${alreadyRanking.length?`
  <div class="card" style="margin-bottom:10px">
    <div class="card-title">üìà Already Ranking for "${esc(kw)}"</div>
    <div class="tw"><table><thead><tr><th>Platform</th><th>DA</th><th>SERP Count</th><th>Live URLs</th><th>Action</th></tr></thead><tbody>
    ${alreadyRanking.map(p=>`<tr>
      <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs ta">${esc(p.name)}</span></td>
      <td><span class="badge badge-g">${p.da}</span></td>
      <td><span class="ta mono xs">${p.serpCount} pages</span></td>
      <td>${p.serpUrls.slice(0,2).map(u=>`<a href="${esc(u)}" target="_blank" class="btn btn-ghost btn-xs" style="margin:1px">View ‚Üí</a>`).join('')}</td>
      <td><button class="btn btn-primary btn-xs" onclick="pfAddToCommenterSite_byUrl('${esc(p.serpUrls[0]||'https://'+p.domain)}','${esc(p.name)}')">+Queue</button></td>
    </tr>`).join('')}
    </tbody></table></div>
  </div>`:'' }
  <div class="card">
    <div class="card-title">üéØ Gap Opportunities ‚Äî Not Yet Ranking (publish here first!)</div>
    <div class="tw"><table><thead><tr><th>Platform</th><th>DA</th><th>Rank Power</th><th>Suggested Slug</th><th>Domain</th><th>Action</th></tr></thead><tbody>
    ${gap.slice(0,20).map(p=>`<tr>
      <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs">${esc(p.name)}</span></td>
      <td><span class="badge ${p.da>=90?'badge-g':p.da>=82?'badge-y':'badge-b'}">${p.da}</span></td>
      <td style="font-family:var(--mono);font-size:13px;letter-spacing:-1px">${esc(p.rankPower||'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ')}</td>
      <td class="mono xs tm">${slug(kw)}</td>
      <td class="mono xs tb">${p.domain}</td>
      <td><button class="btn btn-yellow btn-xs" onclick="navigator.clipboard&&navigator.clipboard.writeText('https://${esc(p.domain)}/'+slug('${esc(kw)}'))">Copy URL</button></td>
    </tr>`).join('')}
    </tbody></table></div>
  </div>`;
}

function pfAddToCommenterSite_byUrl(url, label){
  if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''}); bcSave(); }
  alert('‚úì Added '+label+' to Blog Commenter queue!');
}
function renderSpyNotes(){ return _spyNotes.length?_spyNotes.map(n=>`<div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--bg);border:1px solid var(--border);margin-bottom:5px;font-family:var(--mono);font-size:11px;border-radius:7px;font-weight:600"><span class="tm" style="font-size:9px;flex-shrink:0">${n.ts}</span><span style="flex:1;color:var(--text)">${esc(n.text)}</span><button class="btn btn-danger btn-xs" onclick="removeSpyNote('${n.id}')">‚úï</button></div>`).join(''):'<p class="tm mono xs">No notes yet.</p>'; }
function addSpyNote(){ const inp=document.getElementById('spy-note'); if(!inp||!inp.value.trim()) return; _spyNotes.push({id:uid(),text:inp.value.trim(),ts:ts()}); inp.value=''; const el=document.getElementById('spy-notes'); if(el) el.innerHTML=renderSpyNotes(); }
function removeSpyNote(id){ _spyNotes=_spyNotes.filter(n=>n.id!==id); const el=document.getElementById('spy-notes'); if(el) el.innerHTML=renderSpyNotes(); }

// ‚îÄ‚îÄ‚îÄ KW RESEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _kwrSuggestions=[];
let _kwrSelected=[];
function renderKwResearch(el){
  el.innerHTML=`
  <div class="page-title">üîç Keyword Research</div>
  <div class="page-sub">// intent-based keyword expansion ¬∑ entertainment ¬∑ sport ¬∑ celebrity ¬∑ questions ¬∑ how-to ¬∑ and more</div>
  <div class="card">
    <div class="card-title">Keyword Expander</div>
    <div class="grid3" style="margin-bottom:12px">
      <div class="fg mb0"><label class="lbl">Seed Keyword</label>
        <input type="text" id="kwr-seed" placeholder="e.g. creatine supplement, cristiano ronaldo, iphone review"/></div>
      <div class="fg mb0"><label class="lbl">Volume Hint</label>
        <select id="kwr-volume">
          <option value="all">All Volume Ranges</option>
          <option value="high">High Volume (mass appeal)</option>
          <option value="mid">Mid Volume (niche)</option>
          <option value="low">Low Volume (long-tail)</option>
        </select></div>
      <div class="fg mb0"><label class="lbl">Region/Language</label>
        <select id="kwr-region">
          <option value="global">Global / English</option>
          <option value="us">United States</option>
          <option value="uk">United Kingdom</option>
          <option value="ng">Nigeria</option>
          <option value="au">Australia</option>
          <option value="ca">Canada</option>
        </select></div>
    </div>
    <div class="card-title" style="margin-top:8px">Search Intent</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px" id="kwr-intent-pills">
      ${['all','informational','commercial','transactional','local','entertainment','sport','celebrity','lifestyle','how-to','questions','video','tech','news','review'].map(i=>{
        const labels={all:'‚ô• All Intents',informational:'‚Ñπ Informational',commercial:'üõí Commercial',transactional:'üí≥ Transactional',local:'üìç Local',entertainment:'üé¨ Entertainment',sport:'‚öΩ Sport',celebrity:'‚≠ê Celebrity',lifestyle:'‚ú® Lifestyle','how-to':'üõ† How-To',questions:'‚ùì Questions',video:'üé• Video',tech:'üíª Tech','news':'üì∞ News',review:'üîç Review'};
        return `<span class="chip ${i==='all'?'on':''}" id="kwri-${i}" onclick="kwrSelectIntent('${i}')" style="cursor:pointer;user-select:none;padding:5px 12px;font-size:11px">${labels[i]||i}</span>`;
      }).join('')}
    </div>
    <div class="flex aic g8">
      <button class="btn btn-primary" onclick="expandKeywords()" style="padding:9px 20px">‚ö° Generate Suggestions</button>
      <button class="btn btn-blue btn-sm" onclick="kwrLiveSearch()" id="kwr-live-btn">
        üåê Live Search Suggestions
      </button>
      <span id="kwr-live-status" style="font-family:var(--mono);font-size:10px;color:var(--muted2)"></span>
    </div>
  </div>
  <div id="kwr-output"></div>
  ${S.keywords.length?`<div class="card">
    <div class="card-title">Your Keyword Clusters (${S.keywords.length} total)</div>
    ${(()=>{
      const clusters={};
      S.keywords.forEach(kw=>{ const key=(kw.split(' ')[0]||'misc').toLowerCase(); if(!clusters[key]) clusters[key]=[]; clusters[key].push(kw); });
      return Object.entries(clusters).map(([k,kws])=>`<div style="margin-bottom:12px"><div style="font-family:var(--mono);font-size:9px;color:var(--accent);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:6px">${esc(k)} <span class="nav-badge">${kws.length}</span></div><div class="chips">${kws.map(kw=>`<span class="chip on" style="cursor:default">${esc(kw)}</span>`).join('')}</div></div>`).join('');
    })()}
  </div>`:''}`;
  document.getElementById('kwr-seed').addEventListener('keydown',e=>{ if(e.key==='Enter') expandKeywords(); });
}
const INTENT_MODS={
  informational:['what is','how to','guide to','complete guide','tutorial','explained','tips for','best way to','learn','vs','difference between','examples of','benefits of','overview','definition'],
  commercial:['best','top','review','vs','compare','alternatives to','buy','where to get','recommended','worth it','pros and cons','is it good'],
  transactional:['buy','order','get','download','free','discount','price','cost','cheap','deal','coupon','offer'],
  local:['near me','local','nearby','service','in my city','in lagos','in london','in new york'],
  entertainment:['funny','viral','trending','meme','watch','stream','movie','show','episode','season','trailer','best scenes','hidden gems','must watch','binge worthy','award winning'],
  sport:['highlights','score','match','game','player','team','transfer','stats','ranking','championship','tournament','league','best goals','injury update','news','fixtures'],
  celebrity:['net worth','dating','married','age','height','house','cars','scandal','beef','drama','interview','reaction','biography','before fame','transformation','plastic surgery'],
  lifestyle:['routine','morning routine','diet','fitness','workout','skincare','fashion','outfit','travel','budget','minimalist','productivity','self care','wellness','mental health'],
  'how-to':['how to','step by step','beginners guide','tutorial','DIY','make your own','fix','repair','set up','install','configure','start','create','build'],
  questions:['why','what','when','who','where','how','can you','should I','is it possible','does it work','what happens if','what is the difference','is it worth','how long'],
  video:['youtube','tiktok','reel','shorts','vlog','reaction video','explained video','review video','top 10 video','documentary','podcast','live stream'],
  tech:['app','software','tool','review','update','vs','alternative','tutorial','setup','error','how to use','best settings','hidden features','tips tricks'],
  news:['latest news','breaking','update','today','2024','2025','announced','released','confirmed','leaked','rumour'],
  review:['review','honest review','worth it','pros cons','rating','is it good','should I buy','unboxing','first impressions','after 6 months','long term'],
};
let _kwrSelectedIntent = 'all';
function kwrSelectIntent(intent){
  _kwrSelectedIntent = intent;
  document.querySelectorAll('[id^="kwri-"]').forEach(el => el.classList.remove('on'));
  const sel = document.getElementById('kwri-'+intent);
  if(sel) sel.classList.add('on');
}
async function kwrLiveSearch(){
  const seed = (document.getElementById('kwr-seed')||{value:''}).value.trim();
  if(!seed){ alert('Enter a seed keyword first.'); return; }
  const btn = document.getElementById('kwr-live-btn');
  const status = document.getElementById('kwr-live-status');
  if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Searching...'; }
  if(status) status.textContent = 'Trying SearXNG instances...';
  const intent = _kwrSelectedIntent !== 'all' ? _kwrSelectedIntent : 'informational';
  const modList = INTENT_MODS[intent]||INTENT_MODS.informational;
  const query = `${seed} ${modList[0]}`;
  let found = [];
  // Try SearXNG first
  for(const instance of CS_SEARXNG_INSTANCES){
    const urls = await csSearxngSearch(query, instance, 'any');
    if(urls && urls.length > 0){
      // Extract keyword suggestions from page titles and URLs
      urls.forEach(url => {
        try {
          const u = new URL(url);
          const pathSegs = u.pathname.split('/').filter(Boolean);
          pathSegs.forEach(seg => {
            const kw = seg.replace(/-/g,' ').replace(/[_+]/g,' ').trim();
            if(kw.length > 4 && kw.length < 60 && kw.toLowerCase().includes(seed.toLowerCase().split(' ')[0])){
              found.push(kw);
            }
          });
        } catch(e){}
      });
      if(found.length > 0) break;
    }
  }
  // Also generate from all modifiers matching that intent
  const autoGen = new Set();
  modList.forEach(mod => { autoGen.add(mod+' '+seed); autoGen.add(seed+' '+mod); });
  // Add found from live
  found.forEach(kw => autoGen.add(kw));
  // Also add question variants for questions intent
  if(_kwrSelectedIntent === 'questions'){
    ['why is','what is','how does','when should','where to','who is','can I','should I'].forEach(q => autoGen.add(q+' '+seed));
  }
  _kwrSuggestions = [...autoGen].filter(k=>k.trim()&&k.length>4&&k!==seed).slice(0,60);
  _kwrSelected = [];
  renderKwrSuggestions();
  if(btn){ btn.disabled=false; btn.innerHTML='üåê Live Search Suggestions'; }
  if(status) status.textContent = found.length > 0 ? `‚úÖ +${found.length} live suggestions` : 'Generated from intent modifiers';
}

function expandKeywords(){
  const seed=(document.getElementById('kwr-seed')||{value:''}).value.trim();
  if(!seed){ alert('Enter a seed keyword first.'); return; }
  const intent=_kwrSelectedIntent||'all';
  const el=document.getElementById('kwr-output'); if(!el) return;
  el.innerHTML='<div class="tm mono xs"><span class="spinner"></span> Generating...</div>';
  setTimeout(()=>{
    const allMods=intent==='all'?Object.values(INTENT_MODS).flat():INTENT_MODS[intent]||[];
    const suffixes=[year(),'guide','tips','review','free','online','best','cheap','tutorial','for beginners','advanced','checklist','template','examples'];
    const generated=new Set();
    allMods.forEach(mod=>{ generated.add(mod+' '+seed); generated.add(seed+' '+mod); });
    suffixes.forEach(s=>{ generated.add(seed+' '+s); generated.add('best '+seed+' '+s); });
    ['complete guide','step by step','how to','what is the best'].forEach(p=>generated.add(p+' '+seed));
    ['for small business','for beginners','for experts','that works','online'].forEach(s=>generated.add(seed+' '+s));
    _kwrSuggestions=[...generated].filter(k=>k.trim()&&k.length>4&&k!==seed).slice(0,50);
    _kwrSelected=[];
    renderKwrSuggestions();
  },400);
}
function renderKwrSuggestions(){
  const el=document.getElementById('kwr-output'); if(!el||!_kwrSuggestions.length) return;
  const intentLabel = _kwrSelectedIntent!=='all' ? ` <span style="font-size:9px;background:rgba(0,87,255,0.1);color:var(--accent);padding:2px 7px;border-radius:10px;font-family:var(--mono);font-weight:700;text-transform:uppercase;letter-spacing:.05em">${_kwrSelectedIntent}</span>` : '';
  el.innerHTML=`<div class="card slide-in">
    <div class="card-title flex aic g8">
      üí° ${_kwrSuggestions.length} Suggestions${intentLabel}
      <button class="btn btn-ghost btn-xs" onclick="kwrSelectAll()">Select All</button>
      <button class="btn btn-ghost btn-xs" onclick="_kwrSelected=[];renderKwrSuggestions()">Clear</button>
      <button class="btn btn-primary btn-sm" style="margin-left:auto" onclick="kwrAddToList()" ${!_kwrSelected.length?'disabled':''}>+ Add ${_kwrSelected.length} to Keyword List</button>
    </div>
    <div style="margin-bottom:10px;font-family:var(--mono);font-size:9px;color:var(--muted2)">Click keywords to select ¬∑ click again to deselect ¬∑ then add to your list</div>
    <div class="chips">${_kwrSuggestions.map((kw,i)=>`<span class="chip ${_kwrSelected.includes(kw)?'on':''}" onclick="kwrToggle('${esc(kw)}')" title="${esc(kw)}">${esc(kw)}${_kwrSelected.includes(kw)?' ‚úì':''}</span>`).join('')}</div>
    <div style="margin-top:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${_kwrSelected.length} selected</span>
      <button class="btn btn-ghost btn-xs" onclick="kwrSelectAll()">All</button>
      <button class="btn btn-ghost btn-xs" onclick="_kwrSelected=[];renderKwrSuggestions()">None</button>
      <button class="btn btn-yellow btn-xs" onclick="kwrExportCSV()">Export CSV</button>
      <button class="btn btn-blue btn-xs" onclick="kwrCopyAll()">Copy All</button>
    </div>
  </div>`;
}
function kwrExportCSV(){
  const csv = ['keyword',..._kwrSuggestions].join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='keywords-'+Date.now()+'.csv'; a.click();
}
function kwrCopyAll(){
  const text = _kwrSuggestions.join('\n');
  navigator.clipboard&&navigator.clipboard.writeText(text);
}
function kwrToggle(kw){ if(_kwrSelected.includes(kw)) _kwrSelected=_kwrSelected.filter(x=>x!==kw); else _kwrSelected.push(kw); renderKwrSuggestions(); }
function kwrSelectAll(){ _kwrSelected=[..._kwrSuggestions]; renderKwrSuggestions(); }
function kwrAddToList(){
  S.keywords=[...new Set([...S.keywords,..._kwrSelected])];
  _kwrSuggestions=_kwrSuggestions.filter(k=>!_kwrSelected.includes(k));
  _kwrSelected=[];
  updateHeader();
  renderKwResearch(document.getElementById('page-kw_research'));
}

// ‚îÄ‚îÄ‚îÄ BLOG COMMENTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _bcSites = JSON.parse(localStorage.getItem('bc_sites')||'[]');
let _bcUrlLists = JSON.parse(localStorage.getItem('bc_url_lists')||'[]');
let _bcLog   = [];
let _bcRunning = false;
let _bcStop = false;
let _bcTermLines = [];

function bcSave(){ try{ localStorage.setItem('bc_sites', JSON.stringify(_bcSites)); }catch(e){} }
function bcSaveUrlLists(){ try{ localStorage.setItem('bc_url_lists', JSON.stringify(_bcUrlLists)); }catch(e){} }

const BC_TEMPLATES = [
  (kw,url,name)=>`Great post! I've been looking for reliable info on ${kw} and this really helped. Thanks for sharing, ${name}!`,
  (kw,url,name)=>`Really useful breakdown on ${kw}. This is exactly the kind of content that adds value. Keep it up ‚Äî ${name}`,
  (kw,url,name)=>`I've read a lot about ${kw} but this article really stands out. Well researched and easy to follow. ‚Äî ${name}`,
  (kw,url,name)=>`Just what I needed on ${kw}. Bookmarking this for future reference. Thanks for the effort! ‚Äî ${name}`,
  (kw,url,name)=>`Excellent article! The section on ${kw} was particularly insightful. Would love to see more on this topic. ‚Äî ${name}`,
  (kw,url,name)=>`This is a solid resource on ${kw}. I've shared it with my network. Really appreciate the depth here ‚Äî ${name}`,
  (kw,url,name)=>`Thanks for writing this up! ${kw} is something I've been researching and this covered all the key points. ‚Äî ${name}`,
  (kw,url,name)=>`Really appreciated the detail here on ${kw}. Saved this article for reference. ‚Äî ${name}`,
];

function bcGenComment(kw, url, name){
  const fn = BC_TEMPLATES[Math.floor(Math.random() * BC_TEMPLATES.length)];
  return fn(kw||'this topic', url||'', name||'A Reader');
}

function renderBlogCommenter(el){
  const kws = S.keywords.length ? S.keywords : [];
  el.innerHTML=`
  <div class="page-title">üí¨ Blog Commenter ‚Äî v3 Maximum Force</div>
  <div class="page-sub">// 8-proxy engine ¬∑ WP REST + form POST + generic ¬∑ manual assist fallback ¬∑ custom Cloudflare Worker proxy</div>

  <!-- TOP ROW: Settings + URL List Manager -->
  <div class="grid2" style="gap:18px;align-items:start;margin-bottom:0">

    <!-- LEFT COL -->
    <div>
      <!-- Comment Identity -->
      <div class="card">
        <div class="card-title">ü™™ Commenter Identity</div>
        <div class="grid2">
          <div class="fg mb0"><label class="lbl">Display Name</label>
            <input type="text" id="bc-gen-name" placeholder="e.g. John Davis"/></div>
          <div class="fg mb0"><label class="lbl">Email</label>
            <input type="email" id="bc-email" placeholder="your@email.com"/></div>
        </div>
        <div class="fg mt8"><label class="lbl">Website / URL Field (optional)</label>
          <input type="url" id="bc-website" placeholder="https://yoursite.com"/></div>
      </div>

      <!-- Comment Generator -->
      <div class="card">
        <div class="card-title">üìù Comment Generator</div>
        <div class="grid2">
          <div class="fg mb0"><label class="lbl">Keyword / Topic</label>
            <select id="bc-gen-kw">
              <option value="">‚Äî pick or type below ‚Äî</option>
              ${kws.map(k=>`<option value="${esc(k)}">${esc(k)}</option>`).join('')}
            </select></div>
          <div class="fg mb0"><label class="lbl">Custom Keyword</label>
            <input type="text" id="bc-custom-kw" placeholder="e.g. creatine supplements"/></div>
        </div>
        <div class="fg mt8"><label class="lbl">Generated Comment</label>
          <textarea id="bc-gen-out" rows="4" placeholder="Click Generate to create a comment..."></textarea></div>
        <div class="row">
          <button class="btn btn-primary" onclick="bcGenerate()">üé≤ Generate</button>
          <button class="btn btn-ghost" onclick="bcCopyComment()">üìã Copy</button>
          <button class="btn btn-yellow" onclick="bcQueueAll()">‚ö° Queue to All Sites</button>
        </div>
      </div>

      </div>

      <!-- Advanced Settings -->
  <div class="card">
        <div class="card-title">‚öô Advanced Settings</div>
        <div class="fg"><label class="lbl">Custom Proxy Endpoint (optional)</label>
          <input type="url" id="bc-custom-proxy" placeholder="https://your-worker.workers.dev/?url={URL}" value="${_bcCustomProxy||''}"/></div>
        <div class="notice notice-info" style="margin-top:8px;font-size:10px">
          Deploy a <strong>Cloudflare Worker</strong> as your own CORS proxy for 100% reliability. Use <code>{URL}</code> as the placeholder for the target URL. Free tier: 100k req/day.
          <a href="javascript:void(0)" onclick="bcShowCfWorkerCode()" style="color:var(--accent);font-weight:700">üìã View Cloudflare Worker Code</a>
        </div>
        <div class="flex aic g8 mt8" style="flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-family:var(--mono);font-size:11px;font-weight:700">
            <input type="checkbox" id="bc-manual-fallback" style="width:auto" ${localStorage.getItem('bc_manual_fallback')==='1'?'checked':''} onchange="localStorage.setItem('bc_manual_fallback',this.checked?'1':'0')"/>
            Manual Assist fallback on failure (opens site + pastes comment)
          </label>
        </div>
      </div>

      <!-- Add Single Site -->
      <div class="card">
        <div class="card-title">‚ûï Add Single Target</div>
        <div class="fg"><label class="lbl">Blog / Post URL</label>
          <input type="url" id="bc-url" placeholder="https://example.com/blog/post-title"/></div>
        <div class="grid2">
          <div class="fg mb0"><label class="lbl">Label (optional)</label>
            <input type="text" id="bc-label" placeholder="e.g. Health Blog #1"/></div>
          <div class="fg mb0"><label class="lbl">Platform Type</label>
            <select id="bc-type">
              <option value="wordpress">WordPress</option>
              <option value="blogger">Blogger</option>
              <option value="disqus">Disqus</option>
              <option value="generic">Generic</option>
              <option value="other">Other</option>
            </select></div>
        </div>
        <div class="fg mt8"><label class="lbl">Notes</label>
          <input type="text" id="bc-notes" placeholder="e.g. scroll to #comments, requires captcha"/></div>
        <div class="row mt8">
          <button class="btn btn-primary f1" onclick="bcAddSite()">+ Add Site</button>
          <button class="btn btn-ghost" onclick="bcImportBulk()">üìã Paste Bulk</button>
        </div>
      </div>
    </div>

    <!-- RIGHT COL -->
    <div>
      <!-- URL List Manager (TXT Upload) -->
      <div class="card">
        <div class="card-title">üìÇ URL List Manager</div>
        <div class="notice notice-info" style="margin-bottom:10px">Upload a .txt file with one URL per line. Lists are saved and can be pushed directly to the target sites queue.</div>

        <div style="border:2px dashed var(--border2);border-radius:8px;padding:16px;text-align:center;margin-bottom:10px;cursor:pointer;transition:border-color 0.15s;background:var(--bg)" id="bc-drop-zone" onclick="document.getElementById('bc-file-input').click()" ondragover="bcDragOver(event)" ondragleave="bcDragLeave(event)" ondrop="bcDrop(event)">
          <div style="font-size:24px;margin-bottom:6px">üìÑ</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">Click or drag & drop a .txt file here</div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px">One URL per line ¬∑ https:// format</div>
        </div>
        <input type="file" id="bc-file-input" accept=".txt,text/plain" style="display:none" onchange="bcFileSelected(this)"/>

        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input type="text" id="bc-list-name" placeholder="List name (optional)..." style="flex:1"/>
          <button class="btn btn-primary btn-sm" onclick="bcSaveCurrentList()">üíæ Save List</button>
        </div>

        <!-- Saved URL Lists -->
        <div id="bc-url-lists-render">${bcRenderUrlLists()}</div>
      </div>

      <!-- Target Sites -->
      <div class="card">
        <div class="card-title flex aic g8">
          üéØ Target Sites <span class="nav-badge" id="bc-site-count">${_bcSites.length}</span>
          <button class="btn btn-danger btn-xs" style="margin-left:auto" onclick="bcClearAll()">Clear All</button>
        </div>
        <div id="bc-site-list" style="max-height:320px;overflow-y:auto">${bcRenderSiteList()}</div>
      </div>
    </div>
  </div>

  <!-- FULL WIDTH: Auto Commenter Terminal -->
  <div class="card" style="margin-top:0">
    <div class="card-title flex aic g8">
      üñ• Auto Commenter ‚Äî Real-Time Terminal
      <span id="bc-run-badge" class="nav-badge" style="display:none;background:rgba(0,200,100,0.15);color:#00c864;border-color:rgba(0,200,100,0.3)">‚óè RUNNING</span>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label class="lbl" style="margin:0;white-space:nowrap">Delay between sites:</label>
        <select id="bc-delay" style="width:120px">
          <option value="2000">2 seconds</option>
          <option value="4000" selected>4 seconds</option>
          <option value="6000">6 seconds</option>
          <option value="10000">10 seconds</option>
          <option value="15000">15 seconds</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="bcTermClear()">Clear Terminal</button>
        <button class="btn btn-danger btn-sm" id="bc-stop-btn" onclick="bcStopRun()" style="display:none">‚èπ Stop</button>
        <button class="btn btn-primary" id="bc-start-btn" onclick="bcStartRun()">‚ñ∂ Start Commenting</button>
      </div>
    </div>

    <!-- Progress bar -->
    <div class="prog-wrap" id="bc-prog-wrap" style="display:none">
      <div class="prog-fill" id="bc-prog-fill"></div>
    </div>
    <div id="bc-prog-label" style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:8px;display:none"></div>

    <!-- Terminal -->
    <div class="terminal" id="bc-terminal" style="height:320px">
      <span class="tm">// Click "Start Commenting" to begin. The tool will visit each site, open it, fill the comment form fields, and log progress here in real time...</span>
    </div>

    <!-- Log below terminal -->
    <div style="margin-top:12px">
      <div class="card-title">üìã Session Log</div>
      <div id="bc-log" style="max-height:180px;overflow-y:auto">${bcRenderLog()}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="bcExportLog()">üì§ Export CSV</button>
        <button class="btn btn-danger btn-sm" onclick="_bcLog=[];bcRefresh()">Clear Log</button>
      </div>
    </div>
  </div>`;

  document.getElementById('bc-url').addEventListener('keydown',e=>{ if(e.key==='Enter') bcAddSite(); });
}

// ‚îÄ‚îÄ URL List Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _bcPendingUrls = []; // URLs from current upload not yet saved

function bcRenderUrlLists(){
  if(!_bcUrlLists.length) return '<p class="tm mono xs">No saved URL lists yet. Upload a .txt file above.</p>';
  return _bcUrlLists.map(list=>`
    <div style="border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:7px;background:var(--bg)">
      <div class="flex aic g8" style="margin-bottom:6px">
        <span style="font-size:13px">üìã</span>
        <span class="mono xs" style="flex:1;font-weight:700;color:var(--text)">${esc(list.name)}</span>
        <span class="badge badge-b">${list.urls.length} URLs</span>
        <span class="tm mono" style="font-size:9px">${list.saved}</span>
      </div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:8px;max-height:60px;overflow:hidden;line-height:1.8">
        ${list.urls.slice(0,5).map(u=>`<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(u)}</div>`).join('')}
        ${list.urls.length>5?`<div style="color:var(--accent)">+ ${list.urls.length-5} more...</div>`:''}
      </div>
      <div class="flex g8">
        <button class="btn btn-primary btn-sm f1" onclick="bcPushListToQueue('${list.id}')">‚ûï Push to Target Sites</button>
        <button class="btn btn-ghost btn-sm" onclick="bcViewList('${list.id}')">üëÅ View</button>
        <button class="btn btn-danger btn-sm" onclick="bcDeleteList('${list.id}')">‚úï</button>
      </div>
    </div>`).join('');
}

function bcDragOver(e){ e.preventDefault(); document.getElementById('bc-drop-zone').style.borderColor='var(--accent)'; }
function bcDragLeave(e){ document.getElementById('bc-drop-zone').style.borderColor='var(--border2)'; }
function bcDrop(e){
  e.preventDefault();
  document.getElementById('bc-drop-zone').style.borderColor='var(--border2)';
  const file=e.dataTransfer.files[0];
  if(file) bcReadFile(file);
}
function bcFileSelected(input){
  const file=input.files[0];
  if(file) bcReadFile(file);
  input.value='';
}
function bcReadFile(file){
  if(!file.name.endsWith('.txt')&&file.type&&!file.type.includes('text')){ alert('Please upload a .txt file.'); return; }
  const reader=new FileReader();
  reader.onload=e=>{
    const text=e.target.result;
    const urls=text.split('\n').map(u=>u.trim()).filter(u=>/^https?:\/\//i.test(u));
    if(!urls.length){ alert('No valid URLs found. Make sure each line starts with http:// or https://'); return; }
    _bcPendingUrls=urls;
    // Pre-fill list name from filename
    const nameEl=document.getElementById('bc-list-name');
    if(nameEl&&!nameEl.value) nameEl.value=file.name.replace(/\.txt$/i,'');
    // Show preview in drop zone
    const dz=document.getElementById('bc-drop-zone');
    if(dz) dz.innerHTML=`<div style="font-size:20px;margin-bottom:4px">‚úÖ</div><div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:700">${esc(file.name)}</div><div style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-top:2px">${urls.length} valid URLs loaded ¬∑ Click "Save List" to store</div>`;
    bcTermLog(`üìÇ Loaded "${esc(file.name)}" ‚Äî ${urls.length} URLs ready.`,'accent');
  };
  reader.readAsText(file);
}
function bcSaveCurrentList(){
  if(!_bcPendingUrls.length){ alert('No URLs loaded. Upload a .txt file first.'); return; }
  const nameEl=document.getElementById('bc-list-name');
  const name=(nameEl&&nameEl.value.trim())||('URL List '+(new Date().toLocaleDateString()));
  const list={ id:uid(), name, urls:[..._bcPendingUrls], saved:ts() };
  _bcUrlLists.push(list);
  bcSaveUrlLists();
  _bcPendingUrls=[];
  if(nameEl) nameEl.value='';
  const dz=document.getElementById('bc-drop-zone');
  if(dz) dz.innerHTML=`<div style="font-size:24px;margin-bottom:6px">üìÑ</div><div style="font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">Click or drag & drop a .txt file here</div><div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px">One URL per line ¬∑ https:// format</div>`;
  const lr=document.getElementById('bc-url-lists-render');
  if(lr) lr.innerHTML=bcRenderUrlLists();
  bcTermLog(`üíæ Saved list "${esc(name)}" with ${list.urls.length} URLs.`,'success');
}
function bcPushListToQueue(listId){
  const list=_bcUrlLists.find(l=>l.id===listId);
  if(!list) return;
  let added=0;
  list.urls.forEach(url=>{
    if(!_bcSites.find(s=>s.url===url)){
      _bcSites.push({id:uid(),url,label:url,type:'wordpress',name:'',email:'',website:'',notes:'',done:false,queued:''});
      added++;
    }
  });
  bcSave();
  bcLog(`Pushed ${added} URLs from "${list.name}" to target sites.`,'success');
  bcTermLog(`‚ûï Added ${added} new URLs from "${esc(list.name)}" to Target Sites queue.`,'success');
  bcRefresh();
}
function bcViewList(listId){
  const list=_bcUrlLists.find(l=>l.id===listId);
  if(!list) return;
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`<div class="modal-box" style="min-width:520px;max-width:700px">
    <div class="modal-title">üìã ${esc(list.name)} <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï Close</button></div>
    <div class="notice notice-info" style="margin-bottom:12px">${list.urls.length} URLs ¬∑ Saved ${list.saved}</div>
    <div style="max-height:400px;overflow-y:auto;font-family:var(--mono);font-size:11px;line-height:2">
      ${list.urls.map((u,i)=>`<div style="display:flex;gap:10px;padding:4px 8px;border-bottom:1px solid var(--border);${i%2===0?'background:var(--bg)':''}">
        <span style="color:var(--muted);font-size:9px;flex-shrink:0;padding-top:2px">${i+1}</span>
        <a href="${esc(u)}" target="_blank" style="color:var(--accent);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(u)}</a>
      </div>`).join('')}
    </div>
    <div class="row" style="margin-top:14px">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-primary" onclick="bcPushListToQueue('${list.id}');this.closest('.modal-overlay').remove()">‚ûï Push All to Target Sites</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}
function bcDeleteList(listId){
  if(!confirm('Delete this URL list?')) return;
  _bcUrlLists=_bcUrlLists.filter(l=>l.id!==listId);
  bcSaveUrlLists();
  const lr=document.getElementById('bc-url-lists-render');
  if(lr) lr.innerHTML=bcRenderUrlLists();
}

// ‚îÄ‚îÄ Terminal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bcTermLog(msg, type='info'){
  _bcTermLines.push({msg, type, time:ts()});
  const term=document.getElementById('bc-terminal');
  if(!term) return;
  const colorMap={
    info:'#c9d1d9', success:'#3fb950', error:'#f85149',
    warn:'#d29922', accent:'#58a6ff', muted:'#484f58'
  };
  const div=document.createElement('div');
  div.className='tline';
  div.style.animation='slideIn 0.2s ease';
  div.innerHTML=`<span class="ttime">${ts()}</span><span style="color:${colorMap[type]||'#c9d1d9'}">${msg}</span>`;
  // Remove placeholder if present
  const placeholder=term.querySelector('.tm');
  if(placeholder&&placeholder.tagName!=='DIV') placeholder.remove();
  term.appendChild(div);
  term.scrollTop=term.scrollHeight;
}
function bcTermClear(){
  _bcTermLines=[];
  const term=document.getElementById('bc-terminal');
  if(term) term.innerHTML='<span class="tm">// Terminal cleared. Ready.</span>';
}
function bcTermSeparator(label){
  const term=document.getElementById('bc-terminal');
  if(!term) return;
  const div=document.createElement('div');
  div.style.cssText='display:flex;align-items:center;gap:8px;margin:6px 0;font-family:var(--mono);font-size:9px;color:#484f58';
  div.innerHTML=`<span style="flex:1;height:1px;background:#21262d"></span><span>${label||'‚îÄ'}</span><span style="flex:1;height:1px;background:#21262d"></span>`;
  term.appendChild(div);
  term.scrollTop=term.scrollHeight;
}

// ‚îÄ‚îÄ Auto-Commenter Runner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ PROXY FETCH HELPER v3 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Tries multiple CORS proxies in order, returns {ok, text, status}
// Custom proxy endpoint can be set by user (Cloudflare Worker, etc.)
let _bcCustomProxy = localStorage.getItem('bc_custom_proxy')||'';

function bcGetProxyList(targetUrl, isPost){
  const enc = encodeURIComponent(targetUrl);
  const custom = _bcCustomProxy.trim();
  const list = [];

  // Custom proxy first (user-provided Cloudflare Worker or similar)
  if(custom){
    list.push({ url: custom.replace('{URL}', enc).replace('{url}', enc) || `${custom}?url=${enc}`, passBody: isPost, label:'custom' });
  }

  if(isPost){
    list.push(
      { url: `https://corsproxy.io/?${enc}`, passBody: true, label:'corsproxy' },
      { url: `https://proxy.cors.sh/${targetUrl}`, passBody: true, label:'cors.sh', extraHeaders:{'x-cors-api-key':'temp_'} },
      { url: `https://api.allorigins.win/raw?url=${enc}`, passBody: true, label:'allorigins-raw' },
      { url: `https://thingproxy.freeboard.io/fetch/${targetUrl}`, passBody: true, label:'thingproxy' },
      { url: `https://crossorigin.me/${targetUrl}`, passBody: true, label:'crossorigin' },
      { url: `https://cors-anywhere-demo.herokuapp.com/${targetUrl}`, passBody: true, label:'heroku' },
      { url: `https://yacdn.org/serve/${targetUrl}`, passBody: true, label:'yacdn' },
    );
  } else {
    list.push(
      { url: `https://api.allorigins.win/get?url=${enc}`, json: true, label:'allorigins' },
      { url: `https://corsproxy.io/?${enc}`, passBody: false, label:'corsproxy' },
      { url: `https://api.allorigins.win/raw?url=${enc}`, passBody: false, label:'allorigins-raw' },
      { url: `https://proxy.cors.sh/${targetUrl}`, passBody: false, label:'cors.sh', extraHeaders:{'x-cors-api-key':'temp_'} },
      { url: `https://thingproxy.freeboard.io/fetch/${targetUrl}`, passBody: false, label:'thingproxy' },
      { url: `https://api.codetabs.com/v1/proxy?quest=${enc}`, passBody: false, label:'codetabs' },
      { url: `https://crossorigin.me/${targetUrl}`, passBody: false, label:'crossorigin.me' },
      { url: `https://yacdn.org/serve/${targetUrl}`, passBody: false, label:'yacdn' },
      { url: `https://cors.eu.org/${targetUrl}`, passBody: false, label:'cors.eu.org' },
      { url: `https://corsproxy.org/?${enc}`, passBody: false, label:'corsproxy.org' },
      { url: `https://api.codetabs.com/v1/proxy?quest=${enc}`, passBody: false, label:'codetabs2' },
      { url: `https://corsproxy.club/?${targetUrl}`, passBody: false, label:'corsproxy.club' },
    );
  }
  return list;
}

async function bcProxyFetch(targetUrl, opts={}){
  const isPost = opts.method && opts.method.toUpperCase()==='POST';
  const proxies = bcGetProxyList(targetUrl, isPost);
  const timeout = opts.timeout || 16000;

  for(const proxy of proxies){
    try {
      const fetchOpts = {
        method: opts.method||'GET',
        headers: {
          ...(opts.contentType ? {'Content-Type': opts.contentType} : {}),
          ...(proxy.extraHeaders||{}),
          ...(opts.extraHeaders||{})
        },
      };
      // Set content-type for POST
      if(isPost && !fetchOpts.headers['Content-Type']){
        fetchOpts.headers['Content-Type'] = opts.contentType || 'application/x-www-form-urlencoded';
      }
      if(opts.asJson) fetchOpts.headers['Content-Type'] = 'application/json';

      if(isPost && proxy.passBody && opts.body){
        fetchOpts.body = opts.body;
      }

      const resp = await Promise.race([
        fetch(proxy.url, fetchOpts),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Proxy timeout')),timeout))
      ]);

      let text = '';
      if(proxy.json && resp.ok){
        try{ const d=await resp.json(); text=d.contents||''; }catch(e){ text=await resp.text(); }
      } else {
        text = await resp.text();
      }

      // Consider 4xx/5xx as failed for GET (for POST we check caller)
      if(!isPost && !resp.ok && resp.status >= 500){ continue; }

      return { ok: resp.ok, status: resp.status, text, redirected: resp.redirected, proxy: proxy.label||proxy.url };
    } catch(e){
      continue;
    }
  }
  return { ok: false, status: 0, text: '', error: 'All proxies exhausted' };
}

// ‚îÄ‚îÄ WORDPRESS POST ID DETECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bcExtractWpPostId(html, pageUrl){
  // Method 1: Look for comment_post_ID in hidden input
  const m1 = html.match(/name=["']comment_post_ID["'][^>]*value=["'](\d+)["']/i)
           || html.match(/value=["'](\d+)["'][^>]*name=["']comment_post_ID["']/i);
  if(m1) return m1[1];

  // Method 2: Look in body class "postid-XXXX"
  const m2 = html.match(/postid-(\d+)/);
  if(m2) return m2[1];

  // Method 3: Look in shortlink or canonical
  const m3 = html.match(/[?&]p=(\d+)/);
  if(m3) return m3[1];

  // Method 4: Look for wp-json link with post ID
  const m4 = html.match(/\/wp-json\/wp\/v2\/posts\/(\d+)/);
  if(m4) return m4[1];

  // Method 5: Look in articleBody / page meta
  const m5 = html.match(/"@type"\s*:\s*"(?:BlogPosting|Article)"[\s\S]{0,500}"identifier"\s*:\s*"?(\d+)"?/);
  if(m5) return m5[1];

  return null;
}

// ‚îÄ‚îÄ WORDPRESS REST API COMMENTER (PRIMARY) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bcWpRestComment(pageUrl, postId, name, email, website, comment){
  const origin = new URL(pageUrl).origin;
  const restEndpoint = `${origin}/wp-json/wp/v2/comments`;

  const payload = {
    post: parseInt(postId)||0,
    author_name: name,
    author_email: email,
    content: comment,
  };
  if(website) payload.author_url = website;

  const body = JSON.stringify(payload);

  // Try multiple proxies for JSON POST
  const proxyTargets = [
    { url: restEndpoint, direct: true },
    { url: `https://corsproxy.io/?${encodeURIComponent(restEndpoint)}`, direct: false },
    { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(restEndpoint)}`, direct: false },
    { url: `https://thingproxy.freeboard.io/fetch/${restEndpoint}`, direct: false },
    { url: `https://proxy.cors.sh/${restEndpoint}`, direct: false, extraHeaders:{'x-cors-api-key':'temp_'} },
  ];
  if(_bcCustomProxy){
    const enc = encodeURIComponent(restEndpoint);
    proxyTargets.unshift({ url: _bcCustomProxy.replace('{URL}',enc).replace('{url}',enc) || `${_bcCustomProxy}?url=${enc}`, direct:false });
  }

  for(const proxy of proxyTargets){
    try {
      const resp = await Promise.race([
        fetch(proxy.url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(proxy.extraHeaders||{}) },
          body
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),16000))
      ]);

      const text = await resp.text();
      let json = null;
      try{ json = JSON.parse(text); }catch(e){}

      if(resp.status===201 || resp.status===200){
        const status = json && json.status;
        if(status==='hold') return { success:true, moderated:true, msg:'Comment queued for moderation (REST API)' };
        return { success:true, moderated:false, msg:`Comment posted via REST API (ID: ${json&&json.id||'?'})` };
      }
      if(resp.status===403 && json && json.code==='comment_flood'){
        return { success:false, moderated:false, msg:'Flood protection ‚Äî too many comments too fast' };
      }
      if(resp.status===409){
        return { success:true, moderated:false, msg:'Duplicate comment ‚Äî already posted' };
      }
      // 401/403 = auth needed, 404 = no REST, fallback to legacy
      if(resp.status===401 || resp.status===403 || resp.status===404){
        return { success:false, moderated:false, msg:`REST API returned ${resp.status}`, tryLegacy:true };
      }
    } catch(e){ continue; }
  }
  return { success:false, moderated:false, msg:'REST API unreachable via all proxies', tryLegacy:true };
}

// ‚îÄ‚îÄ LEGACY wp-comments-post.php ENGINE v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bcWpLegacyComment(pageUrl, html, name, email, website, comment){
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // Find the comment form ‚Äî try many selectors
  const form =
    doc.querySelector('form#commentform') ||
    doc.querySelector('form.comment-form') ||
    doc.querySelector('form[action*="wp-comments-post"]') ||
    doc.querySelector('#respond form') ||
    doc.querySelector('form[id*="comment"]') ||
    doc.querySelector('form[class*="comment"]') ||
    doc.querySelector('#comments form') ||
    doc.querySelector('.comments form') ||
    doc.querySelector('form');

  // Determine POST endpoint
  let postUrl = '';
  try {
    const base = new URL(pageUrl);
    const action = form ? (form.getAttribute('action')||'') : '';
    if(!form || !action || action===pageUrl){ postUrl = base.origin + '/wp-comments-post.php'; }
    else if(action.startsWith('http')){ postUrl = action; }
    else if(action.startsWith('/')){ postUrl = base.origin + action; }
    else { postUrl = base.origin + '/' + action; }
  } catch(e){ postUrl = new URL(pageUrl).origin + '/wp-comments-post.php'; }

  // Build URLSearchParams ‚Äî start with ALL hidden fields (captures nonces, akismet tokens, etc.)
  const params = new URLSearchParams();
  if(form){
    form.querySelectorAll('input[type="hidden"], input[type="submit"]').forEach(inp=>{
      const n = inp.getAttribute('name');
      const v = inp.getAttribute('value')||'';
      if(n) params.set(n, v);
    });
  }

  // Post ID ‚Äî try form first, then page-wide extraction
  const postIdField = form && form.querySelector('input[name="comment_post_ID"]');
  const postId = (postIdField && postIdField.value) || bcExtractWpPostId(html, pageUrl) || '1';
  params.set('comment_post_ID', postId);

  // Standard WP comment fields
  params.set('author', name);
  params.set('email', email);
  params.set('url', website||'');
  params.set('comment', comment);
  params.set('comment_parent', '0');
  params.set('submit', 'Post Comment');

  // Map any renamed field names the theme might use
  if(form){
    form.querySelectorAll('input[type="text"], input[type="email"], input[type="url"], textarea').forEach(inp=>{
      const n = (inp.getAttribute('name')||'').toLowerCase();
      const id = (inp.getAttribute('id')||'').toLowerCase();
      const realName = inp.getAttribute('name');
      if(!realName) return;
      if(n==='author'||id==='author'||n.includes('name')||id.includes('name')) params.set(realName, name);
      else if(n==='email'||id==='email'||n.includes('email')) params.set(realName, email);
      else if(n==='url'||id==='url'||n.includes('website')||n.includes('link')) params.set(realName, website||'');
      else if(n==='comment'||inp.tagName==='TEXTAREA'||n.includes('comment')||n.includes('message')) params.set(realName, comment);
    });
  }

  // Referrer header mimics a real browser navigating from the post page
  const proxyTargets = [
    `https://corsproxy.io/?${encodeURIComponent(postUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(postUrl)}`,
    `https://thingproxy.freeboard.io/fetch/${postUrl}`,
    `https://proxy.cors.sh/${postUrl}`,
    `https://crossorigin.me/${postUrl}`,
    `https://yacdn.org/serve/${postUrl}`,
  ];
  if(_bcCustomProxy){
    const enc = encodeURIComponent(postUrl);
    proxyTargets.unshift(_bcCustomProxy.replace('{URL}',enc).replace('{url}',enc) || `${_bcCustomProxy}?url=${enc}`);
  }

  for(const proxyUrl of proxyTargets){
    try {
      const resp = await Promise.race([
        fetch(proxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Referer': pageUrl,
            'Origin': new URL(pageUrl).origin,
          },
          body: params.toString()
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),18000))
      ]);

      const text = await resp.text();
      const lower = text.toLowerCase();

      if(resp.redirected || resp.status===302 || resp.status===301){
        if(lower.includes('moderate')||lower.includes('pending')||lower.includes('awaiting')){
          return { success:true, moderated:true, msg:'Submitted ‚Äî awaiting moderation' };
        }
        return { success:true, moderated:false, msg:'Comment posted (server redirected = success)' };
      }

      if(resp.status===200){
        if(lower.includes('your comment is awaiting')||lower.includes('pending moderation')){
          return { success:true, moderated:true, msg:'Comment submitted ‚Äî pending moderation' };
        }
        if(lower.includes('duplicate')||lower.includes('already said that')){
          return { success:true, moderated:false, msg:'Duplicate ‚Äî already posted' };
        }
        // Strong success signals
        if(
          lower.includes('comment-')||lower.includes('commentlist')||
          lower.includes('#comment-')||lower.includes('comment posted')||
          lower.includes('thanks for')
        ){
          return { success:true, moderated:false, msg:'Comment posted (HTTP 200, success signals detected)' };
        }
        // WP error signals
        if(lower.includes('wp-die')||lower.includes('<p>sorry')||lower.includes('error')){
          const errMatch = text.match(/<p[^>]*>([\s\S]{10,300}?)<\/p>/i);
          const errMsg = errMatch ? errMatch[1].replace(/<[^>]+>/g,'').trim() : 'WordPress returned an error';
          return { success:false, moderated:false, msg:`WP Error: ${errMsg.slice(0,150)}` };
        }
        // Ambiguous 200 ‚Äî treat as likely success
        return { success:true, moderated:true, msg:'Submitted (HTTP 200 ‚Äî verify on site to confirm)' };
      }

      if(resp.status===403) return { success:false, moderated:false, msg:'403 Forbidden ‚Äî nonce expired, spam filter, or Cloudflare blocking' };
      if(resp.status===404) return { success:false, moderated:false, msg:'404 ‚Äî wp-comments-post.php not found on this site' };
      if(resp.status===429) return { success:false, moderated:false, msg:'429 Rate limited ‚Äî wait before retrying' };
      if(resp.status===409) return { success:true, moderated:false, msg:'409 Conflict ‚Äî likely duplicate, comment may already exist' };
      if(resp.status>=500){ continue; } // server error, try next proxy

    } catch(e){ continue; }
  }
  return { success:false, moderated:false, msg:'All POST proxies failed ‚Äî site may be blocking proxy IPs or require CAPTCHA. Use Manual Assist mode.' };
}

// ‚îÄ‚îÄ GENERIC / NON-WP COMMENT ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bcGenericComment(pageUrl, html, name, email, website, comment, logFn){
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // Find ANY form on the page that looks like a comment form
  const allForms = Array.from(doc.querySelectorAll('form'));
  let form = null;
  for(const f of allForms){
    const fHtml = f.innerHTML.toLowerCase();
    if(
      fHtml.includes('comment') || fHtml.includes('message') ||
      fHtml.includes('reply') || fHtml.includes('author') ||
      f.id.toLowerCase().includes('comment') ||
      (f.className||'').toLowerCase().includes('comment')
    ){ form = f; break; }
  }
  if(!form && allForms.length>0) form = allForms[0]; // last resort, take first form
  if(!form) return { success:false, moderated:false, msg:'No comment/contact form found on page' };

  let postUrl = '';
  try {
    const base = new URL(pageUrl);
    const action = form.getAttribute('action')||'';
    if(!action||action==='#'||action===pageUrl){ postUrl = pageUrl; }
    else if(action.startsWith('http')){ postUrl = action; }
    else if(action.startsWith('/')){ postUrl = base.origin + action; }
    else { postUrl = base.origin + '/' + action; }
  } catch(e){ postUrl = pageUrl; }

  const params = new URLSearchParams();
  // Capture all hidden fields (CSRF tokens, etc.)
  form.querySelectorAll('input[type="hidden"]').forEach(inp=>{
    if(inp.name) params.set(inp.name, inp.value||'');
  });

  // Intelligently map fields
  form.querySelectorAll('input, textarea, select').forEach(inp=>{
    const n = (inp.getAttribute('name')||'').toLowerCase();
    const id = (inp.getAttribute('id')||'').toLowerCase();
    const ph = (inp.getAttribute('placeholder')||'').toLowerCase();
    const realName = inp.getAttribute('name');
    if(!realName||inp.type==='hidden'||inp.type==='submit'||inp.type==='button'||inp.type==='checkbox'||inp.type==='radio') return;

    const isName = n.includes('name')||n.includes('author')||id.includes('name')||id.includes('author')||ph.includes('name');
    const isEmail = n.includes('email')||n.includes('mail')||id.includes('email')||ph.includes('email');
    const isWeb = n.includes('url')||n.includes('site')||n.includes('web')||id.includes('url')||ph.includes('url')||ph.includes('website');
    const isMsg = n.includes('comment')||n.includes('message')||n.includes('content')||n.includes('body')||n.includes('text')||inp.tagName==='TEXTAREA'||id.includes('comment')||id.includes('message');

    if(isName) params.set(realName, name);
    else if(isEmail) params.set(realName, email);
    else if(isWeb) params.set(realName, website||'');
    else if(isMsg) params.set(realName, comment);
  });

  // Add submit value
  const submitBtn = form.querySelector('input[type="submit"], button[type="submit"]');
  if(submitBtn && submitBtn.name) params.set(submitBtn.name, submitBtn.value||'Submit');

  logFn(`   ‚Üí Generic form POST to: ${postUrl.slice(0,80)}...`,'info');

  const proxyTargets = [
    `https://corsproxy.io/?${encodeURIComponent(postUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(postUrl)}`,
    `https://thingproxy.freeboard.io/fetch/${postUrl}`,
    `https://proxy.cors.sh/${postUrl}`,
  ];
  if(_bcCustomProxy){
    const enc = encodeURIComponent(postUrl);
    proxyTargets.unshift(_bcCustomProxy.replace('{URL}',enc).replace('{url}',enc) || `${_bcCustomProxy}?url=${enc}`);
  }

  for(const proxyUrl of proxyTargets){
    try {
      const resp = await Promise.race([
        fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Referer': pageUrl },
          body: params.toString()
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),16000))
      ]);
      const text = await resp.text();
      const lower = text.toLowerCase();
      if(resp.status===201||resp.redirected||(resp.status===200&&(lower.includes('thank')||lower.includes('success')||lower.includes('posted')||lower.includes('received')||lower.includes('submitt')))){
        return { success:true, moderated:false, msg:`Generic form submitted (HTTP ${resp.status})` };
      }
      if(resp.status>=200&&resp.status<400){
        return { success:true, moderated:true, msg:`Submitted (HTTP ${resp.status}) ‚Äî verify on site` };
      }
    } catch(e){ continue; }
  }
  return { success:false, moderated:false, msg:'Generic POST failed ‚Äî site likely blocks proxy IPs. Use Manual Assist.' };
}

// ‚îÄ‚îÄ MANUAL ASSIST LAUNCHER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function bcManualAssist(site, name, email, website, comment){
  // Copy comment to clipboard
  navigator.clipboard.writeText(comment).catch(()=>{
    const ta = document.createElement('textarea');
    ta.value = comment;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
  });

  // Open site in new tab
  const tab = window.open(site.url, '_blank');

  // Show instructions modal
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `<div class="modal-box" style="min-width:520px;max-width:680px">
    <div class="modal-title">ü§ù Manual Assist Mode ‚Äî ${esc(site.label||site.url)} <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div>
    <div class="notice notice-success" style="margin-bottom:12px">‚úÖ Comment copied to clipboard! Site opened in new tab.</div>
    <div class="card-title" style="margin-bottom:8px">Your Comment Identity</div>
    <div class="grid2" style="margin-bottom:10px">
      <div style="background:var(--bg);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-family:var(--mono);font-size:11px">
        <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:3px">NAME</div>
        <div style="font-weight:700;color:var(--text)">${esc(name)}</div>
      </div>
      <div style="background:var(--bg);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-family:var(--mono);font-size:11px">
        <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:3px">EMAIL</div>
        <div style="font-weight:700;color:var(--text)">${esc(email)}</div>
      </div>
      ${website?`<div style="background:var(--bg);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-family:var(--mono);font-size:11px;grid-column:1/-1">
        <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:3px">WEBSITE</div>
        <div style="font-weight:700;color:var(--accent)">${esc(website)}</div>
      </div>`:''}
    </div>
    <div style="background:var(--bg);border:1px solid var(--border);padding:10px 12px;border-radius:6px;margin-bottom:12px">
      <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:4px;font-family:var(--mono)">COMMENT (ALREADY IN CLIPBOARD)</div>
      <div style="font-family:var(--mono);font-size:11px;line-height:1.7;color:var(--text);font-weight:600">${esc(comment)}</div>
    </div>
    <div class="notice notice-warn" style="margin-bottom:12px">
      <strong>Steps:</strong> 1. Switch to the new tab ¬∑ 2. Scroll to the Comments section ¬∑ 3. Fill Name, Email, Website ¬∑ 4. Paste comment (Ctrl+V) ¬∑ 5. Click Submit
    </div>
    <div class="row">
      <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(${JSON.stringify(comment)}).then(()=>bcTermLog('Comment re-copied!','success'))">üìã Re-copy Comment</button>
      <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(${JSON.stringify(name+'\n'+email+(website?'\n'+website:'')+'\n\n'+comment)}).then(()=>bcTermLog('All fields copied!','success'))">üìã Copy All Fields</button>
      <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove();bcMarkDone('${site.id}')">‚úÖ Mark as Done</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

// ‚îÄ‚îÄ MAIN COMMENT ORCHESTRATOR v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bcCommentOnSite(site, name, email, website, comment, logFn){
  const url = site.url;
  const siteType = (site.type||'generic').toLowerCase();

  // ‚îÄ‚îÄ STEP 1: Detect WordPress via REST API discovery ‚îÄ‚îÄ
  logFn(`   ‚Üí Probing site type and REST API...`,'info');
  const origin = new URL(url).origin;
  const wpJsonUrl = `${origin}/wp-json/`;

  let isWordPress = false;
  let wpPostId = null;

  try {
    const probe = await bcProxyFetch(wpJsonUrl, { timeout: 10000 });
    if(probe.ok && (probe.text.includes('"namespaces"') || probe.text.includes('wp/v2'))){
      isWordPress = true;
      logFn(`   ‚úì WordPress detected (REST API active)`,'success');
    } else if(probe.text.includes('wp-content')||probe.text.includes('wp-includes')||probe.text.includes('wordpress')){
      isWordPress = true;
      logFn(`   ‚úì WordPress detected (HTML fingerprint)`,'success');
    }
  } catch(e){}

  // Force WP detection from site type field
  if(siteType==='wordpress') isWordPress = true;

  // ‚îÄ‚îÄ STEP 2: Fetch the actual page ‚îÄ‚îÄ
  logFn(`   ‚Üí Fetching page HTML...`,'info');
  let html = '';
  let fetchOk = false;

  const pageResult = await bcProxyFetch(url, { timeout: 18000 });
  if(pageResult.ok && pageResult.text.length > 200){
    html = pageResult.text;
    fetchOk = true;
    logFn(`   ‚úì Page fetched (${(html.length/1024).toFixed(1)} KB) via [${pageResult.proxy}]`,'success');

    if(!isWordPress && (html.includes('wp-content')||html.includes('wp-includes')||html.includes('/wp-json/'))){
      isWordPress = true;
      logFn(`   ‚úì WordPress confirmed from page content`,'success');
    }
  } else {
    logFn(`   ‚ö† Page fetch failed (${pageResult.status||pageResult.error||'network error'})`,'warn');
  }

  // ‚îÄ‚îÄ STEP 3: Extract post ID ‚îÄ‚îÄ
  if(html) {
    wpPostId = bcExtractWpPostId(html, url);
    if(wpPostId) logFn(`   ‚úì Post ID: ${wpPostId}`,'success');
  }

  // ‚îÄ‚îÄ STEP 4: REST API slug lookup if no post ID ‚îÄ‚îÄ
  if(isWordPress && !wpPostId){
    try {
      const slug = url.split('/').filter(Boolean).pop().replace(/[?#].*$/,'');
      const lookupUrl = `${origin}/wp-json/wp/v2/posts?slug=${encodeURIComponent(slug)}&_fields=id,slug`;
      const lookup = await bcProxyFetch(lookupUrl, { timeout: 10000 });
      if(lookup.ok){
        try{
          const posts = JSON.parse(lookup.text);
          if(Array.isArray(posts) && posts.length > 0){
            wpPostId = String(posts[0].id);
            logFn(`   ‚úì Post ID found via REST slug lookup: ${wpPostId}`,'success');
          }
        }catch(e){}
      }
    } catch(e){}
  }

  // ‚îÄ‚îÄ STEP 5: Try WordPress REST API ‚îÄ‚îÄ
  if(isWordPress && wpPostId){
    logFn(`   ‚Üí Attempting WordPress REST API...`,'info');
    const restResult = await bcWpRestComment(url, wpPostId, name, email, website, comment);
    if(restResult.success) return restResult;
    if(!restResult.tryLegacy) return restResult;
    logFn(`   ‚ö† REST API blocked ‚Äî falling back to form POST`,'warn');
  }

  // ‚îÄ‚îÄ STEP 6: Legacy form POST (WordPress & generic) ‚îÄ‚îÄ
  if(html){
    logFn(`   ‚Üí Attempting form POST...`,'info');
    if(isWordPress){
      return await bcWpLegacyComment(url, html, name, email, website, comment);
    } else {
      return await bcGenericComment(url, html, name, email, website, comment, logFn);
    }
  }

  // ‚îÄ‚îÄ STEP 7: Blind WP attempt ‚îÄ‚îÄ
  if(isWordPress){
    logFn(`   ‚Üí Last resort: blind wp-comments-post.php POST...`,'info');
    const fakeHtml = `<form action="${origin}/wp-comments-post.php"><input name="comment_post_ID" value="1"><input name="author"><input name="email"><input name="url"><textarea name="comment"></textarea></form>`;
    return await bcWpLegacyComment(url, fakeHtml, name, email, website, comment);
  }

  // ‚îÄ‚îÄ STEP 8: Absolute fallback ‚Äî blind form POST to page URL ‚îÄ‚îÄ
  logFn(`   ‚Üí Fallback: blind POST to page URL...`,'info');
  const fallbackHtml = `<form action="${url}"><input name="name"><input name="email"><input name="url"><textarea name="comment"></textarea></form>`;
  return await bcGenericComment(url, fallbackHtml, name, email, website, comment, logFn);
}

async function bcStartRun(){
  if(_bcRunning){ alert('Already running!'); return; }
  const pending=_bcSites.filter(s=>!s.done);
  if(!pending.length){ alert('No pending sites. Add sites or push a URL list first.'); return; }

  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const name=(document.getElementById('bc-gen-name')||{value:'A Reader'}).value.trim()||'A Reader';
  const email=(document.getElementById('bc-email')||{value:''}).value.trim();
  const website=(document.getElementById('bc-website')||{value:''}).value.trim();
  const delay=parseInt((document.getElementById('bc-delay')||{value:'3000'}).value)||3000;
  const manualFallback=(document.getElementById('bc-manual-fallback')||{checked:false}).checked;

  // Save custom proxy setting
  const customProxy=(document.getElementById('bc-custom-proxy')||{value:''}).value.trim();
  if(customProxy!==_bcCustomProxy){ _bcCustomProxy=customProxy; localStorage.setItem('bc_custom_proxy',customProxy); }

  if(!name){ alert('Display name is required.'); return; }
  if(!email){ alert('Email is required for commenting.'); return; }

  const commentEl=document.getElementById('bc-gen-out');
  if(!commentEl||!commentEl.value.trim()) bcGenerate();
  const baseComment=(document.getElementById('bc-gen-out')||{value:''}).value.trim()||bcGenComment(kw,'',name);

  _bcRunning=true; _bcStop=false; _bcSessionResults=[];

  document.getElementById('bc-start-btn').disabled=true;
  document.getElementById('bc-stop-btn').style.display='';
  document.getElementById('bc-run-badge').style.display='';
  document.getElementById('bc-prog-wrap').style.display='';
  document.getElementById('bc-prog-label').style.display='';

  bcTermSeparator('‚ñ∂ SESSION START');
  bcTermLog(`üöÄ Starting Auto Commenter ‚Äî ${pending.length} sites queued`,'accent');
  bcTermLog(`üë§ Identity: ${esc(name)} | ${esc(email)} | ${esc(website||'no website')}`,'info');
  bcTermLog(`üí¨ Base comment: "${esc(baseComment.slice(0,80))}${baseComment.length>80?'...':''}"`, 'info');
  bcTermLog(`‚öô Engine: WP REST API ‚Üí Legacy form POST ‚Üí Generic POST ‚Üí Manual Assist (8 proxies)`, 'accent');
  bcTermSeparator('');

  let done=0, success=0, failed=0;
  const total=pending.length;

  for(let i=0;i<pending.length;i++){
    if(_bcStop){ bcTermLog('‚èπ Stopped by user.','warn'); break; }

    const site=pending[i];
    const siteComment=site.queued||bcGenComment(kw,site.url,site.name||name);
    const siteName=site.name||name;
    const siteEmail=site.email||email;
    const siteWebsite=site.website||website;

    const pct=Math.round(((i+1)/total)*100);
    const pf=document.getElementById('bc-prog-fill');
    const pl=document.getElementById('bc-prog-label');
    if(pf) pf.style.width=pct+'%';
    if(pl) pl.textContent=`Site ${i+1}/${total} ‚Äî ${pct}%`;

    bcTermSeparator(`SITE ${i+1}/${total}`);
    bcTermLog(`üåê ${esc(site.url)}`,'accent');

    let result={url:site.url, label:site.label||site.url, status:'failed', reason:'', comment:siteComment};

    try{
      const postResult = await bcCommentOnSite(site, siteName, siteEmail, siteWebsite, siteComment, (msg,type)=>bcTermLog(msg,type));

      if(postResult.success && !postResult.moderated){
        bcTermLog(`   ‚úÖ COMMENT POSTED!`,'success');
        bcTermLog(`   ‚Üí ${esc(postResult.msg)}`,'muted');
        result.status='success'; result.reason=postResult.msg;
        site.done=true; site.queued=siteComment; bcSave();
        success++;
      } else if(postResult.success && postResult.moderated){
        bcTermLog(`   ‚è≥ Comment submitted ‚Äî awaiting moderation`,'success');
        bcTermLog(`   ‚Üí ${esc(postResult.msg)}`,'muted');
        result.status='moderated'; result.reason=postResult.msg;
        site.done=true; site.queued=siteComment; bcSave();
        success++;
      } else {
        bcTermLog(`   ‚úó Failed: ${esc(postResult.msg)}`,'error');
        result.status='failed'; result.reason=postResult.msg;
        failed++;
        // Offer manual assist if enabled and we couldn't auto-post
        if(manualFallback){
          bcTermLog(`   ‚Üí Opening Manual Assist for this site...`,'warn');
          await new Promise(r=>setTimeout(r,800));
          bcManualAssist(site, siteName, siteEmail, siteWebsite, siteComment);
          // Wait for user to potentially dismiss the modal
          await bcWait(3000);
        }
      }
    } catch(err){
      bcTermLog(`   ‚úó Error: ${esc(err.message||'Unknown')}`,'error');
      result.status='error'; result.reason=err.message||'Unknown error';
      failed++;
    }

    _bcSessionResults.push(result);
    done++;
    bcRefresh();

    if(i<pending.length-1&&!_bcStop){
      bcTermLog(`   ‚è≥ Waiting ${delay/1000}s before next site...`,'muted');
      await bcWait(delay);
    }
  }

  bcTermSeparator('‚ñ∂ COMPLETE');
  bcTermLog(`‚úÖ Done ‚Äî ${success} posted ¬∑ ${failed} failed ¬∑ ${done} total`,'success');
  bcLog(`Session: ${success}/${done} succeeded`,'success');

  _bcRunning=false; _bcStop=false;
  document.getElementById('bc-start-btn').disabled=false;
  document.getElementById('bc-stop-btn').style.display='none';
  document.getElementById('bc-run-badge').style.display='none';
  if(document.getElementById('bc-prog-fill')) document.getElementById('bc-prog-fill').style.width='100%';
  bcShowResultsSummary();
  bcRefresh();
}

let _bcSessionResults=[];
function bcShowResultsSummary(){
  const successList=_bcSessionResults.filter(r=>r.status==='success'||r.status==='moderated');
  const failList=_bcSessionResults.filter(r=>r.status!=='success'&&r.status!=='moderated');

  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`
  <div class="modal-box" style="min-width:680px;max-width:90vw;max-height:90vh;overflow-y:auto">
    <div class="modal-title">
      üìä Commenting Session Results
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï Close</button>
    </div>

    <div class="grid2" style="margin-bottom:16px;gap:12px">
      <div style="background:rgba(0,87,255,0.06);border:1px solid rgba(0,87,255,0.2);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:32px;font-weight:800;font-family:var(--mono);color:var(--accent)">${successList.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);margin-top:4px;text-transform:uppercase;letter-spacing:0.08em">‚úÖ Successful</div>
      </div>
      <div style="background:rgba(232,0,61,0.06);border:1px solid rgba(232,0,61,0.2);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:32px;font-weight:800;font-family:var(--mono);color:var(--accent2)">${failList.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);margin-top:4px;text-transform:uppercase;letter-spacing:0.08em">‚úó Failed / Manual Required</div>
      </div>
    </div>

    ${successList.length?`
    <div style="margin-bottom:16px">
      <div style="font-family:var(--mono);font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;font-weight:700">‚úÖ SUCCESSFUL COMMENTS (${successList.length})</div>
      ${successList.map(r=>`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);border-radius:7px;margin-bottom:5px">
        <span style="font-size:14px">${r.status==='moderated'?'‚è≥':'‚úÖ'}</span>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--mono);font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.label)}</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.url)}</div>
        </div>
        <span class="badge ${r.status==='moderated'?'badge-y':'badge-g'}">${r.status==='moderated'?'Pending Moderation':'Posted'}</span>
        <span style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.reason)}</span>
      </div>`).join('')}
    </div>`:''}

    ${failList.length?`
    <div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--accent2);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;font-weight:700">‚úó FAILED / NEEDS MANUAL ACTION (${failList.length})</div>
      ${failList.map(r=>`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(232,0,61,0.04);border:1px solid rgba(232,0,61,0.15);border-radius:7px;margin-bottom:5px">
        <span style="font-size:14px">‚ùå</span>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--mono);font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.label)}</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.reason)}</div>
        </div>
        <a href="${esc(r.url)}" target="_blank" class="btn btn-ghost btn-xs">Open Site</a>
      </div>`).join('')}
    </div>`:''}

    <div class="row" style="margin-top:16px">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-primary" onclick="bcExportResults()">üì§ Export Results CSV</button>
      <button class="btn btn-blue" onclick="bcPushSuccessToAutoPoster()" title="Push successful sites to Auto Poster">üì§ Push to Auto Poster</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  // After session completes, also flush any deferred manual search popup inline
  bcFlushDeferredParasiteResults();
}

function bcFlushDeferredParasiteResults(){
  if(!pfPendingManualSearchData) return;
  const {queries, engine, recency, keyword} = pfPendingManualSearchData;
  pfPendingManualSearchData = null;
  // Show inline below the blog commenter terminal instead of popup
  const terminal = document.querySelector('#bc-terminal');
  if(!terminal) return;
  const container = terminal.closest('.card');
  if(!container) return;
  const div = document.createElement('div');
  div.className = 'card';
  div.style.marginTop = '12px';
  const linksHtml = queries.slice(0,10).map((q,i)=>{
    const url = csBuildSearchUrl(engine, q.query, recency);
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border)">
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px">${i+1}</span>
      <div style="flex:1;min-width:0;font-family:var(--mono);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)">${esc(q.query)}</div>
      <a href="${esc(url)}" target="_blank" class="btn btn-primary btn-xs">Search ‚Üí</a>
    </div>`;
  }).join('');
  div.innerHTML = `<div class="card-title">üîó Parasite Manual Search Links ‚Äî Session Complete</div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:10px">Your blog commenter session is done. Click any link below to find parasite sites for <b>${esc(keyword)}</b>.</div>
    <div style="max-height:300px;overflow-y:auto">${linksHtml}</div>`;
  container.after(div);
}

// Push successful session URLs to Auto Poster
function bcPushSuccessToAutoPoster(){
  const successList = _bcSessionResults.filter(r => r.status==='success' || r.status==='moderated');
  if(!successList.length){ alert('No successful URLs to push.'); return; }
  // Store them in a global for the Auto Poster to pick up
  if(!window._autoPosterQueue) window._autoPosterQueue = [];
  successList.forEach(r => {
    if(!window._autoPosterQueue.find(x=>x.url===r.url)){
      window._autoPosterQueue.push({ url: r.url, label: r.label, status: r.status, comment: r.comment||'' });
    }
  });
  // Open Auto Poster modal
  bcShowAutoPosterSetup(successList);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO POSTER ‚Äî Push Successful Parasite Sites to Auto Poster Setup
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _apSites = JSON.parse(localStorage.getItem('ap_sites')||'[]');
let _apRunning = false;

function apSave(){ localStorage.setItem('ap_sites', JSON.stringify(_apSites)); }

function bcShowAutoPosterSetup(successList){
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = e => { if(e.target===overlay) overlay.remove(); };

  const existingUrls = new Set(_apSites.map(s=>s.url));
  const newSites = successList.filter(r => !existingUrls.has(r.url));

  overlay.innerHTML = `
  <div class="modal-box" style="min-width:720px;max-width:92vw;max-height:92vh;overflow-y:auto">
    <div class="modal-title">
      üì§ Auto Poster Setup ‚Äî Push Parasite Sites
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï Close</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div style="background:rgba(0,87,255,0.06);border:1px solid rgba(0,87,255,0.2);border-radius:10px;padding:14px;text-align:center">
        <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent)">${successList.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase;letter-spacing:.08em">‚úÖ Successful Sites</div>
      </div>
      <div style="background:rgba(124,58,237,0.06);border:1px solid rgba(124,58,237,0.2);border-radius:10px;padding:14px;text-align:center">
        <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent5)">${newSites.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase;letter-spacing:.08em">New to Auto Poster</div>
      </div>
    </div>

    <!-- Platform selector -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">‚öôÔ∏è Auto Post Platform</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
        ${['github','netlify','wordpress','blogger','medium','custom'].map(p => {
          const icons = {github:'üê±',netlify:'üåê',wordpress:'üìù',blogger:'üì∞',medium:'‚úçÔ∏è',custom:'‚öôÔ∏è'};
          const labels = {github:'GitHub Pages',netlify:'Netlify',wordpress:'WordPress REST',blogger:'Blogger API',medium:'Medium API',custom:'Custom Webhook'};
          return `<div onclick="apSelectPlatform('${p}')" id="ap-plat-${p}" style="cursor:pointer;padding:10px;border:2px solid var(--border);border-radius:8px;text-align:center;transition:all .15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.classList.contains('selected')) this.style.borderColor='var(--border)'">
            <div style="font-size:22px">${icons[p]}</div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--muted2);margin-top:4px;font-weight:700">${labels[p]}</div>
          </div>`;
        }).join('')}
      </div>

      <!-- Dynamic credential fields -->
      <div id="ap-cred-fields" style="display:none">
        <div style="font-family:var(--mono);font-size:10px;color:var(--accent);margin-bottom:8px;font-weight:700" id="ap-cred-title">Platform Credentials</div>
        <div id="ap-cred-body"></div>
      </div>
    </div>

    <!-- Post settings -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">üìù Post Settings</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div>
          <label class="lbl">Post Title Template</label>
          <input type="text" id="ap-title-tpl" value="{keyword} ‚Äî Review &amp; Guide" placeholder="{keyword} used as variable"/>
        </div>
        <div>
          <label class="lbl">Post Delay (seconds between posts)</label>
          <input type="number" id="ap-delay" value="5" min="2" max="60"/>
        </div>
      </div>
      <div style="margin-bottom:10px">
        <label class="lbl">Content Template (use {url}, {keyword}, {comment} as variables)</label>
        <textarea id="ap-content-tpl" rows="4" placeholder="e.g. Check out this resource: {url}&#10;&#10;{comment}">{comment}

Read more: {url}</textarea>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <label class="lbl" style="margin:0">Tags / Labels</label>
        <input type="text" id="ap-tags" placeholder="seo, parasite, backlink" style="width:auto;flex:1"/>
      </div>
    </div>

    <!-- Sites to push -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">üåê Sites to Auto-Post To (${successList.length} total)</div>
      <div style="max-height:220px;overflow-y:auto">
        ${successList.map((r,i)=>`
        <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border)">
          <input type="checkbox" id="ap-chk-${i}" checked style="width:auto;flex-shrink:0"/>
          <span style="font-size:14px">${r.status==='moderated'?'‚è≥':'‚úÖ'}</span>
          <div style="flex:1;min-width:0">
            <div style="font-family:var(--mono);font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.label||r.url)}</div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.url)}</div>
          </div>
          <span style="font-family:var(--mono);font-size:9px;padding:2px 7px;border-radius:4px;background:${r.status==='success'?'rgba(0,87,255,0.1)':'rgba(217,119,6,0.1)'};color:${r.status==='success'?'var(--accent)':'var(--accent3)'}">${r.status}</span>
        </div>`).join('')}
      </div>
    </div>

    <!-- Terminal -->
    <div class="card" style="margin-bottom:14px;display:none" id="ap-terminal-card">
      <div class="card-title">‚ö° Auto Poster Terminal</div>
      <div id="ap-terminal" style="background:#0d1117;border:1px solid #30363d;padding:12px;font-family:var(--mono);font-size:10px;height:160px;overflow-y:auto;line-height:1.8;border-radius:8px;color:#c9d1d9"></div>
    </div>

    <div class="row" style="margin-top:0;gap:10px;flex-wrap:wrap">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-ghost btn-sm" onclick="apAddAllToQueue(${JSON.stringify(successList).replace(/</g,'&lt;')})">+ Add to AP Queue</button>
      <button class="btn btn-primary" id="ap-run-btn" onclick="apRunSelected(${JSON.stringify(successList).replace(/</g,'&lt;')})">
        ‚ñ∂ Start Auto Posting
      </button>
    </div>
  </div>`;

  document.body.appendChild(overlay);
}

const AP_CRED_DEFS = {
  github:    { title:'GitHub Pages', fields:[{id:'token',label:'Personal Access Token',ph:'ghp_...',type:'password'},{id:'repo',label:'Repo (user/repo)',ph:'username/my-seo-site'},{id:'branch',label:'Branch',ph:'main'}] },
  netlify:   { title:'Netlify', fields:[{id:'token',label:'Personal Access Token',ph:'netlify-token...',type:'password'},{id:'site_id',label:'Site ID (optional)',ph:'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'}] },
  wordpress: { title:'WordPress REST API', fields:[{id:'site_url',label:'Site URL',ph:'https://yoursite.com'},{id:'username',label:'Username',ph:'admin'},{id:'app_password',label:'Application Password',ph:'xxxx xxxx xxxx',type:'password'}] },
  blogger:   { title:'Blogger API', fields:[{id:'api_key',label:'API Key',ph:'AIza...',type:'password'},{id:'blog_id',label:'Blog ID',ph:'1234567890'}] },
  medium:    { title:'Medium API', fields:[{id:'token',label:'Integration Token',ph:'medium-token...',type:'password'}] },
  custom:    { title:'Custom Webhook', fields:[{id:'webhook_url',label:'Webhook URL',ph:'https://your-endpoint.com/post'},{id:'auth_header',label:'Auth Header (optional)',ph:'Bearer token123'}] },
};

let _apSelectedPlatform = null;
let _apCredentials = {};

function apSelectPlatform(pid){
  _apSelectedPlatform = pid;
  document.querySelectorAll('[id^="ap-plat-"]').forEach(el => {
    el.style.borderColor = 'var(--border)';
    el.classList.remove('selected');
  });
  const sel = document.getElementById(`ap-plat-${pid}`);
  if(sel){ sel.style.borderColor = 'var(--accent)'; sel.style.background = 'rgba(0,87,255,0.06)'; sel.classList.add('selected'); }

  const def = AP_CRED_DEFS[pid];
  if(!def) return;
  const credFields = document.getElementById('ap-cred-fields');
  const credTitle = document.getElementById('ap-cred-title');
  const credBody = document.getElementById('ap-cred-body');
  if(credTitle) credTitle.textContent = def.title + ' ‚Äî Credentials';
  if(credBody) credBody.innerHTML = def.fields.map(f=>`
    <div style="margin-bottom:10px">
      <label class="lbl">${f.label}</label>
      <input type="${f.type||'text'}" id="ap-cred-${f.id}" placeholder="${f.ph}" oninput="_apCredentials['${f.id}']=this.value" autocomplete="off"/>
    </div>`).join('');
  if(credFields) credFields.style.display = '';
}

function apLog(msg, color='#c9d1d9'){
  const term = document.getElementById('ap-terminal');
  if(!term) return;
  const d = document.createElement('div');
  d.innerHTML = `<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`;
  term.appendChild(d);
  term.scrollTop = term.scrollHeight;
}

function apAddAllToQueue(sites){
  if(!_apSites) _apSites = [];
  let added = 0;
  const existingUrls = new Set(_apSites.map(s=>s.url));
  sites.forEach(r => {
    if(!existingUrls.has(r.url)){
      _apSites.push({ id: uid(), url: r.url, label: r.label||r.url, comment: r.comment||'', status: 'pending', added: Date.now() });
      added++;
    }
  });
  apSave();
  alert(`‚úì Added ${added} sites to Auto Poster queue (${_apSites.length} total)`);
}

async function apRunSelected(allSites){
  if(!_apSelectedPlatform){ alert('Select a platform first.'); return; }
  if(_apRunning){ alert('Already running!'); return; }

  // Collect selected sites
  const selected = allSites.filter((r,i) => {
    const chk = document.getElementById(`ap-chk-${i}`);
    return chk && chk.checked;
  });
  if(!selected.length){ alert('No sites selected.'); return; }

  const titleTpl = (document.getElementById('ap-title-tpl')||{value:'{keyword}'}).value;
  const contentTpl = (document.getElementById('ap-content-tpl')||{value:'{comment}\n\n{url}'}).value;
  const delay = parseInt((document.getElementById('ap-delay')||{value:'5'}).value)*1000||5000;

  const termCard = document.getElementById('ap-terminal-card');
  const runBtn = document.getElementById('ap-run-btn');
  if(termCard) termCard.style.display = '';
  if(runBtn){ runBtn.disabled = true; runBtn.innerHTML = '<span class="spinner"></span> Posting...'; }

  _apRunning = true;
  apLog(`üöÄ Starting Auto Poster ‚Äî ${selected.length} sites ‚Äî Platform: ${_apSelectedPlatform.toUpperCase()}`, '#58a6ff');

  let success = 0, failed = 0;

  for(let i=0; i<selected.length; i++){
    const site = selected[i];
    const title = titleTpl.replace(/{keyword}/g, site.label||'SEO');
    const content = contentTpl.replace(/{url}/g, site.url).replace(/{keyword}/g, site.label||'SEO').replace(/{comment}/g, site.comment||'Great resource!');

    apLog(`[\${i+1}/${selected.length}] üåê ${esc(site.url)}`, '#d29922');

    try {
      let result = null;
      if(_apSelectedPlatform === 'github') result = await apPostGitHub(site, title, content);
      else if(_apSelectedPlatform === 'netlify') result = await apPostNetlify(site, title, content);
      else if(_apSelectedPlatform === 'wordpress') result = await apPostWordPress(site, title, content);
      else if(_apSelectedPlatform === 'blogger') result = await apPostBlogger(site, title, content);
      else if(_apSelectedPlatform === 'medium') result = await apPostMedium(site, title, content);
      else if(_apSelectedPlatform === 'custom') result = await apPostCustomWebhook(site, title, content);

      if(result && result.success){
        apLog(`   ‚úÖ Posted! ${esc(result.url||'')}`, '#3fb950');
        success++;
      } else {
        apLog(`   ‚úó Failed: ${esc(result&&result.msg||'Unknown error')}`, '#f85149');
        failed++;
      }
    } catch(e){
      apLog(`   ‚úó Error: ${esc(e.message||'Unknown')}`, '#f85149');
      failed++;
    }

    if(i < selected.length-1){ await new Promise(r=>setTimeout(r,delay)); }
  }

  apLog(`‚úÖ Done ‚Äî ${success} posted ¬∑ ${failed} failed`, '#3fb950');
  _apRunning = false;
  if(runBtn){ runBtn.disabled = false; runBtn.innerHTML = '‚ñ∂ Start Auto Posting'; }
}

// ‚îÄ‚îÄ Platform-specific post functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function apPostGitHub(site, title, content){
  const token = _apCredentials.token;
  const repo = _apCredentials.repo;
  const branch = _apCredentials.branch||'main';
  if(!token||!repo) return {success:false, msg:'Missing GitHub token or repo'};
  const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,50);
  const path = `posts/${Date.now()}-${slug}.html`;
  const htmlContent = `<!DOCTYPE html><html><head><title>${title}</title></head><body><h1>${title}</h1><p>${content}</p><a href="${site.url}">${site.url}</a></body></html>`;
  const encoded = btoa(unescape(encodeURIComponent(htmlContent)));
  try {
    const resp = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: `Add: ${title}`, content: encoded, branch })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.content&&json.content.html_url||`https://github.com/${repo}/blob/${branch}/${path}` };
    return { success: false, msg: json.message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostNetlify(site, title, content){
  const token = _apCredentials.token;
  if(!token) return {success:false, msg:'Missing Netlify token'};
  try {
    // Create a new site then deploy
    const siteName = 'seo-ap-' + Date.now();
    const createResp = await fetch('https://api.netlify.com/api/v1/sites', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: siteName })
    });
    const siteData = await createResp.json();
    if(!createResp.ok) return {success:false, msg: siteData.message||'Failed to create Netlify site'};
    const siteId = siteData.id;
    const htmlContent = `<!DOCTYPE html><html><head><title>${title}</title></head><body><h1>${title}</h1><p>${content}</p><a href="${site.url}">${site.url}</a></body></html>`;
    // Deploy via zip
    const enc = new TextEncoder();
    const fileBytes = enc.encode(htmlContent);
    const deployResp = await fetch(`https://api.netlify.com/api/v1/sites/${siteId}/deploys`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/zip' },
      body: fileBytes
    });
    const deployData = await deployResp.json();
    if(deployResp.ok) return { success: true, url: `https://${siteName}.netlify.app` };
    return { success: false, msg: deployData.message||'Deploy failed' };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostWordPress(site, title, content){
  const siteUrl = (_apCredentials.site_url||'').replace(/\/$/,'');
  const username = _apCredentials.username;
  const appPw = _apCredentials.app_password;
  if(!siteUrl||!username||!appPw) return {success:false, msg:'Missing WordPress credentials'};
  try {
    const auth = btoa(username + ':' + appPw);
    const resp = await fetch(`${siteUrl}/wp-json/wp/v2/posts`, {
      method: 'POST',
      headers: { 'Authorization': `Basic ${auth}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, content, status: 'publish' })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.link||siteUrl };
    return { success: false, msg: json.message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostBlogger(site, title, content){
  const apiKey = _apCredentials.api_key;
  const blogId = _apCredentials.blog_id;
  if(!apiKey||!blogId) return {success:false, msg:'Missing Blogger API key or Blog ID'};
  try {
    const resp = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ kind: 'blogger#post', title, content })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.url||'' };
    return { success: false, msg: json.error&&json.error.message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostMedium(site, title, content){
  const token = _apCredentials.token;
  if(!token) return {success:false, msg:'Missing Medium token'};
  try {
    const userResp = await fetch('https://api.medium.com/v1/me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const userData = await userResp.json();
    if(!userResp.ok) return {success:false, msg:'Invalid Medium token'};
    const userId = userData.data&&userData.data.id;
    const resp = await fetch(`https://api.medium.com/v1/users/${userId}/posts`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, contentFormat: 'html', content: `<h1>${title}</h1><p>${content}</p><p><a href="${site.url}">${site.url}</a></p>`, publishStatus: 'public' })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.data&&json.data.url||'' };
    return { success: false, msg: json.errors&&json.errors[0]&&json.errors[0].message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostCustomWebhook(site, title, content){
  const url = _apCredentials.webhook_url;
  const authHeader = _apCredentials.auth_header;
  if(!url) return {success:false, msg:'Missing webhook URL'};
  try {
    const headers = { 'Content-Type': 'application/json' };
    if(authHeader) headers['Authorization'] = authHeader;
    const resp = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ title, content, source_url: site.url, label: site.label })
    });
    if(resp.ok) return { success: true, url };
    const text = await resp.text();
    return { success: false, msg: `HTTP ${resp.status}: ${text.slice(0,100)}` };
  } catch(e){ return {success:false, msg:e.message}; }
}

function bcExportResults(){
  const rows=[['URL','Label','Status','Reason','Comment'],
    ..._bcSessionResults.map(r=>[r.url,r.label,r.status,r.reason,r.comment||''])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='comment-results.csv'; a.click();
}

function bcStopRun(){
  _bcStop=true;
  bcTermLog('‚èπ Stop requested ‚Äî finishing current site...','warn');
  const sb=document.getElementById('bc-stop-btn');
  if(sb) sb.disabled=true;
}

function bcWait(ms){ return new Promise(res=>setTimeout(res,ms)); }

// Queue comment to ALL pending sites at once
function bcQueueAll(){
  const out=document.getElementById('bc-gen-out');
  if(!out||!out.value.trim()){ alert('Generate a comment first.'); return; }
  const pending=_bcSites.filter(s=>!s.done&&!s.queued);
  if(!pending.length){ alert('No pending sites without queued comments.'); return; }
  pending.forEach(s=>{ s.queued=out.value.trim(); });
  bcSave();
  bcLog(`Queued comment to all ${pending.length} pending sites.`,'success');
  bcTermLog(`‚ö° Comment queued to ${pending.length} sites.`,'success');
  bcRefresh();
}

function bcRenderSiteList(){
  if(!_bcSites.length) return '<p class="tm mono xs">No sites added yet. Add a blog URL above.</p>';
  return _bcSites.map((s,i)=>`
    <div id="bc-site-${s.id}" style="border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:7px;background:var(--bg)">
      <div class="flex aic g8" style="margin-bottom:6px">
        <span style="font-size:13px">${bcTypeIcon(s.type)}</span>
        <span class="mono xs ta" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
          <a href="${esc(s.url)}" target="_blank" rel="noreferrer" style="color:var(--accent);text-decoration:none">${esc(s.label||s.url)}</a>
        </span>
        <span class="badge badge-b">${esc(s.type)}</span>
        <button class="btn btn-ghost btn-xs" onclick="bcOpenSite('${s.id}')">üåê Open</button>
        <button class="btn btn-danger btn-xs" onclick="bcRemoveSite('${s.id}')">‚úï</button>
      </div>
      <div class="mono xs tm" style="margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.url)}</div>
      ${s.notes?`<div style="font-family:var(--mono);font-size:10px;color:var(--accent3);margin-bottom:6px">‚ö† ${esc(s.notes)}</div>`:''}
      <div class="flex aic g8">
        <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Name: <b>${esc(s.name||'‚Äî')}</b></span>
        ${s.email?`<span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Email: <b>${esc(s.email)}</b></span>`:''}
        ${s.website?`<span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Site: <b>${esc(s.website)}</b></span>`:''}
        <button class="btn btn-blue btn-xs" style="margin-left:auto" onclick="bcFillModal('${s.id}')">‚úè Fill Comment</button>
        <button class="btn btn-yellow btn-xs" onclick="bcManualAssistSite('${s.id}')">ü§ù Manual</button>
        <button class="btn btn-ghost btn-xs" onclick="bcMarkDone('${s.id}')" ${s.done?'style="color:var(--accent);border-color:var(--accent)"':''}>
          ${s.done?'‚úì Done':'Mark Done'}
        </button>
      </div>
      ${s.queued?`<div style="margin-top:8px;padding:8px 10px;background:#fff;border:1px solid var(--border);border-radius:6px;font-family:var(--mono);font-size:11px;color:var(--text);line-height:1.6"><b class="tm" style="font-size:9px;text-transform:uppercase;letter-spacing:0.07em">Queued Comment:</b><br>${esc(s.queued)}</div>`:''}
    </div>`).join('');
}

function bcRenderLog(){
  if(!_bcLog.length) return '<p class="tm mono xs">No log entries yet.</p>';
  return _bcLog.slice().reverse().map(l=>`
    <div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--bg);border:1px solid var(--border);margin-bottom:5px;font-family:var(--mono);font-size:10px;border-radius:6px">
      <span class="tm" style="font-size:9px;flex-shrink:0">${l.ts}</span>
      <span class="${l.type==='success'?'ta':l.type==='error'?'tr':'tm'}">${l.type==='success'?'‚úì':l.type==='error'?'‚úó':'‚Ñπ'}</span>
      <span style="flex:1">${esc(l.msg)}</span>
    </div>`).join('');
}

function bcTypeIcon(t){
  return {wordpress:'üîµ',blogger:'üü†',disqus:'üí¨',generic:'üåê',other:'üìù'}[t]||'üìù';
}

function bcManualAssistSite(siteId){
  const site = _bcSites.find(s=>s.id===siteId);
  if(!site){ alert('Site not found.'); return; }
  const name = (document.getElementById('bc-gen-name')||{value:'A Reader'}).value.trim() || site.name || 'A Reader';
  const email = (document.getElementById('bc-email')||{value:''}).value.trim() || site.email || '';
  const website = (document.getElementById('bc-website')||{value:''}).value.trim() || site.website || '';
  const kwSel = (document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom = (document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw = kwCustom||kwSel||'this topic';
  const comment = site.queued || (document.getElementById('bc-gen-out')||{value:''}).value.trim() || bcGenComment(kw, site.url, name);
  if(!email){ alert('Please fill in your email address first.'); return; }
  bcManualAssist(site, name, email, website, comment);
}

function bcLog(msg,type='info'){ _bcLog.push({msg,type,ts:ts()}); }

function bcRefresh(){
  const sl=document.getElementById('bc-site-list');
  const ll=document.getElementById('bc-log');
  const ct=document.getElementById('bc-site-count');
  const lr=document.getElementById('bc-url-lists-render');
  if(sl) sl.innerHTML=bcRenderSiteList();
  if(ll) ll.innerHTML=bcRenderLog();
  if(ct) ct.textContent=_bcSites.length;
  if(lr) lr.innerHTML=bcRenderUrlLists();
}

function bcAddSite(){
  const urlEl=document.getElementById('bc-url');
  const url=(urlEl||{value:''}).value.trim();
  if(!url){ alert('Enter a URL first.'); return; }
  if(!/^https?:\/\//i.test(url)){ alert('URL must start with http:// or https://'); return; }
  const site={
    id:uid(),
    url,
    label:(document.getElementById('bc-label')||{value:''}).value.trim()||url,
    type:(document.getElementById('bc-type')||{value:'wordpress'}).value,
    name:(document.getElementById('bc-gen-name')||{value:''}).value.trim(),
    email:(document.getElementById('bc-email')||{value:''}).value.trim(),
    website:(document.getElementById('bc-website')||{value:''}).value.trim(),
    notes:(document.getElementById('bc-notes')||{value:''}).value.trim(),
    done:false,
    queued:'',
  };
  _bcSites.push(site);
  bcSave();
  bcLog(`Added site: ${site.label}`, 'info');
  bcTermLog(`‚ûï Added: ${esc(site.url)}`,'info');
  // clear url+label+notes only
  ['bc-url','bc-label','bc-notes'].forEach(id=>{
    const e=document.getElementById(id); if(e) e.value='';
  });
  bcRefresh();
}

function bcRemoveSite(id){
  _bcSites=_bcSites.filter(s=>s.id!==id);
  bcSave();
  bcRefresh();
}

function bcClearAll(){
  if(!confirm('Clear all target sites?')) return;
  _bcSites=[];
  bcSave();
  bcRefresh();
}

function bcMarkDone(id){
  const s=_bcSites.find(x=>x.id===id);
  if(s){ s.done=!s.done; bcSave(); }
  bcRefresh();
}

function bcOpenSite(id){
  const s=_bcSites.find(x=>x.id===id);
  if(s) window.open(s.url,'_blank','noreferrer');
}

function bcGenerate(){
  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const name=(document.getElementById('bc-gen-name')||{value:'A Reader'}).value.trim()||'A Reader';
  const out=document.getElementById('bc-gen-out');
  if(out) out.value=bcGenComment(kw,'',name);
}

function bcCopyComment(){
  const out=document.getElementById('bc-gen-out');
  if(!out||!out.value.trim()){ alert('Generate a comment first.'); return; }
  navigator.clipboard.writeText(out.value).then(()=>{
    bcLog('Comment copied to clipboard.','success');
    bcRefresh();
  }).catch(()=>{
    // fallback
    out.select();
    document.execCommand('copy');
    bcLog('Comment copied (fallback).','success');
    bcRefresh();
  });
}

function bcQueueComment_legacy(){
  // Replaced by bcQueueAll
}

function bcFillModal(id){
  const s=_bcSites.find(x=>x.id===id);
  if(!s) return;

  // Build a mini fill-card overlay
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.id='bc-modal';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };

  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const genName=s.name||'A Reader';
  const comment=s.queued||bcGenComment(kw,'',genName);

  overlay.innerHTML=`
    <div class="modal-box" style="min-width:520px;max-width:640px">
      <div class="modal-title">
        ‚úè Fill Comment ‚Äî ${esc(s.label||s.url)}
        <button class="btn btn-ghost btn-xs" onclick="document.getElementById('bc-modal').remove()">‚úï Close</button>
      </div>
      <div class="notice notice-info" style="margin-bottom:14px">
        üìñ Copy each field below and paste into the blog comment form. 
        <a href="${esc(s.url)}" target="_blank" rel="noreferrer" style="color:var(--accent4)">Open site ‚Üí</a>
      </div>
      ${s.notes?`<div class="notice notice-warn">‚ö† Note: ${esc(s.notes)}</div>`:''}

      <div class="grid2" style="margin-bottom:12px">
        <div class="fg mb0"><label class="lbl">Name Field</label>
          <div class="flex g8">
            <input type="text" value="${esc(s.name||'')}" id="bcm-name" readonly style="background:var(--bg)"/>
            <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-name','Name')">Copy</button>
          </div>
        </div>
        <div class="fg mb0"><label class="lbl">Email Field</label>
          <div class="flex g8">
            <input type="text" value="${esc(s.email||'')}" id="bcm-email" readonly style="background:var(--bg)"/>
            <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-email','Email')">Copy</button>
          </div>
        </div>
      </div>
      <div class="fg" style="margin-bottom:12px"><label class="lbl">Website Field</label>
        <div class="flex g8">
          <input type="text" value="${esc(s.website||'')}" id="bcm-web" readonly style="background:var(--bg)"/>
          <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-web','Website')">Copy</button>
        </div>
      </div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Comment Text</label>
        <textarea id="bcm-comment" rows="5" style="background:var(--bg)">${esc(comment)}</textarea>
        <div class="row mt8">
          <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-comment','Comment')">üìã Copy Comment</button>
          <button class="btn btn-primary btn-sm" onclick="bcRegen('${s.id}')">üé≤ Regenerate</button>
          <button class="btn btn-yellow btn-sm" onclick="bcSaveQueued('${s.id}')">üíæ Save to Queue</button>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" onclick="document.getElementById('bc-modal').remove()">Close</button>
        <button class="btn btn-primary" onclick="window.open('${esc(s.url)}','_blank','noreferrer');bcMarkDoneAndClose('${s.id}')">üåê Open Site + Mark Done</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function bcCopyField(id,label){
  const el=document.getElementById(id);
  if(!el) return;
  const val=el.value||el.textContent||'';
  navigator.clipboard.writeText(val).catch(()=>{ el.select&&el.select(); document.execCommand&&document.execCommand('copy'); });
  bcLog(`${label} copied.`,'success');
  bcRefresh();
}

function bcRegen(siteId){
  const s=_bcSites.find(x=>x.id===siteId);
  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const name=s?s.name:'A Reader';
  const el=document.getElementById('bcm-comment');
  if(el) el.value=bcGenComment(kw,'',name);
}

function bcSaveQueued(siteId){
  const s=_bcSites.find(x=>x.id===siteId);
  const el=document.getElementById('bcm-comment');
  if(s&&el){ s.queued=el.value; bcSave(); bcLog(`Comment queued for ${s.label||s.url}`,'success'); bcRefresh(); }
  document.getElementById('bc-modal')&&document.getElementById('bc-modal').remove();
}

function bcMarkDoneAndClose(siteId){
  bcMarkDone(siteId);
  document.getElementById('bc-modal')&&document.getElementById('bc-modal').remove();
}

function bcImportBulk(){
  const raw=prompt('Paste URLs ‚Äî one per line:');
  if(!raw) return;
  const urls=raw.split('\n').map(u=>u.trim()).filter(u=>/^https?:\/\//i.test(u));
  if(!urls.length){ alert('No valid URLs found.'); return; }
  urls.forEach(url=>{
    _bcSites.push({id:uid(),url,label:url,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''});
  });
  bcSave();
  bcLog(`Bulk imported ${urls.length} sites.`,'success');
  bcRefresh();
}

function bcExportLog(){
  const rows=[['Time','Type','Message'],..._bcLog.map(l=>[l.ts,l.type,l.msg])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='blog-commenter-log.csv';
  a.click();
}

function bcShowCfWorkerCode(){
  const code = `// Cloudflare Worker ‚Äî Universal CORS Proxy
// Deploy at: https://dash.cloudflare.com ‚Üí Workers & Pages ‚Üí Create Worker
// Then set your worker URL as: https://your-worker.workers.dev/?url={URL}

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  const url = new URL(request.url);
  const targetUrl = url.searchParams.get('url');
  if (!targetUrl) {
    return new Response('Missing ?url= parameter', { status: 400 });
  }
  // Forward request to target
  const modifiedRequest = new Request(targetUrl, {
    method: request.method,
    headers: {
      'Content-Type': request.headers.get('Content-Type') || 'application/x-www-form-urlencoded',
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120',
      'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
      'Accept-Language': 'en-US,en;q=0.5',
    },
    body: ['POST','PUT','PATCH'].includes(request.method) ? request.body : undefined,
    redirect: 'follow',
  });
  try {
    const response = await fetch(modifiedRequest);
    const responseText = await response.text();
    return new Response(responseText, {
      status: response.status,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
        'Access-Control-Allow-Headers': '*',
        'Content-Type': response.headers.get('Content-Type') || 'text/html',
      },
    });
  } catch(e) {
    return new Response('Proxy error: ' + e.message, { status: 500, headers: {'Access-Control-Allow-Origin':'*'} });
  }
}`;

  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`<div class="modal-box" style="min-width:600px;max-width:800px">
    <div class="modal-title">‚òÅ Cloudflare Worker ‚Äî CORS Proxy Code
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï Close</button>
    </div>
    <div class="notice notice-info" style="margin-bottom:12px">
      <strong>Steps:</strong> 1. Go to <a href="https://dash.cloudflare.com" target="_blank" style="color:var(--accent)">dash.cloudflare.com</a>
      ‚Üí Workers & Pages ‚Üí Create Worker ‚Üí Paste code below ‚Üí Deploy.
      2. Copy your worker URL (e.g. <code>https://my-proxy.yourname.workers.dev</code>)
      3. Set Custom Proxy as: <code>https://my-proxy.yourname.workers.dev/?url={URL}</code>
    </div>
    <textarea style="width:100%;height:320px;font-family:var(--mono);font-size:10px;background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:12px;line-height:1.7" readonly>${esc(code)}</textarea>
    <div class="row mt8">
      <button class="btn btn-primary" onclick="navigator.clipboard.writeText(${JSON.stringify(code)});bcTermLog('Cloudflare Worker code copied!','success')">üìã Copy Code</button>
      <a href="https://dash.cloudflare.com" target="_blank" class="btn btn-ghost">Open Cloudflare Dashboard ‚Üí</a>
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARASITE FINDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _pfResults = [];
let _pfLiveResults = [];
let _pfRunning = false;
let _pfAbort = false;
let _pfActiveFilters = { type:'all', da:'all', comment:'all', keyword:'' };

const PF_NICHES = {
  'Health & Fitness': ['health tips','fitness blog','workout guide','weight loss','nutrition advice','diet plan','supplement review','mental health','yoga','keto diet'],
  'Finance & Money': ['personal finance','make money online','investment tips','stock market','crypto','passive income','budgeting','forex trading','side hustle','debt free'],
  'Technology': ['tech review','software tutorial','AI tools','web development','cybersecurity','gadget review','SaaS','app review','cloud computing','programming'],
  'Marketing & SEO': ['digital marketing','SEO tips','content marketing','social media','email marketing','affiliate marketing','link building','PPC ads','blogging tips','growth hacking'],
  'Travel': ['travel blog','backpacking','budget travel','travel tips','hotel review','destination guide','adventure travel','solo travel','travel hacks','visa guide'],
  'Business': ['startup tips','entrepreneurship','small business','business strategy','e-commerce','dropshipping','leadership','productivity','remote work','branding'],
  'Education': ['online learning','study tips','college guide','courses review','scholarship','skill building','tutoring','certification','career advice','self improvement'],
  'Gaming': ['game review','gaming tips','esports','RPG guide','mobile gaming','PC gaming','game walkthrough','gaming setup','streaming tips','game news'],
  'Food & Recipes': ['food blog','recipe guide','cooking tips','vegan recipes','keto recipes','meal prep','restaurant review','baking','nutrition','food photography'],
  'Real Estate': ['real estate tips','property investment','home buying','rental income','mortgage guide','house flipping','REITs','landlord tips','property management','real estate SEO'],
  'Celebrity & Gossip': ['celebrity news','celebrity gossip','celebrity net worth','celebrity scandal','red carpet','celebrity diet','celebrity workout','paparazzi','celebrity dating'],
  'Entertainment': ['movie review','film review','TV show review','entertainment news','box office','streaming guide','Netflix review','award show','Hollywood news'],
  'Video & YouTube': ['YouTube tips','video marketing','YouTube SEO','video editing','content creator','vlog','YouTube growth','streaming tips','TikTok strategy'],
  'Sports': ['sports news','football tips','NBA news','sports betting','sports analysis','match prediction','fantasy sports','sports review','athlete training'],
  'Music': ['music review','album review','music blog','music news','artist interview','music production','indie music','hip hop news','concert review'],
  'Fashion & Beauty': ['fashion blog','beauty tips','skincare review','makeup tutorial','fashion news','style guide','luxury fashion','beauty influencer','cosmetics review'],
  'Crypto & NFT': ['crypto news','bitcoin guide','NFT review','DeFi','altcoin','crypto trading','blockchain','web3','metaverse','crypto investment'],
};


const PF_PARASITE_DOMAINS = [
  // TIER 1 Ultra High DA 90-99
  {domain:'reddit.com', da:98, type:'Forum/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Subreddits rank #1-3 for almost any keyword. Post in niche subreddits.'},
  {domain:'linkedin.com', da:99, type:'Article/Post', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'LinkedIn articles and posts rank extremely well. Free publishing.'},
  {domain:'sites.google.com', da:98, type:'Web Page', niche:'all', commentEnabled:false, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Google Sites pages index fast and rank well. Free hosting.'},
  {domain:'docs.google.com', da:98, type:'Document', niche:'all', commentEnabled:false, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Public Google Docs rank in Google. Enable public sharing.'},
  {domain:'groups.google.com', da:98, type:'Forum/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Google Groups threads indexed directly by Google. Ranks fast.'},
  {domain:'medium.com', da:95, type:'Article', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Strong ranking power for long-form content on any topic.'},
  {domain:'tumblr.com', da:96, type:'Blog Post', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Fast indexing, strong domain, any niche works well.'},
  {domain:'blogspot.com', da:97, type:'Blog Post', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Google-owned. Blogs rank very fast. Free and unlimited.'},
  {domain:'wordpress.com', da:95, type:'Blog Post', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Massive domain. Posts rank well especially with long-tail keywords.'},
  {domain:'quora.com', da:93, type:'Q&A/Answer', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Answer questions with your link. Ranks for question-based keywords.'},
  {domain:'issuu.com', da:94, type:'Document', niche:'all', commentEnabled:false, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'PDF/document publishing. Good for product guides and reviews.'},
  {domain:'slideshare.net', da:95, type:'Presentation', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Presentations rank well. Owned by LinkedIn.'},
  {domain:'scribd.com', da:93, type:'Document', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Document sharing, strong domain, any content type.'},
  {domain:'substack.com', da:91, type:'Newsletter', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Newsletters/articles rank well. Free plan available.'},
  {domain:'notion.site', da:90, type:'Wiki/Page', niche:'all', commentEnabled:false, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Notion public pages index and rank. Good for guides.'},
  {domain:'stackoverflow.com', da:95, type:'Forum/Q&A', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Top tech Q&A. Answers rank #1 for dev questions constantly.'},
  {domain:'stackexchange.com', da:92, type:'Forum/Q&A', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'200+ niche Q&A sites. Each one ranks well in its niche.'},
  {domain:'producthunt.com', da:90, type:'Community/Review', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Product launches rank in Google. Great for SaaS/tools.'},
  {domain:'dev.to', da:88, type:'Tech Blog/Community', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Dev articles rank FAST. One of the best for tech parasite SEO.'},
  {domain:'hashnode.com', da:85, type:'Tech Blog', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Developer blogs, custom domains, excellent SEO performance.'},
  {domain:'hackernoon.com', da:87, type:'Tech Article', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Tech/crypto/AI articles, strong rankings for tech queries.'},
  {domain:'indiehackers.com', da:82, type:'Forum/Community', niche:'business', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Very active community, posts rank for startup/business KWs.'},
  {domain:'community.hubspot.com', da:93, type:'Forum/Community', niche:'marketing', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Marketing community, posts rank for marketing keywords.'},
  {domain:'moz.com/community', da:91, type:'Forum/Community', niche:'marketing', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'SEO community. Q&A posts rank well for SEO queries.'},
  {domain:'blackhatworld.com', da:85, type:'Forum', niche:'marketing', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'SEO/marketing forum. Large active community.'},
  {domain:'warriorforum.com', da:84, type:'Forum', niche:'marketing', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Internet marketing forum. Old but still ranks.'},
  {domain:'sitepoint.com', da:88, type:'Forum/Article', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Web dev community. Articles and forum threads rank well.'},
  {domain:'bodybuilding.com', da:87, type:'Forum/Article', niche:'health', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Massive fitness forum. Posts rank for supplement/workout KWs.'},
  {domain:'tapatalk.com', da:78, type:'Forum/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Hosts thousands of forums. Find niche forums and post there.'},
  {domain:'forumotion.com', da:72, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Free forum hosting. Many niche forums rank #1-5. Create your own!'},
  {domain:'proboards.com', da:75, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Popular forum hosting. Established niche forums rank well.'},
  {domain:'ning.com', da:88, type:'Community/Network', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Social network builder. Niche networks rank for community queries.'},
  {domain:'xenforo.com/community', da:82, type:'Forum/Community', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'XenForo support. Very active, ranks for forum software queries.'},
  {domain:'fandom.com', da:91, type:'Wiki/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'The biggest fan wiki platform. Any franchise/celebrity has a wiki.'},
  {domain:'wikia.fandom.com', da:91, type:'Wiki/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Fandom wikis rank #1-3 for character/show/celeb searches.'},
  {domain:'imdb.com', da:96, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Movie/TV database. User reviews rank very well.'},
  {domain:'letterboxd.com', da:87, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Film review platform. Reviews rank well for specific films.'},
  {domain:'rottentomatoes.com', da:93, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Movie reviews rank immediately for film-related searches.'},
  {domain:'metacritic.com', da:91, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Game/movie review aggregator with user review section.'},
  {domain:'genius.com', da:92, type:'Community/Wiki', niche:'music', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Lyrics/music. Artist pages rank extremely well for music queries.'},
  {domain:'last.fm', da:88, type:'Music/Community', niche:'music', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Music community, artist pages rank for music discovery.'},
  {domain:'rateyourmusic.com', da:78, type:'Community/Review', niche:'music', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Music rating community. Reviews rank for album/artist queries.'},
  {domain:'fanpop.com', da:79, type:'Fan Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Fan communities for celebs/shows. Club pages rank for fan searches.'},
  {domain:'twitch.tv', da:95, type:'Video/Community', niche:'video', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Streamer pages and clips rank for gaming/video queries.'},
  {domain:'dailymotion.com', da:92, type:'Video Platform', niche:'video', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Video hosting, video pages rank as YouTube alternatives.'},
  {domain:'vimeo.com', da:94, type:'Video Platform', niche:'video', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Video pages rank well, especially for professional/niche content.'},
  {domain:'tmz.com', da:90, type:'News/Blog', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Celebrity news ranks fast for celeb name + news searches.'},
  {domain:'eonline.com', da:88, type:'News/Article', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Celebrity/entertainment news. Ranks for celeb searches.'},
  {domain:'people.com', da:92, type:'News/Article', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'People magazine. Celebrity content ranks consistently.'},
  {domain:'dailymail.co.uk', da:95, type:'News/Blog', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Massive reach. Comments on articles rank for celeb + news KWs.'},
  {domain:'justjared.com', da:78, type:'Blog/News', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Celebrity photo blog. Ranks well for celeb sightings.'},
  {domain:'perezhilton.com', da:74, type:'Blog', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Celebrity gossip blog. Ranks for entertainment queries.'},
  {domain:'hollywoodlife.com', da:75, type:'Blog/News', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Celebrity news. Ranks for celeb name + relationship searches.'},
  {domain:'wetpaint.com', da:62, type:'Community/Wiki', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Entertainment wiki community. Ranks for TV/celeb queries.'},
  {domain:'buzzfeed.com', da:95, type:'Article/List', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Viral content platform. BuzzFeed Community posts rank well.'},
  {domain:'knowyourmeme.com', da:87, type:'Community/Wiki', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Meme/culture wiki, ranks for viral/entertainment queries.'},
  {domain:'cosmopolitan.com', da:90, type:'Article/Community', niche:'fashion', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Fashion/celeb content ranks extremely well.'},
  {domain:'vogue.com', da:91, type:'Article', niche:'fashion', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Fashion authority. Articles rank #1-3 for fashion searches.'},
  {domain:'allure.com', da:87, type:'Article/Community', niche:'fashion', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Beauty/fashion articles rank for product + beauty queries.'},
  {domain:'g2.com', da:90, type:'Review/Community', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Software reviews rank #1-3 for "[software] review" searches.'},
  {domain:'capterra.com', da:88, type:'Review/Community', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Business software reviews, rank for software comparison KWs.'},
  {domain:'glassdoor.com', da:91, type:'Review/Community', niche:'business', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Company reviews rank #1 for "[company] reviews" searches.'},
  {domain:'tripadvisor.com', da:93, type:'Review/Community', niche:'travel', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Reviews rank #1 for restaurant/hotel/destination searches.'},
  {domain:'yelp.com', da:94, type:'Review/Community', niche:'food', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Local business reviews rank extremely well for local searches.'},
  {domain:'allrecipes.com', da:90, type:'Recipe/Community', niche:'food', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Recipes rank #1-3. User recipes also rank. Very high traffic.'},
  {domain:'gamespot.com', da:90, type:'Review/Forum', niche:'gaming', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Game reviews and forums rank well for gaming queries.'},
  {domain:'ign.com', da:92, type:'Review/Forum', niche:'gaming', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Top gaming site. Reviews and forums rank for game searches.'},
  {domain:'gamefaqs.gamespot.com', da:90, type:'Forum/Guide', niche:'gaming', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Game guides and forums rank #1 for game-specific queries.'},
  {domain:'steampowered.com', da:93, type:'Community/Review', niche:'gaming', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ', note:'Steam reviews rank for game name searches constantly.'},
  {domain:'hubpages.com', da:87, type:'Article/Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Very underused. Long-tail article pages rank consistently.'},
  {domain:'vocal.media', da:81, type:'Article/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Underrated platform. Stories rank well for info queries.'},
  {domain:'wattpad.com', da:92, type:'Story/Creative', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Fiction/story platform. Good for entertainment/celeb fanfic niche.'},
  {domain:'fanfiction.net', da:88, type:'Community/Forum', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Massive fanfiction community. Celebrity/entertainment niche.'},
  {domain:'instructables.com', da:88, type:'How-To/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'How-to community. Step-by-step guides rank for DIY queries.'},
  {domain:'patch.com', da:86, type:'Local News/Blog', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Local news sites. Community posts rank for local searches.'},
  {domain:'myfitnesspal.com', da:88, type:'Community/App', niche:'health', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Fitness community, food diary threads rank for diet queries.'},
  {domain:'dzone.com', da:82, type:'Community/Article', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ', note:'Developer community. Articles rank for coding/dev queries.'},
  {domain:'flipboard.com', da:91, type:'Article/Curation', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Magazine-style sharing. Topics and stories rank for news queries.'},
  {domain:'scoop.it', da:84, type:'Content Curation', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Curated topic pages. Good for topical authority building.'},
  {domain:'diigo.com', da:79, type:'Bookmarking/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Social bookmarking. Shared pages rank for researched topics.'},
  {domain:'theodysseyonline.com', da:61, type:'Community/Article', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Community-written articles. Low competition, ranks for long-tail KWs.'},
  {domain:'beforeitsnews.com', da:55, type:'Community News', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Community news. Articles rank for alternative/niche queries.'},
  {domain:'freeforums.org', da:55, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Free forum hosting. Good for creating targeted niche parasite forums.'},
  {domain:'boardhost.com', da:50, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Simple forum hosting. Niche forums rank for topic discussions.'},
  {domain:'createaforum.com', da:45, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Free forum creation. Custom niche forums rank for specific queries.'},
  {domain:'yuku.com', da:55, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Forum hosting. Niche forums rank for specific topic queries.'},
  {domain:'studybreaks.com', da:52, type:'Article/Community', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'College/entertainment blog. Low DA = low competition, easy to rank.'},
  {domain:'boardnation.com', da:40, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ', note:'Very low DA, untapped. Long-tail forum threads with zero competition.'},
  {domain:'niceboard.com', da:38, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ', note:'Low DA forum tool. Untapped for very specific long-tail keywords.'},
  {domain:'gather.com', da:45, type:'Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ', note:'Low DA community. Very low competition for long-tail content.'},
  {domain:'listal.com', da:67, type:'Community/List', niche:'entertainment', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Movie/music list community. Lists rank for curated content queries.'},
  {domain:'celebmafia.com', da:65, type:'Blog', niche:'celebrity', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Celebrity photo site. Ranks for red carpet/event searches.'},
  {domain:'podomatic.com', da:70, type:'Podcast/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Podcast platform. Episode pages rank for topic + podcast searches.'},
  {domain:'anchor.fm', da:81, type:'Podcast/Community', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Spotify Anchor podcasts. Episode pages rank for niche topics.'},
  {domain:'rebelmouse.com', da:68, type:'Community/Blog', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Content platform, low competition, pages rank for specific queries.'},
  {domain:'paper.li', da:67, type:'Content Curation', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ', note:'Curated news pages rank for niche keyword combinations.'},
  {domain:'manta.com', da:68, type:'Business Directory', niche:'business', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Business directory with blog. Low competition parasite opportunities.'},
  {domain:'weheartit.com', da:80, type:'Visual/Community', niche:'fashion', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Visual content platform. Collections rank for fashion/beauty KWs.'},
  {domain:'phpbb.com', da:78, type:'Forum', niche:'technology', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'phpBB community. Ranks for forum/community tech queries.'},
  {domain:'forumcommunity.net', da:60, type:'Forum', niche:'all', commentEnabled:true, rankPower:'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ', note:'Forum platform. Individual forum pages rank for niche queries.'},
];

// ‚îÄ‚îÄ LIVE SEARCH QUERY BUILDER FOR PARASITES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pfBuildQueries(keyword, niche, platformType, recency){
  const kw = keyword.trim() || (niche !== 'all' ? (PF_NICHES[niche]||[])[0] || niche : 'review');
  const queries = [];
  const platformQueries = {
    all: [`"${kw}" site:google.com`,`"${kw}" site:bing.com`,`"${kw}" site:medium.com`,`"${kw}" site:quora.com`,`"${kw}" site:wordpress.com`,`"${kw}" (site:google.com OR site:bing.com OR site:medium.com)`,`"${kw}" forum community`,`"${kw}" inurl:forum`,`"${kw}" inurl:community`,`"${kw}" site:dev.to OR site:hubpages.com`],
    forum: [`"${kw}" site:google.com`,`"${kw}" site:bing.com`,`"${kw}" inurl:forum`,`"${kw}" inurl:thread`,`"${kw}" forum discussion`,`"${kw}" site:tapatalk.com`,`"${kw}" site:proboards.com OR site:forumotion.com`,`"${kw}" site:stackexchange.com`],
    community: [`"${kw}" community site:google.com`,`"${kw}" community site:bing.com`,`"${kw}" site:groups.google.com`,`"${kw}" site:ning.com`,`"${kw}" community inurl:community`,`"${kw}" site:indiehackers.com OR site:producthunt.com`],
    article: [`"${kw}" site:medium.com`,`"${kw}" site:hubpages.com`,`"${kw}" site:vocal.media`,`"${kw}" site:substack.com`,`"${kw}" site:dev.to`],
    wiki: [`"${kw}" site:fandom.com`,`"${kw}" site:wikia.com`,`"${kw}" site:sites.google.com`,`"${kw}" wiki`,`"${kw}" site:notion.site`],
    entertainment: [`"${kw}" site:imdb.com`,`"${kw}" site:rottentomatoes.com`,`"${kw}" site:fandom.com`,`"${kw}" site:fanpop.com`,`"${kw}" site:buzzfeed.com`,`"${kw}" site:tmz.com OR site:eonline.com`],
    celebrity: [`"${kw}" site:tmz.com`,`"${kw}" site:people.com`,`"${kw}" site:eonline.com`,`"${kw}" site:dailymail.co.uk`,`"${kw}" site:google.com`,`"${kw}" site:bing.com`,`"${kw}" celebrity gossip news`],
    video: [`"${kw}" site:vimeo.com`,`"${kw}" site:dailymotion.com`,`"${kw}" site:twitch.tv`,`"${kw}" video channel creator`,`"${kw}" site:medium.com youtube`],
  };
  const chosen = platformQueries[platformType] || platformQueries.all;
  const recencyMap = {'24h':'after:'+new Date(Date.now()-86400000).toISOString().slice(0,10),'48h':'after:'+new Date(Date.now()-172800000).toISOString().slice(0,10),'7d':'after:'+new Date(Date.now()-604800000).toISOString().slice(0,10),'30d':'after:'+new Date(Date.now()-2592000000).toISOString().slice(0,10),'any':''};
  const dateStr = recencyMap[recency]||'';
  chosen.forEach(q => queries.push({ query: q+(dateStr?' '+dateStr:''), raw: q }));
  return queries;
}

function pfAnalyzeUrl(url, keyword){
  let hostname='';
  try { hostname=new URL(url).hostname.replace('www.',''); } catch(e){ return null; }
  const match = PF_PARASITE_DOMAINS.find(p=>{ const d=p.domain.split('/')[0]; return hostname.includes(d)||url.includes(p.domain); });
  if(match) return {...match, liveUrl:url, keyword, live:true, name:match.domain};
  let da=35, type='Blog/Article', commentEnabled=false, rankPower='‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ', note='Found for "'+keyword+'"';
  if(url.includes('forum')||url.includes('thread')||url.includes('discussion')){ type='Forum'; commentEnabled=true; rankPower='‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ'; note='Forum thread ‚Äî post a reply with your link'; }
  else if(url.includes('community')||url.includes('members')){ type='Community'; commentEnabled=true; rankPower='‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ'; }
  else if(url.includes('/blog')||url.includes('/article')||url.includes('/post')){ type='Blog Post'; commentEnabled=true; rankPower='‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ'; note='Blog post with potential comment section'; }
  else if(url.includes('wiki')||url.includes('fandom')){ type='Wiki'; commentEnabled=true; rankPower='‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ'; da=65; }
  return {domain:hostname, da, type, niche:'all', commentEnabled, rankPower, note, liveUrl:url, keyword, live:true, name:hostname};
}

async function pfLiveSearch(){
  if(_pfRunning) return;
  const keyword=(document.getElementById('pf-keyword')||{value:''}).value.trim();
  const niche=(document.getElementById('pf-niche')||{value:'all'}).value;
  const platformType=(document.getElementById('pf-platform-type')||{value:'all'}).value;
  const recency=(document.getElementById('pf-recency')||{value:'any'}).value;
  const engine=(document.getElementById('pf-engine')||{value:'google'}).value;
  if(!keyword && niche==='all'){ alert('Enter a keyword or select a niche first.'); return; }
  _pfRunning=true; _pfAbort=false; _pfLiveResults=[];
  const btn=document.getElementById('pf-search-btn');
  const stopBtn=document.getElementById('pf-stop-btn');
  const wrap=document.getElementById('pf-results-wrap');
  if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Searching...'; }
  if(stopBtn) stopBtn.style.display='';
  wrap.innerHTML=`<div class="card" style="margin-bottom:12px"><div class="card-title">‚ö° Live Parasite Search Terminal</div><div id="pf-terminal" style="background:#0d1117;border:1px solid #30363d;padding:14px;font-family:var(--mono);font-size:11px;height:180px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9"><div style="color:#58a6ff">ü¶† Searching: <b>${esc(keyword||niche)}</b></div></div></div><div id="pf-live-table-wrap"></div>`;
  function pfLog(msg,color='#c9d1d9'){ const term=document.getElementById('pf-terminal'); if(!term) return; const d=document.createElement('div'); d.innerHTML=`<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`; term.appendChild(d); term.scrollTop=term.scrollHeight; }
  const queries=pfBuildQueries(keyword,niche,platformType,recency);
  pfLog(`üìã ${queries.length} queries built`,'#58a6ff');
  const urlsSeen=new Set();
  // Phase 1: SearXNG (best source)
  pfLog(`üîç Phase 1: SearXNG public instances...`,'#58a6ff');
  let pfPhase1Success = false;
  outerPf:
  for(const instance of CS_SEARXNG_INSTANCES){
    if(_pfAbort) break;
    for(let qi=0;qi<Math.min(queries.length,3);qi++){
      if(_pfAbort) break outerPf;
      const {query}=queries[qi];
      pfLog(`   ‚Üí [${instance.replace('https://','').split('/')[0]}] ${query.slice(0,60)}...`,'#484f58');
      const urls=await csSearxngSearch(query,instance,recency);
      if(urls&&urls.length>0){
        let n=0;
        for(const url of urls){
          if(urlsSeen.has(url)) continue; urlsSeen.add(url);
          const site=pfAnalyzeUrl(url,keyword||niche);
          if(!site||!pfPassesFilter(site)) continue;
          _pfLiveResults.push(site); n++;
        }
        pfLog(`   ‚úÖ ${urls.length} results ‚Üí +${n} sites (${_pfLiveResults.length} total)`,'#3fb950');
        pfPhase1Success=true;
        pfUpdateTable();
        await new Promise(r=>setTimeout(r,300));
        if(_pfLiveResults.length>=50) break outerPf;
      } else { pfLog(`   ‚úó Offline, trying next...`,'#f85149'); break; }
    }
    if(_pfLiveResults.length>=50) break;
  }

  // Phase 2: Proxy-based fallback
  if(!_pfAbort && _pfLiveResults.length<20){
    pfLog(`üîç Phase 2: Proxy scraping ${engine.toUpperCase()} + DDG...`,'#d29922');
    for(let qi=0;qi<queries.length;qi++){
      if(_pfAbort) break;
      const {query}=queries[qi];
      pfLog(`üîç [${qi+1}/${queries.length}] ${query.slice(0,70)}`,'#d29922');
      try {
        // Try DDG first
        let urls=await csDuckDuckGoSearch(query);
        if(!urls||urls.length===0){
          const r=await bcProxyFetch(csBuildSearchUrl(engine,query,recency),{timeout:18000});
          if(r.ok&&r.text.length>500) urls=csExtractUrlsFromHtml(r.text,engine);
        }
        if(urls&&urls.length>0){
          pfLog(`   ‚úì ${urls.length} URLs`,'#3fb950');
          let n=0;
          for(const url of urls){
            if(urlsSeen.has(url)) continue; urlsSeen.add(url);
            const site=pfAnalyzeUrl(url,keyword||niche);
            if(!site||!pfPassesFilter(site)) continue;
            _pfLiveResults.push(site); n++;
          }
          pfLog(`   ‚Üí +${n} new (${_pfLiveResults.length} total)`,'#3fb950');
          pfUpdateTable();
        } else { pfLog(`   ‚ö† No results from proxy`,'#d29922'); }
      } catch(e){ pfLog(`   ‚úó ${e.message}`,'#f85149'); }
      if(qi<queries.length-1&&!_pfAbort) await new Promise(r=>setTimeout(r,700));
    }
  }

  if(_pfLiveResults.length===0){
    pfLog('‚ö† Live search blocked. Loading built-in database + showing manual links.','#d29922');
    pfLoadDatabase(keyword||niche,niche);
    if(!_bcRunning) pfShowManualSearchModal(queries,engine,recency,keyword||niche);
    else pfPendingManualSearchData={queries,engine,recency,keyword:keyword||niche};
  } else { pfLog(`‚úÖ Done ‚Äî ${_pfLiveResults.length} parasite opportunities!`,'#3fb950'); _pfResults=_pfLiveResults; }
  _pfRunning=false;
  if(btn){ btn.disabled=false; btn.innerHTML='ü¶† Search Parasites'; }
  if(stopBtn) stopBtn.style.display='none';
}

function pfPassesFilter(site){
  const f=_pfActiveFilters;
  if(f.da!=='all'){ const [min,max]=f.da.split('-').map(Number); if(site.da<min||(max&&site.da>max)) return false; }
  if(f.type!=='all'){ const typeMap={forum:['Forum','Community','Q&A'],article:['Article','Blog','Newsletter'],review:['Review'],wiki:['Wiki'],video:['Video'],celebrity:['celebrity','entertainment']}; const allowed=typeMap[f.type]||[]; const st=(site.type||'').toLowerCase(); if(!allowed.some(t=>st.includes(t.toLowerCase()))) return false; }
  if(f.comment==='yes'&&!site.commentEnabled) return false;
  if(f.keyword){ const kl=f.keyword.toLowerCase(); if(!(site.domain||'').toLowerCase().includes(kl)&&!(site.type||'').toLowerCase().includes(kl)&&!(site.name||'').toLowerCase().includes(kl)) return false; }
  return true;
}

function pfLoadDatabase(keyword,niche){
  let results=PF_PARASITE_DOMAINS;
  if(niche&&niche!=='all'){ const nicheL=niche.toLowerCase(); results=PF_PARASITE_DOMAINS.filter(p=>p.niche==='all'||p.niche.toLowerCase().includes(nicheL)||nicheL.includes(p.niche.toLowerCase())); if(results.length<10) results=PF_PARASITE_DOMAINS; }
  _pfLiveResults=results.map(r=>({...r,keyword:keyword||'',live:false}));
  _pfResults=_pfLiveResults;
  pfUpdateTable();
}

function pfUpdateTable(){
  const wrap=document.getElementById('pf-live-table-wrap'); if(!wrap) return;
  const results=_pfLiveResults.filter(pfPassesFilter).sort((a,b)=>(b.rankPower||'').length-(a.rankPower||'').length||(b.da||0)-(a.da||0));
  wrap.innerHTML=`
  <div class="flex g8" style="margin-bottom:10px;flex-wrap:wrap">
    <div class="stat g" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px">${results.length}</div><div class="stat-l">Total Found</div></div>
    <div class="stat b" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px;color:var(--accent)">${results.filter(r=>(r.rankPower||'').includes('‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ')).length}</div><div class="stat-l">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Power</div></div>
    <div class="stat y" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px;color:var(--accent3)">${results.filter(r=>r.commentEnabled).length}</div><div class="stat-l">Comment-Enabled</div></div>
    <div class="stat p" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px;color:var(--accent5)">${results.filter(r=>r.live).length}</div><div class="stat-l">Live Results</div></div>
    <div style="flex:0;display:flex;flex-direction:column;gap:4px;justify-content:center">
      <button class="btn btn-primary btn-sm" onclick="pfPushAllToCommenter()">‚ûï Push to Commenter</button>
      <button class="btn btn-ghost btn-sm" onclick="pfExportCSV()">üì§ Export CSV</button>
    </div>
  </div>
  <div class="card" style="padding:12px;margin-bottom:10px">
    <div class="flex aic g8" style="flex-wrap:wrap">
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-weight:700">FILTER:</span>
      <select id="pf-filter-type" style="width:140px" onchange="pfApplyFilter()"><option value="all">All Types</option><option value="forum">Forums</option><option value="article">Articles/Blogs</option><option value="review">Review Sites</option><option value="wiki">Wikis</option><option value="video">Video Platforms</option><option value="celebrity">Celebrity/Entmt</option></select>
      <select id="pf-filter-da" style="width:150px" onchange="pfApplyFilter()"><option value="all">Any DA (20-99)</option><option value="20-50">DA 20-50 (Untapped)</option><option value="50-70">DA 50-70 (Mid)</option><option value="70-85">DA 70-85 (Good)</option><option value="85-99">DA 85+ (Authority)</option></select>
      <select id="pf-filter-comment" style="width:150px" onchange="pfApplyFilter()"><option value="all">All Sites</option><option value="yes">Comment-Enabled Only</option></select>
      <input type="text" id="pf-filter-kw" placeholder="Filter by name/type..." style="flex:1;min-width:130px" oninput="pfApplyFilter()"/>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">${results.length} sites</span>
    </div>
  </div>
  <div class="card"><div class="card-title">ü¶† Parasite Opportunities ‚Äî Ranked by Power</div><div class="tw"><table><thead><tr><th>#</th><th>Platform / Domain</th><th>Type</th><th>DA</th><th>Rank Power</th><th>Comments</th><th>Live URL</th><th>Actions</th></tr></thead><tbody id="pf-table-body">${results.map((r,i)=>pfRowHtml(r,i)).join('')}</tbody></table></div></div>`;
}

function pfRowHtml(r,i){
  const domain=r.domain||r.name||'';
  const baseUrl=r.liveUrl||`https://${domain.split('/')[0]}`;
  const daClass=r.da>=85?'badge-g':r.da>=65?'badge-y':r.da>=45?'badge-b':'badge-r';
  return `<tr><td class="mono xs tm">${i+1}</td><td><a href="${esc(baseUrl)}" target="_blank" style="color:var(--accent);font-family:var(--mono);font-size:11px;font-weight:700;text-decoration:none">${esc(domain)}</a>${r.live?'<span class="badge badge-p" style="margin-left:4px;font-size:8px">LIVE</span>':''}<div style="font-size:9px;color:var(--muted2);font-family:var(--mono);max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px">${esc(r.note||r.whyGood||'')}</div></td><td><span class="mono xs" style="white-space:nowrap">${esc(r.type||'Blog')}</span></td><td><span class="badge ${daClass}">${r.da}</span></td><td style="font-family:var(--mono);font-size:13px;letter-spacing:-1px;white-space:nowrap">${esc(r.rankPower||'‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ')}</td><td>${r.commentEnabled?'<span class="badge badge-g">‚úì Yes</span>':'<span class="badge" style="border-color:var(--border2);color:var(--muted2)">No</span>'}</td><td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.liveUrl?`<a href="${esc(r.liveUrl)}" target="_blank" style="font-family:var(--mono);font-size:9px;color:var(--accent4)">View ‚Üí</a>`:'<span class="tm mono" style="font-size:9px">base</span>'}</td><td><div style="display:flex;gap:4px;flex-wrap:nowrap"><button class="btn btn-ghost btn-xs" onclick="window.open('${esc(baseUrl)}','_blank')">Open</button>${r.commentEnabled?`<button class="btn btn-primary btn-xs" onclick="pfAddToCommenterSite(${i})">+Queue</button>`:''}<button class="btn btn-yellow btn-xs" onclick="navigator.clipboard&&navigator.clipboard.writeText('${esc(baseUrl)}')">Copy</button></div></td></tr>`;
}

function pfApplyFilter(){
  _pfActiveFilters={type:(document.getElementById('pf-filter-type')||{value:'all'}).value,da:(document.getElementById('pf-filter-da')||{value:'all'}).value,comment:(document.getElementById('pf-filter-comment')||{value:'all'}).value,keyword:((document.getElementById('pf-filter-kw')||{value:''}).value||'').toLowerCase()};
  const tbody=document.getElementById('pf-table-body'); if(!tbody) return;
  const filtered=_pfLiveResults.filter(pfPassesFilter).sort((a,b)=>(b.rankPower||'').length-(a.rankPower||'').length||(b.da||0)-(a.da||0));
  tbody.innerHTML=filtered.map((r,i)=>pfRowHtml(r,i)).join('');
}

function pfAddToCommenterSite(idx){
  const filtered=_pfLiveResults.filter(pfPassesFilter).sort((a,b)=>(b.rankPower||'').length-(a.rankPower||'').length||(b.da||0)-(a.da||0));
  const r=filtered[idx]; if(!r) return;
  const url=r.liveUrl||`https://${(r.domain||'').split('/')[0]}`;
  if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label:r.domain||r.name||url,type:'generic',name:'',email:'',website:'',notes:r.note||'',done:false,queued:''}); bcSave(); }
  const btn=event.target; btn.innerHTML='‚úì'; btn.classList.remove('btn-primary'); btn.classList.add('btn-ghost'); btn.disabled=true;
}

function pfShowAutoPosterFromFinder(){
  if(!_pfResults||!_pfResults.length){ alert('Run a parasite search first.'); return; }
  const fakeSites = _pfResults.filter(r=>r.commentEnabled||r.liveUrl).map(r => ({
    url: r.liveUrl||`https://${(r.domain||'').split('/')[0]}`, label: r.domain||r.name||'', status:'success', comment:`Check out this parasite opportunity: ${r.domain||r.name||''}`
  }));
  if(!fakeSites.length){ alert('No comment-enabled sites to push.'); return; }
  bcShowAutoPosterSetup(fakeSites);
}

function pfPushAllToCommenter(){
  if(!_pfResults.length){ alert('Run a search first.'); return; }
  let added=0;
  _pfResults.filter(r=>r.commentEnabled).forEach(r=>{ const url=r.liveUrl||`https://${(r.domain||'').split('/')[0]}`; if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label:r.domain||r.name||url,type:'generic',name:'',email:'',website:'',notes:r.note||'',done:false,queued:''}); added++; } });
  bcSave(); alert(`‚úì Added ${added} comment-enabled parasite sites to Blog Commenter!`);
}

function pfPushToCommenter(){ pfPushAllToCommenter(); }

function pfExportCSV(){
  const data=_pfResults.length?_pfResults:PF_PARASITE_DOMAINS;
  const rows=[['Domain','DA','Type','Rank Power','Comments','Niche','Live URL','Notes'],...data.map(r=>[r.domain||r.name||'',r.da,r.type,r.rankPower||'',r.commentEnabled?'Yes':'No',r.niche||'',r.liveUrl||`https://${(r.domain||'').split('/')[0]}`,r.note||r.whyGood||''])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='parasite-sites-'+Date.now()+'.csv'; a.click();
}

function pfStopSearch(){ _pfAbort=true; _pfRunning=false; _pfResults=_pfLiveResults; const btn=document.getElementById('pf-search-btn'); const stopBtn=document.getElementById('pf-stop-btn'); if(btn){ btn.disabled=false; btn.innerHTML='ü¶† Search Parasites'; } if(stopBtn) stopBtn.style.display='none'; }

function pfShowManualSearchModal(queries,engine,recency,keyword){
  // If blog commenter is actively running, defer the popup ‚Äî show inline below results instead
  if(_bcRunning){
    pfPendingManualSearchData = {queries, engine, recency, keyword};
    console.log('[pfShowManualSearchModal] Commenter running ‚Äî deferring popup');
    return;
  }
  pfRenderManualSearchPopup(queries,engine,recency,keyword);
}

let pfPendingManualSearchData = null;

function pfRenderManualSearchPopup(queries,engine,recency,keyword){
  const overlay=document.createElement('div'); overlay.className='modal-overlay'; overlay.onclick=e=>{if(e.target===overlay) overlay.remove();};
  const linksHtml = queries.map((q,i)=>{const url=csBuildSearchUrl(engine,q.query,recency);return `<div style="padding:9px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px"><span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px;flex-shrink:0">${i+1}</span><div style="flex:1;min-width:0;font-family:var(--mono);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.query)}</div><a href="${esc(url)}" target="_blank" class="btn btn-primary btn-xs">Search ‚Üí</a></div>`;}).join('');
  overlay.innerHTML=`<div class="modal-box" style="min-width:560px;max-width:740px"><div class="modal-title">üîó Manual Parasite Search <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï</button></div><div class="notice notice-info" style="margin-bottom:12px">CORS blocked direct fetch. Click each link to manually find parasite sites for <b>${esc(keyword)}</b>.</div><div style="max-height:420px;overflow-y:auto">${linksHtml}</div><div class="row mt8"><button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button></div></div>`;
  document.body.appendChild(overlay);
}
function pfScan(){ pfLiveSearch(); }
function pfAddToCommenter(domain){ const url=`https://${domain}`; if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label:domain,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''}); bcSave(); } alert(`‚úì ${domain} added to Blog Commenter!`); }

function renderParasiteFinder(el){
  el.innerHTML=`
  <div class="page-title">ü¶† Parasite Sites Finder ‚Äî v3 Live Search</div>
  <div class="page-sub">// real-time search ¬∑ forums, communities, wikis ¬∑ celebrity, entertainment, video ¬∑ DA 20-99 ¬∑ untapped low-DA gems</div>
  <div class="card">
    <div class="card-title">üîç Parasite Search</div>
    <div class="grid2" style="margin-bottom:12px">
      <div class="fg mb0"><label class="lbl">Keyword / Topic <span style="color:var(--accent2)">*</span></label>
        <input type="text" id="pf-keyword" placeholder="e.g. celebrity net worth, weight loss, crypto review..." style="font-size:13px;padding:10px 14px" onkeydown="if(event.key==='Enter') pfLiveSearch()" oninput="pfPreview()"/></div>
      <div class="fg mb0"><label class="lbl">Niche / Category</label>
        <select id="pf-niche" onchange="pfPreview()"><option value="all">All Niches</option>${Object.keys(PF_NICHES).map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('')}</select></div>
    </div>
    <div class="grid3">
      <div class="fg mb0"><label class="lbl">Platform Type</label>
        <select id="pf-platform-type" onchange="pfPreview()"><option value="all">All Platforms</option><option value="forum">Forums &amp; Communities</option><option value="community">Communities Only</option><option value="article">Articles &amp; Blogs</option><option value="wiki">Wikis &amp; Databases</option><option value="entertainment">Entertainment</option><option value="celebrity">Celebrity &amp; Gossip</option><option value="video">Video Platforms</option></select></div>
      <div class="fg mb0"><label class="lbl">Search Engine</label>
        <select id="pf-engine"><option value="google">Google</option><option value="bing">Bing</option><option value="duckduckgo">DuckDuckGo</option></select></div>
      <div class="fg mb0"><label class="lbl">Post Recency</label>
        <select id="pf-recency"><option value="any">Any time</option><option value="24h">Last 24 hours</option><option value="48h">Last 48 hours</option><option value="7d">Last 7 days</option><option value="30d">Last month</option></select></div>
    </div>
    <div id="pf-query-preview" style="margin-top:10px;padding:10px 12px;background:#0d1117;border:1px solid #30363d;border-radius:6px;font-family:var(--mono);font-size:10px;color:#58a6ff;display:none"><span style="color:#484f58">SAMPLE QUERY ‚Üí </span><span id="pf-query-text"></span></div>
    <div class="flex aic g8 mt8" style="flex-wrap:wrap">
      <button class="btn btn-primary" id="pf-search-btn" onclick="pfLiveSearch()" style="padding:10px 22px;font-size:11px">ü¶† Search Parasites</button>
      <button class="btn btn-danger btn-sm" id="pf-stop-btn" onclick="pfStopSearch()" style="display:none">‚èπ Stop</button>
      <button class="btn btn-ghost btn-sm" onclick="pfLoadDatabaseUI()">üìö Load All 80+ Known Parasites</button>
      <button class="btn btn-ghost btn-sm" onclick="pfExportCSV()">üì§ Export CSV</button>
      <button class="btn btn-blue btn-sm" onclick="pfPushAllToCommenter()">‚ûï Push to Commenter</button>
      <button class="btn btn-ghost btn-sm" onclick="pfShowAutoPosterFromFinder()" title="Auto-post to GitHub/Netlify/WordPress from parasite sites">üì§ Auto Poster</button>
    </div>
  </div>
  <div id="pf-results-wrap">
    <div class="notice notice-info">üí° <strong>Enter a keyword</strong> (e.g. "celebrity net worth", "weight loss") + choose a platform type ‚Üí hit Search. The tool queries Google/Bing using parasite operators like <code>"keyword" site:reddit.com</code>, <code>"keyword" inurl:forum</code> to find which parasite platforms are already ranking.<br><br>Covers: forums, communities, wikis, celebrity sites, entertainment platforms, video, and low-DA untapped gems from DA 20 to 99.</div>
  </div>`;
  setTimeout(()=>{ const inp=document.getElementById('pf-keyword'); if(inp) inp.focus(); },100);
}

function pfPreview(){
  const kw=(document.getElementById('pf-keyword')||{value:''}).value.trim();
  const niche=(document.getElementById('pf-niche')||{value:'all'}).value;
  const platform=(document.getElementById('pf-platform-type')||{value:'all'}).value;
  const preview=document.getElementById('pf-query-preview');
  const previewText=document.getElementById('pf-query-text');
  if(!kw&&niche==='all'){ if(preview) preview.style.display='none'; return; }
  if(preview) preview.style.display='';
  const q=pfBuildQueries(kw||(PF_NICHES[niche]||[])[0]||niche,niche,platform,'any')[0];
  if(previewText&&q) previewText.textContent=q.query;
}

function pfLoadDatabaseUI(){
  pfLoadDatabase('','all');
  const wrap=document.getElementById('pf-results-wrap');
  if(!document.getElementById('pf-live-table-wrap')){ const div=document.createElement('div'); div.id='pf-live-table-wrap'; wrap.innerHTML=''; wrap.appendChild(div); }
  pfUpdateTable();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMENT SITES FINDER ‚Äî v3 REAL-TIME SEARCH ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _csResults = [];
let _csRunning = false;
let _csLiveResults = []; // live search accumulation
let _csSearchAbort = false;
let _csActiveFilters = { type:'all', link:'all', da:'all', keyword:'' };

// ‚îÄ‚îÄ SEARCH QUERY BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Builds Google/Bing search queries using inurl:/intitle: operators to
// find real fresh pages with comment sections

function csBuildQueries(keyword, platform, recency){
  const kw = keyword.trim();
  const queries = [];

  // Platform-specific inurl patterns
  const platformPatterns = {
    wordpress: [
      `"${kw}" inurl:wp-content "leave a reply"`,
      `"${kw}" intitle:"${kw}" "add a comment" wordpress`,
      `"${kw}" site:wordpress.com "leave a comment"`,
      `"${kw}" inurl:/?p= "leave a reply"`,
    ],
    blogger: [
      `"${kw}" site:blogspot.com "post a comment"`,
      `"${kw}" site:blogspot.com "no comments" OR "leave a comment"`,
    ],
    generic: [
      `"${kw}" "leave a comment" -site:youtube.com -site:facebook.com`,
      `"${kw}" "post a comment" "name" "email" -site:reddit.com`,
      `"${kw}" "add a comment" inurl:blog`,
      `"${kw}" "comments (0)" OR "be the first to comment"`,
      `"${kw}" intitle:"comment" "name" "email" "website"`,
    ],
    forum: [
      `"${kw}" site:forums.* "reply"`,
      `"${kw}" inurl:forum "reply to this"`,
      `"${kw}" "forum" "post reply" -site:reddit.com`,
    ],
    blog: [
      `"${kw}" inurl:blog "leave a reply"`,
      `"${kw}" intitle:"blog" "leave a comment"`,
      `"${kw}" "posted in" "tags:" "leave a comment"`,
    ],
    news: [
      `"${kw}" "news" "leave a comment" -site:bbc.com -site:cnn.com`,
      `"${kw}" site:*.com/news "comment below"`,
    ],
    all: [
      `"${kw}" "leave a reply"`,
      `"${kw}" "leave a comment" blog`,
      `"${kw}" "post a comment" "name" "email"`,
      `"${kw}" "add a comment" -site:youtube.com`,
    ]
  };

  const chosen = platformPatterns[platform] || platformPatterns.all;

  // Add recency modifier
  const recencyMap = {
    '24h': 'after:' + new Date(Date.now()-86400000).toISOString().slice(0,10),
    '48h': 'after:' + new Date(Date.now()-172800000).toISOString().slice(0,10),
    '7d':  'after:' + new Date(Date.now()-604800000).toISOString().slice(0,10),
    '30d': 'after:' + new Date(Date.now()-2592000000).toISOString().slice(0,10),
    'any': ''
  };
  const dateStr = recencyMap[recency]||'';

  chosen.forEach(q => {
    queries.push({ query: q + (dateStr?' '+dateStr:''), raw: q });
  });

  return queries;
}

// ‚îÄ‚îÄ SEARCH ENGINE URL BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function csBuildSearchUrl(engine, query, recency){
  const enc = encodeURIComponent(query);

  if(engine === 'google'){
    let url = `https://www.google.com/search?q=${enc}&num=30`;
    const tbsMap = { '24h':'qdr:d', '48h':'qdr:d2', '7d':'qdr:w', '30d':'qdr:m' };
    if(tbsMap[recency]) url += `&tbs=${tbsMap[recency]}`;
    return url;
  }

  if(engine === 'bing'){
    let url = `https://www.bing.com/search?q=${enc}&count=30`;
    const freshMap = { '24h':'day', '48h':'day', '7d':'week', '30d':'month' };
    if(freshMap[recency]) url += `&filters=ex1%3a"ez${freshMap[recency]}"`;
    return url;
  }

  if(engine === 'duckduckgo'){
    let url = `https://html.duckduckgo.com/html/?q=${enc}`;
    return url;
  }

  return `https://www.google.com/search?q=${enc}`;
}

// ‚îÄ‚îÄ EXTRACT URLS FROM SEARCH RESULT HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function csExtractUrlsFromHtml(html, engine){
  const urls = new Set();
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  if(engine === 'google'){
    // Google result links are in <a> tags with href containing /url?q=
    doc.querySelectorAll('a[href]').forEach(a => {
      const href = a.getAttribute('href')||'';
      const m = href.match(/\/url\?q=(https?:\/\/[^&]+)/);
      if(m){
        try { urls.add(decodeURIComponent(m[1])); } catch(e){}
      }
      // Also direct links
      if(href.startsWith('http') && !href.includes('google.com')){
        urls.add(href);
      }
    });

    // Also scan for cite tags and data-href
    doc.querySelectorAll('cite, [data-href]').forEach(el => {
      const t = (el.textContent||el.getAttribute('data-href')||'').trim();
      if(t.startsWith('http')) urls.add(t);
      else if(t && !t.includes(' ')) urls.add('https://'+t);
    });
  }

  if(engine === 'bing'){
    doc.querySelectorAll('a[href], h2 a, li.b_algo a').forEach(a => {
      const href = a.getAttribute('href')||'';
      if(href.startsWith('http') && !href.includes('bing.com') && !href.includes('microsoft.com')){
        urls.add(href);
      }
    });
  }

  if(engine === 'duckduckgo'){
    doc.querySelectorAll('a.result__a, a[href*="//"]').forEach(a => {
      const href = a.getAttribute('href')||'';
      const m = href.match(/uddg=(https?:\/\/[^&]+)/);
      if(m){ try { urls.add(decodeURIComponent(m[1])); } catch(e){} }
      else if(href.startsWith('http') && !href.includes('duckduckgo.com')){
        urls.add(href);
      }
    });
  }

  // Filter to real URLs
  return [...urls].filter(u => {
    try {
      const uo = new URL(u);
      return uo.hostname.includes('.') &&
        !uo.hostname.includes('google') &&
        !uo.hostname.includes('bing.com') &&
        !uo.hostname.includes('duckduckgo') &&
        !uo.hostname.includes('yahoo.com') &&
        !uo.hostname.includes('facebook.com') &&
        !uo.hostname.includes('twitter.com') &&
        !uo.hostname.includes('instagram.com') &&
        !uo.hostname.includes('youtube.com') &&
        !uo.hostname.includes('amazon.com') &&
        !uo.hostname.includes('wikipedia.org') &&
        u.length < 300;
    } catch(e){ return false; }
  }).slice(0,20);
}

// ‚îÄ‚îÄ SMART SITE ANALYZER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function csAnalyzeSite(url, keyword){
  let hostname = '';
  try { hostname = new URL(url).hostname; } catch(e){ return null; }

  // Guess DA from known domains
  const daMap = {
    'wordpress.com':95,'blogspot.com':97,'medium.com':95,'tumblr.com':96,
    'reddit.com':98,'quora.com':93,'stackoverflow.com':95,'github.com':96,
    'blogger.com':97,'typepad.com':80,'weebly.com':85,'wix.com':90,
    'squarespace.com':88,'substack.com':91,'ghost.io':72,'hashnode.dev':82,
    'dev.to':88,'hackernews':90,'forum':60,'community':65,'blog':50,
  };

  let da = 45; // base DA for unknown sites
  for(const [domain, score] of Object.entries(daMap)){
    if(hostname.includes(domain)){ da = score; break; }
  }

  // Guess type from URL
  let type = 'Blog';
  if(url.includes('/forum') || url.includes('/community') || url.includes('/discuss')) type = 'Forum';
  else if(url.includes('/blog') || hostname.includes('blog')) type = 'Blog';
  else if(url.includes('/news') || hostname.includes('news')) type = 'News';
  else if(hostname.includes('wordpress.com') || url.includes('wp-content')) type = 'WordPress Blog';
  else if(hostname.includes('blogspot.com')) type = 'Blogger';
  else if(hostname.includes('medium.com')) type = 'Medium Article';
  else if(hostname.includes('reddit.com')) type = 'Reddit Thread';
  else if(url.includes('/question') || url.includes('/ask') || hostname.includes('quora')) type = 'Q&A';

  // Guess dofollow
  const dofollow = hostname.includes('wordpress.com') || hostname.includes('dev.to') ||
    hostname.includes('hashnode') || hostname.includes('vocal.media') ||
    hostname.includes('instructables.com') || da < 60;

  return {
    url: url,
    name: hostname.replace('www.',''),
    type,
    da,
    dofollow,
    notes: `Found for "${keyword}" ‚Äî verify comment section`,
    live: true,
    keyword
  };
}

// ‚îÄ‚îÄ SEARXNG + MULTI-ENGINE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CS_SEARXNG_INSTANCES = [
  'https://searx.be',
  'https://search.mdosch.de',
  'https://searxng.world',
  'https://searx.tiekoetter.com',
  'https://search.ononoki.org',
  'https://priv.au',
  'https://searx.prvcy.eu',
  'https://northboot.xyz',
  'https://paulgo.io',
  'https://searx.work',
  'https://etsi.me',
  'https://searx.fmac.xyz',
];

async function csSearxngSearch(query, instance, recency){
  const params = new URLSearchParams({ q: query, format: 'json', categories: 'general' });
  if(recency !== 'any'){
    const trMap = {'24h':'day','48h':'day','7d':'week','30d':'month'};
    if(trMap[recency]) params.set('time_range', trMap[recency]);
  }
  const url = `${instance}/search?${params}`;
  try {
    const resp = await Promise.race([
      fetch(url, { headers: { 'Accept': 'application/json' } }),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),10000))
    ]);
    if(!resp.ok) return null;
    const data = await resp.json();
    if(data && data.results && data.results.length > 0){
      return data.results.map(r => r.url).filter(Boolean);
    }
  } catch(e){}
  return null;
}

async function csDuckDuckGoSearch(query){
  const enc = encodeURIComponent(query);
  const url = `https://html.duckduckgo.com/html/?q=${enc}`;
  const result = await bcProxyFetch(url, { timeout: 14000 });
  if(result.ok && result.text.length > 1000){
    return csExtractUrlsFromHtml(result.text, 'duckduckgo');
  }
  return null;
}

async function csBraveSearch(query){
  const enc = encodeURIComponent(query);
  const url = `https://search.brave.com/search?q=${enc}&source=web`;
  const result = await bcProxyFetch(url, { timeout: 14000 });
  if(result.ok && result.text.length > 1000){
    const urls = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(result.text, 'text/html');
    doc.querySelectorAll('a[href]').forEach(a => {
      const href = a.href || a.getAttribute('href') || '';
      try {
        const u = new URL(href);
        if(u.hostname && !u.hostname.includes('brave.com')){ urls.push(href); }
      } catch(e){}
    });
    return urls.slice(0,30);
  }
  return null;
}

async function csGoogleBingSearch(query, engine, recency){
  const searchUrl = csBuildSearchUrl(engine, query, recency);
  const result = await bcProxyFetch(searchUrl, { timeout: 18000 });
  if(result.ok && result.text.length > 500){
    return { urls: csExtractUrlsFromHtml(result.text, engine), proxy: result.proxy };
  }
  return null;
}

// ‚îÄ‚îÄ MAIN LIVE SEARCH ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function csLiveSearch(){
  if(_csRunning){ return; }
  const keyword = (document.getElementById('cs-keyword')||{value:''}).value.trim();
  if(!keyword){ alert('Enter a keyword first ‚Äî e.g. "weight loss", "wordpress tutorial"'); return; }

  const engine = (document.getElementById('cs-engine')||{value:'google'}).value;
  const platform = (document.getElementById('cs-platform')||{value:'all'}).value;
  const recency = (document.getElementById('cs-recency')||{value:'any'}).value;

  _csRunning = true;
  _csSearchAbort = false;
  _csLiveResults = [];

  const btn = document.getElementById('cs-search-btn');
  const stopBtn = document.getElementById('cs-stop-btn');
  const resultsWrap = document.getElementById('cs-results-wrap');

  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Searching...'; }
  if(stopBtn) stopBtn.style.display = '';

  resultsWrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="card-title">‚ö° Live Search Terminal</div>
      <div id="cs-terminal" style="background:#0d1117;border:1px solid #30363d;padding:14px;font-family:var(--mono);font-size:11px;height:220px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9">
        <div style="color:#58a6ff">üöÄ Starting live search for: <b>${esc(keyword)}</b></div>
      </div>
    </div>
    <div id="cs-live-table-wrap"></div>`;

  function csLog(msg, color='#c9d1d9'){
    const term = document.getElementById('cs-terminal');
    if(!term) return;
    const d = document.createElement('div');
    d.innerHTML = `<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`;
    term.appendChild(d);
    term.scrollTop = term.scrollHeight;
  }

  const queries = csBuildQueries(keyword, platform, recency);
  csLog(`üìã ${queries.length} queries built | platform: ${platform} | engine: ${engine}`, '#58a6ff');
  csLog(`üîç Trying: SearXNG instances ‚Üí DuckDuckGo ‚Üí ${engine} ‚Üí Brave ‚Üí DB fallback`, '#484f58');

  const urlsSeen = new Set();

  function ingestUrls(urls){
    if(!urls || !urls.length) return 0;
    let added = 0;
    for(const url of urls){
      if(_csSearchAbort) break;
      if(urlsSeen.has(url)) continue;
      urlsSeen.add(url);
      const site = csAnalyzeSite(url, keyword);
      if(!site) continue;
      if(!csPassesFilter(site)) continue;
      _csLiveResults.push(site);
      added++;
    }
    if(added > 0){ csUpdateLiveTable(); }
    return added;
  }

  // ‚îÄ PHASE 1: SearXNG (real results, JSON API, no auth, CORS-open) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  csLog(`üîé Phase 1: Trying ${CS_SEARXNG_INSTANCES.length} SearXNG public instances...`, '#d29922');
  let anyPhase1 = false;

  outerLoop:
  for(const instance of CS_SEARXNG_INSTANCES){
    if(_csSearchAbort) break;
    const sn = instance.replace('https://','');
    for(let qi = 0; qi < Math.min(queries.length, 4); qi++){
      if(_csSearchAbort) break outerLoop;
      const {query} = queries[qi];
      csLog(`   ‚Üí SearXNG [${sn}] Q${qi+1}: ${query.slice(0,50)}...`, '#484f58');
      const urls = await csSearxngSearch(query, instance, recency);
      if(urls && urls.length > 0){
        const added = ingestUrls(urls);
        csLog(`   ‚úÖ ${urls.length} results ‚Üí ${added} new sites (total: ${_csLiveResults.length})`, '#3fb950');
        anyPhase1 = true;
        await new Promise(r=>setTimeout(r,350));
        if(_csLiveResults.length >= 60) break outerLoop;
      } else {
        csLog(`   ‚úó [${sn}] offline or blocked`, '#f85149');
        break;
      }
    }
    if(_csLiveResults.length >= 60) break;
  }

  if(anyPhase1){
    csLog(`‚úÖ Phase 1 done ‚Äî ${_csLiveResults.length} sites so far`, '#3fb950');
  } else {
    csLog(`‚ö† All SearXNG instances offline. Falling back to proxy scraping...`, '#d29922');
  }

  // ‚îÄ PHASE 2: DuckDuckGo + engine + Brave via CORS proxies ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!_csSearchAbort && _csLiveResults.length < 30){
    csLog(`üîé Phase 2: Proxy-scraping ${engine.toUpperCase()} + DDG + Brave...`, '#d29922');

    for(let qi = 0; qi < queries.length && !_csSearchAbort; qi++){
      const {query} = queries[qi];
      csLog(`   üîç Q${qi+1}/${queries.length}: ${query.slice(0,55)}...`, '#d29922');

      const ddgUrls = await csDuckDuckGoSearch(query);
      if(ddgUrls && ddgUrls.length > 0){
        const added = ingestUrls(ddgUrls);
        csLog(`      ‚úÖ DuckDuckGo: ${ddgUrls.length} URLs ‚Üí ${added} new sites`, '#3fb950');
      } else {
        const r = await csGoogleBingSearch(query, engine, recency);
        if(r && r.urls && r.urls.length > 0){
          const added = ingestUrls(r.urls);
          csLog(`      ‚úÖ ${engine} via [${r.proxy}]: ${r.urls.length} URLs ‚Üí ${added} sites`, '#3fb950');
        } else {
          const bUrls = await csBraveSearch(query);
          if(bUrls && bUrls.length > 0){
            const added = ingestUrls(bUrls);
            csLog(`      ‚úÖ Brave: ${bUrls.length} URLs ‚Üí ${added} new sites`, '#3fb950');
          } else {
            const fbUrl = csBuildSearchUrl(engine, query, recency);
            csLog(`      ‚úó All blocked ‚Äî <a href="${esc(fbUrl)}" target="_blank" style="color:#58a6ff">Open ${engine} manually ‚Üí</a>`, '#f85149');
          }
        }
      }
      if(qi < queries.length - 1 && !_csSearchAbort){ await new Promise(r=>setTimeout(r,700)); }
    }
  }

  // ‚îÄ PHASE 3: Built-in DB fallback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(_csLiveResults.length === 0){
    csLog(`‚ö† Live search returned 0 results. Loading built-in database...`, '#d29922');
    _csLiveResults = CS_KNOWN.map(s => ({...s, keyword}));
    csUpdateLiveTable();
    csShowSearchUrls(queries, engine, recency);
    csLog(`üìö Loaded ${_csLiveResults.length} sites from built-in database`, '#58a6ff');
  } else {
    csLog(`‚úÖ Search complete ‚Äî <b style="color:#3fb950">${_csLiveResults.length} live sites found!</b>`, '#3fb950');
  }

  _csResults = _csLiveResults;
  _csRunning = false;
  if(btn){ btn.disabled = false; btn.innerHTML = 'üîç Search'; }
  if(stopBtn) stopBtn.style.display = 'none';
}

function csPassesFilter(site){
  const f = _csActiveFilters;
  if(f.link === 'dofollow' && !site.dofollow) return false;
  if(f.link === 'nofollow' && site.dofollow) return false;
  if(f.type !== 'all'){
    const typeMap = {
      wordpress:['WordPress Blog','WordPress'],
      blogger:['Blogger'],
      blog:['Blog','Blog Post'],
      forum:['Forum','Thread'],
      qa:['Q&A'],
      news:['News'],
      community:['Community'],
    };
    const allowed = typeMap[f.type]||[];
    if(!allowed.some(t => (site.type||'').includes(t))) return false;
  }
  if(f.da !== 'all'){
    const [min,max] = f.da.split('-').map(Number);
    if(site.da < min || (max && site.da > max)) return false;
  }
  return true;
}

function csShowSearchUrls(queries, engine, recency){
  // Never interrupt active blog commenter session with popups
  if(_bcRunning){
    pfPendingManualSearchData = pfPendingManualSearchData || {queries, engine, recency, keyword:'search'};
    return;
  }
  const wrap = document.getElementById('cs-live-table-wrap');
  if(!wrap) return;
  const linksHtml = queries.map((q,i) => {
    const url = csBuildSearchUrl(engine, q.query, recency);
    return `<div style="padding:8px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px;text-align:right">${i+1}</span>
      <div style="flex:1;min-width:0">
        <div style="font-family:var(--mono);font-size:10px;color:var(--accent);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.query)}</div>
      </div>
      <a href="${esc(url)}" target="_blank" class="btn btn-ghost btn-xs">üîç Open in ${engine}</a>
    </div>`;
  }).join('');

  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `<div class="card-title">üîó Manual Search URLs ‚Äî Open Each to Find Comment Sites</div>
    <div class="notice notice-warn">Due to browser security (CORS), open these links manually, copy site URLs you find, then add them to your queue.</div>
    <div style="max-height:400px;overflow-y:auto">${linksHtml}</div>`;
  wrap.appendChild(div);
}

function csUpdateLiveTable(){
  const wrap = document.getElementById('cs-live-table-wrap');
  if(!wrap) return;

  const results = _csLiveResults;
  if(!results.length) return;

  wrap.innerHTML = `
  <div class="flex g8" style="margin-bottom:10px;flex-wrap:wrap">
    <div class="stat g" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px">${results.length}</div>
      <div class="stat-l">Found</div>
    </div>
    <div class="stat b" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px;color:var(--accent)">${results.filter(r=>r.dofollow).length}</div>
      <div class="stat-l">Dofollow</div>
    </div>
    <div class="stat y" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px;color:var(--accent3)">${results.filter(r=>r.live).length}</div>
      <div class="stat-l">Live Results</div>
    </div>
    <div class="stat p" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px;color:var(--accent5)">${results.filter(r=>r.da>=70).length}</div>
      <div class="stat-l">DA 70+</div>
    </div>
    <div style="flex:0">
      <button class="btn btn-primary btn-sm" onclick="csPushAllToCommenter()">‚ûï Push All to Commenter</button>
      <button class="btn btn-blue btn-sm" onclick="csShowAutoPosterSetupFromResults()" title="Push found sites to Auto Poster for scheduled posting">üì§ Push to Auto Poster</button>
      <button class="btn btn-ghost btn-sm" style="margin-top:4px" onclick="csExportLive()">üì§ Export CSV</button>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="card" style="padding:12px;margin-bottom:10px">
    <div class="flex aic g8" style="flex-wrap:wrap">
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-weight:700">FILTER:</span>
      <select id="cs-filter-type" style="width:130px" onchange="csApplyFilter()">
        <option value="all">All Types</option>
        <option value="wordpress">WordPress</option>
        <option value="blogger">Blogger</option>
        <option value="blog">Blog</option>
        <option value="forum">Forum</option>
        <option value="qa">Q&A</option>
        <option value="news">News</option>
        <option value="community">Community</option>
      </select>
      <select id="cs-filter-link" style="width:130px" onchange="csApplyFilter()">
        <option value="all">All Links</option>
        <option value="dofollow">Dofollow Only</option>
        <option value="nofollow">Nofollow Only</option>
      </select>
      <select id="cs-filter-da" style="width:130px" onchange="csApplyFilter()">
        <option value="all">Any DA</option>
        <option value="1-40">DA 1-40</option>
        <option value="1-60">DA 1-60</option>
        <option value="40-70">DA 40-70</option>
        <option value="60-100">DA 60+</option>
        <option value="80-100">DA 80+</option>
      </select>
      <input type="text" id="cs-filter-kw" placeholder="Filter by URL or name..." style="flex:1;min-width:150px" oninput="csApplyFilter()"/>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">${results.length} sites</span>
    </div>
  </div>

  <div class="card">
    <div class="card-title">‚úÖ Comment-Enabled Sites ‚Äî Real-Time Results</div>
    <div class="tw">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Site / URL</th>
            <th>Type</th>
            <th>DA</th>
            <th>Links</th>
            <th>Source</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="cs-table-body">
          ${results.map((r,i) => csRowHtml(r,i)).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
}

function csRowHtml(r, i){
  return `<tr>
    <td class="mono xs tm">${i+1}</td>
    <td>
      <a href="${esc(r.url)}" target="_blank" style="color:var(--accent);font-family:var(--mono);font-size:11px;font-weight:700;text-decoration:none;display:block;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.name||r.url)}</a>
      <div style="font-size:9px;color:var(--muted2);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:280px">${esc(r.url)}</div>
    </td>
    <td><span class="mono xs" style="white-space:nowrap">${esc(r.type||'Blog')}</span></td>
    <td>
      <span class="badge ${r.da>=80?'badge-g':r.da>=60?'badge-y':r.da>=40?'badge-b':'badge-r'}">${r.da}</span>
    </td>
    <td>${r.dofollow?'<span class="badge badge-g">‚úì DoF</span>':'<span class="badge" style="border-color:var(--border2);color:var(--muted2)">Nofollow</span>'}</td>
    <td><span class="badge ${r.live?'badge-p':'badge-b'}">${r.live?'üî¥ LIVE':'DB'}</span></td>
    <td>
      <div style="display:flex;gap:4px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-xs" onclick="window.open('${esc(r.url)}','_blank')">Open</button>
        <button class="btn btn-primary btn-xs" onclick="csAddToCommenterObj(${i})">+ Queue</button>
      </div>
    </td>
  </tr>`;
}

function csApplyFilter(){
  const type = (document.getElementById('cs-filter-type')||{value:'all'}).value;
  const link = (document.getElementById('cs-filter-link')||{value:'all'}).value;
  const da = (document.getElementById('cs-filter-da')||{value:'all'}).value;
  const kw = ((document.getElementById('cs-filter-kw')||{value:''}).value||'').toLowerCase();

  _csActiveFilters = { type, link, da, keyword: kw };

  const filtered = _csLiveResults.filter(r => {
    if(!csPassesFilter(r)) return false;
    if(kw && !r.url.toLowerCase().includes(kw) && !(r.name||'').toLowerCase().includes(kw)) return false;
    return true;
  });

  const tbody = document.getElementById('cs-table-body');
  if(tbody) tbody.innerHTML = filtered.map((r,i) => csRowHtml(r,i)).join('');

  // Update count
  const countEls = document.querySelectorAll('#cs-live-table-wrap .stat-v');
  if(countEls[0]) countEls[0].textContent = filtered.length;
}

function csAddToCommenterObj(idx){
  const filtered = _csLiveResults.filter(r => {
    if(!csPassesFilter(r)) return false;
    const kw = _csActiveFilters.keyword||'';
    if(kw && !r.url.toLowerCase().includes(kw) && !(r.name||'').toLowerCase().includes(kw)) return false;
    return true;
  });
  const r = filtered[idx];
  if(!r) return;
  if(!_bcSites.find(s=>s.url===r.url)){
    _bcSites.push({id:uid(),url:r.url,label:r.name||r.url,type:r.type&&r.type.toLowerCase().includes('word')?'wordpress':'generic',name:'',email:'',website:'',notes:r.notes||'',done:false,queued:''});
    bcSave();
    const btn = event.target;
    btn.innerHTML = '‚úì Added'; btn.classList.remove('btn-primary'); btn.classList.add('btn-ghost');
    btn.disabled = true;
  }
}

function csShowAutoPosterSetupFromResults(){
  if(!_csLiveResults||!_csLiveResults.length){ alert('Run a search first.'); return; }
  const fakeSites = _csLiveResults.map(r => ({
    url: r.url, label: r.name||r.url, status: 'success', comment: `Great resource on ${r.keyword||'this topic'}: ${r.url}`
  }));
  bcShowAutoPosterSetup(fakeSites);
}

function csPushAllToCommenter(){
  if(!_csResults.length){alert('Run a search first.');return;}
  let added=0;
  _csResults.forEach(r=>{
    if(!_bcSites.find(s=>s.url===r.url)){
      _bcSites.push({id:uid(),url:r.url,label:r.name||r.url,type:r.type&&r.type.toLowerCase().includes('word')?'wordpress':'generic',name:'',email:'',website:'',notes:r.notes||'',done:false,queued:''});
      added++;
    }
  });
  bcSave();
  alert(`‚úì Added ${added} sites to Blog Commenter!`);
}

function csExportLive(){
  if(!_csResults.length){alert('Run a search first.');return;}
  const rows=[['Name','URL','Type','DA','Dofollow','Source','Notes'],
    ..._csResults.map(r=>[r.name||'',r.url,r.type||'',r.da,r.dofollow?'Yes':'No',r.live?'Live Search':'Database',r.notes||''])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='comment-sites-'+Date.now()+'.csv';a.click();
}

function csStopSearch(){
  _csSearchAbort = true;
  _csRunning = false;
  _csResults = _csLiveResults;
  const btn = document.getElementById('cs-search-btn');
  const stopBtn = document.getElementById('cs-stop-btn');
  if(btn){ btn.disabled = false; btn.innerHTML = 'üîç Search'; }
  if(stopBtn) stopBtn.style.display = 'none';
}

const CS_KNOWN = [
  // Blogs/CMS that allow public comments
  {url:'https://www.blogger.com', name:'Blogger', type:'Blog Platform', da:97, dofollow:false, notes:'Millions of blogs with open comments'},
  {url:'https://wordpress.com', name:'WordPress.com', type:'Blog Platform', da:95, dofollow:false, notes:'Largest blog platform, most allow comments'},
  {url:'https://disqus.com', name:'Disqus', type:'Comment System', da:91, dofollow:false, notes:'Powers comments on 500k+ sites'},
  {url:'https://www.intensedebate.com', name:'IntenseDebate', type:'Comment System', da:82, dofollow:true, notes:'Dofollow links in profile'},
  {url:'https://www.livejournal.com', name:'LiveJournal', type:'Blog', da:88, dofollow:true, notes:'Public blogs allow open comments'},
  {url:'https://medium.com', name:'Medium', type:'Article Platform', da:95, dofollow:false, notes:'Response/comment system on all articles'},
  {url:'https://vocal.media', name:'Vocal.media', type:'Article Platform', da:81, dofollow:true, notes:'Public comment section on all stories'},
  {url:'https://hubpages.com', name:'HubPages', type:'Article Site', da:87, dofollow:false, notes:'Comments on all hubs'},
  {url:'https://www.tumblr.com', name:'Tumblr', type:'Blog', da:96, dofollow:false, notes:'Reblog + comment system'},
  {url:'https://dev.to', name:'Dev.to', type:'Tech Blog', da:88, dofollow:true, notes:'Developer community, dofollow profile links'},
  {url:'https://hashnode.com', name:'Hashnode', type:'Tech Blog', da:85, dofollow:true, notes:'Dev blogs, open commenting'},
  {url:'https://hackernoon.com', name:'HackerNoon', type:'Tech Article', da:87, dofollow:false, notes:'Comment via social login'},
  {url:'https://producthunt.com', name:'Product Hunt', type:'Community', da:90, dofollow:true, notes:'Comment on product listings'},
  {url:'https://indiehackers.com', name:'Indie Hackers', type:'Community', da:82, dofollow:true, notes:'Forum + comment system'},
  {url:'https://community.hubspot.com', name:'HubSpot Community', type:'Forum', da:93, dofollow:false, notes:'Marketing/SEO discussions'},
  {url:'https://moz.com/community', name:'Moz Community', type:'Forum', da:91, dofollow:false, notes:'SEO community posts'},
  {url:'https://www.quora.com', name:'Quora', type:'Q&A', da:93, dofollow:false, notes:'Add comments to any answer'},
  {url:'https://reddit.com', name:'Reddit', type:'Forum', da:98, dofollow:false, notes:'Hundreds of niche subreddits'},
  {url:'https://forums.digitalpoint.com', name:'Digital Point', type:'Forum', da:81, dofollow:true, notes:'SEO/marketing forum with dofollow'},
  {url:'https://www.warriorforum.com', name:'Warrior Forum', type:'Forum', da:84, dofollow:false, notes:'Internet marketing community'},
  {url:'https://blackhatworld.com', name:'Black Hat World', type:'Forum', da:85, dofollow:false, notes:'SEO/marketing discussion forum'},
  {url:'https://www.sitepoint.com/community', name:'SitePoint', type:'Forum', da:88, dofollow:false, notes:'Web dev discussions'},
  {url:'https://stackexchange.com', name:'Stack Exchange', type:'Q&A', da:92, dofollow:false, notes:'Technical Q&A network'},
  {url:'https://answers.yahoo.com', name:'Yahoo Answers', type:'Q&A', da:93, dofollow:false, notes:'General Q&A platform'},
  {url:'https://www.ehow.com', name:'eHow', type:'How-To', da:89, dofollow:false, notes:'How-to articles with comments'},
  {url:'https://www.instructables.com', name:'Instructables', type:'How-To', da:88, dofollow:true, notes:'DIY community, open commenting'},
  {url:'https://www.wikihow.com', name:'wikiHow', type:'How-To', da:91, dofollow:false, notes:'Community edit + discussion tabs'},
  {url:'https://digg.com', name:'Digg', type:'News/Blog', da:88, dofollow:false, notes:'Comment on curated articles'},
  {url:'https://www.stumbleupon.com', name:'Mix (StumbleUpon)', type:'Social', da:85, dofollow:false, notes:'Comment on shared pages'},
  {url:'https://www.scoop.it', name:'Scoop.it', type:'Content Curation', da:84, dofollow:true, notes:'Curation platform with dofollow comments'},
  {url:'https://www.bloglovin.com', name:'Bloglovin', type:'Blog Aggregator', da:86, dofollow:false, notes:'Follow/comment on blogs'},
  {url:'https://www.zoomit.ir', name:'Zoomit', type:'Tech News', da:78, dofollow:false, notes:'Tech news comment section'},
  {url:'https://www.techrepublic.com', name:'TechRepublic', type:'Tech News', da:88, dofollow:false, notes:'Open comment section'},
  {url:'https://www.zdnet.com', name:'ZDNet', type:'Tech News', da:91, dofollow:false, notes:'Tech articles with Disqus comments'},
  {url:'https://ahrefs.com/blog', name:'Ahrefs Blog', type:'SEO Blog', da:91, dofollow:false, notes:'SEO blog with open commenting'},
  {url:'https://searchengineland.com', name:'Search Engine Land', type:'SEO News', da:90, dofollow:false, notes:'Industry comments section'},
  {url:'https://www.semrush.com/blog', name:'SEMrush Blog', type:'SEO Blog', da:90, dofollow:false, notes:'Marketing blog with comments'},
  {url:'https://neilpatel.com/blog', name:'Neil Patel Blog', type:'Marketing Blog', da:88, dofollow:false, notes:'Very active comment section'},
  {url:'https://backlinko.com/blog', name:'Backlinko', type:'SEO Blog', da:87, dofollow:false, notes:'Brian Dean\'s SEO blog comments'},
  {url:'https://moz.com/blog', name:'Moz Blog', type:'SEO Blog', da:91, dofollow:false, notes:'SEO blog with community comments'},
];

function renderCommentSites(el){
  el.innerHTML=`
  <div class="page-title">üåê Comment Sites Finder</div>
  <div class="page-sub">// real-time search ¬∑ find fresh blogs & forums with open comments ¬∑ keyword-powered ¬∑ instant results</div>

  <!-- SEARCH PANEL -->
  <div class="card">
    <div class="card-title">üîç Live Search Parameters</div>

    <div class="grid2" style="margin-bottom:12px">
      <div class="fg mb0">
        <label class="lbl">Keyword / Niche <span style="color:var(--accent2)">*required</span></label>
        <input type="text" id="cs-keyword" placeholder='e.g. wordpress tutorial, weight loss, crypto news'
          style="font-size:13px;padding:10px 14px"
          oninput="csRealTimePreview()"
          onkeydown="if(event.key==='Enter') csLiveSearch()"/>
      </div>
      <div class="fg mb0">
        <label class="lbl">Target Platform</label>
        <select id="cs-platform">
          <option value="all">All Platforms (Broadest)</option>
          <option value="wordpress">WordPress Sites</option>
          <option value="blogger">Blogger / Blogspot</option>
          <option value="blog">Any Blog</option>
          <option value="forum">Forums</option>
          <option value="news">News Sites</option>
          <option value="qa">Q&amp;A Sites</option>
        </select>
      </div>
    </div>

    <div class="grid3">
      <div class="fg mb0">
        <label class="lbl">Search Engine</label>
        <select id="cs-engine">
          <option value="google">Google</option>
          <option value="bing">Bing</option>
          <option value="duckduckgo">DuckDuckGo</option>
        </select>
      </div>
      <div class="fg mb0">
        <label class="lbl">Post Recency / Time Filter</label>
        <select id="cs-recency">
          <option value="any">Any time (most results)</option>
          <option value="24h">Last 24 hours</option>
          <option value="48h">Last 48 hours</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last month</option>
        </select>
      </div>
      <div class="fg mb0">
        <label class="lbl">Comment Type Filter</label>
        <select id="cs-linktype">
          <option value="leave a reply">Leave a Reply (WordPress)</option>
          <option value="post a comment">Post a Comment</option>
          <option value="add a comment">Add a Comment</option>
          <option value="leave a comment">Leave a Comment</option>
          <option value="comment">Generic Comments</option>
        </select>
      </div>
    </div>

    <!-- Live query preview -->
    <div id="cs-query-preview" style="margin-top:10px;padding:10px 12px;background:#0d1117;border:1px solid #30363d;border-radius:6px;font-family:var(--mono);font-size:10px;color:#58a6ff;display:none">
      <span style="color:#484f58">QUERY PREVIEW ‚Üí </span><span id="cs-query-text"></span>
    </div>

    <div class="flex aic g8 mt8" style="flex-wrap:wrap">
      <button class="btn btn-primary" id="cs-search-btn" onclick="csLiveSearch()" style="padding:10px 24px;font-size:11px">
        üîç Search
      </button>
      <button class="btn btn-danger btn-sm" id="cs-stop-btn" onclick="csStopSearch()" style="display:none">‚èπ Stop</button>
      <button class="btn btn-ghost btn-sm" onclick="csShowManualLinks()">üîó Open Search in Browser</button>
      <button class="btn btn-ghost btn-sm" onclick="csLoadBuiltIn()">üìö Load Built-in Database</button>
      <button class="btn btn-ghost btn-sm" onclick="csExportLive()">üì§ Export CSV</button>
      <div id="cs-status" style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-left:auto"></div>
    </div>
  </div>

  <div id="cs-results-wrap">
    <div class="notice notice-info">
      üí° <strong>How it works:</strong> Type a keyword + select recency ‚Üí hit Search ‚Üí the tool builds Google/Bing search queries using <code>"keyword" "leave a reply"</code> operators, fetches results via CORS proxy, and lists every blog/forum it finds with an open comment section.
      <br><br>If the proxy is blocked, click <strong>"Open Search in Browser"</strong> to manually run each query and copy URLs.
    </div>
  </div>`;

  document.getElementById('cs-keyword').addEventListener('input', csRealTimePreview);
}

function csRealTimePreview(){
  const kw = (document.getElementById('cs-keyword')||{value:''}).value.trim();
  const platform = (document.getElementById('cs-platform')||{value:'all'}).value;
  const ctype = (document.getElementById('cs-linktype')||{value:'leave a reply'}).value;
  const engine = (document.getElementById('cs-engine')||{value:'google'}).value;
  const recency = (document.getElementById('cs-recency')||{value:'any'}).value;
  const preview = document.getElementById('cs-query-preview');
  const previewText = document.getElementById('cs-query-text');
  if(!kw){ if(preview) preview.style.display='none'; return; }
  if(preview) preview.style.display='';
  const q = csBuildQueries(kw, platform, recency)[0];
  if(previewText && q) previewText.textContent = q.query + ` ‚Üí ${engine}.com`;
}

function csShowManualLinks(){
  const keyword = (document.getElementById('cs-keyword')||{value:''}).value.trim();
  if(!keyword){ alert('Enter a keyword first.'); return; }
  const engine = (document.getElementById('cs-engine')||{value:'google'}).value;
  const platform = (document.getElementById('cs-platform')||{value:'all'}).value;
  const recency = (document.getElementById('cs-recency')||{value:'any'}).value;
  const queries = csBuildQueries(keyword, platform, recency);
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = e => { if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML = `<div class="modal-box" style="min-width:600px;max-width:800px">
    <div class="modal-title">üîó Manual Search Links ‚Äî Open Each in Browser
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">‚úï</button>
    </div>
    <div class="notice notice-info" style="margin-bottom:12px">Click each link to search ${engine} for comment-enabled sites in <b>${esc(keyword)}</b>. Copy any site URLs you find and add them to the Commenter queue.</div>
    <div style="max-height:440px;overflow-y:auto">
      ${queries.map((q,i)=>{
        const url = csBuildSearchUrl(engine, q.query, recency);
        return `<div style="padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
          <span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px;text-align:right;flex-shrink:0">${i+1}</span>
          <div style="flex:1;min-width:0">
            <div style="font-family:var(--mono);font-size:10px;color:var(--text);font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.query)}</div>
          </div>
          <a href="${esc(url)}" target="_blank" class="btn btn-primary btn-xs">Open in ${engine} ‚Üí</a>
        </div>`;
      }).join('')}
    </div>
    <div class="row mt8">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function csLoadBuiltIn(){
  _csLiveResults = CS_KNOWN.map(s=>({...s}));
  _csResults = _csLiveResults;
  csUpdateLiveTable();
  const wrap = document.getElementById('cs-results-wrap');
  if(wrap && !document.getElementById('cs-live-table-wrap')){
    wrap.innerHTML = `<div id="cs-live-table-wrap"></div>`;
    csUpdateLiveTable();
  }
}

function csFind(){ csLiveSearch(); }
function csAIFind(){ csLiveSearch(); }
function csPushToCommenter(){ csPushAllToCommenter(); }
function csExport(){ csExportLive(); }

function csAddToCommenter(url, name){
  if(!_bcSites.find(s=>s.url===url)){
    _bcSites.push({id:uid(),url,label:name,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''});
    bcSave();
  }
  alert(`‚úì ${name} added to Blog Commenter queue!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
updatePlatformBar();
updateHeader();
renderPage('dashboard');
</script>
</body>
</html>
