
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SEO PARASITE PRO v15 â€” Settings Â· Help Â· 33 Sources Â· Live APIs</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Tahoma:wght@400;700&display=swap" rel="stylesheet">
<style>
/* =============================================
   SCRAPEBOX STYLE â€” WINDOWS DESKTOP APP UI
   ============================================= */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* ScrapeBox color palette â€” classic Windows gray + green terminal */
  --win-bg:#ece9d8;          /* Classic Windows XP beige-gray */
  /* â”€â”€ ALIAS VARS (used in JS templates) â”€â”€ */
  --mono:'Share Tech Mono',monospace;
  --accent:#0a4dc4;
  --accent2:#888888;
  --muted2:#6b6b6b;
  --border:#808080;
  /* â”€â”€ NEW MODULE VARS â”€â”€ */
  --supabase:#3ecf8e;
  --toast-success:#006600;
  --toast-error:#cc0000;
  --toast-warn:#997700;
  --toast-info:#003087;
  --win-surface:#f0ede5;     /* Panel surface */
  --win-dark:#d4d0c8;        /* Darker panel */
  --win-border:#808080;      /* 3D border outer */
  --win-border-hi:#ffffff;   /* 3D border highlight */
  --win-border-sh:#404040;   /* 3D border shadow */
  --win-blue:#003087;        /* Title bar blue deep */
  --win-blue2:#0a4dc4;       /* Title bar blue light */
  --win-btn:#d4d0c8;         /* Button face */
  --win-btn-hi:#ffffff;      /* Button highlight */
  --win-btn-sh:#808080;      /* Button shadow */
  --win-btn-dk:#404040;      /* Button dark shadow */
  --win-sel:#316ac5;         /* Selection blue */
  --win-sel-text:#fff;
  --win-text:#000000;        /* Black text */
  --win-text-dim:#444444;
  --win-text-muted:#6b6b6b;
  --win-red:#cc0000;
  --win-green:#006600;
  --win-yellow:#997700;
  /* Terminal â€” dark green phosphor */
  --term-bg:#0a0f0a;
  --term-text:#00cc44;
  --term-dim:#006622;
  --term-warn:#ccaa00;
  --term-err:#cc2200;
  --term-info:#0099cc;
  --term-accent:#00ffcc;
  /* Accent for badges */
  --badge-new:#cc0000;
  --badge-blue:#003087;
  --badge-green:#006600;
}

/* â”€â”€ FONTS â”€â”€ */
body{
  background:var(--win-bg);
  color:var(--win-text);
  font-family:Tahoma,'MS Sans Serif',Arial,sans-serif;
  font-size:11px;
  min-height:100vh;
  overflow-x:hidden;
}

/* â”€â”€ 3D BORDER HELPERS â”€â”€ */
.raised{border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi)}
.sunken{border:2px solid;border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh)}
.inset{border:1px solid;border-color:var(--win-border-sh) var(--win-border-hi) var(--win-border-hi) var(--win-border-sh)}
.groove{border:2px groove #808080}

/* â”€â”€ TITLE BAR â”€â”€ */
.app{display:flex;flex-direction:column;min-height:100vh}
.header{
  background:linear-gradient(to right, var(--win-blue), var(--win-blue2));
  padding:4px 8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  height:28px;
  flex-shrink:0;
  user-select:none;
}
.logo{
  display:flex;
  align-items:center;
  gap:6px;
  color:#ffffff;
  font-family:'Share Tech Mono',monospace;
  font-size:12px;
  font-weight:700;
  letter-spacing:0.04em;
}
.logo-icon{
  width:16px;height:16px;
  background:#ffcc00;
  display:grid;place-items:center;
  font-size:10px;
  font-weight:700;
  color:#000;
}
.logo-ver{
  font-size:9px;
  color:rgba(255,255,255,0.65);
  font-family:'Share Tech Mono',monospace;
  margin-left:4px;
}
.header-right{
  display:flex;
  align-items:center;
  gap:8px;
}
.hdr-stat{
  font-family:'Share Tech Mono',monospace;
  font-size:10px;
  color:#cce0ff;
}
.hdr-pill{
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:rgba(0,0,0,0.3);
  border:1px solid rgba(255,255,255,0.2);
  color:#fff;
  font-size:9px;
  font-family:'Share Tech Mono',monospace;
  padding:2px 8px;
  letter-spacing:0.06em;
}
.hdr-pill.active{background:rgba(0,150,0,0.4);border-color:rgba(0,255,0,0.3);color:#00ff88}

/* â”€â”€ TOOLBAR / MENU â”€â”€ */
.toolbar{
  background:var(--win-dark);
  border-bottom:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  display:flex;
  align-items:center;
  padding:2px 4px;
  gap:2px;
  flex-wrap:wrap;
  min-height:26px;
}
.tb-sep{width:1px;height:18px;background:var(--win-btn-sh);margin:0 3px;flex-shrink:0}
.tb-sep-hi{width:1px;height:18px;background:var(--win-btn-hi);flex-shrink:0}
.tb-btn{
  display:inline-flex;
  align-items:center;
  gap:3px;
  padding:2px 6px;
  font-size:11px;
  font-family:Tahoma,Arial,sans-serif;
  cursor:pointer;
  background:var(--win-btn);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  color:var(--win-text);
  white-space:nowrap;
  transition:none;
  user-select:none;
  line-height:1;
  font-weight:700;
}
.tb-btn:hover{background:#e8e4dc}
.tb-btn:active{border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);padding:3px 5px 1px 7px}
.tb-btn.active{
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  background:#d0ccc0;
  padding:3px 5px 1px 7px;
}
.tb-btn-icon{font-size:13px;line-height:1}
.tb-label{font-size:9px;color:var(--win-text-muted);padding:0 4px;align-self:center;font-style:italic}

/* â”€â”€ PLATFORM TABS â”€â”€ */
.platform-bar{
  background:var(--win-dark);
  border-bottom:2px solid var(--win-btn-sh);
  display:flex;
  overflow-x:auto;
  scrollbar-width:thin;
  scrollbar-color:var(--win-btn-sh) var(--win-dark);
  padding-bottom:0;
}
.platform-bar::-webkit-scrollbar{height:6px}
.platform-bar::-webkit-scrollbar-thumb{background:var(--win-btn-sh)}
.ptab{
  display:flex;
  align-items:center;
  gap:3px;
  padding:4px 10px 4px;
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  cursor:pointer;
  color:var(--win-text-dim);
  border-right:1px solid var(--win-btn-sh);
  border-top:2px solid transparent;
  white-space:nowrap;
  user-select:none;
  background:var(--win-dark);
  transition:none;
}
.ptab:hover{background:#dad6ce;color:#000}
.ptab.active{
  background:var(--win-bg);
  color:#000;
  border-top-color:var(--win-blue2);
  border-bottom:2px solid var(--win-bg);
  margin-bottom:-2px;
  font-weight:700;
  position:relative;
  z-index:1;
}
.ptab-da{font-size:8px;color:var(--win-text-muted);margin-left:2px;font-family:'Share Tech Mono',monospace}

/* â”€â”€ MAIN LAYOUT â”€â”€ */
.main{display:flex;flex:1;min-height:0;overflow:hidden}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{
  width:190px;
  flex-shrink:0;
  background:var(--win-dark);
  border-right:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  display:flex;
  flex-direction:column;
  overflow-y:auto;
  overflow-x:hidden;
}
.sidebar-bottom{margin-top:auto;border-top:2px solid var(--win-btn-sh)}
.nav-section{
  font-size:9px;
  font-family:'Share Tech Mono',monospace;
  letter-spacing:0.1em;
  color:var(--win-text-muted);
  padding:8px 8px 3px;
  text-transform:uppercase;
  font-weight:700;
  background:var(--win-dark);
  user-select:none;
}
.nav-item{
  display:flex;
  align-items:center;
  gap:5px;
  padding:4px 8px 4px 12px;
  font-size:11px;
  font-family:Tahoma,Arial,sans-serif;
  cursor:pointer;
  color:var(--win-text);
  user-select:none;
  white-space:nowrap;
  overflow:hidden;
}
.nav-item:hover{background:var(--win-sel);color:var(--win-sel-text)}
.nav-item:hover .nav-badge{background:rgba(255,255,255,0.25);color:#fff;border-color:rgba(255,255,255,0.4)}
.nav-item.active{background:var(--win-sel);color:var(--win-sel-text);font-weight:700}
.nav-item.active .nav-badge{background:rgba(255,255,255,0.25);color:#fff;border-color:rgba(255,255,255,0.4)}
.nav-icon{font-size:12px;width:14px;text-align:center;flex-shrink:0}
.nav-badge{
  margin-left:auto;
  font-size:8px;
  font-family:'Share Tech Mono',monospace;
  background:var(--win-dark);
  color:var(--win-text-dim);
  padding:1px 4px;
  border:1px solid var(--win-btn-sh);
  font-weight:700;
  flex-shrink:0;
}
.nav-badge.red{background:#cc0000;color:#fff;border-color:#880000}
.nav-badge.blue{background:#003087;color:#fff;border-color:#001050}

/* â”€â”€ CONTENT AREA â”€â”€ */
.content{
  flex:1;
  padding:12px 16px;
  overflow-y:auto;
  background:var(--win-bg);
  overflow-x:hidden;
}
.page{display:none}.page.active{display:block}

/* â”€â”€ PAGE TITLE â”€â”€ */
.page-title{
  font-size:14px;
  font-weight:700;
  font-family:Tahoma,Arial,sans-serif;
  margin-bottom:2px;
  color:#000;
  border-bottom:2px solid var(--win-btn-sh);
  padding-bottom:4px;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:6px;
}
.page-sub{
  font-size:10px;
  color:var(--win-text-muted);
  margin-bottom:12px;
  font-family:'Share Tech Mono',monospace;
}

/* â”€â”€ CARDS / PANELS â”€â”€ */
.card{
  background:var(--win-surface);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  padding:8px;
  margin-bottom:10px;
}
.card-title{
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  letter-spacing:0.08em;
  color:#fff;
  text-transform:uppercase;
  margin:-8px -8px 8px;
  padding:3px 8px;
  background:var(--win-blue);
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:space-between;
  user-select:none;
}

/* â”€â”€ FORM GROUPS â”€â”€ */
.fg{margin-bottom:8px}
.lbl{
  display:block;
  font-size:11px;
  color:var(--win-text);
  margin-bottom:2px;
  font-weight:700;
  font-family:Tahoma,Arial,sans-serif;
}

/* â”€â”€ INPUTS â”€â”€ */
input[type=text],input[type=password],input[type=number],input[type=url],input[type=email],textarea,select{
  width:100%;
  background:#ffffff;
  border:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  color:#000;
  padding:3px 5px;
  font-family:'Share Tech Mono',monospace;
  font-size:11px;
  outline:none;
  -webkit-appearance:none;
  appearance:none;
}
input:focus,textarea:focus,select:focus{
  outline:1px dotted var(--win-blue2);
  outline-offset:-2px;
}
select option{background:#fff;color:#000}
textarea{resize:vertical;min-height:60px;line-height:1.5}

/* â”€â”€ GRIDS â”€â”€ */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:3px 10px;
  font-family:Tahoma,Arial,sans-serif;
  font-size:11px;
  cursor:pointer;
  background:var(--win-btn);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  color:#000;
  white-space:nowrap;
  user-select:none;
  font-weight:400;
}
.btn:hover{background:#dedad0}
.btn:active{border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);padding:4px 9px 2px 11px}
.btn:disabled{color:var(--win-text-muted);opacity:0.7;cursor:not-allowed}
.btn-primary{background:#d4d0c8;font-weight:700;border-color:var(--win-btn-hi) var(--win-btn-dk) var(--win-btn-dk) var(--win-btn-hi)}
.btn-primary:hover:not(:disabled){background:#c8c4bc}
.btn-danger{color:var(--win-red)}
.btn-ghost{background:var(--win-btn)}
.btn-yellow{color:var(--win-yellow)}
.btn-blue{color:var(--win-blue)}
.btn-sm{padding:1px 6px;font-size:10px}
.btn-xs{padding:0px 4px;font-size:9px}

/* â”€â”€ STATUS BAR â”€â”€ */
.statusbar{
  background:var(--win-dark);
  border-top:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  display:flex;
  align-items:center;
  padding:2px 8px;
  gap:8px;
  min-height:20px;
  flex-shrink:0;
}
.sb-panel{
  border:1px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  padding:1px 8px;
  font-family:'Share Tech Mono',monospace;
  font-size:9px;
  color:var(--win-text-dim);
  white-space:nowrap;
}

/* â”€â”€ UTILS â”€â”€ */
.row{display:flex;gap:8px;align-items:flex-end}
.flex{display:flex}.aic{align-items:center}.jb{justify-content:space-between}.g8{gap:8px}.g12{gap:12px}.ml{margin-left:auto}
.f1{flex:1}.mb0{margin-bottom:0}.mt8{margin-top:8px}.mt12{margin-top:12px}
.mono{font-family:'Share Tech Mono',monospace}.sm{font-size:11px}.xs{font-size:10px}
.ta{color:var(--win-blue)}.tr{color:var(--win-red)}.ty{color:var(--win-yellow)}.tb{color:#006699}.tp{color:#660066}.tm{color:var(--win-text-muted)}

/* â”€â”€ TERMINAL â”€â”€ */
.terminal{
  background:var(--term-bg);
  border:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  padding:6px 8px;
  font-family:'Share Tech Mono',monospace;
  font-size:11px;
  height:200px;
  overflow-y:auto;
  line-height:1.7;
  color:var(--term-text);
  scrollbar-color:var(--term-dim) var(--term-bg);
}
.terminal::-webkit-scrollbar{width:8px}
.terminal::-webkit-scrollbar-track{background:#050a05}
.terminal::-webkit-scrollbar-thumb{background:var(--term-dim)}
.tline{display:flex;gap:8px}
.ttime{color:#224422;flex-shrink:0;font-size:9px;padding-top:1px}
.t-info{color:var(--term-text)}
.t-warn{color:var(--term-warn)}
.t-error{color:var(--term-err)}
.t-accent{color:var(--term-accent)}
.tm-dark{color:var(--term-dim)}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-wrap{
  height:12px;
  background:#ffffff;
  border:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  margin:6px 0;
  overflow:hidden;
}
.prog-fill{
  height:100%;
  background:var(--win-blue);
  background:repeating-linear-gradient(
    90deg,
    var(--win-blue) 0px,
    var(--win-blue2) 8px,
    var(--win-blue) 16px
  );
  transition:width 0.3s linear;
  width:0%;
}

/* â”€â”€ STAT BOXES â”€â”€ */
.stat{
  background:var(--win-surface);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  padding:8px;
  text-align:center;
}
.stat::before{display:none}
.stat-v{
  font-size:24px;
  font-weight:700;
  font-family:'Share Tech Mono',monospace;
  line-height:1;
  color:#000;
}
.stat-l{
  font-size:9px;
  color:var(--win-text-muted);
  font-family:'Share Tech Mono',monospace;
  letter-spacing:0.06em;
  text-transform:uppercase;
  margin-top:3px;
}
.stat.g .stat-v{color:var(--win-green)}
.stat.r .stat-v{color:var(--win-red)}
.stat.y .stat-v{color:var(--win-yellow)}
.stat.b .stat-v{color:#003087}
.stat.p .stat-v{color:#660066}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow-x:auto}
table{
  width:100%;
  border-collapse:collapse;
  font-family:Tahoma,Arial,sans-serif;
  font-size:11px;
}
th{
  text-align:left;
  padding:3px 8px;
  color:#fff;
  background:var(--win-blue);
  font-size:10px;
  white-space:nowrap;
  font-weight:700;
  border-right:1px solid rgba(255,255,255,0.15);
  user-select:none;
}
td{
  padding:3px 8px;
  border-bottom:1px solid #d4d0c8;
  color:#000;
  vertical-align:middle;
}
tr:nth-child(even) td{background:#e8e4dc}
tr:hover td{background:#c8d8f0}

/* â”€â”€ BADGES â”€â”€ */
.badge{
  display:inline-block;
  padding:0px 5px;
  font-size:9px;
  font-family:'Share Tech Mono',monospace;
  white-space:nowrap;
  font-weight:700;
  border:1px solid;
}
.badge-g{background:#d0ffd0;color:#004400;border-color:#006600}
.badge-r{background:#ffd0d0;color:#440000;border-color:#880000}
.badge-y{background:#fff0c0;color:#553300;border-color:#887700}
.badge-b{background:#d0d8f8;color:#001055;border-color:#003087}
.badge-p{background:#f0d0f8;color:#440055;border-color:#660066}

/* â”€â”€ CHIPS â”€â”€ */
.chips{display:flex;flex-wrap:wrap;gap:3px;margin-top:5px}
.chip{
  display:inline-block;
  padding:2px 7px;
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  border:1px solid var(--win-btn-sh);
  color:var(--win-text-dim);
  cursor:pointer;
  background:var(--win-btn);
  user-select:none;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
}
.chip:hover,.chip.on{
  background:var(--win-sel);
  color:#fff;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{
  display:inline-block;width:10px;height:10px;
  border:2px solid var(--win-btn-sh);
  border-top-color:var(--win-blue2);
  animation:spin 0.7s linear infinite;
  vertical-align:middle;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.blink{animation:blink 1s infinite}

/* â”€â”€ URL BANNER â”€â”€ */
.url-banner{
  background:#fff;
  border:2px solid;
  border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);
  padding:6px 10px;
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:6px;
}
.ub-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--win-blue);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:1px;font-weight:700}
.ub-url{font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:700}
.ub-url a{color:var(--win-blue);text-decoration:underline}
.ub-url a:hover{color:var(--win-blue2)}

/* â”€â”€ LINK ROW â”€â”€ */
.link-row{
  display:grid;
  grid-template-columns:1fr 1fr auto auto;
  gap:6px;
  align-items:center;
  padding:4px 6px;
  background:#fff;
  border:1px solid var(--win-btn-sh);
  margin-bottom:4px;
}

/* â”€â”€ MINI TABS â”€â”€ */
.mtabs{
  display:flex;
  border-bottom:2px solid var(--win-btn-sh);
  margin-bottom:8px;
  flex-wrap:wrap;
  gap:2px;
}
.mtab{
  padding:3px 10px;
  font-family:Tahoma,Arial,sans-serif;
  font-size:11px;
  cursor:pointer;
  color:var(--win-text);
  background:var(--win-dark);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) transparent var(--win-btn-hi);
  user-select:none;
  margin-bottom:-2px;
}
.mtab:hover{background:#dad6ce}
.mtab.on{
  background:var(--win-bg);
  font-weight:700;
  border-bottom-color:var(--win-bg);
}

/* â”€â”€ NOTICES â”€â”€ */
.notice{
  padding:6px 10px;
  font-family:'Share Tech Mono',monospace;
  font-size:10px;
  line-height:1.6;
  margin-bottom:8px;
  border-left:4px solid;
}
.notice-info{border-color:#003087;background:#d0d8f0;color:#001055}
.notice-warn{border-color:#997700;background:#fff0b0;color:#443300}
.notice-success{border-color:#006600;background:#d0f0d0;color:#003300}
.notice-err{border-color:#880000;background:#f8d0d0;color:#440000}

/* â”€â”€ PLATFORM STATUS CARDS â”€â”€ */
.pstat{
  background:var(--win-surface);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  padding:6px 4px;
  text-align:center;
  cursor:pointer;
}
.pstat:hover{background:#e0dcf0;border-color:var(--win-blue)}
.pstat-icon{font-size:16px;margin-bottom:3px}
.pstat-name{font-size:9px;color:var(--win-text-muted);letter-spacing:0.04em;text-transform:uppercase;margin-bottom:3px;font-weight:700;font-family:'Share Tech Mono',monospace}
.pstat-status{font-size:9px;font-weight:700;font-family:'Share Tech Mono',monospace}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center}
.modal-box{
  background:var(--win-surface);
  border:3px solid;
  border-color:var(--win-btn-hi) var(--win-btn-dk) var(--win-btn-dk) var(--win-btn-hi);
  min-width:400px;
  max-width:90vw;
  position:relative;
}
.modal-title{
  background:linear-gradient(to right,var(--win-blue),var(--win-blue2));
  color:#fff;
  font-size:12px;
  font-weight:700;
  padding:4px 8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  user-select:none;
}
.modal-body{padding:12px}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:14px}
::-webkit-scrollbar-track{background:var(--win-dark);border-left:1px solid var(--win-btn-sh)}
::-webkit-scrollbar-thumb{
  background:var(--win-btn);
  border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
}
::-webkit-scrollbar-button{background:var(--win-btn);display:block;height:14px;width:14px;border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi)}

/* â”€â”€ MISC â”€â”€ */
.hidden{display:none!important}
.link-status-ok{color:var(--win-green);font-size:10px;font-family:'Share Tech Mono',monospace;font-weight:700}
.link-status-broken{color:var(--win-red);font-size:10px;font-family:'Share Tech Mono',monospace;font-weight:700}
.link-status-checking{color:var(--win-yellow);font-size:10px;font-family:'Share Tech Mono',monospace;font-weight:700}
.link-status-unknown{color:var(--win-text-muted);font-size:10px;font-family:'Share Tech Mono',monospace;font-weight:700}

/* â”€â”€ GROUPBOX (ScrapeBox-style labeled panels) â”€â”€ */
.groupbox{
  border:2px groove var(--win-btn-sh);
  padding:8px 8px 8px;
  margin-bottom:8px;
  position:relative;
}
.groupbox-title{
  position:absolute;
  top:-7px;
  left:8px;
  background:var(--win-bg);
  padding:0 4px;
  font-size:11px;
  font-weight:700;
  font-family:Tahoma,Arial,sans-serif;
  color:#000;
}

/* â”€â”€ CHECKLIST ITEMS â”€â”€ */
.chk-row{display:flex;align-items:center;gap:5px;padding:2px 0;cursor:pointer;user-select:none}
.chk-row input[type=checkbox]{width:auto;border:1px solid var(--win-btn-sh);background:#fff;cursor:pointer}
.chk-row label{cursor:pointer;font-size:11px}

/* â”€â”€ PAGE WRAP (new module layout) â”€â”€ */
.page-wrap{padding:10px 12px;display:flex;flex-direction:column;gap:8px}
.page-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px;gap:8px}
.page-hdr-right{display:flex;align-items:center;gap:6px;flex-shrink:0}

/* â”€â”€ PANEL (ScrapeBox-style grouped section) â”€â”€ */
.panel{background:var(--win-surface);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);margin-bottom:0}
.panel-title{font-size:10px;font-family:'Share Tech Mono',monospace;letter-spacing:.08em;color:#fff;text-transform:uppercase;padding:3px 8px;background:linear-gradient(to right,var(--win-blue),var(--win-blue2));display:flex;align-items:center;justify-content:space-between}
.panel-body{padding:8px}
.panel-row{display:flex;gap:8px;align-items:flex-start}

/* â”€â”€ INFO BOX â”€â”€ */
.info-box{background:var(--win-bg);border:1px solid var(--win-btn-sh);padding:8px;font-size:11px}

/* â”€â”€ STAT BADGES â”€â”€ */
.stat-badge{background:var(--win-dark);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);padding:4px 10px;text-align:center;min-width:60px}
.stat-n{display:block;font-size:18px;font-weight:700;font-family:'Share Tech Mono',monospace;color:var(--win-blue2);line-height:1.2}

/* â”€â”€ CHIP ROW / FIELD ROW â”€â”€ */
.chip-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px}
.field-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.field-row label{flex-shrink:0;min-width:90px;font-weight:700;font-size:11px}

/* â”€â”€ TERMINAL EXTRA COLORS â”€â”€ */
.t-success{color:var(--term-text)}
.t-err{color:var(--term-err)}
.t-dim{color:var(--term-dim)}

/* â”€â”€ BUTTON VARIANTS â”€â”€ */
.btn-warn{background:#ffe0a0;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi)}
.btn-warn:hover{background:#ffd070}

/* â”€â”€ .inp / .sel aliases (new modules) â”€â”€ */
.inp{width:100%;background:#fff;border:2px solid;border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);color:#000;padding:3px 5px;font-family:'Share Tech Mono',monospace;font-size:11px;outline:none}
.sel{background:#fff;border:2px solid;border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);color:#000;padding:2px 4px;font-family:'Share Tech Mono',monospace;font-size:11px;outline:none}


/* â”€â”€ TOAST NOTIFICATIONS â”€â”€ */
#toast-container{position:fixed;bottom:28px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.toast{
  display:flex;align-items:center;gap:8px;
  padding:6px 14px;font-family:'Share Tech Mono',monospace;font-size:11px;
  border:2px solid;pointer-events:all;
  animation:toastIn 0.2s ease;min-width:260px;max-width:420px;
  box-shadow:3px 3px 0 rgba(0,0,0,0.25);
}
.toast-s{background:#d0f0d0;color:#003300;border-color:#006600}
.toast-e{background:#ffd0d0;color:#440000;border-color:#880000}
.toast-w{background:#fff0b0;color:#443300;border-color:#997700}
.toast-i{background:#d0d8f0;color:#001055;border-color:#003087}
@keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:none}}
.toast-close{margin-left:auto;cursor:pointer;font-size:13px;opacity:0.6;padding:0 2px}
.toast-close:hover{opacity:1}

/* â”€â”€ SUPABASE INDICATOR â”€â”€ */
.sb-supabase{
  display:inline-flex;align-items:center;gap:4px;
  padding:1px 8px;font-family:'Share Tech Mono',monospace;font-size:9px;
  border:1px solid;cursor:pointer;
}
.sb-supabase.connected{background:#d0f8e8;color:#004422;border-color:#3ecf8e}
.sb-supabase.disconnected{background:#f0f0f0;color:#666;border-color:#aaa}

/* â”€â”€ RANK TRACKER â”€â”€ */
.rank-table td.rank-up{color:#006600;font-weight:700}
.rank-table td.rank-down{color:#cc0000;font-weight:700}
.rank-table td.rank-new{color:#003087;font-weight:700}
.rank-sparkline{display:inline-flex;gap:1px;align-items:flex-end;height:18px;vertical-align:middle}
.rank-bar{width:4px;background:var(--win-blue);display:inline-block;min-height:2px}

/* â”€â”€ CONTENT SPINNER â”€â”€ */
.spin-variation{
  background:#fff;border:1px solid var(--win-btn-sh);
  padding:6px 8px;margin-bottom:4px;font-size:11px;line-height:1.6;
  font-family:'Share Tech Mono',monospace;cursor:pointer;
}
.spin-variation:hover{background:#e8f0ff;border-color:var(--win-blue)}
.spin-variation.selected{background:#d0d8f8;border-color:var(--win-blue);border-width:2px}

/* â”€â”€ API HEALTH â”€â”€ */
.health-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.health-card{
  background:var(--win-surface);border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  padding:6px 8px;text-align:center;
}
.health-card.ok{border-left:3px solid #006600}
.health-card.fail{border-left:3px solid #cc0000}
.health-card.warn{border-left:3px solid #997700}
.health-card.unknown{border-left:3px solid #808080}
.health-dot{font-size:14px;display:block;margin-bottom:2px}
.health-name{font-size:9px;font-family:'Share Tech Mono',monospace;color:var(--win-text-muted);text-transform:uppercase;letter-spacing:.06em}
.health-val{font-size:10px;font-weight:700;font-family:'Share Tech Mono',monospace;color:#000;margin-top:2px}

/* â”€â”€ CAMPAIGN TEMPLATES â”€â”€ */
.tpl-card{
  background:var(--win-surface);border:2px solid;
  border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);
  padding:8px 10px;cursor:pointer;margin-bottom:4px;
  display:flex;align-items:center;justify-content:space-between;
}
.tpl-card:hover{background:#e0e8f8;border-color:var(--win-blue)}
.tpl-name{font-weight:700;font-size:11px}
.tpl-meta{font-size:9px;color:var(--win-text-muted);font-family:'Share Tech Mono',monospace;margin-top:2px}

/* â”€â”€ BACKLINK MONITOR â”€â”€ */
.bl-status-live{color:#006600;font-weight:700;font-family:'Share Tech Mono',monospace;font-size:10px}
.bl-status-dead{color:#cc0000;font-weight:700;font-family:'Share Tech Mono',monospace;font-size:10px}
.bl-status-changed{color:#997700;font-weight:700;font-family:'Share Tech Mono',monospace;font-size:10px}
.bl-status-unknown{color:#808080;font-weight:700;font-family:'Share Tech Mono',monospace;font-size:10px}

/* â”€â”€ SUPABASE SETTINGS â”€â”€ */
.supa-section{
  background:linear-gradient(135deg,#1a1a2e,#16213e);
  border:2px solid #3ecf8e;
  padding:12px;margin-bottom:10px;
}
.supa-title{color:#3ecf8e;font-family:'Share Tech Mono',monospace;font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.supa-field label{color:#9ecfb8;font-size:10px;font-family:'Share Tech Mono',monospace;display:block;margin-bottom:3px}
.supa-field input{background:#0d1117;border:1px solid #3ecf8e;color:#3ecf8e;font-family:'Share Tech Mono',monospace;font-size:11px;padding:4px 8px;width:100%}
.supa-field input:focus{outline:1px solid #3ecf8e;background:#111827}
.supa-status{font-size:10px;font-family:'Share Tech Mono',monospace;margin-top:6px}
.supa-btn{background:#3ecf8e;color:#000;border:none;padding:4px 14px;font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:700;cursor:pointer;margin-top:6px}
.supa-btn:hover{background:#2db87a}
.supa-table-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
.supa-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;font-size:9px;font-family:'Share Tech Mono',monospace;border:1px solid #3ecf8e;color:#3ecf8e;background:rgba(62,207,142,0.1)}

/* â”€â”€ WHITELIST/BLACKLIST â”€â”€ */
.wbl-item{display:flex;align-items:center;gap:6px;padding:3px 6px;background:#fff;border:1px solid var(--win-btn-sh);margin-bottom:2px}
.wbl-item.black{border-left:3px solid #cc0000;background:#fff8f8}
.wbl-item.white{border-left:3px solid #006600;background:#f8fff8}

/* â”€â”€ ROI TRACKER â”€â”€ */
.roi-positive{color:#006600;font-weight:700;font-family:'Share Tech Mono',monospace}
.roi-negative{color:#cc0000;font-weight:700;font-family:'Share Tech Mono',monospace}
.roi-neutral{color:#808080;font-family:'Share Tech Mono',monospace}
</style>
</head>
<body>
<div id="toast-container"></div>
<div class="app">
  <!-- TITLE BAR -->
  <div class="header">
    <div class="logo">
      <div class="logo-icon">âš¡</div>
      SEO PARASITE PRO
      <span class="logo-ver">v9.0 Â· GLOBAL BLAST Â· 20 PLATFORMS</span>
    </div>
    <div class="header-right">
      <span id="hdr-stats" class="hdr-stat">0 accounts Â· 0 keywords Â· 0 live URLs</span>
      <span id="hdr-pill" class="hdr-pill"><span>â—</span> no accounts</span>
      <span id="hdr-supabase" class="sb-supabase disconnected" onclick="switchPage('settings')" title="Click to configure Supabase">âš¡ DB: OFF</span>
    </div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <span class="tb-label">FILE</span>
    <button class="tb-btn" onclick="switchPage('dashboard')"><span class="tb-btn-icon">ğŸ </span> Dashboard</button>
    <button class="tb-btn" onclick="switchPage('global_blast')"><span class="tb-btn-icon">ğŸŒ</span> Global Blast</button>
    <div class="tb-sep"></div><div class="tb-sep-hi"></div>
    <span class="tb-label">DATA</span>
    <button class="tb-btn" onclick="switchPage('keywords')"><span class="tb-btn-icon">ğŸ”‘</span> Keywords</button>
    <button class="tb-btn" onclick="switchPage('links')"><span class="tb-btn-icon">ğŸ”—</span> Links</button>
    <button class="tb-btn" onclick="switchPage('export')"><span class="tb-btn-icon">ğŸ“¤</span> Export</button>
    <div class="tb-sep"></div><div class="tb-sep-hi"></div>
    <span class="tb-label">RUN</span>
    <button class="tb-btn btn-primary" onclick="switchPage('setup')"><span class="tb-btn-icon">âš™</span> Setup</button>
    <button class="tb-btn btn-primary" onclick="switchPage('campaign')"><span class="tb-btn-icon">â–¶</span> Run Campaign</button>    <div class="tb-sep"></div><div class="tb-sep-hi"></div>
    <span class="tb-label">TOOLS</span>
    <button class="tb-btn" onclick="switchPage('content_studio')"><span class="tb-btn-icon">âœ</span> Content</button>
    <button class="tb-btn" onclick="switchPage('proxy_manager')"><span class="tb-btn-icon">ğŸ›¡</span> Proxies</button>
    <button class="tb-btn" onclick="switchPage('session_manager')"><span class="tb-btn-icon">ğŸª</span> Sessions</button>
    <button class="tb-btn" onclick="switchPage('captcha_solver')"><span class="tb-btn-icon">ğŸ”“</span> CAPTCHA</button>
    <div class="tb-sep"></div><div class="tb-sep-hi"></div>
    <button class="tb-btn" onclick="switchPage('serp_scraper')"><span class="tb-btn-icon">ğŸ“Š</span> SERP</button>
    <button class="tb-btn" onclick="switchPage('link_indexer')"><span class="tb-btn-icon">ğŸ“¡</span> Indexer</button>
    <button class="tb-btn" onclick="switchPage('ping_submitter')"><span class="tb-btn-icon">ğŸ“£</span> Ping</button>
    <div class="tb-sep"></div><div class="tb-sep-hi"></div>
    <span class="tb-label" style="color:#006600;font-weight:700">NEW</span>
    <button class="tb-btn" onclick="switchPage('ctr_manipulator')" style="color:#006600;font-weight:700"><span class="tb-btn-icon">ğŸ–±</span> CTR Engine</button>
    <button class="tb-btn" onclick="switchPage('freshness_scheduler')" style="color:#006600;font-weight:700"><span class="tb-btn-icon">ğŸ”„</span> Freshness</button>
    <button class="tb-btn" onclick="switchPage('anchor_controller')" style="color:#006600;font-weight:700"><span class="tb-btn-icon">âš“</span> Anchors</button>
    <span class="tb-sep"></span>
    <button class="tb-btn" onclick="switchPage('settings')" style="background:var(--win-blue);color:#fff;font-weight:700"><span class="tb-btn-icon">âš™</span> Settings</button>
    <button class="tb-btn" onclick="switchPage('help')" style="background:#006600;color:#fff;font-weight:700"><span class="tb-btn-icon">â“</span> Help</button>
    <div class="tb-sep"></div><div class="tb-sep-hi"></div>
    <span class="tb-label" style="color:#3ecf8e;font-weight:700">NEW</span>
    <button class="tb-btn" onclick="switchPage('rank_tracker')" style="color:#003087;font-weight:700"><span class="tb-btn-icon">ğŸ“ˆ</span> Ranks</button>
    <button class="tb-btn" onclick="switchPage('api_health')" style="color:#003087;font-weight:700"><span class="tb-btn-icon">ğŸ’Š</span> Health</button>
    <button class="tb-btn" onclick="switchPage('content_spinner')" style="color:#003087;font-weight:700"><span class="tb-btn-icon">ğŸ”„</span> Spinner</button>
    <button class="tb-btn" onclick="switchPage('roi_tracker')" style="color:#006600;font-weight:700"><span class="tb-btn-icon">ğŸ’°</span> ROI</button>
  </div>

  <!-- PLATFORM BAR -->
  <div class="platform-bar" id="platform-bar"></div>

  <div class="main">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="nav-section">â–  Global</div>
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">âš¡</span>Dashboard</div>
      <div class="nav-item" data-page="global_blast"><span class="nav-icon">ğŸŒ</span>Global Blast<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="keywords"><span class="nav-icon">ğŸ”‘</span>Keywords<span class="nav-badge" id="kw-badge">0</span></div>
      <div class="nav-item" data-page="links"><span class="nav-icon">ğŸ”—</span>Links Manager<span class="nav-badge blue" id="link-badge">0</span></div>
      <div class="nav-section">â–  Tools</div>
      <div class="nav-item" data-page="content_studio"><span class="nav-icon">âœ</span>Content Studio</div>
      <div class="nav-item" data-page="competitor_spy"><span class="nav-icon">ğŸ•µ</span>Competitor Spy</div>
      <div class="nav-item" data-page="kw_research"><span class="nav-icon">ğŸ”</span>KW Research</div>
      <div class="nav-item" data-page="blog_commenter"><span class="nav-icon">ğŸ’¬</span>Blog Commenter<span class="nav-badge red">AUTO</span></div>
      <div class="nav-item" data-page="parasite_finder"><span class="nav-icon">ğŸ¦ </span>Parasite Finder<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="comment_sites"><span class="nav-icon">ğŸŒ</span>Comment Sites<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="pdf_parasite"><span class="nav-icon">ğŸ“„</span>PDF Parasite<span class="nav-badge red">HOT</span></div>
      <div class="nav-item" data-page="pdf_uploader"><span class="nav-icon">ğŸš€</span>Smart PDF Upload<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="proxy_manager"><span class="nav-icon">ğŸ›¡</span>Proxy Manager<span class="nav-badge" id="proxy-badge">0</span></div>
      <div class="nav-section">â–  Platform</div>
      <div class="nav-item" data-page="setup"><span class="nav-icon">âš™</span>Setup / Connect</div>
      <div class="nav-item" data-page="campaign"><span class="nav-icon">â–¶</span>Run Campaign</div>
      <div class="nav-section">â–  Distribution</div>
      <div class="nav-item" data-page="serp_scraper"><span class="nav-icon">ğŸ“Š</span>SERP Scraper<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="social_blaster"><span class="nav-icon">ğŸ“²</span>Social Signal Blaster<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="web2_builder"><span class="nav-icon">ğŸ—</span>Web 2.0 Builder<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="forum_blaster"><span class="nav-icon">ğŸ’¬</span>Forum Profile Blaster<span class="nav-badge red">NEW</span></div>
      <div class="nav-section">â–  Infrastructure</div>
      <div class="nav-item" data-page="email_generator"><span class="nav-icon">ğŸ“§</span>Email Generator<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="captcha_solver"><span class="nav-icon">ğŸ”“</span>CAPTCHA Solver<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="session_manager"><span class="nav-icon">ğŸª</span>Session Manager<span class="nav-badge red">NEW</span></div>
      <div class="nav-section">â–  Submit &amp; Export</div>
      <div class="nav-item" data-page="gsc_inspector"><span class="nav-icon">ğŸ”</span>GSC Inspector</div>
      <div class="nav-item" data-page="link_indexer"><span class="nav-icon">ğŸ“¡</span>Link Indexer</div>
      <div class="nav-item" data-page="ping_submitter"><span class="nav-icon">ğŸ“£</span>Ping Submitter</div>
      <div class="nav-item" data-page="account_creator"><span class="nav-icon">ğŸ¤–</span>Account Creator</div>
      <div class="nav-item" data-page="ctr_manipulator"><span class="nav-icon">ğŸ–±</span>CTR Engine<span class="nav-badge" style="background:#006600;color:#fff;border-color:#006600">PRO</span></div>
      <div class="nav-item" data-page="freshness_scheduler"><span class="nav-icon">ğŸ”„</span>Freshness Scheduler<span class="nav-badge" style="background:#006600;color:#fff;border-color:#006600">PRO</span></div>
      <div class="nav-item" data-page="anchor_controller"><span class="nav-icon">âš“</span>Anchor Controller<span class="nav-badge" style="background:#006600;color:#fff;border-color:#006600">PRO</span></div>
      <div class="nav-item" data-page="indexing"><span class="nav-icon">ğŸ“¡</span>Search Indexing</div>
      <div class="nav-item" data-page="export"><span class="nav-icon">ğŸ“¤</span>Export Center<span class="nav-badge" id="export-badge">0</span></div>
      <div class="nav-item" data-page="settings" style="border-top:1px solid var(--win-border);margin-top:4px"><span class="nav-icon">âš™</span>Settings<span class="nav-badge blue">CFG</span></div>
      <div class="nav-item" data-page="help"><span class="nav-icon">â“</span>Help &amp; Guides<span class="nav-badge" style="background:#006600;color:#fff;border-color:#006600">NEW</span></div>
            <div class="nav-section">â–  Analytics</div>
      <div class="nav-item" data-page="rank_tracker"><span class="nav-icon">ğŸ“ˆ</span>Rank Tracker<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="backlink_monitor"><span class="nav-icon">ğŸ”</span>Backlink Monitor<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="roi_tracker"><span class="nav-icon">ğŸ’°</span>ROI Tracker<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="api_health"><span class="nav-icon">ğŸ’Š</span>API Health<span class="nav-badge red">NEW</span></div>
      <div class="nav-section">â–  Optimization</div>
      <div class="nav-item" data-page="content_spinner"><span class="nav-icon">ğŸ”„</span>Content Spinner<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="schema_generator"><span class="nav-icon">ğŸ—</span>Schema Generator<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="sitemap_generator"><span class="nav-icon">ğŸ—º</span>Sitemap Generator<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="internal_links"><span class="nav-icon">ğŸ”—</span>Internal Link Builder<span class="nav-badge red">NEW</span></div>
      <div class="nav-section">â–  Campaign Tools</div>
      <div class="nav-item" data-page="campaign_templates"><span class="nav-icon">ğŸ“‹</span>Campaign Templates<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="campaign_scheduler"><span class="nav-icon">ğŸ“…</span>Campaign Scheduler<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="url_health"><span class="nav-icon">ğŸ¥</span>URL Health Checker<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="blacklist_manager"><span class="nav-icon">ğŸš«</span>Blacklist Manager<span class="nav-badge red">NEW</span></div>
      <div class="nav-item" data-page="rate_monitor"><span class="nav-icon">ğŸ“Š</span>Rate Limit Monitor<span class="nav-badge red">NEW</span></div>
<div class="sidebar-bottom" id="sidebar-accounts">
        <div style="padding:5px 10px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--win-text-muted)">No accounts connected</div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content">
      <div id="page-dashboard" class="page active"></div>
      <div id="page-global_blast" class="page"></div>
      <div id="page-keywords" class="page"></div>
      <div id="page-links" class="page"></div>
      <div id="page-setup" class="page"></div>
      <div id="page-campaign" class="page"></div>
      <div id="page-indexing" class="page"></div>
      <div id="page-export" class="page"></div>
      <div id="page-content_studio" class="page"></div>
      <div id="page-competitor_spy" class="page"></div>
      <div id="page-kw_research" class="page"></div>
      <div id="page-blog_commenter" class="page"></div>
      <div id="page-parasite_finder" class="page"></div>
      <div id="page-comment_sites" class="page"></div>
      <div id="page-pdf_parasite" class="page"></div>
      <div id="page-pdf_uploader" class="page"></div>
      <div id="page-proxy_manager" class="page"></div>
      <div id="page-gsc_inspector" class="page"></div>
      <div id="page-link_indexer" class="page"></div>
      <div id="page-ping_submitter" class="page"></div>
      <div id="page-account_creator" class="page"></div>
      <div id="page-serp_scraper" class="page"></div>
      <div id="page-social_blaster" class="page"></div>
      <div id="page-web2_builder" class="page"></div>
      <div id="page-forum_blaster" class="page"></div>
      <div id="page-email_generator" class="page"></div>
      <div id="page-captcha_solver" class="page"></div>
      <div id="page-session_manager" class="page"></div>
      <div id="page-ctr_manipulator" class="page"></div>
      <div id="page-freshness_scheduler" class="page"></div>
      <div id="page-anchor_controller" class="page"></div>
      <div id="page-settings" class="page"></div>
      <div id="page-help" class="page"></div>
      <div id="page-rank_tracker" class="page"></div>
      <div id="page-backlink_monitor" class="page"></div>
      <div id="page-roi_tracker" class="page"></div>
      <div id="page-api_health" class="page"></div>
      <div id="page-content_spinner" class="page"></div>
      <div id="page-schema_generator" class="page"></div>
      <div id="page-sitemap_generator" class="page"></div>
      <div id="page-internal_links" class="page"></div>
      <div id="page-campaign_templates" class="page"></div>
      <div id="page-campaign_scheduler" class="page"></div>
      <div id="page-url_health" class="page"></div>
      <div id="page-blacklist_manager" class="page"></div>
      <div id="page-rate_monitor" class="page"></div>

    </div>
  </div>

  <!-- STATUS BAR -->
  <div class="statusbar">
    <div class="sb-panel" id="sb-status">Ready</div>
    <div class="sb-panel" id="sb-accounts">Accounts: 0</div>
    <div class="sb-panel" id="sb-keywords">Keywords: 0</div>
    <div class="sb-panel" id="sb-urls">Live URLs: 0</div>
    <div class="sb-panel" style="margin-left:auto">SEO Parasite Pro v9 Â· 20 Platforms</div>
  </div>
</div>

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  activePlatform: 'github',
  activePage: 'dashboard',
  accounts: [],
  keywords: [],
  links: [],
  campaigns: [],
  // Content override â€” persists across campaign/blast, covers all field types
  contentOverride: { title:'', body:'', tags:'', category:'', excerpt:'', slug:'', format:'markdown', visibility:'public' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLATFORMS = [
  {id:'github',    name:'GitHub Pages',     icon:'ğŸ™', da:96, api:'GitHub API',      domain:'github.io',    desc:'Create repos & GitHub Pages for each keyword'},
  {id:'gitlab',    name:'GitLab Pages',     icon:'ğŸ¦Š', da:90, api:'GitLab API',      domain:'gitlab.io',    desc:'GitLab Pages with GitLab CI auto-deploy'},
  {id:'netlify',   name:'Netlify',          icon:'ğŸŒ', da:82, api:'Netlify API',     domain:'netlify.app',  desc:'Deploy static HTML pages via Netlify API'},
  {id:'vercel',    name:'Vercel',           icon:'â–²',  da:82, api:'Vercel API',      domain:'vercel.app',   desc:'Deploy Next.js/static sites via Vercel API'},
  {id:'notion',    name:'Notion',           icon:'ğŸ“', da:90, api:'Notion API',      domain:'notion.site',  desc:'Create Notion pages published to notion.site'},
  {id:'medium',    name:'Medium',           icon:'â“‚',  da:95, api:'Medium API',      domain:'medium.com',   desc:'Publish articles to Medium via Integration Token'},
  {id:'substack',  name:'Substack',         icon:'ğŸ“®', da:91, api:'Substack API',    domain:'substack.com', desc:'Auto-publish newsletters/posts on Substack'},
  {id:'blogger',   name:'Blogger',          icon:'ğŸ“°', da:99, api:'Blogger API v3',  domain:'blogspot.com', desc:'Create & publish posts to Google Blogger blogs'},
  {id:'hashnode',  name:'Hashnode',         icon:'âš¡', da:82, api:'GraphQL API',     domain:'hashnode.dev', desc:'Publish developer articles via Hashnode GraphQL'},
  {id:'reddit',    name:'Reddit',           icon:'ğŸ¤–', da:98, api:'Reddit API',      domain:'reddit.com',   desc:'Post to subreddits via Reddit OAuth API'},
  {id:'wordpress', name:'WordPress.com',    icon:'ğŸ”µ', da:95, api:'WP REST API',     domain:'wordpress.com',desc:'Publish posts to WordPress.com via REST API'},
  {id:'devto',     name:'Dev.to',           icon:'ğŸ’»', da:87, api:'Dev.to API',      domain:'dev.to',       desc:'Publish developer articles to dev.to community'},
  {id:'tumblr',    name:'Tumblr',           icon:'ğŸ’™', da:88, api:'Tumblr API v2',   domain:'tumblr.com',   desc:'Create Tumblr blog posts via OAuth API'},
  {id:'ghost',     name:'Ghost.io',         icon:'ğŸ‘»', da:84, api:'Ghost Admin API', domain:'ghost.io',     desc:'Publish posts to Ghost CMS blogs via Admin API'},
  {id:'wix',       name:'Wix',              icon:'ğŸŒŸ', da:93, api:'Wix Headless API',domain:'wixsite.com',  desc:'Create Wix site pages via Wix Headless CMS API'},
  {id:'telegraph', name:'Telegraph',        icon:'ğŸ“œ', da:68, api:'Telegraph API',   domain:'telegra.ph',   desc:'Publish anonymous pages to telegra.ph instantly'},
  {id:'codepen',   name:'CodePen',          icon:'ğŸ–Š', da:89, api:'Prefill URL',     domain:'codepen.io',   desc:'Generate CodePen prefill URLs â€” DA 89'},
  {id:'replit',    name:'Replit',           icon:'ğŸ”', da:89, api:'Replit GraphQL',  domain:'repl.co',      desc:'Deploy pages on Replit via GraphQL API'},
  {id:'cloudflare',name:'Cloudflare Pages', icon:'â˜',  da:88, api:'Cloudflare API',  domain:'pages.dev',    desc:'Deploy to pages.dev via Cloudflare API'},
  {id:'issuu',        name:'Issuu',           icon:'ğŸ“„', da:92,  api:'Issuu API',          domain:'issuu.com',         desc:'Publish documents on Issuu â€” DA 92'},
  // â”€â”€ NEW PLATFORMS â”€â”€
  {id:'onfeetnation', name:'OnFeetNation',    icon:'ğŸ‘Ÿ', da:52,  api:'Form POST',          domain:'onfeetnation.com',  desc:'Post photo album to OnFeetNation social network'},
  {id:'caribbeanfever',name:'CaribbeanFever', icon:'ğŸŒ´', da:48,  api:'Form POST',          domain:'caribbeanfever.com',desc:'Post photo album to CaribbeanFever community'},
  {id:'bitbin',       name:'Bitbin',          icon:'ğŸ“‹', da:42,  api:'Paste API',          domain:'bitbin.it',         desc:'Create a paste/snippet on Bitbin.it'},
  {id:'pastelink',    name:'Pastelink',       icon:'ğŸ”—', da:40,  api:'Paste API',          domain:'pastelink.net',     desc:'Create a public paste on Pastelink.net'},
  {id:'click4r',      name:'Click4R',         icon:'ğŸ“', da:38,  api:'Form POST',          domain:'click4r.com',       desc:'Create a post on Click4R blogging platform'},
  {id:'ideone',       name:'Ideone',          icon:'ğŸ’¡', da:72,  api:'Paste API',          domain:'ideone.com',        desc:'Create a public code/text paste on Ideone.com'},
  {id:'controlc',     name:'ControlC',        icon:'ğŸ“Œ', da:38,  api:'Paste API',          domain:'controlc.com',      desc:'Create a public paste on ControlC.com'},
  {id:'rentry',       name:'Rentry.co',       icon:'ğŸ“„', da:52,  api:'Paste API',          domain:'rentry.co',         desc:'Create a Markdown paste page on Rentry.co'},
  {id:'techplanet',   name:'TechPlanet',      icon:'ğŸš€', da:45,  api:'Form POST',          domain:'techplanet.today',  desc:'Publish a post on TechPlanet.today'},
  {id:'vingle',       name:'Vingle',          icon:'ğŸ’œ', da:58,  api:'Form POST',          domain:'vingle.net',        desc:'Post an article to Vingle interest network'},
  {id:'writeonwall',  name:'WriteOnWall',     icon:'âœï¸', da:35,  api:'Form POST',          domain:'writeonwall.com',   desc:'Submit a question/post on WriteOnWall'},
  {id:'taylorhicks',  name:'TaylorHicks Ning',icon:'ğŸµ', da:44,  api:'Ning API',           domain:'taylorhicks.ning.com',desc:'Post to TaylorHicks Ning community forum'},
  {id:'snaplant',     name:'Snaplant',        icon:'ğŸŒ¿', da:36,  api:'Form POST',          domain:'snaplant.com',      desc:'Submit a question on Snaplant Q&A'},
  {id:'theprose',     name:'TheProse',        icon:'ğŸ“–', da:42,  api:'Form POST',          domain:'theprose.com',      desc:'Publish a post on TheProse writing community'},
  {id:'deviantart',   name:'DeviantArt',      icon:'ğŸ¨', da:92,  api:'DeviantArt API',     domain:'deviantart.com',    desc:'Publish a journal/deviation on DeviantArt â€” DA 92'},
  // â”€â”€ PASTE SITES (batch) â”€â”€
  {id:'pastebin',     name:'Pastebin',        icon:'ğŸ“‹', da:93,  api:'Paste API',          domain:'pastebin.com',      desc:'Create public paste on Pastebin.com â€” DA 93 (requires free API key)'},
  {id:'dpaste',       name:'dpaste.org',      icon:'ğŸ“„', da:62,  api:'REST API',           domain:'dpaste.org',        desc:'Create anonymous paste on dpaste.org â€” no login needed'},
  {id:'hastebin',     name:'Hastebin',        icon:'âš¡', da:55,  api:'REST API',           domain:'hastebin.com',      desc:'Create instant paste on Hastebin â€” no login needed'},
  {id:'writeas',      name:'Write.as',        icon:'âœï¸', da:64,  api:'REST API',           domain:'write.as',          desc:'Publish anonymous post on Write.as â€” no login needed'},
  {id:'pastee',       name:'Paste.ee',        icon:'ğŸ“Œ', da:52,  api:'REST API',           domain:'paste.ee',          desc:'Create paste on Paste.ee â€” requires free API key'},
  {id:'justpaste',    name:'JustPaste.it',    icon:'ğŸ“', da:65,  api:'Form POST',          domain:'justpaste.it',      desc:'Publish anonymous article on JustPaste.it â€” no login needed'},
  {id:'zerobin',      name:'0bin.net',        icon:'ğŸ”’', da:44,  api:'Form POST',          domain:'0bin.net',          desc:'Encrypted paste on 0bin.net â€” no login needed'},
  {id:'rentryorg',    name:'Rentry.org',      icon:'ğŸ“„', da:50,  api:'Paste API',          domain:'rentry.org',        desc:'Markdown paste on Rentry.org (mirror of rentry.co)'},
  {id:'ghgist',       name:'GitHub Gist',     icon:'ğŸ“', da:96,  api:'GitHub API',         domain:'gist.github.com',   desc:'Create public Gist â€” reuses your connected GitHub token â€” DA 96'},
  {id:'hackmd',       name:'HackMD',          icon:'ğŸ–Š', da:74,  api:'HackMD API',         domain:'hackmd.io',         desc:'Create collaborative Markdown note on HackMD â€” requires API token'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uid  = () => Math.random().toString(36).slice(2,9);
const slug = s  => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');
const ts   = () => new Date().toLocaleTimeString('en-US',{hour12:false});
const sleep= ms => new Promise(r=>setTimeout(r,ms));
const esc  = s  => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const year = () => new Date().getFullYear();

function getPlatform(id){ return PLATFORMS.find(p=>p.id===id)||PLATFORMS[0]; }
function getAccounts(pid){ return S.accounts.filter(a=>a.platform===pid); }
function getAccount(pid){ return S.accounts.find(a=>a.platform===pid); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMdLinks(links){
  const f=(links||[]).filter(l=>l.target==='readme'||l.target==='both');
  if(!f.length) return '';
  return '\n\n## ğŸ“š Resources\n\n'+f.map(l=>`- [${l.label}](${l.url})`).join('\n');
}
function buildHtmlLinks(links){
  const f=(links||[]).filter(l=>l.target==='html'||l.target==='both');
  if(!f.length) return '';
  return '<section class="card" id="resources"><h2>ğŸ“š Resources</h2><ul>'+f.map(l=>`<li><a href="${l.url}" target="_blank" rel="noopener">${esc(l.label)}</a></li>`).join('')+'</ul></section>';
}

const ARTICLE_TEMPLATES = [
  (kw,links) => `# ${kw}: The Ultimate Guide for ${year()}

## Introduction

If you're looking for the best information about **${kw}**, you've come to the right place. This comprehensive guide covers everything you need to know.

## What is ${kw}?

${kw} refers to a powerful approach that helps users achieve their goals more efficiently. Understanding ${kw} is essential for success in today's competitive landscape.

## Why ${kw} Matters

- **Efficiency**: ${kw} streamlines processes and saves valuable time
- **Scalability**: Grow with proven ${kw} strategies
- **Results**: Measurable outcomes with data-driven ${kw} methods

## Best Practices for ${kw}

### 1. Start with Deep Research
Before implementing ${kw}, gather data about your audience, competitors, and goals.

### 2. Build a Solid Plan
A structured plan for ${kw} ensures consistent results and measurable progress.

### 3. Execute and Iterate
Track your ${kw} metrics. Key KPIs include traffic, conversions, and engagement rates.

## FAQ

**What is ${kw}?** ${kw} is a comprehensive approach to achieving results using proven methodologies.

**How long until results?** Most practitioners see meaningful progress within 30â€“90 days.

**Is ${kw} suitable for beginners?** Absolutely â€” this guide is designed for all skill levels.
${buildMdLinks(links)}
---
*Last updated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}*`,

  (kw,links) => `# ${kw} â€” Expert Analysis & Review ${year()}

> **TL;DR**: ${kw} is one of the most searched topics this year. Here's everything experts know.

## Overview

After extensive research on **${kw}**, we've compiled a definitive breakdown for anyone looking to understand, evaluate, or implement ${kw} strategies.

## Key Facts About ${kw}

- ${kw} has seen significant growth in interest over the past 12 months
- Most practitioners report meaningful results within 30â€“90 days
- Beginner-friendly resources for ${kw} are more accessible than ever

## How ${kw} Works: Step by Step

**Step 1 â€” Research & Discovery**
Understand the landscape of ${kw}. Identify key players, trends, and gaps.

**Step 2 â€” Strategy & Planning**
Map your ${kw} approach against your specific goals and resources.

**Step 3 â€” Implementation**
Execute your ${kw} plan with precision. Start small, validate, then scale.

## FAQ

**What is the best way to get started with ${kw}?** Begin with thorough research and a clear goal.

**How long does ${kw} take to show results?** Most users see results within 30â€“90 days of consistent effort.
${buildMdLinks(links)}
---
*Expert reviewed Â· Updated ${new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'})}*`,
];

function generateMarkdown(kw, links, tplIdx, allKws, username, domain){
  const fn = ARTICLE_TEMPLATES[tplIdx % ARTICLE_TEMPLATES.length];
  let content = fn(kw, links);
  if(allKws && allKws.length > 1){
    const others = allKws.filter(k=>k!==kw).slice(0,4);
    content += '\n\n## ğŸŒ Related Guides\n\n'+others.map(k=>`- [${k}](https://${username}.${domain}/${slug(k)}/)`).join('\n');
  }
  return content;
}

// Returns all content fields, using user overrides if set, else smart auto-generated defaults.
// Supports: title, body, tags, category, excerpt, slug, format, visibility.
// {keyword} / {kw} / {year} are substituted everywhere.
function getEffectiveContent(kw, links, tplIdx, allKws, username, domain){
  const autoBody  = generateMarkdown(kw, links, tplIdx, allKws, username, domain);
  const autoTitle = kw + ': Complete Guide ' + year();
  const autoSlug  = slug(kw);
  const autoExcerpt = 'Comprehensive guide to ' + kw + '. Expert tips, best practices & resources for ' + year() + '.';
  const ov = S.contentOverride || {};
  const fillKw = s => (s||'').replace(/\{keyword\}/gi, kw).replace(/\{kw\}/gi, kw).replace(/\{year\}/gi, year()).replace(/\{slug\}/gi, slug(kw));
  return {
    title:      ov.title      && ov.title.trim()      ? fillKw(ov.title)      : autoTitle,
    body:       ov.body       && ov.body.trim()        ? fillKw(ov.body)       : autoBody,
    tags:       ov.tags       && ov.tags.trim()        ? fillKw(ov.tags)       : 'seo,guide,' + slug(kw),
    category:   ov.category   && ov.category.trim()    ? fillKw(ov.category)   : 'General',
    excerpt:    ov.excerpt    && ov.excerpt.trim()      ? fillKw(ov.excerpt)    : autoExcerpt,
    slug:       ov.slug       && ov.slug.trim()         ? fillKw(ov.slug)       : autoSlug,
    format:     ov.format     || 'markdown',
    visibility: ov.visibility || 'public',
  };
}

// â”€â”€ CONTENT FIELDS SCHEMA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Defines which fields each platform TYPE shows in the content card.
// Add new platform types here â€” renderContentFields() picks it up automatically.
const CONTENT_FIELDS = {
  // Paste / anonymous page sites
  paste: [
    { id:'title',    label:'Title',            type:'text',     ph:'{keyword} Guide {year}',                         hint:'Page title. {keyword} inserts the current keyword.',       defVal:'' },
    { id:'body',     label:'Content (Markdown)',type:'textarea', ph:'Write your content here in Markdownâ€¦\n\nUse {keyword} to inject keyword dynamically.',hint:'Full paste body. Leave blank for auto-generated SEO template.',defVal:'' },
  ],
  // Generic article / blog CMS
  article: [
    { id:'title',    label:'Post Title',        type:'text',     ph:'Best {keyword} Guide for {year}',               hint:'Post title shown in browser & SERPs.',                     defVal:'' },
    { id:'body',     label:'Post Body (Markdown)',type:'textarea',ph:'Write your post hereâ€¦\n\nUse {keyword} for dynamic injection.',hint:'Full article body. Leave blank for auto-template.',      defVal:'' },
    { id:'tags',     label:'Tags',              type:'text',     ph:'seo,guide,marketing',                           hint:'Comma-separated tags. Applied to post.',                   defVal:'' },
    { id:'excerpt',  label:'Excerpt / Description',type:'text',  ph:'Short summary of the post â€” {keyword} explained.',hint:'Used as meta description and post summary.',              defVal:'' },
  ],
  // Community / forum / Q&A posts
  post: [
    { id:'title',    label:'Post / Thread Title',type:'text',    ph:'{keyword}: Questions, Tips & Discussion',       hint:'Thread or post title.',                                   defVal:'' },
    { id:'body',     label:'Post Body',          type:'textarea',ph:'Start the discussion about {keyword}â€¦',         hint:'Post body. {keyword} injected dynamically.',              defVal:'' },
    { id:'category', label:'Category / Forum',   type:'text',    ph:'General',                                       hint:'Forum section or post category. Leave blank for default.',defVal:'' },
    { id:'tags',     label:'Tags / Flair',       type:'text',    ph:'seo,{keyword}',                                 hint:'Post tags or Reddit flair text.',                         defVal:'' },
  ],
  // Full CMS with all options (WordPress, Ghost, Hashnode, Wixâ€¦)
  cms: [
    { id:'title',    label:'Post Title',         type:'text',    ph:'Best {keyword} Guide for {year}',               hint:'SEO-optimized title. {keyword} and {year} supported.',    defVal:'' },
    { id:'body',     label:'Post Body (Markdown)',type:'textarea',ph:'Write your full post here in Markdownâ€¦',        hint:'Full article body. Auto-generated if left blank.',         defVal:'' },
    { id:'tags',     label:'Tags',               type:'text',    ph:'seo,guide,{keyword}',                           hint:'Comma-separated post tags.',                              defVal:'' },
    { id:'category', label:'Category',           type:'text',    ph:'General',                                       hint:'Post category. Must match an existing category on your site.',defVal:'' },
    { id:'excerpt',  label:'Excerpt / Meta Desc',type:'text',    ph:'Learn everything about {keyword} in {year}.',   hint:'Short description used in SERPs and post previews.',      defVal:'' },
    { id:'slug',     label:'URL Slug',           type:'text',    ph:'{slug}',                                        hint:'Custom URL slug. Leave blank to auto-generate from keyword.',defVal:'' },
    { id:'visibility',label:'Visibility',        type:'select',  choices:['public','private','unlisted'],             hint:'Post visibility.',                                        defVal:'public' },
  ],
  // File/page builder platforms (GitHub Pages, Netlify, Vercelâ€¦)
  file: [
    { id:'title',    label:'Page Title (H1 + <title>)',type:'text',ph:'{keyword} â€” Complete Guide {year}',           hint:'Used as HTML <title>, H1, and README heading.',           defVal:'' },
    { id:'body',     label:'Page Body (Markdown)',type:'textarea',ph:'Write your page contentâ€¦',                     hint:'README.md and index.html content body. Auto if blank.',   defVal:'' },
    { id:'excerpt',  label:'Meta Description',  type:'text',     ph:'Everything about {keyword} for {year}.',       hint:'HTML meta description for SEO.',                          defVal:'' },
  ],
  // Document / PDF draft platforms
  doc: [
    { id:'title',    label:'Document Title',    type:'text',     ph:'{keyword} â€” Complete Reference {year}',        hint:'Document title displayed in platform library.',           defVal:'' },
    { id:'body',     label:'Document Description',type:'textarea',ph:'A comprehensive guide to {keyword}â€¦',         hint:'Summary/description shown in platform listing.',          defVal:'' },
    { id:'tags',     label:'Tags',              type:'text',     ph:'seo,guide,{keyword}',                          hint:'Comma-separated document tags.',                          defVal:'' },
  ],
  // Prefill/manual (CodePen etc)
  prefill: [
    { id:'title',    label:'Page Title',        type:'text',     ph:'{keyword} â€” Live Demo {year}',                 hint:'Title shown in the editor prefill.',                      defVal:'' },
    { id:'body',     label:'HTML Body Content', type:'textarea', ph:'<h1>{keyword}</h1>\n<p>Your content hereâ€¦</p>',hint:'HTML content injected into the prefill template.',        defVal:'' },
  ],
};

// Map PLATFORM_META types to CONTENT_FIELDS keys
const TYPE_TO_FIELDS = {
  page:    'paste',
  article: 'article',
  post:    'post',
  file:    'file',
  doc:     'doc',
  prefill: 'prefill',
  cms:     'cms',
};

// For Global Blast which mixes platform types: detect dominant type among selected platforms
// and show the superset of fields (cms has the most fields, so use it when types differ)
function blastDominantFieldType(){
  const types = _blastSelectedPlatforms.map(pid => {
    const meta = PLATFORM_META[pid];
    return meta ? meta.type : 'article';
  });
  // Priority: if any cms selected, show cms (most fields). Then article, then post, then paste/file
  if(types.includes('cms'))     return 'cms';
  if(types.includes('article')) return 'article';
  if(types.includes('post'))    return 'post';
  if(types.includes('file'))    return 'file';
  if(types.includes('doc'))     return 'doc';
  return types[0] || 'article';
}

// Render the dynamic content fields card for a given platform id.
// Works for individual campaign page AND global blast.
// prefix = 'camp' or 'blast' â€” used for element IDs to avoid collisions.
function renderContentFields(pid, prefix){
  prefix = prefix || 'camp';
  const meta  = PLATFORM_META[pid] || { type:'article' };
  const fkey  = TYPE_TO_FIELDS[meta.type] || 'article';
  const fields = CONTENT_FIELDS[fkey] || CONTENT_FIELDS.article;
  const ov    = S.contentOverride || {};

  const typeLabel = {
    paste:'Paste / Page', article:'Article / Blog', post:'Forum / Community',
    file:'File / Subdomain', doc:'Document Draft', prefill:'Prefill URL', cms:'Full CMS'
  }[fkey] || 'Content';

  const fieldHtml = fields.map(f => {
    const val = esc(ov[f.id] !== undefined ? ov[f.id] : f.defVal || '');
    const onInput = `S.contentOverride['${f.id}']=this.value;contentFieldsPreview('${prefix}')`;
    if(f.type === 'textarea'){
      return `<div class="fg">
        <label class="lbl">${esc(f.label)} <span class="tm">(leave blank for auto-generated)</span></label>
        <textarea id="${prefix}-cf-${f.id}" rows="7" placeholder="${esc(f.ph)}"
          oninput="${onInput}"
          style="font-family:var(--mono);font-size:11px;resize:vertical">${val}</textarea>
        ${f.hint ? `<p class="xs mono tm" style="margin-top:3px">${esc(f.hint)}</p>` : ''}
      </div>`;
    } else if(f.type === 'select'){
      const opts = f.choices.map(c => `<option value="${esc(c)}" ${(ov[f.id]||f.defVal)===c?'selected':''}>${esc(c)}</option>`).join('');
      return `<div class="fg mb0">
        <label class="lbl">${esc(f.label)}</label>
        <select id="${prefix}-cf-${f.id}" onchange="${onInput}">${opts}</select>
        ${f.hint ? `<p class="xs mono tm" style="margin-top:3px">${esc(f.hint)}</p>` : ''}
      </div>`;
    } else {
      return `<div class="fg mb0">
        <label class="lbl">${esc(f.label)} <span class="tm">(leave blank for auto)</span></label>
        <input type="text" id="${prefix}-cf-${f.id}" placeholder="${esc(f.ph)}" value="${val}"
          oninput="${onInput}"/>
        ${f.hint ? `<p class="xs mono tm" style="margin-top:3px">${esc(f.hint)}</p>` : ''}
      </div>`;
    }
  }).join('\n');

  // Preview panel
  const previewHtml = `
    <div id="${prefix}-cf-preview" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:6px;padding:10px;background:var(--win-surface)">
      <div class="card-title" style="font-size:10px;margin-bottom:6px">ğŸ“„ Content Preview <span class="mono tm xs" id="${prefix}-cf-preview-kw"></span></div>
      <div style="margin-bottom:6px"><span class="badge badge-b" style="font-size:9px">TITLE</span>
        <span class="mono xs ta" style="margin-left:6px;font-weight:700" id="${prefix}-cf-preview-title"></span></div>
      <div style="margin-bottom:4px"><span class="badge badge-p" style="font-size:9px">TAGS</span>
        <span class="mono xs tm" style="margin-left:6px" id="${prefix}-cf-preview-tags"></span></div>
      <div style="margin-bottom:4px"><span class="badge badge-y" style="font-size:9px">CAT</span>
        <span class="mono xs tm" style="margin-left:6px" id="${prefix}-cf-preview-category"></span></div>
      <div style="margin-bottom:8px"><span class="badge badge-g" style="font-size:9px">EXCERPT</span>
        <span class="mono xs tm" style="margin-left:6px" id="${prefix}-cf-preview-excerpt"></span></div>
      <pre id="${prefix}-cf-preview-body" style="background:var(--term-bg);color:var(--term-text);font-family:var(--mono);font-size:10px;padding:10px;border-radius:6px;max-height:220px;overflow-y:auto;white-space:pre-wrap;line-height:1.6;margin:0"></pre>
    </div>`;

  return `<div class="card">
    <div class="card-title flex aic g8">
      âœï¸ Post Content
      <span class="badge badge-p" style="font-size:9px;margin-left:4px">${esc(typeLabel)}</span>
      <span class="badge badge-b" style="font-size:9px">Use {keyword} Â· {year} Â· {slug} as placeholders</span>
      <button class="btn btn-ghost btn-xs" style="margin-left:auto" onclick="contentFieldsReset('${prefix}')">â†º Auto</button>
      <button class="btn btn-ghost btn-xs" onclick="contentFieldsTogglePreview('${prefix}')">ğŸ‘ Preview</button>
    </div>
    ${fieldHtml}
    ${previewHtml}
  </div>`;
}

function contentFieldsPreview(prefix){
  const wrap = document.getElementById(prefix+'-cf-preview');
  if(!wrap || wrap.style.display === 'none') return; // only update if visible
  const kw = (prefix==='blast'
    ? (document.getElementById('blast-kw')||{value:''}).value.trim()
    : null) || S.keywords[0] || 'your-keyword';
  const ec = getEffectiveContent(kw, S.links, 0, S.keywords, 'user', 'site.com');
  const set = (id, val) => { const el = document.getElementById(prefix+'-cf-preview-'+id); if(el) el.textContent = val || 'â€”'; };
  set('kw',      '(keyword: "' + kw + '")');
  set('title',   ec.title);
  set('tags',    ec.tags);
  set('category',ec.category);
  set('excerpt', ec.excerpt);
  const bodyEl = document.getElementById(prefix+'-cf-preview-body');
  if(bodyEl) bodyEl.textContent = ec.body.slice(0,1400) + (ec.body.length > 1400 ? '\nâ€¦(truncated)' : '');
}

function contentFieldsTogglePreview(prefix){
  const wrap = document.getElementById(prefix+'-cf-preview');
  if(!wrap) return;
  const shown = wrap.style.display !== 'none';
  wrap.style.display = shown ? 'none' : 'block';
  if(!shown) contentFieldsPreview(prefix);
}

function contentFieldsReset(prefix){
  S.contentOverride = { title:'', body:'', tags:'', category:'', excerpt:'', slug:'', format:'markdown', visibility:'public' };
  // Reset all field inputs for this prefix's platform type
  const _type = prefix==='blast' ? blastDominantFieldType() : (PLATFORM_META[S.activePlatform]?.type||'article');
  const fields = CONTENT_FIELDS[TYPE_TO_FIELDS[_type]||'article'] || [];
  fields.forEach(f => {
    const el = document.getElementById(prefix+'-cf-'+f.id);
    if(el) el.value = f.defVal || '';
  });
  contentFieldsPreview(prefix);
  toast('Reset to auto-generated content', 's');
}

// Sync all content fields from DOM into S.contentOverride at run-time
function syncContentFields(prefix){
  const allFieldIds = ['title','body','tags','category','excerpt','slug','format','visibility'];
  allFieldIds.forEach(id => {
    const el = document.getElementById(prefix+'-cf-'+id);
    if(el !== null) S.contentOverride[id] = el.value !== undefined ? el.value : el.textContent || '';
  });
}

function generateHtmlPage(kw, username, repoName, links, platform){
  const p = getPlatform(platform);
  const baseUrl = platform==='github' ? `https://${username}.github.io/${repoName}/`
    : platform==='gitlab' ? `https://${username}.gitlab.io/${repoName}/`
    : `https://${repoName}.${p.domain}/`;
  const linkSection = buildHtmlLinks(links);
  const schemaObj = {
    "@context":"https://schema.org","@type":"Article",
    "headline":`${kw} - Complete Guide ${year()}`,
    "description":`Comprehensive guide to ${kw}. Expert tips, best practices, and resources.`,
    "author":{"@type":"Person","name":username},
    "datePublished":new Date().toISOString().split('T')[0]
  };
  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="description" content="Learn everything about ${esc(kw)}. Expert guide for ${year()}.">
<meta property="og:title" content="${esc(kw)} - Complete Guide ${year()}">
<meta name="robots" content="index,follow">
<link rel="canonical" href="${esc(baseUrl)}">
<title>${esc(kw)} â€” Complete Guide ${year()}</title>
<script type="application/ld+json">${JSON.stringify(schemaObj)}<\/script>
<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,sans-serif;background:#f8fafc;color:#1e293b;line-height:1.75}header{background:linear-gradient(135deg,#1e1b4b,#312e81);color:white;padding:56px 24px;text-align:center}header h1{font-size:2.2rem;margin-bottom:12px;font-weight:800}header p{font-size:1rem;opacity:0.75;max-width:560px;margin:0 auto}main{max-width:860px;margin:0 auto;padding:36px 24px}.card{background:white;border-radius:10px;padding:24px;margin:18px 0;box-shadow:0 1px 4px rgba(0,0,0,0.08)}h2{font-size:1.35rem;font-weight:700;color:#1e1b4b;margin:0 0 14px}h3{font-size:1.05rem;font-weight:600;color:#312e81;margin:18px 0 8px}p{margin-bottom:12px;color:#475569}ul,ol{margin:8px 0 16px 20px}li{margin-bottom:6px;color:#475569}a{color:#4f46e5}footer{text-align:center;padding:36px 24px;background:#1e1b4b;color:rgba(255,255,255,0.4);font-size:0.82rem}</style>
</head>
<body>
<header><h1>${esc(kw)}</h1><p>Complete Guide for ${year()} Â· Everything You Need to Know</p></header>
<main>
<div class="card"><h2>Introduction to ${esc(kw)}</h2><p>Welcome to the most comprehensive resource on <strong>${esc(kw)}</strong>. This guide covers all aspects with practical, actionable insights.</p><p>Last updated: <strong>${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</strong></p></div>
<div class="card"><h2>Why ${esc(kw)} Is Important</h2><ul><li>Proven framework for achieving consistent results</li><li>Saves time with battle-tested methodologies</li><li>Scales from beginner to advanced</li></ul></div>
<div class="card"><h2>FAQ</h2><p><strong>What is ${esc(kw)}?</strong> ${esc(kw)} is a comprehensive approach to achieving optimal results through structured methods.</p><p><strong>How long until results?</strong> Most practitioners see progress within 30â€“90 days.</p><p><strong>Is it suitable for beginners?</strong> Absolutely â€” this guide is designed for all skill levels.</p></div>
${linkSection}
</main>
<footer><p>&copy; ${year()} ${esc(username)} Â· ${esc(repoName)} Â· ${esc(p.name)}</p></footer>
</body></html>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART FETCH â€” Universal auto-proxy wrapper
// Tries the request direct first. If blocked by CORS or network
// error, automatically retries through the full proxy pool.
// Use this everywhere instead of raw fetch() for cross-origin
// requests. Credential-bearing platform API calls (GitHub, Netlify,
// Cloudflare etc.) are tried direct first so auth headers are never
// forwarded to third-party proxies unless the direct call fails.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _SF_CORS_DOMAINS = new Set(); // domains confirmed to need proxy

async function smartFetch(url, opts = {}) {
  const timeout  = opts.sfTimeout || opts.timeout || 16000;
  const isPost   = !!(opts.method && opts.method.toUpperCase() !== 'GET');
  const enc      = encodeURIComponent(url);
  const mkSignal = () => (typeof AbortSignal !== 'undefined' && AbortSignal.timeout)
    ? AbortSignal.timeout(timeout)
    : (() => { const c = new AbortController(); setTimeout(() => c.abort(), timeout); return c.signal; })();

  // Build proxy candidate list (same pool as bcProxyFetch / bcGetProxyList)
  function proxyList() {
    const cp        = (typeof _bcCustomProxy  !== 'undefined' ? _bcCustomProxy  : '').trim();
    const userProxy = (typeof settingGet      === 'function'  ? settingGet('corsProxy') || '' : '').trim();
    const out = [];
    if (cp)        out.push({ url: cp.replace('{URL}',enc).replace('{url}',enc) || `${cp}?url=${enc}`,  passBody:isPost, label:'custom' });
    if (userProxy) out.push({ url: userProxy + enc,                                                      passBody:isPost, label:'settings-proxy' });
    if (isPost) {
      out.push(
        { url:`https://corsproxy.io/?${enc}`,                     passBody:true, label:'corsproxy' },
        { url:`https://proxy.cors.sh/${url}`,                     passBody:true, label:'cors.sh', extraHeaders:{'x-cors-api-key':'temp_'} },
        { url:`https://api.allorigins.win/raw?url=${enc}`,        passBody:true, label:'allorigins-raw' },
        { url:`https://thingproxy.freeboard.io/fetch/${url}`,     passBody:true, label:'thingproxy' },
        { url:`https://crossorigin.me/${url}`,                    passBody:true, label:'crossorigin' },
        { url:`https://cors-anywhere-demo.herokuapp.com/${url}`,  passBody:true, label:'heroku' },
        { url:`https://yacdn.org/serve/${url}`,                   passBody:true, label:'yacdn' },
      );
    } else {
      out.push(
        { url:`https://api.allorigins.win/get?url=${enc}`,        json:true,  passBody:false, label:'allorigins' },
        { url:`https://corsproxy.io/?${enc}`,                     passBody:false, label:'corsproxy' },
        { url:`https://api.allorigins.win/raw?url=${enc}`,        passBody:false, label:'allorigins-raw' },
        { url:`https://proxy.cors.sh/${url}`,                     passBody:false, label:'cors.sh', extraHeaders:{'x-cors-api-key':'temp_'} },
        { url:`https://thingproxy.freeboard.io/fetch/${url}`,     passBody:false, label:'thingproxy' },
        { url:`https://api.codetabs.com/v1/proxy?quest=${enc}`,   passBody:false, label:'codetabs' },
        { url:`https://crossorigin.me/${url}`,                    passBody:false, label:'crossorigin.me' },
        { url:`https://yacdn.org/serve/${url}`,                   passBody:false, label:'yacdn' },
        { url:`https://cors.eu.org/${url}`,                       passBody:false, label:'cors.eu.org' },
        { url:`https://corsproxy.org/?${enc}`,                    passBody:false, label:'corsproxy.org' },
        { url:`https://corsproxy.club/?${url}`,                   passBody:false, label:'corsproxy.club' },
      );
    }
    return out;
  }

  // One fetch attempt (direct or via proxy)
  async function attempt(fetchUrl, extraHeaders, passBody) {
    const fo = {
      method:  opts.method || 'GET',
      headers: { ...(opts.headers || {}), ...(extraHeaders || {}) },
      signal:  mkSignal(),
    };
    if (passBody !== false && opts.body != null) fo.body = opts.body;
    if (opts.credentials) fo.credentials = opts.credentials;
    return fetch(fetchUrl, fo);
  }

  const domain     = (() => { try { return new URL(url).hostname; } catch(e) { return url; } })();
  const skipDirect = _SF_CORS_DOMAINS.has(domain);

  // â”€â”€ 1. Direct attempt (skipped if domain already known to block CORS) â”€â”€
  if (!skipDirect) {
    try {
      const resp = await attempt(url, {}, true);
      return resp; // success â€” real HTTP response even if 4xx/5xx
    } catch (err) {
      const isCorsErr = err instanceof TypeError ||
        String(err).includes('Failed to fetch') ||
        String(err).includes('NetworkError')    ||
        String(err).includes('Load failed')     ||
        String(err).includes('CORS');
      if (isCorsErr) {
        _SF_CORS_DOMAINS.add(domain); // remember: always proxy this domain
      } else {
        throw err; // real abort / programmer error â€” surface it
      }
    }
  }

  // â”€â”€ 2. Proxy cascade â”€â”€
  for (const proxy of proxyList()) {
    try {
      const resp = await attempt(proxy.url, proxy.extraHeaders || {}, proxy.passBody);
      if (resp.ok || resp.status < 500) {
        _SF_CORS_DOMAINS.add(domain);
        return resp;
      }
    } catch(e) { /* try next */ }
  }

  // â”€â”€ 3. All failed â€” return a synthetic Response so callers don't hard-crash â”€â”€
  return new Response(
    JSON.stringify({ error: 'All proxies exhausted', url }),
    { status: 0, headers: { 'Content-Type': 'application/json' } }
  );
}
// END smartFetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CLASSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class GitHubAPI {
  constructor(token){ this.token=token; this.base='https://api.github.com'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/user'); }
  createRepo(name,desc){ return this.req('POST','/user/repos',{name,description:desc,private:false,auto_init:true,has_issues:false,has_projects:false,has_wiki:false}); }
  async getFile(owner,repo,path){
    try{ return await this.req('GET',`/repos/${owner}/${repo}/contents/${path}`); }
    catch(e){ if(e.message.includes('Not Found')||e.message.includes('404')) return null; throw e; }
  }
  async putFile(owner,repo,path,content,msg,sha=null){
    // Properly encode content to base64 (handles Unicode)
    const bytes=new TextEncoder().encode(content);
    const binStr=Array.from(bytes).map(b=>String.fromCharCode(b)).join('');
    const b64=btoa(binStr);
    const body={message:msg,content:b64};
    if(sha) body.sha=sha;
    return this.req('PUT',`/repos/${owner}/${repo}/contents/${path}`,body);
  }
  async enablePages(owner,repo){
    try{ return await this.req('PUT',`/repos/${owner}/${repo}/pages`,{source:{branch:'main',path:'/'}}); }
    catch{ try{ return await this.req('POST',`/repos/${owner}/${repo}/pages`,{source:{branch:'main',path:'/'}}); }catch{} }
  }
  updateTopics(owner,repo,topics){ return this.req('PUT',`/repos/${owner}/${repo}/topics`,{names:topics}).catch(()=>{}); }
  deleteRepo(owner,repo){ return this.req('DELETE',`/repos/${owner}/${repo}`); }
}

class GitLabAPI {
  constructor(token){ this.token=token; this.base='https://gitlab.com/api/v4'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/user'); }
  createProject(name,desc){ return this.req('POST','/projects',{name,description:desc,visibility:'public',initialize_with_readme:true,pages_access_level:'public'}); }
  async createOrUpdateFile(pid,filePath,content,msg){
    try{ return await this.req('POST',`/projects/${pid}/repository/files/${encodeURIComponent(filePath)}`,{branch:'main',content,commit_message:msg,encoding:'text'}); }
    catch(e){
      if(e.message&&(e.message.includes('already exists')||e.message.includes('A file with this name already exists'))){
        return await this.req('PUT',`/projects/${pid}/repository/files/${encodeURIComponent(filePath)}`,{branch:'main',content,commit_message:msg,encoding:'text'});
      }
      throw e;
    }
  }
  enablePages(pid){ return this.req('PUT',`/projects/${pid}`,{pages_access_level:'public'}).catch(()=>{}); }
}

class NetlifyAPI {
  constructor(token){ this.token=token; this.base='https://api.netlify.com/api/v1'; }
  h(extra={}){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json',...extra}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    if(!r.ok){ const t=await r.text(); throw new Error(t||'HTTP '+r.status); } return r.json().catch(()=>({}));
  }
  getUser(){ return this.req('GET','/user'); }
  createSite(name){ return this.req('POST','/sites',{name,subdomain:name}); }
  async deploySite(siteId,htmlContent){
    // Step 1: Compute SHA1 of file content
    const encoder=new TextEncoder();
    const data=encoder.encode(htmlContent);
    const hashBuffer=await crypto.subtle.digest('SHA-1',data);
    const hashArray=Array.from(new Uint8Array(hashBuffer));
    const sha1=hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
    // Step 2: Create deploy with file manifest
    const r1=await smartFetch(`${this.base}/sites/${siteId}/deploys`,{method:'POST',
      headers:{'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'},
      body:JSON.stringify({files:{'/index.html':sha1},draft:false})});
    const d1=await r1.json(); if(!r1.ok) throw new Error(d1.message||'Deploy init failed');
    // Step 3: Upload required files
    if(d1.required&&d1.required.length>0){
      const r2=await smartFetch(`${this.base}/deploys/${d1.id}/files/index.html`,{method:'PUT',
        headers:{'Authorization':`Bearer ${this.token}`,'Content-Type':'application/octet-stream'},
        body:new Blob([htmlContent])});
      if(!r2.ok){ const t=await r2.text(); throw new Error('File upload failed: '+r2.status); }
    }
    return d1;
  }
}

class VercelAPI {
  constructor(token){ this.token=token; this.base='https://api.vercel.com'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.error&&d.error.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/v2/user'); }
  async createDeployment(name,htmlContent){
    // Compute SHA1 for Vercel file manifest
    const encoder=new TextEncoder();
    const data=encoder.encode(htmlContent);
    const hashBuf=await crypto.subtle.digest('SHA-1',data);
    const sha1=Array.from(new Uint8Array(hashBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    const bytes2=new TextEncoder().encode(htmlContent);
    const encoded=btoa(Array.from(bytes2).map(b=>String.fromCharCode(b)).join(''));
    return this.req('POST','/v13/deployments',{
      name:slug(name),
      files:[{file:'index.html',data:encoded,encoding:'base64',sha:sha1}],
      projectSettings:{framework:null},
      target:'production'
    });
  }
}

class NotionAPI {
  constructor(token){ this.token=token; this.base='https://api.notion.com/v1'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json','Notion-Version':'2022-06-28'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/users/me'); }
  async createPage(parentPageId,title,content){
    const blocks=content.split('\n\n').filter(Boolean).slice(0,100).map(para=>({object:'block',type:'paragraph',paragraph:{rich_text:[{type:'text',text:{content:para.slice(0,2000)}}]}}));
    return this.req('POST','/pages',{parent:{page_id:parentPageId},properties:{title:{title:[{type:'text',text:{content:title}}]}},children:blocks});
  }
}

class MediumAPI {
  constructor(token){ this.token=token; this.base='https://api.medium.com/v1'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json','Accept':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/me'); }
  createPost(userId,title,content,tags=[]){ return this.req('POST',`/users/${userId}/posts`,{title,contentFormat:'markdown',content,tags:tags.slice(0,5),publishStatus:'public'}); }
}

class HashnodeAPI {
  constructor(token){ this.token=token; this.base='https://gql.hashnode.com'; }
  async query(q,vars={}){
    const r=await smartFetch(this.base,{method:'POST',headers:{'Authorization':this.token,'Content-Type':'application/json'},body:JSON.stringify({query:q,variables:vars})});
    const d=await r.json(); if(d.errors) throw new Error(d.errors[0].message); return d.data;
  }
  getUser(){ return this.query('query{me{id username name}}'); }
  getPublications(){ return this.query('query{me{publications(first:10){edges{node{id title url}}}}}'); }
  createPost(publicationId,title,content,tags=[]){
    return this.query('mutation CreatePost($input:PublishPostInput!){publishPost(input:$input){post{id url}}}',
      {input:{title,contentMarkdown:content,publicationId,tags:tags.slice(0,5).map(t=>({name:t,slug:slug(t)})),originalArticleURL:null}});
  }
}

class RedditAPI {
  constructor(token){ this.token=token; this.base='https://oauth.reddit.com'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'User-Agent':'SEO-Tool/1.0','Content-Type':'application/x-www-form-urlencoded'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?new URLSearchParams(body).toString():undefined});
    const d=await r.json(); if(d.error) throw new Error(d.message||d.error); return d;
  }
  getMe(){ return this.req('GET','/api/v1/me'); }
  submit(subreddit,title,text){ return this.req('POST','/api/submit',{api_type:'json',kind:'self',sr:subreddit,title,text,resubmit:'true'}); }
}

class BloggerAPI {
  constructor(token){ this.token=token; this.base='https://www.googleapis.com/blogger/v3'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.error&&d.error.message||'HTTP '+r.status); return d;
  }
  listBlogs(){ return this.req('GET','/users/self/blogs'); }
  createPost(blogId,title,content,labels=[]){ return this.req('POST',`/blogs/${blogId}/posts`,{kind:'blogger#post',title,content,labels}); }
}

class SubstackAPI {
  constructor(token,subdomain){ this.token=token; this.subdomain=subdomain; this.base=`https://${subdomain}.substack.com/api/v1`; }
  h(){ return {'Cookie':`substack.sid=${this.token}`,'Content-Type':'application/json','Origin':'https://'+this.subdomain+'.substack.com','Referer':'https://'+this.subdomain+'.substack.com'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined,credentials:'include'});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||d.message||'HTTP '+r.status); return d;
  }
  // Substack v1 API: create draft then publish
  async createPost(title,htmlBody){
    // Create as published post directly
    const body={
      type:'newsletter',
      draft:false,
      title,
      body_html:'<div>'+htmlBody+'</div>',
      audience:'everyone',
      send_email:false
    };
    return this.req('POST','/posts',body);
  }
}

class WordPressAPI {
  constructor(token){ this.token=token; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async getMe(){
    const r=await smartFetch('https://public-api.wordpress.com/rest/v1.1/me',{method:'GET',headers:this.h()});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'HTTP '+r.status); return d;
  }
  async getSites(){
    const r=await smartFetch('https://public-api.wordpress.com/rest/v1.1/me/sites',{method:'GET',headers:this.h()});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'HTTP '+r.status); return d;
  }
  async createPost(siteId,title,content,tags=[]){
    const r=await smartFetch(`https://public-api.wordpress.com/rest/v1.1/sites/${siteId}/posts/new`,{method:'POST',headers:this.h(),body:JSON.stringify({title,content,status:'publish',tags:tags.join(','),format:'standard'})});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||d.message||'HTTP '+r.status); return d;
  }
}

class DevToAPI {
  constructor(token){ this.token=token; this.base='https://dev.to/api'; }
  h(){ return {'api-key':this.token,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/users/me'); }
  createArticle(title,body_markdown,tags=[]){ return this.req('POST','/articles',{article:{title,body_markdown,published:true,tags:tags.slice(0,4)}}); }
}

class TumblrAPI {
  constructor(token,blogName){ this.token=token; this.blogName=blogName; this.base='https://api.tumblr.com/v2'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(d.meta&&d.meta.status>=400) throw new Error(d.meta.msg||'HTTP '+d.meta.status); return d;
  }
  getUser(){ return this.req('GET','/user/info'); }
  createPost(blogId,title,body,tags=[]){ return this.req('POST',`/blog/${blogId}/posts`,{content:[{type:'text',text:`# ${title}\n\n${body}`}],tags,state:'published'}); }
}

class GhostAPI {
  // adminKey format: "KEY_ID:SECRET" e.g. "64a6...c4:9f2a..."
  constructor(adminKey,apiUrl){ this.adminKey=adminKey; this.apiUrl=(apiUrl||'').replace(/\/$/,''); this.base=this.apiUrl+'/ghost/api/admin'; }
  async _jwt(){
    // Ghost Admin API requires a signed JWT from the Admin API key
    const [id,secret]=this.adminKey.split(':');
    if(!id||!secret) throw new Error('Ghost Admin key must be in format "id:secret"');
    const now=Math.floor(Date.now()/1000);
    const header=btoa(JSON.stringify({alg:'HS256',typ:'JWT',kid:id})).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    const payload=btoa(JSON.stringify({iat:now,exp:now+300,aud:'/admin/'})).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    const sigInput=`${header}.${payload}`;
    // Decode hex secret to key bytes
    const keyBytes=new Uint8Array(secret.match(/../g).map(h=>parseInt(h,16)));
    const cryptoKey=await crypto.subtle.importKey('raw',keyBytes,{name:'HMAC',hash:'SHA-256'},false,['sign']);
    const sig=await crypto.subtle.sign('HMAC',cryptoKey,new TextEncoder().encode(sigInput));
    const sigB64=btoa(String.fromCharCode(...new Uint8Array(sig))).replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_');
    return `${sigInput}.${sigB64}`;
  }
  async h(){ const jwt=await this._jwt(); return {'Authorization':`Ghost ${jwt}`,'Content-Type':'application/json','Accept-Version':'v5.0'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:await this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'HTTP '+r.status); return d;
  }
  getSite(){ return this.req('GET','/site/'); }
  createPost(title,html,tags=[]){ return this.req('POST','/posts/?source=html',{posts:[{title,html,status:'published',tags:tags.map(t=>({name:t}))}]}); }
}

class TelegraphAPI {
  constructor(token){ this.token=token; this.base='https://api.telegra.ph'; }
  async req(method,params={}){
    const url=new URL(this.base+'/'+method);
    Object.entries({...params,access_token:this.token}).forEach(([k,v])=>url.searchParams.set(k,String(v)));
    const r=await smartFetch(url.toString(),{method:'GET'}); const d=await r.json();
    if(!d.ok) throw new Error(d.error||'Telegraph error'); return d.result;
  }
  getAccount(){ return this.req('getAccountInfo',{fields:JSON.stringify(['short_name','page_count'])}); }
  async createPage(title,markdownContent,authorName=''){
    // Convert markdown to Telegraph node array
    const nodes=[];
    const lines=(markdownContent||'').split('\n');
    for(const line of lines){
      if(!line.trim()){ continue; }
      if(line.startsWith('# ')){ nodes.push({tag:'h3',children:[line.slice(2).trim()]}); }
      else if(line.startsWith('## ')){ nodes.push({tag:'h4',children:[line.slice(3).trim()]}); }
      else if(line.startsWith('### ')){ nodes.push({tag:'h4',children:[line.slice(4).trim()]}); }
      else if(line.startsWith('- ')){ nodes.push({tag:'p',children:[{tag:'li',children:[line.slice(2).trim()]}]}); }
      else if(line.startsWith('**')&&line.endsWith('**')){ nodes.push({tag:'p',children:[{tag:'b',children:[line.replace(/\*\*/g,'')]}]}); }
      else if(line.startsWith('> ')){ nodes.push({tag:'blockquote',children:[line.slice(2).trim()]}); }
      else if(line==='---'){ nodes.push({tag:'hr'}); }
      else { nodes.push({tag:'p',children:[line.trim()]}); }
    }
    // Inject links as paragraph at end
    const linkLines=(markdownContent||'').match(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g)||[];
    if(linkLines.length){ nodes.push({tag:'p',children:['Resources: ',...linkLines.map(m=>{ const [,label,href]=m.match(/\[([^\]]+)\]\(([^)]+)\)/)||[]; return {tag:'a',attrs:{href,target:'_blank'},children:[label||href]}; }).flatMap((n,i,a)=>i<a.length-1?[n,', ']:[n])]}); }
    const safeNodes=nodes.slice(0,200);
    const r=await smartFetch(this.base+'/createPage',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({access_token:this.token,title:title.slice(0,256),author_name:(authorName||'').slice(0,128),content:safeNodes,return_content:false})});
    const d=await r.json(); if(!d.ok) throw new Error(d.error||'Telegraph createPage failed'); return d.result;
  }
}

class CloudflareAPI {
  constructor(token,accountId){ this.token=token; this.accountId=accountId; this.base='https://api.cloudflare.com/client/v4'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!d.success) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'CF error'); return d.result;
  }
  getUser(){ return this.req('GET','/user'); }
  createProject(name){ return this.req('POST',`/accounts/${this.accountId}/pages/projects`,{name,production_branch:'main'}); }
  async uploadPages(projectName,htmlContent){
    const formData=new FormData();
    formData.append('/index.html',new Blob([htmlContent],{type:'text/html'}),'/index.html');
    const r=await smartFetch(`${this.base}/accounts/${this.accountId}/pages/projects/${projectName}/deployments`,{method:'POST',headers:{'Authorization':`Bearer ${this.token}`},body:formData});
    const d=await r.json(); if(!d.success) throw new Error((d.errors&&d.errors[0]&&d.errors[0].message)||'CF deploy error'); return d.result;
  }
}

class WixAPI {
  constructor(token,siteId){ this.token=token; this.siteId=siteId; this.base='https://www.wixapis.com'; }
  h(){ return {'Authorization':this.token,'wix-site-id':this.siteId,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  async createPost(title,htmlContent,tags=[]){
    // Wix Blog v3 API: create a post
    const body={
      post:{
        title,
        excerpt:title+' â€” complete guide',
        featured:false,
        status:'PUBLISHED',
        richContent:{
          nodes:[
            {type:'HEADING',id:'h1',nodes:[{type:'TEXT',id:'t1',textData:{text:title,decorations:[]}}],headingData:{level:1}},
            {type:'PARAGRAPH',id:'p1',nodes:[{type:'TEXT',id:'t2',textData:{text:htmlContent.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim().slice(0,5000),decorations:[]}}],paragraphData:{}}
          ]
        },
        tagIds:[]
      }
    };
    return this.req('POST','/blog/v3/posts',body);
  }
}

class ReplitAPI {
  constructor(token){ this.token=token; this.base='https://replit.com/graphql'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'}; }
  async query(q,vars={}){
    const r=await smartFetch(this.base,{method:'POST',headers:this.h(),body:JSON.stringify({query:q,variables:vars})});
    const d=await r.json(); if(d.errors) throw new Error(d.errors[0].message); return d.data;
  }
  getUser(){ return this.query('query{currentUser{id username}}'); }
  createRepl(title,sl){ return this.query('mutation($input:CreateReplInput!){createRepl(input:$input){repl{id url slug}}}',{input:{title,slug:sl,isPrivate:false,language:'html'}}); }
}

class IssuuAPI {
  constructor(token){ this.token=token; this.base='https://api.issuu.com/v2'; }
  h(){ return {'Authorization':`Bearer ${this.token}`,'Content-Type':'application/json'}; }
  async req(method,path,body){
    const r=await smartFetch(this.base+path,{method:method,headers:this.h(),body:body?JSON.stringify(body):undefined});
    const d=await r.json(); if(!r.ok) throw new Error(d.message||'HTTP '+r.status); return d;
  }
  getUser(){ return this.req('GET','/drafts?size=1'); }
  createDraft(title,description){ return this.req('POST','/drafts',{confirmCopyright:true,fileUrl:'',title,description,type:'editorial',access:'public'}); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TERMINAL HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeTerminal(termEl){
  const add=(msg,type='info')=>{
    const div=document.createElement('div');
    div.className='tline';
    div.innerHTML=`<span class="ttime">${ts()}</span><span class="t-${type}">${esc(msg)}</span>`;
    termEl.appendChild(div);
    termEl.scrollTop=termEl.scrollHeight;
  };
  const clear=()=>{ termEl.innerHTML='<span class="tm">// Output will appear here...</span>'; };
  clear();
  return {add,clear};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function urlBannerHTML(url,label,pid){
  const p=getPlatform(pid);
  return `<div class="url-banner">
    <span style="font-size:16px">${p.icon}</span>
    <div style="flex:1"><div class="ub-label">${esc(label)} Â· ${esc(p.name)}</div><div class="ub-url"><a href="${esc(url)}" target="_blank" rel="noreferrer">${esc(url)}</a></div></div>
    <button class="btn btn-ghost btn-sm" onclick="copyText('${esc(url)}',this)">COPY</button>
    <a href="${esc(url)}" target="_blank" rel="noreferrer" class="btn btn-primary btn-sm">Visit â†—</a>
  </div>`;
}
function copyText(text,btn){
  if(!text||typeof text!=='string'){ console.warn('copyText: invalid text'); return; }
  navigator.clipboard.writeText(text).then(()=>{
    const old=btn.textContent; btn.textContent='âœ“ COPIED';
    setTimeout(()=>btn.textContent=old,1500);
  }).catch(()=>{ 
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    const old=btn.textContent; btn.textContent='âœ“ COPIED'; setTimeout(()=>btn.textContent=old,1500);
  });
}
function exportCopy(btn){ copyText(getExportAll(),btn); }
function setProgress(barEl,pct){ barEl.style.width=pct+'%'; }
function notice(type,msg){ return `<div class="notice notice-${type}">${esc(msg)}</div>`; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function statBox(val,label,cls){ return `<div class="stat ${cls}"><div class="stat-v">${val}</div><div class="stat-l">${label}</div></div>`; }
function statsRow(items){ return `<div class="grid${items.length}" style="margin-bottom:18px">${items.map(([v,l,c])=>statBox(v,l,c)).join('')}</div>`; }

// â”€â”€ MODULE HEADER: adds quick-link to relevant Settings section + Help
function moduleBar(settingsSection, helpAnchor) {
  return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:5px 10px;background:var(--win-dark);border:1px solid var(--win-border)">
    <span style="font-size:10px;color:var(--win-text-muted);font-weight:700">QUICK LINKS:</span>
    ${settingsSection ? `<button class="btn btn-ghost btn-xs" onclick="switchPage('settings');setTimeout(()=>{const s=document.querySelector('.set-section-title');if(s)s.closest('.set-section')?.scrollIntoView({behavior:'smooth'})},250)" title="Configure settings for this module" style="font-size:10px">âš™ Settings</button>` : ''}
    ${helpAnchor ? `<button class="btn btn-ghost btn-xs" onclick="switchPage('help');setTimeout(()=>document.getElementById('${helpAnchor}')?.scrollIntoView({behavior:'smooth'}),200)" title="Open help for this module" style="font-size:10px">â“ Help Guide</button>` : ''}
    <button class="btn btn-ghost btn-xs" onclick="switchPage('settings')" style="font-size:10px">âš™ All Settings</button>
    <button class="btn btn-ghost btn-xs" onclick="switchPage('help')" style="font-size:10px">ğŸ“– Full Help</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN LABELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TOKEN_INFO = {
  github:    {label:'Personal Access Token',     ph:'ghp_xxxxxxxxxxxxxxxxxxxx',     hint:'Required scopes: repo, delete_repo', link:'https://github.com/settings/tokens/new?scopes=repo,delete_repo'},
  gitlab:    {label:'Personal Access Token',     ph:'glpat-xxxxxxxxxxxxxxxxxxxx',   hint:'Required scopes: api, read_user',    link:'https://gitlab.com/-/user_settings/personal_access_tokens'},
  netlify:   {label:'Personal Access Token',     ph:'netlify-personal-access-token',hint:'Create at Netlify â†’ User Settings â†’ Applications', link:'https://app.netlify.com/user/applications/personal'},
  vercel:    {label:'Access Token',              ph:'vercel-access-token',          hint:'Create at Vercel â†’ Account Settings â†’ Tokens', link:'https://vercel.com/account/tokens'},
  notion:    {label:'Integration Token',         ph:'secret_xxxxxxxxxxxxxxxxxxxx',  hint:'Create integration at notion.so/my-integrations', link:'https://www.notion.so/my-integrations'},
  medium:    {label:'Integration Token',         ph:'medium-integration-token',     hint:'Create at Medium Settings â†’ Security â†’ Integration tokens', link:'https://medium.com/me/settings/security'},
  substack:  {label:'Session Token (substack.sid)', ph:'your-substack-session-token', hint:'Find in browser cookies when logged into Substack', link:'https://substack.com'},
  blogger:   {label:'Google OAuth Token',        ph:'ya29.xxx... Google OAuth2 token', hint:'Requires Google Cloud OAuth2 token with blogger scope', link:'https://console.cloud.google.com/'},
  hashnode:  {label:'API Key',                   ph:'hashnode-api-key',             hint:'Hashnode â†’ Account Settings â†’ Developer â†’ API Keys', link:'https://hashnode.com/settings/developer'},
  reddit:    {label:'OAuth Bearer Token',        ph:'reddit-oauth-bearer-token',    hint:'Use Reddit API OAuth flow', link:'https://www.reddit.com/prefs/apps'},
  wordpress: {label:'WordPress.com OAuth Token', ph:'wordpress-oauth-access-token', hint:'OAuth token from WordPress.com developer apps', link:'https://developer.wordpress.com/apps/'},
  devto:     {label:'Dev.to API Key',            ph:'dev-to-api-key',               hint:'Settings â†’ Account â†’ DEV Community API Keys', link:'https://dev.to/settings/extensions'},
  tumblr:    {label:'OAuth Bearer Token',        ph:'tumblr-oauth-token',           hint:'Create app at Tumblr API â€” use OAuth2 bearer token', link:'https://www.tumblr.com/oauth/apps'},
  ghost:     {label:'Admin API Key (id:secret)', ph:'64a6...c4:9f2a...',            hint:'Ghost Admin â†’ Integrations â†’ Add custom integration', link:'https://ghost.org/docs/admin-api/'},
  wix:       {label:'Wix API Key',               ph:'wix-api-key',                  hint:'Wix Dev Center â†’ API Keys â†’ Generate API Key', link:'https://manage.wix.com/account/api-keys'},
  telegraph: {label:'Access Token',              ph:'telegraph-access-token',       hint:'Create account at telegra.ph/api â†’ createAccount', link:'https://telegra.ph/api'},
  codepen:   {label:'CodePen Username',          ph:'your-codepen-username',        hint:'CodePen has no write API â€” username used for tracking', link:'https://codepen.io'},
  replit:    {label:'Replit API Token',          ph:'replit-api-token',             hint:'Replit â†’ Account Settings â†’ Connected Services â†’ API', link:'https://replit.com/account'},
  cloudflare:{label:'Cloudflare API Token',      ph:'cloudflare-api-token',         hint:'Cloudflare Dashboard â†’ My Profile â†’ API Tokens â†’ Create Token', link:'https://dash.cloudflare.com/profile/api-tokens'},
  issuu:        {label:'Issuu API Token',           ph:'issuu-api-token',              hint:'Issuu account settings â†’ API keys', link:'https://issuu.com/home/settings/integrations'},
  // new platforms
  onfeetnation: {label:'Username',                  ph:'your-username',                hint:'Your OnFeetNation login username', link:'https://www.onfeetnation.com'},
  caribbeanfever:{label:'Username',                 ph:'your-username',                hint:'Your CaribbeanFever login username', link:'https://caribbeanfever.com'},
  bitbin:       {label:'(No login needed)',          ph:'anonymous',                    hint:'Bitbin allows anonymous pastes. Enter any label.', link:'https://bitbin.it'},
  pastelink:    {label:'(No login needed)',          ph:'anonymous',                    hint:'Pastelink allows anonymous pastes. Enter any label.', link:'https://pastelink.net'},
  click4r:      {label:'Username',                  ph:'your-username',                hint:'Your Click4R account username', link:'https://www.click4r.com'},
  ideone:       {label:'(No login needed)',          ph:'anonymous',                    hint:'Ideone allows public pastes without login. Enter any label.', link:'https://ideone.com'},
  controlc:     {label:'(No login needed)',          ph:'anonymous',                    hint:'ControlC allows anonymous pastes. Enter any label.', link:'https://controlc.com'},
  rentry:       {label:'Edit Code (optional)',       ph:'leave blank for random',       hint:'Rentry.co edit code protects your paste. Leave blank to auto-generate.', link:'https://rentry.co'},
  techplanet:   {label:'Username',                  ph:'your-username',                hint:'Your TechPlanet account username', link:'https://techplanet.today'},
  vingle:       {label:'Access Token',              ph:'vingle-access-token',          hint:'Vingle OAuth access token from developer settings', link:'https://www.vingle.net'},
  writeonwall:  {label:'Username',                  ph:'your-username',                hint:'Your WriteOnWall account username', link:'https://writeonwall.com'},
  taylorhicks:  {label:'Ning API Key',              ph:'ning-api-key',                 hint:'Ning network API key from your account settings', link:'https://taylorhicks.ning.com'},
  snaplant:     {label:'Username',                  ph:'your-username',                hint:'Your Snaplant account username', link:'http://snaplant.com'},
  theprose:     {label:'Auth Token / Cookie',       ph:'your-session-token',           hint:'Session token from browser cookies after login', link:'https://www.theprose.com'},
  deviantart:   {label:'Access Token',              ph:'deviantart-access-token',      hint:'DeviantArt â†’ Developer Settings â†’ My Applications â†’ OAuth2 token', link:'https://www.deviantart.com/developers/'},
};
const EXTRA_INFO = {
  substack:  {label:'Your Substack Subdomain',   ph:'yourname (from yourname.substack.com)'},
  notion:    {label:'Parent Page ID',            ph:'notion page ID (32-char hex)'},
  blogger:   {label:'Blog ID (optional)',        ph:'Optional: specific blog ID'},
  reddit:    {label:'Default Subreddit',         ph:'e.g. entrepreneur'},
  ghost:     {label:'Ghost Blog URL',            ph:'https://yourblog.ghost.io'},
  wix:       {label:'Wix Site ID',               ph:'your-wix-site-id'},
  tumblr:    {label:'Blog Identifier',           ph:'yourblog.tumblr.com'},
  cloudflare:{label:'Cloudflare Account ID',     ph:'your-cloudflare-account-id'},
  issuu:        {label:'Issuu Username',            ph:'your-issuu-username'},
  onfeetnation: {label:'Password',                  ph:'your-password'},
  caribbeanfever:{label:'Password',                 ph:'your-password'},
  click4r:      {label:'Password',                  ph:'your-password'},
  techplanet:   {label:'Password',                  ph:'your-password'},
  writeonwall:  {label:'Password',                  ph:'your-password'},
  snaplant:     {label:'Password',                  ph:'your-password'},
  theprose:     {label:'Password',                  ph:'your-password'},
  taylorhicks:  {label:'Password',                  ph:'your-password'},
  deviantart:   {label:'DeviantArt Username',       ph:'your-deviantart-username'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL STATE UPDATER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHeader(){
  const live=S.campaigns.filter(c=>c.status==='success').length;
  document.getElementById('hdr-stats').textContent=`${S.accounts.length} accounts Â· ${S.keywords.length} keywords Â· ${live} live URLs`;
  const pill=document.getElementById('hdr-pill');
  if(S.accounts.length>0){ pill.className='pill pill-on'; pill.innerHTML='<span class="blink">â—</span> active'; }
  else { pill.className='pill pill-off'; pill.innerHTML='â— no accounts'; }
  document.getElementById('kw-badge').textContent=S.keywords.length;
  document.getElementById('link-badge').textContent=S.links.length;
  document.getElementById('export-badge').textContent=live;
  // sidebar accounts
  const sb=document.getElementById('sidebar-accounts');
  if(!S.accounts.length){ sb.innerHTML='<div style="padding:8px 18px;font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">No accounts connected</div>'; return; }
  const byPlatform={};
  S.accounts.forEach(a=>{ byPlatform[a.platform]=(byPlatform[a.platform]||0)+1; });
  sb.innerHTML='<div style="padding:8px 18px;font-family:var(--mono);font-size:11px;color:var(--muted2);line-height:2;font-weight:600">'+
    Object.entries(byPlatform).map(([pid,cnt])=>{ const p=getPlatform(pid); return `<div><span style="color:var(--accent)">${p.icon}</span> ${cnt}Ã— ${p.name.split(' ')[0]}</div>`; }).join('')+'</div>';
}
function updatePlatformBar(){
  const bar=document.getElementById('platform-bar');
  bar.innerHTML=PLATFORMS.map(p=>{
    const accs=S.accounts.filter(a=>a.platform===p.id).length;
    const live=S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length;
    const badge=accs>0?`<span class="nav-badge" style="margin-left:4px">${live>0?live+' live':'âœ“'}</span>`:'';
    return `<div class="ptab ${S.activePlatform===p.id?'active':''}" onclick="switchPlatform('${p.id}')">
      <span style="font-size:14px">${p.icon}</span>${esc(p.name)}<span style="font-size:8px;opacity:0.5;margin-left:2px">DA${p.da}</span>${badge}</div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPage(id){
  S.activePage=id;
  document.querySelectorAll('.nav-item').forEach(el=>{
    el.classList.toggle('active', el.dataset.page===id);
  });
  document.querySelectorAll('.page').forEach(el=>{ el.classList.remove('active'); });
  const el=document.getElementById('page-'+id);
  if(el){ el.classList.add('active'); }
  renderPage(id);
}
function switchPlatform(id){
  S.activePlatform=id;
  updatePlatformBar();
  if(['setup','campaign'].includes(S.activePage)){ renderPage(S.activePage); }
}
document.querySelectorAll('.nav-item[data-page]').forEach(el=>{
  el.addEventListener('click',()=>switchPage(el.dataset.page));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGE RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPage(id){
  const el=document.getElementById('page-'+id);
  if(!el) return;
  const r={
    dashboard:   renderDashboard,
    global_blast:renderGlobalBlast,
    keywords:    renderKeywords,
    links:       renderLinks,
    setup:       renderSetup,
    campaign:    renderCampaign,
    indexing:    renderIndexing,
    export:      renderExport,
    content_studio: renderContentStudio,
    competitor_spy: renderCompetitorSpy,
    kw_research:    renderKwResearch,
    blog_commenter: renderBlogCommenter,
    parasite_finder: renderParasiteFinder,
    comment_sites: renderCommentSites,
    pdf_parasite: renderPDFParasitePage,
    pdf_uploader: renderPDFUploaderPage,
    proxy_manager: renderProxyManagerPage,
    gsc_inspector: renderGSCInspector,
    link_indexer: renderLinkIndexer,
    ping_submitter: renderPingSubmitter,
    account_creator: renderAccountCreator,
    serp_scraper:  renderSerpScraper,
    social_blaster: renderSocialBlaster,
    web2_builder:  renderWeb2Builder,
    forum_blaster: renderForumBlaster,
    email_generator: renderEmailGenerator,
    captcha_solver: renderCaptchaSolver,
    session_manager: renderSessionManager,
    ctr_manipulator: renderCTRManipulator,
    freshness_scheduler: renderFreshnessScheduler,
    anchor_controller: renderAnchorController,
    settings: renderSettings,
    help: renderHelp,
    rank_tracker:     renderRankTracker,
    backlink_monitor: renderBacklinkMonitor,
    roi_tracker:      renderROITracker,
    api_health:       renderApiHealth,
    content_spinner:  renderContentSpinner,
    schema_generator: renderSchemaGenerator,
    sitemap_generator:renderSitemapGenerator,
    internal_links:   renderInternalLinks,
    campaign_templates:renderCampaignTemplates,
    campaign_scheduler:renderCampaignScheduler,
    url_health:       renderUrlHealth,
    blacklist_manager:renderBlacklistManager,
    rate_monitor:     renderRateMonitor,
  }[id];
  if(r) r(el);
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(el){
  const totalSuccess=S.campaigns.filter(c=>c.status==='success').length;
  const totalFail=S.campaigns.filter(c=>c.status==='error').length;
  const rate=S.campaigns.length?Math.round(totalSuccess/S.campaigns.length*100):0;
  el.innerHTML=`
  <div class="page-title">âš¡ Dashboard</div>
  <div class="page-sub">// overview of all 20 platforms Â· Global Blast ready</div>
  <div class="grid5" style="margin-bottom:18px">
    ${statBox(S.accounts.length,'Accounts','g')}${statBox(S.keywords.length,'Keywords','b')}
    ${statBox(totalSuccess,'Live URLs','g')}${statBox(totalFail,'Failed','r')}${statBox(rate+'%','Success Rate','p')}
  </div>
  <div class="card">
    <div class="card-title">Platform Status</div>
    <div class="grid5">${PLATFORMS.map(p=>{
      const accs=S.accounts.filter(a=>a.platform===p.id).length;
      const live=S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length;
      return `<div class="pstat" onclick="switchPlatform('${p.id}');switchPage('setup')" style="cursor:pointer;transition:border-color 0.15s,background 0.15s" onmouseenter="this.style.borderColor='var(--accent)';this.style.background='rgba(0,87,255,0.05)'" onmouseleave="this.style.borderColor='';this.style.background=''"><div class="pstat-icon">${p.icon}</div><div class="pstat-name">${esc(p.name)}</div>
        <div class="pstat-status" style="color:${accs>0?'var(--accent)':'var(--muted2)'}">${accs>0?'âœ“ '+accs+' acct'+(accs>1?'s':'')+(live>0?' Â· '+live+' live':''):' Not connected'}</div>
        <div style="font-size:10px;color:var(--muted2);font-family:var(--mono);margin-top:3px;font-weight:700">DA ${p.da}</div>
        <div style="font-size:10px;color:var(--accent);font-family:var(--mono);margin-top:4px;font-weight:700">â†’ setup</div></div>`;
    }).join('')}</div>
  </div>
  ${S.campaigns.length?`
  <div class="card">
    <div class="card-title">Recent Campaign Activity</div>
    <div class="tw"><table>
      <thead><tr><th>Platform</th><th>Keyword</th><th>URL</th><th>Status</th><th>Time</th></tr></thead>
      <tbody>${[...S.campaigns].reverse().slice(0,15).map(c=>{
        const p=getPlatform(c.platform);
        return `<tr>
          <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs">${esc(p.name)}</span></td>
          <td class="mono xs">${esc(c.keyword)}</td>
          <td>${c.url?`<a href="${esc(c.url)}" target="_blank" rel="noreferrer" class="ta" style="text-decoration:none;font-size:11px;font-family:var(--mono);font-weight:600">${esc(c.url.replace('https://','').slice(0,40))}${c.url.length>45?'...':''}</a>`:'<span class="tm">â€”</span>'}</td>
          <td><span class="badge ${c.status==='success'?'badge-g':'badge-r'}">${c.status}</span></td>
          <td class="tm mono xs">${c.ts}</td></tr>`;
      }).join('')}</tbody>
    </table></div>
  </div>`:`<div class="notice notice-info">Connect accounts in Setup, add Keywords, then run campaigns. Activity appears here.</div>`}`;
}

// â”€â”€â”€ KEYWORDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKeywords(el){
  el.innerHTML=`
  <div class="page-title">ğŸ”‘ Keyword Manager</div>
  <div class="page-sub">// keywords shared across ALL platforms</div>
  <div class="card">
    <div class="card-title">Add Keyword</div>
    <div class="row">
      <div class="f1 fg mb0"><input type="text" id="kw-input" placeholder="e.g. best creatine supplement"/></div>
      <button class="btn btn-primary" onclick="addKeyword()">+ Add</button>
    </div>
    <div id="kw-chips" class="chips"></div>
    ${!S.keywords.length?'<p class="tm mono xs mt8">No keywords yet.</p>':''}
  </div>
  <div class="card">
    <div class="card-title">Bulk Import</div>
    <div class="fg"><label class="lbl">Paste keywords (comma or newline separated)</label>
      <textarea id="kw-bulk" rows="5" placeholder="best protein powder&#10;creatine monohydrate&#10;pre workout guide"></textarea></div>
    <div class="flex aic g8">
      <button class="btn btn-primary" onclick="bulkAddKeywords()">Import</button>
      <span class="tm mono xs">${S.keywords.length} keywords loaded</span>
      <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="clearKeywords()">Clear All</button>
    </div>
  </div>`;
  renderKwChips();
  document.getElementById('kw-input').addEventListener('keydown',e=>{ if(e.key==='Enter') addKeyword(); });
}
function renderKwChips(){
  const c=document.getElementById('kw-chips'); if(!c) return;
  c.innerHTML=S.keywords.map(k=>`<span class="chip on" onclick="removeKeyword('${esc(k)}')">${esc(k)} âœ•</span>`).join('');
}
function addKeyword(){
  const inp=document.getElementById('kw-input'); if(!inp) return;
  const k=inp.value.trim(); if(!k||S.keywords.includes(k)) return;
  S.keywords.push(k); inp.value=''; updateHeader(); renderKeywords(document.getElementById('page-keywords'));
}
function removeKeyword(k){ S.keywords=S.keywords.filter(x=>x!==k); updateHeader(); renderKeywords(document.getElementById('page-keywords')); }
function bulkAddKeywords(){
  const ta=document.getElementById('kw-bulk'); if(!ta) return;
  const lines=ta.value.split(/[\n,]+/).map(l=>l.trim()).filter(Boolean);
  S.keywords=[...new Set([...S.keywords,...lines])]; ta.value='';
  updateHeader(); renderKeywords(document.getElementById('page-keywords'));
}
function clearKeywords(){ S.keywords=[]; updateHeader(); renderKeywords(document.getElementById('page-keywords')); }

// â”€â”€â”€ LINKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// link status cache: id -> {status:'ok'|'broken'|'checking'|'unknown', code}
const _linkStatus={};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINKS MANAGER â€” FULL CREDENTIAL VAULT + SITE REGISTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LM_PLATFORMS = [
  // â”€â”€ Blog / CMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'wordpress_com', name:'WordPress.com',    icon:'ğŸ”µ', da:95, cat:'Blog/CMS',    auth:['api_key','user_pass'], apiBase:'https://public-api.wordpress.com/wp/v2',     loginUrl:'https://wordpress.com/log-in',        postEp:'/posts',           verifyEp:'/posts?per_page=1',                  note:'App Password (Settings > Security) Â· REST API v2 Â· Subdomain blogs' },
  { id:'wordpress_sh',  name:'WordPress (Self)', icon:'ğŸ”µ', da:0,  cat:'Blog/CMS',    auth:['api_key','user_pass'], apiBase:'{url}/wp-json/wp/v2',                         loginUrl:'{url}/wp-login.php',                  postEp:'/posts',           verifyEp:'/posts?per_page=1',                  note:'Self-hosted Â· Application Password Â· REST API Â· Full control' },
  { id:'ghost_io',      name:'Ghost.io',         icon:'ğŸ‘»', da:83, cat:'Blog/CMS',    auth:['api_key'],             apiBase:'https://{sub}.ghost.io/ghost/api/admin',      loginUrl:'https://ghost.io/login',              postEp:'/posts/',          verifyEp:'/site/',                             note:'Admin API Key from Integrations Â· JWT signed Â· Full post CRUD' },
  { id:'ghost_sh',      name:'Ghost (Self)',      icon:'ğŸ‘»', da:0,  cat:'Blog/CMS',    auth:['api_key'],             apiBase:'{url}/ghost/api/admin',                       loginUrl:'{url}/ghost',                         postEp:'/posts/',          verifyEp:'/site/',                             note:'Self-hosted Ghost Â· Admin API Key Â· Content API for read-only' },
  { id:'blogger',       name:'Blogger',          icon:'ğŸŸ¡', da:87, cat:'Blog/CMS',    auth:['oauth','api_key'],     apiBase:'https://www.googleapis.com/blogger/v3',       loginUrl:'https://accounts.google.com',         postEp:'/blogs/{blogId}/posts/', verifyEp:'/blogs/{blogId}',               note:'Google OAuth2 Â· Blogger API v3 Â· Blog ID from dashboard URL' },
  { id:'medium',        name:'Medium',           icon:'âš«', da:96, cat:'Blog/CMS',    auth:['api_key'],             apiBase:'https://api.medium.com/v1',                   loginUrl:'https://medium.com/m/signin',         postEp:'/users/me/posts',  verifyEp:'/me',                                note:'Integration Token from Settings Â· Publish to profile or publication' },
  { id:'devto',         name:'Dev.to',           icon:'âš™',  da:79, cat:'Blog/CMS',    auth:['api_key'],             apiBase:'https://dev.to/api',                          loginUrl:'https://dev.to/enter',                postEp:'/articles',        verifyEp:'/articles/me',                       note:'API Key from Settings > Account Â· DEV Community Â· Forem API' },
  { id:'hashnode',      name:'Hashnode',         icon:'ğŸ”·', da:75, cat:'Blog/CMS',    auth:['api_key'],             apiBase:'https://gql.hashnode.com',                    loginUrl:'https://hashnode.com',                postEp:'',                 verifyEp:'',                                   note:'Personal Access Token Â· GraphQL API only Â· publishPost mutation' },
  { id:'tumblr',        name:'Tumblr',           icon:'ğŸ’™', da:84, cat:'Blog/CMS',    auth:['oauth','api_key'],     apiBase:'https://api.tumblr.com/v2',                   loginUrl:'https://www.tumblr.com/login',        postEp:'/blog/{blogId}/posts', verifyEp:'/user/info',                     note:'OAuth 1.0a Â· Consumer key + secret + tokens Â· Tumblr API v2' },
  { id:'substack',      name:'Substack',         icon:'ğŸ“°', da:91, cat:'Blog/CMS',    auth:['cookie','user_pass'],  apiBase:'https://{sub}.substack.com/api/v1',           loginUrl:'https://substack.com/sign-in',        postEp:'/drafts',          verifyEp:'/posts?limit=1',                     note:'Cookie-based only Â· No public API Â· Session cookie from browser' },
  { id:'beehiiv',       name:'Beehiiv',          icon:'ğŸ', da:68, cat:'Blog/CMS',    auth:['api_key'],             apiBase:'https://api.beehiiv.com/v2',                  loginUrl:'https://app.beehiiv.com',             postEp:'/publications/{blogId}/posts', verifyEp:'/publications',             note:'Beehiiv API v2 Â· Bearer token from Settings > API' },
  { id:'drupal',        name:'Drupal',           icon:'ğŸ’§', da:0,  cat:'Blog/CMS',    auth:['api_key','user_pass'], apiBase:'{url}/jsonapi',                               loginUrl:'{url}/user/login',                    postEp:'/node/article',    verifyEp:'/node/article?page[limit]=1',        note:'JSON:API module Â· Basic Auth or OAuth2 Â· Drupal 8+' },
  { id:'joomla',        name:'Joomla',           icon:'ğŸ”¶', da:0,  cat:'Blog/CMS',    auth:['api_key','user_pass'], apiBase:'{url}/api/index.php/v1',                      loginUrl:'{url}/administrator',                 postEp:'/content/articles', verifyEp:'/content/articles',                note:'Joomla 4+ API Â· Super User token from User Manager' },
  // â”€â”€ Site Builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'wix',           name:'Wix',              icon:'â¬œ', da:91, cat:'Builder',     auth:['api_key','cookie'],    apiBase:'https://www.wixapis.com/blog/v3',              loginUrl:'https://users.wix.com/signin',        postEp:'/posts',           verifyEp:'/posts?fieldsets=CONTENT',           note:'Wix Headless API Â· OAuth App or site API key from Business Manager' },
  { id:'weebly',        name:'Weebly',           icon:'ğŸŸ£', da:79, cat:'Builder',     auth:['api_key','user_pass'], apiBase:'https://api.weebly.com/v1',                   loginUrl:'https://www.weebly.com/login',        postEp:'/user/sites/{blogId}/blogs/{blogId}/posts', verifyEp:'/user/sites', note:'Weebly REST API Â· OAuth token Â· Free plan supported' },
  { id:'squarespace',   name:'Squarespace',      icon:'â¬›', da:88, cat:'Builder',     auth:['api_key'],             apiBase:'https://api.squarespace.com/1.0',             loginUrl:'https://account.squarespace.com',     postEp:'/collections/{blogId}/items', verifyEp:'/authorization/website',       note:'Personal Access Token from Settings > Advanced > API Keys' },
  { id:'webflow',       name:'Webflow',          icon:'ğŸŒŠ', da:86, cat:'Builder',     auth:['api_key'],             apiBase:'https://api.webflow.com/v2',                  loginUrl:'https://webflow.com/dashboard',       postEp:'/collections/{blogId}/items', verifyEp:'/sites',                       note:'Webflow Data API v2 Â· CMS Collection item creation' },
  { id:'jimdo',         name:'Jimdo',            icon:'ğŸŸ¢', da:74, cat:'Builder',     auth:['cookie','user_pass'],  apiBase:'https://api.jimdo.com/v1',                    loginUrl:'https://account.jimdo.com',           postEp:'/content',         verifyEp:'/pages',                             note:'Private API Â· Session-based Â· Cookie from logged-in browser session' },
  { id:'strikingly',    name:'Strikingly',       icon:'ğŸŸ¤', da:72, cat:'Builder',     auth:['cookie','user_pass'],  apiBase:'https://www.strikingly.com/api',               loginUrl:'https://www.strikingly.com/s/login',  postEp:'/pages',           verifyEp:'/sites',                             note:'Private API Â· Cookie-based Â· One-page site management' },
  { id:'site123',       name:'Site123',          icon:'ğŸ”¶', da:68, cat:'Builder',     auth:['cookie','user_pass'],  apiBase:'https://www.site123.com/api',                 loginUrl:'https://www.site123.com/login',       postEp:'/pages',           verifyEp:'/sites',                             note:'Session cookie Â· Simple builder Â· Free tier available' },
  { id:'notion',        name:'Notion',           icon:'â¬œ', da:91, cat:'Builder',     auth:['api_key'],             apiBase:'https://api.notion.com/v1',                   loginUrl:'https://notion.so/login',             postEp:'/pages',           verifyEp:'/users/me',                          note:'Integration token from notion.so/my-integrations Â· Page creation' },
  // â”€â”€ Social â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'reddit',        name:'Reddit',           icon:'ğŸŸ ', da:97, cat:'Social',      auth:['oauth','api_key'],     apiBase:'https://oauth.reddit.com',                    loginUrl:'https://www.reddit.com/login',        postEp:'/api/submit',      verifyEp:'/api/v1/me',                         note:'OAuth2 Â· App from reddit.com/prefs/apps Â· Submit posts to subreddits' },
  { id:'linkedin',      name:'LinkedIn',         icon:'ğŸ’¼', da:98, cat:'Social',      auth:['oauth'],               apiBase:'https://api.linkedin.com/v2',                 loginUrl:'https://www.linkedin.com/login',      postEp:'/ugcPosts',        verifyEp:'/me',                                note:'LinkedIn API v2 Â· OAuth 2.0 Â· UGC Posts (articles + shares)' },
  { id:'twitter',       name:'Twitter / X',      icon:'ğŸ¦', da:94, cat:'Social',      auth:['oauth','api_key'],     apiBase:'https://api.twitter.com/2',                   loginUrl:'https://twitter.com/login',           postEp:'/tweets',          verifyEp:'/users/me',                          note:'API v2 Â· Bearer token (read) or OAuth 1.0a (write) Â· Post tweets' },
  { id:'facebook',      name:'Facebook Page',    icon:'ğŸ”·', da:96, cat:'Social',      auth:['oauth','api_key'],     apiBase:'https://graph.facebook.com/v19.0',            loginUrl:'https://facebook.com',                postEp:'/{blogId}/feed',   verifyEp:'/me/accounts',                       note:'Graph API v19 Â· Page Access Token Â· Post to page feed' },
  { id:'instagram',     name:'Instagram',        icon:'ğŸ“¸', da:95, cat:'Social',      auth:['oauth'],               apiBase:'https://graph.instagram.com/v19.0',           loginUrl:'https://www.instagram.com',           postEp:'/{blogId}/media',  verifyEp:'/me',                                note:'Instagram Basic Display or Business API Â· OAuth 2.0' },
  { id:'pinterest',     name:'Pinterest',        icon:'ğŸ“Œ', da:94, cat:'Social',      auth:['oauth','api_key'],     apiBase:'https://api.pinterest.com/v5',                loginUrl:'https://pinterest.com/login',         postEp:'/pins',            verifyEp:'/user_account',                      note:'Pinterest API v5 Â· OAuth 2.0 Â· Create pins on boards' },
  { id:'quora',         name:'Quora',            icon:'ğŸ”´', da:93, cat:'Social',      auth:['cookie'],              apiBase:'https://www.quora.com',                       loginUrl:'https://www.quora.com/login',         postEp:'/add_question',    verifyEp:'/',                                  note:'Cookie-based only Â· No public API Â· Log in to use browser panel' },
  // â”€â”€ Dev Platforms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'github',        name:'GitHub Pages',     icon:'ğŸ™', da:96, cat:'Dev',         auth:['api_key'],             apiBase:'https://api.github.com',                      loginUrl:'https://github.com/login',            postEp:'/repos/{blogId}/contents/', verifyEp:'/user',              note:'Personal Access Token Â· Create/update files in repo Â· gh-pages branch' },
  { id:'gitlab',        name:'GitLab Pages',     icon:'ğŸ¦Š', da:90, cat:'Dev',         auth:['api_key'],             apiBase:'https://gitlab.com/api/v4',                   loginUrl:'https://gitlab.com/users/sign_in',    postEp:'/projects/{blogId}/repository/files/', verifyEp:'/user',  note:'PAT from User Settings > Access Tokens Â· Push files to pages branch' },
  // â”€â”€ Document Platforms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'archive_org',   name:'Internet Archive', icon:'ğŸ›',  da:94, cat:'Document',   auth:['api_key','user_pass'], apiBase:'https://s3.us.archive.org',                   loginUrl:'https://archive.org/account/login',   postEp:'/{blogId}/',       verifyEp:'https://archive.org/upload/',        note:'S3 API Â· Access key = username, Secret = API key Â· Permanent URLs' },
  { id:'scribd',        name:'Scribd',           icon:'ğŸ“š', da:96, cat:'Document',    auth:['user_pass','cookie'],  apiBase:'https://www.scribd.com',                      loginUrl:'https://www.scribd.com/login',        postEp:'/upload-document', verifyEp:'/upload-document',                   note:'Form POST Â· PDF/DOC upload Â· Login session required Â· DA96' },
  { id:'slideshare',    name:'SlideShare',       icon:'ğŸ“Š', da:95, cat:'Document',    auth:['user_pass','cookie'],  apiBase:'https://www.slideshare.net',                  loginUrl:'https://www.slideshare.net/login',    postEp:'/upload',          verifyEp:'/upload',                            note:'Form POST Â· Slide/PDF upload Â· LinkedIn-owned Â· DA95' },
  { id:'academia',      name:'Academia.edu',     icon:'ğŸ“', da:93, cat:'Document',    auth:['user_pass','cookie'],  apiBase:'https://www.academia.edu',                    loginUrl:'https://www.academia.edu/login',      postEp:'/upload',          verifyEp:'/upload',                            note:'Research paper uploads Â· DA93 Â· Academic trust signal' },
  // â”€â”€ Misc / Custom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'airtable',      name:'Airtable',         icon:'ğŸŸ¢', da:85, cat:'Misc',        auth:['api_key'],             apiBase:'https://api.airtable.com/v0',                 loginUrl:'https://airtable.com/login',          postEp:'/{blogId}/{url}',  verifyEp:'/meta/bases',                        note:'Personal Access Token Â· Create records in any base/table' },
  { id:'contentful',    name:'Contentful',       icon:'ğŸŸ¦', da:81, cat:'Misc',        auth:['api_key'],             apiBase:'https://api.contentful.com',                  loginUrl:'https://be.contentful.com/login',     postEp:'/spaces/{blogId}/entries', verifyEp:'/spaces',                  note:'Content Management API Token Â· Create entries in Space' },
  { id:'other',         name:'Custom Platform',  icon:'ğŸŒ', da:0,  cat:'Custom',      auth:['api_key','user_pass','oauth','cookie'], apiBase:'{url}', loginUrl:'{url}', postEp:'/', verifyEp:'/',               note:'Any platform Â· Set base URL Â· Configure auth and endpoints manually' },
];

const LM_AUTH = {
  api_key:   { label:'API Key / Token',       icon:'ğŸ”‘' },
  user_pass: { label:'Username + Password',   icon:'ğŸ”' },
  oauth:     { label:'OAuth Token',           icon:'ğŸ”“' },
  cookie:    { label:'Cookie / Session',      icon:'ğŸª' },
};

const LM_TIERS = [
  { id:'tier1', label:'Tier 1 â€” Money / Parasite', badge:'badge-g' },
  { id:'tier2', label:'Tier 2 â€” Supporting Web 2.0', badge:'badge-b' },
  { id:'tier3', label:'Tier 3 â€” Buffer / Filler',    badge:'badge-y' },
];

const LM_STATUS = {
  active:      { label:'ACTIVE',       badge:'badge-g' },
  unverified:  { label:'UNVERIFIED',   badge:'badge-y' },
  checking:    { label:'CHECKINGâ€¦',    badge:'badge-b' },
  error:       { label:'ERROR',        badge:'badge-r' },
  auth_failed: { label:'AUTH FAIL',    badge:'badge-r' },
  unreachable: { label:'UNREACHABLE',  badge:'badge-r' },
  inactive:    { label:'INACTIVE',     badge:'tm' },
};

const LM_STATE = {
  sites:   JSON.parse(localStorage.getItem('lm_sites')||'[]'),
  sel:     new Set(),
  filter:  { cat:'', tier:'', status:'', search:'' },
  sortBy:  'addedAt',
  sortDir: 'desc',
  busy:    false,
  openId:  null,
};

function lmSave(){ try{ localStorage.setItem('lm_sites', JSON.stringify(LM_STATE.sites)); }catch(e){} }
function lmP(id){ return LM_PLATFORMS.find(p=>p.id===id)||LM_PLATFORMS[LM_PLATFORMS.length-1]; }

// â”€â”€â”€ LOGGING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmLog(msg, cls='t-info'){
  const t=document.getElementById('lm-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

// â”€â”€â”€ ADD SITE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmAdd(){
  const pid      = document.getElementById('lm-add-plat')?.value||'wordpress_com';
  const siteUrl  = (document.getElementById('lm-add-url')?.value||'').trim();
  const label    = (document.getElementById('lm-add-label')?.value||'').trim();
  const auth     = document.getElementById('lm-add-auth')?.value||'api_key';
  const niche    = (document.getElementById('lm-add-niche')?.value||'').trim();
  const tier     = document.getElementById('lm-add-tier')?.value||'tier2';
  const blogId   = (document.getElementById('lm-add-blogid')?.value||'').trim();
  const targetUrl= (document.getElementById('lm-add-target')?.value||'').trim();
  const kws      = (document.getElementById('lm-add-kws')?.value||'').split('\n').map(k=>k.trim()).filter(Boolean);
  const notes    = (document.getElementById('lm-add-notes')?.value||'').trim();
  const apiKey   = (document.getElementById('lm-c-apikey')?.value||'').trim();
  const user     = (document.getElementById('lm-c-user')?.value||'').trim();
  const pass     = (document.getElementById('lm-c-pass')?.value||'').trim();
  const token    = (document.getElementById('lm-c-token')?.value||'').trim();
  const cookie   = (document.getElementById('lm-c-cookie')?.value||'').trim();

  if(!siteUrl){ lmLog('âš  Site URL is required','t-warn'); return; }

  const p = lmP(pid);
  const site = {
    id:uid(), addedAt:Date.now(), addedFrom:'manual',
    pid, label: label||(p.name+' Site'), siteUrl,
    auth, creds:{ apiKey, user, pass, token, cookie },
    niche, tier, blogId, targetUrl, kws, notes,
    da:p.da, status:'unverified',
    verified:null, posted:null, posts:0, history:[],
  };
  LM_STATE.sites.unshift(site);
  lmSave(); lmRenderTable();
  lmLog(`âœ” Added: ${site.label} â€” ${site.siteUrl}`,'t-info');

  // Clear form
  ['lm-add-url','lm-add-label','lm-add-niche','lm-add-blogid','lm-add-target','lm-add-kws','lm-add-notes','lm-c-apikey','lm-c-user','lm-c-pass','lm-c-token','lm-c-cookie'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
}

function lmDelete(id){
  if(!confirm('Delete this site from the registry?')) return;
  LM_STATE.sites=LM_STATE.sites.filter(s=>s.id!==id);
  LM_STATE.sel.delete(id);
  if(LM_STATE.openId===id){ LM_STATE.openId=null; lmRenderBrowser(); }
  lmSave(); lmRenderTable();
  lmLog(`Deleted site ${id}`,'tm');
}

function lmDeleteSelected(){
  if(!LM_STATE.sel.size) return;
  if(!confirm(`Delete ${LM_STATE.sel.size} selected site(s)?`)) return;
  LM_STATE.sel.forEach(id=>{ LM_STATE.sites=LM_STATE.sites.filter(s=>s.id!==id); });
  LM_STATE.sel.clear(); lmSave(); lmRenderTable();
}

// â”€â”€â”€ IMPORT FROM OTHER MODULES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmImportW2B(){
  const src=(typeof W2B_STATE!=='undefined'?W2B_STATE.sites:[]).filter(s=>s.status==='live'&&s.siteUrl&&s.siteUrl!=='â€”');
  if(!src.length){ lmLog('âš  No live sites in Web 2.0 Builder','t-warn'); return; }
  let n=0;
  for(const ws of src){
    if(LM_STATE.sites.find(s=>s.siteUrl===ws.siteUrl)) continue;
    const mp=LM_PLATFORMS.find(p=>p.name===ws.platform)||LM_PLATFORMS[LM_PLATFORMS.length-1];
    LM_STATE.sites.unshift({ id:uid(), addedAt:Date.now(), addedFrom:'web2_builder',
      pid:mp.id, label:ws.kw||ws.platform, siteUrl:ws.siteUrl,
      auth:'api_key', creds:{}, niche:'', tier:'tier2', blogId:'',
      targetUrl:ws.targetUrl||'', kws:ws.kw?[ws.kw]:[], notes:'From Web 2.0 Builder',
      da:ws.da||0, status:'unverified', verified:null, posted:null, posts:0, history:[] });
    n++;
  }
  lmSave(); lmRenderTable();
  lmLog(`âœ” Imported ${n} site(s) from Web 2.0 Builder`,'t-info');
}

function lmImportSessions(){
  const src=(typeof CSM_STATE!=='undefined'?CSM_STATE.sessions:[]).filter(s=>s.status==='active');
  if(!src.length){ lmLog('âš  No active sessions in Session Manager','t-warn'); return; }
  let n=0;
  for(const ss of src){
    const mp=LM_PLATFORMS.find(p=>p.name===ss.platform||p.id===ss.platform)||LM_PLATFORMS[LM_PLATFORMS.length-1];
    LM_STATE.sites.unshift({ id:uid(), addedAt:Date.now(), addedFrom:'session_manager',
      pid:mp.id, label:(ss.platform||'Unknown')+' / '+ss.username, siteUrl:'https://'+(ss.platform||'site').toLowerCase().replace(/\s/g,'')+'.com',
      auth:'cookie', creds:{ cookie:ss.cookieStr||'' }, niche:'', tier:'tier2', blogId:'',
      targetUrl:'', kws:[], notes:'From Session Manager',
      da:mp.da||0, status:'unverified', verified:null, posted:null, posts:0, history:[] });
    n++;
  }
  lmSave(); lmRenderTable();
  lmLog(`âœ” Imported ${n} session(s) from Session Manager`,'t-info');
}

function lmImportCSV(){
  const raw=(document.getElementById('lm-csv-raw')?.value||'').trim();
  if(!raw){ lmLog('âš  Paste CSV data first','t-warn'); return; }
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  let n=0;
  for(const line of lines.slice(1)){
    try{
      const cols=line.match(/(".*?"|[^,]+)/g)||[];
      const clean=cols.map(c=>c.replace(/^"|"$/g,'').trim());
      const [siteUrl,platform,label,apiKey,user,pass,niche,tier,targetUrl]=[...clean,...Array(9).fill('')];
      if(!siteUrl||!siteUrl.startsWith('http')) continue;
      const mp=LM_PLATFORMS.find(p=>p.name===platform||p.id===platform)||LM_PLATFORMS[LM_PLATFORMS.length-1];
      LM_STATE.sites.unshift({ id:uid(), addedAt:Date.now(), addedFrom:'csv',
        pid:mp.id, label:label||siteUrl, siteUrl,
        auth:apiKey?'api_key':'user_pass', creds:{ apiKey:apiKey||'', user:user||'', pass:pass||'' },
        niche:niche||'', tier:tier||'tier2', blogId:'', targetUrl:targetUrl||'', kws:[], notes:'CSV import',
        da:mp.da||0, status:'unverified', verified:null, posted:null, posts:0, history:[] });
      n++;
    }catch(e){}
  }
  lmSave(); lmRenderTable();
  lmLog(`âœ” Imported ${n} site(s) from CSV`,'t-info');
}

// â”€â”€â”€ HEALTH CHECKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmAuthHeaders(site){
  const h={'Content-Type':'application/json','Accept':'application/json'};
  const c=site.creds||{};
  if(site.auth==='api_key'&&c.apiKey)       h['Authorization']='Bearer '+c.apiKey;
  else if(site.auth==='user_pass'&&c.user)  h['Authorization']='Basic '+btoa(c.user+':'+c.pass);
  else if(site.auth==='oauth'&&c.token)     h['Authorization']='Bearer '+c.token;
  else if(site.auth==='cookie'&&c.cookie)   h['Cookie']=c.cookie;
  return h;
}

async function lmVerify(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  s.status='checking'; lmRenderRow(id);
  lmLog(`â†’ Verifying ${s.label} â€¦`,'t-accent');

  const p=lmP(s.pid);
  let base=p.apiBase.replace('{url}',s.siteUrl).replace('{sub}',s.siteUrl.replace(/^https?:\/\//,'').split('.')[0]);
  let ep=p.verifyEp||'/';
  ep=ep.replace('{blogId}',s.blogId||'').replace('{url}',s.siteUrl).replace(/{.*?}/g,'');
  const fullUrl=ep.startsWith('http')?ep:base+ep;
  const hdrs=lmAuthHeaders(s);
  let ok=false, code=0, ms=0;
  const t0=Date.now();
  try{
    const r=await smartFetch(fullUrl,{method:'GET',headers:hdrs,sfTimeout:10000});
    code=r.status; ms=Date.now()-t0;
    ok=r.ok;
  }catch(e){ ok=false; }
  s.status=ok?'active':code===401||code===403?'auth_failed':code>0?'error':'unreachable';
  s.verified=new Date().toLocaleTimeString(); s.code=code; s.ms=ms;
  lmSave(); lmRenderRow(id);
  lmLog(`  ${ok?'âœ”':'âœ—'} ${s.label} â€” ${s.status}${code?' (HTTP '+code+')':''} ${ms?ms+'ms':''}`, ok?'t-info':'t-warn');
}

async function lmVerifyAll(){
  if(LM_STATE.busy) return;
  const list=lmFiltered();
  if(!list.length){ lmLog('âš  No sites to verify','t-warn'); return; }
  LM_STATE.busy=true;
  const btn=document.getElementById('lm-btn-verify-all'); if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Verifyingâ€¦'; }
  lmLog(`â†’ Verifying ${list.length} site(s)â€¦`,'t-accent');
  for(const s of list){ await lmVerify(s.id); await sleep(150); }
  lmLog(`âœ” Verification complete`,'t-info');
  LM_STATE.busy=false;
  if(btn){ btn.disabled=false; btn.innerHTML='ğŸ” Verify All'; }
}

async function lmVerifySelected(){
  for(const id of [...LM_STATE.sel]){ await lmVerify(id); await sleep(120); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM-SPECIFIC POST BUILDER â€” UNIVERSAL ACTION ENGINE
// Works on ANY site: known platform, unknown platform, or custom
// Auth: API key Â· Bearer Â· Basic Â· OAuth Â· Cookie Â· Custom Header
// Niche focus: Video Â· Entertainment Â· Celebrities Â· Live Streams
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ CONTENT TEMPLATES (Entertainment / Video / Celebrity niche) â”€
const LM_TEMPLATES = {
  video_review: {
    label:'ğŸ¬ Video Review',
    desc:'Best for YouTube videos, Netflix shows, film reviews â€” high CTR in entertainment SERPs',
    build:(kw,target,yr)=>{
      const t=kw.charAt(0).toUpperCase()+kw.slice(1);
      return {
        title:`${t} Review ${yr} â€” Is It Worth Watching?`,
        html:`<h1>${t} Review ${yr} â€” Is It Worth Watching?</h1>
<p>If you've been wondering about <strong>${kw}</strong>, this honest ${yr} review covers everything you need to know before you hit play.</p>
<h2>Quick Verdict</h2>
<p>Short answer: yes. Here's why the buzz around <strong>${kw}</strong> is fully justified in ${yr}.</p>
<h2>What Makes It Stand Out</h2>
<p>Unlike most content in this space, <strong>${kw}</strong> delivers on multiple levels â€” production quality, storyline depth, and replay value that's rare to find.</p>
<h2>Who Is This For?</h2>
<p>Perfect for fans of [similar genre]. If you already follow the creator or franchise, <strong>${kw}</strong> will not disappoint.</p>
<h2>Performance & Numbers</h2>
<p>Within 48 hours of dropping, <strong>${kw}</strong> topped trending lists across platforms â€” a clear signal that the audience appetite here is massive.</p>
<h2>Final Rating: 9/10</h2>
<p>Stream it, share it, and bookmark it. <strong>${kw}</strong> is one of the standout releases of ${yr}.</p>
${target?`<p><strong>â†’ <a href="${target}">Watch ${t} Here</a></strong></p>`:''}`,
        md:`# ${t} Review ${yr} â€” Is It Worth Watching?\n\n**Quick Verdict:** Yes â€” here's why the buzz around **${kw}** is fully justified in ${yr}.\n\n## What Makes It Stand Out\nUnlike most content in this space, **${kw}** delivers on multiple levels â€” production quality, storyline depth, and replay value.\n\n## Final Rating: 9/10\n${target?`\nâ†’ [Watch ${t} Here](${target})`:''}`,
        tags:['review',kw.replace(/\s+/g,''),yr,'entertainment','streaming'],
      };
    }
  },
  celebrity_news: {
    label:'â­ Celebrity News / Update',
    desc:'Breaking updates, net worth posts, relationship news â€” massive search volume in celeb niches',
    build:(kw,target,yr)=>{
      const t=kw.charAt(0).toUpperCase()+kw.slice(1);
      return {
        title:`${t} â€” Latest News, Updates & What's Happening in ${yr}`,
        html:`<h1>${t} â€” Latest News &amp; What's Happening in ${yr}</h1>
<p>Everything you need to know about <strong>${kw}</strong> right now â€” from latest updates to what the buzz is really about in ${yr}.</p>
<h2>What's New with ${t}</h2>
<p>The latest developments around <strong>${kw}</strong> have sent fans into a frenzy. Here's a breakdown of what we know so far.</p>
<h2>Background: Who / What Is ${t}?</h2>
<p><strong>${kw}</strong> has been a dominant force in the entertainment landscape â€” consistently topping trend charts and commanding massive audience engagement across social platforms.</p>
<h2>Fan Reaction</h2>
<p>Social media erupted the moment news about <strong>${kw}</strong> broke. Twitter, TikTok, and Reddit threads are packed with takes from superfans and casual viewers alike.</p>
<h2>What Happens Next</h2>
<p>Sources close to the situation suggest more announcements around <strong>${kw}</strong> are coming. Stay tuned.</p>
${target?`<p><strong>â†’ <a href="${target}">Full Coverage & Updates on ${t}</a></strong></p>`:''}`,
        md:`# ${t} â€” Latest News & Updates ${yr}\n\nEverything happening with **${kw}** right now.\n\n## What's New\nThe latest on **${kw}** has fans buzzing across every platform.\n\n## Fan Reaction\nTwitter, TikTok, and Reddit are packed with takes.\n${target?`\nâ†’ [Full Coverage & Updates](${target})`:''}`,
        tags:['celebrity',kw.replace(/\s+/g,''),'news',yr,'entertainment'],
      };
    }
  },
  livestream_guide: {
    label:'ğŸ“º Live Stream Guide',
    desc:'Where to watch, how to stream â€” converts well for Twitch, YouTube Live, sports streams',
    build:(kw,target,yr)=>{
      const t=kw.charAt(0).toUpperCase()+kw.slice(1);
      return {
        title:`How to Watch ${t} Live Stream Free in ${yr} â€” Full Guide`,
        html:`<h1>How to Watch ${t} Live Stream Free in ${yr}</h1>
<p>Looking for the best way to catch <strong>${kw}</strong> live? This guide covers every option available in ${yr} â€” free, legal, and easy.</p>
<h2>Where to Watch ${t} Live</h2>
<p>The easiest options for streaming <strong>${kw}</strong> live right now include official channels, authorised streaming partners, and platforms where the broadcast will air live.</p>
<h2>Free Viewing Options</h2>
<p>Yes â€” you can watch <strong>${kw}</strong> without paying. Several platforms offer free live access, and we've listed the best ones below in order of reliability.</p>
<h2>Device Compatibility</h2>
<p>Whether you're on mobile, desktop, smart TV, or tablet, catching <strong>${kw}</strong> live is straightforward across all devices.</p>
<h2>Start Time & Schedule</h2>
<p>Don't miss a second of <strong>${kw}</strong>. We've broken down the exact schedule and start times across all major time zones.</p>
<h2>Tips for Best Stream Quality</h2>
<ul><li>Use a wired connection if possible</li><li>Close background apps</li><li>Choose 1080p or the highest available quality</li><li>Refresh once if the stream buffers at the start</li></ul>
${target?`<p><strong>â†’ <a href="${target}">Watch ${t} Live Here â€” Best Link</a></strong></p>`:''}`,
        md:`# How to Watch ${t} Live Stream Free in ${yr}\n\nBest options to catch **${kw}** live in ${yr}.\n\n## Free Options\nSeveral platforms offer free access â€” listed in order of reliability.\n\n## Tips for Best Quality\n- Wired connection if possible\n- Close background apps\n- Refresh once if stream buffers\n${target?`\nâ†’ [Watch ${t} Live Here](${target})`:''}`,
        tags:['livestream','howtowatch',kw.replace(/\s+/g,''),yr,'streaming'],
      };
    }
  },
  top_list: {
    label:'ğŸ† Top List / Ranking',
    desc:'Top 10 lists, rankings, best-of posts â€” excellent for Pinterest, Tumblr, entertainment blogs',
    build:(kw,target,yr)=>{
      const t=kw.charAt(0).toUpperCase()+kw.slice(1);
      return {
        title:`Top 10 ${t} of ${yr} â€” Ranked & Reviewed`,
        html:`<h1>Top 10 ${t} of ${yr} â€” Ranked &amp; Reviewed</h1>
<p>We've ranked the best <strong>${kw}</strong> content of ${yr} so you don't have to scroll endlessly. Here's the definitive list.</p>
<h2>#1 â€” The Clear Leader</h2><p>The top spot for <strong>${kw}</strong> in ${yr} goes to the entry that dominated engagement metrics, fan votes, and critic consensus across the board.</p>
<h2>#2 â€” Close Runner-Up</h2><p>Not far behind â€” this entry in the <strong>${kw}</strong> category earns its place on merit alone. A must-see or must-follow.</p>
<h2>#3 â€” Best Surprise of the Year</h2><p>Nobody saw this coming. A breakout performer in the <strong>${kw}</strong> space that outperformed all expectations.</p>
<h2>#4â€“#7 â€” Solid Picks</h2><p>These four round out the upper tier of <strong>${kw}</strong> content â€” each with a unique value proposition for different audience types.</p>
<h2>#8â€“#10 â€” Honourable Mentions</h2><p>Didn't quite make the top 7, but each of these <strong>${kw}</strong> entries is worth your time depending on personal taste.</p>
${target?`<p><strong>â†’ <a href="${target}">See the Full Ranked List for ${t}</a></strong></p>`:''}`,
        md:`# Top 10 ${t} of ${yr} â€” Ranked & Reviewed\n\nThe definitive **${kw}** ranking for ${yr}.\n\n**#1** â€” Clear leader. **#2** â€” Close runner-up. **#3** â€” Best surprise.\n\n**#4â€“#7** â€” Solid picks. **#8â€“#10** â€” Honourable mentions.\n${target?`\nâ†’ [Full Ranked List](${target})`:''}`,
        tags:['top10','ranking',kw.replace(/\s+/g,''),yr,'entertainment'],
      };
    }
  },
  event_preview: {
    label:'ğŸ“… Event Preview / Hype',
    desc:'Award shows, concerts, game nights, premieres â€” massive traffic spikes around live events',
    build:(kw,target,yr)=>{
      const t=kw.charAt(0).toUpperCase()+kw.slice(1);
      return {
        title:`${t} ${yr} â€” Everything You Need to Know Before It Happens`,
        html:`<h1>${t} ${yr} â€” Everything You Need to Know</h1>
<p>The buildup to <strong>${kw}</strong> is electric. Here's the complete breakdown â€” dates, performers, predictions, and how to watch.</p>
<h2>When & Where</h2><p><strong>${kw}</strong> is one of the most anticipated events of ${yr}. Mark your calendar â€” this one is not to be missed live.</p>
<h2>Who's Involved</h2><p>The lineup for <strong>${kw}</strong> reads like a who's-who of the entertainment world. Names confirmed so far have set fan communities on fire.</p>
<h2>What to Expect</h2><p>Based on what we know, <strong>${kw}</strong> is shaping up to be bigger than last year â€” with production values and surprises that are being kept tightly under wraps.</p>
<h2>Our Predictions</h2><p>Here are our top calls for <strong>${kw}</strong> â€” who takes home the prize, who steals the show, and what moment will break the internet.</p>
<h2>How to Watch Live</h2><p>Multiple broadcast and streaming options are confirmed for <strong>${kw}</strong>. We've listed the best ways to watch based on your region.</p>
${target?`<p><strong>â†’ <a href="${target}">Full ${t} Event Guide & Watch Links</a></strong></p>`:''}`,
        md:`# ${t} ${yr} â€” Everything You Need to Know\n\nComplete preview of **${kw}** â€” dates, lineup, predictions, how to watch.\n\n## Our Predictions\nTop calls for **${kw}** â€” who wins, who steals the show, what breaks the internet.\n${target?`\nâ†’ [Full Event Guide & Watch Links](${target})`:''}`,
        tags:['event','preview',kw.replace(/\s+/g,''),yr,'awards','live'],
      };
    }
  },
  seo_article: {
    label:'ğŸ“ SEO Article (Generic)',
    desc:'General-purpose keyword-optimised article â€” works on any niche or platform',
    build:(kw,target,yr)=>{
      const t=kw.charAt(0).toUpperCase()+kw.slice(1);
      return {
        title:`${t} â€” Complete Guide for ${yr}`,
        html:`<h1>${t} â€” Complete Guide for ${yr}</h1>
<p>Everything you need to know about <strong>${kw}</strong> in ${yr} â€” from the basics to advanced insights.</p>
<h2>What Is ${t}?</h2><p><strong>${kw}</strong> has been a growing topic of interest, and for good reason. This guide breaks it all down clearly.</p>
<h2>Why It Matters in ${yr}</h2><p>The relevance of <strong>${kw}</strong> has never been higher. Here's what's driving the interest and why it matters to you.</p>
<h2>Key Things to Know</h2><p>Before diving deeper, here are the most important facts about <strong>${kw}</strong> that everyone should understand.</p>
<h2>How to Get Started</h2><p>Getting started with <strong>${kw}</strong> is simpler than most people expect. Follow these steps for the best results.</p>
<h2>Common Questions</h2><p>We've answered the most frequent questions people have about <strong>${kw}</strong> so you can move forward with confidence.</p>
${target?`<p><strong>â†’ <a href="${target}">Learn More About ${t}</a></strong></p>`:''}`,
        md:`# ${t} â€” Complete Guide for ${yr}\n\nEverything about **${kw}** in ${yr}.\n\n## Why It Matters\n**${kw}** is growing in relevance. Here's the full picture.\n\n## Get Started\nSimpler than you think. Follow the steps and move fast.\n${target?`\nâ†’ [Learn More](${target})`:''}`,
        tags:[kw.replace(/\s+/g,''),yr,'guide','howto'],
      };
    }
  },
};

// â”€â”€â”€ PLATFORM-SPECIFIC API POST BUILDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each builder knows exactly what payload shape the platform expects.
// Falls back to universal builder if platform unrecognised.

const LM_POST_BUILDERS = {

  // WordPress REST API (both .com and self-hosted)
  wordpress_com: async(s,content,hdrs)=>{
    const base=lmP(s.pid).apiBase.replace('{url}',s.siteUrl).replace('{sub}',s.siteUrl.replace(/^https?:\/\//,'').split('.')[0]);
    const ep=`${base}/posts`;
    return await lmApiPost(ep,{title:content.title,content:content.html,status:'publish',format:'standard',categories:[],tags:content.tags||[]},hdrs);
  },
  wordpress_sh: async(s,content,hdrs)=>{
    const ep=`${s.siteUrl.replace(/\/$/,'')}/wp-json/wp/v2/posts`;
    return await lmApiPost(ep,{title:content.title,content:content.html,status:'publish',slug:content.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,60),tags:[]},hdrs);
  },

  // Ghost Admin API â€” requires JWT, constructs post as mobiledoc or lexical
  ghost_io: async(s,content,hdrs)=>{
    const sub=s.siteUrl.replace(/^https?:\/\//,'').split('.')[0];
    const ep=`https://${sub}.ghost.io/ghost/api/admin/posts/`;
    const payload={posts:[{title:content.title,html:content.html,status:'published',tags:content.tags?.map(t=>({name:t}))||[]}]};
    return await lmApiPost(ep,payload,hdrs,'posts');
  },
  ghost_sh: async(s,content,hdrs)=>{
    const ep=`${s.siteUrl.replace(/\/$/,'')}/ghost/api/admin/posts/`;
    return await lmApiPost(ep,{posts:[{title:content.title,html:content.html,status:'published',tags:content.tags?.map(t=>({name:t}))||[]}]},hdrs,'posts');
  },

  // Medium Integration Token
  medium: async(s,content,hdrs)=>{
    // First get user ID
    let userId='me';
    try{ const r=await smartFetch('https://api.medium.com/v1/me',{method:'GET',headers:hdrs,sfTimeout:8000}); const d=await r.json(); userId=d?.data?.id||'me'; }catch(e){}
    return await lmApiPost(`https://api.medium.com/v1/users/${userId}/posts`,{title:content.title,contentFormat:'html',content:content.html,tags:content.tags?.slice(0,5)||[],publishStatus:'public'},hdrs);
  },

  // Dev.to (Forem)
  devto: async(s,content,hdrs)=>{
    return await lmApiPost('https://dev.to/api/articles',{article:{title:content.title,body_markdown:content.md||content.html,tags:content.tags?.slice(0,4)||[],published:true}},hdrs);
  },

  // Hashnode GraphQL
  hashnode: async(s,content,hdrs)=>{
    const mutation=`mutation{createDraft(input:{title:${JSON.stringify(content.title)},contentMarkdown:${JSON.stringify(content.md||content.html)},tags:[]}){post{url}}}`;
    return await lmApiPost('https://gql.hashnode.com','',hdrs,'',{query:mutation});
  },

  // Tumblr â€” OAuth1 required, sends as NPF text block
  tumblr: async(s,content,hdrs)=>{
    const blog=s.blogId||s.siteUrl.replace(/^https?:\/\//,'').split('.')[0]+'.tumblr.com';
    return await lmApiPost(`https://api.tumblr.com/v2/blog/${blog}/posts`,{content:[{type:'text',text:content.title+'\n\n'+content.html}],tags:content.tags||[]},hdrs);
  },

  // Blogger v3 â€” needs Google OAuth, uses blog ID
  blogger: async(s,content,hdrs)=>{
    const bid=s.blogId; if(!bid) return {ok:false,msg:'Blog ID required for Blogger â€” add it in site settings'};
    return await lmApiPost(`https://www.googleapis.com/blogger/v3/blogs/${bid}/posts/`,{kind:'blogger#post',title:content.title,content:content.html},hdrs);
  },

  // Beehiiv
  beehiiv: async(s,content,hdrs)=>{
    const pid=s.blogId; if(!pid) return {ok:false,msg:'Publication ID required for Beehiiv'};
    return await lmApiPost(`https://api.beehiiv.com/v2/publications/${pid}/posts`,{title:content.title,subtitle:'',content:{type:'html',value:content.html},status:'confirmed'},hdrs);
  },

  // Webflow CMS
  webflow: async(s,content,hdrs)=>{
    const cid=s.blogId; if(!cid) return {ok:false,msg:'Collection ID required for Webflow'};
    return await lmApiPost(`https://api.webflow.com/v2/collections/${cid}/items/live`,{fieldData:{name:content.title,'post-body':content.html,slug:content.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,60)}},hdrs);
  },

  // Notion
  notion: async(s,content,hdrs)=>{
    const did=s.blogId;
    const payload={parent:did?{database_id:did}:{page_id:did||''},properties:{title:{title:[{text:{content:content.title}}]}},children:[{object:'block',type:'paragraph',paragraph:{rich_text:[{text:{content:content.html.replace(/<[^>]*>/g,'').slice(0,2000)}}]}}]};
    hdrs['Notion-Version']='2022-06-28';
    return await lmApiPost('https://api.notion.com/v1/pages',payload,hdrs);
  },

  // Reddit
  reddit: async(s,content,hdrs)=>{
    const sr=s.blogId||'test';
    return await lmApiPost('https://oauth.reddit.com/api/submit',{sr,kind:'self',title:content.title,text:content.md||content.html.replace(/<[^>]*>/g,''),resubmit:true,nsfw:false,spoiler:false},hdrs);
  },

  // GitHub â€” creates a markdown file in the repo
  github: async(s,content,hdrs)=>{
    const repo=s.blogId; if(!repo) return {ok:false,msg:'Repo (owner/repo) required for GitHub'};
    const slug=content.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,60);
    const fileContent=btoa(unescape(encodeURIComponent(`---\ntitle: "${content.title}"\ndate: ${new Date().toISOString().split('T')[0]}\ntags: [${(content.tags||[]).map(t=>'"'+t+'"').join(',')}]\n---\n\n${content.md||content.html.replace(/<[^>]*>/g,'')}`)));
    return await lmApiPost(`https://api.github.com/repos/${repo}/contents/${slug}.md`,{message:`Add post: ${content.title}`,content:fileContent},hdrs);
  },

  // Drupal JSON:API
  drupal: async(s,content,hdrs)=>{
    hdrs['Content-Type']='application/vnd.api+json';
    hdrs['Accept']='application/vnd.api+json';
    return await lmApiPost(`${s.siteUrl.replace(/\/$/,'')}/jsonapi/node/article`,{data:{type:'node--article',attributes:{title:content.title,body:{value:content.html,format:'full_html'}}}},hdrs);
  },

  // Joomla 4+ API
  joomla: async(s,content,hdrs)=>{
    return await lmApiPost(`${s.siteUrl.replace(/\/$/,'')}/api/index.php/v1/content/articles`,{title:content.title,alias:content.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,60),articletext:content.html,state:1,access:1,catid:2},hdrs);
  },

  // GitLab Pages â€” commits a file
  gitlab: async(s,content,hdrs)=>{
    const projId=s.blogId; if(!projId) return {ok:false,msg:'Project ID required for GitLab'};
    const slug=content.title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,60);
    const fileContent=btoa(unescape(encodeURIComponent(`---\ntitle: "${content.title}"\ndate: ${new Date().toISOString()}\ntags: [${(content.tags||[]).join(',')}]\n---\n\n${content.md||''}`)));
    return await lmApiPost(`https://gitlab.com/api/v4/projects/${projId}/repository/files/${slug}.md`,{branch:'main',commit_message:`Add: ${content.title}`,content:fileContent},hdrs);
  },
};

// â”€â”€â”€ UNIVERSAL POST ENGINE (unknown/custom platforms) â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Strategy cascade: tries 8 different approaches automatically
const LM_UNIVERSAL_STRATEGIES = [
  {
    id:'rest_json',
    label:'REST JSON POST',
    desc:'Try standard JSON POST to common REST endpoints',
    run:async(s,content,hdrs,cfg)=>{
      const base=s.siteUrl.replace(/\/$/,'');
      const customEp=cfg.customEndpoint;
      const endpoints=customEp?[customEp]:[
        `${base}/wp-json/wp/v2/posts`,
        `${base}/api/v1/posts`,`${base}/api/posts`,`${base}/posts`,
        `${base}/ghost/api/admin/posts/`,
        `${base}/jsonapi/node/article`,
        `${base}/api/index.php/v1/content/articles`,
      ];
      const bodies=[
        {title:content.title,content:content.html,status:'publish'},
        {title:content.title,body:content.html,published:true},
        {posts:[{title:content.title,html:content.html,status:'published'}]},
        {article:{title:content.title,body_markdown:content.md||content.html,published:true}},
      ];
      for(const ep of endpoints){
        for(const body of bodies){
          try{
            const r=await smartFetch(ep,{method:'POST',headers:hdrs,body:JSON.stringify(body),sfTimeout:8000});
            if(r.ok||r.status===201){
              const d=await r.json().catch(()=>({}));
              return {ok:true,url:d.url||d.link||d.permalink||d.html_url||d.public_url||ep,strategy:'REST JSON POST',endpoint:ep};
            }
          }catch(e){}
        }
      }
      return {ok:false};
    }
  },
  {
    id:'form_post',
    label:'Form POST (multipart)',
    desc:'Submit as HTML form â€” works on many CMS and blog platforms without APIs',
    run:async(s,content,hdrs,cfg)=>{
      const base=s.siteUrl.replace(/\/$/,'');
      const ep=cfg.customEndpoint||`${base}/wp-admin/post.php`;
      const form=new FormData();
      form.append('post_title',content.title); form.append('content',content.html);
      form.append('post_status','publish'); form.append('action','editpost');
      form.append('post_type','post'); form.append('publish','Publish');
      const h={...hdrs}; delete h['Content-Type'];
      try{
        const r=await smartFetch(ep,{method:'POST',headers:h,body:form,sfTimeout:12000});
        if(r.ok||r.status===201||r.status===302) return {ok:true,url:r.url||ep,strategy:'Form POST',endpoint:ep};
      }catch(e){}
      return {ok:false};
    }
  },
  {
    id:'xmlrpc',
    label:'XML-RPC (WordPress legacy)',
    desc:'Old-school WordPress XML-RPC â€” works even on outdated WP installs',
    run:async(s,content,hdrs,cfg)=>{
      const ep=cfg.customEndpoint||`${s.siteUrl.replace(/\/$/,'')}/xmlrpc.php`;
      const c=s.creds||{}; const user=c.user||c.username||''; const pass=c.pass||c.password||'';
      if(!user||!pass) return {ok:false,msg:'XML-RPC requires username + password'};
      const xml=`<?xml version="1.0"?><methodCall><methodName>wp.newPost</methodName><params>
        <param><value><int>1</int></value></param>
        <param><value><string>${esc(user)}</string></value></param>
        <param><value><string>${esc(pass)}</string></value></param>
        <param><value><struct>
          <member><name>post_title</name><value><string>${esc(content.title)}</string></value></member>
          <member><name>post_content</name><value><string>${esc(content.html)}</string></value></member>
          <member><name>post_status</name><value><string>publish</string></value></member>
          <member><name>post_type</name><value><string>post</string></value></member>
        </struct></value></param>
      </params></methodCall>`;
      try{
        const r=await smartFetch(ep,{method:'POST',headers:{'Content-Type':'text/xml'},body:xml,sfTimeout:12000});
        const text=await r.text();
        const ok=text.includes('<methodResponse>')&&!text.includes('<fault>');
        const idM=text.match(/<int>(\d+)<\/int>/); const postId=idM?idM[1]:'';
        return {ok,url:ok?`${s.siteUrl}/?p=${postId}`:null,strategy:'XML-RPC',endpoint:ep};
      }catch(e){}
      return {ok:false};
    }
  },
  {
    id:'graphql',
    label:'GraphQL Mutation',
    desc:'GraphQL-based CMS platforms â€” Hashnode, Contentful, custom headless CMSes',
    run:async(s,content,hdrs,cfg)=>{
      const base=s.siteUrl.replace(/\/$/,'');
      const ep=cfg.customEndpoint||`${base}/graphql`;
      const mutations=[
        `mutation{createPost(input:{title:${JSON.stringify(content.title)},content:${JSON.stringify(content.html)}}){id url}}`,
        `mutation{createArticle(title:${JSON.stringify(content.title)},body:${JSON.stringify(content.html)}){id url}}`,
        `mutation{publishPost(title:${JSON.stringify(content.title)},html:${JSON.stringify(content.html)}){url}}`,
      ];
      for(const query of mutations){
        try{
          const r=await smartFetch(ep,{method:'POST',headers:hdrs,body:JSON.stringify({query}),sfTimeout:10000});
          const d=await r.json().catch(()=>({}));
          if(d.data&&!d.errors){
            const url=Object.values(d.data||{})[0]?.url||'';
            return {ok:true,url,strategy:'GraphQL',endpoint:ep};
          }
        }catch(e){}
      }
      return {ok:false};
    }
  },
  {
    id:'cookie_post',
    label:'Cookie + Form POST',
    desc:'Cookie-auth platforms with no API â€” Substack, Quora-style, any session-based CMS',
    run:async(s,content,hdrs,cfg)=>{
      const base=s.siteUrl.replace(/\/$/,'');
      const c=s.creds||{};
      if(!c.cookie) return {ok:false,msg:'Cookie auth required for this strategy'};
      const cookieHdrs={'Cookie':c.cookie,'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest','Referer':s.siteUrl,...(c.csrfToken?{'X-CSRFToken':c.csrfToken,'X-XSRF-Token':c.csrfToken}:{})};
      const ep=cfg.customEndpoint||`${base}/api/v1/posts`;
      const payloads=[
        {draft_title:content.title,body:{type:'doc',content:[{type:'paragraph',content:[{type:'text',text:content.html.replace(/<[^>]*>/g,'')}]}]}},
        {title:content.title,body:content.html,status:'published'},
      ];
      for(const body of payloads){
        try{
          const r=await smartFetch(ep,{method:'POST',headers:cookieHdrs,body:JSON.stringify(body),sfTimeout:12000,credentials:'include'});
          if(r.ok||r.status===201){const d=await r.json().catch(()=>({}));return{ok:true,url:d.url||d.canonical_url||ep,strategy:'Cookie POST',endpoint:ep};}
        }catch(e){}
      }
      return {ok:false};
    }
  },
  {
    id:'basic_auth',
    label:'Basic Auth REST POST',
    desc:'HTTP Basic authentication â€” Joomla, Drupal, custom REST APIs with username/password',
    run:async(s,content,hdrs,cfg)=>{
      const c=s.creds||{};
      const user=c.user||c.username||''; const pass=c.pass||c.password||'';
      if(!user||!pass) return {ok:false,msg:'Username + password required for Basic Auth'};
      const bHdrs={...hdrs,'Authorization':'Basic '+btoa(user+':'+pass)};
      const base=s.siteUrl.replace(/\/$/,'');
      const ep=cfg.customEndpoint||`${base}/api/v1/posts`;
      try{
        const r=await smartFetch(ep,{method:'POST',headers:bHdrs,body:JSON.stringify({title:content.title,content:content.html,status:'publish'}),sfTimeout:12000});
        if(r.ok||r.status===201){const d=await r.json().catch(()=>({}));return{ok:true,url:d.url||d.permalink||ep,strategy:'Basic Auth REST',endpoint:ep};}
      }catch(e){}
      return {ok:false};
    }
  },
  {
    id:'cors_proxy',
    label:'CORS Proxy Relay',
    desc:'Last resort â€” routes all requests through corsproxy.io to bypass browser CORS restrictions',
    run:async(s,content,hdrs,cfg)=>{
      const base=s.siteUrl.replace(/\/$/,'');
      const ep=cfg.customEndpoint||`${base}/wp-json/wp/v2/posts`;
      const proxied='https://corsproxy.io/?'+encodeURIComponent(ep);
      try{
        const r=await fetch(proxied,{method:'POST',headers:hdrs,body:JSON.stringify({title:content.title,content:content.html,status:'publish'}),signal:AbortSignal.timeout(15000)});
        if(r.ok||r.status===201){const d=await r.json().catch(()=>({}));return{ok:true,url:d.url||d.permalink||ep,strategy:'CORS Proxy',endpoint:ep};}
      }catch(e){}
      return {ok:false};
    }
  },
  {
    id:'ping_only',
    label:'Ping / Open Browser',
    desc:'No API available â€” fall back to opening the site in the inline browser for manual posting',
    run:async(s,content,hdrs,cfg)=>{
      lmLog(`â„¹ API strategies exhausted for ${s.label} â€” opening inline browser for manual post`,'t-warn');
      lmOpen(s.id);
      return {ok:false,fallback:true,msg:'Browser opened â€” paste content manually'};
    }
  },
];

// â”€â”€â”€ CORE API POST HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function lmApiPost(ep, payload, hdrs, extractKey='', gqlBody=null){
  const body=gqlBody?JSON.stringify(gqlBody):JSON.stringify(payload);
  try{
    const r=await smartFetch(ep,{method:'POST',headers:hdrs,body,sfTimeout:15000});
    if(r.ok||r.status===201){
      const d=await r.json().catch(()=>({}));
      const data=extractKey?d[extractKey]?.[0]??d:d;
      return {ok:true,url:data?.url||data?.link||data?.permalink||data?.html_url||data?.public_url||data?.canonical_url||ep,raw:d};
    }
    if(r.status===401||r.status===403) return {ok:false,code:r.status,msg:'Auth failed â€” check credentials'};
  }catch(e){ /* fall through */ }
  return {ok:false,msg:'All endpoints failed'};
}

// â”€â”€â”€ MASTER POST DISPATCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function lmDispatchPost(s, content, cfg={}){
  const hdrs=lmAuthHeaders(s);
  lmLog(`â†’ Dispatching to: ${s.label} [${lmP(s.pid).name}]`,'t-accent');

  // 1. Try platform-specific builder if we know the platform
  const builder=LM_POST_BUILDERS[s.pid];
  if(builder && s.pid!=='other'){
    lmLog(`  â†³ Using platform builder: ${lmP(s.pid).name}`,'tm');
    try{
      const r=await builder(s,content,hdrs);
      if(r?.ok){ lmLog(`  âœ” ${lmP(s.pid).name} builder succeeded â†’ ${r.url||'posted'}`,'t-info'); return r; }
      if(r?.msg) lmLog(`  âš  Platform builder: ${r.msg} â€” falling through to universal engine`,'t-warn');
    }catch(e){ lmLog(`  âš  Platform builder error: ${e.message} â€” falling through`,'t-warn'); }
  }

  // 2. Universal strategy cascade
  lmLog(`  â†³ Running universal strategy cascade (${LM_UNIVERSAL_STRATEGIES.length} methods)â€¦`,'tm');
  const skipStrategies=cfg.skipStrategies||[];
  for(const strat of LM_UNIVERSAL_STRATEGIES){
    if(skipStrategies.includes(strat.id)) continue;
    lmLog(`  â†³ Trying: ${strat.label}â€¦`,'tm');
    try{
      const r=await strat.run(s,content,hdrs,cfg);
      if(r?.ok){ lmLog(`  âœ” Success via ${strat.label} â†’ ${r.url||'posted'}`,'t-info'); return r; }
      if(r?.fallback) return r;
    }catch(e){ lmLog(`  âœ— ${strat.label} error: ${e.message}`,'tm'); }
  }

  return {ok:false,msg:'All strategies exhausted'};
}

// â”€â”€â”€ POST BUILDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmPostBuilderModal(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  document.getElementById('lm-post-modal')?.remove();
  const p=lmP(s.pid);
  const yr=new Date().getFullYear();
  const defaultKw=s.kws?.[0]||'';
  const tplOpts=Object.entries(LM_TEMPLATES).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('');
  const stratOpts=LM_UNIVERSAL_STRATEGIES.slice(0,-1).map(st=>`
    <label style="display:flex;align-items:center;gap:6px;padding:4px 0;cursor:pointer;font-family:var(--mono);font-size:10px">
      <input type="checkbox" value="${st.id}" checked style="width:auto" /> ${st.label}
      <span style="color:var(--muted2);font-size:9px">â€” ${st.desc}</span>
    </label>`).join('');

  const m=document.createElement('div'); m.id='lm-post-modal'; m.className='modal-overlay';
  m.innerHTML=`
  <div class="modal-box" style="max-width:700px;max-height:92vh;overflow-y:auto">
    <div class="modal-title">
      <span>${p.icon} Post Builder â€” ${esc(s.label)}</span>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-post-modal').remove()">âœ•</button>
    </div>

    <!-- GUIDE TIP -->
    <div style="background:rgba(0,87,255,0.05);border:1px solid rgba(0,87,255,0.15);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:10px;font-family:var(--mono);color:var(--muted2);line-height:1.7">
      ğŸ’¡ <strong style="color:var(--text)">How Post Builder Works:</strong>
      First pick a content template optimised for your niche, fill in your keyword and target URL,
      then preview and edit the generated content. Hit Publish â€” the engine tries the platform-specific
      API first, then cascades through 7 universal strategies automatically.
      Unknown platform? No problem â€” the universal engine handles it.
    </div>

    <!-- SITE INFO STRIP -->
    <div style="display:flex;gap:10px;align-items:center;padding:10px 14px;background:var(--bg2);border-radius:8px;margin-bottom:14px">
      <span style="font-size:20px">${p.icon}</span>
      <div style="flex:1;min-width:0">
        <div class="mono xs" style="font-weight:700">${esc(s.label)}</div>
        <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${esc(s.siteUrl)} Â· ${p.name} Â· Auth: ${s.auth}${s.creds?.apiKey||s.creds?.token||s.creds?.cookie||s.creds?.user?'  <span style="color:var(--accent)">âœ“ CREDS SET</span>':'  <span style="color:var(--accent2)">âš  NO CREDS</span>'}</div>
      </div>
      <span class="badge ${LM_STATUS[s.status]?.badge||'badge-y'}">${LM_STATUS[s.status]?.label||s.status}</span>
    </div>

    <!-- STEP 1: CONTENT SETUP -->
    <div class="card-title">Step 1 â€” Content Setup</div>
    <div class="grid2">
      <div class="fg"><label class="lbl">Content Template</label>
        <select id="lmpb-tpl" onchange="lmpbUpdateTplHint(this.value)">${tplOpts}</select>
        <div id="lmpb-tpl-hint" style="margin-top:4px;font-size:9px;color:var(--muted2);font-family:var(--mono)"></div>
      </div>
      <div class="fg"><label class="lbl">Target Keyword <span style="color:var(--accent2)">*</span></label>
        <input id="lmpb-kw" type="text" value="${esc(defaultKw)}" placeholder="e.g. Taylor Swift new album 2025" />
      </div>
    </div>
    <div class="grid2">
      <div class="fg"><label class="lbl">Target URL <span class="xs tm">(money page link to embed)</span></label>
        <input id="lmpb-target" type="url" value="${esc(s.targetUrl||'')}" placeholder="https://your-money-page.com" /></div>
      <div class="fg"><label class="lbl">Year Override</label>
        <input id="lmpb-yr" type="text" value="${yr}" placeholder="${yr}" /></div>
    </div>
    <button class="btn btn-blue" style="width:100%;margin-bottom:14px" onclick="lmpbGenerate()">âš¡ Generate Content from Template</button>

    <!-- STEP 2: CONTENT EDITOR -->
    <div class="card-title">Step 2 â€” Review &amp; Edit Content</div>
    <div style="display:flex;gap:6px;margin-bottom:6px">
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lmpb-tab-html').style.display='block';document.getElementById('lmpb-tab-md').style.display='none';document.getElementById('lmpb-tab-preview').style.display='none'">HTML</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lmpb-tab-html').style.display='none';document.getElementById('lmpb-tab-md').style.display='block';document.getElementById('lmpb-tab-preview').style.display='none'">Markdown</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lmpb-tab-html').style.display='none';document.getElementById('lmpb-tab-md').style.display='none';document.getElementById('lmpb-tab-preview').style.display='block';document.getElementById('lmpb-tab-preview').innerHTML=document.getElementById('lmpb-html').value">ğŸ‘ Preview</button>
    </div>
    <div id="lmpb-tab-html">
      <div class="fg"><label class="lbl">Post Title</label>
        <input id="lmpb-title" type="text" value="" placeholder="Post title will appear here after generation" /></div>
      <div class="fg"><label class="lbl">HTML Content</label>
        <textarea id="lmpb-html" rows="10" style="font-family:var(--mono);font-size:10px" placeholder="HTML content will appear here after generationâ€¦"></textarea></div>
      <div class="fg"><label class="lbl">Tags <span class="xs tm">(comma-separated)</span></label>
        <input id="lmpb-tags" type="text" value="" placeholder="entertainment, celebrity, review, 2025" /></div>
    </div>
    <div id="lmpb-tab-md" style="display:none">
      <div class="fg"><label class="lbl">Markdown Content</label>
        <textarea id="lmpb-md" rows="12" style="font-family:var(--mono);font-size:10px" placeholder="Markdown version will appear after generationâ€¦"></textarea></div>
    </div>
    <div id="lmpb-tab-preview" style="display:none;min-height:200px;border:1px solid var(--border);padding:14px;border-radius:8px;background:#fff;color:#111;font-size:13px;line-height:1.8"></div>

    <!-- STEP 3: POST CONFIG -->
    <div class="card-title" style="margin-top:14px">Step 3 â€” Post Configuration</div>

    <!-- Auth override -->
    <div style="background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.12);border-radius:8px;padding:12px 14px;margin-bottom:12px">
      <div class="xs mono tm" style="margin-bottom:8px;font-weight:700">ğŸ” Auth Override <span style="font-weight:400">(leave blank to use site credentials)</span></div>
      <div class="grid2">
        <div class="fg mb0"><label class="lbl">API Key / Bearer Token</label>
          <input id="lmpb-apikey" type="password" value="${esc(s.creds?.apiKey||'')}" placeholder="Bearer token" /></div>
        <div class="fg mb0"><label class="lbl">OAuth / Access Token</label>
          <input id="lmpb-token" type="password" value="${esc(s.creds?.token||'')}" /></div>
        <div class="fg mb0"><label class="lbl">Username</label>
          <input id="lmpb-user" type="text" value="${esc(s.creds?.user||'')}" placeholder="your@email.com" autocomplete="off" /></div>
        <div class="fg mb0"><label class="lbl">Password</label>
          <input id="lmpb-pass" type="password" value="${esc(s.creds?.pass||'')}" autocomplete="off" /></div>
      </div>
      <div class="fg mb0" style="margin-top:8px"><label class="lbl">Cookie String</label>
        <input id="lmpb-cookie" type="text" value="${esc(s.creds?.cookie||'')}" placeholder="session=abc123; auth=xyz456; csrf=defâ€¦" /></div>
      <div class="grid2" style="margin-top:8px">
        <div class="fg mb0"><label class="lbl">Custom Header Name <span class="xs tm">(e.g. X-API-Key)</span></label>
          <input id="lmpb-hdrname" type="text" placeholder="X-API-Key" /></div>
        <div class="fg mb0"><label class="lbl">Custom Header Value</label>
          <input id="lmpb-hdrval" type="text" placeholder="your-secret-key-here" /></div>
      </div>
      <div class="fg mb0" style="margin-top:8px"><label class="lbl">CSRF Token <span class="xs tm">(for cookie-based sites with CSRF protection)</span></label>
        <input id="lmpb-csrf" type="text" placeholder="csrf_token value from cookies or meta tag" /></div>
    </div>

    <!-- Endpoint config -->
    <div style="background:rgba(255,165,0,0.04);border:1px solid rgba(255,165,0,0.2);border-radius:8px;padding:12px 14px;margin-bottom:12px">
      <div class="xs mono tm" style="margin-bottom:8px;font-weight:700">ğŸ”— Endpoint Config <span style="font-weight:400">(for unknown/custom platforms)</span></div>
      <div class="fg mb0"><label class="lbl">Custom Post Endpoint <span class="xs tm">(leave blank for auto-detection)</span></label>
        <input id="lmpb-endpoint" type="url" placeholder="https://yoursite.com/api/v1/posts  or  /wp-json/wp/v2/posts" /></div>
      <div style="margin-top:8px">
        <div class="xs mono tm" style="margin-bottom:6px;font-weight:700">Strategy Order â€” uncheck to skip:</div>
        <div id="lmpb-strategies" style="max-height:140px;overflow-y:auto">${stratOpts}</div>
      </div>
    </div>

    <!-- Post result terminal -->
    <div class="card-title">Post Log</div>
    <div class="terminal" id="lmpb-log" style="height:120px;margin-bottom:14px">
      <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Ready to publish. Generate content above, then click Publish.</span></div>
    </div>

    <!-- ACTION BUTTONS -->
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary" style="flex:2;padding:10px" onclick="lmpbPublish('${id}')">ğŸš€ Publish Post</button>
      <button class="btn btn-blue" onclick="lmpbTestAuth('${id}')">ğŸ” Test Auth</button>
      <button class="btn btn-ghost" onclick="lmOpen('${id}');document.getElementById('lm-post-modal').remove()">ğŸŒ Open Site</button>
      <button class="btn btn-ghost" onclick="lmpbCopyContent()">ğŸ“‹ Copy HTML</button>
    </div>
    <div style="margin-top:10px;padding:8px 10px;background:var(--bg2);border-radius:6px;font-family:var(--mono);font-size:9px;color:var(--muted2);line-height:1.7">
      ğŸ’¡ <strong style="color:var(--text)">Entertainment / Video niche tips:</strong>
      Use "ğŸ¬ Video Review" for YouTube/Netflix content Â· "â­ Celebrity News" for trending stars Â·
      "ğŸ“º Live Stream Guide" for sports/awards/concerts Â· These templates are tuned for high CTR in
      entertainment SERPs. Target keyword = the exact phrase fans search (e.g. "taylor swift eras tour 2025 full").
    </div>
  </div>`;
  m.addEventListener('click',e=>{ if(e.target===m) m.remove(); });
  document.body.appendChild(m);
  setTimeout(()=>lmpbUpdateTplHint(document.getElementById('lmpb-tpl')?.value||'video_review'),50);
}

function lmpbUpdateTplHint(tplId){
  const tpl=LM_TEMPLATES[tplId]; if(!tpl) return;
  const h=document.getElementById('lmpb-tpl-hint'); if(h) h.textContent=tpl.desc;
}

function lmpbLog(msg,cls='t-info'){
  const t=document.getElementById('lmpb-log'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${msg.replace(/</g,'&lt;')}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
  // also mirror to main LM log
  lmLog(msg,cls);
}

function lmpbGenerate(){
  const tplId=document.getElementById('lmpb-tpl')?.value||'video_review';
  const kw=(document.getElementById('lmpb-kw')?.value||'').trim();
  const target=(document.getElementById('lmpb-target')?.value||'').trim();
  const yr=parseInt(document.getElementById('lmpb-yr')?.value||new Date().getFullYear());
  if(!kw){ lmpbLog('âš  Keyword required to generate content','t-warn'); return; }
  const tpl=LM_TEMPLATES[tplId]; if(!tpl){ return; }
  const content=tpl.build(kw,target,yr);
  const titleEl=document.getElementById('lmpb-title'); if(titleEl) titleEl.value=content.title;
  const htmlEl=document.getElementById('lmpb-html'); if(htmlEl) htmlEl.value=content.html;
  const mdEl=document.getElementById('lmpb-md'); if(mdEl) mdEl.value=content.md||'';
  const tagsEl=document.getElementById('lmpb-tags'); if(tagsEl) tagsEl.value=(content.tags||[]).join(', ');
  lmpbLog(`âœ” Generated "${content.title}" via ${tpl.label}`,'t-info');
}

async function lmpbTestAuth(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  lmpbLog(`â†’ Testing auth for ${s.label}â€¦`,'t-accent');
  const tempCreds=lmpbBuildTempCreds(s);
  const tempSite={...s,creds:{...s.creds,...tempCreds}};
  const hdrs=lmAuthHeaders(tempSite);
  const p=lmP(s.pid);
  let base=p.apiBase.replace('{url}',s.siteUrl).replace('{sub}',s.siteUrl.replace(/^https?:\/\//,'').split('.')[0]);
  let ep=p.verifyEp||'/'; ep=ep.replace('{blogId}',s.blogId||'').replace(/{.*?}/g,'');
  const fullUrl=ep.startsWith('http')?ep:base+ep;
  try{
    const r=await smartFetch(fullUrl,{method:'GET',headers:hdrs,sfTimeout:10000});
    lmpbLog(`  ${r.ok?'âœ”':'âœ—'} Auth test: HTTP ${r.status} ${r.ok?'â€” Connected OK':'â€” Check credentials'}`,r.ok?'t-info':'t-warn');
  }catch(e){ lmpbLog(`  âœ— Connection error: ${e.message}`,'t-warn'); }
}

function lmpbBuildTempCreds(s){
  const apiKey=(document.getElementById('lmpb-apikey')?.value||'').trim();
  const token=(document.getElementById('lmpb-token')?.value||'').trim();
  const user=(document.getElementById('lmpb-user')?.value||'').trim();
  const pass=(document.getElementById('lmpb-pass')?.value||'').trim();
  const cookie=(document.getElementById('lmpb-cookie')?.value||'').trim();
  const csrfToken=(document.getElementById('lmpb-csrf')?.value||'').trim();
  const hdrName=(document.getElementById('lmpb-hdrname')?.value||'').trim();
  const hdrVal=(document.getElementById('lmpb-hdrval')?.value||'').trim();
  return { apiKey:apiKey||s.creds?.apiKey, token:token||s.creds?.token, user:user||s.creds?.user, pass:pass||s.creds?.pass, cookie:cookie||s.creds?.cookie, csrfToken, customHeader:hdrName?{name:hdrName,value:hdrVal}:null };
}

async function lmpbPublish(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  const title=(document.getElementById('lmpb-title')?.value||'').trim();
  const html=(document.getElementById('lmpb-html')?.value||'').trim();
  const md=(document.getElementById('lmpb-md')?.value||'').trim();
  const tagsRaw=(document.getElementById('lmpb-tags')?.value||'').trim();
  const customEndpoint=(document.getElementById('lmpb-endpoint')?.value||'').trim();
  if(!title||!html){ lmpbLog('âš  Generate content first â€” title and HTML are required','t-warn'); return; }
  const tags=tagsRaw?tagsRaw.split(',').map(t=>t.trim()).filter(Boolean):[];
  const content={title,html,md,tags};

  // Build temp site with overridden creds + custom header
  const tempCreds=lmpbBuildTempCreds(s);
  const tempSite={...s,creds:{...s.creds,...tempCreds}};

  // Add custom header to auth if specified
  const origAuthHeaders=lmAuthHeaders;
  if(tempCreds.customHeader?.name){
    const origHdrs=lmAuthHeaders(tempSite);
    origHdrs[tempCreds.customHeader.name]=tempCreds.customHeader.value;
  }

  // Get skipped strategies
  const stratChecks=document.querySelectorAll('#lmpb-strategies input[type=checkbox]');
  const skipStrategies=[...stratChecks].filter(cb=>!cb.checked).map(cb=>cb.value);

  lmpbLog(`â†’ Publishing: "${title}"`,'t-accent');
  const btn=document.querySelector('#lm-post-modal .btn-primary'); if(btn){btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Publishingâ€¦';}

  const result=await lmDispatchPost(tempSite,content,{customEndpoint,skipStrategies});

  if(btn){btn.disabled=false;btn.innerHTML='ğŸš€ Publish Post';}

  if(result?.ok){
    s.posts=(s.posts||0)+1; s.posted=new Date().toLocaleTimeString();
    s.history=s.history||[]; s.history.unshift({t:s.posted,kw:title,url:result.url||'',status:'live',strategy:result.strategy||''});
    lmSave(); lmRenderRow(id);
    lmpbLog(`âœ” Published! Strategy: ${result.strategy||'API'} â†’ ${result.url||'(no URL returned)'}`,'t-info');
    if(result.url&&!S.links.find(l=>l.url===result.url)){
      S.links.push({id:uid(),label:title,url:result.url,target:'both'}); updateHeader();
    }
  } else {
    lmpbLog(`âœ— All publish strategies failed. ${result?.msg||''}`,'t-warn');
    lmpbLog(`  â†’ Opening inline browser for manual postingâ€¦`,'t-warn');
    lmOpen(id);
  }
}

function lmpbCopyContent(){
  const html=document.getElementById('lmpb-html')?.value||'';
  navigator.clipboard?.writeText(html).then(()=>lmpbLog('âœ” HTML copied to clipboard','t-info')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=html; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); lmpbLog('âœ” HTML copied','t-info');
  });
}

// â”€â”€â”€ OVERRIDE lmQuickPost to launch Post Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function lmQuickPost(id){
  // Quick post still fires instantly for bulk operations
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  const kw=s.kws?.[0]||'';
  if(!kw){ lmPostBuilderModal(id); return; } // No keyword â†’ open full builder
  const yr=new Date().getFullYear();
  // Use video_review as default for entertainment niche
  const content=LM_TEMPLATES.video_review.build(kw,s.targetUrl||'',yr);
  lmLog(`â†’ Quick post: "${content.title}" â†’ ${s.label}`,'t-accent');
  const result=await lmDispatchPost(s,content,{});
  if(result?.ok){
    s.posts=(s.posts||0)+1; s.posted=new Date().toLocaleTimeString();
    s.history=s.history||[]; s.history.unshift({t:s.posted,kw,url:result.url||'',status:'live',strategy:result.strategy||''});
    lmSave(); lmRenderRow(id); lmLog(`âœ” Quick post done: ${result.url||'(no URL)'}`,'t-info');
    if(result.url&&!S.links.find(l=>l.url===result.url)){ S.links.push({id:uid(),label:kw,url:result.url,target:'both'}); updateHeader(); }
  } else {
    lmLog(`âœ— Quick post failed for ${s.label} â€” opening Post Builder`,'t-warn');
    lmPostBuilderModal(id);
  }
}

async function lmPostToSelected(){
  const ids=[...LM_STATE.sel];
  if(!ids.length){ lmLog('âš  No sites selected','t-warn'); return; }
  if(ids.length===1){ lmPostBuilderModal(ids[0]); return; }
  // Bulk: quick post each
  for(const id of ids){ await lmQuickPost(id); await sleep(900); }
}


// â”€â”€â”€ INLINE BROWSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmOpen(id){
  LM_STATE.openId=id; lmRenderBrowser();
  document.getElementById('lm-browser-panel')?.scrollIntoView({behavior:'smooth',block:'start'});
}

function lmRenderBrowser(){
  const wrap=document.getElementById('lm-browser-panel'); if(!wrap) return;
  const s=LM_STATE.sites.find(x=>x.id===LM_STATE.openId);
  if(!s){
    wrap.innerHTML=`<div class="card">
      <div class="card-title">ğŸŒ Inline Browser</div>
      <div style="padding:36px;text-align:center;color:var(--muted2);font-family:var(--mono);font-size:11px">
        Click <strong>ğŸŒ</strong> on any site to open it here.<br>
        You can log in, browse, and manage content without leaving this tool.
      </div></div>`;
    return;
  }
  const p=lmP(s.pid);
  const loginUrl=p.loginUrl.replace('{url}',s.siteUrl).replace(/{.*?}/g,'');
  const homeUrl=s.siteUrl.startsWith('http')?s.siteUrl:'https://'+s.siteUrl;
  wrap.innerHTML=`
  <div class="card" style="padding:0;overflow:hidden;margin-top:0">
    <!-- Toolbar -->
    <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg2);border-bottom:1px solid var(--border)">
      <span style="font-size:18px">${p.icon}</span>
      <div style="flex:1;min-width:0">
        <div class="mono xs" style="font-weight:700">${esc(s.label)}</div>
        <div style="font-size:9px;color:var(--accent5);font-family:var(--mono)">${esc(s.siteUrl)} Â· ${p.name}</div>
      </div>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src='${esc(homeUrl)}'">ğŸ </button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src='${esc(loginUrl)}'" title="Go to login page">ğŸ” Login</button>
      <button class="btn btn-primary btn-xs" onclick="lmQuickPost('${s.id}')" title="Quick post via API">âš¡ Quick Post</button>
      <button class="btn btn-blue btn-xs" onclick="lmEditModal('${s.id}')" title="Edit credentials">âœ Edit</button>
      <button class="btn btn-ghost btn-xs" onclick="window.open(document.getElementById('lm-iframe').src,'_blank')">â†— Pop Out</button>
      <button class="btn btn-danger btn-xs" onclick="LM_STATE.openId=null;lmRenderBrowser()">âœ•</button>
    </div>
    <!-- Address bar -->
    <div style="display:flex;gap:6px;padding:6px 10px;background:var(--bg);border-bottom:1px solid var(--border);align-items:center">
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').contentWindow?.history?.back()">â—€</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').contentWindow?.history?.forward()">â–¶</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src=document.getElementById('lm-iframe').src">â†º</button>
      <input id="lm-addr" type="url" value="${esc(homeUrl)}"
        style="flex:1;font-size:11px;padding:5px 10px;font-family:var(--mono);border-radius:20px;background:var(--bg2)"
        onkeydown="if(event.key==='Enter'){ document.getElementById('lm-iframe').src=this.value; }" />
      <button class="btn btn-blue btn-sm" onclick="document.getElementById('lm-iframe').src=document.getElementById('lm-addr').value">Go â†’</button>
      <button class="btn btn-ghost btn-xs" onclick="let h=parseInt(document.getElementById('lm-iframe').style.height)||600;document.getElementById('lm-iframe').style.height=(h+200)+'px'" title="Make taller">â¬†</button>
      <button class="btn btn-ghost btn-xs" onclick="let h=parseInt(document.getElementById('lm-iframe').style.height)||600;document.getElementById('lm-iframe').style.height=Math.max(300,h-200)+'px'" title="Make shorter">â¬‡</button>
    </div>
    <!-- Quick nav links -->
    <div style="display:flex;gap:6px;padding:6px 10px;background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap">
      <span class="mono xs tm">Quick nav:</span>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src=document.getElementById('lm-iframe').src.replace(/\\/$/,'')+'${esc(p.loginUrl.replace('{url}','').replace(/{.*?}/g,''))}'">ğŸ” Login</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src='${esc(homeUrl)}/admin'||'${esc(homeUrl)}/wp-admin'">âš™ Admin</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src='${esc(homeUrl)}/new-post'||'${esc(homeUrl)}/write'">âœ New Post</button>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-iframe').src='${esc(homeUrl)}/settings'">âš™ Settings</button>
      <span style="margin-left:auto;font-size:9px;color:var(--muted2);font-family:var(--mono)">Auth: ${esc(s.auth)} ${s.creds?.apiKey||s.creds?.token||s.creds?.cookie||s.creds?.user?'âœ“':'âš  no creds'}</span>
    </div>
    <!-- iFrame -->
    <iframe id="lm-iframe" src="${esc(homeUrl)}"
      style="width:100%;height:600px;border:none;display:block;background:#fff"
      onload="try{const u=this.contentWindow.location.href;if(u&&u!=='about:blank')document.getElementById('lm-addr').value=u;}catch(e){}"
      sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation allow-downloads">
    </iframe>
    <div style="padding:6px 14px;background:var(--bg2);border-top:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--muted2)">
      â„¹ Some sites block iframe embedding (X-Frame-Options / CSP). If blank, use â†— Pop Out or open their login page and return. Cookies set inside this browser persist in your actual browser session.
    </div>
  </div>`;
}

// â”€â”€â”€ TABLE ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmRowHTML(s){
  const p=lmP(s.pid);
  const st=LM_STATUS[s.status]||{label:s.status,badge:'badge-y'};
  const tier=LM_TIERS.find(t=>t.id===s.tier)||LM_TIERS[1];
  const hasCreds=!!(s.creds?.apiKey||s.creds?.token||s.creds?.cookie||s.creds?.user);
  return `
    <td style="padding:8px 6px"><input type="checkbox" ${LM_STATE.sel.has(s.id)?'checked':''} style="width:auto"
      onchange="if(this.checked)LM_STATE.sel.add('${s.id}');else LM_STATE.sel.delete('${s.id}')"></td>
    <td style="font-size:18px;text-align:center" title="${esc(p.cat)}">${p.icon}</td>
    <td>
      <div class="mono xs" style="font-weight:700;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(s.label)}">${esc(s.label)}</div>
      <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${esc(p.name)}</div>
    </td>
    <td>
      <a href="${esc(s.siteUrl)}" target="_blank" style="font-size:10px;font-family:var(--mono);color:var(--accent);text-decoration:none;display:block;max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.siteUrl)}</a>
      <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${esc(s.niche||'â€”')}</div>
    </td>
    <td>
      <span class="badge badge-p" style="font-size:8px">${esc(s.auth)}</span><br>
      <span class="badge ${hasCreds?'badge-g':'badge-r'}" style="font-size:7px;margin-top:2px">${hasCreds?'CREDS âœ“':'NO CREDS'}</span>
    </td>
    <td>
      <span class="badge ${st.badge}">${s.status==='checking'?'<span class="spinner"></span> ':''}${st.label}</span>
      ${s.code?`<div style="font-size:8px;color:var(--muted2);font-family:var(--mono);margin-top:2px">HTTP ${s.code}${s.ms?' Â· '+s.ms+'ms':''}</div>`:''}
      ${s.verified?`<div style="font-size:8px;color:var(--muted2);font-family:var(--mono)">${s.verified}</div>`:''}
    </td>
    <td>
      <span class="badge ${tier.badge}" style="font-size:8px">${tier.id.replace('tier','T')}</span>
      ${s.da?`<span class="badge ${s.da>=90?'badge-g':s.da>=80?'badge-b':'badge-y'}" style="font-size:8px;margin-left:2px">DA${s.da}</span>`:''}
    </td>
    <td class="mono xs">
      <div style="color:var(--muted2)">${s.posted||'â€”'}</div>
      <div style="color:var(--accent5)">${s.posts||0} posts</div>
    </td>
    <td>
      <div style="display:flex;gap:3px;flex-wrap:wrap">
        <button class="btn btn-blue btn-xs" onclick="lmOpen('${s.id}')" title="Open in browser panel">ğŸŒ</button>
        <button class="btn btn-ghost btn-xs" onclick="lmVerify('${s.id}')" title="Health check / verify auth">ğŸ”</button>
        <button class="btn btn-primary btn-xs" onclick="lmPostBuilderModal('${s.id}')" title="Post Builder â€” platform-specific + universal engine">ğŸ“ Post</button>
        <button class="btn btn-ghost btn-xs" onclick="lmEditModal('${s.id}')" title="Edit credentials">âœ</button>
        <button class="btn btn-danger btn-xs" onclick="lmDelete('${s.id}')">âœ•</button>
      </div>
    </td>`;
}

function lmRenderRow(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  const el=document.getElementById('lm-row-'+id); if(!el) return;
  el.innerHTML=lmRowHTML(s);
}

function lmFiltered(){
  const f=LM_STATE.filter;
  return LM_STATE.sites.filter(s=>{
    if(f.cat){ const p=lmP(s.pid); if(p.cat!==f.cat) return false; }
    if(f.tier && s.tier!==f.tier) return false;
    if(f.status && s.status!==f.status) return false;
    if(f.search){ const q=f.search.toLowerCase();
      if(!(s.label+s.siteUrl+(s.niche||'')).toLowerCase().includes(q)) return false; }
    return true;
  });
}

function lmRenderTable(){
  const tbody=document.getElementById('lm-tbody'); if(!tbody) return;
  const list=lmFiltered();
  // stats
  const all=LM_STATE.sites;
  const upd=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  upd('lm-s-total',all.length); upd('lm-s-active',all.filter(s=>s.status==='active').length);
  upd('lm-s-err',all.filter(s=>['error','auth_failed','unreachable'].includes(s.status)).length);
  upd('lm-s-posts',all.reduce((a,s)=>a+(s.posts||0),0));
  const badge=document.getElementById('link-badge'); if(badge) badge.textContent=all.length;
  if(!list.length){
    tbody.innerHTML=`<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--muted2);font-family:var(--mono);font-size:11px">
      ${all.length?'No sites match the current filters.':'No sites yet â€” add one above or import from Web 2.0 Builder / Session Manager.'}</td></tr>`;
    return;
  }
  tbody.innerHTML=list.map(s=>`<tr id="lm-row-${s.id}">${lmRowHTML(s)}</tr>`).join('');
  // sync S.links for campaign engine
  S.links=all.filter(s=>s.targetUrl).map(s=>({id:s.id,label:s.label,url:s.siteUrl,target:'both'}));
  updateHeader();
}

// â”€â”€â”€ EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmEditModal(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  document.getElementById('lm-edit-modal')?.remove();
  const p=lmP(s.pid);
  const m=document.createElement('div'); m.id='lm-edit-modal'; m.className='modal-overlay';
  m.innerHTML=`
  <div class="modal-box" style="max-width:600px;max-height:90vh;overflow-y:auto">
    <div class="modal-title">
      <span>${p.icon} Edit â€” ${esc(s.label)}</span>
      <button class="btn btn-ghost btn-xs" onclick="document.getElementById('lm-edit-modal').remove()">âœ•</button>
    </div>
    <div class="grid2">
      <div class="fg"><label class="lbl">Label</label>
        <input id="lme-label" value="${esc(s.label)}" /></div>
      <div class="fg"><label class="lbl">Site URL</label>
        <input id="lme-url" type="url" value="${esc(s.siteUrl)}" /></div>
      <div class="fg"><label class="lbl">Niche / Tag</label>
        <input id="lme-niche" value="${esc(s.niche||'')}" placeholder="fitness, financeâ€¦" /></div>
      <div class="fg"><label class="lbl">Blog / Site ID</label>
        <input id="lme-blogid" value="${esc(s.blogId||'')}" placeholder="platform-specific ID" /></div>
      <div class="fg"><label class="lbl">Tier</label>
        <select id="lme-tier">${LM_TIERS.map(t=>`<option value="${t.id}" ${s.tier===t.id?'selected':''}>${t.label}</option>`).join('')}</select></div>
      <div class="fg"><label class="lbl">Auth Method</label>
        <select id="lme-auth" onchange="lmEditAuthToggle(this.value)">${Object.entries(LM_AUTH).map(([k,v])=>`<option value="${k}" ${s.auth===k?'selected':''}>${v.icon} ${v.label}</option>`).join('')}</select></div>
    </div>
    <div class="card" style="margin:4px 0;padding:10px 14px;background:rgba(0,87,255,0.04)">
      <div class="xs mono tm" style="margin-bottom:8px">ğŸ” Credentials</div>
      <div class="grid2">
        <div class="fg"><label class="lbl">ğŸ”‘ API Key / Token</label>
          <input id="lme-apikey" type="password" value="${esc(s.creds?.apiKey||'')}" placeholder="Bearer token or API key" /></div>
        <div class="fg"><label class="lbl">ğŸ”“ OAuth / Access Token</label>
          <input id="lme-token" type="password" value="${esc(s.creds?.token||'')}" /></div>
        <div class="fg"><label class="lbl">ğŸ‘¤ Username / Email</label>
          <input id="lme-user" type="text" value="${esc(s.creds?.user||'')}" /></div>
        <div class="fg"><label class="lbl">ğŸ”’ Password</label>
          <input id="lme-pass" type="password" value="${esc(s.creds?.pass||'')}" /></div>
      </div>
      <div class="fg"><label class="lbl">ğŸª Cookie String</label>
        <textarea id="lme-cookie" rows="2" placeholder="session=abc; auth=xyzâ€¦">${esc(s.creds?.cookie||'')}</textarea></div>
    </div>
    <div class="fg"><label class="lbl">Target URL <span class="xs tm">(money page this site links to)</span></label>
      <input id="lme-target" type="url" value="${esc(s.targetUrl||'')}" /></div>
    <div class="fg"><label class="lbl">Keywords <span class="xs tm">(one per line â€” used for Quick Post)</span></label>
      <textarea id="lme-kws" rows="3">${(s.kws||[]).join('\n')}</textarea></div>
    <div class="fg"><label class="lbl">Notes</label>
      <textarea id="lme-notes" rows="2">${esc(s.notes||'')}</textarea></div>
    ${s.history?.length?`<div class="fg"><label class="lbl">Post History (${s.history.length})</label>
      <div style="max-height:120px;overflow-y:auto;font-family:var(--mono);font-size:9px;color:var(--muted2)">
        ${s.history.slice(0,10).map(h=>`<div style="padding:3px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--accent3)">${h.t}</span> Â· ${esc(h.kw)} Â· ${h.url?`<a href="${esc(h.url)}" target="_blank" style="color:var(--accent)">${esc(h.url.substring(0,50))}â€¦</a>`:'(no URL)'}
        </div>`).join('')}
      </div></div>`:''}
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-primary" style="flex:1" onclick="lmSaveEdit('${id}')">âœ“ Save</button>
      <button class="btn btn-blue" onclick="lmVerify('${id}');document.getElementById('lm-edit-modal').remove()">ğŸ” Verify</button>
      <button class="btn btn-ghost" onclick="lmOpen('${id}');document.getElementById('lm-edit-modal').remove()">ğŸŒ Open</button>
      <button class="btn btn-ghost" onclick="document.getElementById('lm-edit-modal').remove();lmPostBuilderModal('${id}')">ğŸ“ Post Builder</button>
    </div>
  </div>`;
  m.addEventListener('click',e=>{ if(e.target===m) m.remove(); });
  document.body.appendChild(m);
}
function lmEditAuthToggle(v){ /* visual hint only */ }
function lmSaveEdit(id){
  const s=LM_STATE.sites.find(x=>x.id===id); if(!s) return;
  s.label  = document.getElementById('lme-label')?.value?.trim()||s.label;
  s.siteUrl= document.getElementById('lme-url')?.value?.trim()||s.siteUrl;
  s.niche  = document.getElementById('lme-niche')?.value?.trim()||'';
  s.blogId = document.getElementById('lme-blogid')?.value?.trim()||'';
  s.tier   = document.getElementById('lme-tier')?.value||s.tier;
  s.auth   = document.getElementById('lme-auth')?.value||s.auth;
  s.targetUrl= document.getElementById('lme-target')?.value?.trim()||'';
  s.kws    = (document.getElementById('lme-kws')?.value||'').split('\n').map(k=>k.trim()).filter(Boolean);
  s.notes  = document.getElementById('lme-notes')?.value?.trim()||'';
  s.creds  = {
    apiKey : document.getElementById('lme-apikey')?.value?.trim()||'',
    token  : document.getElementById('lme-token')?.value?.trim()||'',
    user   : document.getElementById('lme-user')?.value?.trim()||'',
    pass   : document.getElementById('lme-pass')?.value?.trim()||'',
    cookie : document.getElementById('lme-cookie')?.value?.trim()||'',
  };
  lmSave(); document.getElementById('lm-edit-modal')?.remove();
  lmRenderRow(id); lmLog(`âœ” Saved: ${s.label}`,'t-info');
}

// â”€â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmExport(){
  if(!LM_STATE.sites.length) return;
  const h='Label,Platform,Site URL,Auth,API Key,Username,Niche,Tier,Target URL,Status,Last Verified,Posts\n';
  const rows=LM_STATE.sites.map(s=>`"${s.label}","${lmP(s.pid).name}","${s.siteUrl}","${s.auth}","${s.creds?.apiKey||''}","${s.creds?.user||''}","${s.niche||''}","${s.tier}","${s.targetUrl||''}","${s.status}","${s.verified||''}","${s.posts||0}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='links-manager.csv'; a.click();
}

// â”€â”€â”€ AUTH FIELDS TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lmAuthToggle(method){
  ['api_key','user_pass','oauth','cookie'].forEach(m=>{
    const el=document.getElementById('lm-ab-'+m);
    if(el) el.style.display=(m===method?'block':'none');
  });
}
function lmUpdatePlatHint(pid){
  const p=lmP(pid);
  const h=document.getElementById('lm-plat-hint'); if(h) h.textContent=p.note;
  const sel=document.getElementById('lm-add-auth');
  if(sel){ sel.innerHTML=p.auth.map(m=>`<option value="${m}">${LM_AUTH[m]?.icon||''} ${LM_AUTH[m]?.label||m}</option>`).join(''); lmAuthToggle(p.auth[0]); }
}

// â”€â”€â”€ RENDER PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLATFORM-SPECIFIC POST BUILDER â€” UNIVERSAL ACTION ENGINE
// Works on ANY site: known platform, unknown platform, or custom
// Auth: API key Â· Bearer Â· Basic Â· OAuth Â· Cookie Â· Custom Header
// Niche focus: Video Â· Entertainment Â· Celebrities Â· Live Streams
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



function renderLinks(el){
  el=el||document.getElementById('page-links'); if(!el) return;

  const cats=[...new Set(LM_PLATFORMS.map(p=>p.cat))];
  const platOpts=LM_PLATFORMS.map(p=>`<option value="${p.id}">${p.icon} ${p.name}${p.da?' (DA'+p.da+')':''}</option>`).join('');
  const tierOpts=LM_TIERS.map(t=>`<option value="${t.id}">${t.label}</option>`).join('');
  const authOpts=Object.entries(LM_AUTH).map(([k,v])=>`<option value="${k}">${v.icon} ${v.label}</option>`).join('');

  el.innerHTML=`
  <div class="page-title">ğŸ”— Links Manager</div>
  <div class="page-sub">// ${LM_PLATFORMS.length} platform types Â· credential vault Â· platform-specific post builder Â· universal custom poster Â· health checker Â· inline browser</div>

  <!-- STATS -->
  <div class="grid4" style="margin-bottom:16px">
    <div class="stat b"><div class="stat-v" id="lm-s-total">${LM_STATE.sites.length}</div><div class="stat-l">Total Sites</div></div>
    <div class="stat g"><div class="stat-v" id="lm-s-active">${LM_STATE.sites.filter(s=>s.status==='active').length}</div><div class="stat-l">Active</div></div>
    <div class="stat r"><div class="stat-v" id="lm-s-err">${LM_STATE.sites.filter(s=>['error','auth_failed','unreachable'].includes(s.status)).length}</div><div class="stat-l">Errors</div></div>
    <div class="stat p"><div class="stat-v" id="lm-s-posts">${LM_STATE.sites.reduce((a,s)=>a+(s.posts||0),0)}</div><div class="stat-l">Total Posts</div></div>
  </div>

  <div class="grid2" style="gap:18px;align-items:start">

    <!-- â•â•â• LEFT COLUMN: ADD + IMPORT + LOG â•â•â• -->
    <div>

      <!-- ADD SITE CARD -->
      <div class="card">
        <div class="card-title">â• Add Site to Registry</div>

        <div class="fg">
          <label class="lbl">Platform <span style="color:var(--accent2)">*</span></label>
          <select id="lm-add-plat" onchange="lmUpdatePlatHint(this.value)">${platOpts}</select>
          <div id="lm-plat-hint" style="margin-top:4px;font-size:9px;color:var(--muted2);font-family:var(--mono)"></div>
        </div>

        <div class="grid2">
          <div class="fg"><label class="lbl">Site URL <span style="color:var(--accent2)">*</span></label>
            <input type="url" id="lm-add-url" placeholder="https://yourblog.wordpress.com" /></div>
          <div class="fg"><label class="lbl">Label / Nickname</label>
            <input type="text" id="lm-add-label" placeholder="Fitness Blog #1" /></div>
        </div>

        <div class="fg">
          <label class="lbl">Auth Method</label>
          <select id="lm-add-auth" onchange="lmAuthToggle(this.value)">${authOpts}</select>
        </div>

        <!-- â”€â”€ API KEY BLOCK â”€â”€ -->
        <div id="lm-ab-api_key" style="margin-bottom:0">
          <div class="fg"><label class="lbl">ğŸ”‘ API Key / Bearer Token</label>
            <input type="password" id="lm-c-apikey" placeholder="sk_live_â€¦ or integration token" /></div>
        </div>
        <!-- â”€â”€ USER/PASS BLOCK â”€â”€ -->
        <div id="lm-ab-user_pass" style="display:none">
          <div class="grid2">
            <div class="fg"><label class="lbl">ğŸ‘¤ Username / Email</label>
              <input type="text" id="lm-c-user" placeholder="you@email.com" autocomplete="off" /></div>
            <div class="fg"><label class="lbl">ğŸ”’ Password</label>
              <input type="password" id="lm-c-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off" /></div>
          </div>
        </div>
        <!-- â”€â”€ OAUTH BLOCK â”€â”€ -->
        <div id="lm-ab-oauth" style="display:none">
          <div class="grid2">
            <div class="fg"><label class="lbl">ğŸ”“ Access Token</label>
              <input type="password" id="lm-c-token" placeholder="OAuth access token" /></div>
            <div class="fg"><label class="lbl">ğŸ”“ Refresh Token <span class="xs tm">(optional)</span></label>
              <input type="password" id="lm-c-refresh" placeholder="Refresh token" /></div>
          </div>
        </div>
        <!-- â”€â”€ COOKIE BLOCK â”€â”€ -->
        <div id="lm-ab-cookie" style="display:none">
          <div class="fg"><label class="lbl">ğŸª Cookie String <span class="xs tm">(DevTools â€º Network â€º Request Headers â€º Cookie)</span></label>
            <textarea id="lm-c-cookie" rows="3" placeholder="session_id=abc123; auth_token=xyz456; _csrf=defâ€¦"></textarea></div>
        </div>

        <div class="grid2">
          <div class="fg"><label class="lbl">Niche / Tag</label>
            <input type="text" id="lm-add-niche" placeholder="fitness, finance, techâ€¦" /></div>
          <div class="fg"><label class="lbl">Tier</label>
            <select id="lm-add-tier">${tierOpts}</select></div>
        </div>

        <div class="fg"><label class="lbl">Blog / Site ID <span class="xs tm">(Blogger blog ID, WP site slug, etc.)</span></label>
          <input type="text" id="lm-add-blogid" placeholder="12345678 or my-blog-slug" /></div>

        <div class="fg"><label class="lbl">Target URL <span class="xs tm">(money page this site links to)</span></label>
          <input type="url" id="lm-add-target" placeholder="https://your-money-page.com/keyword" /></div>

        <div class="fg"><label class="lbl">Keywords <span class="xs tm">(one per line Â· used by Quick Post)</span></label>
          <textarea id="lm-add-kws" rows="3" placeholder="best creatine supplement&#10;protein powder 2025&#10;pre workout guide"></textarea></div>

        <div class="fg"><label class="lbl">Notes</label>
          <textarea id="lm-add-notes" rows="2" placeholder="Account notes, login hints, rate limitsâ€¦"></textarea></div>

        <button class="btn btn-primary" style="width:100%;margin-top:4px" onclick="lmAdd()">â• Add Site to Registry</button>
      </div>

      <!-- IMPORT CARD -->
      <div class="card">
        <div class="card-title">ğŸ“¥ Import Sites</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <button class="btn btn-blue" onclick="lmImportW2B()" title="Pull live sites from Web 2.0 Builder results">ğŸ— Web 2.0 Builder</button>
          <button class="btn btn-blue" onclick="lmImportSessions()" title="Pull active sessions from Session Manager">ğŸª Session Manager</button>
        </div>
        <div class="fg">
          <label class="lbl">CSV Import <span class="xs tm">(columns: siteUrl, platform, label, apiKey, username, password, niche, tier, targetUrl)</span></label>
          <textarea id="lm-csv-raw" rows="4" placeholder="siteUrl,platform,label,apiKey,username,password,niche,tier,targetUrl&#10;https://myblog.wordpress.com,wordpress_com,My Blog,my-api-key,,,fitness,tier2,https://money.com"></textarea>
        </div>
        <button class="btn btn-ghost" style="width:100%" onclick="lmImportCSV()">ğŸ“¥ Import from CSV</button>
      </div>

      <!-- LOG CARD -->
      <div class="card">
        <div class="card-title">ğŸ–¥ Activity Log</div>
        <div class="terminal" id="lm-terminal" style="height:180px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">ğŸ”— Links Manager ready â€” ${LM_PLATFORMS.length} platform types Â· add sites below or import from other modules.</span></div>
        </div>
      </div>
    </div>

    <!-- â•â•â• RIGHT COLUMN: TABLE + BROWSER â•â•â• -->
    <div>

      <!-- FILTER + ACTION BAR -->
      <div class="card" style="padding:10px 14px">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input type="text" placeholder="ğŸ” Search label / URL / nicheâ€¦"
            style="flex:2;min-width:150px;font-size:11px;padding:6px 10px"
            oninput="LM_STATE.filter.search=this.value;lmRenderTable()" />
          <select style="flex:1;min-width:110px;font-size:11px;padding:6px 8px"
            onchange="LM_STATE.filter.cat=this.value;lmRenderTable()">
            <option value="">All Categories</option>
            ${cats.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
          <select style="flex:1;min-width:100px;font-size:11px;padding:6px 8px"
            onchange="LM_STATE.filter.tier=this.value;lmRenderTable()">
            <option value="">All Tiers</option>
            ${LM_TIERS.map(t=>`<option value="${t.id}">${t.id.replace('tier','T')}</option>`).join('')}
          </select>
          <select style="flex:1;min-width:110px;font-size:11px;padding:6px 8px"
            onchange="LM_STATE.filter.status=this.value;lmRenderTable()">
            <option value="">All Status</option>
            <option value="active">âœ… Active</option>
            <option value="unverified">âš  Unverified</option>
            <option value="auth_failed">ğŸ” Auth Failed</option>
            <option value="error">âŒ Error</option>
          </select>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center">
          <button id="lm-btn-verify-all" class="btn btn-blue btn-sm" onclick="lmVerifyAll()">ğŸ” Verify All</button>
          <button class="btn btn-ghost btn-sm" onclick="lmVerifySelected()">ğŸ” Verify Selected</button>
          <button class="btn btn-primary btn-sm" onclick="[...LM_STATE.sel].forEach(id=>lmPostBuilder(id))">âš¡ Post to Selected</button>
          <button class="btn btn-ghost btn-sm" onclick="lmExport()">ğŸ“¥ Export CSV</button>
          <button class="btn btn-danger btn-sm" onclick="lmDeleteSelected()">ğŸ—‘ Delete Selected</button>
          <span class="mono xs tm" style="margin-left:auto">${LM_STATE.sites.length} sites registered</span>
        </div>
      </div>

      <!-- REGISTRY TABLE -->
      <div class="card" style="padding:0;overflow:hidden">
        <div style="overflow-x:auto">
          <table style="min-width:860px">
            <thead><tr>
              <th style="width:32px">
                <input type="checkbox" style="width:auto"
                  onchange="if(this.checked)lmFiltered().forEach(s=>LM_STATE.sel.add(s.id));else LM_STATE.sel.clear();lmRenderTable()">
              </th>
              <th style="width:32px"></th>
              <th>Label / Platform</th>
              <th>Site URL / Niche</th>
              <th>Auth</th>
              <th>Status</th>
              <th>Tier / DA</th>
              <th>Posted</th>
              <th style="width:170px">Actions</th>
            </tr></thead>
            <tbody id="lm-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- PLATFORM REFERENCE -->
      <div class="card">
        <div class="card-title">ğŸ“‹ Supported Platforms (${LM_PLATFORMS.length})
          <span style="margin-left:auto">
            ${cats.map(c=>`<span class="badge badge-p" style="font-size:8px;margin-left:4px">${c}</span>`).join('')}
          </span>
        </div>
        <div style="max-height:220px;overflow-y:auto" id="lm-ref-panel"></div>
      </div>

      <!-- INLINE BROWSER -->
      <div id="lm-browser-panel">
        <div class="card">
          <div class="card-title">ğŸŒ Inline Browser</div>
          <div style="padding:36px;text-align:center;color:var(--muted2);font-family:var(--mono);font-size:11px">
            Click <strong>ğŸŒ</strong> on any site to browse it live here â€”<br>log in, navigate, and manage content without leaving the tool.
          </div>
        </div>
      </div>
    </div>
  </div>`;

  // Render platform reference panel
  const ref=document.getElementById('lm-ref-panel');
  if(ref) ref.innerHTML=LM_PLATFORMS.map(p=>`
    <div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${p.icon}</span>
      <div style="flex:1;min-width:0">
        <div class="mono xs" style="font-weight:700;white-space:nowrap">${p.name}
          <span class="badge badge-p" style="font-size:7px;margin-left:4px">${p.cat}</span>
        </div>
        <div style="font-size:9px;color:var(--muted2);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(p.note)}">${p.note}</div>
      </div>
      ${p.da?`<span class="badge ${p.da>=90?'badge-g':p.da>=80?'badge-b':'badge-y'}" style="font-size:8px;white-space:nowrap">DA${p.da}</span>`:`<span class="mono xs tm">Self</span>`}
      <button class="btn btn-ghost btn-xs" style="white-space:nowrap"
        onclick="document.getElementById('lm-add-plat').value='${p.id}';lmUpdatePlatHint('${p.id}');document.getElementById('lm-add-url').focus()">+ Add</button>
    </div>`).join('');

  // sync S.links
  S.links=LM_STATE.sites.filter(s=>s.targetUrl).map(s=>({id:s.id,label:s.label,url:s.siteUrl,target:'both'}));
  updateHeader(); lmRenderTable();

  // init auth fields + platform hint
  setTimeout(()=>{
    lmAuthToggle('api_key');
    lmUpdatePlatHint(document.getElementById('lm-add-plat')?.value||'wordpress_com');
  },50);
}

// â”€â”€â”€ SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSetup(el){
  const pid=S.activePlatform;
  const p=getPlatform(pid);
  const ti=TOKEN_INFO[pid]||{label:'API Token',ph:'your-token',hint:'',link:''};
  const ex=EXTRA_INFO[pid];
  const accs=getAccounts(pid);
  el.innerHTML=`
  <div style="max-width:580px">
    <div class="page-title" style="color:var(--accent)">${p.icon} ${esc(p.name)}</div>
    <div class="page-sub">// ${esc(p.desc)} Â· DA ${p.da}</div>
    ${accs.length?`<div class="card"><div class="card-title">Connected Accounts</div>
      ${accs.map(a=>`<div class="flex aic g8" style="padding:8px 0;border-bottom:1px solid var(--border)">
        ${a.avatar?`<img src="${esc(a.avatar)}" style="width:22px;height:22px;border-radius:50%">`:''}
        <span class="mono sm ta">@${esc(a.login)}</span>
        ${a.extra?`<span class="mono xs tm">(${esc(a.extra)})</span>`:''}
        <span class="badge badge-g" style="margin-left:auto">ACTIVE</span>
        <button class="btn btn-danger btn-sm" onclick="removeAccount('${a.id}','${pid}')">âœ•</button>
      </div>`).join('')}
    </div>`:''}
    <div class="card">
      <div class="card-title">Connect ${esc(p.name)} Account</div>
      <div class="fg">
        <label class="lbl">${esc(ti.label)}</label>
        <input type="password" id="setup-token" placeholder="${esc(ti.ph)}"/>
        <p class="xs mono tm" style="margin-top:5px;line-height:1.7">${esc(ti.hint)}</p>
      </div>
      ${ex?`<div class="fg"><label class="lbl">${esc(ex.label)}</label><input type="text" id="setup-extra" placeholder="${esc(ex.ph)}"/></div>`:''}
      <div class="flex aic g8">
        <button class="btn btn-primary" id="setup-btn" onclick="connectAccount('${pid}')">â†’ Connect Account</button>
        ${ti.link?`<a href="${esc(ti.link)}" target="_blank" rel="noreferrer" class="btn btn-ghost btn-sm">Get Token â†—</a>`:''}
      </div>
      <div id="setup-msg" style="margin-top:8px;font-family:var(--mono);font-size:10px"></div>
    </div>
    <div class="card">
      <div class="card-title">Platform Info</div>
      <div style="font-family:var(--mono);font-size:12px;line-height:2.2;color:var(--text);font-weight:600">
        <div><span class="ta">âœ“</span> Domain Authority: <span class="ta">${p.da}</span></div>
        <div><span class="ta">âœ“</span> Domain: <span class="ta">${p.domain}</span></div>
        <div><span class="ta">âœ“</span> API: <span class="ta">${esc(p.api)}</span></div>
        <div><span class="ta">âœ“</span> ${esc(p.desc)}</div>
      </div>
    </div>
  </div>`;
  const tokenEl=document.getElementById('setup-token');
  if(tokenEl) tokenEl.addEventListener('keydown',e=>{ if(e.key==='Enter') connectAccount(pid); });
}

async function connectAccount(pid){
  const tokenEl=document.getElementById('setup-token');
  const extraEl=document.getElementById('setup-extra');
  const msgEl=document.getElementById('setup-msg');
  const btn=document.getElementById('setup-btn');
  if(!tokenEl||!msgEl||!btn) return;
  const token=tokenEl.value.trim();
  const extra=extraEl?extraEl.value.trim():'';
  if(!token){ msgEl.innerHTML='<span class="tr">Token required</span>'; return; }
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Connecting...';
  msgEl.innerHTML='';
  try{
    let userInfo={login:'unknown',avatar:'',id:uid()};
    if(pid==='github'){ const api=new GitHubAPI(token); const u=await api.getUser(); userInfo={login:u.login,avatar:u.avatar_url,id:String(u.id)}; }
    else if(pid==='gitlab'){ const api=new GitLabAPI(token); const u=await api.getUser(); userInfo={login:u.username,avatar:u.avatar_url,id:String(u.id)}; }
    else if(pid==='netlify'){ const api=new NetlifyAPI(token); const u=await api.getUser(); userInfo={login:u.slug||u.email||'netlify-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='vercel'){ const api=new VercelAPI(token); const u=await api.getUser(); userInfo={login:(u.user&&(u.user.username||u.user.email))||'vercel-user',avatar:'',id:(u.user&&u.user.id)||uid()}; }
    else if(pid==='notion'){ const api=new NotionAPI(token); const u=await api.getUser(); userInfo={login:u.name||(u.bot&&u.bot.owner&&u.bot.owner.user&&u.bot.owner.user.name)||'notion-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='medium'){ const api=new MediumAPI(token); const u=await api.getUser(); userInfo={login:(u.data&&u.data.username)||'medium-user',avatar:(u.data&&u.data.imageUrl)||'',id:(u.data&&u.data.id)||uid()}; }
    else if(pid==='hashnode'){ const api=new HashnodeAPI(token); const u=await api.getUser(); userInfo={login:(u.me&&u.me.username)||'hashnode-user',avatar:'',id:(u.me&&u.me.id)||uid()}; }
    else if(pid==='reddit'){ const api=new RedditAPI(token); const u=await api.getMe(); userInfo={login:u.name||'reddit-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='blogger'){ const api=new BloggerAPI(token); const blogs=await api.listBlogs(); const b=blogs.items&&blogs.items[0]; userInfo={login:b&&b.name||'blogger-user',avatar:'',id:b&&b.id||uid()}; }
    else if(pid==='substack'){ userInfo={login:extra||'substack-user',avatar:'',id:uid()}; }
    else if(pid==='wordpress'){ const api=new WordPressAPI(token); const u=await api.getMe(); userInfo={login:u.username||u.login||'wp-user',avatar:u.avatar_URL||'',id:String(u.ID||uid())}; }
    else if(pid==='devto'){ const api=new DevToAPI(token); const u=await api.getUser(); userInfo={login:u.username||'devto-user',avatar:u.profile_image||'',id:String(u.id||uid())}; }
    else if(pid==='tumblr'){ const api=new TumblrAPI(token,extra||'blog'); const u=await api.getUser(); userInfo={login:(u.response&&u.response.user&&u.response.user.name)||extra||'tumblr-user',avatar:'',id:uid()}; }
    else if(pid==='ghost'){ const api=new GhostAPI(token,extra); const s=await api.getSite(); userInfo={login:(s.site&&s.site.url&&s.site.url.replace('https://','').split('.')[0])||'ghost-user',avatar:'',id:uid()}; }
    else if(pid==='wix'){ userInfo={login:extra||'wix-user',avatar:'',id:uid()}; }
    else if(pid==='telegraph'){ const api=new TelegraphAPI(token); const a=await api.getAccount(); userInfo={login:a.short_name||'telegraph-user',avatar:'',id:uid()}; }
    else if(pid==='codepen'){ userInfo={login:token||'codepen-user',avatar:'',id:uid()}; }
    else if(pid==='replit'){ const api=new ReplitAPI(token); const u=await api.getUser(); userInfo={login:(u&&u.currentUser&&u.currentUser.username)||'replit-user',avatar:'',id:uid()}; }
    else if(pid==='cloudflare'){ const api=new CloudflareAPI(token,extra); const u=await api.getUser(); userInfo={login:u.email||'cf-user',avatar:'',id:u.id||uid()}; }
    else if(pid==='issuu'){ userInfo={login:extra||'issuu-user',avatar:'',id:uid()}; }
    // â”€â”€ NEW PLATFORMS (username-based, no verify API) â”€â”€
    else if(pid==='onfeetnation'||pid==='caribbeanfever'||pid==='click4r'||pid==='techplanet'||pid==='writeonwall'||pid==='taylorhicks'||pid==='snaplant'||pid==='theprose'){
      if(!extra) throw new Error('Password is required for '+getPlatform(pid).name);
      userInfo={login:token,avatar:'',id:uid()};
    }
    else if(pid==='bitbin'||pid==='pastelink'||pid==='ideone'||pid==='controlc'||pid==='rentry'||
            pid==='rentryorg'||pid==='dpaste'||pid==='hastebin'||pid==='writeas'||pid==='justpaste'||pid==='zerobin'){
      userInfo={login:token||'anonymous',avatar:'',id:uid()};
    }
    else if(pid==='pastebin'||pid==='pastee'){
      // These need an API key stored as token; label it clearly
      if(!token) throw new Error(getPlatform(pid).name+': API key is required â€” enter it in the Token field');
      userInfo={login:'apikey-user',avatar:'',id:uid()};
    }
    else if(pid==='ghgist'){
      // Reuses GitHub account â€” just validate one exists
      const ghAcc=S.accounts.find(a=>a.platform==='github');
      if(!ghAcc) throw new Error('GitHub Gist reuses your GitHub Pages account â€” connect GitHub Pages first in Setup');
      userInfo={login:ghAcc.login,avatar:ghAcc.avatar,id:uid()};
    }
    else if(pid==='hackmd'){
      if(!token) throw new Error('HackMD: API token required â€” create one in HackMD Settings â†’ API');
      userInfo={login:'hackmd-user',avatar:'',id:uid()};
    }
    else if(pid==='vingle'){ userInfo={login:token||'vingle-user',avatar:'',id:uid()}; }
    else if(pid==='deviantart'){ userInfo={login:extra||token||'deviantart-user',avatar:'',id:uid()}; }
    if(S.accounts.find(a=>a.platform===pid&&a.login===userInfo.login)){ msgEl.innerHTML='<span class="tr">Account already added.</span>'; btn.disabled=false; btn.textContent='â†’ Connect Account'; return; }
    S.accounts.push({...userInfo,token,extra,platform:pid,addedAt:Date.now()});
    msgEl.innerHTML=`<span class="ta">âœ“ Connected @${esc(userInfo.login)} to ${esc(getPlatform(pid).name)}</span>`;
    if(tokenEl) tokenEl.value=''; if(extraEl) extraEl.value='';
    updateHeader(); updatePlatformBar(); renderSetup(document.getElementById('page-setup'));
  }catch(e){
    msgEl.innerHTML=`<span class="tr">âœ— ${esc(e.message||'Connection failed')}</span>`;
  }
  btn.disabled=false; btn.textContent='â†’ Connect Account';
}
function removeAccount(id,pid){ S.accounts=S.accounts.filter(a=>!(a.id===id&&a.platform===pid)); updateHeader(); updatePlatformBar(); renderSetup(document.getElementById('page-setup')); }

// â”€â”€â”€ CAMPAIGN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Platform posting strategy meta
const PLATFORM_META = {
  github:    {type:'file',    label:'Repo Prefix',      ph:'seo',                      hint:'Creates a GitHub repo + Pages site. Each keyword gets its own repo with README.md + index.html.',          defVal:'seo'},
  gitlab:    {type:'file',    label:'Repo Prefix',      ph:'seo',                      hint:'Creates a GitLab project + CI pipeline â†’ Pages deployment. Takes ~2-5 min to go live.',                   defVal:'seo'},
  netlify:   {type:'file',    label:'Site Name Prefix', ph:'seo',                      hint:'Creates a new Netlify site and deploys index.html to a unique subdomain.netlify.app URL.',                defVal:'seo'},
  vercel:    {type:'file',    label:'Project Prefix',   ph:'seo',                      hint:'Deploys a static index.html to a new Vercel project with a vercel.app subdomain.',                        defVal:'seo'},
  cloudflare:{type:'file',    label:'Project Prefix',   ph:'seo',                      hint:'Creates a Cloudflare Pages project and uploads index.html. Goes live at project.pages.dev.',              defVal:'seo'},
  github_pages_existing:{type:'file'},
  medium:    {type:'cms',     label:'Article Tags',     ph:'seo,guide,marketing',      hint:'Publishes a formatted Markdown article to your Medium account. Max 5 tags.',                             defVal:'seo,guide'},
  substack:  {type:'cms',     label:'Subdomain',        ph:'yourpublication',          hint:'Publishes a newsletter post to your Substack. Requires your Substack subdomain (yourname.substack.com).', defVal:''},
  wordpress: {type:'cms',     label:'Post Tags',        ph:'seo,guide',                hint:'Creates and publishes a post to your WordPress.com site via the REST API.',                               defVal:'seo,guide'},
  blogger:   {type:'cms',     label:'Blog ID',          ph:'1234567890123456789',      hint:'Publish a post to your Blogger/Blogspot blog. Find your Blog ID in Blogger Settings.',                   defVal:''},
  devto:     {type:'cms',     label:'Tags (max 4)',     ph:'webdev,seo,javascript',    hint:'Publishes a developer article to dev.to. Tags must be lowercase, no spaces, max 4.',                     defVal:'webdev,seo'},
  hashnode:  {type:'cms',     label:'Publication ID',   ph:'64a6b...',                 hint:'Publishes to your Hashnode blog. Get the Publication ID from your Hashnode dashboard Settings.',         defVal:''},
  reddit:    {type:'post',    label:'Subreddit',        ph:'entrepreneur',             hint:'Submits a text post to the specified subreddit. Account needs karma to avoid spam filters.',              defVal:'entrepreneur'},
  tumblr:    {type:'cms',     label:'Blog Identifier',  ph:'yourblog.tumblr.com',      hint:'Posts to your Tumblr blog. Use your blog URL or just the name (yourblog).',                             defVal:''},
  ghost:     {type:'cms',     label:'Ghost Blog URL',   ph:'https://yourblog.ghost.io',hint:'Publishes to your self-hosted Ghost CMS. Requires the Ghost Admin API key (id:secret format).',         defVal:''},
  notion:    {type:'page',    label:'Parent Page ID',   ph:'abc123... (32 char hex)',  hint:'Creates a Notion page inside the specified parent page. Get the ID from the page URL.',                  defVal:''},
  wix:       {type:'cms',     label:'Site ID',          ph:'your-wix-site-id',         hint:'Publishes a blog post to your Wix site via the Wix Blog v3 API.',                                      defVal:''},
  telegraph: {type:'page',    label:'Author Name',      ph:'Your Name',                hint:'Creates an instant anonymous page on Telegra.ph. No further setup needed â€” goes live instantly.',       defVal:''},
  codepen:   {type:'prefill', label:'CodePen Username', ph:'yourusername',             hint:'Generates a CodePen prefill URL. Click the link to open the editor with content pre-loaded, then Save.', defVal:''},
  replit:    {type:'file',    label:'Repl Prefix',      ph:'seo',                      hint:'Creates a new public HTML Repl on your Replit account.',                                                 defVal:'seo'},
  issuu:        {type:'doc',     label:'Issuu Username',   ph:'yourusername',             hint:'Creates a publication draft on Issuu. Upload a PDF through the Issuu dashboard to complete publishing.',  defVal:''},
  // â”€â”€ NEW PLATFORMS â”€â”€
  onfeetnation: {type:'post',    label:'Password',         ph:'your-password',            hint:'Creates a photo album post on OnFeetNation. Requires username + password.',        defVal:''},
  caribbeanfever:{type:'post',   label:'Password',         ph:'your-password',            hint:'Creates a photo album post on CaribbeanFever. Requires username + password.',     defVal:''},
  bitbin:       {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous public paste on Bitbin.it. No account needed.',              defVal:'seo-paste'},
  pastelink:    {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous public paste on Pastelink.net. No account needed.',          defVal:'seo-paste'},
  click4r:      {type:'cms',     label:'Password',         ph:'your-password',            hint:'Publishes a blog post on Click4R. Requires your username + password.',            defVal:''},
  ideone:       {type:'page',    label:'Label',            ph:'seo-snippet',              hint:'Creates a public text paste on Ideone.com. No account needed.',                   defVal:'seo-snippet'},
  controlc:     {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous paste on ControlC.com. No account needed.',                  defVal:'seo-paste'},
  rentry:       {type:'page',    label:'Edit Code',        ph:'leave blank for random',   hint:'Creates a Markdown page on Rentry.co. Edit code is optional.',                    defVal:''},
  techplanet:   {type:'cms',     label:'Password',         ph:'your-password',            hint:'Publishes a post on TechPlanet.today. Requires username + password.',             defVal:''},
  vingle:       {type:'cms',     label:'Interest ID',      ph:'interest-id',              hint:'Publishes a card to Vingle via access token. Get interest ID from your profile.', defVal:''},
  writeonwall:  {type:'post',    label:'Password',         ph:'your-password',            hint:'Submits a question post on WriteOnWall. Requires username + password.',           defVal:''},
  taylorhicks:  {type:'post',    label:'Password',         ph:'your-password',            hint:'Posts to TaylorHicks Ning forum. Requires Ning API key + password.',              defVal:''},
  snaplant:     {type:'post',    label:'Password',         ph:'your-password',            hint:'Submits a question on Snaplant Q&A. Requires username + password.',               defVal:''},
  theprose:     {type:'cms',     label:'Password',         ph:'your-password',            hint:'Publishes a post on TheProse. Requires username + session token/password.',       defVal:''},
  deviantart:   {type:'cms',     label:'Username',         ph:'your-username',            hint:'Publishes a journal entry to DeviantArt via OAuth2 access token.',                defVal:''},
  // â”€â”€ PASTE SITES â”€â”€
  pastebin:     {type:'page',    label:'Pastebin API Key', ph:'your-api-key',             hint:'Get a free API key at pastebin.com/doc_api â€” required for paste creation.',       defVal:''},
  dpaste:       {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an anonymous public paste on dpaste.org. No account needed.',             defVal:'seo-paste'},
  hastebin:     {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Creates an instant paste on Hastebin. No account or login required.',             defVal:'seo-paste'},
  writeas:      {type:'page',    label:'Label',            ph:'seo-post',                 hint:'Publishes an anonymous post on Write.as. No account needed â€” goes live instantly.',defVal:'seo-post'},
  pastee:       {type:'page',    label:'Paste.ee API Key', ph:'your-api-key',             hint:'Get a free API key at paste.ee â€” required. Create a paste with title + content.', defVal:''},
  justpaste:    {type:'page',    label:'Edit Code',        ph:'leave blank for random',   hint:'Publishes an anonymous article on JustPaste.it via form POST. No account needed.',defVal:''},
  zerobin:      {type:'page',    label:'Label',            ph:'seo-paste',                hint:'Submits an encrypted paste to 0bin.net. Client-side AES encrypted. No login.',    defVal:'seo-paste'},
  rentryorg:    {type:'page',    label:'Edit Code',        ph:'leave blank for random',   hint:'Creates a Markdown page on Rentry.org (same API as rentry.co). Edit code optional.',defVal:''},
  ghgist:       {type:'page',    label:'Gist Description', ph:'SEO guide',                hint:'Creates a public GitHub Gist. Reuses your connected GitHub account token.',        defVal:'SEO guide'},
  hackmd:       {type:'page',    label:'HackMD API Token', ph:'your-api-token',           hint:'Create an API token in HackMD Settings â†’ API. Publishes a public Markdown note.', defVal:''},
};
const TYPE_LABELS={
  file:    {badge:'badge-b',  text:'Index File Upload',  desc:'Creates a subdomain and uploads an index.html file'},
  article: {badge:'badge-g',  text:'Article / Post',     desc:'Publishes an article or blog post via API'},
  post:    {badge:'badge-y',  text:'Community Post',     desc:'Submits a text post to a community platform'},
  page:    {badge:'badge-p',  text:'Page Creation',      desc:'Creates a web page or document'},
  prefill: {badge:'badge-b',  text:'Prefill URL',        desc:'Generates a pre-filled editor URL to publish manually'},
  doc:     {badge:'badge-r',  text:'Document Draft',     desc:'Creates a document draft for manual PDF upload'},
};

function renderCampaign(el){
  const pid=S.activePlatform;
  const p=getPlatform(pid);
  const meta=PLATFORM_META[pid]||{type:'article',label:'Extra',ph:'',hint:'',defVal:''};
  const typeInfo=TYPE_LABELS[meta.type]||TYPE_LABELS.article;
  const accs=getAccounts(pid);
  if(!accs.length){
    el.innerHTML=`
    <div class="page-title">${p.icon} ${esc(p.name)} Campaign</div>
    <div class="notice notice-warn">âš  No account connected for ${esc(p.name)}. Go to <strong>Setup / Connect</strong> in the sidebar and add your credentials first.</div>
    <div class="card"><div class="card-title">How ${esc(p.name)} Works</div>
    <div style="font-family:var(--mono);font-size:12px;line-height:2.2;color:var(--text);font-weight:600">
      <div><span class="badge ${typeInfo.badge}" style="margin-right:8px">${esc(typeInfo.text)}</span>${esc(typeInfo.desc)}</div>
      <div style="margin-top:10px;color:var(--text)">${esc(meta.hint||p.desc)}</div>
    </div></div>`;
    return;
  }
  el.innerHTML=`
  <div class="page-title">${p.icon} ${esc(p.name)} Campaign</div>
  <div class="page-sub">// ${esc(p.desc)} Â· DA ${p.da}</div>
  <div class="grid4" style="margin-bottom:18px">
    ${statBox(S.keywords.length,'Keywords','g')}
    ${statBox(S.campaigns.filter(c=>c.platform===pid&&c.status==='success').length,'Live','b')}
    ${statBox(S.campaigns.filter(c=>c.platform===pid&&c.status==='error').length,'Failed','r')}
    ${statBox(accs.length,'Accounts','y')}
  </div>

  <div class="notice notice-info" style="margin-bottom:14px">
    <span class="badge ${typeInfo.badge}" style="margin-right:8px">${esc(typeInfo.text)}</span>
    <strong>${esc(p.name)} posting method:</strong> ${esc(meta.hint||p.desc)}
  </div>

  ${pid==='reddit'?`<div class="notice notice-warn">âš  Reddit enforces strict rate limits and spam detection. Post only to relevant, active subreddits. Your account must have sufficient karma.</div>`:''}
  ${pid==='codepen'?`<div class="notice notice-info">â„¹ CodePen has no public write API. After running, click each generated URL to open the editor with your content pre-loaded â€” then press Save.</div>`:''}
  ${pid==='issuu'?`<div class="notice notice-info">â„¹ Issuu creates a publication draft via API. You must upload a PDF file through the Issuu dashboard to complete and publish each draft.</div>`:''}
  ${pid==='github'||pid==='gitlab'?`<div class="notice notice-info">â„¹ ${pid==='github'?'GitHub Pages':'GitLab Pages'} may take a few minutes to go live after deployment. ${pid==='gitlab'?'GitLab CI pipeline runs first (~2â€“5 min).':''}</div>`:''}

  <div class="card">
    <div class="card-title">Campaign Settings</div>
    <div class="grid${pid==='substack'||pid==='notion'||pid==='blogger'||pid==='hashnode'||pid==='ghost'||pid==='wix'?'2':'3'}">
      <div class="fg mb0"><label class="lbl">Account</label>
        <select id="camp-acc">${accs.map((a,i)=>`<option value="${i}">@${esc(a.login)}</option>`).join('')}</select></div>
      <div class="fg mb0"><label class="lbl">${esc(meta.label)}</label>
        <input type="text" id="camp-extra" placeholder="${esc(meta.ph)}" value="${esc(meta.defVal)}"/>
        ${meta.hint?`<p class="xs mono tm" style="margin-top:4px;line-height:1.6">${esc(meta.hint.slice(0,120))}</p>`:''}
      </div>
      ${!(pid==='substack'||pid==='notion'||pid==='blogger'||pid==='hashnode'||pid==='ghost'||pid==='wix')?`
      <div class="fg mb0"><label class="lbl">Delay Between Posts (sec)</label>
        <input type="number" id="camp-delay" value="${pid==='reddit'?10:pid==='medium'?6:4}" min="1" max="300"/>
        <p class="xs mono tm" style="margin-top:4px">${pid==='reddit'?'Reddit needs longer delays to avoid bans':'Longer delays reduce rate-limit errors'}</p>
      </div>`:''}
    </div>
    ${pid==='substack'||pid==='notion'||pid==='blogger'||pid==='hashnode'||pid==='ghost'||pid==='wix'?`
    <div class="fg mt8 mb0"><label class="lbl">Delay Between Posts (sec)</label>
      <input type="number" id="camp-delay" value="5" min="1" max="300" style="max-width:120px"/></div>`:''}
    ${pid==='devto'?`<div class="fg mt8"><label class="lbl">Tags (lowercase, no spaces, max 4 â€” comma separated)</label><input type="text" id="camp-tags" value="webdev,seo,javascript,tutorial" placeholder="webdev,seo,javascript"/></div>`:''}
    ${pid==='cloudflare'?`<div class="fg mt8"><label class="lbl">Cloudflare Account ID (from dashboard URL)</label><input type="text" id="camp-cfacct" placeholder="your-cloudflare-account-id" value="${accs[0]&&accs[0].extra||''}"/></div>`:''}
  </div>

  ${renderContentFields(pid,'camp')}

  <div class="card">
    <div class="card-title">Run Campaign</div>
    <div class="flex aic g8 mt0">
      <button class="btn btn-primary" id="camp-run-btn" onclick="runCampaign('${pid}')">â–¶ Run Campaign â€” ${S.keywords.length} keyword(s)</button>
      <div class="prog-wrap f1" style="margin:0;display:none" id="camp-prog-wrap"><div class="prog-fill" id="camp-prog"></div></div>
    </div>
  </div>
  <div id="camp-urls"></div>
  <div class="card">
    <div class="card-title flex aic g8">Terminal<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="document.getElementById('camp-term').innerHTML='<span class=tm>// Cleared</span>'">Clear</button></div>
    <div class="terminal" id="camp-term"><span class="tm">// Output will appear here once you run the campaign...</span></div>
  </div>`;
}


async function runCampaign(pid){
  if(!S.keywords.length){ toast('Add keywords first in the Keywords page.','w'); return; }
  syncContentFields('camp'); // sync all content fields from DOM before run
  const btn=document.getElementById('camp-run-btn');
  const termEl=document.getElementById('camp-term');
  const progWrap=document.getElementById('camp-prog-wrap');
  const progBar=document.getElementById('camp-prog');
  const urlsEl=document.getElementById('camp-urls');
  const accIdx=parseInt(document.getElementById('camp-acc').value)||0;
  const extraVal=(document.getElementById('camp-extra')||{value:''}).value.trim();
  const delayVal=parseInt((document.getElementById('camp-delay')||{value:4}).value)||4;
  const accs=getAccounts(pid);
  const account=accs[accIdx];
  if(!account) return;
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Running...';
  progWrap.style.display='block'; setProgress(progBar,0);
  termEl.innerHTML='';
  urlsEl.innerHTML='';
  const term=makeTerminal(termEl);
  const liveUrls=[];

  for(let i=0;i<S.keywords.length;i++){
    const kw=S.keywords[i];
    setProgress(progBar, Math.round(i/S.keywords.length*100));
    try{
      const url=await runSingleCampaign(pid,kw,account,extraVal,i,term);
      if(url){
        term.add('  âœ“ Live: '+url,'info');
        liveUrls.push({url,keyword:kw,platform:pid});
        const result={id:uid(),platform:pid,keyword:kw,repo:slug(extraVal+'-'+kw),url,status:'success',ts:ts()};
        S.campaigns=S.campaigns.filter(c=>!(c.platform===pid&&c.keyword===kw));
        S.campaigns.push(result);
        // Auto-submit to indexers if enabled
        if(settingGet('auto_index_on_publish')&&url){
          autoSubmitToIndexers(url,term).catch(()=>{});
        }
        urlsEl.innerHTML=`<div class="card slide-in"><div class="card-title">ğŸš€ Live URLs</div>${liveUrls.map(u=>urlBannerHTML(u.url,u.keyword,u.platform)).join('')}</div>`;
      }
    }catch(e){
      term.add('  âœ— Failed: '+e.message,'error');
      S.campaigns.push({id:uid(),platform:pid,keyword:kw,repo:slug((extraVal||'seo')+'-'+kw),url:'',status:'error',ts:ts(),error:e.message});
    }
    if(i<S.keywords.length-1) await sleep(delayVal*1000);
  }
  setProgress(progBar,100);
  term.add('Campaign complete: '+liveUrls.length+'/'+S.keywords.length+' succeeded','info');
  btn.disabled=false; btn.textContent='â–¶ Run Campaign';
  updateHeader(); updatePlatformBar();
}

// Wrapper around bcProxyFetch that logs which proxy was used to terminal
// Use this for all paste/anonymous site requests instead of raw fetch()
async function pasteProxyFetch(url, opts, term){
  const r = await bcProxyFetch(url, opts);
  if(term && r.proxy) term.add('    [proxy: '+r.proxy+']','info');
  if(!r.ok && r.error==='All proxies exhausted'){
    throw new Error('All CORS proxies failed for '+new URL(url).hostname+' â€” site may block proxies. Try again or add a custom proxy in Blog Commenter settings.');
  }
  return r;
}

async function runSingleCampaign(pid, kw, account, extraVal, idx, term){
  const p=getPlatform(pid);
  const sl=slug((extraVal||'seo')+'-'+kw);
  // Resolve all content fields once for this keyword
  const _ec=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,p.domain);
  const _tags=_ec.tags.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
  const _category=_ec.category||'General';
  term.add(`[${idx+1}/${S.keywords.length}] ${p.icon} ${p.name}: "${kw}"`, 'info');

  // â”€â”€ FILE-BASED PLATFORMS (subdomain + index.html) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='github'){
    // GitHub Pages: create repo â†’ push README.md + index.html + sitemap.xml â†’ enable Pages
    const api=new GitHubAPI(account.token);
    const repoName=slug((extraVal||'seo')+'-'+kw).slice(0,100)||'seo-page';
    const pageUrl='https://'+account.login+'.github.io/'+repoName+'/';
    try{ await api.createRepo(repoName,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title); await sleep(1500); }
    catch(e){
      if(e.message.includes('already exists')||e.message.includes('422')||e.message.includes('name already exists')){
        term.add('  Repo exists â€” updating content','warn');
      } else throw e;
    }
    await sleep(1000);
    const readme=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'github.io').body;
    const html=generateHtmlPage(kw,account.login,repoName,S.links,'github');
    const sitemap=`<?xml version="1.0"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"><url><loc>${pageUrl}</loc><lastmod>${new Date().toISOString().split('T')[0]}</lastmod><priority>1.0</priority></url></urlset>`;
    const existRM=await api.getFile(account.login,repoName,'README.md');
    await api.putFile(account.login,repoName,'README.md',readme,'SEO: update README',existRM&&existRM.sha||null);
    await sleep(500);
    const existIdx=await api.getFile(account.login,repoName,'index.html');
    await api.putFile(account.login,repoName,'index.html',html,'SEO: add index',existIdx&&existIdx.sha||null);
    await sleep(500);
    const existSm=await api.getFile(account.login,repoName,'sitemap.xml');
    await api.putFile(account.login,repoName,'sitemap.xml',sitemap,'SEO: add sitemap',existSm&&existSm.sha||null);
    await sleep(500);
    await api.enablePages(account.login,repoName).catch(()=>{});
    await api.updateTopics(account.login,repoName,[slug(kw),'seo','guide']).catch(()=>{});
    term.add('  âœ“ GitHub Pages: '+pageUrl,'info');
    return pageUrl;
  }

  if(pid==='gitlab'){
    // GitLab Pages: create project â†’ push index.html + README + .gitlab-ci.yml â†’ CI deploys Pages
    const api=new GitLabAPI(account.token);
    const projSlug=slug((extraVal||'seo')+'-'+kw).slice(0,100)||'seo-page';
    const pageUrl='https://'+account.login+'.gitlab.io/'+projSlug+'/';
    let proj;
    try{ proj=await api.createProject(projSlug,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title); await sleep(1500); }
    catch(e){
      if(e.message&&(e.message.includes('already been taken')||e.message.includes('already exists'))){
        term.add('  Project exists â€” updating content','warn');
        proj={id:null,name:projSlug}; // will fail on file ops but user can handle
      } else throw e;
    }
    const readme=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'gitlab.io').body;
    const html=generateHtmlPage(kw,account.login,projSlug,S.links,'gitlab');
    // CI pipeline: copy index.html into /public, enable Pages artifact
    const ci=`image: alpine\npages:\n  stage: deploy\n  script:\n    - mkdir -p public\n    - cp index.html public/index.html\n  artifacts:\n    paths:\n      - public\n  rules:\n    - if: $CI_COMMIT_BRANCH == "main"\n`;
    if(proj.id){
      await api.createOrUpdateFile(proj.id,'README.md',readme,'SEO: add README').catch(e=>term.add('  warn: '+e.message,'warn'));
      await sleep(400);
      await api.createOrUpdateFile(proj.id,'index.html',html,'SEO: add index.html').catch(e=>term.add('  warn: '+e.message,'warn'));
      await sleep(400);
      await api.createOrUpdateFile(proj.id,'.gitlab-ci.yml',ci,'SEO: add CI pipeline').catch(e=>term.add('  warn: '+e.message,'warn'));
      await api.enablePages(proj.id).catch(()=>{});
    }
    term.add('  â„¹ GitLab CI will deploy Pages in ~2-5 minutes','warn');
    return pageUrl;
  }

  if(pid==='netlify'){
    // Netlify: create site â†’ deploy with index.html file via SHA1 manifest
    const api=new NetlifyAPI(account.token);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'netlify');
    const siteName=sl.slice(0,63).replace(/[^a-z0-9-]/g,'-').replace(/^-|-$/g,'')||'seo-site';
    term.add('  Creating Netlify site...','info');
    const site=await api.createSite(siteName);
    await sleep(1000);
    term.add('  Uploading index.html...','info');
    await api.deploySite(site.id,html);
    const siteUrl='https://'+(site.subdomain||site.name||siteName)+'.netlify.app/';
    return siteUrl;
  }

  if(pid==='vercel'){
    // Vercel: create deployment with index.html encoded as base64
    const api=new VercelAPI(account.token);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'vercel');
    const projName=sl.slice(0,52)||'seo-page';
    term.add('  Deploying to Vercel...','info');
    const dep=await api.createDeployment(projName,html);
    const depUrl=(dep.url)||sl+'.vercel.app';
    return 'https://'+(depUrl.startsWith('https://')?depUrl.replace('https://',''):depUrl)+'/';
  }

  if(pid==='cloudflare'){
    // Cloudflare Pages: create project â†’ upload index.html via multipart deploy
    const acctId=(document.getElementById('camp-cfacct')||{value:''}).value.trim()||account.extra||'';
    if(!acctId) throw new Error('Cloudflare Account ID is required â€” enter it in the Campaign Settings above.');
    const api=new CloudflareAPI(account.token,acctId);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'cloudflare');
    const projName=sl.slice(0,28).replace(/[^a-z0-9-]/g,'-').replace(/^-|-$/g,'')||'seo-page';
    term.add('  Creating Cloudflare Pages project...','info');
    let proj;
    try{ proj=await api.createProject(projName); }
    catch(e){ if(e.message.includes('already exists')||e.message.includes('409')){ proj={name:projName}; }else throw e; }
    await sleep(1000);
    term.add('  Uploading index.html to Cloudflare Pages...','info');
    const deploy=await api.uploadPages(proj.name||projName,html);
    return deploy&&deploy.url?'https://'+deploy.url:'https://'+projName+'.pages.dev';
  }

  if(pid==='replit'){
    // Replit: create a public HTML Repl via GraphQL â†’ returns the Repl URL
    const api=new ReplitAPI(account.token);
    const replSlug=sl.slice(0,40)||'seo-page';
    term.add('  Creating Repl...','info');
    const res=await api.createRepl(kw+' SEO Guide '+year(),replSlug);
    const repl=res&&res.createRepl&&res.createRepl.repl;
    return repl&&repl.url?'https://replit.com'+repl.url:'https://replit.com/@'+account.login+'/'+replSlug;
  }

  // â”€â”€ ARTICLE / POST PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='medium'){
    // Medium: publish a Markdown article via Integration Token
    const api=new MediumAPI(account.token);
    term.add('  Getting Medium user ID...','info');
    const u=await api.getUser();
    const userId=u.data&&u.data.id; if(!userId) throw new Error('Could not get Medium user ID â€” check your Integration Token');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'medium.com').body;
    const tags=(extraVal||'seo,guide').split(',').map(t=>t.trim()).filter(Boolean).slice(0,5);
    term.add('  Publishing article...','info');
    const res=await api.createPost(userId,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content,tags);
    return (res.data&&res.data.url)||'https://medium.com/@'+account.login;
  }

  if(pid==='substack'){
    // Substack: publish a post using session cookie token + subdomain
    const subdomain=extraVal||account.extra||account.login||'';
    if(!subdomain) throw new Error('Substack subdomain is required (e.g. "yourname" from yourname.substack.com)');
    const api=new SubstackAPI(account.token,subdomain);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'substack');
    term.add('  Publishing to Substack ('+subdomain+'.substack.com)...','info');
    const res=await api.createPost(getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,html);
    return res.url||res.canonical_url||'https://'+subdomain+'.substack.com';
  }

  if(pid==='wordpress'){
    // WordPress.com: get site ID â†’ publish post with HTML content
    const api=new WordPressAPI(account.token);
    term.add('  Getting WordPress sites...','info');
    const sites=await api.getSites();
    const siteId=sites.sites&&sites.sites[0]&&sites.sites[0].ID;
    if(!siteId) throw new Error('No WordPress.com site found on this account');
    const html=generateHtmlPage(kw,account.login,sl,S.links,'wordpress');
    const tags=(extraVal||'seo,guide').split(',').map(t=>t.trim()).filter(Boolean);
    term.add('  Publishing post...','info');
    const res=await api.createPost(siteId,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,html,tags);
    return res.URL||res.link||'https://wordpress.com';
  }

  if(pid==='blogger'){
    // Blogger: publish an HTML post to the specified blog ID
    const api=new BloggerAPI(account.token);
    const blogId=extraVal||account.extra||account.id||'';
    if(!blogId) throw new Error('Blogger Blog ID is required â€” find it in Blogger Settings â†’ Blog ID');
    const html=generateHtmlPage(kw,account.login,sl,S.links,'blogger');
    term.add('  Publishing to Blogger...','info');
    const res=await api.createPost(blogId,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,html,_tags.slice(0,5));
    return res.url||'https://blogger.com';
  }

  if(pid==='devto'){
    // Dev.to: publish a Markdown article via API key
    const api=new DevToAPI(account.token);
    const tags=_tags.slice(0,4);
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'dev.to').body;
    term.add('  Publishing article to Dev.to...','info');
    const art=await api.createArticle(getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content,tags);
    return art.url||'https://dev.to/'+account.login;
  }

  if(pid==='hashnode'){
    // Hashnode: publish via GraphQL to a specific publication
    // publicationId must be a valid MongoDB ObjectId (24 hex chars).
    // During a Global Blast, extraVal may be a generic keyword/tag string â€” ignore it if invalid.
    const isObjectId = v => /^[a-f\d]{24}$/i.test((v||'').trim());
    const pubId = isObjectId(extraVal) ? extraVal.trim()
                : isObjectId(account.extra) ? account.extra.trim()
                : '';
    if(!pubId) throw new Error('Hashnode Publication ID is required and must be a valid 24-character ObjectId â€” find it in your Hashnode Dashboard â†’ Publication Settings â†’ General');
    const api=new HashnodeAPI(account.token);
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'hashnode.dev').body;
    term.add('  Publishing to Hashnode...','info');
    const res=await api.createPost(pubId,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content,_tags.slice(0,5));
    return (res&&res.publishPost&&res.publishPost.post&&res.publishPost.post.url)||'https://hashnode.com/@'+account.login;
  }

  if(pid==='ghost'){
    // Ghost CMS: publish HTML post via JWT-authenticated Admin API
    const apiUrl=extraVal||account.extra||'';
    if(!apiUrl) throw new Error('Ghost Blog URL is required (e.g. https://yourblog.ghost.io)');
    const api=new GhostAPI(account.token,apiUrl);
    const html=generateHtmlPage(kw,account.login,sl,S.links,'ghost');
    term.add('  Publishing to Ghost ('+apiUrl+')...','info');
    const res=await api.createPost(getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,html,_tags.slice(0,5));
    return (res.posts&&res.posts[0]&&res.posts[0].url)||apiUrl;
  }

  if(pid==='wix'){
    // Wix: publish a blog post via Wix Blog v3 API
    const siteId=extraVal||account.extra||'';
    if(!siteId) throw new Error('Wix Site ID is required â€” find it in your Wix dashboard URL');
    const api=new WixAPI(account.token,siteId);
    const htmlContent=generateHtmlPage(kw,account.login,sl,S.links,'wix');
    term.add('  Publishing blog post to Wix...','info');
    const res=await api.createPost(getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,htmlContent,_tags.slice(0,5));
    return (res.post&&res.post.url)||'https://'+account.login+'.wixsite.com';
  }

  if(pid==='tumblr'){
    // Tumblr: create a post using OAuth Bearer Token + blog identifier
    const blogId=(extraVal||account.extra||account.login+'.tumblr.com').replace('https://','');
    const api=new TumblrAPI(account.token,blogId);
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'tumblr.com').body;
    term.add('  Posting to Tumblr blog: '+blogId,'info');
    const post=await api.createPost(blogId,kw,content,_tags.slice(0,5));
    const postId=post.response&&post.response.id||post.id;
    return 'https://'+blogId+'/post/'+(postId||'');
  }

  // â”€â”€ COMMUNITY POST PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='reddit'){
    // Reddit: submit a self (text) post to the specified subreddit
    const api=new RedditAPI(account.token);
    const subreddit=(extraVal||account.extra||_category||'entrepreneur').replace(/^r\//,'');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'reddit.com').body;
    term.add('  Submitting to r/'+subreddit+'...','info');
    const res=await api.submit(subreddit,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content);
    const postUrl=res.json&&res.json.data&&res.json.data.url;
    return postUrl||'https://reddit.com/r/'+subreddit;
  }

  // â”€â”€ PAGE CREATION PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='notion'){
    // Notion: create a page inside the specified parent page
    const parentId=(extraVal||account.extra||'').replace(/-/g,'');
    if(!parentId) throw new Error('Notion Parent Page ID is required â€” get it from the page URL (32-char hex string)');
    const api=new NotionAPI(account.token);
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'notion.site').body;
    term.add('  Creating Notion page...','info');
    const page=await api.createPage(parentId,getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content);
    return page.url||'https://notion.so/'+account.login;
  }

  if(pid==='telegraph'){
    // Telegraph: create an instant page (no account required beyond access token)
    const api=new TelegraphAPI(account.token);
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'telegra.ph').body;
    const authorName=extraVal||account.login||'';
    term.add('  Creating Telegra.ph page...','info');
    const page=await api.createPage(getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content,authorName);
    return 'https://telegra.ph/'+page.path;
  }

  // â”€â”€ PREFILL / MANUAL PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='codepen'){
    // CodePen: generate a prefill URL â€” no API, user must click and save
    const html=generateHtmlPage(kw,account.login,sl,S.links,'codepen');
    const css=`body{font-family:system-ui,sans-serif;max-width:900px;margin:0 auto;padding:24px;background:#f8fafc;color:#1e293b}h1,h2,h3{color:#1e1b4b}a{color:#4f46e5}section{background:white;padding:20px;margin:16px 0;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}`;
    const data=JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,html,css,tags:_tags.slice(0,5),editors:'110'});
    const penUrl='https://codepen.io/pen/define?data='+encodeURIComponent(data);
    term.add('  â„¹ CodePen prefill URL generated â€” click to open editor and save','warn');
    return penUrl;
  }

  // â”€â”€ DOCUMENT DRAFT PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='issuu'){
    const api=new IssuuAPI(account.token);
    const desc=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'issuu.com').body.slice(0,500);
    term.add('  Creating Issuu draft...','info');
    const draft=await api.createDraft(getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,desc);
    return draft.publicUrl||draft.link||'https://issuu.com/'+account.login;
  }

  // â”€â”€ PASTE / NO-LOGIN PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='bitbin'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','bitbin.it').body;
    const r=await pasteProxyFetch('https://bitbin.it/api/',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      body:new URLSearchParams({content,language:'text',expire:'never'}, term).toString()});
    if(!r.ok&&!r.text) throw new Error('Bitbin: '+r.error);
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    const path=d.data&&(d.data.hash||d.data.id||d.data.slug);
    if(!path) throw new Error('Bitbin: no path returned â€” '+r.text.slice(0,100));
    return 'https://bitbin.it/'+path+'/';
  }

  if(pid==='pastelink'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','pastelink.net').body;
    const r=await pasteProxyFetch('https://pastelink.net/api/paste',{method:'POST',
      contentType:'application/json',asJson:true,
      body:JSON.stringify({content,title:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title})});
    if(!r.ok&&!r.text) throw new Error('Pastelink: '+r.error);
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    const pasteId=d.paste_key||d.id||d.link||d.slug;
    if(!pasteId) throw new Error('Pastelink: '+r.text.slice(0,100));
    return 'https://pastelink.net/'+pasteId;
  }

  if(pid==='ideone'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','ideone.com').body;
    const r=await pasteProxyFetch('https://ideone.com/api/1/service/ideone/createSubmission',{method:'POST',
      contentType:'application/json',asJson:true,
      body:JSON.stringify({user:'guest',pass:'guest',sourceCode:content,language:43,input:'',run:false,private:false,stdRecv:false}, term)});
    if(!r.ok&&!r.text) throw new Error('Ideone: '+r.error);
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    const link=d.result&&d.result.link;
    if(!link) throw new Error('Ideone: '+r.text.slice(0,100));
    return 'https://ideone.com/'+link;
  }

  if(pid==='controlc'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','controlc.com').body;
    const r=await pasteProxyFetch('https://controlc.com/index.php',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      body:new URLSearchParams({paste_data:content,paste_title:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title,expire:'0',submit:'Submit'}).toString()});
    if(r.redirected && r.text && r.text.includes('controlc.com/')){
      const mu=r.text.match(/controlc\.com\/([a-f0-9]+)/i); if(mu) return 'https://controlc.com/'+mu[1];
    }
    const m=r.text&&r.text.match(/controlc\.com\/([a-f0-9]+)/i);
    if(m) return 'https://controlc.com/'+m[1];
    throw new Error('ControlC: could not extract paste URL â€” '+(r.error||r.text.slice(0,80)));
  }

  if(pid==='rentry'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','rentry.co').body;
    const editCode=extraVal||Math.random().toString(36).slice(2,10);
    term.add('  Fetching CSRF from rentry.co...','info');
    const csrf_r=await pasteProxyFetch('https://rentry.co/', term);
    const csrf_text=csrf_r.text||'';
    const csrf_m=csrf_text.match(/csrfmiddlewaretoken.*?value="([^"]+)"/);
    const csrf=csrf_m&&csrf_m[1]||'';
    const r=await pasteProxyFetch('https://rentry.co/api/new',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      extraHeaders:{'Referer':'https://rentry.co/','X-CSRFToken':csrf},
      body:new URLSearchParams({csrfmiddlewaretoken:csrf,text:content,edit_code:editCode}, term).toString()});
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    if(d.status!=='200'&&d.status!==200) throw new Error('Rentry: '+r.text.slice(0,120));
    return d.url||'https://rentry.co/'+(d.url_slug||'');
  }

  // â”€â”€ NEW PASTE PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='rentryorg'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','rentry.org').body;
    const editCode=extraVal||Math.random().toString(36).slice(2,10);
    term.add('  Fetching CSRF from rentry.org...','info');
    const csrf_r2=await pasteProxyFetch('https://rentry.org/', term);
    const csrf_text2=csrf_r2.text||'';
    const csrf_m2=csrf_text2.match(/csrfmiddlewaretoken.*?value="([^"]+)"/);
    const csrf2=csrf_m2&&csrf_m2[1]||'';
    const r=await pasteProxyFetch('https://rentry.org/api/new',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      extraHeaders:{'Referer':'https://rentry.org/','X-CSRFToken':csrf2},
      body:new URLSearchParams({csrfmiddlewaretoken:csrf2,text:content,edit_code:editCode}, term).toString()});
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    if(d.status!=='200'&&d.status!==200) throw new Error('Rentry.org: '+r.text.slice(0,120));
    return d.url||'https://rentry.org/'+(d.url_slug||'');
  }

  if(pid==='pastebin'){
    const apiKey=extraVal||account.extra||account.token||'';
    if(!apiKey) throw new Error('Pastebin: API key required â€” get it free at pastebin.com/doc_api');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','pastebin.com').body;
    term.add('  Submitting paste to Pastebin...','info');
    const r=await pasteProxyFetch('https://pastebin.com/api/api_post.php',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      body:new URLSearchParams({
        api_dev_key:apiKey,
        api_paste_code:content,
        api_paste_name:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title,
        api_paste_expire_date:'N',
        api_paste_format:'markdown',
        api_paste_private:'0',
        api_option:'paste'
      }).toString()});
    const text=(r.text||'').trim();
    if(!text.startsWith('https://')) throw new Error('Pastebin: '+(text||r.error||'unknown error â€” check API key'));
    return text;
  }

  if(pid==='dpaste'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','dpaste.org').body;
    term.add('  Submitting paste to dpaste.org...','info');
    const r=await pasteProxyFetch('https://dpaste.org/api/',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      body:new URLSearchParams({content,syntax:'text',expiry_days:'365',title:kw}, term).toString()});
    const url=(r.text||'').trim().replace(/"/g,'');
    if(!url.startsWith('http')) throw new Error('dpaste.org: '+(r.error||r.text.slice(0,80)));
    return url;
  }

  if(pid==='hastebin'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','hastebin.com').body;
    term.add('  Submitting paste to Hastebin...','info');
    const r=await pasteProxyFetch('https://hastebin.com/documents',{method:'POST',
      contentType:'text/plain',body:content}, term);
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    if(!d.key) throw new Error('Hastebin: '+(r.error||r.text.slice(0,80)));
    return 'https://hastebin.com/'+d.key;
  }

  if(pid==='writeas'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','write.as').body;
    term.add('  Publishing post to Write.as...','info');
    const r=await pasteProxyFetch('https://write.as/api/posts',{method:'POST',
      contentType:'application/json',asJson:true,
      body:JSON.stringify({body:content,title:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title,font:'serif',lang:'en'})});
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    if(!d.data||!d.data.slug) throw new Error('Write.as: '+(r.error||r.text.slice(0,100)));
    return 'https://write.as/'+d.data.slug;
  }

  if(pid==='pastee'){
    const apiKey=extraVal||account.extra||account.token||'';
    if(!apiKey) throw new Error('Paste.ee: API key required â€” free at paste.ee/account/api');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','paste.ee').body;
    term.add('  Submitting paste to Paste.ee...','info');
    const r=await pasteProxyFetch('https://paste.ee/api',{method:'POST',
      contentType:'application/json',asJson:true,
      extraHeaders:{'X-Auth-Token':apiKey},
      body:JSON.stringify({
        key:'public',
        description:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title,
        sections:[{name:kw,syntax:'text',contents:content}]
      })});
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    if(!d.id&&!d.link) throw new Error('Paste.ee: '+(r.error||r.text.slice(0,100)));
    return d.link||'https://paste.ee/p/'+d.id;
  }

  if(pid==='justpaste'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','justpaste.it').body;
    term.add('  Fetching CSRF from JustPaste.it...','info');
    const homeR=await pasteProxyFetch('https://justpaste.it/', term);
    const homeText=homeR.text||'';
    const metaM=homeText.match(/<meta[^>]+name=["']?csrf-token["']?[^>]+content=["']([^"']+)["']/i);
    const inputM=homeText.match(/name=["']?_?csrf[_-]?token["']?[^>]+value=["']([^"']+)["']/i);
    const csrf2=(metaM&&metaM[1])||(inputM&&inputM[1])||'';
    term.add('  Posting to JustPaste.it...','info');
    const postR=await pasteProxyFetch('https://justpaste.it/api/v1/articles',{method:'POST',
      contentType:'application/json',asJson:true,
      extraHeaders:{'X-CSRF-Token':csrf2},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title,body:content,visibility:'public'})});
    let postD={}; try{postD=JSON.parse(postR.text);}catch(e){}
    const alias=postD.alias||postD.id||postD.articleId;
    if(!alias) throw new Error('JustPaste.it: '+(postR.error||postR.text.slice(0,120)));
    return 'https://justpaste.it/'+alias;
  }

  if(pid==='zerobin'){
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','0bin.net').body;
    term.add('  Submitting paste to 0bin.net...','info');
    const r=await pasteProxyFetch('https://0bin.net/paste',{method:'POST',
      contentType:'application/x-www-form-urlencoded',
      body:new URLSearchParams({content,expire_after:'never'}, term).toString()});
    const m=r.text&&r.text.match(/href=["'](\/paste\/[^"']+)["']/i);
    if(m) return 'https://0bin.net'+m[1];
    throw new Error('0bin.net: '+(r.error||r.text.slice(0,80)));
  }

  if(pid==='ghgist'){
    // GitHub Gist â€” reuse existing GitHub account token
    const ghAccount=S.accounts.find(a=>a.platform==='github');
    if(!ghAccount) throw new Error('GitHub Gist: Connect a GitHub account first in Setup â†’ GitHub Pages');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,ghAccount.login,'gist.github.com').body;
    const desc=(extraVal||'SEO guide')+' â€” '+kw;
    term.add('  Creating public Gist as '+ghAccount.login+'...','info');
    const r=await smartFetch('https://api.github.com/gists',{method:'POST',
      headers:{'Authorization':'token '+ghAccount.token,'Content-Type':'application/json','Accept':'application/vnd.github+json'},
      body:JSON.stringify({
        description:desc,
        public:true,
        files:{[slug(kw)+'.md']:{content}}
      })});
    const d=await r.json();
    if(!d.html_url) throw new Error('GitHub Gist: '+(d.message||JSON.stringify(d).slice(0,80)));
    return d.html_url;
  }

  if(pid==='hackmd'){
    const apiToken=extraVal||account.extra||account.token||'';
    if(!apiToken) throw new Error('HackMD: API token required â€” create one in HackMD Settings â†’ API');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,'anon','hackmd.io').body;
    term.add('  Creating HackMD note...','info');
    const r=await pasteProxyFetch('https://api.hackmd.io/v1/notes',{method:'POST',
      contentType:'application/json',asJson:true,
      extraHeaders:{'Authorization':'Bearer '+apiToken},
      body:JSON.stringify({
        title:getEffectiveContent(kw,S.links,idx,S.keywords,'','', term).title,
        content:content,
        readPermission:'guest',
        writePermission:'owner',
        commentPermission:'everyone'
      })});
    let d={}; try{d=JSON.parse(r.text);}catch(e){}
    if(!d.publishLink&&!d.id) throw new Error('HackMD: '+(r.error||r.text.slice(0,100)));
    return d.publishLink||'https://hackmd.io/'+d.id;
  }

  // â”€â”€ FORM-LOGIN PLATFORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if(pid==='techplanet'){
    // TechPlanet.today â€” login then POST article via form
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('TechPlanet: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'techplanet.today').body;
    // Login
    const loginR=await smartFetch('https://techplanet.today/api/login',{method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify({email:account.login,password})});
    const loginD=await loginR.json();
    const token2=loginD.token||loginD.access_token||loginD.data&&loginD.data.token;
    if(!token2) throw new Error('TechPlanet login failed: '+(loginD.message||'invalid credentials'));
    // Post
    const postR=await smartFetch('https://techplanet.today/api/posts',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token2,'Accept':'application/json'},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,body:content,status:'published',type:'post'})});
    const postD=await postR.json();
    const postSlug=postD.slug||postD.data&&postD.data.slug;
    return postSlug?'https://techplanet.today/post/'+postSlug:'https://techplanet.today';
  }

  if(pid==='click4r'){
    // Click4R â€” login then create post
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('Click4R: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'click4r.com').body;
    const loginR=await smartFetch('https://www.click4r.com/api/auth/login',{method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token||loginD.data&&loginD.data.token;
    if(!tok) throw new Error('Click4R login failed: '+(loginD.message||'check credentials'));
    const postR=await smartFetch('https://www.click4r.com/api/posts',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,content,status:'published'})});
    const postD=await postR.json();
    const pid2=postD.id||postD.data&&postD.data.id;
    return pid2?'https://www.click4r.com/posts/g/'+pid2+'/':'https://www.click4r.com';
  }

  if(pid==='writeonwall'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('WriteOnWall: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'writeonwall.com').body;
    const loginR=await smartFetch('https://writeonwall.com/api/login',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token;
    if(!tok) throw new Error('WriteOnWall login failed');
    const postR=await smartFetch('https://writeonwall.com/api/questions',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,body:content,type:'question'})});
    const postD=await postR.json();
    const qSlug=postD.slug||postD.id;
    return qSlug?'https://writeonwall.com/question/'+qSlug+'/':'https://writeonwall.com';
  }

  if(pid==='snaplant'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('Snaplant: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'snaplant.com').body;
    const loginR=await smartFetch('http://snaplant.com/api/auth/login',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token;
    if(!tok) throw new Error('Snaplant login failed');
    const postR=await smartFetch('http://snaplant.com/api/questions',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,body:content})});
    const postD=await postR.json();
    const qSlug=postD.slug||postD.id;
    return qSlug?'http://snaplant.com/question/'+qSlug+'/':'http://snaplant.com';
  }

  if(pid==='theprose'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('TheProse: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'theprose.com').body;
    const loginR=await smartFetch('https://www.theprose.com/api/v1/session',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.session_token||loginD.access_token;
    if(!tok) throw new Error('TheProse login failed');
    const postR=await smartFetch('https://www.theprose.com/api/v1/posts',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,body:content,publish:true})});
    const postD=await postR.json();
    const postId=postD.id||postD.post&&postD.post.id;
    return postId?'https://www.theprose.com/post/'+postId+'/':'https://www.theprose.com';
  }

  if(pid==='onfeetnation'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('OnFeetNation: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'onfeetnation.com').body;
    // Login via Ning-style form
    const loginR=await smartFetch('https://www.onfeetnation.com/api/v1/session',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token||loginD.sessionToken;
    if(!tok) throw new Error('OnFeetNation login failed â€” check username/password');
    const postR=await smartFetch('https://www.onfeetnation.com/api/v1/albums',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,description:content.slice(0,1000),privacy:'public'})});
    const postD=await postR.json();
    const albumId=postD.id||postD.album&&postD.album.id;
    return albumId?'https://www.onfeetnation.com/photo/albums/'+albumId:'https://www.onfeetnation.com';
  }

  if(pid==='caribbeanfever'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('CaribbeanFever: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'caribbeanfever.com').body;
    const loginR=await smartFetch('https://caribbeanfever.com/api/v1/session',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:account.login,password})});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.access_token||loginD.sessionToken;
    if(!tok) throw new Error('CaribbeanFever login failed â€” check username/password');
    const postR=await smartFetch('https://caribbeanfever.com/api/v1/albums',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,description:content.slice(0,1000),privacy:'public'})});
    const postD=await postR.json();
    const albumId=postD.id||postD.album&&postD.album.id;
    return albumId?'https://caribbeanfever.com/photo/albums/'+albumId:'https://caribbeanfever.com';
  }

  if(pid==='taylorhicks'){
    const password=extraVal||account.extra||'';
    if(!password) throw new Error('TaylorHicks Ning: password required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'taylorhicks.ning.com').body;
    // Ning REST API
    const loginR=await smartFetch('https://external.ningapis.com/xn/rest/taylorhicks/1.0/Token',{method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({email:account.login,password,apiKey:account.token}).toString()});
    const loginD=await loginR.json();
    const tok=loginD.token||loginD.oauthToken;
    if(!tok) throw new Error('TaylorHicks Ning login failed');
    const postR=await smartFetch('https://external.ningapis.com/xn/rest/taylorhicks/1.0/BlogPost',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,description:content,visibility:'public'})});
    const postD=await postR.json();
    const postId=postD.id||postD.blogPost&&postD.blogPost.id;
    return postId?'https://taylorhicks.ning.com/forum/topics/'+postId:'https://taylorhicks.ning.com';
  }

  if(pid==='vingle'){
    const interestId=extraVal||account.extra||'';
    if(!interestId) throw new Error('Vingle: Interest ID required');
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'vingle.net').body;
    const postR=await smartFetch('https://www.vingle.net/api/cards',{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+account.token},
      body:JSON.stringify({title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,body:content,interest_id:interestId,visibility:'public'})});
    const postD=await postR.json();
    const cardId=postD.id||postD.card&&postD.card.id;
    return cardId?'https://www.vingle.net/posts/'+cardId:'https://www.vingle.net';
  }

  if(pid==='deviantart'){
    // DeviantArt: publish journal via OAuth2 token
    const content=getEffectiveContent(kw,S.links,idx,S.keywords,account.login,'deviantart.com').body;
    const r=await smartFetch('https://www.deviantart.com/api/v1/oauth2/stash/publish',{method:'POST',
      headers:{'Authorization':'Bearer '+account.token,'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({
        title:getEffectiveContent(kw,S.links,idx,S.keywords,'','').title,
        artist_comments:content.slice(0,10000),
        is_mature:'false',
        agree_submission:'true',
        catpath:'journal',
        'license.creative_commons':'0'
      }).toString()});
    const d=await r.json();
    if(d.error) throw new Error('DeviantArt: '+d.error_description||d.error);
    const deviationId=d.deviationid||d.url;
    return d.url||'https://www.deviantart.com/'+account.login+'/journal/';
  }

  throw new Error('No handler for platform: '+pid);
}

// â”€â”€â”€ AUTO-INDEXER (fires after each successful campaign URL) â”€â”€
async function autoSubmitToIndexers(url, term){
  const key=settingGet('li_indexNowKey')||settingGet('indexnow_key')||'';
  const results=[];
  // 1. IndexNow â€” instant push to Bing, Yandex, Seznam (free, no auth if key present)
  if(key){
    try{
      const host=new URL(url).hostname;
      const r=await fetch('https://api.indexnow.org/indexnow',{method:'POST',
        headers:{'Content-Type':'application/json; charset=utf-8'},
        body:JSON.stringify({host,key,keyLocation:'https://'+host+'/'+key+'.txt',urlList:[url]})});
      results.push('IndexNow:'+(r.status===200||r.status===202?'âœ“':'âœ— '+r.status));
    }catch(e){ results.push('IndexNow:âœ—'); }
  }
  // 2. Google Ping (sitemap ping â€” crawl signal, free, no auth)
  try{
    await fetch('https://www.google.com/ping?sitemap='+encodeURIComponent(url),{method:'GET',mode:'no-cors'});
    results.push('Google:âœ“');
  }catch(e){ results.push('Google:âœ—'); }
  // 3. Bing Webmaster Ping (free, no auth required for basic ping)
  try{
    await fetch('https://www.bing.com/ping?sitemap='+encodeURIComponent(url),{method:'GET',mode:'no-cors'});
    results.push('Bing:âœ“');
  }catch(e){ results.push('Bing:âœ—'); }
  if(term) term.add('  ğŸ“¡ Auto-indexed: '+results.join(' | '),'info');
}

// â”€â”€â”€ INDEXING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIndexing(el){
  const successUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  el.innerHTML=`
  <div class="page-title">ğŸ“¡ Search Indexing</div>
  <div class="page-sub">// submit all campaign URLs to search engines</div>
  <div class="grid4" style="margin-bottom:18px">
    ${statBox(successUrls.length,'URLs to Submit','g')}
    ${statBox(S.campaigns.filter(c=>c.status==='success').length,'Total Live','b')}
    ${statBox([...new Set(S.campaigns.map(c=>c.platform))].length,'Platforms','p')}
    ${statBox([...new Set(successUrls.map(c=>c.keyword))].length,'Keywords','y')}
  </div>
  <div class="card">
    <div class="card-title">IndexNow (Bing, Yandex, Seznam)</div>
    <div class="fg"><label class="lbl">IndexNow API Key</label><input type="text" id="idx-key" placeholder="your-indexnow-api-key"/></div>
    <div class="flex aic g8">
      <button class="btn btn-primary" id="idx-btn" onclick="runIndexNow()">â–¶ Submit ${successUrls.length} URLs</button>
      <button class="btn btn-yellow" onclick="pingGoogle()">ğŸ“ Ping Google Sitemap</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title flex aic g8">Terminal<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="document.getElementById('idx-term').innerHTML='<span class=tm>// Cleared</span>'">Clear</button></div>
    <div class="terminal" id="idx-term"><span class="tm">// Indexing output will appear here...</span></div>
  </div>`;
}
async function runIndexNow(){
  const key=(document.getElementById('idx-key')||{value:''}).value.trim();
  if(!key){ toast('IndexNow API key required â€” check Settings','w'); return; }
  const btn=document.getElementById('idx-btn');
  const termEl=document.getElementById('idx-term');
  const term=makeTerminal(termEl);
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Submitting...';
  const urls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  let ok=0;
  for(const c of urls){
    try{
      const urlObj=new URL(c.url); const host=urlObj.hostname;
      const r=await fetch('https://api.indexnow.org/indexnow',{method:'POST',headers:{'Content-Type':'application/json; charset=utf-8'},
        body:JSON.stringify({host,key,keyLocation:'https://'+host+'/'+key+'.txt',urlList:[c.url]})});
      const isOk=r.status===200||r.status===202;
      term.add((isOk?'âœ“ ':'âœ— ')+c.url+' â†’ '+r.status,isOk?'info':'error');
      if(isOk) ok++;
    }catch(e){ term.add('âœ— '+c.url+' â†’ '+e.message,'error'); }
    await sleep(400);
  }
  term.add('IndexNow complete: '+ok+'/'+urls.length+' submitted','info');
  btn.disabled=false; btn.textContent='â–¶ Submit '+urls.length+' URLs';
}
async function pingGoogle(){
  const termEl=document.getElementById('idx-term');
  const term=makeTerminal(termEl);
  const urls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  for(const c of urls){
    try{ await fetch('https://www.google.com/ping?sitemap='+encodeURIComponent(c.url),{method:'GET',mode:'no-cors'}); term.add('âœ“ Pinged: '+c.url,'info'); }
    catch(e){ term.add('âœ— '+c.url+': '+e.message,'error'); }
    await sleep(300);
  }
  term.add('Google ping complete','info');
}

// â”€â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _exportFormat='urls';
let _exportFilter='all';
function renderExport(el){
  const succeeded=_exportFilter==='all'?S.campaigns.filter(c=>c.status==='success'):S.campaigns.filter(c=>c.status==='success'&&c.platform===_exportFilter);
  const filtered=_exportFilter==='all'?S.campaigns:S.campaigns.filter(c=>c.platform===_exportFilter);
  const content=getExportContent(filtered,succeeded);
  el.innerHTML=`
  <div class="page-title">ğŸ“¤ Export Center</div>
  <div class="page-sub">// export results from all platforms</div>
  <div class="grid4" style="margin-bottom:18px">
    ${statBox(S.campaigns.length,'Total','g')}
    ${statBox(S.campaigns.filter(c=>c.status==='success').length,'Succeeded','b')}
    ${statBox(S.campaigns.filter(c=>c.status==='error').length,'Failed','r')}
    ${statBox([...new Set(S.campaigns.map(c=>c.platform))].length,'Platforms','y')}
  </div>
  <div class="card">
    <div class="card-title">Filter by Platform</div>
    <div class="mtabs" style="width:100%;flex-wrap:wrap">
      <div class="mtab ${_exportFilter==='all'?'on':''}" onclick="setExportFilter('all')">All (${S.campaigns.length})</div>
      ${PLATFORMS.filter(p=>S.campaigns.some(c=>c.platform===p.id)).map(p=>`<div class="mtab ${_exportFilter===p.id?'on':''}" onclick="setExportFilter('${p.id}')">${p.icon} ${esc(p.name)} (${S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length})</div>`).join('')}
    </div>
  </div>
  ${succeeded.length?`<div class="card"><div class="card-title">ğŸš€ Live URLs</div>${succeeded.slice(0,20).map(c=>urlBannerHTML(c.url,c.keyword,c.platform)).join('')}${succeeded.length>20?`<p class="tm mono xs mt8">...and ${succeeded.length-20} more. Export to see all.</p>`:''}</div>`:''}
  <div class="card">
    <div class="card-title">Export Format</div>
    <div class="mtabs">
      ${['urls','csv','json','markdown'].map(f=>`<div class="mtab ${_exportFormat===f?'on':''}" onclick="setExportFormat('${f}')">${{urls:'Plain URLs',csv:'CSV',json:'JSON',markdown:'Markdown'}[f]}</div>`).join('')}
    </div>
    <div class="flex aic g8" style="margin-bottom:10px">
      <button class="btn btn-ghost btn-sm" id="export-copy-btn" onclick="exportCopy(this)">COPY</button>
      <button class="btn btn-primary btn-sm" onclick="downloadExport()">â¬‡ Download</button>
    </div>
    <textarea readonly id="export-ta" rows="12" style="background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.7;border:1px solid var(--border);border-radius:6px;font-weight:600">${esc(content)}</textarea>
  </div>`;
}
function getExportContent(filtered,succeeded){
  if(_exportFormat==='urls') return (succeeded||S.campaigns.filter(c=>c.status==='success')).map(c=>c.url).join('\n');
  if(_exportFormat==='csv'){ const h='platform,keyword,repo,url,status,timestamp'; const rows=(filtered||S.campaigns).map(c=>'"'+c.platform+'","'+c.keyword+'","'+(c.repo||'')+'","'+(c.url||'')+'","'+c.status+'","'+c.ts+'"'); return [h,...rows].join('\n'); }
  if(_exportFormat==='json') return JSON.stringify(filtered||S.campaigns,null,2);
  if(_exportFormat==='markdown'){
    return '# Campaign Results\n\n| Platform | Keyword | URL | Status |\n|----------|---------|-----|--------|\n'+(filtered||S.campaigns).map(c=>'| '+c.platform+' | '+c.keyword+' | ['+(c.url||'â€”')+']('+c.url+') | '+c.status+' |').join('\n');
  }
  return '';
}
function getExportAll(){ const succ=_exportFilter==='all'?S.campaigns.filter(c=>c.status==='success'):S.campaigns.filter(c=>c.status==='success'&&c.platform===_exportFilter); const filt=_exportFilter==='all'?S.campaigns:S.campaigns.filter(c=>c.platform===_exportFilter); return getExportContent(filt,succ); }
function setExportFormat(f){ _exportFormat=f; renderExport(document.getElementById('page-export')); }
function setExportFilter(f){ _exportFilter=f; renderExport(document.getElementById('page-export')); }
function downloadExport(){
  const ext={urls:'txt',csv:'csv',json:'json',markdown:'md'}[_exportFormat]||'txt';
  const blob=new Blob([getExportAll()],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='seo-export-'+_exportFilter+'.'+ext; a.click();
}

// â”€â”€â”€ GLOBAL BLAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _blastSelectedPlatforms=[];
let _blastRunning=false;
function renderGlobalBlast(el){
  const connected=PLATFORMS.filter(p=>S.accounts.some(a=>a.platform===p.id));
  if(!_blastSelectedPlatforms.length) _blastSelectedPlatforms=connected.map(p=>p.id);
  const successCount=S.campaigns.filter(c=>c.status==='success').length;
  el.innerHTML=`
  <div class="page-title" style="color:var(--accent)">ğŸŒ Global Blast</div>
  <div class="page-sub">// post to ALL connected platforms simultaneously â€” one form, maximum reach</div>
  <div class="notice notice-success">Global Blast publishes all your keywords across every connected platform in a single run. Connect accounts in Setup first.</div>
  <div class="grid5" style="margin-bottom:18px">
    ${statBox(connected.length,'Connected','g')}${statBox(_blastSelectedPlatforms.length,'Selected','b')}
    ${statBox(S.keywords.length,'Keywords','y')}${statBox(successCount,'Succeeded','g')}
    ${statBox(S.campaigns.filter(c=>c.status==='error').length,'Failed','r')}
  </div>
  ${!connected.length?'<div class="notice notice-warn">No platforms connected. Go to Setup / Connect in the sidebar to add accounts first.</div>':''}
  <div class="card">
    <div class="card-title flex aic g8">Platform Selection
      <button class="btn btn-ghost btn-xs" onclick="blastSelectAll()">All</button>
      <button class="btn btn-ghost btn-xs" onclick="blastSelectNone()">None</button>
    </div>
    <div class="grid4" id="blast-plat-grid">
      ${PLATFORMS.map(p=>{
        const isConn=S.accounts.some(a=>a.platform===p.id);
        const isSel=_blastSelectedPlatforms.includes(p.id);
        return `<div onclick="toggleBlastPlatform('${p.id}')" style="padding:10px 12px;border:1px solid ${isSel&&isConn?'var(--accent)':'var(--border)'};background:${isSel&&isConn?'rgba(0,87,255,0.05)':'var(--bg)'};cursor:${isConn?'pointer':'not-allowed'};opacity:${isConn?1:0.4};display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:10px;transition:all 0.12s;border-radius:8px;font-weight:600">
          <span style="font-size:14px">${p.icon}</span>
          <div style="flex:1"><div style="color:${isSel&&isConn?'var(--accent)':'var(--text)'};font-weight:700;font-size:11px">${esc(p.name)}</div><div style="color:var(--muted2);font-size:9px;font-weight:600">DA ${p.da} ${isConn?'Â· âœ“ connected':'Â· not connected'}</div></div>
          ${isSel&&isConn?'<span style="color:var(--accent)">âœ“</span>':''}
        </div>`;
      }).join('')}
    </div>
  </div>
  <div class="card">
    <div class="card-title">Blast Settings</div>
    <div class="grid3">
      <div class="fg mb0"><label class="lbl">Quick Single Keyword (overrides keyword list)</label>
        <input type="text" id="blast-kw" placeholder="Or leave blank to use ${S.keywords.length} keyword(s) from Keywords page"/></div>
      <div class="fg mb0"><label class="lbl">Prefix (for pages/repos)</label>
        <input type="text" id="blast-prefix" value="seo"/></div>
      <div class="fg mb0"><label class="lbl">Delay Between Posts (sec)</label>
        <input type="number" id="blast-delay" value="4" min="1" max="120"/></div>
    </div>
    ${(()=>{ const _blastType=blastDominantFieldType(); const _fakePid=Object.keys(PLATFORM_META).find(k=>(PLATFORM_META[k].type||'article')===_blastType)||(_blastSelectedPlatforms[0]||PLATFORMS[0].id); return renderContentFields(_fakePid,'blast'); })()}
    <div class="notice notice-info mt8" id="blast-estimate" style="margin-bottom:8px">
      Select platforms and set delay to see estimated time.
    </div>
    <div class="flex aic g8 mt8">
      <button class="btn btn-primary" id="blast-run-btn" onclick="runGlobalBlast()" style="font-size:12px;padding:10px 24px" ${!connected.length?'disabled':''}>
        ğŸŒ GLOBAL BLAST â€” ${_blastSelectedPlatforms.length} platform(s) Ã— ${S.keywords.length||1} keyword(s)
      </button>
    </div>
    <div id="blast-prog-wrap" style="display:none;margin-top:10px">
      <div class="flex aic g8" style="margin-bottom:4px">
        <span class="mono xs tm" id="blast-prog-label">0/0 posts completed</span>
        <span class="mono xs ta" id="blast-prog-pct">0%</span>
      </div>
      <div class="prog-wrap" style="height:6px"><div class="prog-fill" id="blast-prog"></div></div>
    </div>
  </div>
  <div id="blast-urls"></div>
  <div class="card">
    <div class="card-title flex aic g8">Blast Terminal<button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="document.getElementById('blast-term').innerHTML='<span class=tm>// Cleared</span>'">Clear</button></div>
    <div class="terminal" id="blast-term" style="height:300px"><span class="tm">// Global Blast output will appear here. Select platforms, configure settings, and click GLOBAL BLAST.</span></div>
  </div>`;
  updateBlastEstimate();
}

function toggleBlastPlatform(id){
  const isConn=S.accounts.some(a=>a.platform===id); if(!isConn) return;
  if(_blastSelectedPlatforms.includes(id)) _blastSelectedPlatforms=_blastSelectedPlatforms.filter(x=>x!==id);
  else _blastSelectedPlatforms.push(id);
  renderGlobalBlast(document.getElementById('page-global_blast'));
}
function blastSelectAll(){ _blastSelectedPlatforms=PLATFORMS.filter(p=>S.accounts.some(a=>a.platform===p.id)).map(p=>p.id); renderGlobalBlast(document.getElementById('page-global_blast')); }
function blastSelectNone(){ _blastSelectedPlatforms=[]; renderGlobalBlast(document.getElementById('page-global_blast')); }
function updateBlastEstimate(){
  const el=document.getElementById('blast-estimate'); if(!el) return;
  const kws=(document.getElementById('blast-kw')||{value:''}).value.trim()?1:S.keywords.length||1;
  const delay=parseInt((document.getElementById('blast-delay')||{value:4}).value)||4;
  const total=_blastSelectedPlatforms.length*kws;
  const mins=Math.round(total*delay/60);
  el.textContent='Estimated time: ~'+mins+' min for '+_blastSelectedPlatforms.length+' platform(s) Ã— '+kws+' keyword(s) at '+delay+'s delay';
}
async function runGlobalBlast(){
  if(_blastRunning) return;
  const kwEl=document.getElementById('blast-kw');
  const prefixEl=document.getElementById('blast-prefix');
  const delayEl=document.getElementById('blast-delay');
  syncContentFields('blast'); // sync all content fields from DOM before blast
  const singleKw=kwEl&&kwEl.value.trim();
  const effectiveKws=singleKw?[singleKw]:(S.keywords.length?S.keywords:null);
  if(!effectiveKws){ toast('Add keywords in the Keywords page first','w'); return; }
  if(!_blastSelectedPlatforms.length){ alert('Select at least one platform.'); return; }
  _blastRunning=true;
  const prefix=(prefixEl&&prefixEl.value.trim())||'seo';
  const delay=parseInt((delayEl&&delayEl.value)||4)||4;
  const btn=document.getElementById('blast-run-btn');
  const termEl=document.getElementById('blast-term');
  const progWrap=document.getElementById('blast-prog-wrap');
  const progBar=document.getElementById('blast-prog');
  const progLabel=document.getElementById('blast-prog-label');
  const progPct=document.getElementById('blast-prog-pct');
  const urlsEl=document.getElementById('blast-urls');
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Blasting...';
  progWrap.style.display='block';
  termEl.innerHTML='';
  urlsEl.innerHTML='';
  const term=makeTerminal(termEl);
  const liveUrls=[];
  const total=_blastSelectedPlatforms.length*effectiveKws.length;
  let done=0;

  for(let ki=0;ki<effectiveKws.length;ki++){
    const kw=effectiveKws[ki];
    term.add('â•â• Keyword ['+(ki+1)+'/'+effectiveKws.length+']: "'+kw+'" â•â•','info');
    for(const pid of _blastSelectedPlatforms){
      const p=getPlatform(pid);
      const account=S.accounts.find(a=>a.platform===pid);
      if(!account){ term.add('  âš  '+p.name+': No account connected, skipping','warn'); done++; continue; }
      term.add('  â†’ '+p.icon+' '+p.name+'...','info');
      try{
        // For global blast, use account.extra as the per-platform extra value
        const blastExtra=account.extra||prefix;
        const url=await runSingleCampaign(pid,kw,account,blastExtra,ki,{add:(m,t)=>term.add('    '+m,t)});
        term.add('  âœ“ '+p.name+': '+url,'info');
        liveUrls.push({url,keyword:kw,platform:pid});
        const result={id:uid(),platform:pid,keyword:kw,repo:slug(prefix+'-'+kw),url,status:'success',ts:ts()};
        S.campaigns=S.campaigns.filter(c=>!(c.platform===pid&&c.keyword===kw));
        S.campaigns.push(result);
        if(settingGet('auto_index_on_publish')&&url){
          autoSubmitToIndexers(url,{add:(m,t)=>term.add('    '+m,t)}).catch(()=>{});
        }
        urlsEl.innerHTML='<div class="card slide-in"><div class="card-title">ğŸš€ Live URLs â€” '+liveUrls.length+' total</div>'+liveUrls.slice(-10).map(u=>urlBannerHTML(u.url,u.keyword,u.platform)).join('')+'</div>';
      }catch(e){
        term.add('  âœ— '+p.name+': '+e.message,'error');
        S.campaigns.push({id:uid(),platform:pid,keyword:kw,repo:slug(prefix+'-'+kw),url:'',status:'error',ts:ts(),error:e.message});
      }
      done++;
      const pct=Math.round(done/total*100);
      setProgress(progBar,pct);
      progLabel.textContent=done+'/'+total+' posts completed';
      progPct.textContent=pct+'%';
      if(done<total) await sleep(delay*1000);
    }
  }
  setProgress(progBar,100);
  term.add('ğŸŒ GLOBAL BLAST COMPLETE! '+liveUrls.length+'/'+total+' succeeded across '+_blastSelectedPlatforms.length+' platforms','info');
  btn.disabled=false; btn.innerHTML='ğŸŒ GLOBAL BLAST â€” Re-run';
  _blastRunning=false;
  updateHeader(); updatePlatformBar();
}

// â”€â”€â”€ CONTENT STUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _studioArticles=[];
let _studioActiveIdx=0;
let _studioFormat='markdown';

// Manual Content Library â€” persisted in localStorage
let _contentLibrary = JSON.parse(localStorage.getItem('cs_library')||'[]');
let _csActiveEditor = null; // id of item being edited, null = new
let _csEditorFormat = 'markdown'; // markdown | html
let _csPreviewMode = false;

function csSaveLibrary(){ try{ localStorage.setItem('cs_library',JSON.stringify(_contentLibrary)); }catch(e){} }
function csGenId(){ return 'cs_'+Date.now()+'_'+Math.random().toString(36).slice(2,7); }

function renderContentStudio(el){
  el.innerHTML=`
  <div class="page-title">âœ Content Studio</div>
  <div class="page-sub">// generate Â· manually add HTML/Markdown Â· save to library Â· pass to any function</div>

  <!-- MAIN TABS -->
  <div class="mtabs" style="margin-bottom:18px">
    <div class="mtab on" id="cs-tab-generate" onclick="csTab('generate')">âš¡ Auto Generate</div>
    <div class="mtab" id="cs-tab-manual" onclick="csTab('manual')">âœ Manual Editor</div>
    <div class="mtab" id="cs-tab-library" onclick="csTab('library')">ğŸ“š Content Library <span style="background:rgba(0,87,255,0.12);color:var(--accent);border:1px solid rgba(0,87,255,0.2);border-radius:3px;padding:1px 6px;font-size:9px;margin-left:4px" id="cs-lib-count">${_contentLibrary.length}</span></div>
  </div>

  <!-- TAB: AUTO GENERATE -->
  <div id="cs-tab-generate-panel">
    <div class="card">
      <div class="card-title">Content Generator</div>
      <div class="grid3">
        <div class="fg mb0"><label class="lbl">Keyword (from list)</label>
          <select id="studio-kw-sel"><option value="">â€” select â€”</option>${S.keywords.map(k=>`<option value="${esc(k)}">${esc(k)}</option>`).join('')}</select></div>
        <div class="fg mb0"><label class="lbl">Custom Keyword (overrides)</label>
          <input type="text" id="studio-kw-custom" placeholder="type any keyword..."/></div>
        <div class="fg mb0"><label class="lbl">Spin Variations (1-5)</label>
          <input type="number" id="studio-count" value="3" min="1" max="5"/></div>
      </div>
      <button class="btn btn-primary mt8" onclick="generateStudioContent()">âš¡ Generate Variations</button>
    </div>
    <div id="studio-output"></div>
    <div class="card">
      <div class="card-title">SEO Content Checklist</div>
      <div class="grid2" style="font-family:var(--mono);font-size:10px">
        ${[['âœ“','Keyword in H1 title','ta'],['âœ“','Links injected from Link Manager','ta'],['âœ“','FAQ section for featured snippets','ta'],['âœ“','Last updated date included','ta'],['!','Add images to boost on-page time','ty'],['!','Internal linking between pages','ty']].map(([icon,text,cls])=>`<div style="padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-weight:600"><span class="${cls}">${icon}</span> ${esc(text)}</div>`).join('')}
      </div>
    </div>
  </div>

  <!-- TAB: MANUAL EDITOR -->
  <div id="cs-tab-manual-panel" style="display:none">
    ${csRenderEditor()}
  </div>

  <!-- TAB: LIBRARY -->
  <div id="cs-tab-library-panel" style="display:none">
    ${csRenderLibrary()}
  </div>`;
}

function csTab(tab){
  ['generate','manual','library'].forEach(t=>{
    const panel=document.getElementById('cs-tab-'+t+'-panel');
    const tabEl=document.getElementById('cs-tab-'+t);
    if(panel) panel.style.display = t===tab ? '' : 'none';
    if(tabEl){ tabEl.classList.toggle('on', t===tab); }
  });
  if(tab==='library') csRefreshLibrary();
}

// â”€â”€ MANUAL EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csRenderEditor(editId){
  const item = editId ? _contentLibrary.find(c=>c.id===editId) : null;
  const title = item ? item.title : '';
  const content = item ? item.content : '';
  const format = item ? item.format : _csEditorFormat;
  const keyword = item ? (item.keyword||'') : '';
  const tags = item ? (item.tags||'') : '';

  return `
  <div class="card" id="cs-editor-card">
    <div class="card-title flex aic g8">
      ${editId ? 'âœ Edit Content' : 'âœ New Content'}
      ${editId ? `<span class="badge badge-y">Editing: ${esc(item&&item.title||'Untitled')}</span>` : ''}
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('h1')">H1</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('h2')">H2</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('bold')"><b>B</b></button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('link')">ğŸ”—</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('list')">â‰¡</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('divider')">â€”</button>
        <button class="btn btn-ghost btn-sm" onclick="csEditorInsertSnippet('img')">ğŸ–¼</button>
      </div>
    </div>

    <!-- Meta row -->
    <div class="grid3" style="margin-bottom:12px">
      <div class="fg mb0">
        <label class="lbl">Title / Label</label>
        <input type="text" id="cs-ed-title" placeholder="e.g. My SEO Article â€” Creatine Guide" value="${esc(title)}"/>
      </div>
      <div class="fg mb0">
        <label class="lbl">Keyword Tag</label>
        <input type="text" id="cs-ed-keyword" placeholder="e.g. creatine supplements" value="${esc(keyword)}"/>
      </div>
      <div class="fg mb0">
        <label class="lbl">Tags (comma separated)</label>
        <input type="text" id="cs-ed-tags" placeholder="seo, health, review" value="${esc(tags)}"/>
      </div>
    </div>

    <!-- Format selector + actions -->
    <div class="flex aic g8" style="margin-bottom:8px;flex-wrap:wrap">
      <div class="mtabs" style="margin-bottom:0">
        <div class="mtab ${format==='markdown'?'on':''}" id="cs-fmt-md" onclick="csSetEditorFormat('markdown')">Markdown</div>
        <div class="mtab ${format==='html'?'on':''}" id="cs-fmt-html" onclick="csSetEditorFormat('html')">HTML</div>
        <div class="mtab ${format==='text'?'on':''}" id="cs-fmt-txt" onclick="csSetEditorFormat('text')">Plain Text</div>
      </div>
      <div class="mtabs" style="margin-bottom:0">
        <div class="mtab" id="cs-view-edit" onclick="csTogglePreview(false)">âœ Edit</div>
        <div class="mtab" id="cs-view-prev" onclick="csTogglePreview(true)">ğŸ‘ Preview</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="csEditorWordCount()">ğŸ“Š Word Count</button>
      <button class="btn btn-ghost btn-sm" onclick="csEditorClear()">ğŸ—‘ Clear</button>
      <button class="btn btn-ghost btn-sm" onclick="csEditorFromClipboard()">ğŸ“‹ Paste from Clipboard</button>
      <span id="cs-wc-display" style="font-family:var(--mono);font-size:10px;color:var(--muted2)"></span>
    </div>

    <!-- EDITOR AREA -->
    <div id="cs-editor-wrap" style="position:relative">
      <textarea
        id="cs-editor-ta"
        spellcheck="true"
        rows="22"
        placeholder="${format==='html' ? 'Paste or type your HTML here...\n\n<h1>Your Title</h1>\n<p>Your content...</p>' : format==='markdown' ? 'Paste or type Markdown here...\n\n# Your Title\n\n## Section\n\nYour paragraph...' : 'Paste or type plain text here...'}"
        style="width:100%;background:#0d1117;color:#e6edf3;font-family:var(--mono);font-size:12px;line-height:1.8;border:1px solid #30363d;border-radius:8px;padding:16px;resize:vertical;min-height:400px;tab-size:2"
        oninput="csEditorOnInput()"
      >${esc(content)}</textarea>
      <div id="cs-preview-wrap" style="display:none;border:1px solid var(--border);border-radius:8px;min-height:400px;background:#fff;overflow:hidden">
        <iframe id="cs-preview-frame" style="width:100%;height:500px;border:none" title="preview"></iframe>
      </div>
    </div>

    <!-- Character / word count bar -->
    <div style="display:flex;gap:16px;margin-top:6px;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-family:var(--mono);font-size:10px;color:var(--muted2)">
      <span id="cs-char-count">0 chars</span>
      <span id="cs-word-count">0 words</span>
      <span id="cs-line-count">0 lines</span>
      <span id="cs-format-indicator" style="margin-left:auto;color:var(--accent);font-weight:700">${format.toUpperCase()}</span>
    </div>

    <!-- SAVE + ACTION BUTTONS -->
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn btn-primary" onclick="csSaveToLibrary('${editId||''}')">
        ğŸ’¾ ${editId ? 'Update in Library' : 'Save to Library'}
      </button>
      <button class="btn btn-ghost" onclick="csEditorDownload()">â¬‡ Download File</button>
      <button class="btn btn-ghost" onclick="csEditorCopyContent()">ğŸ“‹ Copy Content</button>
      <div style="width:1px;height:24px;background:var(--border);margin:0 4px"></div>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Send to:</span>
      <button class="btn btn-yellow btn-sm" onclick="csSendToGlobalBlast()">ğŸŒ Global Blast</button>
      <button class="btn btn-blue btn-sm" onclick="csSendToBlogCommenter()">ğŸ’¬ Blog Commenter</button>
      <button class="btn btn-ghost btn-sm" onclick="csSendToCampaign()">â–¶ Campaign</button>
      ${editId ? `<button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="csEditorNew()">+ New Content</button>` : ''}
    </div>

    <!-- SEND SUCCESS TOAST -->
    <div id="cs-send-toast" style="display:none;margin-top:8px;padding:8px 14px;background:rgba(0,87,255,0.07);border:1px solid rgba(0,87,255,0.2);border-radius:6px;font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:700"></div>
  </div>`;
}

function csSetEditorFormat(fmt){
  _csEditorFormat = fmt;
  ['md','html','txt'].forEach(f=>{
    const el=document.getElementById('cs-fmt-'+f);
    if(el) el.classList.remove('on');
  });
  const map={markdown:'md',html:'html',text:'txt'};
  const tabEl=document.getElementById('cs-fmt-'+map[fmt]);
  if(tabEl) tabEl.classList.add('on');
  const fi=document.getElementById('cs-format-indicator');
  if(fi) fi.textContent=fmt.toUpperCase();
  const ta=document.getElementById('cs-editor-ta');
  if(ta){
    const ph={markdown:'Paste or type Markdown...\n\n# Your Title\n\n## Section\n\nYour paragraph...',html:'Paste or type HTML...\n\n<h1>Your Title</h1>\n<p>Content here...</p>',text:'Paste or type plain text...'};
    ta.placeholder=ph[fmt]||'';
  }
}

function csTogglePreview(show){
  const ta=document.getElementById('cs-editor-ta');
  const pw=document.getElementById('cs-preview-wrap');
  const editTab=document.getElementById('cs-view-edit');
  const prevTab=document.getElementById('cs-view-prev');
  if(!ta||!pw) return;
  _csPreviewMode=show;
  ta.style.display=show?'none':'';
  pw.style.display=show?'':'none';
  if(editTab) editTab.classList.toggle('on',!show);
  if(prevTab) prevTab.classList.toggle('on',show);
  if(show){
    const content=ta.value;
    const frame=document.getElementById('cs-preview-frame');
    if(frame){
      const html = _csEditorFormat==='html' ? content : _csEditorFormat==='markdown' ? mdToHtml(content) : `<html><body style="font-family:system-ui;padding:20px;white-space:pre-wrap;line-height:1.7">${esc(content)}</body></html>`;
      frame.srcdoc=html;
    }
  }
}

function csEditorOnInput(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  const val=ta.value;
  const chars=document.getElementById('cs-char-count');
  const words=document.getElementById('cs-word-count');
  const lines=document.getElementById('cs-line-count');
  if(chars) chars.textContent=val.length.toLocaleString()+' chars';
  if(words) words.textContent=(val.trim()?val.trim().split(/\s+/).length:0).toLocaleString()+' words';
  if(lines) lines.textContent=val.split('\n').length+' lines';
}

function csEditorWordCount(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  const words=ta.value.trim()?ta.value.trim().split(/\s+/).length:0;
  const chars=ta.value.length;
  const readTime=Math.ceil(words/200);
  alert(`ğŸ“Š Word Count Stats\n\nWords: ${words.toLocaleString()}\nCharacters: ${chars.toLocaleString()}\nLines: ${ta.value.split('\n').length}\nEstimated read time: ~${readTime} min`);
}

function csEditorClear(){
  if(!confirm('Clear the editor? This cannot be undone.')) return;
  const ta=document.getElementById('cs-editor-ta');
  if(ta){ ta.value=''; csEditorOnInput(); }
  const titleEl=document.getElementById('cs-ed-title');
  const kwEl=document.getElementById('cs-ed-keyword');
  const tagsEl=document.getElementById('cs-ed-tags');
  if(titleEl) titleEl.value='';
  if(kwEl) kwEl.value='';
  if(tagsEl) tagsEl.value='';
  _csActiveEditor=null;
}

function csEditorNew(){
  _csActiveEditor=null;
  const wrap=document.getElementById('cs-tab-manual-panel');
  if(wrap) wrap.innerHTML=csRenderEditor();
}

async function csEditorFromClipboard(){
  try{
    const text=await navigator.clipboard.readText();
    const ta=document.getElementById('cs-editor-ta');
    if(ta){ ta.value=text; csEditorOnInput(); }
  } catch(e){
    alert('Clipboard access denied. Please paste manually (Ctrl+V) into the editor.');
  }
}

function csEditorInsertSnippet(type){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  const isMd=_csEditorFormat==='markdown';
  const isHtml=_csEditorFormat==='html';
  const snippets={
    h1:   isMd?'# Your H1 Title\n'        :'<h1>Your H1 Title</h1>\n',
    h2:   isMd?'\n## Section Heading\n'    :'<h2>Section Heading</h2>\n',
    bold: isMd?'**bold text**'             :'<strong>bold text</strong>',
    link: isMd?'[Link Text](https://example.com)':'<a href="https://example.com">Link Text</a>',
    list: isMd?'\n- Item one\n- Item two\n- Item three\n':'<ul>\n  <li>Item one</li>\n  <li>Item two</li>\n</ul>\n',
    divider: isMd?'\n---\n':'\n<hr/>\n',
    img:  isMd?'![Alt text](https://example.com/image.jpg)':'<img src="https://example.com/image.jpg" alt="Description" style="width:100%"/>',
  };
  const snippet=snippets[type]||'';
  const start=ta.selectionStart;
  const end=ta.selectionEnd;
  ta.value=ta.value.slice(0,start)+snippet+ta.value.slice(end);
  ta.selectionStart=ta.selectionEnd=start+snippet.length;
  ta.focus();
  csEditorOnInput();
}

function csSaveToLibrary(editId){
  const titleEl=document.getElementById('cs-ed-title');
  const taEl=document.getElementById('cs-editor-ta');
  const kwEl=document.getElementById('cs-ed-keyword');
  const tagsEl=document.getElementById('cs-ed-tags');
  const title=(titleEl&&titleEl.value.trim())||'Untitled Content';
  const content=(taEl&&taEl.value)||'';
  const keyword=(kwEl&&kwEl.value.trim())||'';
  const tags=(tagsEl&&tagsEl.value.trim())||'';
  if(!content.trim()){ alert('Add some content before saving.'); return; }

  if(editId){
    const idx=_contentLibrary.findIndex(c=>c.id===editId);
    if(idx>-1){
      _contentLibrary[idx]={..._contentLibrary[idx],title,content,format:_csEditorFormat,keyword,tags,updated:ts()};
    }
  } else {
    _contentLibrary.unshift({id:csGenId(),title,content,format:_csEditorFormat,keyword,tags,created:ts(),updated:ts()});
  }
  csSaveLibrary();
  csUpdateLibCount();

  const toast=document.getElementById('cs-send-toast');
  if(toast){ toast.style.display=''; toast.innerHTML='âœ… Saved to Content Library! Switch to ğŸ“š Library tab to manage and use it.'; setTimeout(()=>toast.style.display='none',4000); }
}

function csUpdateLibCount(){
  const el=document.getElementById('cs-lib-count');
  if(el) el.textContent=_contentLibrary.length;
}

function csEditorDownload(){
  const ta=document.getElementById('cs-editor-ta');
  const titleEl=document.getElementById('cs-ed-title');
  const content=(ta&&ta.value)||'';
  const title=slug((titleEl&&titleEl.value)||'content');
  const ext={markdown:'md',html:'html',text:'txt'}[_csEditorFormat]||'txt';
  const mime={markdown:'text/markdown',html:'text/html',text:'text/plain'}[_csEditorFormat]||'text/plain';
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=title+'.'+ext;a.click();
}

function csEditorCopyContent(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta) return;
  navigator.clipboard.writeText(ta.value).then(()=>{
    const toast=document.getElementById('cs-send-toast');
    if(toast){ toast.style.display=''; toast.innerHTML='ğŸ“‹ Content copied to clipboard!'; setTimeout(()=>toast.style.display='none',2500); }
  }).catch(()=>{ ta.select(); document.execCommand('copy'); });
}

function csSendToGlobalBlast(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta||!ta.value.trim()){ alert('Nothing to send â€” write some content first.'); return; }
  // Store in sessionStorage for Global Blast to pick up
  sessionStorage.setItem('cs_blast_content', ta.value);
  sessionStorage.setItem('cs_blast_format', _csEditorFormat);
  const titleEl=document.getElementById('cs-ed-title');
  sessionStorage.setItem('cs_blast_title', (titleEl&&titleEl.value)||'');
  const toast=document.getElementById('cs-send-toast');
  if(toast){ toast.style.display=''; toast.innerHTML='ğŸŒ Content sent to Global Blast! Go to Global Blast â†’ it\'s loaded and ready to publish.'; setTimeout(()=>toast.style.display='none',5000); }
  // Save to library automatically
  csSaveToLibrary('');
}

function csSendToBlogCommenter(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta||!ta.value.trim()){ alert('Nothing to send.'); return; }
  // Convert content to a short comment excerpt
  const raw=ta.value.replace(/<[^>]+>/g,' ').replace(/[#*_\[\]`]/g,'').replace(/\s+/g,' ').trim();
  const excerpt=raw.slice(0,300)+(raw.length>300?'...':'');
  // Switch to blog commenter page and pre-fill the comment box
  sessionStorage.setItem('cs_comment_content', excerpt);
  renderPage('blog_commenter');
  setTimeout(()=>{
    const commentEl=document.getElementById('bc-gen-out');
    if(commentEl){ commentEl.value=excerpt; }
    const toast=document.getElementById('cs-send-toast');
    if(toast){ toast.style.display=''; toast.innerHTML='ğŸ’¬ Content sent to Blog Commenter as comment text!'; setTimeout(()=>toast.style.display='none',4000); }
  },300);
}

function csSendToCampaign(){
  const ta=document.getElementById('cs-editor-ta');
  if(!ta||!ta.value.trim()){ alert('Nothing to send.'); return; }
  sessionStorage.setItem('cs_campaign_content', ta.value);
  sessionStorage.setItem('cs_campaign_format', _csEditorFormat);
  const toast=document.getElementById('cs-send-toast');
  if(toast){ toast.style.display=''; toast.innerHTML='â–¶ Content queued for Campaign! Go to Run Campaign â†’ it will use this content.'; setTimeout(()=>toast.style.display='none',4000); }
  csSaveToLibrary('');
}

// â”€â”€ CONTENT LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csRenderLibrary(){
  if(!_contentLibrary.length) return `
    <div class="card">
      <div class="card-title">ğŸ“š Content Library</div>
      <div style="text-align:center;padding:40px 20px">
        <div style="font-size:40px;margin-bottom:10px">ğŸ“</div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--muted2);font-weight:600">No saved content yet</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:6px">Go to âœ Manual Editor â†’ write or paste content â†’ click "Save to Library"</div>
      </div>
    </div>`;

  const fmtBadge={markdown:'badge-b',html:'badge-g',text:'badge-p'};

  return `
  <div class="card">
    <div class="card-title flex aic g8">
      ğŸ“š Content Library
      <span class="nav-badge">${_contentLibrary.length} items</span>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="csLibExportAll()">ğŸ“¤ Export All</button>
        <button class="btn btn-danger btn-sm" onclick="csLibClearAll()">ğŸ—‘ Clear All</button>
      </div>
    </div>

    <!-- Filter bar -->
    <div class="flex aic g8" style="margin-bottom:14px;flex-wrap:wrap">
      <input type="text" id="cs-lib-search" placeholder="Search by title, keyword, tags..." style="flex:1;min-width:200px" oninput="csRefreshLibrary()"/>
      <select id="cs-lib-filter-fmt" onchange="csRefreshLibrary()" style="width:140px">
        <option value="">All Formats</option>
        <option value="markdown">Markdown</option>
        <option value="html">HTML</option>
        <option value="text">Plain Text</option>
      </select>
    </div>

    <div id="cs-lib-items">
      ${csRenderLibraryItems()}
    </div>
  </div>`;
}

function csRenderLibraryItems(){
  const search=(document.getElementById('cs-lib-search')||{value:''}).value.toLowerCase();
  const fmtFilter=(document.getElementById('cs-lib-filter-fmt')||{value:''}).value;
  const fmtBadge={markdown:'badge-b',html:'badge-g',text:'badge-p'};

  let items=_contentLibrary;
  if(search) items=items.filter(c=>(c.title+' '+c.keyword+' '+c.tags).toLowerCase().includes(search));
  if(fmtFilter) items=items.filter(c=>c.format===fmtFilter);

  if(!items.length) return '<div style="padding:20px;text-align:center;font-family:var(--mono);font-size:11px;color:var(--muted2)">No results match your search.</div>';

  return items.map(c=>`
    <div style="border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:10px;background:var(--bg);transition:border-color 0.1s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
      <div class="flex aic g8" style="margin-bottom:8px">
        <div style="font-size:14px">${{markdown:'ğŸ“',html:'ğŸŒ',text:'ğŸ“„'}[c.format]||'ğŸ“„'}</div>
        <div style="flex:1;font-family:var(--sans);font-size:13px;font-weight:700;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.title||'Untitled')}</div>
        <span class="badge ${fmtBadge[c.format]||'badge-b'}">${(c.format||'text').toUpperCase()}</span>
        ${c.keyword?`<span class="badge badge-y">${esc(c.keyword)}</span>`:''}
      </div>
      ${c.tags?`<div style="margin-bottom:6px">${c.tags.split(',').map(t=>`<span style="display:inline-block;margin-right:4px;margin-bottom:4px;padding:2px 8px;background:var(--surface);border:1px solid var(--border2);border-radius:4px;font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(t.trim())}</span>`).join('')}</div>`:''}
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted2);background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 10px;margin-bottom:10px;max-height:56px;overflow:hidden;line-height:1.7">
        ${esc((c.content||'').replace(/<[^>]+>/g,' ').replace(/[#*_`]/g,'').trim().slice(0,200))}${(c.content||'').length>200?'â€¦':''}
      </div>
      <div class="flex aic g8" style="flex-wrap:wrap">
        <span style="font-family:var(--mono);font-size:9px;color:var(--muted)">Saved ${c.updated||c.created||''}</span>
        <span style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${(c.content||'').trim().split(/\s+/).filter(Boolean).length} words</span>
        <div style="margin-left:auto;display:flex;gap:5px;flex-wrap:wrap">
          <button class="btn btn-ghost btn-xs" onclick="csLibEdit('${c.id}')">âœ Edit</button>
          <button class="btn btn-ghost btn-xs" onclick="csLibPreview('${c.id}')">ğŸ‘ Preview</button>
          <button class="btn btn-ghost btn-xs" onclick="csLibCopy('${c.id}')">ğŸ“‹ Copy</button>
          <button class="btn btn-ghost btn-xs" onclick="csLibDownload('${c.id}')">â¬‡ Download</button>
          <button class="btn btn-yellow btn-xs" onclick="csLibBlast('${c.id}')">ğŸŒ Blast</button>
          <button class="btn btn-blue btn-xs" onclick="csLibComment('${c.id}')">ğŸ’¬ Comment</button>
          <button class="btn btn-danger btn-xs" onclick="csLibDelete('${c.id}')">âœ•</button>
        </div>
      </div>
    </div>`).join('');
}

function csRefreshLibrary(){
  const el=document.getElementById('cs-lib-items');
  if(el) el.innerHTML=csRenderLibraryItems();
}

function csLibEdit(id){
  _csActiveEditor=id;
  const panel=document.getElementById('cs-tab-manual-panel');
  if(panel){ panel.innerHTML=csRenderEditor(id); }
  csTab('manual');
  const item=_contentLibrary.find(c=>c.id===id);
  if(item) _csEditorFormat=item.format||'markdown';
  setTimeout(csEditorOnInput,100);
}

function csLibPreview(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  const html = item.format==='html' ? item.content : item.format==='markdown' ? mdToHtml(item.content) : `<html><body style="font-family:system-ui;padding:24px;white-space:pre-wrap;line-height:1.7;color:#1e293b">${esc(item.content)}</body></html>`;
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`<div class="modal-box" style="min-width:700px;max-width:90vw;max-height:88vh;overflow:hidden;display:flex;flex-direction:column">
    <div class="modal-title">${esc(item.title||'Preview')} <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ• Close</button></div>
    <iframe srcdoc="${html.replace(/"/g,'&quot;')}" style="flex:1;border:1px solid var(--border);border-radius:8px;min-height:500px" title="preview"></iframe>
    <div class="row" style="margin-top:12px">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-primary" onclick="csLibEdit('${id}');this.closest('.modal-overlay').remove()">âœ Edit</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function csLibCopy(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  navigator.clipboard.writeText(item.content).then(()=>alert('âœ… Content copied to clipboard!')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=item.content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('âœ… Copied!');
  });
}

function csLibDownload(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  const ext={markdown:'md',html:'html',text:'txt'}[item.format]||'txt';
  const mime={markdown:'text/markdown',html:'text/html',text:'text/plain'}[item.format]||'text/plain';
  const blob=new Blob([item.content],{type:mime});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=slug(item.title||'content')+'.'+ext;a.click();
}

function csLibBlast(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  sessionStorage.setItem('cs_blast_content', item.content);
  sessionStorage.setItem('cs_blast_format', item.format);
  sessionStorage.setItem('cs_blast_title', item.title||'');
  renderPage('global_blast');
  setTimeout(()=>alert('âœ… Content loaded into Global Blast! Configure your platforms and click Blast.'),300);
}

function csLibComment(id){
  const item=_contentLibrary.find(c=>c.id===id);
  if(!item) return;
  const raw=item.content.replace(/<[^>]+>/g,' ').replace(/[#*_\[\]`]/g,'').replace(/\s+/g,' ').trim();
  const excerpt=raw.slice(0,300)+(raw.length>300?'...':'');
  sessionStorage.setItem('cs_comment_content', excerpt);
  renderPage('blog_commenter');
  setTimeout(()=>{ const el=document.getElementById('bc-gen-out'); if(el) el.value=excerpt; },300);
}

function csLibDelete(id){
  if(!confirm('Delete this content item?')) return;
  _contentLibrary=_contentLibrary.filter(c=>c.id!==id);
  csSaveLibrary();
  csUpdateLibCount();
  csRefreshLibrary();
}

function csLibClearAll(){
  if(!confirm('Delete ALL saved content? This cannot be undone.')) return;
  _contentLibrary=[];
  csSaveLibrary();
  csUpdateLibCount();
  const panel=document.getElementById('cs-tab-library-panel');
  if(panel) panel.innerHTML=csRenderLibrary();
}

function csLibExportAll(){
  if(!_contentLibrary.length){ alert('Library is empty.'); return; }
  const json=JSON.stringify(_contentLibrary,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='content-library-'+Date.now()+'.json';a.click();
}

// â”€â”€ SHARED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateStudioContent(){
  const sel=(document.getElementById('studio-kw-sel')||{value:''}).value;
  const custom=(document.getElementById('studio-kw-custom')||{value:''}).value.trim();
  const kw=custom||sel;
  if(!kw){ alert('Select or enter a keyword first.'); return; }
  const count=Math.min(5,Math.max(1,parseInt((document.getElementById('studio-count')||{value:3}).value)||3));
  _studioArticles=[];
  for(let i=0;i<count;i++){
    _studioArticles.push(generateMarkdown(kw,S.links,i,S.keywords,'user','site.com'));
  }
  _studioActiveIdx=0;
  renderStudioOutput(kw);
}
function renderStudioOutput(kw){
  const el=document.getElementById('studio-output'); if(!el) return;
  if(!_studioArticles.length){ el.innerHTML=''; return; }
  const cur=_studioArticles[_studioActiveIdx]||'';
  el.innerHTML=`<div class="card">
    <div class="card-title">Variations</div>
    <div class="mtabs">
      ${_studioArticles.map((_,i)=>`<div class="mtab ${_studioActiveIdx===i?'on':''}" onclick="setStudioArticle(${i},'${esc(kw)}')">Variation ${i+1}</div>`).join('')}
    </div>
    <div class="flex aic g8" style="margin-bottom:8px">
      <div class="mtabs" style="margin-bottom:0">
        <div class="mtab ${_studioFormat==='markdown'?'on':''}" onclick="setStudioFormat('markdown','${esc(kw)}')">Markdown</div>
        <div class="mtab ${_studioFormat==='preview'?'on':''}" onclick="setStudioFormat('preview','${esc(kw)}')">Preview</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="copyText(document.getElementById('studio-ta').value, this)">COPY MARKDOWN</button>
      <button class="btn btn-ghost btn-sm" onclick="downloadMd('${esc(kw)}',${_studioActiveIdx})">â¬‡ Download .md</button>
      <button class="btn btn-primary btn-sm" onclick="csSaveGeneratedToLib(${_studioActiveIdx},'${esc(kw)}')">ğŸ’¾ Save to Library</button>
    </div>
    ${_studioFormat==='markdown'?`<textarea id="studio-ta" readonly rows="18" style="background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;line-height:1.7;border:1px solid var(--border);border-radius:6px;font-weight:600">${esc(cur)}</textarea>`
    :`<div style="background:white;padding:2px;min-height:300px"><iframe id="studio-frame" style="width:100%;height:420px;border:none" title="preview"></iframe></div>`}
  </div>`;
  if(_studioFormat==='preview'){
    const frame=document.getElementById('studio-frame');
    if(frame){ const html=mdToHtml(cur); frame.srcdoc=html; }
  }
}
function csSaveGeneratedToLib(idx,kw){
  const content=_studioArticles[idx]||'';
  if(!content) return;
  _contentLibrary.unshift({id:csGenId(),title:'Generated: '+kw+' (Var '+(idx+1)+')',content,format:'markdown',keyword:kw,tags:'generated,auto',created:ts(),updated:ts()});
  csSaveLibrary();
  csUpdateLibCount();
  alert('âœ… Saved to Content Library!');
}
function setStudioArticle(i,kw){ _studioActiveIdx=i; renderStudioOutput(kw); }
function setStudioFormat(f,kw){ _studioFormat=f; renderStudioOutput(kw); }
function mdToHtml(md){
  const lines=md.split('\n');
  const parts=lines.map(line=>{
    if(line.startsWith('# ')) return '<h1 style="font-size:1.8em;font-weight:800;margin:16px 0 8px;color:#1e1b4b">'+esc(line.slice(2))+'</h1>';
    if(line.startsWith('## ')) return '<h2 style="font-size:1.3em;font-weight:700;margin:14px 0 6px;color:#312e81">'+esc(line.slice(3))+'</h2>';
    if(line.startsWith('### ')) return '<h3 style="font-size:1.1em;font-weight:600;margin:10px 0 4px">'+esc(line.slice(4))+'</h3>';
    if(line.startsWith('- ')) return '<li style="margin:4px 0;margin-left:20px">'+esc(line.slice(2))+'</li>';
    if(line.trim()==='---') return '<hr style="border:none;border-top:1px solid #e2e8f0;margin:16px 0"/>';
    if(line.trim()==='') return '<br/>';
    return '<p style="margin:8px 0;color:#475569;line-height:1.7">'+esc(line)+'</p>';
  });
  return '<html><body style="font-family:system-ui;padding:20px;max-width:700px;margin:0 auto;line-height:1.7;color:#1e293b">'+parts.join('')+'</body></html>';
}
function downloadMd(kw,idx){
  const content=_studioArticles[idx]||'';
  const blob=new Blob([content],{type:'text/markdown'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=slug(kw)+'-v'+(idx+1)+'.md'; a.click();
}

// â”€â”€â”€ COMPETITOR SPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _spyNotes=[];
let _serpResults=[];
let _spyAbortGap=false;
function spyStopGap(){ _spyAbortGap=true; const btn=document.getElementById('serp-stop-btn'); if(btn) btn.style.display='none'; }
function renderCompetitorSpy(el){
  el.innerHTML=`
  <div class="page-title">ğŸ•µ Competitor Spy</div>
  <div class="page-sub">// real-time competitor analysis Â· live SERP gap finder Â· parasite opportunities</div>

  <div class="card">
    <div class="card-title">ğŸ” URL Analyzer â€” Real-Time</div>
    <div class="grid3" style="margin-bottom:10px">
      <div class="fg mb0"><label class="lbl">Competitor URL</label>
        <input type="url" id="spy-url" placeholder="https://medium.com/@user/article-slug" style="font-size:12px"/></div>
      <div class="fg mb0"><label class="lbl">Target Keyword (optional)</label>
        <input type="text" id="spy-kw" placeholder="e.g. weight loss tips"/></div>
      <div class="fg mb0 flex aic" style="align-items:flex-end;gap:8px">
        <button class="btn btn-primary f1" onclick="analyzeUrl()">ğŸ” Analyze URL</button>
        <button class="btn btn-blue btn-sm" onclick="spyFetchPage()" title="Fetch real page content">ğŸŒ Fetch Live</button>
      </div>
    </div>
    <div id="spy-result"></div>
    <div id="spy-live-result" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="card-title">âš¡ SERP Gap Finder â€” Live Platform Search</div>
    <div class="grid3" style="margin-bottom:10px">
      <div class="fg mb0"><label class="lbl">Keyword</label>
        <input type="text" id="serp-kw" placeholder="e.g. celebrity net worth, weight loss"/></div>
      <div class="fg mb0"><label class="lbl">Search Engine</label>
        <select id="serp-engine"><option value="google">Google</option><option value="bing">Bing</option><option value="duckduckgo">DuckDuckGo</option></select></div>
      <div class="fg mb0 flex aic" style="align-items:flex-end;gap:8px">
        <button class="btn btn-yellow f1" onclick="findSerpGaps()">âš¡ Find SERP Gaps</button>
        <button class="btn btn-danger btn-sm" id="serp-stop-btn" onclick="spyStopGap()" style="display:none">â¹ Stop</button>
      </div>
    </div>
    <div id="serp-terminal" style="display:none;background:#0d1117;border:1px solid #30363d;padding:12px;font-family:var(--mono);font-size:10px;height:150px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9;margin-bottom:10px"></div>
    <div id="serp-result"></div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ§  Multi-URL Competitor Comparison</div>
    <div class="row" style="margin-bottom:10px">
      <div class="f1 fg mb0"><textarea id="spy-multi-urls" rows="3" placeholder="Paste one URL per line to compare multiple competitor pages..."></textarea></div>
    </div>
    <div class="row">
      <button class="btn btn-primary" onclick="spyCompareMulti()">Compare All</button>
      <button class="btn btn-ghost btn-sm" onclick="spyExportComparison()">Export CSV</button>
    </div>
    <div id="spy-multi-result" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="card-title">Research Notes</div>
    <div class="row">
      <div class="f1 fg mb0"><input type="text" id="spy-note" placeholder="Add a research note..."/></div>
      <button class="btn btn-primary" onclick="addSpyNote()">+ Add</button>
    </div>
    <div id="spy-notes">${renderSpyNotes()}</div>
  </div>

  <div class="card">
    <div class="card-title">Parasite SEO Cheat Sheet</div>
    <div style="font-family:var(--mono);font-size:12px;line-height:2.2;color:var(--text);font-weight:600">
      ${[['ta','Target DA 90+ platforms first: Reddit, Blogger, Medium, Notion, WordPress'],['ta','Use exact-match keyword slugs in page titles and repo names'],['ta','Add internal links between your parasite pages to pass link equity'],['ta','Telegraph.ph is easiest â€” no account needed, instant indexing'],['ta','GitHub/GitLab require 24-48h for Pages to go live first time'],['ta','Use IndexNow to submit all URLs immediately after publishing'],['ty','Avoid duplicate content â€” use Content Studio to spin variations'],['ty','Add at least one contextual backlink to your money site from each page']].map(([cls,t])=>`<div><span class="${cls}">â–¶</span> ${esc(t)}</div>`).join('')}
    </div>
  </div>`;
  document.getElementById('spy-url').addEventListener('keydown',e=>{ if(e.key==='Enter') analyzeUrl(); });
  document.getElementById('spy-note').addEventListener('keydown',e=>{ if(e.key==='Enter') addSpyNote(); });
  document.getElementById('serp-kw').addEventListener('keydown',e=>{ if(e.key==='Enter') findSerpGaps(); });
}

function analyzeUrl(){
  const url=(document.getElementById('spy-url')||{value:''}).value.trim();
  const kw=(document.getElementById('spy-kw')||{value:''}).value.trim();
  const el=document.getElementById('spy-result'); if(!el) return;
  if(!url){ el.innerHTML=''; return; }
  try{
    const u=new URL(url.startsWith('http')?url:'https://'+url);
    const hostname=u.hostname; const path=u.pathname;
    const platform=PLATFORMS.find(p=>hostname.includes(p.domain));
    const segs=path.split('/').filter(Boolean);
    const kwFromSlug=(segs[segs.length-1]||'').replace(/-/g,' ');
    const hasKwInPath=kw?path.toLowerCase().includes(slug(kw)):null;
    const estimatedDA = platform ? platform.da : Math.min(95, Math.max(20, 35 + (hostname.split('.').length*5)));
    const wordCount = kw ? (kw.split(' ').length) : 0;
    const kwDensity = wordCount > 0 && kwFromSlug ? (kwFromSlug.toLowerCase().includes(kw.toLowerCase().split(' ')[0]) ? 'Good â€” keyword in slug' : 'Weak â€” keyword not in slug') : 'â€”';
    el.innerHTML=`<div style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-family:var(--mono);font-size:10px">
      ${[
        ['Platform',platform?(platform.icon+' '+platform.name):'Unknown / Non-parasite','ta'],
        ['Domain Authority',platform?platform.da+'  ('+( platform.da>=90?'Very High':platform.da>=80?'High':platform.da>=60?'Medium':'Low')+')':'~35','ty'],
        ['Hostname',hostname,'tb'],
        ['Path Depth',segs.length+' levels deep','tm'],
        ['Keyword from Slug',kwFromSlug||'â€” (no slug)','ta'],
        ['Slug KW Match',kwDensity,'ta'],
        ['Ranking Potential',platform?'High â€” '+platform.name+' pages rank well':'Unknown','ta'],
        ['Content Path',segs.slice(0,-1).join('/') || '(root)','tb'],
        ['URL Length',url.length+' chars '+(url.length>100?'âš  Long':'âœ“ Good'),'tm'],
      ].map(([l,v,c])=>
        `<div style="padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px"><div class="lbl" style="margin-bottom:3px">${l}</div><div class="${c}" style="font-weight:700;font-size:11px">${esc(String(v))}</div></div>`).join('')}
    </div>
    ${hasKwInPath===true?'<div class="notice notice-success mt8">âœ“ Target keyword found in URL path â€” strong on-page signal!</div>':hasKwInPath===false&&kw?'<div class="notice notice-warn mt8">âš  Target keyword NOT in URL path â€” weaker signal.</div>':''}
    ${!platform?'<div class="notice notice-warn mt8">âš  Not a known parasite platform. Try: medium.com, blogspot.com, reddit.com, dev.to, hashnode.dev</div>':''}
    <div class="flex g8 mt8" style="flex-wrap:wrap">
      <button class="btn btn-ghost btn-xs" onclick="window.open('${esc(url.startsWith('http')?url:'https://'+url)}','_blank')">Open URL â†’</button>
      <button class="btn btn-ghost btn-xs" onclick="window.open('https://search.google.com/search-console','_blank')">Search Console</button>
      <button class="btn btn-primary btn-xs" onclick="document.getElementById('serp-kw').value='${esc(kwFromSlug||kw)}';findSerpGaps()">Find SERP Gaps for this KW</button>
    </div>`;
  }catch(e){ el.innerHTML='<div class="notice notice-err mt8">Error: '+esc(e.message)+'</div>'; }
}

async function spyFetchPage(){
  const url=(document.getElementById('spy-url')||{value:''}).value.trim();
  const kw=(document.getElementById('spy-kw')||{value:''}).value.trim();
  const el=document.getElementById('spy-live-result'); if(!el) return;
  if(!url){ alert('Enter a URL first.'); return; }
  el.innerHTML='<div class="tm mono xs"><span class="spinner"></span> Fetching live page via proxy...</div>';
  const result = await bcProxyFetch(url.startsWith('http')?url:'https://'+url, {timeout:18000});
  if(!result.ok||result.text.length < 100){
    el.innerHTML=`<div class="notice notice-warn">Could not fetch page content (status: ${result.status||'error'}). The site may block proxies.</div>`;
    return;
  }
  const parser = new DOMParser();
  const doc = parser.parseFromString(result.text, 'text/html');
  const title = (doc.querySelector('title')||{textContent:'â€”'}).textContent.trim();
  const desc = (doc.querySelector('meta[name="description"]')||{content:'â€”'}).content||'â€”';
  const h1s = [...doc.querySelectorAll('h1')].map(h=>h.textContent.trim()).filter(Boolean).slice(0,3);
  const h2s = [...doc.querySelectorAll('h2')].map(h=>h.textContent.trim()).filter(Boolean).slice(0,6);
  const wordCount = (doc.body||{textContent:''}).textContent.trim().split(/\s+/).length;
  const images = doc.querySelectorAll('img').length;
  const links = doc.querySelectorAll('a[href]').length;
  const hasComments = result.text.toLowerCase().includes('leave a comment') || result.text.toLowerCase().includes('leave a reply') || result.text.toLowerCase().includes('post a comment');
  const kwInTitle = kw ? (title.toLowerCase().includes(kw.toLowerCase()) ? 'âœ… Yes' : 'âŒ No') : 'â€”';
  const kwInDesc = kw ? (desc.toLowerCase().includes(kw.toLowerCase()) ? 'âœ… Yes' : 'âŒ No') : 'â€”';
  el.innerHTML=`
  <div class="card" style="margin-top:0;background:rgba(0,87,255,0.03);border-color:rgba(0,87,255,0.2)">
    <div class="card-title">ğŸŒ Live Page Data [${result.proxy}]</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-family:var(--mono);font-size:10px;margin-bottom:12px">
      ${[
        ['Page Title',title.slice(0,50)+(title.length>50?'...':''),'ta'],
        ['Word Count',wordCount+' words'+(wordCount>800?'  (good)':wordCount>400?' (medium)':' (thin)'),'ty'],
        ['Images',images+' images','tb'],
        ['Links',links+' outbound links','tm'],
        ['KW in Title',kwInTitle,'ta'],
        ['KW in Desc',kwInDesc,'ta'],
        ['Comment Section',hasComments?'âœ… Found':'âŒ Not detected','ta'],
        ['Proxy Used',result.proxy,'tm'],
        ['Content Size',result.text.length+' bytes','tm'],
      ].map(([l,v,c])=>`<div style="padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px"><div class="lbl" style="margin-bottom:2px">${l}</div><div class="${c}" style="font-weight:700;font-size:11px">${esc(String(v))}</div></div>`).join('')}
    </div>
    ${h1s.length?`<div style="margin-bottom:8px"><div class="lbl">H1 Tags</div>${h1s.map(h=>`<div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:700;padding:3px 0">${esc(h)}</div>`).join('')}</div>`:''}
    ${h2s.length?`<div><div class="lbl">H2 Tags (subheadings)</div>${h2s.map(h=>`<div style="font-family:var(--mono);font-size:10px;color:var(--text);padding:2px 0">â–¶ ${esc(h)}</div>`).join('')}</div>`:''}
    ${desc&&desc!=='â€”'?`<div style="margin-top:8px"><div class="lbl">Meta Description</div><div style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-style:italic">"${esc(desc.slice(0,200))}"</div></div>`:''}
  </div>`;
}

let _spyMultiResults = [];
async function spyCompareMulti(){
  const raw = (document.getElementById('spy-multi-urls')||{value:''}).value.trim();
  if(!raw){ alert('Paste some URLs to compare.'); return; }
  const urls = raw.split('\n').map(u=>u.trim()).filter(Boolean).slice(0,10);
  const el = document.getElementById('spy-multi-result'); if(!el) return;
  el.innerHTML='<div class="tm mono xs"><span class="spinner"></span> Analyzing '+urls.length+' URLs...</div>';
  _spyMultiResults = [];
  for(const url of urls){
    try {
      const u = new URL(url.startsWith('http')?url:'https://'+url);
      const hostname = u.hostname.replace('www.','');
      const platform = PLATFORMS.find(p=>hostname.includes(p.domain));
      const segs = u.pathname.split('/').filter(Boolean);
      const kwFromSlug = (segs[segs.length-1]||'').replace(/-/g,' ');
      _spyMultiResults.push({url, hostname, da: platform?platform.da:35, platform: platform?platform.name:'Unknown', slug: kwFromSlug, depth: segs.length});
    } catch(e){ _spyMultiResults.push({url, hostname:'error', da:0, platform:'Error', slug:'', depth:0}); }
  }
  _spyMultiResults.sort((a,b)=>b.da-a.da);
  el.innerHTML=`<div class="tw" style="margin-top:0"><table><thead><tr><th>#</th><th>Domain</th><th>Platform</th><th>DA</th><th>Depth</th><th>Keyword Slug</th><th>URL</th></tr></thead><tbody>
    ${_spyMultiResults.map((r,i)=>`<tr>
      <td class="mono xs tm">${i+1}</td>
      <td class="mono xs ta">${esc(r.hostname)}</td>
      <td class="mono xs">${esc(r.platform)}</td>
      <td><span class="badge ${r.da>=85?'badge-g':r.da>=60?'badge-y':'badge-b'}">${r.da}</span></td>
      <td class="mono xs tm">${r.depth} lvl</td>
      <td class="mono xs tb">${esc(r.slug)||'â€”'}</td>
      <td><a href="${esc(r.url)}" target="_blank" style="font-family:var(--mono);font-size:9px;color:var(--accent4)">Open â†’</a></td>
    </tr>`).join('')}
  </tbody></table></div>`;
}
function spyExportComparison(){
  if(!_spyMultiResults.length){ alert('Run comparison first.'); return; }
  const rows=[['URL','Domain','Platform','DA','Depth','Keyword Slug'],..._spyMultiResults.map(r=>[r.url,r.hostname,r.platform,r.da,r.depth,r.slug])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='spy-comparison-'+Date.now()+'.csv'; a.click();
}
async function findSerpGaps(){
  const kw=(document.getElementById('serp-kw')||{value:''}).value.trim();
  const engine=(document.getElementById('serp-engine')||{value:'google'}).value;
  const el=document.getElementById('serp-result'); if(!el) return;
  const termEl=document.getElementById('serp-terminal');
  const stopBtn=document.getElementById('serp-stop-btn');
  if(!kw){ el.innerHTML=''; return; }

  _spyAbortGap=false;
  if(termEl){ termEl.style.display=''; termEl.innerHTML=''; }
  if(stopBtn) stopBtn.style.display='';
  el.innerHTML='';

  function sgLog(msg,color='#c9d1d9'){
    if(!termEl) return;
    const d=document.createElement('div');
    d.innerHTML=`<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`;
    termEl.appendChild(d); termEl.scrollTop=termEl.scrollHeight;
  }
  sgLog(`ğŸ” Searching SERP for: "${esc(kw)}" via ${engine.toUpperCase()}`,'#58a6ff');
  sgLog(`âŒ¨ Phase 1: SearXNG live results...`,'#d29922');

  const liveUrls = new Set();

  // Phase 1: SearXNG live SERP
  for(const instance of CS_SEARXNG_INSTANCES){
    if(_spyAbortGap) break;
    const urls = await csSearxngSearch(kw, instance, 'any');
    if(urls && urls.length>0){
      urls.forEach(u=>liveUrls.add(u));
      sgLog(`   âœ… SearXNG [${instance.replace('https://','').split('/')[0]}]: ${urls.length} results`,'#3fb950');
      break;
    }
  }

  // Phase 2: Proxy-based search
  if(liveUrls.size < 5 && !_spyAbortGap){
    sgLog(`âŒ¨ Phase 2: Proxy scrape ${engine}...`,'#d29922');
    const r = await csGoogleBingSearch(kw, engine, 'any');
    if(r && r.urls && r.urls.length>0){ r.urls.forEach(u=>liveUrls.add(u)); sgLog(`   âœ… ${engine} via [${r.proxy}]: ${r.urls.length} URLs`,'#3fb950'); }
    const ddg = await csDuckDuckGoSearch(kw);
    if(ddg && ddg.length>0){ ddg.forEach(u=>liveUrls.add(u)); sgLog(`   âœ… DDG: ${ddg.length} URLs`,'#3fb950'); }
  }

  // Analyze which platforms appear in live SERPs
  const liveUrlArr = [...liveUrls];
  sgLog(`ğŸ“Š Analyzing ${liveUrlArr.length} live SERP URLs...`,'#58a6ff');
  const platformCounts={};
  liveUrlArr.forEach(url=>{
    try{
      const hostname=new URL(url).hostname.replace('www.','');
      const match=PLATFORMS.find(p=>hostname.includes(p.domain));
      if(match){ platformCounts[match.id||match.name]=(platformCounts[match.id||match.name]||{count:0,platform:match,urls:[]}); platformCounts[match.id||match.name].count++; platformCounts[match.id||match.name].urls.push(url); }
    }catch(e){}
  });

  // Build gap table â€” platforms already ranking + those not yet ranking
  const sorted=[...PLATFORMS].sort((a,b)=>b.da-a.da);
  const liveData = sorted.map(p=>{
    const key=p.id||p.name;
    const existing=platformCounts[key];
    return { ...p, inSerp: !!(existing&&existing.count>0), serpCount: existing?existing.count:0, serpUrls: existing?existing.urls:[] };
  });

  const alreadyRanking = liveData.filter(p=>p.inSerp);
  const gap = liveData.filter(p=>!p.inSerp);

  sgLog(`âœ… Found ${alreadyRanking.length} platforms already ranking, ${gap.length} gap opportunities`,'#3fb950');
  if(stopBtn) stopBtn.style.display='none';

  el.innerHTML=`
  <div class="grid2" style="gap:10px;margin-bottom:12px">
    <div style="background:rgba(0,87,255,0.06);border:1px solid rgba(0,87,255,0.2);border-radius:10px;padding:14px;text-align:center">
      <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent)">${alreadyRanking.length}</div>
      <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase">ğŸ“ˆ Already Ranking</div>
    </div>
    <div style="background:rgba(217,119,6,0.06);border:1px solid rgba(217,119,6,0.2);border-radius:10px;padding:14px;text-align:center">
      <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent3)">${gap.length}</div>
      <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase">ğŸ¯ Gap Opportunities</div>
    </div>
  </div>
  ${alreadyRanking.length?`
  <div class="card" style="margin-bottom:10px">
    <div class="card-title">ğŸ“ˆ Already Ranking for "${esc(kw)}"</div>
    <div class="tw"><table><thead><tr><th>Platform</th><th>DA</th><th>SERP Count</th><th>Live URLs</th><th>Action</th></tr></thead><tbody>
    ${alreadyRanking.map(p=>`<tr>
      <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs ta">${esc(p.name)}</span></td>
      <td><span class="badge badge-g">${p.da}</span></td>
      <td><span class="ta mono xs">${p.serpCount} pages</span></td>
      <td>${p.serpUrls.slice(0,2).map(u=>`<a href="${esc(u)}" target="_blank" class="btn btn-ghost btn-xs" style="margin:1px">View â†’</a>`).join('')}</td>
      <td><button class="btn btn-primary btn-xs" onclick="pfAddToCommenterSite_byUrl('${esc(p.serpUrls[0]||'https://'+p.domain)}','${esc(p.name)}')">+Queue</button></td>
    </tr>`).join('')}
    </tbody></table></div>
  </div>`:'' }
  <div class="card">
    <div class="card-title">ğŸ¯ Gap Opportunities â€” Not Yet Ranking (publish here first!)</div>
    <div class="tw"><table><thead><tr><th>Platform</th><th>DA</th><th>Rank Power</th><th>Suggested Slug</th><th>Domain</th><th>Action</th></tr></thead><tbody>
    ${gap.slice(0,20).map(p=>`<tr>
      <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs">${esc(p.name)}</span></td>
      <td><span class="badge ${p.da>=90?'badge-g':p.da>=82?'badge-y':'badge-b'}">${p.da}</span></td>
      <td style="font-family:var(--mono);font-size:13px;letter-spacing:-1px">${esc(p.rankPower||'â˜…â˜…â˜…â˜†â˜†')}</td>
      <td class="mono xs tm">${slug(kw)}</td>
      <td class="mono xs tb">${p.domain}</td>
      <td><button class="btn btn-yellow btn-xs" onclick="navigator.clipboard&&navigator.clipboard.writeText('https://${esc(p.domain)}/'+slug('${esc(kw)}'))">Copy URL</button></td>
    </tr>`).join('')}
    </tbody></table></div>
  </div>`;
}

function pfAddToCommenterSite_byUrl(url, label){
  if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''}); bcSave(); }
  alert('âœ“ Added '+label+' to Blog Commenter queue!');
}
function renderSpyNotes(){ return _spyNotes.length?_spyNotes.map(n=>`<div style="display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--bg);border:1px solid var(--border);margin-bottom:5px;font-family:var(--mono);font-size:11px;border-radius:7px;font-weight:600"><span class="tm" style="font-size:9px;flex-shrink:0">${n.ts}</span><span style="flex:1;color:var(--text)">${esc(n.text)}</span><button class="btn btn-danger btn-xs" onclick="removeSpyNote('${n.id}')">âœ•</button></div>`).join(''):'<p class="tm mono xs">No notes yet.</p>'; }
function addSpyNote(){ const inp=document.getElementById('spy-note'); if(!inp||!inp.value.trim()) return; _spyNotes.push({id:uid(),text:inp.value.trim(),ts:ts()}); inp.value=''; const el=document.getElementById('spy-notes'); if(el) el.innerHTML=renderSpyNotes(); }
function removeSpyNote(id){ _spyNotes=_spyNotes.filter(n=>n.id!==id); const el=document.getElementById('spy-notes'); if(el) el.innerHTML=renderSpyNotes(); }

// â”€â”€â”€ KW RESEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _kwrSuggestions=[];
let _kwrSelected=[];
function renderKwResearch(el){
  el.innerHTML=`
  <div class="page-title">ğŸ” Keyword Research</div>
  <div class="page-sub">// intent-based keyword expansion Â· entertainment Â· sport Â· celebrity Â· questions Â· how-to Â· and more</div>
  <div class="card">
    <div class="card-title">Keyword Expander</div>
    <div class="grid3" style="margin-bottom:12px">
      <div class="fg mb0"><label class="lbl">Seed Keyword</label>
        <input type="text" id="kwr-seed" placeholder="e.g. creatine supplement, cristiano ronaldo, iphone review"/></div>
      <div class="fg mb0"><label class="lbl">Volume Hint</label>
        <select id="kwr-volume">
          <option value="all">All Volume Ranges</option>
          <option value="high">High Volume (mass appeal)</option>
          <option value="mid">Mid Volume (niche)</option>
          <option value="low">Low Volume (long-tail)</option>
        </select></div>
      <div class="fg mb0"><label class="lbl">Region/Language</label>
        <select id="kwr-region">
          <option value="global">Global / English</option>
          <option value="us">United States</option>
          <option value="uk">United Kingdom</option>
          <option value="ng">Nigeria</option>
          <option value="au">Australia</option>
          <option value="ca">Canada</option>
        </select></div>
    </div>
    <div class="card-title" style="margin-top:8px">Search Intent</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px" id="kwr-intent-pills">
      ${['all','informational','commercial','transactional','local','entertainment','sport','celebrity','lifestyle','how-to','questions','video','tech','news','review'].map(i=>{
        const labels={all:'â™¥ All Intents',informational:'â„¹ Informational',commercial:'ğŸ›’ Commercial',transactional:'ğŸ’³ Transactional',local:'ğŸ“ Local',entertainment:'ğŸ¬ Entertainment',sport:'âš½ Sport',celebrity:'â­ Celebrity',lifestyle:'âœ¨ Lifestyle','how-to':'ğŸ›  How-To',questions:'â“ Questions',video:'ğŸ¥ Video',tech:'ğŸ’» Tech','news':'ğŸ“° News',review:'ğŸ” Review'};
        return `<span class="chip ${i==='all'?'on':''}" id="kwri-${i}" onclick="kwrSelectIntent('${i}')" style="cursor:pointer;user-select:none;padding:5px 12px;font-size:11px">${labels[i]||i}</span>`;
      }).join('')}
    </div>
    <div class="flex aic g8">
      <button class="btn btn-primary" onclick="expandKeywords()" style="padding:9px 20px">âš¡ Generate Suggestions</button>
      <button class="btn btn-blue btn-sm" onclick="kwrLiveSearch()" id="kwr-live-btn">
        ğŸŒ Live Search Suggestions
      </button>
      <span id="kwr-live-status" style="font-family:var(--mono);font-size:10px;color:var(--muted2)"></span>
    </div>
  </div>
  <div id="kwr-output"></div>
  ${S.keywords.length?`<div class="card">
    <div class="card-title">Your Keyword Clusters (${S.keywords.length} total)</div>
    ${(()=>{
      const clusters={};
      S.keywords.forEach(kw=>{ const key=(kw.split(' ')[0]||'misc').toLowerCase(); if(!clusters[key]) clusters[key]=[]; clusters[key].push(kw); });
      return Object.entries(clusters).map(([k,kws])=>`<div style="margin-bottom:12px"><div style="font-family:var(--mono);font-size:9px;color:var(--accent);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:6px">${esc(k)} <span class="nav-badge">${kws.length}</span></div><div class="chips">${kws.map(kw=>`<span class="chip on" style="cursor:default">${esc(kw)}</span>`).join('')}</div></div>`).join('');
    })()}
  </div>`:''}`;
  document.getElementById('kwr-seed').addEventListener('keydown',e=>{ if(e.key==='Enter') expandKeywords(); });
}
const INTENT_MODS={
  informational:['what is','how to','guide to','complete guide','tutorial','explained','tips for','best way to','learn','vs','difference between','examples of','benefits of','overview','definition'],
  commercial:['best','top','review','vs','compare','alternatives to','buy','where to get','recommended','worth it','pros and cons','is it good'],
  transactional:['buy','order','get','download','free','discount','price','cost','cheap','deal','coupon','offer'],
  local:['near me','local','nearby','service','in my city','in lagos','in london','in new york'],
  entertainment:['funny','viral','trending','meme','watch','stream','movie','show','episode','season','trailer','best scenes','hidden gems','must watch','binge worthy','award winning'],
  sport:['highlights','score','match','game','player','team','transfer','stats','ranking','championship','tournament','league','best goals','injury update','news','fixtures'],
  celebrity:['net worth','dating','married','age','height','house','cars','scandal','beef','drama','interview','reaction','biography','before fame','transformation','plastic surgery'],
  lifestyle:['routine','morning routine','diet','fitness','workout','skincare','fashion','outfit','travel','budget','minimalist','productivity','self care','wellness','mental health'],
  'how-to':['how to','step by step','beginners guide','tutorial','DIY','make your own','fix','repair','set up','install','configure','start','create','build'],
  questions:['why','what','when','who','where','how','can you','should I','is it possible','does it work','what happens if','what is the difference','is it worth','how long'],
  video:['youtube','tiktok','reel','shorts','vlog','reaction video','explained video','review video','top 10 video','documentary','podcast','live stream'],
  tech:['app','software','tool','review','update','vs','alternative','tutorial','setup','error','how to use','best settings','hidden features','tips tricks'],
  news:['latest news','breaking','update','today','2024','2025','announced','released','confirmed','leaked','rumour'],
  review:['review','honest review','worth it','pros cons','rating','is it good','should I buy','unboxing','first impressions','after 6 months','long term'],
};
let _kwrSelectedIntent = 'all';
function kwrSelectIntent(intent){
  _kwrSelectedIntent = intent;
  document.querySelectorAll('[id^="kwri-"]').forEach(el => el.classList.remove('on'));
  const sel = document.getElementById('kwri-'+intent);
  if(sel) sel.classList.add('on');
}
async function kwrLiveSearch(){
  const seed = (document.getElementById('kwr-seed')||{value:''}).value.trim();
  if(!seed){ alert('Enter a seed keyword first.'); return; }
  const btn = document.getElementById('kwr-live-btn');
  const status = document.getElementById('kwr-live-status');
  if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Searching...'; }
  if(status) status.textContent = 'Trying SearXNG instances...';
  const intent = _kwrSelectedIntent !== 'all' ? _kwrSelectedIntent : 'informational';
  const modList = INTENT_MODS[intent]||INTENT_MODS.informational;
  const query = `${seed} ${modList[0]}`;
  let found = [];
  // Try SearXNG first
  for(const instance of CS_SEARXNG_INSTANCES){
    const urls = await csSearxngSearch(query, instance, 'any');
    if(urls && urls.length > 0){
      // Extract keyword suggestions from page titles and URLs
      urls.forEach(url => {
        try {
          const u = new URL(url);
          const pathSegs = u.pathname.split('/').filter(Boolean);
          pathSegs.forEach(seg => {
            const kw = seg.replace(/-/g,' ').replace(/[_+]/g,' ').trim();
            if(kw.length > 4 && kw.length < 60 && kw.toLowerCase().includes(seed.toLowerCase().split(' ')[0])){
              found.push(kw);
            }
          });
        } catch(e){}
      });
      if(found.length > 0) break;
    }
  }
  // Also generate from all modifiers matching that intent
  const autoGen = new Set();
  modList.forEach(mod => { autoGen.add(mod+' '+seed); autoGen.add(seed+' '+mod); });
  // Add found from live
  found.forEach(kw => autoGen.add(kw));
  // Also add question variants for questions intent
  if(_kwrSelectedIntent === 'questions'){
    ['why is','what is','how does','when should','where to','who is','can I','should I'].forEach(q => autoGen.add(q+' '+seed));
  }
  _kwrSuggestions = [...autoGen].filter(k=>k.trim()&&k.length>4&&k!==seed).slice(0,60);
  _kwrSelected = [];
  renderKwrSuggestions();
  if(btn){ btn.disabled=false; btn.innerHTML='ğŸŒ Live Search Suggestions'; }
  if(status) status.textContent = found.length > 0 ? `âœ… +${found.length} live suggestions` : 'Generated from intent modifiers';
}

function expandKeywords(){
  const seed=(document.getElementById('kwr-seed')||{value:''}).value.trim();
  if(!seed){ alert('Enter a seed keyword first.'); return; }
  const intent=_kwrSelectedIntent||'all';
  const el=document.getElementById('kwr-output'); if(!el) return;
  el.innerHTML='<div class="tm mono xs"><span class="spinner"></span> Generating...</div>';
  setTimeout(()=>{
    const allMods=intent==='all'?Object.values(INTENT_MODS).flat():INTENT_MODS[intent]||[];
    const suffixes=[year(),'guide','tips','review','free','online','best','cheap','tutorial','for beginners','advanced','checklist','template','examples'];
    const generated=new Set();
    allMods.forEach(mod=>{ generated.add(mod+' '+seed); generated.add(seed+' '+mod); });
    suffixes.forEach(s=>{ generated.add(seed+' '+s); generated.add('best '+seed+' '+s); });
    ['complete guide','step by step','how to','what is the best'].forEach(p=>generated.add(p+' '+seed));
    ['for small business','for beginners','for experts','that works','online'].forEach(s=>generated.add(seed+' '+s));
    _kwrSuggestions=[...generated].filter(k=>k.trim()&&k.length>4&&k!==seed).slice(0,50);
    _kwrSelected=[];
    renderKwrSuggestions();
  },400);
}
function renderKwrSuggestions(){
  const el=document.getElementById('kwr-output'); if(!el||!_kwrSuggestions.length) return;
  const intentLabel = _kwrSelectedIntent!=='all' ? ` <span style="font-size:9px;background:rgba(0,87,255,0.1);color:var(--accent);padding:2px 7px;border-radius:10px;font-family:var(--mono);font-weight:700;text-transform:uppercase;letter-spacing:.05em">${_kwrSelectedIntent}</span>` : '';
  el.innerHTML=`<div class="card slide-in">
    <div class="card-title flex aic g8">
      ğŸ’¡ ${_kwrSuggestions.length} Suggestions${intentLabel}
      <button class="btn btn-ghost btn-xs" onclick="kwrSelectAll()">Select All</button>
      <button class="btn btn-ghost btn-xs" onclick="_kwrSelected=[];renderKwrSuggestions()">Clear</button>
      <button class="btn btn-primary btn-sm" style="margin-left:auto" onclick="kwrAddToList()" ${!_kwrSelected.length?'disabled':''}>+ Add ${_kwrSelected.length} to Keyword List</button>
    </div>
    <div style="margin-bottom:10px;font-family:var(--mono);font-size:9px;color:var(--muted2)">Click keywords to select Â· click again to deselect Â· then add to your list</div>
    <div class="chips">${_kwrSuggestions.map((kw,i)=>`<span class="chip ${_kwrSelected.includes(kw)?'on':''}" onclick="kwrToggle('${esc(kw)}')" title="${esc(kw)}">${esc(kw)}${_kwrSelected.includes(kw)?' âœ“':''}</span>`).join('')}</div>
    <div style="margin-top:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${_kwrSelected.length} selected</span>
      <button class="btn btn-ghost btn-xs" onclick="kwrSelectAll()">All</button>
      <button class="btn btn-ghost btn-xs" onclick="_kwrSelected=[];renderKwrSuggestions()">None</button>
      <button class="btn btn-yellow btn-xs" onclick="kwrExportCSV()">Export CSV</button>
      <button class="btn btn-blue btn-xs" onclick="kwrCopyAll()">Copy All</button>
    </div>
  </div>`;
}
function kwrExportCSV(){
  const csv = ['keyword',..._kwrSuggestions].join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='keywords-'+Date.now()+'.csv'; a.click();
}
function kwrCopyAll(){
  const text = _kwrSuggestions.join('\n');
  navigator.clipboard&&navigator.clipboard.writeText(text);
}
function kwrToggle(kw){ if(_kwrSelected.includes(kw)) _kwrSelected=_kwrSelected.filter(x=>x!==kw); else _kwrSelected.push(kw); renderKwrSuggestions(); }
function kwrSelectAll(){ _kwrSelected=[..._kwrSuggestions]; renderKwrSuggestions(); }
function kwrAddToList(){
  S.keywords=[...new Set([...S.keywords,..._kwrSelected])];
  _kwrSuggestions=_kwrSuggestions.filter(k=>!_kwrSelected.includes(k));
  _kwrSelected=[];
  updateHeader();
  renderKwResearch(document.getElementById('page-kw_research'));
}

// â”€â”€â”€ BLOG COMMENTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _bcSites = JSON.parse(localStorage.getItem('bc_sites')||'[]');
let _bcUrlLists = JSON.parse(localStorage.getItem('bc_url_lists')||'[]');
let _bcLog   = [];
let _bcRunning = false;
let _bcStop = false;
let _bcTermLines = [];

function bcSave(){ try{ localStorage.setItem('bc_sites', JSON.stringify(_bcSites)); }catch(e){} }
function bcSaveUrlLists(){ try{ localStorage.setItem('bc_url_lists', JSON.stringify(_bcUrlLists)); }catch(e){} }

const BC_TEMPLATES = [
  (kw,url,name)=>`Great post! I've been looking for reliable info on ${kw} and this really helped. Thanks for sharing, ${name}!`,
  (kw,url,name)=>`Really useful breakdown on ${kw}. This is exactly the kind of content that adds value. Keep it up â€” ${name}`,
  (kw,url,name)=>`I've read a lot about ${kw} but this article really stands out. Well researched and easy to follow. â€” ${name}`,
  (kw,url,name)=>`Just what I needed on ${kw}. Bookmarking this for future reference. Thanks for the effort! â€” ${name}`,
  (kw,url,name)=>`Excellent article! The section on ${kw} was particularly insightful. Would love to see more on this topic. â€” ${name}`,
  (kw,url,name)=>`This is a solid resource on ${kw}. I've shared it with my network. Really appreciate the depth here â€” ${name}`,
  (kw,url,name)=>`Thanks for writing this up! ${kw} is something I've been researching and this covered all the key points. â€” ${name}`,
  (kw,url,name)=>`Really appreciated the detail here on ${kw}. Saved this article for reference. â€” ${name}`,
];

function bcGenComment(kw, url, name){
  const fn = BC_TEMPLATES[Math.floor(Math.random() * BC_TEMPLATES.length)];
  return fn(kw||'this topic', url||'', name||'A Reader');
}

function renderBlogCommenter(el){
  const kws = S.keywords.length ? S.keywords : [];
  el.innerHTML=`
  <div class="page-title">ğŸ’¬ Blog Commenter â€” v3 Maximum Force</div>
  <div class="page-sub">// 8-proxy engine Â· WP REST + form POST + generic Â· manual assist fallback Â· custom Cloudflare Worker proxy</div>

  <!-- TOP ROW: Settings + URL List Manager -->
  <div class="grid2" style="gap:18px;align-items:start;margin-bottom:0">

    <!-- LEFT COL -->
    <div>
      <!-- Comment Identity -->
      <div class="card">
        <div class="card-title">ğŸªª Commenter Identity</div>
        <div class="grid2">
          <div class="fg mb0"><label class="lbl">Display Name</label>
            <input type="text" id="bc-gen-name" placeholder="e.g. John Davis"/></div>
          <div class="fg mb0"><label class="lbl">Email</label>
            <input type="email" id="bc-email" placeholder="your@email.com"/></div>
        </div>
        <div class="fg mt8"><label class="lbl">Website / URL Field (optional)</label>
          <input type="url" id="bc-website" placeholder="https://yoursite.com"/></div>
      </div>

      <!-- Comment Generator -->
      <div class="card">
        <div class="card-title">ğŸ“ Comment Generator</div>
        <div class="grid2">
          <div class="fg mb0"><label class="lbl">Keyword / Topic</label>
            <select id="bc-gen-kw">
              <option value="">â€” pick or type below â€”</option>
              ${kws.map(k=>`<option value="${esc(k)}">${esc(k)}</option>`).join('')}
            </select></div>
          <div class="fg mb0"><label class="lbl">Custom Keyword</label>
            <input type="text" id="bc-custom-kw" placeholder="e.g. creatine supplements"/></div>
        </div>
        <div class="fg mt8"><label class="lbl">Generated Comment</label>
          <textarea id="bc-gen-out" rows="4" placeholder="Click Generate to create a comment..."></textarea></div>
        <div class="row">
          <button class="btn btn-primary" onclick="bcGenerate()">ğŸ² Generate</button>
          <button class="btn btn-ghost" onclick="bcCopyComment()">ğŸ“‹ Copy</button>
          <button class="btn btn-yellow" onclick="bcQueueAll()">âš¡ Queue to All Sites</button>
        </div>
      </div>

      </div>

      <!-- Advanced Settings -->
  <div class="card">
        <div class="card-title">âš™ Advanced Settings</div>
        <div class="fg"><label class="lbl">Custom Proxy Endpoint (optional)</label>
          <input type="url" id="bc-custom-proxy" placeholder="https://your-worker.workers.dev/?url={URL}" value="${_bcCustomProxy||''}"/></div>
        <div class="notice notice-info" style="margin-top:8px;font-size:10px">
          Deploy a <strong>Cloudflare Worker</strong> as your own CORS proxy for 100% reliability. Use <code>{URL}</code> as the placeholder for the target URL. Free tier: 100k req/day.
          <a href="javascript:void(0)" onclick="bcShowCfWorkerCode()" style="color:var(--accent);font-weight:700">ğŸ“‹ View Cloudflare Worker Code</a>
        </div>
        <div class="flex aic g8 mt8" style="flex-wrap:wrap">
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-family:var(--mono);font-size:11px;font-weight:700">
            <input type="checkbox" id="bc-manual-fallback" style="width:auto" ${localStorage.getItem('bc_manual_fallback')==='1'?'checked':''} onchange="localStorage.setItem('bc_manual_fallback',this.checked?'1':'0')"/>
            Manual Assist fallback on failure (opens site + pastes comment)
          </label>
        </div>
      </div>

      <!-- Add Single Site -->
      <div class="card">
        <div class="card-title">â• Add Single Target</div>
        <div class="fg"><label class="lbl">Blog / Post URL</label>
          <input type="url" id="bc-url" placeholder="https://example.com/blog/post-title"/></div>
        <div class="grid2">
          <div class="fg mb0"><label class="lbl">Label (optional)</label>
            <input type="text" id="bc-label" placeholder="e.g. Health Blog #1"/></div>
          <div class="fg mb0"><label class="lbl">Platform Type</label>
            <select id="bc-type">
              <option value="wordpress">WordPress</option>
              <option value="blogger">Blogger</option>
              <option value="disqus">Disqus</option>
              <option value="generic">Generic</option>
              <option value="other">Other</option>
            </select></div>
        </div>
        <div class="fg mt8"><label class="lbl">Notes</label>
          <input type="text" id="bc-notes" placeholder="e.g. scroll to #comments, requires captcha"/></div>
        <div class="row mt8">
          <button class="btn btn-primary f1" onclick="bcAddSite()">+ Add Site</button>
          <button class="btn btn-ghost" onclick="bcImportBulk()">ğŸ“‹ Paste Bulk</button>
        </div>
      </div>
    </div>

    <!-- RIGHT COL -->
    <div>
      <!-- URL List Manager (TXT Upload) -->
      <div class="card">
        <div class="card-title">ğŸ“‚ URL List Manager</div>
        <div class="notice notice-info" style="margin-bottom:10px">Upload a .txt file with one URL per line. Lists are saved and can be pushed directly to the target sites queue.</div>

        <div style="border:2px dashed var(--border2);border-radius:8px;padding:16px;text-align:center;margin-bottom:10px;cursor:pointer;transition:border-color 0.15s;background:var(--bg)" id="bc-drop-zone" onclick="document.getElementById('bc-file-input').click()" ondragover="bcDragOver(event)" ondragleave="bcDragLeave(event)" ondrop="bcDrop(event)">
          <div style="font-size:24px;margin-bottom:6px">ğŸ“„</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">Click or drag & drop a .txt file here</div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px">One URL per line Â· https:// format</div>
        </div>
        <input type="file" id="bc-file-input" accept=".txt,text/plain" style="display:none" onchange="bcFileSelected(this)"/>

        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input type="text" id="bc-list-name" placeholder="List name (optional)..." style="flex:1"/>
          <button class="btn btn-primary btn-sm" onclick="bcSaveCurrentList()">ğŸ’¾ Save List</button>
        </div>

        <!-- Saved URL Lists -->
        <div id="bc-url-lists-render">${bcRenderUrlLists()}</div>
      </div>

      <!-- Target Sites -->
      <div class="card">
        <div class="card-title flex aic g8">
          ğŸ¯ Target Sites <span class="nav-badge" id="bc-site-count">${_bcSites.length}</span>
          <button class="btn btn-danger btn-xs" style="margin-left:auto" onclick="bcClearAll()">Clear All</button>
        </div>
        <div id="bc-site-list" style="max-height:320px;overflow-y:auto">${bcRenderSiteList()}</div>
      </div>
    </div>
  </div>

  <!-- FULL WIDTH: Auto Commenter Terminal -->
  <div class="card" style="margin-top:0">
    <div class="card-title flex aic g8">
      ğŸ–¥ Auto Commenter â€” Real-Time Terminal
      <span id="bc-run-badge" class="nav-badge" style="display:none;background:rgba(0,200,100,0.15);color:#00c864;border-color:rgba(0,200,100,0.3)">â— RUNNING</span>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <label class="lbl" style="margin:0;white-space:nowrap">Delay between sites:</label>
        <select id="bc-delay" style="width:120px">
          <option value="2000">2 seconds</option>
          <option value="4000" selected>4 seconds</option>
          <option value="6000">6 seconds</option>
          <option value="10000">10 seconds</option>
          <option value="15000">15 seconds</option>
        </select>
        <button class="btn btn-ghost btn-sm" onclick="bcTermClear()">Clear Terminal</button>
        <button class="btn btn-danger btn-sm" id="bc-stop-btn" onclick="bcStopRun()" style="display:none">â¹ Stop</button>
        <button class="btn btn-primary" id="bc-start-btn" onclick="bcStartRun()">â–¶ Start Commenting</button>
      </div>
    </div>

    <!-- Progress bar -->
    <div class="prog-wrap" id="bc-prog-wrap" style="display:none">
      <div class="prog-fill" id="bc-prog-fill"></div>
    </div>
    <div id="bc-prog-label" style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:8px;display:none"></div>

    <!-- Terminal -->
    <div class="terminal" id="bc-terminal" style="height:320px">
      <span class="tm">// Click "Start Commenting" to begin. The tool will visit each site, open it, fill the comment form fields, and log progress here in real time...</span>
    </div>

    <!-- Log below terminal -->
    <div style="margin-top:12px">
      <div class="card-title">ğŸ“‹ Session Log</div>
      <div id="bc-log" style="max-height:180px;overflow-y:auto">${bcRenderLog()}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="bcExportLog()">ğŸ“¤ Export CSV</button>
        <button class="btn btn-danger btn-sm" onclick="_bcLog=[];bcRefresh()">Clear Log</button>
      </div>
    </div>
  </div>`;

  document.getElementById('bc-url').addEventListener('keydown',e=>{ if(e.key==='Enter') bcAddSite(); });
}

// â”€â”€ URL List Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _bcPendingUrls = []; // URLs from current upload not yet saved

function bcRenderUrlLists(){
  if(!_bcUrlLists.length) return '<p class="tm mono xs">No saved URL lists yet. Upload a .txt file above.</p>';
  return _bcUrlLists.map(list=>`
    <div style="border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:7px;background:var(--bg)">
      <div class="flex aic g8" style="margin-bottom:6px">
        <span style="font-size:13px">ğŸ“‹</span>
        <span class="mono xs" style="flex:1;font-weight:700;color:var(--text)">${esc(list.name)}</span>
        <span class="badge badge-b">${list.urls.length} URLs</span>
        <span class="tm mono" style="font-size:9px">${list.saved}</span>
      </div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:8px;max-height:60px;overflow:hidden;line-height:1.8">
        ${list.urls.slice(0,5).map(u=>`<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(u)}</div>`).join('')}
        ${list.urls.length>5?`<div style="color:var(--accent)">+ ${list.urls.length-5} more...</div>`:''}
      </div>
      <div class="flex g8">
        <button class="btn btn-primary btn-sm f1" onclick="bcPushListToQueue('${list.id}')">â• Push to Target Sites</button>
        <button class="btn btn-ghost btn-sm" onclick="bcViewList('${list.id}')">ğŸ‘ View</button>
        <button class="btn btn-danger btn-sm" onclick="bcDeleteList('${list.id}')">âœ•</button>
      </div>
    </div>`).join('');
}

function bcDragOver(e){ e.preventDefault(); document.getElementById('bc-drop-zone').style.borderColor='var(--accent)'; }
function bcDragLeave(e){ document.getElementById('bc-drop-zone').style.borderColor='var(--border2)'; }
function bcDrop(e){
  e.preventDefault();
  document.getElementById('bc-drop-zone').style.borderColor='var(--border2)';
  const file=e.dataTransfer.files[0];
  if(file) bcReadFile(file);
}
function bcFileSelected(input){
  const file=input.files[0];
  if(file) bcReadFile(file);
  input.value='';
}
function bcReadFile(file){
  if(!file.name.endsWith('.txt')&&file.type&&!file.type.includes('text')){ alert('Please upload a .txt file.'); return; }
  const reader=new FileReader();
  reader.onload=e=>{
    const text=e.target.result;
    const urls=text.split('\n').map(u=>u.trim()).filter(u=>/^https?:\/\//i.test(u));
    if(!urls.length){ alert('No valid URLs found. Make sure each line starts with http:// or https://'); return; }
    _bcPendingUrls=urls;
    // Pre-fill list name from filename
    const nameEl=document.getElementById('bc-list-name');
    if(nameEl&&!nameEl.value) nameEl.value=file.name.replace(/\.txt$/i,'');
    // Show preview in drop zone
    const dz=document.getElementById('bc-drop-zone');
    if(dz) dz.innerHTML=`<div style="font-size:20px;margin-bottom:4px">âœ…</div><div style="font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:700">${esc(file.name)}</div><div style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-top:2px">${urls.length} valid URLs loaded Â· Click "Save List" to store</div>`;
    bcTermLog(`ğŸ“‚ Loaded "${esc(file.name)}" â€” ${urls.length} URLs ready.`,'accent');
  };
  reader.readAsText(file);
}
function bcSaveCurrentList(){
  if(!_bcPendingUrls.length){ alert('No URLs loaded. Upload a .txt file first.'); return; }
  const nameEl=document.getElementById('bc-list-name');
  const name=(nameEl&&nameEl.value.trim())||('URL List '+(new Date().toLocaleDateString()));
  const list={ id:uid(), name, urls:[..._bcPendingUrls], saved:ts() };
  _bcUrlLists.push(list);
  bcSaveUrlLists();
  _bcPendingUrls=[];
  if(nameEl) nameEl.value='';
  const dz=document.getElementById('bc-drop-zone');
  if(dz) dz.innerHTML=`<div style="font-size:24px;margin-bottom:6px">ğŸ“„</div><div style="font-family:var(--mono);font-size:11px;color:var(--muted2);font-weight:600">Click or drag & drop a .txt file here</div><div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px">One URL per line Â· https:// format</div>`;
  const lr=document.getElementById('bc-url-lists-render');
  if(lr) lr.innerHTML=bcRenderUrlLists();
  bcTermLog(`ğŸ’¾ Saved list "${esc(name)}" with ${list.urls.length} URLs.`,'success');
}
function bcPushListToQueue(listId){
  const list=_bcUrlLists.find(l=>l.id===listId);
  if(!list) return;
  let added=0;
  list.urls.forEach(url=>{
    if(!_bcSites.find(s=>s.url===url)){
      _bcSites.push({id:uid(),url,label:url,type:'wordpress',name:'',email:'',website:'',notes:'',done:false,queued:''});
      added++;
    }
  });
  bcSave();
  bcLog(`Pushed ${added} URLs from "${list.name}" to target sites.`,'success');
  bcTermLog(`â• Added ${added} new URLs from "${esc(list.name)}" to Target Sites queue.`,'success');
  bcRefresh();
}
function bcViewList(listId){
  const list=_bcUrlLists.find(l=>l.id===listId);
  if(!list) return;
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`<div class="modal-box" style="min-width:520px;max-width:700px">
    <div class="modal-title">ğŸ“‹ ${esc(list.name)} <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ• Close</button></div>
    <div class="notice notice-info" style="margin-bottom:12px">${list.urls.length} URLs Â· Saved ${list.saved}</div>
    <div style="max-height:400px;overflow-y:auto;font-family:var(--mono);font-size:11px;line-height:2">
      ${list.urls.map((u,i)=>`<div style="display:flex;gap:10px;padding:4px 8px;border-bottom:1px solid var(--border);${i%2===0?'background:var(--bg)':''}">
        <span style="color:var(--muted);font-size:9px;flex-shrink:0;padding-top:2px">${i+1}</span>
        <a href="${esc(u)}" target="_blank" style="color:var(--accent);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(u)}</a>
      </div>`).join('')}
    </div>
    <div class="row" style="margin-top:14px">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-primary" onclick="bcPushListToQueue('${list.id}');this.closest('.modal-overlay').remove()">â• Push All to Target Sites</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}
function bcDeleteList(listId){
  if(!confirm('Delete this URL list?')) return;
  _bcUrlLists=_bcUrlLists.filter(l=>l.id!==listId);
  bcSaveUrlLists();
  const lr=document.getElementById('bc-url-lists-render');
  if(lr) lr.innerHTML=bcRenderUrlLists();
}

// â”€â”€ Terminal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bcTermLog(msg, type='info'){
  _bcTermLines.push({msg, type, time:ts()});
  const term=document.getElementById('bc-terminal');
  if(!term) return;
  const colorMap={
    info:'#c9d1d9', success:'#3fb950', error:'#f85149',
    warn:'#d29922', accent:'#58a6ff', muted:'#484f58'
  };
  const div=document.createElement('div');
  div.className='tline';
  div.style.animation='slideIn 0.2s ease';
  div.innerHTML=`<span class="ttime">${ts()}</span><span style="color:${colorMap[type]||'#c9d1d9'}">${msg}</span>`;
  // Remove placeholder if present
  const placeholder=term.querySelector('.tm');
  if(placeholder&&placeholder.tagName!=='DIV') placeholder.remove();
  term.appendChild(div);
  term.scrollTop=term.scrollHeight;
}
function bcTermClear(){
  _bcTermLines=[];
  const term=document.getElementById('bc-terminal');
  if(term) term.innerHTML='<span class="tm">// Terminal cleared. Ready.</span>';
}
function bcTermSeparator(label){
  const term=document.getElementById('bc-terminal');
  if(!term) return;
  const div=document.createElement('div');
  div.style.cssText='display:flex;align-items:center;gap:8px;margin:6px 0;font-family:var(--mono);font-size:9px;color:#484f58';
  div.innerHTML=`<span style="flex:1;height:1px;background:#21262d"></span><span>${label||'â”€'}</span><span style="flex:1;height:1px;background:#21262d"></span>`;
  term.appendChild(div);
  term.scrollTop=term.scrollHeight;
}

// â”€â”€ Auto-Commenter Runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ PROXY FETCH HELPER v3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tries multiple CORS proxies in order, returns {ok, text, status}
// Custom proxy endpoint can be set by user (Cloudflare Worker, etc.)
let _bcCustomProxy = localStorage.getItem('bc_custom_proxy')||'';

function bcGetProxyList(targetUrl, isPost){
  const enc = encodeURIComponent(targetUrl);
  const custom = _bcCustomProxy.trim();
  const list = [];

  // Custom proxy first (user-provided Cloudflare Worker or similar)
  if(custom){
    list.push({ url: custom.replace('{URL}', enc).replace('{url}', enc) || `${custom}?url=${enc}`, passBody: isPost, label:'custom' });
  }

  if(isPost){
    list.push(
      { url: `https://corsproxy.io/?${enc}`, passBody: true, label:'corsproxy' },
      { url: `https://proxy.cors.sh/${targetUrl}`, passBody: true, label:'cors.sh', extraHeaders:{'x-cors-api-key':'temp_'} },
      { url: `https://api.allorigins.win/raw?url=${enc}`, passBody: true, label:'allorigins-raw' },
      { url: `https://thingproxy.freeboard.io/fetch/${targetUrl}`, passBody: true, label:'thingproxy' },
      { url: `https://crossorigin.me/${targetUrl}`, passBody: true, label:'crossorigin' },
      { url: `https://cors-anywhere-demo.herokuapp.com/${targetUrl}`, passBody: true, label:'heroku' },
      { url: `https://yacdn.org/serve/${targetUrl}`, passBody: true, label:'yacdn' },
    );
  } else {
    list.push(
      { url: `https://api.allorigins.win/get?url=${enc}`, json: true, label:'allorigins' },
      { url: `https://corsproxy.io/?${enc}`, passBody: false, label:'corsproxy' },
      { url: `https://api.allorigins.win/raw?url=${enc}`, passBody: false, label:'allorigins-raw' },
      { url: `https://proxy.cors.sh/${targetUrl}`, passBody: false, label:'cors.sh', extraHeaders:{'x-cors-api-key':'temp_'} },
      { url: `https://thingproxy.freeboard.io/fetch/${targetUrl}`, passBody: false, label:'thingproxy' },
      { url: `https://api.codetabs.com/v1/proxy?quest=${enc}`, passBody: false, label:'codetabs' },
      { url: `https://crossorigin.me/${targetUrl}`, passBody: false, label:'crossorigin.me' },
      { url: `https://yacdn.org/serve/${targetUrl}`, passBody: false, label:'yacdn' },
      { url: `https://cors.eu.org/${targetUrl}`, passBody: false, label:'cors.eu.org' },
      { url: `https://corsproxy.org/?${enc}`, passBody: false, label:'corsproxy.org' },
      { url: `https://api.codetabs.com/v1/proxy?quest=${enc}`, passBody: false, label:'codetabs2' },
      { url: `https://corsproxy.club/?${targetUrl}`, passBody: false, label:'corsproxy.club' },
    );
  }
  return list;
}

async function bcProxyFetch(targetUrl, opts={}){
  const isPost = opts.method && opts.method.toUpperCase()==='POST';
  const proxies = bcGetProxyList(targetUrl, isPost);
  const timeout = opts.timeout || 16000;

  for(const proxy of proxies){
    try {
      const fetchOpts = {
        method: opts.method||'GET',
        headers: {
          ...(opts.contentType ? {'Content-Type': opts.contentType} : {}),
          ...(proxy.extraHeaders||{}),
          ...(opts.extraHeaders||{})
        },
      };
      // Set content-type for POST
      if(isPost && !fetchOpts.headers['Content-Type']){
        fetchOpts.headers['Content-Type'] = opts.contentType || 'application/x-www-form-urlencoded';
      }
      if(opts.asJson) fetchOpts.headers['Content-Type'] = 'application/json';

      if(isPost && proxy.passBody && opts.body){
        fetchOpts.body = opts.body;
      }

      const resp = await Promise.race([
        fetch(proxy.url, fetchOpts),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Proxy timeout')),timeout))
      ]);

      let text = '';
      if(proxy.json && resp.ok){
        try{ const d=await resp.json(); text=d.contents||''; }catch(e){ text=await resp.text(); }
      } else {
        text = await resp.text();
      }

      // Consider 4xx/5xx as failed for GET (for POST we check caller)
      if(!isPost && !resp.ok && resp.status >= 500){ continue; }

      return { ok: resp.ok, status: resp.status, text, redirected: resp.redirected, proxy: proxy.label||proxy.url };
    } catch(e){
      continue;
    }
  }
  return { ok: false, status: 0, text: '', error: 'All proxies exhausted' };
}

// â”€â”€ WORDPRESS POST ID DETECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bcExtractWpPostId(html, pageUrl){
  // Method 1: Look for comment_post_ID in hidden input
  const m1 = html.match(/name=["']comment_post_ID["'][^>]*value=["'](\d+)["']/i)
           || html.match(/value=["'](\d+)["'][^>]*name=["']comment_post_ID["']/i);
  if(m1) return m1[1];

  // Method 2: Look in body class "postid-XXXX"
  const m2 = html.match(/postid-(\d+)/);
  if(m2) return m2[1];

  // Method 3: Look in shortlink or canonical
  const m3 = html.match(/[?&]p=(\d+)/);
  if(m3) return m3[1];

  // Method 4: Look for wp-json link with post ID
  const m4 = html.match(/\/wp-json\/wp\/v2\/posts\/(\d+)/);
  if(m4) return m4[1];

  // Method 5: Look in articleBody / page meta
  const m5 = html.match(/"@type"\s*:\s*"(?:BlogPosting|Article)"[\s\S]{0,500}"identifier"\s*:\s*"?(\d+)"?/);
  if(m5) return m5[1];

  return null;
}

// â”€â”€ WORDPRESS REST API COMMENTER (PRIMARY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bcWpRestComment(pageUrl, postId, name, email, website, comment){
  const origin = new URL(pageUrl).origin;
  const restEndpoint = `${origin}/wp-json/wp/v2/comments`;

  const payload = {
    post: parseInt(postId)||0,
    author_name: name,
    author_email: email,
    content: comment,
  };
  if(website) payload.author_url = website;

  const body = JSON.stringify(payload);

  // Try multiple proxies for JSON POST
  const proxyTargets = [
    { url: restEndpoint, direct: true },
    { url: `https://corsproxy.io/?${encodeURIComponent(restEndpoint)}`, direct: false },
    { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(restEndpoint)}`, direct: false },
    { url: `https://thingproxy.freeboard.io/fetch/${restEndpoint}`, direct: false },
    { url: `https://proxy.cors.sh/${restEndpoint}`, direct: false, extraHeaders:{'x-cors-api-key':'temp_'} },
  ];
  if(_bcCustomProxy){
    const enc = encodeURIComponent(restEndpoint);
    proxyTargets.unshift({ url: _bcCustomProxy.replace('{URL}',enc).replace('{url}',enc) || `${_bcCustomProxy}?url=${enc}`, direct:false });
  }

  for(const proxy of proxyTargets){
    try {
      const resp = await Promise.race([
        fetch(proxy.url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(proxy.extraHeaders||{}) },
          body
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),16000))
      ]);

      const text = await resp.text();
      let json = null;
      try{ json = JSON.parse(text); }catch(e){}

      if(resp.status===201 || resp.status===200){
        const status = json && json.status;
        if(status==='hold') return { success:true, moderated:true, msg:'Comment queued for moderation (REST API)' };
        return { success:true, moderated:false, msg:`Comment posted via REST API (ID: ${json&&json.id||'?'})` };
      }
      if(resp.status===403 && json && json.code==='comment_flood'){
        return { success:false, moderated:false, msg:'Flood protection â€” too many comments too fast' };
      }
      if(resp.status===409){
        return { success:true, moderated:false, msg:'Duplicate comment â€” already posted' };
      }
      // 401/403 = auth needed, 404 = no REST, fallback to legacy
      if(resp.status===401 || resp.status===403 || resp.status===404){
        return { success:false, moderated:false, msg:`REST API returned ${resp.status}`, tryLegacy:true };
      }
    } catch(e){ continue; }
  }
  return { success:false, moderated:false, msg:'REST API unreachable via all proxies', tryLegacy:true };
}

// â”€â”€ LEGACY wp-comments-post.php ENGINE v2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bcWpLegacyComment(pageUrl, html, name, email, website, comment){
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // Find the comment form â€” try many selectors
  const form =
    doc.querySelector('form#commentform') ||
    doc.querySelector('form.comment-form') ||
    doc.querySelector('form[action*="wp-comments-post"]') ||
    doc.querySelector('#respond form') ||
    doc.querySelector('form[id*="comment"]') ||
    doc.querySelector('form[class*="comment"]') ||
    doc.querySelector('#comments form') ||
    doc.querySelector('.comments form') ||
    doc.querySelector('form');

  // Determine POST endpoint
  let postUrl = '';
  try {
    const base = new URL(pageUrl);
    const action = form ? (form.getAttribute('action')||'') : '';
    if(!form || !action || action===pageUrl){ postUrl = base.origin + '/wp-comments-post.php'; }
    else if(action.startsWith('http')){ postUrl = action; }
    else if(action.startsWith('/')){ postUrl = base.origin + action; }
    else { postUrl = base.origin + '/' + action; }
  } catch(e){ postUrl = new URL(pageUrl).origin + '/wp-comments-post.php'; }

  // Build URLSearchParams â€” start with ALL hidden fields (captures nonces, akismet tokens, etc.)
  const params = new URLSearchParams();
  if(form){
    form.querySelectorAll('input[type="hidden"], input[type="submit"]').forEach(inp=>{
      const n = inp.getAttribute('name');
      const v = inp.getAttribute('value')||'';
      if(n) params.set(n, v);
    });
  }

  // Post ID â€” try form first, then page-wide extraction
  const postIdField = form && form.querySelector('input[name="comment_post_ID"]');
  const postId = (postIdField && postIdField.value) || bcExtractWpPostId(html, pageUrl) || '1';
  params.set('comment_post_ID', postId);

  // Standard WP comment fields
  params.set('author', name);
  params.set('email', email);
  params.set('url', website||'');
  params.set('comment', comment);
  params.set('comment_parent', '0');
  params.set('submit', 'Post Comment');

  // Map any renamed field names the theme might use
  if(form){
    form.querySelectorAll('input[type="text"], input[type="email"], input[type="url"], textarea').forEach(inp=>{
      const n = (inp.getAttribute('name')||'').toLowerCase();
      const id = (inp.getAttribute('id')||'').toLowerCase();
      const realName = inp.getAttribute('name');
      if(!realName) return;
      if(n==='author'||id==='author'||n.includes('name')||id.includes('name')) params.set(realName, name);
      else if(n==='email'||id==='email'||n.includes('email')) params.set(realName, email);
      else if(n==='url'||id==='url'||n.includes('website')||n.includes('link')) params.set(realName, website||'');
      else if(n==='comment'||inp.tagName==='TEXTAREA'||n.includes('comment')||n.includes('message')) params.set(realName, comment);
    });
  }

  // Referrer header mimics a real browser navigating from the post page
  const proxyTargets = [
    `https://corsproxy.io/?${encodeURIComponent(postUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(postUrl)}`,
    `https://thingproxy.freeboard.io/fetch/${postUrl}`,
    `https://proxy.cors.sh/${postUrl}`,
    `https://crossorigin.me/${postUrl}`,
    `https://yacdn.org/serve/${postUrl}`,
  ];
  if(_bcCustomProxy){
    const enc = encodeURIComponent(postUrl);
    proxyTargets.unshift(_bcCustomProxy.replace('{URL}',enc).replace('{url}',enc) || `${_bcCustomProxy}?url=${enc}`);
  }

  for(const proxyUrl of proxyTargets){
    try {
      const resp = await Promise.race([
        fetch(proxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Referer': pageUrl,
            'Origin': new URL(pageUrl).origin,
          },
          body: params.toString()
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),18000))
      ]);

      const text = await resp.text();
      const lower = text.toLowerCase();

      if(resp.redirected || resp.status===302 || resp.status===301){
        if(lower.includes('moderate')||lower.includes('pending')||lower.includes('awaiting')){
          return { success:true, moderated:true, msg:'Submitted â€” awaiting moderation' };
        }
        return { success:true, moderated:false, msg:'Comment posted (server redirected = success)' };
      }

      if(resp.status===200){
        if(lower.includes('your comment is awaiting')||lower.includes('pending moderation')){
          return { success:true, moderated:true, msg:'Comment submitted â€” pending moderation' };
        }
        if(lower.includes('duplicate')||lower.includes('already said that')){
          return { success:true, moderated:false, msg:'Duplicate â€” already posted' };
        }
        // Strong success signals
        if(
          lower.includes('comment-')||lower.includes('commentlist')||
          lower.includes('#comment-')||lower.includes('comment posted')||
          lower.includes('thanks for')
        ){
          return { success:true, moderated:false, msg:'Comment posted (HTTP 200, success signals detected)' };
        }
        // WP error signals
        if(lower.includes('wp-die')||lower.includes('<p>sorry')||lower.includes('error')){
          const errMatch = text.match(/<p[^>]*>([\s\S]{10,300}?)<\/p>/i);
          const errMsg = errMatch ? errMatch[1].replace(/<[^>]+>/g,'').trim() : 'WordPress returned an error';
          return { success:false, moderated:false, msg:`WP Error: ${errMsg.slice(0,150)}` };
        }
        // Ambiguous 200 â€” treat as likely success
        return { success:true, moderated:true, msg:'Submitted (HTTP 200 â€” verify on site to confirm)' };
      }

      if(resp.status===403) return { success:false, moderated:false, msg:'403 Forbidden â€” nonce expired, spam filter, or Cloudflare blocking' };
      if(resp.status===404) return { success:false, moderated:false, msg:'404 â€” wp-comments-post.php not found on this site' };
      if(resp.status===429) return { success:false, moderated:false, msg:'429 Rate limited â€” wait before retrying' };
      if(resp.status===409) return { success:true, moderated:false, msg:'409 Conflict â€” likely duplicate, comment may already exist' };
      if(resp.status>=500){ continue; } // server error, try next proxy

    } catch(e){ continue; }
  }
  return { success:false, moderated:false, msg:'All POST proxies failed â€” site may be blocking proxy IPs or require CAPTCHA. Use Manual Assist mode.' };
}

// â”€â”€ GENERIC / NON-WP COMMENT ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bcGenericComment(pageUrl, html, name, email, website, comment, logFn){
  // Auto-solve any CAPTCHA present on the comment form
  const hasRecaptcha = /google\.com\/recaptcha|g-recaptcha/.test(html);
  const hasHcaptcha  = /hcaptcha\.com|h-captcha/.test(html);
  if(hasRecaptcha || hasHcaptcha){
    const skm = html.match(/data-sitekey=["']([^"']+)["']/i)||html.match(/sitekey[=:][\s"']+([A-Za-z0-9_-]{20,})/i);
    const siteKey = skm ? skm[1] : '';
    const type = hasHcaptcha ? 'hcaptcha' : 'recaptcha_v2';
    logFn && logFn(`   â†’ CAPTCHA detected (${type}) â€” auto-solving...`,'info');
    try {
      const capRes = await capSolve({type, siteKey, siteUrl:pageUrl});
      if(capRes.solved) logFn && logFn(`   âœ“ CAPTCHA solved [${capRes.source}]`,'success');
      else logFn && logFn(`   âš  CAPTCHA solve attempt completed (token generated)`,'warn');
    } catch(e){ logFn && logFn(`   âš  CAPTCHA solve skipped: ${e.message}`,'warn'); }
  }
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // Find ANY form on the page that looks like a comment form
  const allForms = Array.from(doc.querySelectorAll('form'));
  let form = null;
  for(const f of allForms){
    const fHtml = f.innerHTML.toLowerCase();
    if(
      fHtml.includes('comment') || fHtml.includes('message') ||
      fHtml.includes('reply') || fHtml.includes('author') ||
      f.id.toLowerCase().includes('comment') ||
      (f.className||'').toLowerCase().includes('comment')
    ){ form = f; break; }
  }
  if(!form && allForms.length>0) form = allForms[0]; // last resort, take first form
  if(!form) return { success:false, moderated:false, msg:'No comment/contact form found on page' };

  let postUrl = '';
  try {
    const base = new URL(pageUrl);
    const action = form.getAttribute('action')||'';
    if(!action||action==='#'||action===pageUrl){ postUrl = pageUrl; }
    else if(action.startsWith('http')){ postUrl = action; }
    else if(action.startsWith('/')){ postUrl = base.origin + action; }
    else { postUrl = base.origin + '/' + action; }
  } catch(e){ postUrl = pageUrl; }

  const params = new URLSearchParams();
  // Capture all hidden fields (CSRF tokens, etc.)
  form.querySelectorAll('input[type="hidden"]').forEach(inp=>{
    if(inp.name) params.set(inp.name, inp.value||'');
  });

  // Intelligently map fields
  form.querySelectorAll('input, textarea, select').forEach(inp=>{
    const n = (inp.getAttribute('name')||'').toLowerCase();
    const id = (inp.getAttribute('id')||'').toLowerCase();
    const ph = (inp.getAttribute('placeholder')||'').toLowerCase();
    const realName = inp.getAttribute('name');
    if(!realName||inp.type==='hidden'||inp.type==='submit'||inp.type==='button'||inp.type==='checkbox'||inp.type==='radio') return;

    const isName = n.includes('name')||n.includes('author')||id.includes('name')||id.includes('author')||ph.includes('name');
    const isEmail = n.includes('email')||n.includes('mail')||id.includes('email')||ph.includes('email');
    const isWeb = n.includes('url')||n.includes('site')||n.includes('web')||id.includes('url')||ph.includes('url')||ph.includes('website');
    const isMsg = n.includes('comment')||n.includes('message')||n.includes('content')||n.includes('body')||n.includes('text')||inp.tagName==='TEXTAREA'||id.includes('comment')||id.includes('message');

    if(isName) params.set(realName, name);
    else if(isEmail) params.set(realName, email);
    else if(isWeb) params.set(realName, website||'');
    else if(isMsg) params.set(realName, comment);
  });

  // Add submit value
  const submitBtn = form.querySelector('input[type="submit"], button[type="submit"]');
  if(submitBtn && submitBtn.name) params.set(submitBtn.name, submitBtn.value||'Submit');

  logFn(`   â†’ Generic form POST to: ${postUrl.slice(0,80)}...`,'info');

  const proxyTargets = [
    `https://corsproxy.io/?${encodeURIComponent(postUrl)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(postUrl)}`,
    `https://thingproxy.freeboard.io/fetch/${postUrl}`,
    `https://proxy.cors.sh/${postUrl}`,
  ];
  if(_bcCustomProxy){
    const enc = encodeURIComponent(postUrl);
    proxyTargets.unshift(_bcCustomProxy.replace('{URL}',enc).replace('{url}',enc) || `${_bcCustomProxy}?url=${enc}`);
  }

  for(const proxyUrl of proxyTargets){
    try {
      const resp = await Promise.race([
        fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Referer': pageUrl },
          body: params.toString()
        }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),16000))
      ]);
      const text = await resp.text();
      const lower = text.toLowerCase();
      if(resp.status===201||resp.redirected||(resp.status===200&&(lower.includes('thank')||lower.includes('success')||lower.includes('posted')||lower.includes('received')||lower.includes('submitt')))){
        return { success:true, moderated:false, msg:`Generic form submitted (HTTP ${resp.status})` };
      }
      if(resp.status>=200&&resp.status<400){
        return { success:true, moderated:true, msg:`Submitted (HTTP ${resp.status}) â€” verify on site` };
      }
    } catch(e){ continue; }
  }
  return { success:false, moderated:false, msg:'Generic POST failed â€” site likely blocks proxy IPs. Use Manual Assist.' };
}

// â”€â”€ MANUAL ASSIST LAUNCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bcManualAssist(site, name, email, website, comment){
  // Copy comment to clipboard
  navigator.clipboard.writeText(comment).catch(()=>{
    const ta = document.createElement('textarea');
    ta.value = comment;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
  });

  // Open site in new tab
  const tab = window.open(site.url, '_blank');

  // Show instructions modal
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `<div class="modal-box" style="min-width:520px;max-width:680px">
    <div class="modal-title">ğŸ¤ Manual Assist Mode â€” ${esc(site.label||site.url)} <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ•</button></div>
    <div class="notice notice-success" style="margin-bottom:12px">âœ… Comment copied to clipboard! Site opened in new tab.</div>
    <div class="card-title" style="margin-bottom:8px">Your Comment Identity</div>
    <div class="grid2" style="margin-bottom:10px">
      <div style="background:var(--bg);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-family:var(--mono);font-size:11px">
        <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:3px">NAME</div>
        <div style="font-weight:700;color:var(--text)">${esc(name)}</div>
      </div>
      <div style="background:var(--bg);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-family:var(--mono);font-size:11px">
        <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:3px">EMAIL</div>
        <div style="font-weight:700;color:var(--text)">${esc(email)}</div>
      </div>
      ${website?`<div style="background:var(--bg);border:1px solid var(--border);padding:8px 12px;border-radius:6px;font-family:var(--mono);font-size:11px;grid-column:1/-1">
        <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:3px">WEBSITE</div>
        <div style="font-weight:700;color:var(--accent)">${esc(website)}</div>
      </div>`:''}
    </div>
    <div style="background:var(--bg);border:1px solid var(--border);padding:10px 12px;border-radius:6px;margin-bottom:12px">
      <div style="color:var(--muted2);font-size:9px;text-transform:uppercase;margin-bottom:4px;font-family:var(--mono)">COMMENT (ALREADY IN CLIPBOARD)</div>
      <div style="font-family:var(--mono);font-size:11px;line-height:1.7;color:var(--text);font-weight:600">${esc(comment)}</div>
    </div>
    <div class="notice notice-warn" style="margin-bottom:12px">
      <strong>Steps:</strong> 1. Switch to the new tab Â· 2. Scroll to the Comments section Â· 3. Fill Name, Email, Website Â· 4. Paste comment (Ctrl+V) Â· 5. Click Submit
    </div>
    <div class="row">
      <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(${JSON.stringify(comment)}).then(()=>bcTermLog('Comment re-copied!','success'))">ğŸ“‹ Re-copy Comment</button>
      <button class="btn btn-ghost" onclick="navigator.clipboard.writeText(${JSON.stringify(name+'\n'+email+(website?'\n'+website:'')+'\n\n'+comment)}).then(()=>bcTermLog('All fields copied!','success'))">ğŸ“‹ Copy All Fields</button>
      <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove();bcMarkDone('${site.id}')">âœ… Mark as Done</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

// â”€â”€ MAIN COMMENT ORCHESTRATOR v2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bcCommentOnSite(site, name, email, website, comment, logFn){
  const url = site.url;
  const siteType = (site.type||'generic').toLowerCase();

  // â”€â”€ STEP 1: Detect WordPress via REST API discovery â”€â”€
  logFn(`   â†’ Probing site type and REST API...`,'info');
  const origin = new URL(url).origin;
  const wpJsonUrl = `${origin}/wp-json/`;

  let isWordPress = false;
  let wpPostId = null;

  try {
    const probe = await bcProxyFetch(wpJsonUrl, { timeout: 10000 });
    if(probe.ok && (probe.text.includes('"namespaces"') || probe.text.includes('wp/v2'))){
      isWordPress = true;
      logFn(`   âœ“ WordPress detected (REST API active)`,'success');
    } else if(probe.text.includes('wp-content')||probe.text.includes('wp-includes')||probe.text.includes('wordpress')){
      isWordPress = true;
      logFn(`   âœ“ WordPress detected (HTML fingerprint)`,'success');
    }
  } catch(e){}

  // Force WP detection from site type field
  if(siteType==='wordpress') isWordPress = true;

  // â”€â”€ STEP 2: Fetch the actual page â”€â”€
  logFn(`   â†’ Fetching page HTML...`,'info');
  let html = '';
  let fetchOk = false;

  const pageResult = await bcProxyFetch(url, { timeout: 18000 });
  if(pageResult.ok && pageResult.text.length > 200){
    html = pageResult.text;
    fetchOk = true;
    logFn(`   âœ“ Page fetched (${(html.length/1024).toFixed(1)} KB) via [${pageResult.proxy}]`,'success');

    if(!isWordPress && (html.includes('wp-content')||html.includes('wp-includes')||html.includes('/wp-json/'))){
      isWordPress = true;
      logFn(`   âœ“ WordPress confirmed from page content`,'success');
    }
  } else {
    logFn(`   âš  Page fetch failed (${pageResult.status||pageResult.error||'network error'})`,'warn');
  }

  // â”€â”€ STEP 3: Extract post ID â”€â”€
  if(html) {
    wpPostId = bcExtractWpPostId(html, url);
    if(wpPostId) logFn(`   âœ“ Post ID: ${wpPostId}`,'success');
  }

  // â”€â”€ STEP 4: REST API slug lookup if no post ID â”€â”€
  if(isWordPress && !wpPostId){
    try {
      const slug = url.split('/').filter(Boolean).pop().replace(/[?#].*$/,'');
      const lookupUrl = `${origin}/wp-json/wp/v2/posts?slug=${encodeURIComponent(slug)}&_fields=id,slug`;
      const lookup = await bcProxyFetch(lookupUrl, { timeout: 10000 });
      if(lookup.ok){
        try{
          const posts = JSON.parse(lookup.text);
          if(Array.isArray(posts) && posts.length > 0){
            wpPostId = String(posts[0].id);
            logFn(`   âœ“ Post ID found via REST slug lookup: ${wpPostId}`,'success');
          }
        }catch(e){}
      }
    } catch(e){}
  }

  // â”€â”€ STEP 5: Try WordPress REST API â”€â”€
  if(isWordPress && wpPostId){
    logFn(`   â†’ Attempting WordPress REST API...`,'info');
    const restResult = await bcWpRestComment(url, wpPostId, name, email, website, comment);
    if(restResult.success) return restResult;
    if(!restResult.tryLegacy) return restResult;
    logFn(`   âš  REST API blocked â€” falling back to form POST`,'warn');
  }

  // â”€â”€ STEP 6: Legacy form POST (WordPress & generic) â”€â”€
  if(html){
    logFn(`   â†’ Attempting form POST...`,'info');
    if(isWordPress){
      return await bcWpLegacyComment(url, html, name, email, website, comment);
    } else {
      return await bcGenericComment(url, html, name, email, website, comment, logFn);
    }
  }

  // â”€â”€ STEP 7: Blind WP attempt â”€â”€
  if(isWordPress){
    logFn(`   â†’ Last resort: blind wp-comments-post.php POST...`,'info');
    const fakeHtml = `<form action="${origin}/wp-comments-post.php"><input name="comment_post_ID" value="1"><input name="author"><input name="email"><input name="url"><textarea name="comment"></textarea></form>`;
    return await bcWpLegacyComment(url, fakeHtml, name, email, website, comment);
  }

  // â”€â”€ STEP 8: Absolute fallback â€” blind form POST to page URL â”€â”€
  logFn(`   â†’ Fallback: blind POST to page URL...`,'info');
  const fallbackHtml = `<form action="${url}"><input name="name"><input name="email"><input name="url"><textarea name="comment"></textarea></form>`;
  return await bcGenericComment(url, fallbackHtml, name, email, website, comment, logFn);
}

async function bcStartRun(){
  if(_bcRunning){ alert('Already running!'); return; }
  const pending=_bcSites.filter(s=>!s.done);
  if(!pending.length){ alert('No pending sites. Add sites or push a URL list first.'); return; }

  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const name=(document.getElementById('bc-gen-name')||{value:'A Reader'}).value.trim()||'A Reader';
  const email=(document.getElementById('bc-email')||{value:''}).value.trim();
  const website=(document.getElementById('bc-website')||{value:''}).value.trim();
  const delay=parseInt((document.getElementById('bc-delay')||{value:'3000'}).value)||3000;
  const manualFallback=(document.getElementById('bc-manual-fallback')||{checked:false}).checked;

  // Save custom proxy setting
  const customProxy=(document.getElementById('bc-custom-proxy')||{value:''}).value.trim();
  if(customProxy!==_bcCustomProxy){ _bcCustomProxy=customProxy; localStorage.setItem('bc_custom_proxy',customProxy); }

  if(!name){ alert('Display name is required.'); return; }
  if(!email){ alert('Email is required for commenting.'); return; }

  const commentEl=document.getElementById('bc-gen-out');
  if(!commentEl||!commentEl.value.trim()) bcGenerate();
  const baseComment=(document.getElementById('bc-gen-out')||{value:''}).value.trim()||bcGenComment(kw,'',name);

  _bcRunning=true; _bcStop=false; _bcSessionResults=[];

  document.getElementById('bc-start-btn').disabled=true;
  document.getElementById('bc-stop-btn').style.display='';
  document.getElementById('bc-run-badge').style.display='';
  document.getElementById('bc-prog-wrap').style.display='';
  document.getElementById('bc-prog-label').style.display='';

  bcTermSeparator('â–¶ SESSION START');
  bcTermLog(`ğŸš€ Starting Auto Commenter â€” ${pending.length} sites queued`,'accent');
  bcTermLog(`ğŸ‘¤ Identity: ${esc(name)} | ${esc(email)} | ${esc(website||'no website')}`,'info');
  bcTermLog(`ğŸ’¬ Base comment: "${esc(baseComment.slice(0,80))}${baseComment.length>80?'...':''}"`, 'info');
  bcTermLog(`âš™ Engine: WP REST API â†’ Legacy form POST â†’ Generic POST â†’ Manual Assist (8 proxies)`, 'accent');
  bcTermSeparator('');

  let done=0, success=0, failed=0;
  const total=pending.length;

  for(let i=0;i<pending.length;i++){
    if(_bcStop){ bcTermLog('â¹ Stopped by user.','warn'); break; }

    const site=pending[i];
    const siteComment=site.queued||bcGenComment(kw,site.url,site.name||name);
    const siteName=site.name||name;
    const siteEmail=site.email||email;
    const siteWebsite=site.website||website;

    const pct=Math.round(((i+1)/total)*100);
    const pf=document.getElementById('bc-prog-fill');
    const pl=document.getElementById('bc-prog-label');
    if(pf) pf.style.width=pct+'%';
    if(pl) pl.textContent=`Site ${i+1}/${total} â€” ${pct}%`;

    bcTermSeparator(`SITE ${i+1}/${total}`);
    bcTermLog(`ğŸŒ ${esc(site.url)}`,'accent');

    let result={url:site.url, label:site.label||site.url, status:'failed', reason:'', comment:siteComment};

    try{
      const postResult = await bcCommentOnSite(site, siteName, siteEmail, siteWebsite, siteComment, (msg,type)=>bcTermLog(msg,type));

      if(postResult.success && !postResult.moderated){
        bcTermLog(`   âœ… COMMENT POSTED!`,'success');
        bcTermLog(`   â†’ ${esc(postResult.msg)}`,'muted');
        result.status='success'; result.reason=postResult.msg;
        site.done=true; site.queued=siteComment; bcSave();
        success++;
      } else if(postResult.success && postResult.moderated){
        bcTermLog(`   â³ Comment submitted â€” awaiting moderation`,'success');
        bcTermLog(`   â†’ ${esc(postResult.msg)}`,'muted');
        result.status='moderated'; result.reason=postResult.msg;
        site.done=true; site.queued=siteComment; bcSave();
        success++;
      } else {
        bcTermLog(`   âœ— Failed: ${esc(postResult.msg)}`,'error');
        result.status='failed'; result.reason=postResult.msg;
        failed++;
        // Offer manual assist if enabled and we couldn't auto-post
        if(manualFallback){
          bcTermLog(`   â†’ Opening Manual Assist for this site...`,'warn');
          await new Promise(r=>setTimeout(r,800));
          bcManualAssist(site, siteName, siteEmail, siteWebsite, siteComment);
          // Wait for user to potentially dismiss the modal
          await bcWait(3000);
        }
      }
    } catch(err){
      bcTermLog(`   âœ— Error: ${esc(err.message||'Unknown')}`,'error');
      result.status='error'; result.reason=err.message||'Unknown error';
      failed++;
    }

    _bcSessionResults.push(result);
    done++;
    bcRefresh();

    if(i<pending.length-1&&!_bcStop){
      bcTermLog(`   â³ Waiting ${delay/1000}s before next site...`,'muted');
      await bcWait(delay);
    }
  }

  bcTermSeparator('â–¶ COMPLETE');
  bcTermLog(`âœ… Done â€” ${success} posted Â· ${failed} failed Â· ${done} total`,'success');
  bcLog(`Session: ${success}/${done} succeeded`,'success');

  _bcRunning=false; _bcStop=false;
  document.getElementById('bc-start-btn').disabled=false;
  document.getElementById('bc-stop-btn').style.display='none';
  document.getElementById('bc-run-badge').style.display='none';
  if(document.getElementById('bc-prog-fill')) document.getElementById('bc-prog-fill').style.width='100%';
  bcShowResultsSummary();
  bcRefresh();
}

let _bcSessionResults=[];
function bcShowResultsSummary(){
  const successList=_bcSessionResults.filter(r=>r.status==='success'||r.status==='moderated');
  const failList=_bcSessionResults.filter(r=>r.status!=='success'&&r.status!=='moderated');

  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`
  <div class="modal-box" style="min-width:680px;max-width:90vw;max-height:90vh;overflow-y:auto">
    <div class="modal-title">
      ğŸ“Š Commenting Session Results
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ• Close</button>
    </div>

    <div class="grid2" style="margin-bottom:16px;gap:12px">
      <div style="background:rgba(0,87,255,0.06);border:1px solid rgba(0,87,255,0.2);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:32px;font-weight:800;font-family:var(--mono);color:var(--accent)">${successList.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);margin-top:4px;text-transform:uppercase;letter-spacing:0.08em">âœ… Successful</div>
      </div>
      <div style="background:rgba(232,0,61,0.06);border:1px solid rgba(232,0,61,0.2);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:32px;font-weight:800;font-family:var(--mono);color:var(--accent2)">${failList.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);margin-top:4px;text-transform:uppercase;letter-spacing:0.08em">âœ— Failed / Manual Required</div>
      </div>
    </div>

    ${successList.length?`
    <div style="margin-bottom:16px">
      <div style="font-family:var(--mono);font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;font-weight:700">âœ… SUCCESSFUL COMMENTS (${successList.length})</div>
      ${successList.map(r=>`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);border-radius:7px;margin-bottom:5px">
        <span style="font-size:14px">${r.status==='moderated'?'â³':'âœ…'}</span>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--mono);font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.label)}</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.url)}</div>
        </div>
        <span class="badge ${r.status==='moderated'?'badge-y':'badge-g'}">${r.status==='moderated'?'Pending Moderation':'Posted'}</span>
        <span style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.reason)}</span>
      </div>`).join('')}
    </div>`:''}

    ${failList.length?`
    <div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--accent2);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;font-weight:700">âœ— FAILED / NEEDS MANUAL ACTION (${failList.length})</div>
      ${failList.map(r=>`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(232,0,61,0.04);border:1px solid rgba(232,0,61,0.15);border-radius:7px;margin-bottom:5px">
        <span style="font-size:14px">âŒ</span>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--mono);font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.label)}</div>
          <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.reason)}</div>
        </div>
        <a href="${esc(r.url)}" target="_blank" class="btn btn-ghost btn-xs">Open Site</a>
      </div>`).join('')}
    </div>`:''}

    <div class="row" style="margin-top:16px">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-primary" onclick="bcExportResults()">ğŸ“¤ Export Results CSV</button>
      <button class="btn btn-blue" onclick="bcPushSuccessToAutoPoster()" title="Push successful sites to Auto Poster">ğŸ“¤ Push to Auto Poster</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  // After session completes, also flush any deferred manual search popup inline
  bcFlushDeferredParasiteResults();
}

function bcFlushDeferredParasiteResults(){
  if(!pfPendingManualSearchData) return;
  const {queries, engine, recency, keyword} = pfPendingManualSearchData;
  pfPendingManualSearchData = null;
  // Show inline below the blog commenter terminal instead of popup
  const terminal = document.querySelector('#bc-terminal');
  if(!terminal) return;
  const container = terminal.closest('.card');
  if(!container) return;
  const div = document.createElement('div');
  div.className = 'card';
  div.style.marginTop = '12px';
  const linksHtml = queries.slice(0,10).map((q,i)=>{
    const url = csBuildSearchUrl(engine, q.query, recency);
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border)">
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px">${i+1}</span>
      <div style="flex:1;min-width:0;font-family:var(--mono);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)">${esc(q.query)}</div>
      <a href="${esc(url)}" target="_blank" class="btn btn-primary btn-xs">Search â†’</a>
    </div>`;
  }).join('');
  div.innerHTML = `<div class="card-title">ğŸ”— Parasite Manual Search Links â€” Session Complete</div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-bottom:10px">Your blog commenter session is done. Click any link below to find parasite sites for <b>${esc(keyword)}</b>.</div>
    <div style="max-height:300px;overflow-y:auto">${linksHtml}</div>`;
  container.after(div);
}

// Push successful session URLs to Auto Poster
function bcPushSuccessToAutoPoster(){
  const successList = _bcSessionResults.filter(r => r.status==='success' || r.status==='moderated');
  if(!successList.length){ alert('No successful URLs to push.'); return; }
  // Store them in a global for the Auto Poster to pick up
  if(!window._autoPosterQueue) window._autoPosterQueue = [];
  successList.forEach(r => {
    if(!window._autoPosterQueue.find(x=>x.url===r.url)){
      window._autoPosterQueue.push({ url: r.url, label: r.label, status: r.status, comment: r.comment||'' });
    }
  });
  // Open Auto Poster modal
  bcShowAutoPosterSetup(successList);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO POSTER â€” Push Successful Parasite Sites to Auto Poster Setup
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _apSites = JSON.parse(localStorage.getItem('ap_sites')||'[]');
let _apRunning = false;

function apSave(){ localStorage.setItem('ap_sites', JSON.stringify(_apSites)); }

function bcShowAutoPosterSetup(successList){
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = e => { if(e.target===overlay) overlay.remove(); };

  const existingUrls = new Set(_apSites.map(s=>s.url));
  const newSites = successList.filter(r => !existingUrls.has(r.url));

  overlay.innerHTML = `
  <div class="modal-box" style="min-width:720px;max-width:92vw;max-height:92vh;overflow-y:auto">
    <div class="modal-title">
      ğŸ“¤ Auto Poster Setup â€” Push Parasite Sites
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ• Close</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div style="background:rgba(0,87,255,0.06);border:1px solid rgba(0,87,255,0.2);border-radius:10px;padding:14px;text-align:center">
        <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent)">${successList.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase;letter-spacing:.08em">âœ… Successful Sites</div>
      </div>
      <div style="background:rgba(124,58,237,0.06);border:1px solid rgba(124,58,237,0.2);border-radius:10px;padding:14px;text-align:center">
        <div style="font-size:28px;font-weight:800;font-family:var(--mono);color:var(--accent5)">${newSites.length}</div>
        <div style="font-size:10px;font-family:var(--mono);color:var(--muted2);text-transform:uppercase;letter-spacing:.08em">New to Auto Poster</div>
      </div>
    </div>

    <!-- Platform selector -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">âš™ï¸ Auto Post Platform</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
        ${['github','netlify','wordpress','blogger','medium','custom'].map(p => {
          const icons = {github:'ğŸ±',netlify:'ğŸŒ',wordpress:'ğŸ“',blogger:'ğŸ“°',medium:'âœï¸',custom:'âš™ï¸'};
          const labels = {github:'GitHub Pages',netlify:'Netlify',wordpress:'WordPress REST',blogger:'Blogger API',medium:'Medium API',custom:'Custom Webhook'};
          return `<div onclick="apSelectPlatform('${p}')" id="ap-plat-${p}" style="cursor:pointer;padding:10px;border:2px solid var(--border);border-radius:8px;text-align:center;transition:all .15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="if(!this.classList.contains('selected')) this.style.borderColor='var(--border)'">
            <div style="font-size:22px">${icons[p]}</div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--muted2);margin-top:4px;font-weight:700">${labels[p]}</div>
          </div>`;
        }).join('')}
      </div>

      <!-- Dynamic credential fields -->
      <div id="ap-cred-fields" style="display:none">
        <div style="font-family:var(--mono);font-size:10px;color:var(--accent);margin-bottom:8px;font-weight:700" id="ap-cred-title">Platform Credentials</div>
        <div id="ap-cred-body"></div>
      </div>
    </div>

    <!-- Post settings -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">ğŸ“ Post Settings</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
        <div>
          <label class="lbl">Post Title Template</label>
          <input type="text" id="ap-title-tpl" value="{keyword} â€” Review &amp; Guide" placeholder="{keyword} used as variable"/>
        </div>
        <div>
          <label class="lbl">Post Delay (seconds between posts)</label>
          <input type="number" id="ap-delay" value="5" min="2" max="60"/>
        </div>
      </div>
      <div style="margin-bottom:10px">
        <label class="lbl">Content Template (use {url}, {keyword}, {comment} as variables)</label>
        <textarea id="ap-content-tpl" rows="4" placeholder="e.g. Check out this resource: {url}&#10;&#10;{comment}">{comment}

Read more: {url}</textarea>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <label class="lbl" style="margin:0">Tags / Labels</label>
        <input type="text" id="ap-tags" placeholder="seo, parasite, backlink" style="width:auto;flex:1"/>
      </div>
    </div>

    <!-- Sites to push -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title">ğŸŒ Sites to Auto-Post To (${successList.length} total)</div>
      <div style="max-height:220px;overflow-y:auto">
        ${successList.map((r,i)=>`
        <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border)">
          <input type="checkbox" id="ap-chk-${i}" checked style="width:auto;flex-shrink:0"/>
          <span style="font-size:14px">${r.status==='moderated'?'â³':'âœ…'}</span>
          <div style="flex:1;min-width:0">
            <div style="font-family:var(--mono);font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.label||r.url)}</div>
            <div style="font-family:var(--mono);font-size:9px;color:var(--muted2)">${esc(r.url)}</div>
          </div>
          <span style="font-family:var(--mono);font-size:9px;padding:2px 7px;border-radius:4px;background:${r.status==='success'?'rgba(0,87,255,0.1)':'rgba(217,119,6,0.1)'};color:${r.status==='success'?'var(--accent)':'var(--accent3)'}">${r.status}</span>
        </div>`).join('')}
      </div>
    </div>

    <!-- Terminal -->
    <div class="card" style="margin-bottom:14px;display:none" id="ap-terminal-card">
      <div class="card-title">âš¡ Auto Poster Terminal</div>
      <div id="ap-terminal" style="background:#0d1117;border:1px solid #30363d;padding:12px;font-family:var(--mono);font-size:10px;height:160px;overflow-y:auto;line-height:1.8;border-radius:8px;color:#c9d1d9"></div>
    </div>

    <div class="row" style="margin-top:0;gap:10px;flex-wrap:wrap">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
      <button class="btn btn-ghost btn-sm" onclick="apAddAllToQueue(${JSON.stringify(successList).replace(/</g,'&lt;')})">+ Add to AP Queue</button>
      <button class="btn btn-primary" id="ap-run-btn" onclick="apRunSelected(${JSON.stringify(successList).replace(/</g,'&lt;')})">
        â–¶ Start Auto Posting
      </button>
    </div>
  </div>`;

  document.body.appendChild(overlay);
}

const AP_CRED_DEFS = {
  github:    { title:'GitHub Pages', fields:[{id:'token',label:'Personal Access Token',ph:'ghp_...',type:'password'},{id:'repo',label:'Repo (user/repo)',ph:'username/my-seo-site'},{id:'branch',label:'Branch',ph:'main'}] },
  netlify:   { title:'Netlify', fields:[{id:'token',label:'Personal Access Token',ph:'netlify-token...',type:'password'},{id:'site_id',label:'Site ID (optional)',ph:'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'}] },
  wordpress: { title:'WordPress REST API', fields:[{id:'site_url',label:'Site URL',ph:'https://yoursite.com'},{id:'username',label:'Username',ph:'admin'},{id:'app_password',label:'Application Password',ph:'xxxx xxxx xxxx',type:'password'}] },
  blogger:   { title:'Blogger API', fields:[{id:'api_key',label:'API Key',ph:'AIza...',type:'password'},{id:'blog_id',label:'Blog ID',ph:'1234567890'}] },
  medium:    { title:'Medium API', fields:[{id:'token',label:'Integration Token',ph:'medium-token...',type:'password'}] },
  custom:    { title:'Custom Webhook', fields:[{id:'webhook_url',label:'Webhook URL',ph:'https://your-endpoint.com/post'},{id:'auth_header',label:'Auth Header (optional)',ph:'Bearer token123'}] },
};

let _apSelectedPlatform = null;
let _apCredentials = {};

function apSelectPlatform(pid){
  _apSelectedPlatform = pid;
  document.querySelectorAll('[id^="ap-plat-"]').forEach(el => {
    el.style.borderColor = 'var(--border)';
    el.classList.remove('selected');
  });
  const sel = document.getElementById(`ap-plat-${pid}`);
  if(sel){ sel.style.borderColor = 'var(--accent)'; sel.style.background = 'rgba(0,87,255,0.06)'; sel.classList.add('selected'); }

  const def = AP_CRED_DEFS[pid];
  if(!def) return;
  const credFields = document.getElementById('ap-cred-fields');
  const credTitle = document.getElementById('ap-cred-title');
  const credBody = document.getElementById('ap-cred-body');
  if(credTitle) credTitle.textContent = def.title + ' â€” Credentials';
  if(credBody) credBody.innerHTML = def.fields.map(f=>`
    <div style="margin-bottom:10px">
      <label class="lbl">${f.label}</label>
      <input type="${f.type||'text'}" id="ap-cred-${f.id}" placeholder="${f.ph}" oninput="_apCredentials['${f.id}']=this.value" autocomplete="off"/>
    </div>`).join('');
  if(credFields) credFields.style.display = '';
}

function apLog(msg, color='#c9d1d9'){
  const term = document.getElementById('ap-terminal');
  if(!term) return;
  const d = document.createElement('div');
  d.innerHTML = `<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`;
  term.appendChild(d);
  term.scrollTop = term.scrollHeight;
}

function apAddAllToQueue(sites){
  if(!_apSites) _apSites = [];
  let added = 0;
  const existingUrls = new Set(_apSites.map(s=>s.url));
  sites.forEach(r => {
    if(!existingUrls.has(r.url)){
      _apSites.push({ id: uid(), url: r.url, label: r.label||r.url, comment: r.comment||'', status: 'pending', added: Date.now() });
      added++;
    }
  });
  apSave();
  alert(`âœ“ Added ${added} sites to Auto Poster queue (${_apSites.length} total)`);
}

async function apRunSelected(allSites){
  if(!_apSelectedPlatform){ alert('Select a platform first.'); return; }
  if(_apRunning){ alert('Already running!'); return; }

  // Collect selected sites
  const selected = allSites.filter((r,i) => {
    const chk = document.getElementById(`ap-chk-${i}`);
    return chk && chk.checked;
  });
  if(!selected.length){ alert('No sites selected.'); return; }

  const titleTpl = (document.getElementById('ap-title-tpl')||{value:'{keyword}'}).value;
  const contentTpl = (document.getElementById('ap-content-tpl')||{value:'{comment}\n\n{url}'}).value;
  const delay = parseInt((document.getElementById('ap-delay')||{value:'5'}).value)*1000||5000;

  const termCard = document.getElementById('ap-terminal-card');
  const runBtn = document.getElementById('ap-run-btn');
  if(termCard) termCard.style.display = '';
  if(runBtn){ runBtn.disabled = true; runBtn.innerHTML = '<span class="spinner"></span> Posting...'; }

  _apRunning = true;
  apLog(`ğŸš€ Starting Auto Poster â€” ${selected.length} sites â€” Platform: ${_apSelectedPlatform.toUpperCase()}`, '#58a6ff');

  let success = 0, failed = 0;

  for(let i=0; i<selected.length; i++){
    const site = selected[i];
    const title = titleTpl.replace(/{keyword}/g, site.label||'SEO');
    const content = contentTpl.replace(/{url}/g, site.url).replace(/{keyword}/g, site.label||'SEO').replace(/{comment}/g, site.comment||'Great resource!');

    apLog(`[\${i+1}/${selected.length}] ğŸŒ ${esc(site.url)}`, '#d29922');

    try {
      let result = null;
      if(_apSelectedPlatform === 'github') result = await apPostGitHub(site, title, content);
      else if(_apSelectedPlatform === 'netlify') result = await apPostNetlify(site, title, content);
      else if(_apSelectedPlatform === 'wordpress') result = await apPostWordPress(site, title, content);
      else if(_apSelectedPlatform === 'blogger') result = await apPostBlogger(site, title, content);
      else if(_apSelectedPlatform === 'medium') result = await apPostMedium(site, title, content);
      else if(_apSelectedPlatform === 'custom') result = await apPostCustomWebhook(site, title, content);

      if(result && result.success){
        apLog(`   âœ… Posted! ${esc(result.url||'')}`, '#3fb950');
        success++;
      } else {
        apLog(`   âœ— Failed: ${esc(result&&result.msg||'Unknown error')}`, '#f85149');
        failed++;
      }
    } catch(e){
      apLog(`   âœ— Error: ${esc(e.message||'Unknown')}`, '#f85149');
      failed++;
    }

    if(i < selected.length-1){ await new Promise(r=>setTimeout(r,delay)); }
  }

  apLog(`âœ… Done â€” ${success} posted Â· ${failed} failed`, '#3fb950');
  _apRunning = false;
  if(runBtn){ runBtn.disabled = false; runBtn.innerHTML = 'â–¶ Start Auto Posting'; }
}

// â”€â”€ Platform-specific post functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function apPostGitHub(site, title, content){
  const token = _apCredentials.token;
  const repo = _apCredentials.repo;
  const branch = _apCredentials.branch||'main';
  if(!token||!repo) return {success:false, msg:'Missing GitHub token or repo'};
  const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').slice(0,50);
  const path = `posts/${Date.now()}-${slug}.html`;
  const htmlContent = `<!DOCTYPE html><html><head><title>${title}</title></head><body><h1>${title}</h1><p>${content}</p><a href="${site.url}">${site.url}</a></body></html>`;
  const encoded = btoa(unescape(encodeURIComponent(htmlContent)));
  try {
    const resp = await smartFetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: `Add: ${title}`, content: encoded, branch })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.content&&json.content.html_url||`https://github.com/${repo}/blob/${branch}/${path}` };
    return { success: false, msg: json.message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostNetlify(site, title, content){
  const token = _apCredentials.token;
  if(!token) return {success:false, msg:'Missing Netlify token'};
  try {
    // Create a new site then deploy
    const siteName = 'seo-ap-' + Date.now();
    const createResp = await smartFetch('https://api.netlify.com/api/v1/sites', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: siteName })
    });
    const siteData = await createResp.json();
    if(!createResp.ok) return {success:false, msg: siteData.message||'Failed to create Netlify site'};
    const siteId = siteData.id;
    const htmlContent = `<!DOCTYPE html><html><head><title>${title}</title></head><body><h1>${title}</h1><p>${content}</p><a href="${site.url}">${site.url}</a></body></html>`;
    // Deploy via zip
    const enc = new TextEncoder();
    const fileBytes = enc.encode(htmlContent);
    const deployResp = await smartFetch(`https://api.netlify.com/api/v1/sites/${siteId}/deploys`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/zip' },
      body: fileBytes
    });
    const deployData = await deployResp.json();
    if(deployResp.ok) return { success: true, url: `https://${siteName}.netlify.app` };
    return { success: false, msg: deployData.message||'Deploy failed' };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostWordPress(site, title, content){
  const siteUrl = (_apCredentials.site_url||'').replace(/\/$/,'');
  const username = _apCredentials.username;
  const appPw = _apCredentials.app_password;
  if(!siteUrl||!username||!appPw) return {success:false, msg:'Missing WordPress credentials'};
  try {
    const auth = btoa(username + ':' + appPw);
    const resp = await smartFetch(`${siteUrl}/wp-json/wp/v2/posts`, {
      method: 'POST',
      headers: { 'Authorization': `Basic ${auth}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, content, status: 'publish' })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.link||siteUrl };
    return { success: false, msg: json.message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostBlogger(site, title, content){
  const apiKey = _apCredentials.api_key;
  const blogId = _apCredentials.blog_id;
  if(!apiKey||!blogId) return {success:false, msg:'Missing Blogger API key or Blog ID'};
  try {
    const resp = await smartFetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ kind: 'blogger#post', title, content })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.url||'' };
    return { success: false, msg: json.error&&json.error.message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostMedium(site, title, content){
  const token = _apCredentials.token;
  if(!token) return {success:false, msg:'Missing Medium token'};
  try {
    const userResp = await smartFetch('https://api.medium.com/v1/me', {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const userData = await userResp.json();
    if(!userResp.ok) return {success:false, msg:'Invalid Medium token'};
    const userId = userData.data&&userData.data.id;
    const resp = await smartFetch(`https://api.medium.com/v1/users/${userId}/posts`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, contentFormat: 'html', content: `<h1>${title}</h1><p>${content}</p><p><a href="${site.url}">${site.url}</a></p>`, publishStatus: 'public' })
    });
    const json = await resp.json();
    if(resp.ok) return { success: true, url: json.data&&json.data.url||'' };
    return { success: false, msg: json.errors&&json.errors[0]&&json.errors[0].message||resp.status };
  } catch(e){ return {success:false, msg:e.message}; }
}

async function apPostCustomWebhook(site, title, content){
  const url = _apCredentials.webhook_url;
  const authHeader = _apCredentials.auth_header;
  if(!url) return {success:false, msg:'Missing webhook URL'};
  try {
    const headers = { 'Content-Type': 'application/json' };
    if(authHeader) headers['Authorization'] = authHeader;
    const resp = await smartFetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ title, content, source_url: site.url, label: site.label })
    });
    if(resp.ok) return { success: true, url };
    const text = await resp.text();
    return { success: false, msg: `HTTP ${resp.status}: ${text.slice(0,100)}` };
  } catch(e){ return {success:false, msg:e.message}; }
}

function bcExportResults(){
  const rows=[['URL','Label','Status','Reason','Comment'],
    ..._bcSessionResults.map(r=>[r.url,r.label,r.status,r.reason,r.comment||''])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='comment-results.csv'; a.click();
}

function bcStopRun(){
  _bcStop=true;
  bcTermLog('â¹ Stop requested â€” finishing current site...','warn');
  const sb=document.getElementById('bc-stop-btn');
  if(sb) sb.disabled=true;
}

function bcWait(ms){ return new Promise(res=>setTimeout(res,ms)); }

// Queue comment to ALL pending sites at once
function bcQueueAll(){
  const out=document.getElementById('bc-gen-out');
  if(!out||!out.value.trim()){ alert('Generate a comment first.'); return; }
  const pending=_bcSites.filter(s=>!s.done&&!s.queued);
  if(!pending.length){ alert('No pending sites without queued comments.'); return; }
  pending.forEach(s=>{ s.queued=out.value.trim(); });
  bcSave();
  bcLog(`Queued comment to all ${pending.length} pending sites.`,'success');
  bcTermLog(`âš¡ Comment queued to ${pending.length} sites.`,'success');
  bcRefresh();
}

function bcRenderSiteList(){
  if(!_bcSites.length) return '<p class="tm mono xs">No sites added yet. Add a blog URL above.</p>';
  return _bcSites.map((s,i)=>`
    <div id="bc-site-${s.id}" style="border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:7px;background:var(--bg)">
      <div class="flex aic g8" style="margin-bottom:6px">
        <span style="font-size:13px">${bcTypeIcon(s.type)}</span>
        <span class="mono xs ta" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
          <a href="${esc(s.url)}" target="_blank" rel="noreferrer" style="color:var(--accent);text-decoration:none">${esc(s.label||s.url)}</a>
        </span>
        <span class="badge badge-b">${esc(s.type)}</span>
        <button class="btn btn-ghost btn-xs" onclick="bcOpenSite('${s.id}')">ğŸŒ Open</button>
        <button class="btn btn-danger btn-xs" onclick="bcRemoveSite('${s.id}')">âœ•</button>
      </div>
      <div class="mono xs tm" style="margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.url)}</div>
      ${s.notes?`<div style="font-family:var(--mono);font-size:10px;color:var(--accent3);margin-bottom:6px">âš  ${esc(s.notes)}</div>`:''}
      <div class="flex aic g8">
        <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Name: <b>${esc(s.name||'â€”')}</b></span>
        ${s.email?`<span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Email: <b>${esc(s.email)}</b></span>`:''}
        ${s.website?`<span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Site: <b>${esc(s.website)}</b></span>`:''}
        <button class="btn btn-blue btn-xs" style="margin-left:auto" onclick="bcFillModal('${s.id}')">âœ Fill Comment</button>
        <button class="btn btn-yellow btn-xs" onclick="bcManualAssistSite('${s.id}')">ğŸ¤ Manual</button>
        <button class="btn btn-ghost btn-xs" onclick="bcMarkDone('${s.id}')" ${s.done?'style="color:var(--accent);border-color:var(--accent)"':''}>
          ${s.done?'âœ“ Done':'Mark Done'}
        </button>
      </div>
      ${s.queued?`<div style="margin-top:8px;padding:8px 10px;background:#fff;border:1px solid var(--border);border-radius:6px;font-family:var(--mono);font-size:11px;color:var(--text);line-height:1.6"><b class="tm" style="font-size:9px;text-transform:uppercase;letter-spacing:0.07em">Queued Comment:</b><br>${esc(s.queued)}</div>`:''}
    </div>`).join('');
}

function bcRenderLog(){
  if(!_bcLog.length) return '<p class="tm mono xs">No log entries yet.</p>';
  return _bcLog.slice().reverse().map(l=>`
    <div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--bg);border:1px solid var(--border);margin-bottom:5px;font-family:var(--mono);font-size:10px;border-radius:6px">
      <span class="tm" style="font-size:9px;flex-shrink:0">${l.ts}</span>
      <span class="${l.type==='success'?'ta':l.type==='error'?'tr':'tm'}">${l.type==='success'?'âœ“':l.type==='error'?'âœ—':'â„¹'}</span>
      <span style="flex:1">${esc(l.msg)}</span>
    </div>`).join('');
}

function bcTypeIcon(t){
  return {wordpress:'ğŸ”µ',blogger:'ğŸŸ ',disqus:'ğŸ’¬',generic:'ğŸŒ',other:'ğŸ“'}[t]||'ğŸ“';
}

function bcManualAssistSite(siteId){
  const site = _bcSites.find(s=>s.id===siteId);
  if(!site){ alert('Site not found.'); return; }
  const name = (document.getElementById('bc-gen-name')||{value:'A Reader'}).value.trim() || site.name || 'A Reader';
  const email = (document.getElementById('bc-email')||{value:''}).value.trim() || site.email || '';
  const website = (document.getElementById('bc-website')||{value:''}).value.trim() || site.website || '';
  const kwSel = (document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom = (document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw = kwCustom||kwSel||'this topic';
  const comment = site.queued || (document.getElementById('bc-gen-out')||{value:''}).value.trim() || bcGenComment(kw, site.url, name);
  if(!email){ alert('Please fill in your email address first.'); return; }
  bcManualAssist(site, name, email, website, comment);
}

function bcLog(msg,type='info'){ _bcLog.push({msg,type,ts:ts()}); }

function bcRefresh(){
  const sl=document.getElementById('bc-site-list');
  const ll=document.getElementById('bc-log');
  const ct=document.getElementById('bc-site-count');
  const lr=document.getElementById('bc-url-lists-render');
  if(sl) sl.innerHTML=bcRenderSiteList();
  if(ll) ll.innerHTML=bcRenderLog();
  if(ct) ct.textContent=_bcSites.length;
  if(lr) lr.innerHTML=bcRenderUrlLists();
}

function bcAddSite(){
  const urlEl=document.getElementById('bc-url');
  const url=(urlEl||{value:''}).value.trim();
  if(!url){ alert('Enter a URL first.'); return; }
  if(!/^https?:\/\//i.test(url)){ alert('URL must start with http:// or https://'); return; }
  const site={
    id:uid(),
    url,
    label:(document.getElementById('bc-label')||{value:''}).value.trim()||url,
    type:(document.getElementById('bc-type')||{value:'wordpress'}).value,
    name:(document.getElementById('bc-gen-name')||{value:''}).value.trim(),
    email:(document.getElementById('bc-email')||{value:''}).value.trim(),
    website:(document.getElementById('bc-website')||{value:''}).value.trim(),
    notes:(document.getElementById('bc-notes')||{value:''}).value.trim(),
    done:false,
    queued:'',
  };
  _bcSites.push(site);
  bcSave();
  bcLog(`Added site: ${site.label}`, 'info');
  bcTermLog(`â• Added: ${esc(site.url)}`,'info');
  // clear url+label+notes only
  ['bc-url','bc-label','bc-notes'].forEach(id=>{
    const e=document.getElementById(id); if(e) e.value='';
  });
  bcRefresh();
}

function bcRemoveSite(id){
  _bcSites=_bcSites.filter(s=>s.id!==id);
  bcSave();
  bcRefresh();
}

function bcClearAll(){
  if(!confirm('Clear all target sites?')) return;
  _bcSites=[];
  bcSave();
  bcRefresh();
}

function bcMarkDone(id){
  const s=_bcSites.find(x=>x.id===id);
  if(s){ s.done=!s.done; bcSave(); }
  bcRefresh();
}

function bcOpenSite(id){
  const s=_bcSites.find(x=>x.id===id);
  if(s) window.open(s.url,'_blank','noreferrer');
}

function bcGenerate(){
  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const name=(document.getElementById('bc-gen-name')||{value:'A Reader'}).value.trim()||'A Reader';
  const out=document.getElementById('bc-gen-out');
  if(out) out.value=bcGenComment(kw,'',name);
}

function bcCopyComment(){
  const out=document.getElementById('bc-gen-out');
  if(!out||!out.value.trim()){ alert('Generate a comment first.'); return; }
  navigator.clipboard.writeText(out.value).then(()=>{
    bcLog('Comment copied to clipboard.','success');
    bcRefresh();
  }).catch(()=>{
    // fallback
    out.select();
    document.execCommand('copy');
    bcLog('Comment copied (fallback).','success');
    bcRefresh();
  });
}

function bcQueueComment_legacy(){
  // Replaced by bcQueueAll
}

function bcFillModal(id){
  const s=_bcSites.find(x=>x.id===id);
  if(!s) return;

  // Build a mini fill-card overlay
  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.id='bc-modal';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };

  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const genName=s.name||'A Reader';
  const comment=s.queued||bcGenComment(kw,'',genName);

  overlay.innerHTML=`
    <div class="modal-box" style="min-width:520px;max-width:640px">
      <div class="modal-title">
        âœ Fill Comment â€” ${esc(s.label||s.url)}
        <button class="btn btn-ghost btn-xs" onclick="document.getElementById('bc-modal').remove()">âœ• Close</button>
      </div>
      <div class="notice notice-info" style="margin-bottom:14px">
        ğŸ“– Copy each field below and paste into the blog comment form. 
        <a href="${esc(s.url)}" target="_blank" rel="noreferrer" style="color:var(--accent4)">Open site â†’</a>
      </div>
      ${s.notes?`<div class="notice notice-warn">âš  Note: ${esc(s.notes)}</div>`:''}

      <div class="grid2" style="margin-bottom:12px">
        <div class="fg mb0"><label class="lbl">Name Field</label>
          <div class="flex g8">
            <input type="text" value="${esc(s.name||'')}" id="bcm-name" readonly style="background:var(--bg)"/>
            <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-name','Name')">Copy</button>
          </div>
        </div>
        <div class="fg mb0"><label class="lbl">Email Field</label>
          <div class="flex g8">
            <input type="text" value="${esc(s.email||'')}" id="bcm-email" readonly style="background:var(--bg)"/>
            <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-email','Email')">Copy</button>
          </div>
        </div>
      </div>
      <div class="fg" style="margin-bottom:12px"><label class="lbl">Website Field</label>
        <div class="flex g8">
          <input type="text" value="${esc(s.website||'')}" id="bcm-web" readonly style="background:var(--bg)"/>
          <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-web','Website')">Copy</button>
        </div>
      </div>
      <div class="fg" style="margin-bottom:14px"><label class="lbl">Comment Text</label>
        <textarea id="bcm-comment" rows="5" style="background:var(--bg)">${esc(comment)}</textarea>
        <div class="row mt8">
          <button class="btn btn-ghost btn-sm" onclick="bcCopyField('bcm-comment','Comment')">ğŸ“‹ Copy Comment</button>
          <button class="btn btn-primary btn-sm" onclick="bcRegen('${s.id}')">ğŸ² Regenerate</button>
          <button class="btn btn-yellow btn-sm" onclick="bcSaveQueued('${s.id}')">ğŸ’¾ Save to Queue</button>
        </div>
      </div>
      <div class="row">
        <button class="btn btn-ghost" onclick="document.getElementById('bc-modal').remove()">Close</button>
        <button class="btn btn-primary" onclick="window.open('${esc(s.url)}','_blank','noreferrer');bcMarkDoneAndClose('${s.id}')">ğŸŒ Open Site + Mark Done</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function bcCopyField(id,label){
  const el=document.getElementById(id);
  if(!el) return;
  const val=el.value||el.textContent||'';
  navigator.clipboard.writeText(val).catch(()=>{ el.select&&el.select(); document.execCommand&&document.execCommand('copy'); });
  bcLog(`${label} copied.`,'success');
  bcRefresh();
}

function bcRegen(siteId){
  const s=_bcSites.find(x=>x.id===siteId);
  const kwSel=(document.getElementById('bc-gen-kw')||{value:''}).value;
  const kwCustom=(document.getElementById('bc-custom-kw')||{value:''}).value.trim();
  const kw=kwCustom||kwSel||'this topic';
  const name=s?s.name:'A Reader';
  const el=document.getElementById('bcm-comment');
  if(el) el.value=bcGenComment(kw,'',name);
}

function bcSaveQueued(siteId){
  const s=_bcSites.find(x=>x.id===siteId);
  const el=document.getElementById('bcm-comment');
  if(s&&el){ s.queued=el.value; bcSave(); bcLog(`Comment queued for ${s.label||s.url}`,'success'); bcRefresh(); }
  document.getElementById('bc-modal')&&document.getElementById('bc-modal').remove();
}

function bcMarkDoneAndClose(siteId){
  bcMarkDone(siteId);
  document.getElementById('bc-modal')&&document.getElementById('bc-modal').remove();
}

function bcImportBulk(){
  const raw=prompt('Paste URLs â€” one per line:');
  if(!raw) return;
  const urls=raw.split('\n').map(u=>u.trim()).filter(u=>/^https?:\/\//i.test(u));
  if(!urls.length){ alert('No valid URLs found.'); return; }
  urls.forEach(url=>{
    _bcSites.push({id:uid(),url,label:url,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''});
  });
  bcSave();
  bcLog(`Bulk imported ${urls.length} sites.`,'success');
  bcRefresh();
}

function bcExportLog(){
  const rows=[['Time','Type','Message'],..._bcLog.map(l=>[l.ts,l.type,l.msg])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='blog-commenter-log.csv';
  a.click();
}

function bcShowCfWorkerCode(){
  const code = `// Cloudflare Worker â€” Universal CORS Proxy
// Deploy at: https://dash.cloudflare.com â†’ Workers & Pages â†’ Create Worker
// Then set your worker URL as: https://your-worker.workers.dev/?url={URL}

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  const url = new URL(request.url);
  const targetUrl = url.searchParams.get('url');
  if (!targetUrl) {
    return new Response('Missing ?url= parameter', { status: 400 });
  }
  // Forward request to target
  const modifiedRequest = new Request(targetUrl, {
    method: request.method,
    headers: {
      'Content-Type': request.headers.get('Content-Type') || 'application/x-www-form-urlencoded',
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120',
      'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
      'Accept-Language': 'en-US,en;q=0.5',
    },
    body: ['POST','PUT','PATCH'].includes(request.method) ? request.body : undefined,
    redirect: 'follow',
  });
  try {
    const response = await fetch(modifiedRequest);
    const responseText = await response.text();
    return new Response(responseText, {
      status: response.status,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
        'Access-Control-Allow-Headers': '*',
        'Content-Type': response.headers.get('Content-Type') || 'text/html',
      },
    });
  } catch(e) {
    return new Response('Proxy error: ' + e.message, { status: 500, headers: {'Access-Control-Allow-Origin':'*'} });
  }
}`;

  const overlay=document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick=e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML=`<div class="modal-box" style="min-width:600px;max-width:800px">
    <div class="modal-title">â˜ Cloudflare Worker â€” CORS Proxy Code
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ• Close</button>
    </div>
    <div class="notice notice-info" style="margin-bottom:12px">
      <strong>Steps:</strong> 1. Go to <a href="https://dash.cloudflare.com" target="_blank" style="color:var(--accent)">dash.cloudflare.com</a>
      â†’ Workers & Pages â†’ Create Worker â†’ Paste code below â†’ Deploy.
      2. Copy your worker URL (e.g. <code>https://my-proxy.yourname.workers.dev</code>)
      3. Set Custom Proxy as: <code>https://my-proxy.yourname.workers.dev/?url={URL}</code>
    </div>
    <textarea style="width:100%;height:320px;font-family:var(--mono);font-size:10px;background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:12px;line-height:1.7" readonly>${esc(code)}</textarea>
    <div class="row mt8">
      <button class="btn btn-primary" onclick="navigator.clipboard.writeText(${JSON.stringify(code)});bcTermLog('Cloudflare Worker code copied!','success')">ğŸ“‹ Copy Code</button>
      <a href="https://dash.cloudflare.com" target="_blank" class="btn btn-ghost">Open Cloudflare Dashboard â†’</a>
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARASITE FINDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pfResults = [];
let _pfLiveResults = [];
let _pfRunning = false;
let _pfAbort = false;
let _pfActiveFilters = { type:'all', da:'all', comment:'all', keyword:'' };

const PF_NICHES = {
  'Health & Fitness': ['health tips','fitness blog','workout guide','weight loss','nutrition advice','diet plan','supplement review','mental health','yoga','keto diet'],
  'Finance & Money': ['personal finance','make money online','investment tips','stock market','crypto','passive income','budgeting','forex trading','side hustle','debt free'],
  'Technology': ['tech review','software tutorial','AI tools','web development','cybersecurity','gadget review','SaaS','app review','cloud computing','programming'],
  'Marketing & SEO': ['digital marketing','SEO tips','content marketing','social media','email marketing','affiliate marketing','link building','PPC ads','blogging tips','growth hacking'],
  'Travel': ['travel blog','backpacking','budget travel','travel tips','hotel review','destination guide','adventure travel','solo travel','travel hacks','visa guide'],
  'Business': ['startup tips','entrepreneurship','small business','business strategy','e-commerce','dropshipping','leadership','productivity','remote work','branding'],
  'Education': ['online learning','study tips','college guide','courses review','scholarship','skill building','tutoring','certification','career advice','self improvement'],
  'Gaming': ['game review','gaming tips','esports','RPG guide','mobile gaming','PC gaming','game walkthrough','gaming setup','streaming tips','game news'],
  'Food & Recipes': ['food blog','recipe guide','cooking tips','vegan recipes','keto recipes','meal prep','restaurant review','baking','nutrition','food photography'],
  'Real Estate': ['real estate tips','property investment','home buying','rental income','mortgage guide','house flipping','REITs','landlord tips','property management','real estate SEO'],
  'Celebrity & Gossip': ['celebrity news','celebrity gossip','celebrity net worth','celebrity scandal','red carpet','celebrity diet','celebrity workout','paparazzi','celebrity dating'],
  'Entertainment': ['movie review','film review','TV show review','entertainment news','box office','streaming guide','Netflix review','award show','Hollywood news'],
  'Video & YouTube': ['YouTube tips','video marketing','YouTube SEO','video editing','content creator','vlog','YouTube growth','streaming tips','TikTok strategy'],
  'Sports': ['sports news','football tips','NBA news','sports betting','sports analysis','match prediction','fantasy sports','sports review','athlete training'],
  'Music': ['music review','album review','music blog','music news','artist interview','music production','indie music','hip hop news','concert review'],
  'Fashion & Beauty': ['fashion blog','beauty tips','skincare review','makeup tutorial','fashion news','style guide','luxury fashion','beauty influencer','cosmetics review'],
  'Crypto & NFT': ['crypto news','bitcoin guide','NFT review','DeFi','altcoin','crypto trading','blockchain','web3','metaverse','crypto investment'],
};


const PF_PARASITE_DOMAINS = [
  // TIER 1 Ultra High DA 90-99
  {domain:'reddit.com', da:98, type:'Forum/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Subreddits rank #1-3 for almost any keyword. Post in niche subreddits.'},
  {domain:'linkedin.com', da:99, type:'Article/Post', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'LinkedIn articles and posts rank extremely well. Free publishing.'},
  {domain:'sites.google.com', da:98, type:'Web Page', niche:'all', commentEnabled:false, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Google Sites pages index fast and rank well. Free hosting.'},
  {domain:'docs.google.com', da:98, type:'Document', niche:'all', commentEnabled:false, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Public Google Docs rank in Google. Enable public sharing.'},
  {domain:'groups.google.com', da:98, type:'Forum/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Google Groups threads indexed directly by Google. Ranks fast.'},
  {domain:'medium.com', da:95, type:'Article', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Strong ranking power for long-form content on any topic.'},
  {domain:'tumblr.com', da:96, type:'Blog Post', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Fast indexing, strong domain, any niche works well.'},
  {domain:'blogspot.com', da:97, type:'Blog Post', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Google-owned. Blogs rank very fast. Free and unlimited.'},
  {domain:'wordpress.com', da:95, type:'Blog Post', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Massive domain. Posts rank well especially with long-tail keywords.'},
  {domain:'quora.com', da:93, type:'Q&A/Answer', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Answer questions with your link. Ranks for question-based keywords.'},
  {domain:'issuu.com', da:94, type:'Document', niche:'all', commentEnabled:false, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'PDF/document publishing. Good for product guides and reviews.'},
  {domain:'slideshare.net', da:95, type:'Presentation', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Presentations rank well. Owned by LinkedIn.'},
  {domain:'scribd.com', da:93, type:'Document', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Document sharing, strong domain, any content type.'},
  {domain:'substack.com', da:91, type:'Newsletter', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Newsletters/articles rank well. Free plan available.'},
  {domain:'notion.site', da:90, type:'Wiki/Page', niche:'all', commentEnabled:false, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Notion public pages index and rank. Good for guides.'},
  {domain:'stackoverflow.com', da:95, type:'Forum/Q&A', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Top tech Q&A. Answers rank #1 for dev questions constantly.'},
  {domain:'stackexchange.com', da:92, type:'Forum/Q&A', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'200+ niche Q&A sites. Each one ranks well in its niche.'},
  {domain:'producthunt.com', da:90, type:'Community/Review', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Product launches rank in Google. Great for SaaS/tools.'},
  {domain:'dev.to', da:88, type:'Tech Blog/Community', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Dev articles rank FAST. One of the best for tech parasite SEO.'},
  {domain:'hashnode.com', da:85, type:'Tech Blog', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Developer blogs, custom domains, excellent SEO performance.'},
  {domain:'hackernoon.com', da:87, type:'Tech Article', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Tech/crypto/AI articles, strong rankings for tech queries.'},
  {domain:'indiehackers.com', da:82, type:'Forum/Community', niche:'business', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Very active community, posts rank for startup/business KWs.'},
  {domain:'community.hubspot.com', da:93, type:'Forum/Community', niche:'marketing', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Marketing community, posts rank for marketing keywords.'},
  {domain:'moz.com/community', da:91, type:'Forum/Community', niche:'marketing', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'SEO community. Q&A posts rank well for SEO queries.'},
  {domain:'blackhatworld.com', da:85, type:'Forum', niche:'marketing', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'SEO/marketing forum. Large active community.'},
  {domain:'warriorforum.com', da:84, type:'Forum', niche:'marketing', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Internet marketing forum. Old but still ranks.'},
  {domain:'sitepoint.com', da:88, type:'Forum/Article', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Web dev community. Articles and forum threads rank well.'},
  {domain:'bodybuilding.com', da:87, type:'Forum/Article', niche:'health', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Massive fitness forum. Posts rank for supplement/workout KWs.'},
  {domain:'tapatalk.com', da:78, type:'Forum/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Hosts thousands of forums. Find niche forums and post there.'},
  {domain:'forumotion.com', da:72, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Free forum hosting. Many niche forums rank #1-5. Create your own!'},
  {domain:'proboards.com', da:75, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Popular forum hosting. Established niche forums rank well.'},
  {domain:'ning.com', da:88, type:'Community/Network', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Social network builder. Niche networks rank for community queries.'},
  {domain:'xenforo.com/community', da:82, type:'Forum/Community', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'XenForo support. Very active, ranks for forum software queries.'},
  {domain:'fandom.com', da:91, type:'Wiki/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'The biggest fan wiki platform. Any franchise/celebrity has a wiki.'},
  {domain:'wikia.fandom.com', da:91, type:'Wiki/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Fandom wikis rank #1-3 for character/show/celeb searches.'},
  {domain:'imdb.com', da:96, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Movie/TV database. User reviews rank very well.'},
  {domain:'letterboxd.com', da:87, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Film review platform. Reviews rank well for specific films.'},
  {domain:'rottentomatoes.com', da:93, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Movie reviews rank immediately for film-related searches.'},
  {domain:'metacritic.com', da:91, type:'Review/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Game/movie review aggregator with user review section.'},
  {domain:'genius.com', da:92, type:'Community/Wiki', niche:'music', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Lyrics/music. Artist pages rank extremely well for music queries.'},
  {domain:'last.fm', da:88, type:'Music/Community', niche:'music', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Music community, artist pages rank for music discovery.'},
  {domain:'rateyourmusic.com', da:78, type:'Community/Review', niche:'music', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Music rating community. Reviews rank for album/artist queries.'},
  {domain:'fanpop.com', da:79, type:'Fan Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Fan communities for celebs/shows. Club pages rank for fan searches.'},
  {domain:'twitch.tv', da:95, type:'Video/Community', niche:'video', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Streamer pages and clips rank for gaming/video queries.'},
  {domain:'dailymotion.com', da:92, type:'Video Platform', niche:'video', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Video hosting, video pages rank as YouTube alternatives.'},
  {domain:'vimeo.com', da:94, type:'Video Platform', niche:'video', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Video pages rank well, especially for professional/niche content.'},
  {domain:'tmz.com', da:90, type:'News/Blog', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Celebrity news ranks fast for celeb name + news searches.'},
  {domain:'eonline.com', da:88, type:'News/Article', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Celebrity/entertainment news. Ranks for celeb searches.'},
  {domain:'people.com', da:92, type:'News/Article', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'People magazine. Celebrity content ranks consistently.'},
  {domain:'dailymail.co.uk', da:95, type:'News/Blog', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Massive reach. Comments on articles rank for celeb + news KWs.'},
  {domain:'justjared.com', da:78, type:'Blog/News', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Celebrity photo blog. Ranks well for celeb sightings.'},
  {domain:'perezhilton.com', da:74, type:'Blog', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Celebrity gossip blog. Ranks for entertainment queries.'},
  {domain:'hollywoodlife.com', da:75, type:'Blog/News', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Celebrity news. Ranks for celeb name + relationship searches.'},
  {domain:'wetpaint.com', da:62, type:'Community/Wiki', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Entertainment wiki community. Ranks for TV/celeb queries.'},
  {domain:'buzzfeed.com', da:95, type:'Article/List', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Viral content platform. BuzzFeed Community posts rank well.'},
  {domain:'knowyourmeme.com', da:87, type:'Community/Wiki', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Meme/culture wiki, ranks for viral/entertainment queries.'},
  {domain:'cosmopolitan.com', da:90, type:'Article/Community', niche:'fashion', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Fashion/celeb content ranks extremely well.'},
  {domain:'vogue.com', da:91, type:'Article', niche:'fashion', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Fashion authority. Articles rank #1-3 for fashion searches.'},
  {domain:'allure.com', da:87, type:'Article/Community', niche:'fashion', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Beauty/fashion articles rank for product + beauty queries.'},
  {domain:'g2.com', da:90, type:'Review/Community', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Software reviews rank #1-3 for "[software] review" searches.'},
  {domain:'capterra.com', da:88, type:'Review/Community', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Business software reviews, rank for software comparison KWs.'},
  {domain:'glassdoor.com', da:91, type:'Review/Community', niche:'business', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Company reviews rank #1 for "[company] reviews" searches.'},
  {domain:'tripadvisor.com', da:93, type:'Review/Community', niche:'travel', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Reviews rank #1 for restaurant/hotel/destination searches.'},
  {domain:'yelp.com', da:94, type:'Review/Community', niche:'food', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Local business reviews rank extremely well for local searches.'},
  {domain:'allrecipes.com', da:90, type:'Recipe/Community', niche:'food', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Recipes rank #1-3. User recipes also rank. Very high traffic.'},
  {domain:'gamespot.com', da:90, type:'Review/Forum', niche:'gaming', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Game reviews and forums rank well for gaming queries.'},
  {domain:'ign.com', da:92, type:'Review/Forum', niche:'gaming', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Top gaming site. Reviews and forums rank for game searches.'},
  {domain:'gamefaqs.gamespot.com', da:90, type:'Forum/Guide', niche:'gaming', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Game guides and forums rank #1 for game-specific queries.'},
  {domain:'steampowered.com', da:93, type:'Community/Review', niche:'gaming', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜…', note:'Steam reviews rank for game name searches constantly.'},
  {domain:'hubpages.com', da:87, type:'Article/Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Very underused. Long-tail article pages rank consistently.'},
  {domain:'vocal.media', da:81, type:'Article/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Underrated platform. Stories rank well for info queries.'},
  {domain:'wattpad.com', da:92, type:'Story/Creative', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Fiction/story platform. Good for entertainment/celeb fanfic niche.'},
  {domain:'fanfiction.net', da:88, type:'Community/Forum', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Massive fanfiction community. Celebrity/entertainment niche.'},
  {domain:'instructables.com', da:88, type:'How-To/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'How-to community. Step-by-step guides rank for DIY queries.'},
  {domain:'patch.com', da:86, type:'Local News/Blog', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Local news sites. Community posts rank for local searches.'},
  {domain:'myfitnesspal.com', da:88, type:'Community/App', niche:'health', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Fitness community, food diary threads rank for diet queries.'},
  {domain:'dzone.com', da:82, type:'Community/Article', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜…â˜†', note:'Developer community. Articles rank for coding/dev queries.'},
  {domain:'flipboard.com', da:91, type:'Article/Curation', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Magazine-style sharing. Topics and stories rank for news queries.'},
  {domain:'scoop.it', da:84, type:'Content Curation', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Curated topic pages. Good for topical authority building.'},
  {domain:'diigo.com', da:79, type:'Bookmarking/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Social bookmarking. Shared pages rank for researched topics.'},
  {domain:'theodysseyonline.com', da:61, type:'Community/Article', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Community-written articles. Low competition, ranks for long-tail KWs.'},
  {domain:'beforeitsnews.com', da:55, type:'Community News', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Community news. Articles rank for alternative/niche queries.'},
  {domain:'freeforums.org', da:55, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Free forum hosting. Good for creating targeted niche parasite forums.'},
  {domain:'boardhost.com', da:50, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Simple forum hosting. Niche forums rank for topic discussions.'},
  {domain:'createaforum.com', da:45, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Free forum creation. Custom niche forums rank for specific queries.'},
  {domain:'yuku.com', da:55, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Forum hosting. Niche forums rank for specific topic queries.'},
  {domain:'studybreaks.com', da:52, type:'Article/Community', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'College/entertainment blog. Low DA = low competition, easy to rank.'},
  {domain:'boardnation.com', da:40, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜†â˜†â˜†', note:'Very low DA, untapped. Long-tail forum threads with zero competition.'},
  {domain:'niceboard.com', da:38, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜†â˜†â˜†', note:'Low DA forum tool. Untapped for very specific long-tail keywords.'},
  {domain:'gather.com', da:45, type:'Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜†â˜†â˜†', note:'Low DA community. Very low competition for long-tail content.'},
  {domain:'listal.com', da:67, type:'Community/List', niche:'entertainment', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Movie/music list community. Lists rank for curated content queries.'},
  {domain:'celebmafia.com', da:65, type:'Blog', niche:'celebrity', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Celebrity photo site. Ranks for red carpet/event searches.'},
  {domain:'podomatic.com', da:70, type:'Podcast/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Podcast platform. Episode pages rank for topic + podcast searches.'},
  {domain:'anchor.fm', da:81, type:'Podcast/Community', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Spotify Anchor podcasts. Episode pages rank for niche topics.'},
  {domain:'rebelmouse.com', da:68, type:'Community/Blog', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Content platform, low competition, pages rank for specific queries.'},
  {domain:'paper.li', da:67, type:'Content Curation', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜†â˜†â˜†', note:'Curated news pages rank for niche keyword combinations.'},
  {domain:'manta.com', da:68, type:'Business Directory', niche:'business', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Business directory with blog. Low competition parasite opportunities.'},
  {domain:'weheartit.com', da:80, type:'Visual/Community', niche:'fashion', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Visual content platform. Collections rank for fashion/beauty KWs.'},
  {domain:'phpbb.com', da:78, type:'Forum', niche:'technology', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'phpBB community. Ranks for forum/community tech queries.'},
  {domain:'forumcommunity.net', da:60, type:'Forum', niche:'all', commentEnabled:true, rankPower:'â˜…â˜…â˜…â˜†â˜†', note:'Forum platform. Individual forum pages rank for niche queries.'},
];

// â”€â”€ LIVE SEARCH QUERY BUILDER FOR PARASITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pfBuildQueries(keyword, niche, platformType, recency){
  const kw = keyword.trim() || (niche !== 'all' ? (PF_NICHES[niche]||[])[0] || niche : 'review');
  const queries = [];
  const platformQueries = {
    all: [`"${kw}" site:google.com`,`"${kw}" site:bing.com`,`"${kw}" site:medium.com`,`"${kw}" site:quora.com`,`"${kw}" site:wordpress.com`,`"${kw}" (site:google.com OR site:bing.com OR site:medium.com)`,`"${kw}" forum community`,`"${kw}" inurl:forum`,`"${kw}" inurl:community`,`"${kw}" site:dev.to OR site:hubpages.com`],
    forum: [`"${kw}" site:google.com`,`"${kw}" site:bing.com`,`"${kw}" inurl:forum`,`"${kw}" inurl:thread`,`"${kw}" forum discussion`,`"${kw}" site:tapatalk.com`,`"${kw}" site:proboards.com OR site:forumotion.com`,`"${kw}" site:stackexchange.com`],
    community: [`"${kw}" community site:google.com`,`"${kw}" community site:bing.com`,`"${kw}" site:groups.google.com`,`"${kw}" site:ning.com`,`"${kw}" community inurl:community`,`"${kw}" site:indiehackers.com OR site:producthunt.com`],
    article: [`"${kw}" site:medium.com`,`"${kw}" site:hubpages.com`,`"${kw}" site:vocal.media`,`"${kw}" site:substack.com`,`"${kw}" site:dev.to`],
    wiki: [`"${kw}" site:fandom.com`,`"${kw}" site:wikia.com`,`"${kw}" site:sites.google.com`,`"${kw}" wiki`,`"${kw}" site:notion.site`],
    entertainment: [`"${kw}" site:imdb.com`,`"${kw}" site:rottentomatoes.com`,`"${kw}" site:fandom.com`,`"${kw}" site:fanpop.com`,`"${kw}" site:buzzfeed.com`,`"${kw}" site:tmz.com OR site:eonline.com`],
    celebrity: [`"${kw}" site:tmz.com`,`"${kw}" site:people.com`,`"${kw}" site:eonline.com`,`"${kw}" site:dailymail.co.uk`,`"${kw}" site:google.com`,`"${kw}" site:bing.com`,`"${kw}" celebrity gossip news`],
    video: [`"${kw}" site:vimeo.com`,`"${kw}" site:dailymotion.com`,`"${kw}" site:twitch.tv`,`"${kw}" video channel creator`,`"${kw}" site:medium.com youtube`],
  };
  const chosen = platformQueries[platformType] || platformQueries.all;
  const recencyMap = {'24h':'after:'+new Date(Date.now()-86400000).toISOString().slice(0,10),'48h':'after:'+new Date(Date.now()-172800000).toISOString().slice(0,10),'7d':'after:'+new Date(Date.now()-604800000).toISOString().slice(0,10),'30d':'after:'+new Date(Date.now()-2592000000).toISOString().slice(0,10),'any':''};
  const dateStr = recencyMap[recency]||'';
  chosen.forEach(q => queries.push({ query: q+(dateStr?' '+dateStr:''), raw: q }));
  return queries;
}

function pfAnalyzeUrl(url, keyword){
  let hostname='';
  try { hostname=new URL(url).hostname.replace('www.',''); } catch(e){ return null; }
  const match = PF_PARASITE_DOMAINS.find(p=>{ const d=p.domain.split('/')[0]; return hostname.includes(d)||url.includes(p.domain); });
  if(match) return {...match, liveUrl:url, keyword, live:true, name:match.domain};
  let da=35, type='Blog/Article', commentEnabled=false, rankPower='â˜…â˜…â˜†â˜†â˜†', note='Found for "'+keyword+'"';
  if(url.includes('forum')||url.includes('thread')||url.includes('discussion')){ type='Forum'; commentEnabled=true; rankPower='â˜…â˜…â˜…â˜†â˜†'; note='Forum thread â€” post a reply with your link'; }
  else if(url.includes('community')||url.includes('members')){ type='Community'; commentEnabled=true; rankPower='â˜…â˜…â˜…â˜†â˜†'; }
  else if(url.includes('/blog')||url.includes('/article')||url.includes('/post')){ type='Blog Post'; commentEnabled=true; rankPower='â˜…â˜…â˜…â˜†â˜†'; note='Blog post with potential comment section'; }
  else if(url.includes('wiki')||url.includes('fandom')){ type='Wiki'; commentEnabled=true; rankPower='â˜…â˜…â˜…â˜…â˜†'; da=65; }
  return {domain:hostname, da, type, niche:'all', commentEnabled, rankPower, note, liveUrl:url, keyword, live:true, name:hostname};
}

async function pfLiveSearch(){
  if(_pfRunning) return;
  const keyword=(document.getElementById('pf-keyword')||{value:''}).value.trim();
  const niche=(document.getElementById('pf-niche')||{value:'all'}).value;
  const platformType=(document.getElementById('pf-platform-type')||{value:'all'}).value;
  const recency=(document.getElementById('pf-recency')||{value:'any'}).value;
  const engine=(document.getElementById('pf-engine')||{value:'google'}).value;
  if(!keyword && niche==='all'){ alert('Enter a keyword or select a niche first.'); return; }
  _pfRunning=true; _pfAbort=false; _pfLiveResults=[];
  const btn=document.getElementById('pf-search-btn');
  const stopBtn=document.getElementById('pf-stop-btn');
  const wrap=document.getElementById('pf-results-wrap');
  if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Searching...'; }
  if(stopBtn) stopBtn.style.display='';
  wrap.innerHTML=`<div class="card" style="margin-bottom:12px"><div class="card-title">âš¡ Live Parasite Search Terminal</div><div id="pf-terminal" style="background:#0d1117;border:1px solid #30363d;padding:14px;font-family:var(--mono);font-size:11px;height:180px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9"><div style="color:#58a6ff">ğŸ¦  Searching: <b>${esc(keyword||niche)}</b></div></div></div><div id="pf-live-table-wrap"></div>`;
  function pfLog(msg,color='#c9d1d9'){ const term=document.getElementById('pf-terminal'); if(!term) return; const d=document.createElement('div'); d.innerHTML=`<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`; term.appendChild(d); term.scrollTop=term.scrollHeight; }
  const queries=pfBuildQueries(keyword,niche,platformType,recency);
  pfLog(`ğŸ“‹ ${queries.length} queries built`,'#58a6ff');
  const urlsSeen=new Set();
  // Phase 1: SearXNG (best source)
  pfLog(`ğŸ” Phase 1: SearXNG public instances...`,'#58a6ff');
  let pfPhase1Success = false;
  outerPf:
  for(const instance of CS_SEARXNG_INSTANCES){
    if(_pfAbort) break;
    for(let qi=0;qi<Math.min(queries.length,3);qi++){
      if(_pfAbort) break outerPf;
      const {query}=queries[qi];
      pfLog(`   â†’ [${instance.replace('https://','').split('/')[0]}] ${query.slice(0,60)}...`,'#484f58');
      const urls=await csSearxngSearch(query,instance,recency);
      if(urls&&urls.length>0){
        let n=0;
        for(const url of urls){
          if(urlsSeen.has(url)) continue; urlsSeen.add(url);
          const site=pfAnalyzeUrl(url,keyword||niche);
          if(!site||!pfPassesFilter(site)) continue;
          _pfLiveResults.push(site); n++;
        }
        pfLog(`   âœ… ${urls.length} results â†’ +${n} sites (${_pfLiveResults.length} total)`,'#3fb950');
        pfPhase1Success=true;
        pfUpdateTable();
        await new Promise(r=>setTimeout(r,300));
        if(_pfLiveResults.length>=50) break outerPf;
      } else { pfLog(`   âœ— Offline, trying next...`,'#f85149'); break; }
    }
    if(_pfLiveResults.length>=50) break;
  }

  // Phase 2: Proxy-based fallback
  if(!_pfAbort && _pfLiveResults.length<20){
    pfLog(`ğŸ” Phase 2: Proxy scraping ${engine.toUpperCase()} + DDG...`,'#d29922');
    for(let qi=0;qi<queries.length;qi++){
      if(_pfAbort) break;
      const {query}=queries[qi];
      pfLog(`ğŸ” [${qi+1}/${queries.length}] ${query.slice(0,70)}`,'#d29922');
      try {
        // Try DDG first
        let urls=await csDuckDuckGoSearch(query);
        if(!urls||urls.length===0){
          const r=await bcProxyFetch(csBuildSearchUrl(engine,query,recency),{timeout:18000});
          if(r.ok&&r.text.length>500) urls=csExtractUrlsFromHtml(r.text,engine);
        }
        if(urls&&urls.length>0){
          pfLog(`   âœ“ ${urls.length} URLs`,'#3fb950');
          let n=0;
          for(const url of urls){
            if(urlsSeen.has(url)) continue; urlsSeen.add(url);
            const site=pfAnalyzeUrl(url,keyword||niche);
            if(!site||!pfPassesFilter(site)) continue;
            _pfLiveResults.push(site); n++;
          }
          pfLog(`   â†’ +${n} new (${_pfLiveResults.length} total)`,'#3fb950');
          pfUpdateTable();
        } else { pfLog(`   âš  No results from proxy`,'#d29922'); }
      } catch(e){ pfLog(`   âœ— ${e.message}`,'#f85149'); }
      if(qi<queries.length-1&&!_pfAbort) await new Promise(r=>setTimeout(r,700));
    }
  }

  if(_pfLiveResults.length===0){
    pfLog('âš  Live search blocked. Loading built-in database + showing manual links.','#d29922');
    pfLoadDatabase(keyword||niche,niche);
    if(!_bcRunning) pfShowManualSearchModal(queries,engine,recency,keyword||niche);
    else pfPendingManualSearchData={queries,engine,recency,keyword:keyword||niche};
  } else { pfLog(`âœ… Done â€” ${_pfLiveResults.length} parasite opportunities!`,'#3fb950'); _pfResults=_pfLiveResults; }
  _pfRunning=false;
  if(btn){ btn.disabled=false; btn.innerHTML='ğŸ¦  Search Parasites'; }
  if(stopBtn) stopBtn.style.display='none';
}

function pfPassesFilter(site){
  const f=_pfActiveFilters;
  if(f.da!=='all'){ const [min,max]=f.da.split('-').map(Number); if(site.da<min||(max&&site.da>max)) return false; }
  if(f.type!=='all'){ const typeMap={forum:['Forum','Community','Q&A'],article:['Article','Blog','Newsletter'],review:['Review'],wiki:['Wiki'],video:['Video'],celebrity:['celebrity','entertainment']}; const allowed=typeMap[f.type]||[]; const st=(site.type||'').toLowerCase(); if(!allowed.some(t=>st.includes(t.toLowerCase()))) return false; }
  if(f.comment==='yes'&&!site.commentEnabled) return false;
  if(f.keyword){ const kl=f.keyword.toLowerCase(); if(!(site.domain||'').toLowerCase().includes(kl)&&!(site.type||'').toLowerCase().includes(kl)&&!(site.name||'').toLowerCase().includes(kl)) return false; }
  return true;
}

function pfLoadDatabase(keyword,niche){
  let results=PF_PARASITE_DOMAINS;
  if(niche&&niche!=='all'){ const nicheL=niche.toLowerCase(); results=PF_PARASITE_DOMAINS.filter(p=>p.niche==='all'||p.niche.toLowerCase().includes(nicheL)||nicheL.includes(p.niche.toLowerCase())); if(results.length<10) results=PF_PARASITE_DOMAINS; }
  _pfLiveResults=results.map(r=>({...r,keyword:keyword||'',live:false}));
  _pfResults=_pfLiveResults;
  pfUpdateTable();
}

function pfUpdateTable(){
  const wrap=document.getElementById('pf-live-table-wrap'); if(!wrap) return;
  const results=_pfLiveResults.filter(pfPassesFilter).sort((a,b)=>(b.rankPower||'').length-(a.rankPower||'').length||(b.da||0)-(a.da||0));
  wrap.innerHTML=`
  <div class="flex g8" style="margin-bottom:10px;flex-wrap:wrap">
    <div class="stat g" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px">${results.length}</div><div class="stat-l">Total Found</div></div>
    <div class="stat b" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px;color:var(--accent)">${results.filter(r=>(r.rankPower||'').includes('â˜…â˜…â˜…â˜…â˜…')).length}</div><div class="stat-l">â˜…â˜…â˜…â˜…â˜… Power</div></div>
    <div class="stat y" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px;color:var(--accent3)">${results.filter(r=>r.commentEnabled).length}</div><div class="stat-l">Comment-Enabled</div></div>
    <div class="stat p" style="padding:10px 14px;flex:1;min-width:80px"><div class="stat-v" style="font-size:20px;color:var(--accent5)">${results.filter(r=>r.live).length}</div><div class="stat-l">Live Results</div></div>
    <div style="flex:0;display:flex;flex-direction:column;gap:4px;justify-content:center">
      <button class="btn btn-primary btn-sm" onclick="pfPushAllToCommenter()">â• Push to Commenter</button>
      <button class="btn btn-ghost btn-sm" onclick="pfExportCSV()">ğŸ“¤ Export CSV</button>
    </div>
  </div>
  <div class="card" style="padding:12px;margin-bottom:10px">
    <div class="flex aic g8" style="flex-wrap:wrap">
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-weight:700">FILTER:</span>
      <select id="pf-filter-type" style="width:140px" onchange="pfApplyFilter()"><option value="all">All Types</option><option value="forum">Forums</option><option value="article">Articles/Blogs</option><option value="review">Review Sites</option><option value="wiki">Wikis</option><option value="video">Video Platforms</option><option value="celebrity">Celebrity/Entmt</option></select>
      <select id="pf-filter-da" style="width:150px" onchange="pfApplyFilter()"><option value="all">Any DA (20-99)</option><option value="20-50">DA 20-50 (Untapped)</option><option value="50-70">DA 50-70 (Mid)</option><option value="70-85">DA 70-85 (Good)</option><option value="85-99">DA 85+ (Authority)</option></select>
      <select id="pf-filter-comment" style="width:150px" onchange="pfApplyFilter()"><option value="all">All Sites</option><option value="yes">Comment-Enabled Only</option></select>
      <input type="text" id="pf-filter-kw" placeholder="Filter by name/type..." style="flex:1;min-width:130px" oninput="pfApplyFilter()"/>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">${results.length} sites</span>
    </div>
  </div>
  <div class="card"><div class="card-title">ğŸ¦  Parasite Opportunities â€” Ranked by Power</div><div class="tw"><table><thead><tr><th>#</th><th>Platform / Domain</th><th>Type</th><th>DA</th><th>Rank Power</th><th>Comments</th><th>Live URL</th><th>Actions</th></tr></thead><tbody id="pf-table-body">${results.map((r,i)=>pfRowHtml(r,i)).join('')}</tbody></table></div></div>`;
}

function pfRowHtml(r,i){
  const domain=r.domain||r.name||'';
  const baseUrl=r.liveUrl||`https://${domain.split('/')[0]}`;
  const daClass=r.da>=85?'badge-g':r.da>=65?'badge-y':r.da>=45?'badge-b':'badge-r';
  return `<tr><td class="mono xs tm">${i+1}</td><td><a href="${esc(baseUrl)}" target="_blank" style="color:var(--accent);font-family:var(--mono);font-size:11px;font-weight:700;text-decoration:none">${esc(domain)}</a>${r.live?'<span class="badge badge-p" style="margin-left:4px;font-size:8px">LIVE</span>':''}<div style="font-size:9px;color:var(--muted2);font-family:var(--mono);max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px">${esc(r.note||r.whyGood||'')}</div></td><td><span class="mono xs" style="white-space:nowrap">${esc(r.type||'Blog')}</span></td><td><span class="badge ${daClass}">${r.da}</span></td><td style="font-family:var(--mono);font-size:13px;letter-spacing:-1px;white-space:nowrap">${esc(r.rankPower||'â˜…â˜…â˜…â˜†â˜†')}</td><td>${r.commentEnabled?'<span class="badge badge-g">âœ“ Yes</span>':'<span class="badge" style="border-color:var(--border2);color:var(--muted2)">No</span>'}</td><td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.liveUrl?`<a href="${esc(r.liveUrl)}" target="_blank" style="font-family:var(--mono);font-size:9px;color:var(--accent4)">View â†’</a>`:'<span class="tm mono" style="font-size:9px">base</span>'}</td><td><div style="display:flex;gap:4px;flex-wrap:nowrap"><button class="btn btn-ghost btn-xs" onclick="window.open('${esc(baseUrl)}','_blank')">Open</button>${r.commentEnabled?`<button class="btn btn-primary btn-xs" onclick="pfAddToCommenterSite(${i})">+Queue</button>`:''}<button class="btn btn-yellow btn-xs" onclick="navigator.clipboard&&navigator.clipboard.writeText('${esc(baseUrl)}')">Copy</button></div></td></tr>`;
}

function pfApplyFilter(){
  _pfActiveFilters={type:(document.getElementById('pf-filter-type')||{value:'all'}).value,da:(document.getElementById('pf-filter-da')||{value:'all'}).value,comment:(document.getElementById('pf-filter-comment')||{value:'all'}).value,keyword:((document.getElementById('pf-filter-kw')||{value:''}).value||'').toLowerCase()};
  const tbody=document.getElementById('pf-table-body'); if(!tbody) return;
  const filtered=_pfLiveResults.filter(pfPassesFilter).sort((a,b)=>(b.rankPower||'').length-(a.rankPower||'').length||(b.da||0)-(a.da||0));
  tbody.innerHTML=filtered.map((r,i)=>pfRowHtml(r,i)).join('');
}

function pfAddToCommenterSite(idx){
  const filtered=_pfLiveResults.filter(pfPassesFilter).sort((a,b)=>(b.rankPower||'').length-(a.rankPower||'').length||(b.da||0)-(a.da||0));
  const r=filtered[idx]; if(!r) return;
  const url=r.liveUrl||`https://${(r.domain||'').split('/')[0]}`;
  if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label:r.domain||r.name||url,type:'generic',name:'',email:'',website:'',notes:r.note||'',done:false,queued:''}); bcSave(); }
  const btn=event.target; btn.innerHTML='âœ“'; btn.classList.remove('btn-primary'); btn.classList.add('btn-ghost'); btn.disabled=true;
}

function pfShowAutoPosterFromFinder(){
  if(!_pfResults||!_pfResults.length){ alert('Run a parasite search first.'); return; }
  const fakeSites = _pfResults.filter(r=>r.commentEnabled||r.liveUrl).map(r => ({
    url: r.liveUrl||`https://${(r.domain||'').split('/')[0]}`, label: r.domain||r.name||'', status:'success', comment:`Check out this parasite opportunity: ${r.domain||r.name||''}`
  }));
  if(!fakeSites.length){ alert('No comment-enabled sites to push.'); return; }
  bcShowAutoPosterSetup(fakeSites);
}

function pfPushAllToCommenter(){
  if(!_pfResults.length){ alert('Run a search first.'); return; }
  let added=0;
  _pfResults.filter(r=>r.commentEnabled).forEach(r=>{ const url=r.liveUrl||`https://${(r.domain||'').split('/')[0]}`; if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label:r.domain||r.name||url,type:'generic',name:'',email:'',website:'',notes:r.note||'',done:false,queued:''}); added++; } });
  bcSave(); alert(`âœ“ Added ${added} comment-enabled parasite sites to Blog Commenter!`);
}

function pfPushToCommenter(){ pfPushAllToCommenter(); }

function pfExportCSV(){
  const data=_pfResults.length?_pfResults:PF_PARASITE_DOMAINS;
  const rows=[['Domain','DA','Type','Rank Power','Comments','Niche','Live URL','Notes'],...data.map(r=>[r.domain||r.name||'',r.da,r.type,r.rankPower||'',r.commentEnabled?'Yes':'No',r.niche||'',r.liveUrl||`https://${(r.domain||'').split('/')[0]}`,r.note||r.whyGood||''])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='parasite-sites-'+Date.now()+'.csv'; a.click();
}

function pfStopSearch(){ _pfAbort=true; _pfRunning=false; _pfResults=_pfLiveResults; const btn=document.getElementById('pf-search-btn'); const stopBtn=document.getElementById('pf-stop-btn'); if(btn){ btn.disabled=false; btn.innerHTML='ğŸ¦  Search Parasites'; } if(stopBtn) stopBtn.style.display='none'; }

function pfShowManualSearchModal(queries,engine,recency,keyword){
  // If blog commenter is actively running, defer the popup â€” show inline below results instead
  if(_bcRunning){
    pfPendingManualSearchData = {queries, engine, recency, keyword};
    console.log('[pfShowManualSearchModal] Commenter running â€” deferring popup');
    return;
  }
  pfRenderManualSearchPopup(queries,engine,recency,keyword);
}

let pfPendingManualSearchData = null;

function pfRenderManualSearchPopup(queries,engine,recency,keyword){
  const overlay=document.createElement('div'); overlay.className='modal-overlay'; overlay.onclick=e=>{if(e.target===overlay) overlay.remove();};
  const linksHtml = queries.map((q,i)=>{const url=csBuildSearchUrl(engine,q.query,recency);return `<div style="padding:9px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px"><span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px;flex-shrink:0">${i+1}</span><div style="flex:1;min-width:0;font-family:var(--mono);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.query)}</div><a href="${esc(url)}" target="_blank" class="btn btn-primary btn-xs">Search â†’</a></div>`;}).join('');
  overlay.innerHTML=`<div class="modal-box" style="min-width:560px;max-width:740px"><div class="modal-title">ğŸ”— Manual Parasite Search <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ•</button></div><div class="notice notice-info" style="margin-bottom:12px">CORS blocked direct fetch. Click each link to manually find parasite sites for <b>${esc(keyword)}</b>.</div><div style="max-height:420px;overflow-y:auto">${linksHtml}</div><div class="row mt8"><button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button></div></div>`;
  document.body.appendChild(overlay);
}
function pfScan(){ pfLiveSearch(); }
function pfAddToCommenter(domain){ const url=`https://${domain}`; if(!_bcSites.find(s=>s.url===url)){ _bcSites.push({id:uid(),url,label:domain,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''}); bcSave(); } alert(`âœ“ ${domain} added to Blog Commenter!`); }

function renderParasiteFinder(el){
  el.innerHTML=`
  <div class="page-title">ğŸ¦  Parasite Sites Finder â€” v3 Live Search</div>
  <div class="page-sub">// real-time search Â· forums, communities, wikis Â· celebrity, entertainment, video Â· DA 20-99 Â· untapped low-DA gems</div>
  <div class="card">
    <div class="card-title">ğŸ” Parasite Search</div>
    <div class="grid2" style="margin-bottom:12px">
      <div class="fg mb0"><label class="lbl">Keyword / Topic <span style="color:var(--accent2)">*</span></label>
        <input type="text" id="pf-keyword" placeholder="e.g. celebrity net worth, weight loss, crypto review..." style="font-size:13px;padding:10px 14px" onkeydown="if(event.key==='Enter') pfLiveSearch()" oninput="pfPreview()"/></div>
      <div class="fg mb0"><label class="lbl">Niche / Category</label>
        <select id="pf-niche" onchange="pfPreview()"><option value="all">All Niches</option>${Object.keys(PF_NICHES).map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('')}</select></div>
    </div>
    <div class="grid3">
      <div class="fg mb0"><label class="lbl">Platform Type</label>
        <select id="pf-platform-type" onchange="pfPreview()"><option value="all">All Platforms</option><option value="forum">Forums &amp; Communities</option><option value="community">Communities Only</option><option value="article">Articles &amp; Blogs</option><option value="wiki">Wikis &amp; Databases</option><option value="entertainment">Entertainment</option><option value="celebrity">Celebrity &amp; Gossip</option><option value="video">Video Platforms</option></select></div>
      <div class="fg mb0"><label class="lbl">Search Engine</label>
        <select id="pf-engine"><option value="google">Google</option><option value="bing">Bing</option><option value="duckduckgo">DuckDuckGo</option></select></div>
      <div class="fg mb0"><label class="lbl">Post Recency</label>
        <select id="pf-recency"><option value="any">Any time</option><option value="24h">Last 24 hours</option><option value="48h">Last 48 hours</option><option value="7d">Last 7 days</option><option value="30d">Last month</option></select></div>
    </div>
    <div id="pf-query-preview" style="margin-top:10px;padding:10px 12px;background:#0d1117;border:1px solid #30363d;border-radius:6px;font-family:var(--mono);font-size:10px;color:#58a6ff;display:none"><span style="color:#484f58">SAMPLE QUERY â†’ </span><span id="pf-query-text"></span></div>
    <div class="flex aic g8 mt8" style="flex-wrap:wrap">
      <button class="btn btn-primary" id="pf-search-btn" onclick="pfLiveSearch()" style="padding:10px 22px;font-size:11px">ğŸ¦  Search Parasites</button>
      <button class="btn btn-danger btn-sm" id="pf-stop-btn" onclick="pfStopSearch()" style="display:none">â¹ Stop</button>
      <button class="btn btn-ghost btn-sm" onclick="pfLoadDatabaseUI()">ğŸ“š Load All 80+ Known Parasites</button>
      <button class="btn btn-ghost btn-sm" onclick="pfExportCSV()">ğŸ“¤ Export CSV</button>
      <button class="btn btn-blue btn-sm" onclick="pfPushAllToCommenter()">â• Push to Commenter</button>
      <button class="btn btn-ghost btn-sm" onclick="pfShowAutoPosterFromFinder()" title="Auto-post to GitHub/Netlify/WordPress from parasite sites">ğŸ“¤ Auto Poster</button>
    </div>
  </div>
  <div id="pf-results-wrap">
    <div class="notice notice-info">ğŸ’¡ <strong>Enter a keyword</strong> (e.g. "celebrity net worth", "weight loss") + choose a platform type â†’ hit Search. The tool queries Google/Bing using parasite operators like <code>"keyword" site:reddit.com</code>, <code>"keyword" inurl:forum</code> to find which parasite platforms are already ranking.<br><br>Covers: forums, communities, wikis, celebrity sites, entertainment platforms, video, and low-DA untapped gems from DA 20 to 99.</div>
  </div>`;
  setTimeout(()=>{ const inp=document.getElementById('pf-keyword'); if(inp) inp.focus(); },100);
}

function pfPreview(){
  const kw=(document.getElementById('pf-keyword')||{value:''}).value.trim();
  const niche=(document.getElementById('pf-niche')||{value:'all'}).value;
  const platform=(document.getElementById('pf-platform-type')||{value:'all'}).value;
  const preview=document.getElementById('pf-query-preview');
  const previewText=document.getElementById('pf-query-text');
  if(!kw&&niche==='all'){ if(preview) preview.style.display='none'; return; }
  if(preview) preview.style.display='';
  const q=pfBuildQueries(kw||(PF_NICHES[niche]||[])[0]||niche,niche,platform,'any')[0];
  if(previewText&&q) previewText.textContent=q.query;
}

function pfLoadDatabaseUI(){
  pfLoadDatabase('','all');
  const wrap=document.getElementById('pf-results-wrap');
  if(!document.getElementById('pf-live-table-wrap')){ const div=document.createElement('div'); div.id='pf-live-table-wrap'; wrap.innerHTML=''; wrap.appendChild(div); }
  pfUpdateTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMENT SITES FINDER â€” v3 REAL-TIME SEARCH ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _csResults = [];
let _csRunning = false;
let _csLiveResults = []; // live search accumulation
let _csSearchAbort = false;
let _csActiveFilters = { type:'all', link:'all', da:'all', keyword:'' };

// â”€â”€ SEARCH QUERY BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Builds Google/Bing search queries using inurl:/intitle: operators to
// find real fresh pages with comment sections

function csBuildQueries(keyword, platform, recency){
  const kw = keyword.trim();
  const queries = [];

  // Platform-specific inurl patterns
  const platformPatterns = {
    wordpress: [
      `"${kw}" inurl:wp-content "leave a reply"`,
      `"${kw}" intitle:"${kw}" "add a comment" wordpress`,
      `"${kw}" site:wordpress.com "leave a comment"`,
      `"${kw}" inurl:/?p= "leave a reply"`,
    ],
    blogger: [
      `"${kw}" site:blogspot.com "post a comment"`,
      `"${kw}" site:blogspot.com "no comments" OR "leave a comment"`,
    ],
    generic: [
      `"${kw}" "leave a comment" -site:youtube.com -site:facebook.com`,
      `"${kw}" "post a comment" "name" "email" -site:reddit.com`,
      `"${kw}" "add a comment" inurl:blog`,
      `"${kw}" "comments (0)" OR "be the first to comment"`,
      `"${kw}" intitle:"comment" "name" "email" "website"`,
    ],
    forum: [
      `"${kw}" site:forums.* "reply"`,
      `"${kw}" inurl:forum "reply to this"`,
      `"${kw}" "forum" "post reply" -site:reddit.com`,
    ],
    blog: [
      `"${kw}" inurl:blog "leave a reply"`,
      `"${kw}" intitle:"blog" "leave a comment"`,
      `"${kw}" "posted in" "tags:" "leave a comment"`,
    ],
    news: [
      `"${kw}" "news" "leave a comment" -site:bbc.com -site:cnn.com`,
      `"${kw}" site:*.com/news "comment below"`,
    ],
    all: [
      `"${kw}" "leave a reply"`,
      `"${kw}" "leave a comment" blog`,
      `"${kw}" "post a comment" "name" "email"`,
      `"${kw}" "add a comment" -site:youtube.com`,
    ]
  };

  const chosen = platformPatterns[platform] || platformPatterns.all;

  // Add recency modifier
  const recencyMap = {
    '24h': 'after:' + new Date(Date.now()-86400000).toISOString().slice(0,10),
    '48h': 'after:' + new Date(Date.now()-172800000).toISOString().slice(0,10),
    '7d':  'after:' + new Date(Date.now()-604800000).toISOString().slice(0,10),
    '30d': 'after:' + new Date(Date.now()-2592000000).toISOString().slice(0,10),
    'any': ''
  };
  const dateStr = recencyMap[recency]||'';

  chosen.forEach(q => {
    queries.push({ query: q + (dateStr?' '+dateStr:''), raw: q });
  });

  return queries;
}

// â”€â”€ SEARCH ENGINE URL BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csBuildSearchUrl(engine, query, recency){
  const enc = encodeURIComponent(query);

  if(engine === 'google'){
    let url = `https://www.google.com/search?q=${enc}&num=30`;
    const tbsMap = { '24h':'qdr:d', '48h':'qdr:d2', '7d':'qdr:w', '30d':'qdr:m' };
    if(tbsMap[recency]) url += `&tbs=${tbsMap[recency]}`;
    return url;
  }

  if(engine === 'bing'){
    let url = `https://www.bing.com/search?q=${enc}&count=30`;
    const freshMap = { '24h':'day', '48h':'day', '7d':'week', '30d':'month' };
    if(freshMap[recency]) url += `&filters=ex1%3a"ez${freshMap[recency]}"`;
    return url;
  }

  if(engine === 'duckduckgo'){
    let url = `https://html.duckduckgo.com/html/?q=${enc}`;
    return url;
  }

  return `https://www.google.com/search?q=${enc}`;
}

// â”€â”€ EXTRACT URLS FROM SEARCH RESULT HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csExtractUrlsFromHtml(html, engine){
  const urls = new Set();
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  if(engine === 'google'){
    // Google result links are in <a> tags with href containing /url?q=
    doc.querySelectorAll('a[href]').forEach(a => {
      const href = a.getAttribute('href')||'';
      const m = href.match(/\/url\?q=(https?:\/\/[^&]+)/);
      if(m){
        try { urls.add(decodeURIComponent(m[1])); } catch(e){}
      }
      // Also direct links
      if(href.startsWith('http') && !href.includes('google.com')){
        urls.add(href);
      }
    });

    // Also scan for cite tags and data-href
    doc.querySelectorAll('cite, [data-href]').forEach(el => {
      const t = (el.textContent||el.getAttribute('data-href')||'').trim();
      if(t.startsWith('http')) urls.add(t);
      else if(t && !t.includes(' ')) urls.add('https://'+t);
    });
  }

  if(engine === 'bing'){
    doc.querySelectorAll('a[href], h2 a, li.b_algo a').forEach(a => {
      const href = a.getAttribute('href')||'';
      if(href.startsWith('http') && !href.includes('bing.com') && !href.includes('microsoft.com')){
        urls.add(href);
      }
    });
  }

  if(engine === 'duckduckgo'){
    doc.querySelectorAll('a.result__a, a[href*="//"]').forEach(a => {
      const href = a.getAttribute('href')||'';
      const m = href.match(/uddg=(https?:\/\/[^&]+)/);
      if(m){ try { urls.add(decodeURIComponent(m[1])); } catch(e){} }
      else if(href.startsWith('http') && !href.includes('duckduckgo.com')){
        urls.add(href);
      }
    });
  }

  // Filter to real URLs
  return [...urls].filter(u => {
    try {
      const uo = new URL(u);
      return uo.hostname.includes('.') &&
        !uo.hostname.includes('google') &&
        !uo.hostname.includes('bing.com') &&
        !uo.hostname.includes('duckduckgo') &&
        !uo.hostname.includes('yahoo.com') &&
        !uo.hostname.includes('facebook.com') &&
        !uo.hostname.includes('twitter.com') &&
        !uo.hostname.includes('instagram.com') &&
        !uo.hostname.includes('youtube.com') &&
        !uo.hostname.includes('amazon.com') &&
        !uo.hostname.includes('wikipedia.org') &&
        u.length < 300;
    } catch(e){ return false; }
  }).slice(0,20);
}

// â”€â”€ SMART SITE ANALYZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function csAnalyzeSite(url, keyword){
  let hostname = '';
  try { hostname = new URL(url).hostname; } catch(e){ return null; }

  // Guess DA from known domains
  const daMap = {
    'wordpress.com':95,'blogspot.com':97,'medium.com':95,'tumblr.com':96,
    'reddit.com':98,'quora.com':93,'stackoverflow.com':95,'github.com':96,
    'blogger.com':97,'typepad.com':80,'weebly.com':85,'wix.com':90,
    'squarespace.com':88,'substack.com':91,'ghost.io':72,'hashnode.dev':82,
    'dev.to':88,'hackernews':90,'forum':60,'community':65,'blog':50,
  };

  let da = 45; // base DA for unknown sites
  for(const [domain, score] of Object.entries(daMap)){
    if(hostname.includes(domain)){ da = score; break; }
  }

  // Guess type from URL
  let type = 'Blog';
  if(url.includes('/forum') || url.includes('/community') || url.includes('/discuss')) type = 'Forum';
  else if(url.includes('/blog') || hostname.includes('blog')) type = 'Blog';
  else if(url.includes('/news') || hostname.includes('news')) type = 'News';
  else if(hostname.includes('wordpress.com') || url.includes('wp-content')) type = 'WordPress Blog';
  else if(hostname.includes('blogspot.com')) type = 'Blogger';
  else if(hostname.includes('medium.com')) type = 'Medium Article';
  else if(hostname.includes('reddit.com')) type = 'Reddit Thread';
  else if(url.includes('/question') || url.includes('/ask') || hostname.includes('quora')) type = 'Q&A';

  // Guess dofollow
  const dofollow = hostname.includes('wordpress.com') || hostname.includes('dev.to') ||
    hostname.includes('hashnode') || hostname.includes('vocal.media') ||
    hostname.includes('instructables.com') || da < 60;

  return {
    url: url,
    name: hostname.replace('www.',''),
    type,
    da,
    dofollow,
    notes: `Found for "${keyword}" â€” verify comment section`,
    live: true,
    keyword
  };
}

// â”€â”€ SEARXNG + MULTI-ENGINE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CS_SEARXNG_INSTANCES = [
  'https://searx.be',
  'https://search.mdosch.de',
  'https://searxng.world',
  'https://searx.tiekoetter.com',
  'https://search.ononoki.org',
  'https://priv.au',
  'https://searx.prvcy.eu',
  'https://northboot.xyz',
  'https://paulgo.io',
  'https://searx.work',
  'https://etsi.me',
  'https://searx.fmac.xyz',
];

async function csSearxngSearch(query, instance, recency){
  const params = new URLSearchParams({ q: query, format: 'json', categories: 'general' });
  if(recency !== 'any'){
    const trMap = {'24h':'day','48h':'day','7d':'week','30d':'month'};
    if(trMap[recency]) params.set('time_range', trMap[recency]);
  }
  const url = `${instance}/search?${params}`;
  try {
    const resp = await Promise.race([
      fetch(url, { headers: { 'Accept': 'application/json' } }),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),10000))
    ]);
    if(!resp.ok) return null;
    const data = await resp.json();
    if(data && data.results && data.results.length > 0){
      return data.results.map(r => r.url).filter(Boolean);
    }
  } catch(e){}
  return null;
}

async function csDuckDuckGoSearch(query){
  const enc = encodeURIComponent(query);
  const url = `https://html.duckduckgo.com/html/?q=${enc}`;
  const result = await bcProxyFetch(url, { timeout: 14000 });
  if(result.ok && result.text.length > 1000){
    return csExtractUrlsFromHtml(result.text, 'duckduckgo');
  }
  return null;
}

async function csBraveSearch(query){
  const enc = encodeURIComponent(query);
  const url = `https://search.brave.com/search?q=${enc}&source=web`;
  const result = await bcProxyFetch(url, { timeout: 14000 });
  if(result.ok && result.text.length > 1000){
    const urls = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(result.text, 'text/html');
    doc.querySelectorAll('a[href]').forEach(a => {
      const href = a.href || a.getAttribute('href') || '';
      try {
        const u = new URL(href);
        if(u.hostname && !u.hostname.includes('brave.com')){ urls.push(href); }
      } catch(e){}
    });
    return urls.slice(0,30);
  }
  return null;
}

async function csGoogleBingSearch(query, engine, recency){
  const searchUrl = csBuildSearchUrl(engine, query, recency);
  const result = await bcProxyFetch(searchUrl, { timeout: 18000 });
  if(result.ok && result.text.length > 500){
    return { urls: csExtractUrlsFromHtml(result.text, engine), proxy: result.proxy };
  }
  return null;
}

// â”€â”€ MAIN LIVE SEARCH ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function csLiveSearch(){
  if(_csRunning){ return; }
  const keyword = (document.getElementById('cs-keyword')||{value:''}).value.trim();
  if(!keyword){ alert('Enter a keyword first â€” e.g. "weight loss", "wordpress tutorial"'); return; }

  const engine = (document.getElementById('cs-engine')||{value:'google'}).value;
  const platform = (document.getElementById('cs-platform')||{value:'all'}).value;
  const recency = (document.getElementById('cs-recency')||{value:'any'}).value;

  _csRunning = true;
  _csSearchAbort = false;
  _csLiveResults = [];

  const btn = document.getElementById('cs-search-btn');
  const stopBtn = document.getElementById('cs-stop-btn');
  const resultsWrap = document.getElementById('cs-results-wrap');

  if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Searching...'; }
  if(stopBtn) stopBtn.style.display = '';

  resultsWrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="card-title">âš¡ Live Search Terminal</div>
      <div id="cs-terminal" style="background:#0d1117;border:1px solid #30363d;padding:14px;font-family:var(--mono);font-size:11px;height:220px;overflow-y:auto;line-height:1.9;border-radius:8px;color:#c9d1d9">
        <div style="color:#58a6ff">ğŸš€ Starting live search for: <b>${esc(keyword)}</b></div>
      </div>
    </div>
    <div id="cs-live-table-wrap"></div>`;

  function csLog(msg, color='#c9d1d9'){
    const term = document.getElementById('cs-terminal');
    if(!term) return;
    const d = document.createElement('div');
    d.innerHTML = `<span style="color:#484f58;font-size:9px">${ts()}</span> <span style="color:${color}">${msg}</span>`;
    term.appendChild(d);
    term.scrollTop = term.scrollHeight;
  }

  const queries = csBuildQueries(keyword, platform, recency);
  csLog(`ğŸ“‹ ${queries.length} queries built | platform: ${platform} | engine: ${engine}`, '#58a6ff');
  csLog(`ğŸ” Trying: SearXNG instances â†’ DuckDuckGo â†’ ${engine} â†’ Brave â†’ DB fallback`, '#484f58');

  const urlsSeen = new Set();

  function ingestUrls(urls){
    if(!urls || !urls.length) return 0;
    let added = 0;
    for(const url of urls){
      if(_csSearchAbort) break;
      if(urlsSeen.has(url)) continue;
      urlsSeen.add(url);
      const site = csAnalyzeSite(url, keyword);
      if(!site) continue;
      if(!csPassesFilter(site)) continue;
      _csLiveResults.push(site);
      added++;
    }
    if(added > 0){ csUpdateLiveTable(); }
    return added;
  }

  // â”€ PHASE 1: SearXNG (real results, JSON API, no auth, CORS-open) â”€â”€â”€â”€â”€â”€â”€
  csLog(`ğŸ” Phase 1: Trying ${CS_SEARXNG_INSTANCES.length} SearXNG public instances...`, '#d29922');
  let anyPhase1 = false;

  outerLoop:
  for(const instance of CS_SEARXNG_INSTANCES){
    if(_csSearchAbort) break;
    const sn = instance.replace('https://','');
    for(let qi = 0; qi < Math.min(queries.length, 4); qi++){
      if(_csSearchAbort) break outerLoop;
      const {query} = queries[qi];
      csLog(`   â†’ SearXNG [${sn}] Q${qi+1}: ${query.slice(0,50)}...`, '#484f58');
      const urls = await csSearxngSearch(query, instance, recency);
      if(urls && urls.length > 0){
        const added = ingestUrls(urls);
        csLog(`   âœ… ${urls.length} results â†’ ${added} new sites (total: ${_csLiveResults.length})`, '#3fb950');
        anyPhase1 = true;
        await new Promise(r=>setTimeout(r,350));
        if(_csLiveResults.length >= 60) break outerLoop;
      } else {
        csLog(`   âœ— [${sn}] offline or blocked`, '#f85149');
        break;
      }
    }
    if(_csLiveResults.length >= 60) break;
  }

  if(anyPhase1){
    csLog(`âœ… Phase 1 done â€” ${_csLiveResults.length} sites so far`, '#3fb950');
  } else {
    csLog(`âš  All SearXNG instances offline. Falling back to proxy scraping...`, '#d29922');
  }

  // â”€ PHASE 2: DuckDuckGo + engine + Brave via CORS proxies â”€â”€â”€â”€â”€â”€â”€
  if(!_csSearchAbort && _csLiveResults.length < 30){
    csLog(`ğŸ” Phase 2: Proxy-scraping ${engine.toUpperCase()} + DDG + Brave...`, '#d29922');

    for(let qi = 0; qi < queries.length && !_csSearchAbort; qi++){
      const {query} = queries[qi];
      csLog(`   ğŸ” Q${qi+1}/${queries.length}: ${query.slice(0,55)}...`, '#d29922');

      const ddgUrls = await csDuckDuckGoSearch(query);
      if(ddgUrls && ddgUrls.length > 0){
        const added = ingestUrls(ddgUrls);
        csLog(`      âœ… DuckDuckGo: ${ddgUrls.length} URLs â†’ ${added} new sites`, '#3fb950');
      } else {
        const r = await csGoogleBingSearch(query, engine, recency);
        if(r && r.urls && r.urls.length > 0){
          const added = ingestUrls(r.urls);
          csLog(`      âœ… ${engine} via [${r.proxy}]: ${r.urls.length} URLs â†’ ${added} sites`, '#3fb950');
        } else {
          const bUrls = await csBraveSearch(query);
          if(bUrls && bUrls.length > 0){
            const added = ingestUrls(bUrls);
            csLog(`      âœ… Brave: ${bUrls.length} URLs â†’ ${added} new sites`, '#3fb950');
          } else {
            const fbUrl = csBuildSearchUrl(engine, query, recency);
            csLog(`      âœ— All blocked â€” <a href="${esc(fbUrl)}" target="_blank" style="color:#58a6ff">Open ${engine} manually â†’</a>`, '#f85149');
          }
        }
      }
      if(qi < queries.length - 1 && !_csSearchAbort){ await new Promise(r=>setTimeout(r,700)); }
    }
  }

  // â”€ PHASE 3: Built-in DB fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(_csLiveResults.length === 0){
    csLog(`âš  Live search returned 0 results. Loading built-in database...`, '#d29922');
    _csLiveResults = CS_KNOWN.map(s => ({...s, keyword}));
    csUpdateLiveTable();
    csShowSearchUrls(queries, engine, recency);
    csLog(`ğŸ“š Loaded ${_csLiveResults.length} sites from built-in database`, '#58a6ff');
  } else {
    csLog(`âœ… Search complete â€” <b style="color:#3fb950">${_csLiveResults.length} live sites found!</b>`, '#3fb950');
  }

  _csResults = _csLiveResults;
  _csRunning = false;
  if(btn){ btn.disabled = false; btn.innerHTML = 'ğŸ” Search'; }
  if(stopBtn) stopBtn.style.display = 'none';
}

function csPassesFilter(site){
  const f = _csActiveFilters;
  if(f.link === 'dofollow' && !site.dofollow) return false;
  if(f.link === 'nofollow' && site.dofollow) return false;
  if(f.type !== 'all'){
    const typeMap = {
      wordpress:['WordPress Blog','WordPress'],
      blogger:['Blogger'],
      blog:['Blog','Blog Post'],
      forum:['Forum','Thread'],
      qa:['Q&A'],
      news:['News'],
      community:['Community'],
    };
    const allowed = typeMap[f.type]||[];
    if(!allowed.some(t => (site.type||'').includes(t))) return false;
  }
  if(f.da !== 'all'){
    const [min,max] = f.da.split('-').map(Number);
    if(site.da < min || (max && site.da > max)) return false;
  }
  return true;
}

function csShowSearchUrls(queries, engine, recency){
  // Never interrupt active blog commenter session with popups
  if(_bcRunning){
    pfPendingManualSearchData = pfPendingManualSearchData || {queries, engine, recency, keyword:'search'};
    return;
  }
  const wrap = document.getElementById('cs-live-table-wrap');
  if(!wrap) return;
  const linksHtml = queries.map((q,i) => {
    const url = csBuildSearchUrl(engine, q.query, recency);
    return `<div style="padding:8px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
      <span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px;text-align:right">${i+1}</span>
      <div style="flex:1;min-width:0">
        <div style="font-family:var(--mono);font-size:10px;color:var(--accent);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.query)}</div>
      </div>
      <a href="${esc(url)}" target="_blank" class="btn btn-ghost btn-xs">ğŸ” Open in ${engine}</a>
    </div>`;
  }).join('');

  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `<div class="card-title">ğŸ”— Manual Search URLs â€” Open Each to Find Comment Sites</div>
    <div class="notice notice-warn">Due to browser security (CORS), open these links manually, copy site URLs you find, then add them to your queue.</div>
    <div style="max-height:400px;overflow-y:auto">${linksHtml}</div>`;
  wrap.appendChild(div);
}

function csUpdateLiveTable(){
  const wrap = document.getElementById('cs-live-table-wrap');
  if(!wrap) return;

  const results = _csLiveResults;
  if(!results.length) return;

  wrap.innerHTML = `
  <div class="flex g8" style="margin-bottom:10px;flex-wrap:wrap">
    <div class="stat g" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px">${results.length}</div>
      <div class="stat-l">Found</div>
    </div>
    <div class="stat b" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px;color:var(--accent)">${results.filter(r=>r.dofollow).length}</div>
      <div class="stat-l">Dofollow</div>
    </div>
    <div class="stat y" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px;color:var(--accent3)">${results.filter(r=>r.live).length}</div>
      <div class="stat-l">Live Results</div>
    </div>
    <div class="stat p" style="padding:10px 16px;flex:1;min-width:80px">
      <div class="stat-v" style="font-size:20px;color:var(--accent5)">${results.filter(r=>r.da>=70).length}</div>
      <div class="stat-l">DA 70+</div>
    </div>
    <div style="flex:0">
      <button class="btn btn-primary btn-sm" onclick="csPushAllToCommenter()">â• Push All to Commenter</button>
      <button class="btn btn-blue btn-sm" onclick="csShowAutoPosterSetupFromResults()" title="Push found sites to Auto Poster for scheduled posting">ğŸ“¤ Push to Auto Poster</button>
      <button class="btn btn-ghost btn-sm" style="margin-top:4px" onclick="csExportLive()">ğŸ“¤ Export CSV</button>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="card" style="padding:12px;margin-bottom:10px">
    <div class="flex aic g8" style="flex-wrap:wrap">
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-weight:700">FILTER:</span>
      <select id="cs-filter-type" style="width:130px" onchange="csApplyFilter()">
        <option value="all">All Types</option>
        <option value="wordpress">WordPress</option>
        <option value="blogger">Blogger</option>
        <option value="blog">Blog</option>
        <option value="forum">Forum</option>
        <option value="qa">Q&A</option>
        <option value="news">News</option>
        <option value="community">Community</option>
      </select>
      <select id="cs-filter-link" style="width:130px" onchange="csApplyFilter()">
        <option value="all">All Links</option>
        <option value="dofollow">Dofollow Only</option>
        <option value="nofollow">Nofollow Only</option>
      </select>
      <select id="cs-filter-da" style="width:130px" onchange="csApplyFilter()">
        <option value="all">Any DA</option>
        <option value="1-40">DA 1-40</option>
        <option value="1-60">DA 1-60</option>
        <option value="40-70">DA 40-70</option>
        <option value="60-100">DA 60+</option>
        <option value="80-100">DA 80+</option>
      </select>
      <input type="text" id="cs-filter-kw" placeholder="Filter by URL or name..." style="flex:1;min-width:150px" oninput="csApplyFilter()"/>
      <span style="font-family:var(--mono);font-size:10px;color:var(--muted2)">${results.length} sites</span>
    </div>
  </div>

  <div class="card">
    <div class="card-title">âœ… Comment-Enabled Sites â€” Real-Time Results</div>
    <div class="tw">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Site / URL</th>
            <th>Type</th>
            <th>DA</th>
            <th>Links</th>
            <th>Source</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="cs-table-body">
          ${results.map((r,i) => csRowHtml(r,i)).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
}

function csRowHtml(r, i){
  return `<tr>
    <td class="mono xs tm">${i+1}</td>
    <td>
      <a href="${esc(r.url)}" target="_blank" style="color:var(--accent);font-family:var(--mono);font-size:11px;font-weight:700;text-decoration:none;display:block;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.name||r.url)}</a>
      <div style="font-size:9px;color:var(--muted2);font-family:var(--mono);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:280px">${esc(r.url)}</div>
    </td>
    <td><span class="mono xs" style="white-space:nowrap">${esc(r.type||'Blog')}</span></td>
    <td>
      <span class="badge ${r.da>=80?'badge-g':r.da>=60?'badge-y':r.da>=40?'badge-b':'badge-r'}">${r.da}</span>
    </td>
    <td>${r.dofollow?'<span class="badge badge-g">âœ“ DoF</span>':'<span class="badge" style="border-color:var(--border2);color:var(--muted2)">Nofollow</span>'}</td>
    <td><span class="badge ${r.live?'badge-p':'badge-b'}">${r.live?'ğŸ”´ LIVE':'DB'}</span></td>
    <td>
      <div style="display:flex;gap:4px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-xs" onclick="window.open('${esc(r.url)}','_blank')">Open</button>
        <button class="btn btn-primary btn-xs" onclick="csAddToCommenterObj(${i})">+ Queue</button>
      </div>
    </td>
  </tr>`;
}

function csApplyFilter(){
  const type = (document.getElementById('cs-filter-type')||{value:'all'}).value;
  const link = (document.getElementById('cs-filter-link')||{value:'all'}).value;
  const da = (document.getElementById('cs-filter-da')||{value:'all'}).value;
  const kw = ((document.getElementById('cs-filter-kw')||{value:''}).value||'').toLowerCase();

  _csActiveFilters = { type, link, da, keyword: kw };

  const filtered = _csLiveResults.filter(r => {
    if(!csPassesFilter(r)) return false;
    if(kw && !r.url.toLowerCase().includes(kw) && !(r.name||'').toLowerCase().includes(kw)) return false;
    return true;
  });

  const tbody = document.getElementById('cs-table-body');
  if(tbody) tbody.innerHTML = filtered.map((r,i) => csRowHtml(r,i)).join('');

  // Update count
  const countEls = document.querySelectorAll('#cs-live-table-wrap .stat-v');
  if(countEls[0]) countEls[0].textContent = filtered.length;
}

function csAddToCommenterObj(idx){
  const filtered = _csLiveResults.filter(r => {
    if(!csPassesFilter(r)) return false;
    const kw = _csActiveFilters.keyword||'';
    if(kw && !r.url.toLowerCase().includes(kw) && !(r.name||'').toLowerCase().includes(kw)) return false;
    return true;
  });
  const r = filtered[idx];
  if(!r) return;
  if(!_bcSites.find(s=>s.url===r.url)){
    _bcSites.push({id:uid(),url:r.url,label:r.name||r.url,type:r.type&&r.type.toLowerCase().includes('word')?'wordpress':'generic',name:'',email:'',website:'',notes:r.notes||'',done:false,queued:''});
    bcSave();
    const btn = event.target;
    btn.innerHTML = 'âœ“ Added'; btn.classList.remove('btn-primary'); btn.classList.add('btn-ghost');
    btn.disabled = true;
  }
}

function csShowAutoPosterSetupFromResults(){
  if(!_csLiveResults||!_csLiveResults.length){ alert('Run a search first.'); return; }
  const fakeSites = _csLiveResults.map(r => ({
    url: r.url, label: r.name||r.url, status: 'success', comment: `Great resource on ${r.keyword||'this topic'}: ${r.url}`
  }));
  bcShowAutoPosterSetup(fakeSites);
}

function csPushAllToCommenter(){
  if(!_csResults.length){alert('Run a search first.');return;}
  let added=0;
  _csResults.forEach(r=>{
    if(!_bcSites.find(s=>s.url===r.url)){
      _bcSites.push({id:uid(),url:r.url,label:r.name||r.url,type:r.type&&r.type.toLowerCase().includes('word')?'wordpress':'generic',name:'',email:'',website:'',notes:r.notes||'',done:false,queued:''});
      added++;
    }
  });
  bcSave();
  alert(`âœ“ Added ${added} sites to Blog Commenter!`);
}

function csExportLive(){
  if(!_csResults.length){alert('Run a search first.');return;}
  const rows=[['Name','URL','Type','DA','Dofollow','Source','Notes'],
    ..._csResults.map(r=>[r.name||'',r.url,r.type||'',r.da,r.dofollow?'Yes':'No',r.live?'Live Search':'Database',r.notes||''])];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='comment-sites-'+Date.now()+'.csv';a.click();
}

function csStopSearch(){
  _csSearchAbort = true;
  _csRunning = false;
  _csResults = _csLiveResults;
  const btn = document.getElementById('cs-search-btn');
  const stopBtn = document.getElementById('cs-stop-btn');
  if(btn){ btn.disabled = false; btn.innerHTML = 'ğŸ” Search'; }
  if(stopBtn) stopBtn.style.display = 'none';
}

const CS_KNOWN = [
  // Blogs/CMS that allow public comments
  {url:'https://www.blogger.com', name:'Blogger', type:'Blog Platform', da:97, dofollow:false, notes:'Millions of blogs with open comments'},
  {url:'https://wordpress.com', name:'WordPress.com', type:'Blog Platform', da:95, dofollow:false, notes:'Largest blog platform, most allow comments'},
  {url:'https://disqus.com', name:'Disqus', type:'Comment System', da:91, dofollow:false, notes:'Powers comments on 500k+ sites'},
  {url:'https://www.intensedebate.com', name:'IntenseDebate', type:'Comment System', da:82, dofollow:true, notes:'Dofollow links in profile'},
  {url:'https://www.livejournal.com', name:'LiveJournal', type:'Blog', da:88, dofollow:true, notes:'Public blogs allow open comments'},
  {url:'https://medium.com', name:'Medium', type:'Article Platform', da:95, dofollow:false, notes:'Response/comment system on all articles'},
  {url:'https://vocal.media', name:'Vocal.media', type:'Article Platform', da:81, dofollow:true, notes:'Public comment section on all stories'},
  {url:'https://hubpages.com', name:'HubPages', type:'Article Site', da:87, dofollow:false, notes:'Comments on all hubs'},
  {url:'https://www.tumblr.com', name:'Tumblr', type:'Blog', da:96, dofollow:false, notes:'Reblog + comment system'},
  {url:'https://dev.to', name:'Dev.to', type:'Tech Blog', da:88, dofollow:true, notes:'Developer community, dofollow profile links'},
  {url:'https://hashnode.com', name:'Hashnode', type:'Tech Blog', da:85, dofollow:true, notes:'Dev blogs, open commenting'},
  {url:'https://hackernoon.com', name:'HackerNoon', type:'Tech Article', da:87, dofollow:false, notes:'Comment via social login'},
  {url:'https://producthunt.com', name:'Product Hunt', type:'Community', da:90, dofollow:true, notes:'Comment on product listings'},
  {url:'https://indiehackers.com', name:'Indie Hackers', type:'Community', da:82, dofollow:true, notes:'Forum + comment system'},
  {url:'https://community.hubspot.com', name:'HubSpot Community', type:'Forum', da:93, dofollow:false, notes:'Marketing/SEO discussions'},
  {url:'https://moz.com/community', name:'Moz Community', type:'Forum', da:91, dofollow:false, notes:'SEO community posts'},
  {url:'https://www.quora.com', name:'Quora', type:'Q&A', da:93, dofollow:false, notes:'Add comments to any answer'},
  {url:'https://reddit.com', name:'Reddit', type:'Forum', da:98, dofollow:false, notes:'Hundreds of niche subreddits'},
  {url:'https://forums.digitalpoint.com', name:'Digital Point', type:'Forum', da:81, dofollow:true, notes:'SEO/marketing forum with dofollow'},
  {url:'https://www.warriorforum.com', name:'Warrior Forum', type:'Forum', da:84, dofollow:false, notes:'Internet marketing community'},
  {url:'https://blackhatworld.com', name:'Black Hat World', type:'Forum', da:85, dofollow:false, notes:'SEO/marketing discussion forum'},
  {url:'https://www.sitepoint.com/community', name:'SitePoint', type:'Forum', da:88, dofollow:false, notes:'Web dev discussions'},
  {url:'https://stackexchange.com', name:'Stack Exchange', type:'Q&A', da:92, dofollow:false, notes:'Technical Q&A network'},
  {url:'https://answers.yahoo.com', name:'Yahoo Answers', type:'Q&A', da:93, dofollow:false, notes:'General Q&A platform'},
  {url:'https://www.ehow.com', name:'eHow', type:'How-To', da:89, dofollow:false, notes:'How-to articles with comments'},
  {url:'https://www.instructables.com', name:'Instructables', type:'How-To', da:88, dofollow:true, notes:'DIY community, open commenting'},
  {url:'https://www.wikihow.com', name:'wikiHow', type:'How-To', da:91, dofollow:false, notes:'Community edit + discussion tabs'},
  {url:'https://digg.com', name:'Digg', type:'News/Blog', da:88, dofollow:false, notes:'Comment on curated articles'},
  {url:'https://www.stumbleupon.com', name:'Mix (StumbleUpon)', type:'Social', da:85, dofollow:false, notes:'Comment on shared pages'},
  {url:'https://www.scoop.it', name:'Scoop.it', type:'Content Curation', da:84, dofollow:true, notes:'Curation platform with dofollow comments'},
  {url:'https://www.bloglovin.com', name:'Bloglovin', type:'Blog Aggregator', da:86, dofollow:false, notes:'Follow/comment on blogs'},
  {url:'https://www.zoomit.ir', name:'Zoomit', type:'Tech News', da:78, dofollow:false, notes:'Tech news comment section'},
  {url:'https://www.techrepublic.com', name:'TechRepublic', type:'Tech News', da:88, dofollow:false, notes:'Open comment section'},
  {url:'https://www.zdnet.com', name:'ZDNet', type:'Tech News', da:91, dofollow:false, notes:'Tech articles with Disqus comments'},
  {url:'https://ahrefs.com/blog', name:'Ahrefs Blog', type:'SEO Blog', da:91, dofollow:false, notes:'SEO blog with open commenting'},
  {url:'https://searchengineland.com', name:'Search Engine Land', type:'SEO News', da:90, dofollow:false, notes:'Industry comments section'},
  {url:'https://www.semrush.com/blog', name:'SEMrush Blog', type:'SEO Blog', da:90, dofollow:false, notes:'Marketing blog with comments'},
  {url:'https://neilpatel.com/blog', name:'Neil Patel Blog', type:'Marketing Blog', da:88, dofollow:false, notes:'Very active comment section'},
  {url:'https://backlinko.com/blog', name:'Backlinko', type:'SEO Blog', da:87, dofollow:false, notes:'Brian Dean\'s SEO blog comments'},
  {url:'https://moz.com/blog', name:'Moz Blog', type:'SEO Blog', da:91, dofollow:false, notes:'SEO blog with community comments'},
];

function renderCommentSites(el){
  el.innerHTML=`
  <div class="page-title">ğŸŒ Comment Sites Finder</div>
  <div class="page-sub">// real-time search Â· find fresh blogs & forums with open comments Â· keyword-powered Â· instant results</div>

  <!-- SEARCH PANEL -->
  <div class="card">
    <div class="card-title">ğŸ” Live Search Parameters</div>

    <div class="grid2" style="margin-bottom:12px">
      <div class="fg mb0">
        <label class="lbl">Keyword / Niche <span style="color:var(--accent2)">*required</span></label>
        <input type="text" id="cs-keyword" placeholder='e.g. wordpress tutorial, weight loss, crypto news'
          style="font-size:13px;padding:10px 14px"
          oninput="csRealTimePreview()"
          onkeydown="if(event.key==='Enter') csLiveSearch()"/>
      </div>
      <div class="fg mb0">
        <label class="lbl">Target Platform</label>
        <select id="cs-platform">
          <option value="all">All Platforms (Broadest)</option>
          <option value="wordpress">WordPress Sites</option>
          <option value="blogger">Blogger / Blogspot</option>
          <option value="blog">Any Blog</option>
          <option value="forum">Forums</option>
          <option value="news">News Sites</option>
          <option value="qa">Q&amp;A Sites</option>
        </select>
      </div>
    </div>

    <div class="grid3">
      <div class="fg mb0">
        <label class="lbl">Search Engine</label>
        <select id="cs-engine">
          <option value="google">Google</option>
          <option value="bing">Bing</option>
          <option value="duckduckgo">DuckDuckGo</option>
        </select>
      </div>
      <div class="fg mb0">
        <label class="lbl">Post Recency / Time Filter</label>
        <select id="cs-recency">
          <option value="any">Any time (most results)</option>
          <option value="24h">Last 24 hours</option>
          <option value="48h">Last 48 hours</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last month</option>
        </select>
      </div>
      <div class="fg mb0">
        <label class="lbl">Comment Type Filter</label>
        <select id="cs-linktype">
          <option value="leave a reply">Leave a Reply (WordPress)</option>
          <option value="post a comment">Post a Comment</option>
          <option value="add a comment">Add a Comment</option>
          <option value="leave a comment">Leave a Comment</option>
          <option value="comment">Generic Comments</option>
        </select>
      </div>
    </div>

    <!-- Live query preview -->
    <div id="cs-query-preview" style="margin-top:10px;padding:10px 12px;background:#0d1117;border:1px solid #30363d;border-radius:6px;font-family:var(--mono);font-size:10px;color:#58a6ff;display:none">
      <span style="color:#484f58">QUERY PREVIEW â†’ </span><span id="cs-query-text"></span>
    </div>

    <div class="flex aic g8 mt8" style="flex-wrap:wrap">
      <button class="btn btn-primary" id="cs-search-btn" onclick="csLiveSearch()" style="padding:10px 24px;font-size:11px">
        ğŸ” Search
      </button>
      <button class="btn btn-danger btn-sm" id="cs-stop-btn" onclick="csStopSearch()" style="display:none">â¹ Stop</button>
      <button class="btn btn-ghost btn-sm" onclick="csShowManualLinks()">ğŸ”— Open Search in Browser</button>
      <button class="btn btn-ghost btn-sm" onclick="csLoadBuiltIn()">ğŸ“š Load Built-in Database</button>
      <button class="btn btn-ghost btn-sm" onclick="csExportLive()">ğŸ“¤ Export CSV</button>
      <div id="cs-status" style="font-family:var(--mono);font-size:10px;color:var(--muted2);margin-left:auto"></div>
    </div>
  </div>

  <div id="cs-results-wrap">
    <div class="notice notice-info">
      ğŸ’¡ <strong>How it works:</strong> Type a keyword + select recency â†’ hit Search â†’ the tool builds Google/Bing search queries using <code>"keyword" "leave a reply"</code> operators, fetches results via CORS proxy, and lists every blog/forum it finds with an open comment section.
      <br><br>If the proxy is blocked, click <strong>"Open Search in Browser"</strong> to manually run each query and copy URLs.
    </div>
  </div>`;

  document.getElementById('cs-keyword').addEventListener('input', csRealTimePreview);
}

function csRealTimePreview(){
  const kw = (document.getElementById('cs-keyword')||{value:''}).value.trim();
  const platform = (document.getElementById('cs-platform')||{value:'all'}).value;
  const ctype = (document.getElementById('cs-linktype')||{value:'leave a reply'}).value;
  const engine = (document.getElementById('cs-engine')||{value:'google'}).value;
  const recency = (document.getElementById('cs-recency')||{value:'any'}).value;
  const preview = document.getElementById('cs-query-preview');
  const previewText = document.getElementById('cs-query-text');
  if(!kw){ if(preview) preview.style.display='none'; return; }
  if(preview) preview.style.display='';
  const q = csBuildQueries(kw, platform, recency)[0];
  if(previewText && q) previewText.textContent = q.query + ` â†’ ${engine}.com`;
}

function csShowManualLinks(){
  const keyword = (document.getElementById('cs-keyword')||{value:''}).value.trim();
  if(!keyword){ alert('Enter a keyword first.'); return; }
  const engine = (document.getElementById('cs-engine')||{value:'google'}).value;
  const platform = (document.getElementById('cs-platform')||{value:'all'}).value;
  const recency = (document.getElementById('cs-recency')||{value:'any'}).value;
  const queries = csBuildQueries(keyword, platform, recency);
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = e => { if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML = `<div class="modal-box" style="min-width:600px;max-width:800px">
    <div class="modal-title">ğŸ”— Manual Search Links â€” Open Each in Browser
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ•</button>
    </div>
    <div class="notice notice-info" style="margin-bottom:12px">Click each link to search ${engine} for comment-enabled sites in <b>${esc(keyword)}</b>. Copy any site URLs you find and add them to the Commenter queue.</div>
    <div style="max-height:440px;overflow-y:auto">
      ${queries.map((q,i)=>{
        const url = csBuildSearchUrl(engine, q.query, recency);
        return `<div style="padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
          <span style="font-family:var(--mono);font-size:9px;color:var(--muted);width:20px;text-align:right;flex-shrink:0">${i+1}</span>
          <div style="flex:1;min-width:0">
            <div style="font-family:var(--mono);font-size:10px;color:var(--text);font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.query)}</div>
          </div>
          <a href="${esc(url)}" target="_blank" class="btn btn-primary btn-xs">Open in ${engine} â†’</a>
        </div>`;
      }).join('')}
    </div>
    <div class="row mt8">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function csLoadBuiltIn(){
  _csLiveResults = CS_KNOWN.map(s=>({...s}));
  _csResults = _csLiveResults;
  csUpdateLiveTable();
  const wrap = document.getElementById('cs-results-wrap');
  if(wrap && !document.getElementById('cs-live-table-wrap')){
    wrap.innerHTML = `<div id="cs-live-table-wrap"></div>`;
    csUpdateLiveTable();
  }
}

function csFind(){ csLiveSearch(); }
function csAIFind(){ csLiveSearch(); }
function csPushToCommenter(){ csPushAllToCommenter(); }
function csExport(){ csExportLive(); }

function csAddToCommenter(url, name){
  if(!_bcSites.find(s=>s.url===url)){
    _bcSites.push({id:uid(),url,label:name,type:'generic',name:'',email:'',website:'',notes:'',done:false,queued:''});
    bcSave();
  }
  alert(`âœ“ ${name} added to Blog Commenter queue!`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF PARASITE MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/* â”€â”€ PDF Parasite State â”€â”€ */
const PDF_STATE = {
  jobs: [],          // [{id, keyword, title, platform, status, pdfBlob, pdfUrl, uploadUrl, ts, size, pages, log}]
  settings: {
    font: 'helvetica',
    primaryColor: '#0057ff',
    includeLinks: true,
    includeSchema: true,
    addBacklinks: true,
    addTableOfContents: true,
    pagesPerDoc: 3,
    density: 'rich'   // 'thin' | 'rich' | 'ultra'
  }
};

/* â”€â”€ PDF Platforms Config â”€â”€ */
const PDF_PLATFORMS = [
  { id:'scribd',    name:'Scribd',       icon:'ğŸ“š', da:96,  freeUpload:true,  indexed:true,  apiNote:'Cookie/Form POST â€“ Scribd auto-indexes & ranks PDFs on Google. DA 96.', uploadUrl:'https://www.scribd.com/upload-document', method:'form' },
  { id:'issuu',     name:'Issuu',        icon:'ğŸ“°', da:92,  freeUpload:true,  indexed:true,  apiNote:'Issuu API v2 / Form POST â€“ Publications indexed by Google. DA 92.',    uploadUrl:'https://issuu.com/home/publications',        method:'api'  },
  { id:'slideshare',name:'SlideShare',   icon:'ğŸ“Š', da:95,  freeUpload:true,  indexed:true,  apiNote:'LinkedIn SlideShare â€“ upload via form. DA 95.',                        uploadUrl:'https://www.slideshare.net/upload',           method:'form' },
  { id:'academia',  name:'Academia.edu', icon:'ğŸ“', da:93,  freeUpload:true,  indexed:true,  apiNote:'Free upload â€“ Google crawls Academia.edu pages heavily. DA 93.',       uploadUrl:'https://www.academia.edu/upload',             method:'form' },
  { id:'researchgate',name:'ResearchGate',icon:'ğŸ”¬',da:91, freeUpload:true,  indexed:true,  apiNote:'Upload preprints/papers â€“ crawled aggressively by Google. DA 91.',     uploadUrl:'https://www.researchgate.net/publication/upload', method:'form' },
  { id:'archive',   name:'Internet Archive',icon:'ğŸ›ï¸',da:94,freeUpload:true,indexed:true,  apiNote:'archive.org S3-like API â€“ permanent URLs, well crawled. DA 94.',        uploadUrl:'https://archive.org/upload/',                 method:'api'  },
  { id:'box',       name:'Box.com',      icon:'ğŸ“¦', da:90,  freeUpload:false, indexed:true,  apiNote:'Box.com shared links are indexed by Google. DA 90.',                   uploadUrl:'https://app.box.com/upload',                  method:'form' },
  { id:'docsend',   name:'DocSend',      icon:'ğŸ“¨', da:72,  freeUpload:false, indexed:false, apiNote:'Tracks opens; public links can rank. DA 72.',                          uploadUrl:'https://docsend.com/upload',                  method:'form' },
  { id:'calameo',   name:'Calameo',      icon:'ğŸ“–', da:88,  freeUpload:true,  indexed:true,  apiNote:'Flipbook publisher â€“ good indexation, DA 88.',                         uploadUrl:'https://en.calameo.com/publish/',             method:'form' },
  { id:'yumpu',     name:'Yumpu',        icon:'ğŸ“—', da:82,  freeUpload:true,  indexed:true,  apiNote:'ePublishing platform â€“ well crawled by Google. DA 82.',                uploadUrl:'https://www.yumpu.com/en/upload',             method:'form' },
  { id:'edocr',     name:'edocr',        icon:'ğŸ“‚', da:73,  freeUpload:true,  indexed:true,  apiNote:'Document sharing DA 73 â€“ allows keyword-rich titles & descriptions.',  uploadUrl:'https://www.edocr.com/upload',                method:'form' },
  { id:'slideserve',name:'SlideServe',   icon:'ğŸ', da:79,  freeUpload:true,  indexed:true,  apiNote:'Upload presentations as PDFs â€“ DA 79, Google-indexed.',                uploadUrl:'https://www.slideserve.com/upload',           method:'form' },
];

/* â”€â”€ Content Templates by Niche â”€â”€ */
const PDF_TEMPLATES = {
  guide:    { label:'Ultimate Guide',   pages:['Introduction','Why {KW} Matters','Step-by-Step Process','Expert Tips','Common Mistakes','Conclusion & Next Steps'] },
  review:   { label:'Product Review',   pages:['Overview','Key Features','Pros & Cons','Pricing Analysis','Comparison Chart','Final Verdict'] },
  checklist:{ label:'Checklist / SOP',  pages:['Quick Reference Checklist','Detailed Breakdown','Tools Required','Expert Recommendations','FAQ','Resources'] },
  report:   { label:'Industry Report',  pages:['Executive Summary','Market Overview','Data & Statistics','Expert Insights','Predictions','Key Takeaways'] },
  casestudy:{ label:'Case Study',       pages:['Background','The Challenge','Strategy Used','Results Achieved','Lessons Learned','How to Apply This'] },
  listicle: { label:'Top-N Listicle',   pages:['Introduction','#1 â€“ Best Option','#2 â€“ Runner-Up','#3 â€“ Budget Pick','#4 â€“ Hidden Gem','Final Rankings'] },
};

/* â”€â”€ Keyword Density Profiles â”€â”€ */
const PDF_DENSITY = {
  thin:  { wordsPerSection:80,  kwFreq:2, lsiCount:2 },
  rich:  { wordsPerSection:180, kwFreq:4, lsiCount:5 },
  ultra: { wordsPerSection:320, kwFreq:7, lsiCount:9 },
};

/* â”€â”€ LSI/semantic keyword generator â”€â”€ */
function pdfLSI(kw, count=5){
  const base = kw.toLowerCase().split(/\s+/);
  const modifiers = ['best','top','cheap','affordable','professional','guide','review','tutorial','tips','how to','online','near me','2024','2025','services','comparison','vs','for beginners','advanced','complete'];
  const lsi = [];
  for(let i=0;i<count;i++){
    const mod = modifiers[i % modifiers.length];
    lsi.push(i%2===0 ? `${mod} ${kw}` : `${kw} ${mod}`);
  }
  return lsi;
}

/* â”€â”€ Schema JSON-LD builder for PDF metadata â”€â”€ */
function pdfSchema(kw, title, url){
  return {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "name": title,
    "description": `Comprehensive guide on ${kw}. Covers everything you need to know about ${kw} in 2025.`,
    "keywords": `${kw}, ${pdfLSI(kw,5).join(', ')}`,
    "url": url || '#',
    "datePublished": new Date().toISOString().split('T')[0],
    "author": {"@type":"Organization","name":"Expert Guide Series"},
    "publisher": {"@type":"Organization","name":"Industry Authority","logo":{"@type":"ImageObject","url":"https://example.com/logo.png"}}
  };
}

/* â”€â”€ Build rich HTML document that gets "printed to PDF" â”€â”€ */
function pdfBuildHTML(keyword, title, template, backlinks, density){
  const lsi = pdfLSI(keyword, 9);
  const tpl = PDF_TEMPLATES[template] || PDF_TEMPLATES.guide;
  const dens = PDF_DENSITY[density] || PDF_DENSITY.rich;
  const pages = tpl.pages.map(p=>p.replace(/{KW}/g, keyword));
  const kw = keyword;
  const schema = JSON.stringify(pdfSchema(kw, title, ''), null, 2);

  const sectionHTML = pages.map((heading, idx) => {
    const para1 = `When researching ${kw}, one of the most important aspects to understand is ${heading.toLowerCase()}. Many professionals working with ${kw} agree that this section covers the core principles every user must know. According to industry experts, ${kw} has evolved significantly in recent years.`;
    const para2 = `The ${kw} landscape continues to shift. Whether you're a beginner or an advanced user exploring ${kw}, the following insights will help you make informed decisions. Data from recent surveys shows that those who master ${lsi[idx%lsi.length]} outperform competitors by a wide margin.`;
    const para3 = dens.wordsPerSection > 150 ? `For the best results with ${kw}, always consider the context. Top practitioners of ${lsi[(idx+1)%lsi.length]} recommend a structured approach. This section breaks down the methodology so you can apply it immediately â€” whether you're dealing with ${lsi[(idx+2)%lsi.length]} or ${lsi[(idx+3)%lsi.length]}.` : '';
    const para4 = dens.wordsPerSection > 250 ? `Advanced ${kw} users have found that combining multiple approaches â€” including ${lsi[(idx+4)%lsi.length]} â€” yields the highest ROI. The data consistently shows that a well-executed ${kw} strategy reduces costs, increases visibility, and drives sustainable growth over time.` : '';

    const bls = backlinks && idx === Math.floor(pages.length/2)
      ? `<div style="margin:16px 0;padding:12px 16px;background:#f0f4ff;border-left:4px solid #0057ff;border-radius:4px;font-size:11pt"><strong>ğŸ“Œ Resource:</strong> For more on ${kw}, visit <a href="${backlinks}" style="color:#0057ff">${backlinks}</a></div>` : '';

    return `
      <div style="page-break-inside:avoid;margin-bottom:28px">
        <h2 style="font-size:16pt;color:#0057ff;border-bottom:2px solid #e8edff;padding-bottom:6px;margin-bottom:12px">${idx+1}. ${heading}</h2>
        <p style="font-size:11pt;line-height:1.8;color:#1a1a2e;margin-bottom:10px">${para1}</p>
        <p style="font-size:11pt;line-height:1.8;color:#1a1a2e;margin-bottom:10px">${para2}</p>
        ${para3 ? `<p style="font-size:11pt;line-height:1.8;color:#1a1a2e;margin-bottom:10px">${para3}</p>` : ''}
        ${para4 ? `<p style="font-size:11pt;line-height:1.8;color:#1a1a2e;margin-bottom:10px">${para4}</p>` : ''}
        ${bls}
      </div>`;
  }).join('');

  const tocHTML = `
    <div style="background:#f8fafc;border:1px solid #dde3ec;padding:16px 20px;border-radius:8px;margin-bottom:24px">
      <h2 style="font-size:13pt;color:#0057ff;margin-bottom:10px">ğŸ“‹ Table of Contents</h2>
      <ol style="font-size:11pt;line-height:2;color:#333;padding-left:20px">
        ${pages.map((p,i)=>`<li>${p}</li>`).join('')}
      </ol>
    </div>`;

  const metaTags = lsi.slice(0,6).map(l=>`<meta name="keywords" content="${esc(l)}">`).join('\n    ');

  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${esc(title)}</title>
  <meta name="description" content="Complete guide on ${esc(kw)} â€” covering everything from basics to advanced strategies. Updated for 2025.">
  ${metaTags}
  <meta property="og:title" content="${esc(title)}">
  <meta property="og:description" content="Expert guide on ${esc(kw)}.">
  <script type="application/ld+json">${schema}<\/script>
  <style>
    body{font-family:'Georgia',serif;font-size:12pt;color:#1a1a2e;line-height:1.7;max-width:750px;margin:0 auto;padding:28px 36px}
    h1{font-size:22pt;color:#0057ff;margin-bottom:6px;line-height:1.3}
    .subtitle{font-size:12pt;color:#666;margin-bottom:20px;font-style:italic}
    .kw-chip{display:inline-block;background:#e8edff;color:#0057ff;font-size:9pt;padding:2px 10px;border-radius:20px;margin:2px;font-family:monospace}
    .lsi-box{background:#fff9e6;border:1px solid #ffe080;padding:12px 16px;border-radius:6px;margin:20px 0}
    .lsi-box h3{font-size:10pt;color:#92400e;margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em}
    .cta-box{background:linear-gradient(135deg,#0057ff,#7c3aed);color:#fff;padding:20px 24px;border-radius:8px;margin:28px 0;text-align:center}
    .cta-box p{font-size:12pt;margin-bottom:10px}
    .cta-box a{color:#fff;font-weight:bold;font-size:13pt}
    @media print{.no-print{display:none}}
  </style>
</head>
<body>
  <h1>${esc(title)}</h1>
  <div class="subtitle">The Definitive 2025 Resource on ${esc(kw)}</div>

  <div class="lsi-box">
    <h3>ğŸ”‘ Related Searches</h3>
    ${lsi.map(l=>`<span class="kw-chip">${esc(l)}</span>`).join(' ')}
  </div>

  ${tocHTML}

  ${sectionHTML}

  ${backlinks ? `
  <div class="cta-box">
    <p>Want to learn more about <strong>${esc(kw)}</strong>?</p>
    <a href="${esc(backlinks)}">${esc(backlinks)}</a>
  </div>` : ''}

  <hr style="margin:28px 0;border:none;border-top:1px solid #dde3ec">
  <p style="font-size:9pt;color:#999;text-align:center">Â© 2025 Expert Guide Series Â· All rights reserved Â· Comprehensive guide on ${esc(kw)}</p>
</body>
</html>`;
}

/* â”€â”€ Generate PDF via print window trick (browser-native) â”€â”€ */
function pdfGenerate(job){
  return new Promise(resolve => {
    const html = pdfBuildHTML(job.keyword, job.title, job.template, job.backlinks, job.density);
    const printWin = window.open('', '_blank', 'width=900,height=700');
    if(!printWin){ resolve(null); return; }
    printWin.document.open();
    printWin.document.write(html);
    printWin.document.close();
    setTimeout(() => {
      printWin.print();
      printWin.onafterprint = () => { printWin.close(); resolve(html); };
      setTimeout(() => { try{ printWin.close(); }catch(e){} resolve(html); }, 4000);
    }, 900);
  });
}

/* â”€â”€ Download HTML as file (fallback for those who want direct download) â”€â”€ */
function pdfDownloadHTML(job){
  const html = pdfBuildHTML(job.keyword, job.title, job.template, job.backlinks, job.density);
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = slug(job.title || job.keyword) + '-parasite.html';
  a.click();
}

/* â”€â”€ Add log line to job â”€â”€ */
function pdfLog(jobId, msg, type='info'){
  const job = PDF_STATE.jobs.find(j=>j.id===jobId);
  if(!job) return;
  job.log = job.log || [];
  job.log.push({ts:ts(), msg, type});
  pdfRefreshJobRow(jobId);
  const termEl = document.getElementById('pdf-terminal');
  if(termEl){
    const typeClass = type==='error'?'t-error':type==='warn'?'t-warn':type==='success'?'t-info':'t-accent';
    termEl.innerHTML += `<div class="tline"><span class="ttime">${ts()}</span><span class="${typeClass}">${esc(msg)}</span></div>`;
    termEl.scrollTop = termEl.scrollHeight;
  }
}

/* â”€â”€ Refresh a single job row in table â”€â”€ */
function pdfRefreshJobRow(jobId){
  const job = PDF_STATE.jobs.find(j=>j.id===jobId);
  if(!job) return;
  const row = document.getElementById(`pdf-job-${jobId}`);
  if(!row) return;
  const statusMap = {queued:'<span class="badge badge-y">â³ Queued</span>',building:'<span class="badge badge-b">ğŸ”¨ Building</span>',ready:'<span class="badge badge-g">âœ… Ready</span>',uploading:'<span class="badge badge-b"><span class="spinner"></span> Uploading</span>',live:'<span class="badge badge-g">ğŸ”´ Live</span>',error:'<span class="badge badge-r">âŒ Error</span>'};
  row.innerHTML = `
    <td class="mono xs tm">${esc(job.ts)}</td>
    <td><div style="font-weight:700;font-size:12px">${esc(job.keyword)}</div><div class="xs tm">${esc(job.title)}</div></td>
    <td><span class="badge badge-p">${esc(job.platform)}</span></td>
    <td>${esc(job.template||'guide')}</td>
    <td>${statusMap[job.status]||job.status}</td>
    <td>
      ${job.status==='ready'||job.status==='live' ? `<button class="btn btn-primary btn-xs" onclick="pdfLaunchUpload('${job.id}')">ğŸ“¤ Upload</button>` : ''}
      <button class="btn btn-ghost btn-xs" onclick="pdfDownloadJob('${job.id}')">â¬‡ HTML</button>
      ${job.uploadUrl ? `<a href="${esc(job.uploadUrl)}" target="_blank" class="btn btn-blue btn-xs">ğŸ”— URL</a>` : ''}
      <button class="btn btn-danger btn-xs" onclick="pdfRemoveJob('${job.id}')">âœ•</button>
    </td>`;
}

/* â”€â”€ Build / queue a new job â”€â”€ */
async function pdfAddJob(){
  const kw      = (document.getElementById('pdf-keyword')||{value:''}).value.trim();
  const title   = (document.getElementById('pdf-title')||{value:''}).value.trim() || `The Complete Guide to ${kw}`;
  const tpl     = (document.getElementById('pdf-template')||{value:'guide'}).value;
  const plat    = (document.getElementById('pdf-platform')||{value:'scribd'}).value;
  const bls     = (document.getElementById('pdf-backlinks')||{value:''}).value.trim();
  const density = (document.getElementById('pdf-density')||{value:'rich'}).value;

  if(!kw){ alert('Enter a target keyword first.'); return; }

  const job = { id:uid(), keyword:kw, title, template:tpl, platform:plat, backlinks:bls, density, status:'queued', log:[], ts:new Date().toLocaleTimeString(), uploadUrl:null };
  PDF_STATE.jobs.unshift(job);
  pdfRenderTable();
  pdfLog(job.id, `Job created for "${kw}" â†’ ${plat}`, 'info');

  // Auto-build
  await pdfBuildJob(job.id);
}

async function pdfBuildJob(jobId){
  const job = PDF_STATE.jobs.find(j=>j.id===jobId);
  if(!job) return;
  job.status = 'building';
  pdfLog(jobId, `Building HTML document for "${job.keyword}"...`, 'info');
  pdfRefreshJobRow(jobId);
  await sleep(400);

  // Generate HTML
  job.html = pdfBuildHTML(job.keyword, job.title, job.template, job.backlinks, job.density);
  job.charCount = job.html.length;
  job.wordCount = job.html.replace(/<[^>]+>/g,'').split(/\s+/).filter(Boolean).length;

  job.status = 'ready';
  pdfLog(jobId, `âœ… Document ready â€” ${job.wordCount} words, ${job.charCount} chars`, 'success');
  pdfRefreshJobRow(jobId);
  pdfUpdateStats();
}

/* â”€â”€ Launch upload (opens platform + downloads HTML) â”€â”€ */
function pdfLaunchUpload(jobId){
  const job = PDF_STATE.jobs.find(j=>j.id===jobId);
  if(!job) return;
  const plat = PDF_PLATFORMS.find(p=>p.id===job.platform);
  if(!plat){ alert('Platform not found.'); return; }

  job.status = 'uploading';
  pdfLog(jobId, `Opening ${plat.name} upload page...`, 'warn');
  pdfRefreshJobRow(jobId);

  // Download the HTML file
  pdfDownloadHTML(job);

  // Open platform upload page
  setTimeout(()=>{ window.open(plat.uploadUrl,'_blank'); }, 600);

  // Mark as live after delay (manual confirmation)
  setTimeout(()=>{
    job.status = 'live';
    job.uploadUrl = plat.uploadUrl;
    pdfLog(jobId, `âœ… File downloaded + ${plat.name} upload page opened. Paste the HTML content there.`, 'success');
    pdfRefreshJobRow(jobId);
    pdfUpdateStats();
  }, 2000);
}

/* â”€â”€ Remove job â”€â”€ */
function pdfRemoveJob(jobId){
  PDF_STATE.jobs = PDF_STATE.jobs.filter(j=>j.id!==jobId);
  pdfRenderTable();
  pdfUpdateStats();
}

/* â”€â”€ Download job HTML â”€â”€ */
function pdfDownloadJob(jobId){
  const job = PDF_STATE.jobs.find(j=>j.id===jobId);
  if(!job){ alert('Job not found.'); return; }
  if(!job.html) job.html = pdfBuildHTML(job.keyword, job.title, job.template, job.backlinks, job.density);
  pdfDownloadHTML(job);
}

/* â”€â”€ Bulk add from keyword list â”€â”€ */
async function pdfBulkAdd(){
  const raw = (document.getElementById('pdf-bulk-kws')||{value:''}).value.trim();
  const tpl = (document.getElementById('pdf-bulk-tpl')||{value:'guide'}).value;
  const plat = (document.getElementById('pdf-bulk-platform')||{value:'scribd'}).value;
  const bls = (document.getElementById('pdf-bulk-backlinks')||{value:''}).value.trim();
  const density = (document.getElementById('pdf-bulk-density')||{value:'rich'}).value;
  if(!raw){ alert('Add at least one keyword.'); return; }

  const kws = raw.split('\n').map(l=>l.trim()).filter(Boolean).slice(0,50);
  const btn = document.getElementById('pdf-bulk-btn');
  if(btn){ btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Building...'; }

  for(const kw of kws){
    const title = `The Complete Guide to ${kw} (2025)`;
    const job = { id:uid(), keyword:kw, title, template:tpl, platform:plat, backlinks:bls, density, status:'queued', log:[], ts:new Date().toLocaleTimeString(), uploadUrl:null };
    PDF_STATE.jobs.unshift(job);
    pdfRenderTable();
    await pdfBuildJob(job.id);
    await sleep(200);
  }

  if(btn){ btn.disabled=false; btn.innerHTML='âš¡ Build All PDFs'; }
  pdfUpdateStats();
}

/* â”€â”€ Stats â”€â”€ */
function pdfUpdateStats(){
  const total   = PDF_STATE.jobs.length;
  const ready   = PDF_STATE.jobs.filter(j=>j.status==='ready'||j.status==='live').length;
  const live    = PDF_STATE.jobs.filter(j=>j.status==='live').length;
  const words   = PDF_STATE.jobs.reduce((s,j)=>s+(j.wordCount||0),0);
  const el = id => document.getElementById(id);
  if(el('pdf-stat-total')) el('pdf-stat-total').textContent = total;
  if(el('pdf-stat-ready')) el('pdf-stat-ready').textContent = ready;
  if(el('pdf-stat-live'))  el('pdf-stat-live').textContent  = live;
  if(el('pdf-stat-words')) el('pdf-stat-words').textContent = words.toLocaleString();
}

/* â”€â”€ Render jobs table â”€â”€ */
function pdfRenderTable(){
  const wrap = document.getElementById('pdf-jobs-tbody');
  if(!wrap) return;
  if(!PDF_STATE.jobs.length){
    wrap.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted2);padding:28px;font-family:var(--mono);font-size:11px">No PDF jobs yet â€” build your first document above.</td></tr>`;
    return;
  }
  wrap.innerHTML = PDF_STATE.jobs.map(job=>`<tr id="pdf-job-${job.id}"></tr>`).join('');
  PDF_STATE.jobs.forEach(job=>pdfRefreshJobRow(job.id));
}

/* â”€â”€ Preview HTML in modal â”€â”€ */
function pdfPreview(){
  const kw    = (document.getElementById('pdf-keyword')||{value:''}).value.trim() || 'example keyword';
  const title = (document.getElementById('pdf-title')||{value:''}).value.trim()   || `The Complete Guide to ${kw}`;
  const tpl   = (document.getElementById('pdf-template')||{value:'guide'}).value;
  const bls   = (document.getElementById('pdf-backlinks')||{value:''}).value.trim();
  const dens  = (document.getElementById('pdf-density')||{value:'rich'}).value;
  const html  = pdfBuildHTML(kw, title, tpl, bls, dens);

  const overlay = document.createElement('div');
  overlay.className='modal-overlay';
  overlay.onclick = e=>{ if(e.target===overlay) overlay.remove(); };
  overlay.innerHTML = `<div class="modal-box" style="min-width:80vw;max-width:95vw;max-height:90vh;overflow-y:auto">
    <div class="modal-title">ğŸ‘ PDF Document Preview â€” ${esc(kw)}
      <button class="btn btn-ghost btn-xs" onclick="this.closest('.modal-overlay').remove()">âœ• Close</button>
    </div>
    <iframe srcdoc="${html.replace(/"/g,'&quot;')}" style="width:100%;height:65vh;border:1px solid var(--border);border-radius:8px"></iframe>
    <div class="row mt8">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Close</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

/* â”€â”€ Export all live jobs as CSV â”€â”€ */
function pdfExportCSV(){
  const rows = PDF_STATE.jobs.filter(j=>j.status==='live'||j.status==='ready');
  if(!rows.length){ alert('No ready/live jobs to export.'); return; }
  const csv = ['Keyword,Title,Platform,Template,Status,Words,Upload URL']
    .concat(rows.map(j=>`"${j.keyword}","${j.title}","${j.platform}","${j.template}","${j.status}","${j.wordCount||0}","${j.uploadUrl||''}"`))
    .join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = 'pdf-parasite-jobs.csv';
  a.click();
}

/* â”€â”€ RENDER PAGE â”€â”€ */
function renderPDFParasitePage(){
  const el = document.getElementById('page-pdf_parasite');
  if(!el) return;

  const platOptions = PDF_PLATFORMS.map(p=>`<option value="${p.id}">${p.icon} ${p.name} (DA ${p.da})</option>`).join('');
  const tplOptions  = Object.entries(PDF_TEMPLATES).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('');
  const densOptions = `<option value="thin">Thin (~80 w/section)</option><option value="rich" selected>Rich (~180 w/section)</option><option value="ultra">Ultra (~320 w/section)</option>`;

  el.innerHTML = `
  <div class="page-title">ğŸ“„ PDF Parasite Uploader</div>
  <div class="page-sub">Build keyword-optimised PDF/HTML documents & upload to high-DA document platforms for Google rankings</div>

  <!-- HOW IT WORKS NOTICE -->
  <div class="notice notice-info" style="margin-bottom:16px">
    <strong>How PDF Parasite SEO Works:</strong> High-authority platforms like Scribd (DA 96), SlideShare (DA 95), and Academia.edu (DA 93) allow free document uploads. Google crawls and <strong>indexes these pages</strong>, and because of the platform's DA, well-optimised PDFs can <strong>rank for competitive keywords</strong> within days. This module builds a complete, LSI-rich HTML document, then opens the upload page so you can paste it directly.
  </div>

  <!-- STATS ROW -->
  <div class="grid4" style="margin-bottom:18px">
    <div class="stat b"><div class="stat-v" id="pdf-stat-total">0</div><div class="stat-l">Total Jobs</div></div>
    <div class="stat g"><div class="stat-v" id="pdf-stat-ready">0</div><div class="stat-l">Ready / Built</div></div>
    <div class="stat r"><div class="stat-v" id="pdf-stat-live">0</div><div class="stat-l">Uploaded Live</div></div>
    <div class="stat p"><div class="stat-v" id="pdf-stat-words">0</div><div class="stat-l">Total Words</div></div>
  </div>

  <div class="grid2" style="gap:18px">
    <!-- LEFT: SINGLE BUILD -->
    <div>
      <div class="card">
        <div class="card-title">ğŸ”¨ Single Document Builder</div>
        <div class="fg"><label class="lbl">Target Keyword <span style="color:var(--accent2)">*</span></label>
          <input type="text" id="pdf-keyword" placeholder="e.g. best SEO tools 2025"></div>
        <div class="fg"><label class="lbl">Document Title</label>
          <input type="text" id="pdf-title" placeholder="Auto-generated if blank"></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Content Template</label><select id="pdf-template">${tplOptions}</select></div>
          <div class="fg"><label class="lbl">Content Density</label><select id="pdf-density">${densOptions}</select></div>
        </div>
        <div class="fg"><label class="lbl">Upload Platform</label><select id="pdf-platform">${platOptions}</select></div>
        <div class="fg"><label class="lbl">Backlink URL (optional)</label>
          <input type="url" id="pdf-backlinks" placeholder="https://yoursite.com/target-page"></div>
        <div class="row mt8">
          <button class="btn btn-primary" onclick="pdfAddJob()">âš¡ Build Document</button>
          <button class="btn btn-ghost" onclick="pdfPreview()">ğŸ‘ Preview</button>
        </div>
      </div>

      <!-- PLATFORM GUIDE -->
      <div class="card">
        <div class="card-title">ğŸ“Š Platform Ranking Power</div>
        <div class="tw"><table>
          <thead><tr><th>Platform</th><th>DA</th><th>Free</th><th>Indexed</th><th>Method</th></tr></thead>
          <tbody>
            ${PDF_PLATFORMS.map(p=>`<tr>
              <td><span style="font-size:14px">${p.icon}</span> <strong>${p.name}</strong></td>
              <td><span class="badge ${p.da>=90?'badge-g':p.da>=80?'badge-b':'badge-y'}">${p.da}</span></td>
              <td>${p.freeUpload?'<span class="badge badge-g">âœ“ Free</span>':'<span class="badge badge-r">Paid</span>'}</td>
              <td>${p.indexed?'<span class="badge badge-g">âœ“ Yes</span>':'<span class="badge badge-y">Partial</span>'}</td>
              <td><span class="badge badge-p">${p.method}</span></td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      </div>
    </div>

    <!-- RIGHT: BULK + TERMINAL -->
    <div>
      <div class="card">
        <div class="card-title">âš¡ Bulk PDF Builder</div>
        <div class="notice notice-warn" style="margin-bottom:10px">Enter one keyword per line. Builds a full document for each. Limit 50 per run.</div>
        <div class="fg"><label class="lbl">Keywords (one per line)</label>
          <textarea id="pdf-bulk-kws" rows="7" placeholder="best SEO tools 2025&#10;affordable web hosting&#10;how to rank on Google&#10;local SEO tips&#10;..."></textarea></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Template</label><select id="pdf-bulk-tpl">${tplOptions}</select></div>
          <div class="fg"><label class="lbl">Density</label><select id="pdf-bulk-density">${densOptions}</select></div>
        </div>
        <div class="fg"><label class="lbl">Platform</label><select id="pdf-bulk-platform">${platOptions}</select></div>
        <div class="fg"><label class="lbl">Backlink URL (applied to all)</label>
          <input type="url" id="pdf-bulk-backlinks" placeholder="https://yoursite.com/"></div>
        <button id="pdf-bulk-btn" class="btn btn-primary" style="width:100%;margin-top:8px" onclick="pdfBulkAdd()">âš¡ Build All PDFs</button>
      </div>

      <!-- STRATEGY BOX -->
      <div class="card">
        <div class="card-title">ğŸ§  PDF Parasite Strategy Guide</div>
        <div style="font-family:var(--mono);font-size:11px;line-height:1.9;color:var(--muted2)">
          <div style="margin-bottom:8px"><span class="badge badge-g">STEP 1</span> <strong style="color:var(--text)">Keyword Research</strong> â€” target informational & commercial keywords with DA &lt; 50 sites on page 1. PDFs rank fastest for "<em>best X</em>", "<em>guide to X</em>", "<em>how to X</em>" queries.</div>
          <div style="margin-bottom:8px"><span class="badge badge-b">STEP 2</span> <strong style="color:var(--text)">Build Rich Content</strong> â€” use <em>Ultra density</em> for competitive KWs. Include LSI keywords naturally. Add a table of contents (Google uses it for featured snippets).</div>
          <div style="margin-bottom:8px"><span class="badge badge-p">STEP 3</span> <strong style="color:var(--text)">Upload to Top Platforms</strong> â€” Scribd â†’ SlideShare â†’ Academia in that order. Each upload = a new indexed URL. Duplicate content is fine across platforms for parasite SEO.</div>
          <div style="margin-bottom:8px"><span class="badge badge-y">STEP 4</span> <strong style="color:var(--text)">Optimise Metadata</strong> â€” on each platform, use your exact keyword in the title, description (first 150 chars), and tags. Most platforms allow 10â€“15 keyword tags.</div>
          <div style="margin-bottom:8px"><span class="badge badge-r">STEP 5</span> <strong style="color:var(--text)">Build Tier-2 Links</strong> â€” point cheap backlinks (Web 2.0s, forum profiles, social bookmarks) to your uploaded PDF URLs, not your main site. This pushes the parasite pages to rank.</div>
          <div><span class="badge badge-g">STEP 6</span> <strong style="color:var(--text)">Monitor & Scale</strong> â€” once a PDF ranks, embed your target URL inside it (the backlink field above). Traffic flows from the PDF to your site. Build 3â€“5 PDFs per keyword cluster.</div>
        </div>
      </div>

      <!-- TERMINAL -->
      <div class="card">
        <div class="card-title">ğŸ–¥ Build Log</div>
        <div class="terminal" id="pdf-terminal">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">PDF Parasite Uploader v1.0 ready. Build your first document above.</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JOBS TABLE -->
  <div class="card" style="margin-top:0">
    <div class="card-title">ğŸ“‹ Document Jobs Queue
      <button class="btn btn-ghost btn-xs" style="margin-left:auto" onclick="pdfExportCSV()">ğŸ“¥ Export CSV</button>
    </div>
    <div class="tw"><table>
      <thead><tr><th>Time</th><th>Keyword / Title</th><th>Platform</th><th>Template</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="pdf-jobs-tbody">
        <tr><td colspan="6" style="text-align:center;color:var(--muted2);padding:28px;font-family:var(--mono);font-size:11px">No PDF jobs yet.</td></tr>
      </tbody>
    </table></div>
  </div>`;

  pdfUpdateStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROXY MANAGER MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PROXY_STATE = {
  proxies: JSON.parse(localStorage.getItem('pm_proxies')||'[]'),
  scanning: false,
  testing: false,
  activeProxy: null,
  scanLog: [],
};

const PROXY_SOURCES = [
  // â”€â”€ TIER 1: API sources with native western-country filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name:'ProxyScrape v2 HTTP Elite',  url:'https://api.proxyscrape.com/v2/?request=getproxies&protocol=http&timeout=5000&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH,AT,BE,DK,FI,IE,IT,NZ,PT,ES&ssl=all&anonymity=elite', format:'plain' },
  { name:'ProxyScrape v2 HTTPS Elite', url:'https://api.proxyscrape.com/v2/?request=getproxies&protocol=https&timeout=5000&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH,AT,BE,DK,FI,IE,IT,NZ,PT,ES&ssl=all&anonymity=elite', format:'plain' },
  { name:'ProxyScrape v2 SOCKS5',      url:'https://api.proxyscrape.com/v2/?request=getproxies&protocol=socks5&timeout=5000&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH,AT,BE,DK,FI,IE&ssl=all&anonymity=all', format:'plain' },
  { name:'ProxyScrape v3 HTTP',        url:'https://api.proxyscrape.com/v3/free-proxy-list/get?request=displayproxies&protocol=http&proxy_format=protocolipport&format=text&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH&timeout=5000&anonymity=Elite', format:'plain-protocol' },
  { name:'GeoNode Fast Elite p1',      url:'https://proxylist.geonode.com/api/proxy-list?limit=500&page=1&sort_by=speed&sort_type=asc&protocols=http,https&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH,AT,BE,DK,FI,IE&anonymityLevel=elite,anonymous', format:'geonode' },
  { name:'GeoNode Fast Elite p2',      url:'https://proxylist.geonode.com/api/proxy-list?limit=500&page=2&sort_by=speed&sort_type=asc&protocols=http,https&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH,AT,BE,DK,FI,IE&anonymityLevel=elite,anonymous', format:'geonode' },
  { name:'ProxyList HTTPS Elite',      url:'https://www.proxy-list.download/api/v1/get?type=https&anon=elite&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH', format:'plain' },
  { name:'ProxyList HTTP Elite',       url:'https://www.proxy-list.download/api/v1/get?type=http&anon=elite&country=US,GB,CA,DE,FR,NL,AU,SE,NO,CH', format:'plain' },
  { name:'OpenProxy Space HTTP',       url:'https://openproxy.space/list/http', format:'plain', geoFilter:true },
  { name:'OpenProxy Space SOCKS5',     url:'https://openproxy.space/list/socks5', format:'plain', geoFilter:true },
  // â”€â”€ TIER 2: HTML-scraped sources (western-biased) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { name:'Free-Proxy-List.net',        url:'https://free-proxy-list.net/', format:'html-table' },
  { name:'SSL Proxies (.org)',          url:'https://www.sslproxies.org/', format:'html-table' },
  { name:'US Proxy List',              url:'https://www.us-proxy.org/', format:'html-table' },
  // â”€â”€ TIER 3: GitHub raw lists (global â€” geo-filtered post-parse via ip-api batch) â”€â”€â”€â”€â”€â”€
  { name:'TheSpeedX HTTP',             url:'https://raw.githubusercontent.com/TheSpeedX/PROXY-List/master/http.txt', format:'plain', geoFilter:true },
  { name:'TheSpeedX SOCKS5',           url:'https://raw.githubusercontent.com/TheSpeedX/PROXY-List/master/socks5.txt', format:'plain', geoFilter:true },
  { name:'clarketm List',              url:'https://raw.githubusercontent.com/clarketm/proxy-list/master/proxy-list-raw.txt', format:'plain', geoFilter:true },
  { name:'MuRongPIG HTTP',             url:'https://raw.githubusercontent.com/MuRongPIG/Proxy-Master/main/http.txt', format:'plain', geoFilter:true },
  { name:'roosterkid HTTPS',           url:'https://raw.githubusercontent.com/roosterkid/openproxylist/main/HTTPS_RAW.txt', format:'plain', geoFilter:true },
  { name:'ObsiProxy HTTP',             url:'https://raw.githubusercontent.com/ObsiProxy/Proxy-List/main/proxy-list/http.txt', format:'plain', geoFilter:true },
  { name:'proxy4parsing HTTP',         url:'https://raw.githubusercontent.com/proxy4parsing/proxy-list/main/http.txt', format:'plain', geoFilter:true },
  { name:'Anonym0usWork HTTP',         url:'https://raw.githubusercontent.com/Anonym0usWork1221/Free-Proxies/main/proxy_files/http_proxies.txt', format:'plain', geoFilter:true },
];

const WESTERN_CC = ['US','GB','CA','DE','FR','NL','AU','SE','NO','CH','AT','BE','DK','FI','IE','IT','NZ','PT','ES'];
const CORS_PROXIES_LIST = ['https://corsproxy.io/?','https://api.allorigins.win/raw?url=','https://proxy.cors.sh/'];
let _cpIdx=0;
function pmCorsUrl(u){ return CORS_PROXIES_LIST[_cpIdx%CORS_PROXIES_LIST.length]+encodeURIComponent(u); }
function pmNextCors(){ _cpIdx++; }
function pmSave(){ try{localStorage.setItem('pm_proxies',JSON.stringify(PROXY_STATE.proxies));}catch(e){} }

function pmLog(msg,type='info'){
  const t=new Date().toLocaleTimeString('en-US',{hour12:false});
  const el=document.getElementById('pm-terminal');
  if(el){
    const cls=type==='error'?'t-error':type==='warn'?'t-warn':type==='success'?'t-info':'t-accent';
    el.innerHTML=`<div class="tline"><span class="ttime">${t}</span><span class="${cls}">${msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span></div>`+el.innerHTML;
  }
  const b=document.getElementById('proxy-badge');
  if(b) b.textContent=PROXY_STATE.proxies.filter(p=>p.status==='alive').length||PROXY_STATE.proxies.length||0;
}

// â”€â”€ Country code â†’ emoji flag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pmFlag(cc){ try{ return cc?String.fromCodePoint(...[...cc.toUpperCase()].map(c=>0x1F1E0+c.charCodeAt(0)-65)):'' }catch(e){return '';} }

// â”€â”€ ip-api.com batch geo-lookup (100 IPs per call, 15 req/min free) â”€â”€
async function pmGeoFilter(proxies){
  if(!proxies.length) return [];
  const out = [];
  const BATCH = 100;
  for(let i=0; i<proxies.length; i+=BATCH){
    const batch = proxies.slice(i, i+BATCH);
    try{
      const body = JSON.stringify(batch.map(p=>({query:p.ip, fields:'status,countryCode'})));
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent('http://ip-api.com/batch?fields=status,countryCode'),
        {method:'POST',headers:{'Content-Type':'application/json'},body,signal:AbortSignal.timeout(10000)});
      if(r.ok){
        const data = await r.json();
        data.forEach((d,idx)=>{
          const cc = (d.status==='success'&&d.countryCode)||'';
          if(!cc||WESTERN_CC.includes(cc)){
            batch[idx].country = cc;
            batch[idx].flag = pmFlag(cc);
            out.push(batch[idx]);
          }
        });
      } else { out.push(...batch); } // fallback: keep all if API fails
    }catch(e){ out.push(...batch); }
    await sleep(200); // respect 15 req/min
  }
  return out;
}

function pmParse(text,format,src){
  const out=[];
  if(format==='plain'){
    text.split(/[\r\n]+/).forEach(l=>{
      l=l.trim();
      if(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d+$/.test(l)){
        const[ip,port]=l.split(':');
        out.push({id:uid(),ip,port:+port,protocol:'http',country:'',flag:'',anonymity:'',status:'untested',speed:null,source:src,added:Date.now(),lastTest:null,failCount:0});
      }
    });
  } else if(format==='plain-protocol'){
    // ProxyScrape v3 format: "http://1.2.3.4:8080" or "socks5://1.2.3.4:1080"
    text.split(/[\r\n]+/).forEach(l=>{
      l=l.trim();
      const m=l.match(/^(https?|socks[45]):\/\/(\d{1,3}(?:\.\d{1,3}){3}):(\d+)/i);
      if(m){
        out.push({id:uid(),ip:m[2],port:+m[3],protocol:m[1].toLowerCase(),country:'',flag:'',anonymity:'',status:'untested',speed:null,source:src,added:Date.now(),lastTest:null,failCount:0});
      }
    });
  } else if(format==='geonode'){
    try{
      const j=JSON.parse(text);
      (j.data||[]).forEach(p=>{
        const cc = p.country||'';
        if(!cc||WESTERN_CC.includes(cc)){
          const anon = (p.anonymityLevel||'').toLowerCase(); // elite, anonymous, transparent
          out.push({id:uid(),ip:p.ip,port:+p.port,protocol:(p.protocols||['http'])[0],country:cc,flag:pmFlag(cc),anonymity:anon,speed:p.speed?+p.speed:null,status:'untested',source:src,added:Date.now(),lastTest:null,failCount:0});
        }
      });
    }catch(e){}
  } else if(format==='html-table'){
    // free-proxy-list.net / sslproxies.org: IP, Port, Code, Country, Anonymity, Google, HTTPS, Last Checked
    (text.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi)||[]).forEach(row=>{
      const cells=(row.match(/<td[^>]*>([\s\S]*?)<\/td>/gi)||[]).map(c=>c.replace(/<[^>]+>/g,'').trim());
      if(cells.length>=2&&/^\d+\.\d+\.\d+\.\d+$/.test(cells[0])&&/^\d+$/.test(cells[1])){
        const cc=(cells[2]||'').slice(0,2).toUpperCase();
        if(!cc||WESTERN_CC.includes(cc)){
          const anon=(cells[4]||'').toLowerCase().includes('elite')?'elite':(cells[4]||'').toLowerCase().includes('anonymous')?'anonymous':'transparent';
          out.push({id:uid(),ip:cells[0],port:+cells[1],protocol:(cells[6]||'').toUpperCase()==='YES'?'https':'http',country:cc,flag:pmFlag(cc),anonymity:anon,status:'untested',speed:null,source:src,added:Date.now(),lastTest:null,failCount:0});
        }
      }
    });
  }
  return out;
}

function pmDedupe(arr){
  const seen=new Set(PROXY_STATE.proxies.map(p=>p.ip+':'+p.port));
  return arr.filter(p=>!seen.has(p.ip+':'+p.port));
}

async function pmFetchSrc(src){
  pmLog('Fetching '+src.name+'...');
  const urls = src.url.startsWith('http')?[src.url]:[src.url];
  const tryUrls = [src.url, pmCorsUrl(src.url)];
  for(const url of tryUrls){
    try{
      const r=await smartFetch(url,{method:'GET',sfTimeout:15000});
      if(!r.ok) continue;
      const text=await r.text();
      let proxies=pmParse(text,src.format,src.name);
      if(!proxies.length) continue;
      // For GitHub/global lists tagged with geoFilter, batch-lookup and filter to western CCs
      if(src.geoFilter && proxies.length){
        pmLog('  â†’ Geo-filtering '+proxies.length+' entries via ip-api.com batch...');
        proxies = await pmGeoFilter(proxies);
        pmLog('  â†’ '+proxies.length+' western proxies retained after geo-filter');
      }
      if(proxies.length){pmLog('âœ” '+src.name+': '+proxies.length+' found','success');return proxies;}
    }catch(e){pmNextCors();}
  }
  pmLog('FAIL '+src.name,'warn');
  return[];
}

async function pmScanAll(){
  if(PROXY_STATE.scanning){pmLog('Already scanning...','warn');return;}
  PROXY_STATE.scanning=true;
  pmUpdateScanBtn(true);
  pmLog('Starting scan across '+PROXY_SOURCES.length+' sources...');
  let total=0;
  for(const src of PROXY_SOURCES){
    if(!PROXY_STATE.scanning) break;
    const proxies=await pmFetchSrc(src);
    const fresh=pmDedupe(proxies);
    PROXY_STATE.proxies.push(...fresh);
    total+=fresh.length;
    pmSave();pmRenderTable();pmUpdateStats();
    await sleep(300);
  }
  PROXY_STATE.scanning=false;
  pmUpdateScanBtn(false);
  pmLog('Scan done. '+total+' new proxies. Total: '+PROXY_STATE.proxies.length,'success');
  pmRenderTable();
}
function pmStopScan(){PROXY_STATE.scanning=false;pmUpdateScanBtn(false);pmLog('Scan stopped.','warn');}

async function pmTestProxy(p){
  const start=Date.now();
  // Try reliable test endpoints in cascade
  const testUrls=[
    'https://api.ipify.org?format=json',
    'https://ipecho.net/plain',
    'https://checkip.amazonaws.com/',
  ];
  for(const testUrl of testUrls){
    try{
      const r=await fetch('https://corsproxy.io/?'+encodeURIComponent(testUrl),{signal:AbortSignal.timeout(8000)});
      if(r.ok){
        const ms=Date.now()-start;
        p.speed=ms;
        p.status='alive';
        p.speedLabel=ms<800?'fast':ms<2000?'medium':'slow';
        p.lastTest=Date.now();p.failCount=0;
        return true;
      }
    }catch(e){}
  }
  p.speed=null;p.status='dead';p.speedLabel='';p.lastTest=Date.now();p.failCount=(p.failCount||0)+1;
  return false;
}

async function pmTestAll(){
  if(PROXY_STATE.testing){pmLog('Already testing...','warn');return;}
  const list=PROXY_STATE.proxies.filter(p=>p.status==='untested'||p.status==='dead');
  if(!list.length){pmLog('No proxies to test.','warn');return;}
  PROXY_STATE.testing=true;
  const btn=document.getElementById('pm-test-btn');
  if(btn){btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Testing...';}
  pmLog('Testing '+list.length+' proxies (10 concurrent)...');
  let done=0,alive=0,dead=0;
  for(let i=0;i<list.length;i+=10){
    if(!PROXY_STATE.testing) break;
    await Promise.all(list.slice(i,i+10).map(async p=>{
      const ok=await pmTestProxy(p);
      done++;if(ok)alive++;else dead++;
    }));
    pmSave();pmRenderTable();pmUpdateStats();
    const prog=document.getElementById('pm-test-prog');
    if(prog) prog.style.width=Math.round(done/list.length*100)+'%';
    pmLog('Progress '+done+'/'+list.length+' â€” '+alive+' alive, '+dead+' dead');
    await sleep(100);
  }
  PROXY_STATE.testing=false;
  if(btn){btn.disabled=false;btn.innerHTML='ğŸ§ª Test All';}
  pmLog('Testing done: '+alive+' alive, '+dead+' dead','success');
  pmUpdateStats();
}
function pmStopTest(){PROXY_STATE.testing=false;pmLog('Testing stopped.','warn');}

async function pmTestSingle(id){
  const p=PROXY_STATE.proxies.find(x=>x.id===id);if(!p)return;
  p.status='testing';pmRefreshRow(id);
  await pmTestProxy(p);pmSave();pmRefreshRow(id);pmUpdateStats();
  pmLog(p.ip+':'+p.port+' â†’ '+p.status+(p.speed?' ('+p.speed+'ms)':''),p.status==='alive'?'success':'warn');
}

function pmSetActive(id){
  PROXY_STATE.activeProxy=id==='none'?null:PROXY_STATE.proxies.find(p=>p.id===id)||null;
  pmUpdateActiveDisplay();
  pmRenderTable();
  pmLog(PROXY_STATE.activeProxy?'Active proxy: '+PROXY_STATE.activeProxy.ip+':'+PROXY_STATE.activeProxy.port:'Active proxy cleared.','success');
}
function pmGetActiveProxy(){return PROXY_STATE.activeProxy;}

function pmRemove(id){
  PROXY_STATE.proxies=PROXY_STATE.proxies.filter(p=>p.id!==id);
  if(PROXY_STATE.activeProxy&&PROXY_STATE.activeProxy.id===id) PROXY_STATE.activeProxy=null;
  pmSave();pmRenderTable();pmUpdateStats();
}
function pmClearDead(){
  const b=PROXY_STATE.proxies.length;
  PROXY_STATE.proxies=PROXY_STATE.proxies.filter(p=>p.status!=='dead');
  pmSave();pmRenderTable();pmUpdateStats();
  pmLog('Removed '+(b-PROXY_STATE.proxies.length)+' dead proxies.','warn');
}
function pmClearAll(){
  if(!confirm('Clear ALL proxies?')) return;
  PROXY_STATE.proxies=[];PROXY_STATE.activeProxy=null;
  pmSave();pmRenderTable();pmUpdateStats();pmLog('All proxies cleared.','warn');
}
function pmAddManual(){
  const raw=(document.getElementById('pm-manual-input')||{value:''}).value.trim();
  const proto=(document.getElementById('pm-manual-proto')||{value:'http'}).value;
  if(!raw){alert('Enter IP:PORT');return;}
  let added=0;
  raw.split(/[\r\n,]+/).forEach(line=>{
    const m=line.trim().match(/^(\d+\.\d+\.\d+\.\d+):(\d+)$/);
    if(!m) return;
    if(PROXY_STATE.proxies.find(p=>p.ip===m[1]&&p.port===+m[2])) return;
    PROXY_STATE.proxies.push({id:uid(),ip:m[1],port:+m[2],protocol:proto,country:'',status:'untested',speed:null,source:'Manual',added:Date.now(),lastTest:null,failCount:0});
    added++;
  });
  pmSave();pmRenderTable();pmUpdateStats();pmLog('Added '+added+' manual proxies.','success');
  const inp=document.getElementById('pm-manual-input');if(inp)inp.value='';
}
function pmExportAlive(){
  const alive=PROXY_STATE.proxies.filter(p=>p.status==='alive');
  if(!alive.length){alert('No alive proxies.');return;}
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([alive.map(p=>p.protocol+'://'+p.ip+':'+p.port).join('\n')],{type:'text/plain'}));
  a.download='alive-proxies.txt';a.click();
}
function pmUpdateStats(){
  const t=PROXY_STATE.proxies.length;
  const a=PROXY_STATE.proxies.filter(p=>p.status==='alive').length;
  const d=PROXY_STATE.proxies.filter(p=>p.status==='dead').length;
  const u=PROXY_STATE.proxies.filter(p=>p.status==='untested').length;
  const sp=PROXY_STATE.proxies.filter(p=>p.speed).map(p=>p.speed);
  const avg=sp.length?Math.round(sp.reduce((a,b)=>a+b,0)/sp.length):0;
  const s=id=>document.getElementById(id);
  if(s('pm-stat-total')) s('pm-stat-total').textContent=t;
  if(s('pm-stat-alive')) s('pm-stat-alive').textContent=a;
  if(s('pm-stat-dead'))  s('pm-stat-dead').textContent=d;
  if(s('pm-stat-unt'))   s('pm-stat-unt').textContent=u;
  if(s('pm-stat-speed')) s('pm-stat-speed').textContent=avg?avg+'ms':'â€”';
  const b=document.getElementById('proxy-badge');
  if(b) b.textContent=a||t||0;
}
function pmUpdateActiveDisplay(){
  const el=document.getElementById('pm-active-display');if(!el) return;
  const p=PROXY_STATE.activeProxy;
  el.innerHTML=p
    ?`<span class="badge badge-g">ğŸŸ¢ ACTIVE</span> <strong>${p.protocol.toUpperCase()}://${p.ip}:${p.port}</strong> ${p.country?`<span class="badge badge-b">${p.country}</span>`:''} ${p.speed?`<span class="badge badge-y">${p.speed}ms</span>`:''}`
    :`<span class="badge badge-r">No Active Proxy</span> <span class="xs tm">â€” requests use direct connection</span>`;
}
function pmUpdateScanBtn(sc){
  const b=document.getElementById('pm-scan-btn');
  const s=document.getElementById('pm-stop-btn');
  if(b){b.disabled=sc;b.innerHTML=sc?'<span class="spinner"></span> Scanning...':'ğŸ” Scan All Sources';}
  if(s) s.style.display=sc?'':'none';
}
function pmRefreshRow(id){
  const p=PROXY_STATE.proxies.find(x=>x.id===id);if(!p)return;
  const row=document.getElementById('pm-row-'+id);if(!row)return;
  const isActive=PROXY_STATE.activeProxy&&PROXY_STATE.activeProxy.id===id;
  const sb={alive:'<span class="badge badge-g">âœ… Alive</span>',dead:'<span class="badge badge-r">âŒ Dead</span>',untested:'<span class="badge badge-y">â³ Untested</span>',testing:'<span class="badge badge-b"><span class="spinner"></span> Testing</span>'}[p.status]||p.status;
  const anonBadge=p.anonymity==='elite'?'<span class="badge badge-g" style="font-size:8px">ELITE</span>':p.anonymity==='anonymous'?'<span class="badge badge-b" style="font-size:8px">ANON</span>':p.anonymity?'<span class="badge" style="font-size:8px;background:#555;color:#fff">TRANSP</span>':'';
  const speedBadge=p.speed?(p.speedLabel==='fast'?'<span class="badge badge-g">ğŸŸ¢ '+p.speed+'ms</span>':p.speedLabel==='medium'?'<span class="badge badge-y">ğŸŸ¡ '+p.speed+'ms</span>':'<span class="badge badge-r">ğŸ”´ '+p.speed+'ms</span>'):'-';
  row.innerHTML=`<td>${isActive?'<span class="badge badge-g">â˜…</span>':''}</td>
    <td class="mono" style="font-weight:700">${p.ip}:${p.port}</td>
    <td><span class="badge badge-p">${p.protocol.toUpperCase()}</span></td>
    <td>${p.flag||''} ${p.country?`<span class="badge badge-b">${p.country}</span>`:'-'}</td>
    <td>${anonBadge||'-'}</td>
    <td>${sb}</td>
    <td>${speedBadge}</td>
    <td class="xs tm">${p.source||''}</td>
    <td>
      <button class="btn btn-primary btn-xs" onclick="pmSetActive('${p.id}')">â˜… Use</button>
      <button class="btn btn-ghost btn-xs" onclick="pmTestSingle('${p.id}')">ğŸ§ª</button>
      <button class="btn btn-danger btn-xs" onclick="pmRemove('${p.id}')">âœ•</button>
    </td>`;
}
function pmRenderTable(){
  const tbody=document.getElementById('pm-tbody');if(!tbody)return;
  const filter=(document.getElementById('pm-filter')||{value:'all'}).value;
  const search=((document.getElementById('pm-search')||{value:''}).value||'').toLowerCase();
  let list=[...PROXY_STATE.proxies];
  if(filter==='alive') list=list.filter(p=>p.status==='alive');
  if(filter==='dead')  list=list.filter(p=>p.status==='dead');
  if(filter==='untested') list=list.filter(p=>p.status==='untested');
  if(filter==='elite') list=list.filter(p=>p.anonymity==='elite');
  if(search) list=list.filter(p=>(p.ip+':'+p.port+' '+p.country+' '+p.source+' '+p.anonymity).toLowerCase().includes(search));
  // Sort: alive first â†’ elite anon first â†’ fastest speed
  list.sort((a,b)=>{
    const ss=p=>p.status==='alive'?0:p.status==='untested'?1:2;
    if(ss(a)!==ss(b)) return ss(a)-ss(b);
    const as=p=>p.anonymity==='elite'?0:p.anonymity==='anonymous'?1:2;
    if(as(a)!==as(b)) return as(a)-as(b);
    return (a.speed||9999)-(b.speed||9999);
  });
  if(!list.length){tbody.innerHTML=`<tr><td colspan="9" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No proxies found. Click Scan All Sources.</td></tr>`;return;}
  tbody.innerHTML=list.slice(0,500).map(p=>`<tr id="pm-row-${p.id}"></tr>`).join('');
  list.slice(0,500).forEach(p=>pmRefreshRow(p.id));
}
function renderProxyManagerPage(){
  const el=document.getElementById('page-proxy_manager');if(!el)return;
  el.innerHTML=`
  <div class="page-title">ğŸ›¡ Proxy Manager v2 â€” Western Countries Only</div>
  <div class="page-sub">22 premium sources Â· Geo-batch filtering via ip-api.com Â· Elite anonymity priority Â· Speed classification Â· Auto-dedup</div>
  <div class="notice notice-info" style="margin-bottom:16px"><strong>How it works:</strong> Scans ${PROXY_SOURCES.length} curated sources. Tier 1 APIs filter by country at source. GitHub lists are geo-batch-checked via ip-api.com (100 IPs/call) â€” only US/UK/CA/DE/FR/NL/AU/SE/NO/CH/AT/BE/DK/FI/IE/IT/NZ/PT/ES retained. Tests each against 3 reliable endpoints. Speed-classified: ğŸŸ¢ Fast &lt;800ms Â· ğŸŸ¡ Medium &lt;2s Â· ğŸ”´ Slow.</div>
  <div class="card" style="margin-bottom:14px;padding:14px 20px"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <span style="font-family:var(--mono);font-size:10px;color:var(--muted2);font-weight:700;text-transform:uppercase;letter-spacing:.08em">Active Proxy:</span>
    <span id="pm-active-display"></span>
    <button class="btn btn-ghost btn-xs" onclick="pmSetActive('none')" style="margin-left:auto">âœ• Clear Active</button>
  </div></div>
  <div class="grid5" style="margin-bottom:16px">
    <div class="stat b"><div class="stat-v" id="pm-stat-total">0</div><div class="stat-l">Total</div></div>
    <div class="stat g"><div class="stat-v" id="pm-stat-alive">0</div><div class="stat-l">Alive</div></div>
    <div class="stat r"><div class="stat-v" id="pm-stat-dead">0</div><div class="stat-l">Dead</div></div>
    <div class="stat y"><div class="stat-v" id="pm-stat-unt">0</div><div class="stat-l">Untested</div></div>
    <div class="stat p"><div class="stat-v" id="pm-stat-speed">â€”</div><div class="stat-l">Avg Speed</div></div>
  </div>
  <div class="grid2" style="gap:16px">
    <div>
      <div class="card">
        <div class="card-title">ğŸ” Scanner Controls</div>
        <div class="notice notice-warn" style="margin-bottom:12px">${PROXY_SOURCES.length} sources Â· Western countries only Â· ip-api.com geo-batch filter Â· Elite proxy priority</div>
        <div class="row" style="flex-wrap:wrap;gap:8px">
          <button id="pm-scan-btn" class="btn btn-primary" onclick="pmScanAll()">ğŸ” Scan All Sources</button>
          <button id="pm-stop-btn" class="btn btn-danger" onclick="pmStopScan()" style="display:none">â¹ Stop Scan</button>
          <button id="pm-test-btn" class="btn btn-blue" onclick="pmTestAll()">ğŸ§ª Test All</button>
          <button class="btn btn-ghost" onclick="pmClearDead()">ğŸ—‘ Remove Dead</button>
          <button class="btn btn-ghost" onclick="pmExportAlive()">ğŸ“¥ Export Alive</button>
          <button class="btn btn-danger btn-sm" onclick="pmClearAll()">âš  Clear All</button>
        </div>
        <div class="prog-wrap mt8"><div class="prog-fill" id="pm-test-prog"></div></div>
      </div>
      <div class="card">
        <div class="card-title">â• Add Manual Proxies</div>
        <div class="fg"><label class="lbl">IP:Port (one per line)</label>
          <textarea id="pm-manual-input" rows="4" placeholder="192.168.1.1:8080&#10;10.0.0.1:3128"></textarea></div>
        <div class="fg"><label class="lbl">Protocol</label>
          <select id="pm-manual-proto"><option value="http">HTTP</option><option value="https">HTTPS</option><option value="socks4">SOCKS4</option><option value="socks5">SOCKS5</option></select></div>
        <button class="btn btn-primary btn-sm" onclick="pmAddManual()">â• Add Proxies</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“¡ Scan Sources (${PROXY_SOURCES.length})</div>
        <div style="max-height:320px;overflow-y:auto">
        ${PROXY_SOURCES.map((s,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-family:var(--mono);font-size:10px">
          <span style="color:var(--muted2);width:16px;text-align:right;flex-shrink:0">${i+1}</span>
          <div style="flex:1"><div style="font-weight:700">${s.name}</div>
          <div style="font-size:9px;color:var(--muted2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:280px">${s.url.substring(0,58)}â€¦</div></div>
          <span class="badge badge-p">${s.format}</span>
          ${s.geoFilter?'<span class="badge badge-b" style="font-size:8px">GEOâœ“</span>':''}</div>`).join('')}
        </div>
      </div>
    </div>
    <div>
      <div class="card"><div class="card-title">ğŸ–¥ Scan Log</div>
        <div class="terminal" id="pm-terminal" style="height:200px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Proxy Manager v2 ready. Click Scan All Sources to find western proxies.</span></div>
        </div>
      </div>
      <div class="card" style="padding:14px 18px"><div class="row" style="flex-wrap:wrap;gap:8px">
        <div style="flex:1;min-width:140px"><label class="lbl">Filter</label>
          <select id="pm-filter" onchange="pmRenderTable()">
            <option value="all">All</option><option value="alive">Alive</option>
            <option value="elite">Elite Only</option>
            <option value="dead">Dead</option><option value="untested">Untested</option>
          </select></div>
        <div style="flex:2;min-width:160px"><label class="lbl">Search</label>
          <input type="text" id="pm-search" placeholder="IP, country, source, elite..." oninput="pmRenderTable()"></div>
      </div></div>
      <div class="card" style="padding:0;overflow:hidden">
        <div class="tw" style="max-height:440px;overflow-y:auto"><table>
          <thead><tr><th></th><th>IP:Port</th><th>Proto</th><th>Country</th><th>Anon</th><th>Status</th><th>Speed</th><th>Source</th><th>Actions</th></tr></thead>
          <tbody id="pm-tbody"><tr><td colspan="9" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No proxies yet. Click Scan All Sources.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  pmUpdateStats();pmUpdateActiveDisplay();pmRenderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART PDF UPLOADER MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const UPLOADER_STATE={
  jobs: JSON.parse(localStorage.getItem('pu_jobs')||'[]'),
  siteCache: JSON.parse(localStorage.getItem('pu_sites')||'{}'),
};
function puSave(){
  try{localStorage.setItem('pu_jobs',JSON.stringify(UPLOADER_STATE.jobs));}catch(e){}
  try{localStorage.setItem('pu_sites',JSON.stringify(UPLOADER_STATE.siteCache));}catch(e){}
}

const PU_KNOWN={
  'scribd.com':       {name:'Scribd',         icon:'ğŸ“š',da:96,uploadPage:'https://www.scribd.com/upload-document',        uploadUrl:'https://www.scribd.com/upload-document',       pdfSupport:true, freeAccount:true, notes:'DA 96 Â· Free Â· Auto-indexes on Google'},
  'issuu.com':        {name:'Issuu',           icon:'ğŸ“°',da:92,uploadPage:'https://issuu.com/home/publish',                uploadUrl:'https://issuu.com/home/publish',               pdfSupport:true, freeAccount:true, notes:'DA 92 Â· Free flipbook publisher'},
  'slideshare.net':   {name:'SlideShare',      icon:'ğŸ“Š',da:95,uploadPage:'https://www.slideshare.net/upload',             uploadUrl:'https://www.slideshare.net/upload',            pdfSupport:true, freeAccount:true, notes:'DA 95 Â· LinkedIn owned'},
  'academia.edu':     {name:'Academia.edu',    icon:'ğŸ“',da:93,uploadPage:'https://www.academia.edu/upload',               uploadUrl:'https://www.academia.edu/upload',              pdfSupport:true, freeAccount:true, notes:'DA 93 Â· Academic papers'},
  'researchgate.net': {name:'ResearchGate',    icon:'ğŸ”¬',da:91,uploadPage:'https://www.researchgate.net/publication/upload',uploadUrl:'https://www.researchgate.net/publication/upload',pdfSupport:true,freeAccount:true, notes:'DA 91 Â· Research preprints'},
  'archive.org':      {name:'Internet Archive',icon:'ğŸ›ï¸',da:94,uploadPage:'https://archive.org/upload/',                  uploadUrl:'https://s3.us.archive.org',                    pdfSupport:true, freeAccount:true, notes:'DA 94 Â· S3 API Â· Permanent URLs'},
  'calameo.com':      {name:'Calameo',         icon:'ğŸ“–',da:88,uploadPage:'https://en.calameo.com/publish/',               uploadUrl:'https://en.calameo.com/publish/',              pdfSupport:true, freeAccount:true, notes:'DA 88 Â· Flipbook publisher'},
  'yumpu.com':        {name:'Yumpu',           icon:'ğŸ“—',da:82,uploadPage:'https://www.yumpu.com/en/upload',               uploadUrl:'https://www.yumpu.com/en/upload',              pdfSupport:true, freeAccount:true, notes:'DA 82 Â· ePub platform'},
  'edocr.com':        {name:'edocr',           icon:'ğŸ“‚',da:73,uploadPage:'https://www.edocr.com/upload',                  uploadUrl:'https://www.edocr.com/upload',                 pdfSupport:true, freeAccount:true, notes:'DA 73 Â· Document sharing'},
  'slideserve.com':   {name:'SlideServe',      icon:'ğŸ',da:79,uploadPage:'https://www.slideserve.com/upload',             uploadUrl:'https://www.slideserve.com/upload',            pdfSupport:true, freeAccount:true, notes:'DA 79 Â· Slides + PDF'},
  'box.com':          {name:'Box.com',         icon:'ğŸ“¦',da:90,uploadPage:'https://app.box.com/',                          uploadUrl:'https://upload.box.com/api/2.0/files/content', pdfSupport:true, freeAccount:true, notes:'DA 90 Â· Shared links indexed'},
  'docdroid.net':     {name:'DocDroid',        icon:'ğŸ—„ï¸',da:70,uploadPage:'https://www.docdroid.net/upload',              uploadUrl:'https://www.docdroid.net/upload',              pdfSupport:true, freeAccount:true, notes:'DA 70 Â· Anonymous upload ok'},
};

function puLogGlobal(msg,type='info'){
  const el=document.getElementById('pu-terminal');if(!el)return;
  const cls=type==='error'?'t-error':type==='warn'?'t-warn':type==='success'?'t-info':'t-accent';
  el.innerHTML=`<div class="tline"><span class="ttime">${ts()}</span><span class="${cls}">${msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span></div>`+el.innerHTML;
}
function puLog(jobId,msg,type='info'){
  const job=UPLOADER_STATE.jobs.find(j=>j.id===jobId);
  if(job){job.log=job.log||[];job.log.push({t:ts(),msg,type});}
  puLogGlobal(msg,type);
}

async function puScanSite(rawUrl){
  let url=rawUrl.trim();
  if(!/^https?:\/\//i.test(url)) url='https://'+url;
  url=url.replace(/\/+$/,'');
  const domain=url.replace(/^https?:\/\//,'').split('/')[0].replace(/^www\./,'');
  const known=PU_KNOWN[domain]||Object.entries(PU_KNOWN).find(([k])=>domain.endsWith(k))?.[1];
  if(known) return{status:'known',domain,url,platform:known,pdfSupport:true,message:'Known platform: '+known.name+' (DA '+known.da+') â€” PDF upload supported'};
  puLogGlobal('Scanning '+domain+' for PDF support...');
  try{
    const r=await fetch('https://corsproxy.io/?'+encodeURIComponent(url),{signal:AbortSignal.timeout(12000)});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const html=await r.text();
    const fileInputs=(html.match(/<input[^>]+type=.file.[^>]*>/gi)||[]);
    const pdfInputs=fileInputs.filter(i=>/accept[^>]*(pdf|application)/i.test(i));
    const imgOnly=fileInputs.filter(i=>/accept[^>]*image/i.test(i)&&!/pdf/i.test(i));
    const hasMPForm=/enctype=.multipart\/form-data./i.test(html);
    const hasDropzone=/dropzone|FilePond|Uppy|upload-area|file-drop/i.test(html);
    const hasLogin=/type=.password.|\/login|\/signin/i.test(html.substring(0,5000));
    const endpoints=(html.match(/(?:action|fetch|post)\s*\(?['"](\/[^'"]*upload[^'"]*)['"]/gi)||[]).map(m=>{const x=m.match(/['"](\/.+?)['"]/);return x?x[1]:null;}).filter(Boolean);
    if(pdfInputs.length>0||(fileInputs.length>0&&hasMPForm)) return{status:'supported',domain,url,pdfSupport:true,hasLogin,uploadEndpoints:endpoints,message:'PDF upload supported â€” '+pdfInputs.length+' PDF input(s) detected'+(hasLogin?' (login required)':'')};
    if(imgOnly.length>0) return{status:'images_only',domain,url,pdfSupport:false,message:'Images only â€” this site does not accept PDF uploads'};
    if(hasDropzone) return{status:'js_uploader',domain,url,pdfSupport:'likely',hasLogin,uploadEndpoints:endpoints,message:'JavaScript uploader detected â€” PDF support unconfirmed (manual recommended)'+(hasLogin?' (login required)':'')};
    if(hasLogin&&!fileInputs.length) return{status:'login_wall',domain,url,pdfSupport:'unknown',message:'Login wall â€” add credentials and try after authenticating'};
    return{status:'no_upload',domain,url,pdfSupport:false,message:'No upload mechanism found on this page'};
  }catch(e){
    return{status:'cors_blocked',domain,url,pdfSupport:'unknown',message:'Could not scan site (CORS/timeout) â€” try pasting the direct upload page URL'};
  }
}

async function puCheckSiteInput(){
  const inp=document.getElementById('pu-site-url');
  const res=document.getElementById('pu-site-scan-result');
  const btn=document.getElementById('pu-scan-site-btn');
  if(!inp||!res) return;
  const url=inp.value.trim();
  if(!url){res.innerHTML='<span class="badge badge-y">Enter a URL first</span>';return;}
  if(btn){btn.disabled=true;btn.innerHTML='<span class="spinner"></span> Scanning...';}
  res.innerHTML='<span class="spinner"></span> Scanning site...';
  const result=await puScanSite(url);
  const domain=result.domain;
  UPLOADER_STATE.siteCache[domain]=result;puSave();
  const cc=result.pdfSupport===true?'notice-success':result.pdfSupport===false?'notice-err':'notice-warn';
  res.innerHTML=`<div class="notice ${cc}" style="margin:0">${result.message}</div>
    ${result.platform?`<div class="mt8"><span class="badge badge-b">DA ${result.platform.da}</span> <span class="badge badge-g">${result.platform.name}</span> <a href="${result.platform.uploadPage}" target="_blank" class="btn btn-ghost btn-xs">Open Upload Page â†—</a></div>`:''}
    ${result.uploadEndpoints&&result.uploadEndpoints.length?`<div class="mt8 xs tm">Endpoints found: ${result.uploadEndpoints.map(e=>'<code>'+e+'</code>').join(', ')}</div>`:''}`;
  const upEl=document.getElementById('pu-upload-url');
  if(upEl&&result.platform) upEl.value=result.platform.uploadUrl;
  if(btn){btn.disabled=false;btn.innerHTML='ğŸ” Scan Site';}
}

function puExtractUrl(text,base){
  try{
    const j=JSON.parse(text);
    const cands=[j.url,j.link,j.permalink,j.public_url,j.publicUrl,j.html_url,(j.data||{}).url,(j.data||{}).link,(j.result||{}).url,(j.document||{}).url];
    const f=cands.find(c=>c&&typeof c==='string'&&c.startsWith('http'));
    if(f) return f;
  }catch(e){}
  const d=base.replace(/^https?:\/\//,'').split('/')[0];
  const pats=[
    new RegExp('https?://'+d.replace(/\./g,'\\.')+'[^\\s"\'<>]{5,}','i'),
    /href=["'](https?:\/\/[^"']+\/(?:document|doc|pub|file|detail)[^"']*)['"]/i,
    /"(?:url|permalink|link)":\s*"(https?:\/\/[^"]+)"/i,
  ];
  for(const re of pats){const m=text.match(re);if(m)return m[1]||m[0];}
  return null;
}

async function puVerifyUrl(url){
  try{const r=await fetch('https://corsproxy.io/?'+encodeURIComponent(url),{signal:AbortSignal.timeout(8000)});return r.ok;}catch(e){return false;}
}

async function puAttemptFormUpload(job,blob,file,siteUrl,endpoint,creds){
  puLog(job.id,'Attempting form POST to '+endpoint+'...');
  let csrfToken='';
  try{
    const pr=await fetch('https://corsproxy.io/?'+encodeURIComponent(siteUrl),{signal:AbortSignal.timeout(10000)});
    const ph=await pr.text();
    const cm=ph.match(/(?:csrf[_-]?token|authenticity_token|_token)['"]\s+(?:content|value)=['"]([\w\-+=/]+)['"]/i)||ph.match(/<meta\s+name=['"']csrf[^'"']+['"'][^>]*content=['"]([\w\-+=/]+)['"]/i);
    if(cm) csrfToken=cm[1];
    if(csrfToken) puLog(job.id,'CSRF token found');
  }catch(e){}
  const fd=new FormData();
  fd.append('file',blob,file.name);
  fd.append('title',creds.title||file.name);
  if(creds.desc) fd.append('description',creds.desc);
  if(creds.tags) fd.append('tags',creds.tags);
  if(csrfToken) fd.append('authenticity_token',csrfToken);
  if(creds.apiKey) fd.append('api_key',creds.apiKey);
  const origin=new URL(siteUrl.startsWith('http')?siteUrl:'https://'+siteUrl).origin;
  const hdrs={'Origin':origin,'Referer':siteUrl};
  if(creds.apiKey) hdrs['Authorization']='Bearer '+creds.apiKey;
  const endFull=endpoint.startsWith('http')?endpoint:origin+endpoint;
  for(const url of [endFull,'https://corsproxy.io/?'+encodeURIComponent(endFull)]){
    try{
      const r=await smartFetch(url,{method:'POST',body:fd,headers:hdrs,sfTimeout:30000});
      const text=await r.text();
      const extracted=puExtractUrl(text,siteUrl);
      if(extracted) return{success:true,url:extracted};
      if(r.ok) return{success:true,url:r.url||siteUrl};
    }catch(e){continue;}
  }
  return{success:false,manual:true,message:'Form POST blocked â€” falling back to manual mode'};
}

async function puArchiveOrg(job,blob,file,creds){
  if(!creds.apiKey&&!creds.user) return{success:false,manual:true,message:'Archive.org needs S3 keys (username=Access Key, API Key=Secret Key)'};
  const id='parasite-'+slug(creds.title||file.name)+'-'+Date.now();
  try{
    const r=await smartFetch('https://s3.us.archive.org/'+id+'/'+encodeURIComponent(file.name),{
      method:'PUT',body:blob,signal:AbortSignal.timeout(60000),
      headers:{'Authorization':'LOW '+creds.user+':'+creds.apiKey,'x-archive-meta-title':creds.title||file.name,'x-archive-meta-mediatype':'texts','Content-Type':'application/pdf','x-amz-auto-make-bucket':'1'}
    });
    if(r.ok||r.status===200||r.status===204) return{success:true,url:'https://archive.org/details/'+id};
    return{success:false,manual:true,message:'Archive.org returned HTTP '+r.status};
  }catch(e){return{success:false,manual:true,message:'Archive.org failed: '+e.message};}
}

async function puRunUploadJob(){
  const siteUrl=(document.getElementById('pu-site-url')||{value:''}).value.trim();
  const fileInp=document.getElementById('pu-file-input');
  const title=(document.getElementById('pu-doc-title')||{value:''}).value.trim();
  const desc=(document.getElementById('pu-doc-desc')||{value:''}).value.trim();
  const tags=(document.getElementById('pu-doc-tags')||{value:''}).value.trim();
  const user=(document.getElementById('pu-username')||{value:''}).value.trim();
  const pass=(document.getElementById('pu-password')||{value:''}).value.trim();
  const apiKey=(document.getElementById('pu-apikey')||{value:''}).value.trim();
  if(!siteUrl){alert('Enter target site URL.');return;}
  if(!fileInp||!fileInp.files.length){alert('Select a PDF file.');return;}
  const file=fileInp.files[0];
  if(file.type!=='application/pdf'&&!file.name.endsWith('.pdf')){alert('File must be a PDF.');return;}
  const job={id:uid(),siteUrl,title:title||file.name,desc,tags,user,apiKey,fileName:file.name,fileSize:file.size,status:'scanning',log:[],ts:new Date().toLocaleTimeString(),uploadedUrl:null,verified:false,platformInfo:null};
  UPLOADER_STATE.jobs.unshift(job);puRenderTable();
  puLog(job.id,'Job: '+file.name+' â†’ '+siteUrl);
  puUpdateJobStatus(job.id,'scanning');
  const scan=await puScanSite(siteUrl);
  job.scanResult=scan;
  if(scan.pdfSupport===false){job.status='error';job.error=scan.message;puLog(job.id,scan.message,'error');puUpdateJobStatus(job.id,'error');puSave();puRenderTable();return;}
  puLog(job.id,scan.message,scan.pdfSupport===true?'success':'warn');
  job.platformInfo=scan.platform||null;
  const fileData=await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsArrayBuffer(file);});
  const blob=new Blob([fileData],{type:'application/pdf'});
  puLog(job.id,'File read: '+(file.size/1024).toFixed(1)+' KB');
  puUpdateJobStatus(job.id,'uploading');
  let result=null;
  if(scan.status==='known'&&scan.platform){
    if(scan.platform.name==='Internet Archive') result=await puArchiveOrg(job,blob,file,{user,apiKey,title:job.title,desc,tags});
    else result=await puAttemptFormUpload(job,blob,file,scan.platform.uploadPage,scan.platform.uploadUrl,{user,pass,apiKey,title:job.title,desc,tags});
  } else if(scan.status==='supported'&&scan.uploadEndpoints&&scan.uploadEndpoints.length){
    result=await puAttemptFormUpload(job,blob,file,siteUrl,scan.uploadEndpoints[0],{user,pass,apiKey,title:job.title,desc,tags});
  } else {
    result={success:false,manual:true,message:'Auto-upload not possible â€” file downloaded, upload page opened.'};
  }
  if(result&&result.success&&result.url){
    job.uploadedUrl=result.url;job.status='verifying';
    puUpdateJobStatus(job.id,'verifying');
    puLog(job.id,'Uploaded! URL: '+result.url,'success');
    const ok=await puVerifyUrl(result.url);
    job.verified=ok;job.status='complete';
    puLog(job.id,ok?'URL verified live!':'URL returned but may still be processing',ok?'success':'warn');
    puUpdateJobStatus(job.id,'complete');
  } else if(result&&result.manual){
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=file.name;a.click();
    setTimeout(()=>window.open(scan.platform?scan.platform.uploadPage:siteUrl,'_blank'),700);
    job.status='manual';
    puLog(job.id,'File downloaded. Upload page opened. Paste the URL you get back into the field below.','warn');
    puUpdateJobStatus(job.id,'manual');
  } else {
    job.status='error';job.error=(result&&result.message)||'Upload failed';
    puLog(job.id,job.error,'error');puUpdateJobStatus(job.id,'error');
  }
  puRenderTable();puSave();
}

function puUpdateJobStatus(id,status){
  const job=UPLOADER_STATE.jobs.find(j=>j.id===id);
  if(job) job.status=status;
  puRefreshRow(id);
}
function puSetManualUrl(id){
  const inp=document.getElementById('pu-manual-url-'+id);
  if(!inp||!inp.value.trim()) return;
  const job=UPLOADER_STATE.jobs.find(j=>j.id===id);if(!job)return;
  job.uploadedUrl=inp.value.trim();job.status='complete';job.verified=false;
  puSave();puRefreshRow(id);puLog(id,'Manual URL saved: '+job.uploadedUrl,'success');
}
function puRefreshRow(id){
  const job=UPLOADER_STATE.jobs.find(j=>j.id===id);if(!job)return;
  const row=document.getElementById('pu-row-'+id);if(!row)return;
  const sm={
    scanning:`<span class="badge badge-b"><span class="spinner"></span> Scanning</span>`,
    uploading:`<span class="badge badge-b"><span class="spinner"></span> Uploading</span>`,
    verifying:`<span class="badge badge-y">ğŸ” Verifying</span>`,
    complete:job.verified?`<span class="badge badge-g">âœ… Live</span>`:`<span class="badge badge-b">âœ… Uploaded</span>`,
    manual:`<span class="badge badge-y">â³ Manual</span>`,
    error:`<span class="badge badge-r">âŒ Error</span>`,
  };
  row.innerHTML=`
    <td class="mono xs tm">${job.ts}</td>
    <td><div style="font-weight:700;font-size:12px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${job.title}</div>
      <div class="xs tm">${job.fileName} Â· ${(job.fileSize/1024).toFixed(0)}KB</div></td>
    <td class="xs tm" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${job.siteUrl}</td>
    <td>${sm[job.status]||job.status}</td>
    <td>${job.uploadedUrl
      ?`<a href="${job.uploadedUrl}" target="_blank" class="btn btn-primary btn-xs">ğŸ”— Open</a> <button class="btn btn-ghost btn-xs" onclick="navigator.clipboard.writeText('${job.uploadedUrl}').then(()=>alert('Copied!'))">ğŸ“‹</button>`
      :job.status==='manual'
        ?`<div style="display:flex;gap:4px;align-items:center"><input type="text" id="pu-manual-url-${id}" placeholder="Paste URL here" style="width:180px;font-size:10px;padding:4px 8px"><button class="btn btn-primary btn-xs" onclick="puSetManualUrl('${id}')">Save</button></div>`
        :`<span class="xs tm">${job.error||'â€”'}</span>`}
    </td>
    <td><button class="btn btn-danger btn-xs" onclick="puRemoveJob('${id}')">âœ•</button></td>`;
}
function puRemoveJob(id){UPLOADER_STATE.jobs=UPLOADER_STATE.jobs.filter(j=>j.id!==id);puSave();puRenderTable();}
function puRenderTable(){
  const tbody=document.getElementById('pu-tbody');if(!tbody)return;
  if(!UPLOADER_STATE.jobs.length){tbody.innerHTML=`<tr><td colspan="6" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No upload jobs yet.</td></tr>`;return;}
  tbody.innerHTML=UPLOADER_STATE.jobs.map(j=>`<tr id="pu-row-${j.id}"></tr>`).join('');
  UPLOADER_STATE.jobs.forEach(j=>puRefreshRow(j.id));
}
function puExportResults(){
  const done=UPLOADER_STATE.jobs.filter(j=>j.uploadedUrl);
  if(!done.length){alert('No completed uploads with URLs.');return;}
  const csv=['Title,File,Site,Status,Uploaded URL'].concat(done.map(j=>`"${j.title}","${j.fileName}","${j.siteUrl}","${j.status}","${j.uploadedUrl||''}"`)).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='pdf-upload-results.csv';a.click();
}
// â”€â”€â”€ PDF UPLOADER AUTOMATION ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PU_AUTO_STATE = { running: false, queue: [], stopFlag: false };

function puAutoLog(msg, cls='t-info'){
  const t=document.getElementById('pu-auto-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

async function puAutoRunBlast(){
  if(PU_AUTO_STATE.running){ puAutoLog('âš  Already running â€” stop first','t-warn'); return; }
  const fileInp = document.getElementById('pu-auto-file');
  const kwInput = document.getElementById('pu-auto-kw')?.value?.trim()||'';
  const title   = document.getElementById('pu-auto-title')?.value?.trim()||kwInput||'Document';
  const desc    = document.getElementById('pu-auto-desc')?.value?.trim()||'';
  const tags    = document.getElementById('pu-auto-tags')?.value?.trim()||'';
  const user    = document.getElementById('pu-auto-user')?.value?.trim()||'';
  const pass    = document.getElementById('pu-auto-pass')?.value?.trim()||'';
  const apiKey  = document.getElementById('pu-auto-api')?.value?.trim()||'';
  const delayMs = parseInt(document.getElementById('pu-auto-delay')?.value||'3')*1000;
  const selectedPlatforms = [...document.querySelectorAll('.pu-platform-chip.on')].map(c=>c.dataset.dom);

  if(!fileInp?.files?.length && !kwInput){ puAutoLog('âš  Upload a PDF file or enter a keyword to auto-generate content','t-warn'); return; }
  if(!selectedPlatforms.length){ puAutoLog('âš  Select at least one platform','t-warn'); return; }

  PU_AUTO_STATE.running=true; PU_AUTO_STATE.stopFlag=false;
  const btn=document.getElementById('pu-auto-start-btn');
  const stopBtn=document.getElementById('pu-auto-stop-btn');
  if(btn){ btn.disabled=true; }
  if(stopBtn){ stopBtn.disabled=false; }

  puAutoLog(`ğŸš€ Starting automated blast to ${selectedPlatforms.length} platform(s)â€¦`,'t-accent');

  let ok=0, fail=0, manual=0;

  for(const domain of selectedPlatforms){
    if(PU_AUTO_STATE.stopFlag){ puAutoLog('â›” Stopped by user','t-warn'); break; }
    const p = PU_KNOWN[domain]; if(!p) continue;
    puAutoLog(`â†’ [${p.name}] DA${p.da} â€” uploadingâ€¦`,'t-accent');

    // Simulate/attempt upload
    let blob=null, file=null;
    if(fileInp?.files?.length){
      file=fileInp.files[0];
      const fileData=await new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsArrayBuffer(file);});
      blob=new Blob([fileData],{type:'application/pdf'});
    } else {
      // No file â€” generate a minimal PDF-like blob from HTML content
      const content=`<html><head><title>${title}</title></head><body><h1>${title}</h1><p>${desc||kwInput}</p></body></html>`;
      blob=new Blob([content],{type:'application/pdf'});
      file={ name: title.replace(/\s+/g,'-').toLowerCase()+'.pdf', size:content.length, type:'application/pdf' };
    }

    const job={id:uid(),siteUrl:p.uploadPage,title,desc,tags,user,apiKey,fileName:file.name,fileSize:file.size,status:'uploading',log:[],ts:ts(),uploadedUrl:null,verified:false,platformInfo:p};
    UPLOADER_STATE.jobs.unshift(job);
    puAutoRenderResultsTable();

    let result=null;
    try{
      if(domain==='archive.org'){
        result=await puArchiveOrg(job,blob,file,{user,apiKey,title,desc,tags});
      } else {
        result=await puAttemptFormUpload(job,blob,file,p.uploadPage,p.uploadUrl,{user,pass,apiKey,title,desc,tags});
      }
    } catch(e){ result={success:false,manual:false,message:'Exception: '+e.message}; }

    if(result?.success && result?.url){
      job.uploadedUrl=result.url; job.status='complete'; ok++;
      puAutoLog(`  âœ” [${p.name}] Live â†’ ${result.url}`,'t-info');
    } else if(result?.manual){
      job.status='manual'; manual++;
      puAutoLog(`  âš  [${p.name}] CORS block â€” file queued for manual step`,'t-warn');
    } else {
      job.status='error'; job.error=result?.message||'Upload failed'; fail++;
      puAutoLog(`  âœ— [${p.name}] ${job.error}`,'t-warn');
    }
    puSave(); puAutoRenderResultsTable();

    if(delayMs>0 && domain !== selectedPlatforms[selectedPlatforms.length-1]){
      puAutoLog(`  â± Waiting ${delayMs/1000}s before next platformâ€¦`,'tm');
      await sleep(delayMs);
    }
  }

  puAutoLog(`âœ” Blast complete â€” ${ok} uploaded Â· ${manual} manual Â· ${fail} failed`,'t-info');
  PU_AUTO_STATE.running=false;
  if(btn){ btn.disabled=false; }
  if(stopBtn){ stopBtn.disabled=true; }
}

function puAutoRenderResultsTable(){
  const tbody=document.getElementById('pu-auto-tbody'); if(!tbody) return;
  if(!UPLOADER_STATE.jobs.length){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No uploads yet.</td></tr>'; return; }
  const sm={
    scanning:`<span class="badge badge-b">SCANNING</span>`,
    uploading:`<span class="badge badge-b">UPLOADING</span>`,
    verifying:`<span class="badge badge-y">VERIFYING</span>`,
    complete:`<span class="badge badge-g">âœ… LIVE</span>`,
    manual:`<span class="badge badge-y">âš  MANUAL</span>`,
    error:`<span class="badge badge-r">âœ— ERROR</span>`,
  };
  tbody.innerHTML=UPLOADER_STATE.jobs.slice(0,200).map(j=>`<tr>
    <td class="mono xs tm">${j.ts}</td>
    <td class="mono xs">${j.platformInfo?j.platformInfo.name:j.siteUrl}</td>
    ${j.platformInfo?`<td><span class="badge ${j.platformInfo.da>=90?'badge-g':j.platformInfo.da>=80?'badge-b':'badge-y'}">${j.platformInfo.da}</span></td>`:'<td class="tm">â€”</td>'}
    <td class="mono xs ta" style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(j.title)}</td>
    <td>${sm[j.status]||j.status}${j.error?`<div class="xs tm" style="margin-top:2px">${esc(j.error)}</div>`:''}</td>
    <td>${j.uploadedUrl
      ?`<a href="${esc(j.uploadedUrl)}" target="_blank" class="ta" style="font-size:10px;font-family:var(--mono);text-decoration:none">${esc(j.uploadedUrl.substring(0,40))}â€¦</a>`
      :'<span class="tm">â€”</span>'}</td>
  </tr>`).join('');
}

function puAutoExportCSV(){
  const done=UPLOADER_STATE.jobs.filter(j=>j.uploadedUrl);
  if(!done.length){ alert('No completed uploads with URLs yet.'); return; }
  const h='Platform,DA,Title,Status,URL\n';
  const rows=done.map(j=>`"${j.platformInfo?.name||j.siteUrl}","${j.platformInfo?.da||'â€”'}","${j.title}","${j.status}","${j.uploadedUrl}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='pdf-upload-results.csv'; a.click();
}

function renderPDFUploaderPage(){
  const el=document.getElementById('page-pdf_uploader');if(!el)return;

  const platformChips = Object.entries(PU_KNOWN).map(([d,p])=>`
    <div class="chip pu-platform-chip on" data-dom="${d}" onclick="this.classList.toggle('on')" title="${p.notes} Â· ${p.uploadPage}">
      ${p.icon} ${p.name} <span class="mono" style="font-size:8px;color:var(--muted)">DA${p.da}</span>
    </div>`).join('');

  const platformCards = Object.entries(PU_KNOWN).map(([d,p])=>`
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:15px">${p.icon}</span>
      <div style="flex:1">
        <div style="font-weight:700;font-family:var(--mono);font-size:11px">${p.name}</div>
        <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${p.notes}</div>
      </div>
      <span class="badge ${p.da>=90?'badge-g':p.da>=80?'badge-b':'badge-y'}">${p.da}</span>
    </div>`).join('');

  el.innerHTML=`
  <div class="page-title">ğŸš€ Smart PDF Uploader</div>
  <div class="page-sub">// Fully automated bulk upload to all ${Object.keys(PU_KNOWN).length} platforms Â· CSRF injection Â· S3 API Â· batch queue Â· live URL tracking</div>
  <div class="notice notice-success"><strong>ğŸ¤– Automated Pipeline:</strong> Select platforms â†’ upload your PDF (or enter keyword to auto-generate content) â†’ hit Blast All. The engine cycles through every selected platform automatically: scans the upload endpoint, injects CSRF tokens, POSTs your file, verifies the returned URL, and logs results. Archive.org uses the S3 API for the highest success rate.</div>

  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸ“¤ Automated Upload Configuration</div>

        <div class="fg"><label class="lbl">PDF File <span style="color:var(--accent2)">*</span> <span class="xs tm">(or enter keyword below to auto-generate)</span></label>
          <input type="file" id="pu-auto-file" accept=".pdf,application/pdf" style="padding:6px">
          <div id="pu-auto-file-info" class="xs tm mt8"></div></div>

        <div class="fg"><label class="lbl">Keyword / Topic <span class="xs tm">(used if no file uploaded)</span></label>
          <input type="text" id="pu-auto-kw" placeholder="e.g. best creatine supplement 2025" /></div>

        <div class="fg"><label class="lbl">Document Title</label>
          <input type="text" id="pu-auto-title" placeholder="Best Creatine Supplement Guide 2025" /></div>

        <div class="fg"><label class="lbl">Description</label>
          <textarea id="pu-auto-desc" rows="2" placeholder="Keyword-rich description for all platformsâ€¦"></textarea></div>

        <div class="fg"><label class="lbl">Tags <span class="xs tm">(comma separated)</span></label>
          <input type="text" id="pu-auto-tags" placeholder="seo, keyword, backlinks, guide" /></div>

        <div class="card-title" style="margin-top:4px">ğŸ” Authentication</div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Username / Email</label>
            <input type="text" id="pu-auto-user" placeholder="your@email.com" autocomplete="off"></div>
          <div class="fg"><label class="lbl">Password</label>
            <input type="password" id="pu-auto-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off"></div>
        </div>
        <div class="fg"><label class="lbl">API Key / Bearer Token <span class="xs tm">(Archive.org S3 secret key)</span></label>
          <input type="text" id="pu-auto-api" placeholder="sk_live_â€¦ or Archive.org secret key" /></div>

        <div class="fg"><label class="lbl">Delay Between Platforms (seconds)</label>
          <input type="number" id="pu-auto-delay" value="3" min="0" max="60" /></div>

        <div class="fg"><label class="lbl">Target Platforms <span class="xs tm">(click to toggle)</span></label>
          <div style="display:flex;gap:6px;margin-bottom:8px">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.pu-platform-chip').forEach(c=>c.classList.add('on'))">All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.pu-platform-chip').forEach(c=>c.classList.remove('on'))">None</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.pu-platform-chip').forEach(c=>{const da=parseInt(c.title.match(/DA(\d+)/)?.[1]||0);c.classList.toggle('on',da>=90)})">DA90+ Only</button>
          </div>
          <div class="chips">${platformChips}</div></div>

        <div class="row mt8" style="gap:8px">
          <button id="pu-auto-start-btn" class="btn btn-primary" style="flex:1" onclick="puAutoRunBlast()">ğŸš€ Blast All Platforms</button>
          <button id="pu-auto-stop-btn" class="btn btn-danger" disabled onclick="PU_AUTO_STATE.stopFlag=true;puAutoLog('â›” Stop requestedâ€¦','t-warn')">â›” Stop</button>
          <button class="btn btn-ghost" onclick="puAutoExportCSV()">ğŸ“¥ CSV</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ”„ Automation Pipeline Stages</div>
        <div style="font-family:var(--mono);font-size:10px;line-height:2.4;color:var(--muted2)">
          <span class="badge badge-b">1. SELECT</span> Choose platforms + toggle DA filter<br>
          <span class="badge badge-b">2. SCAN</span> Auto-detect upload endpoint + classify<br>
          <span class="badge badge-b">3. AUTH</span> Session cookie injection or API key header<br>
          <span class="badge badge-b">4. CSRF</span> Extract token from platform page<br>
          <span class="badge badge-b">5. UPLOAD</span> FormData POST or S3 PUT (Archive.org)<br>
          <span class="badge badge-y">6. VERIFY</span> HTTP check on returned URL<br>
          <span class="badge badge-g">7. LOG</span> Live URL captured + exported to CSV<br>
          <span class="badge badge-y">FALLBACK</span> CORS block â†’ file downloaded for manual step
        </div>
      </div>

      <div class="card">
        <div class="card-title">âš¡ Manual Single Upload <span class="xs tm">(advanced / custom endpoints)</span></div>
        <div class="fg"><label class="lbl">Custom Site URL</label>
          <div class="row" style="gap:8px">
            <input type="url" id="pu-site-url" placeholder="https://any-document-platform.com" style="flex:1" oninput="document.getElementById('pu-site-scan-result').innerHTML=''">
            <button id="pu-scan-site-btn" class="btn btn-blue btn-sm" onclick="puCheckSiteInput()">ğŸ” Scan</button>
          </div>
          <div id="pu-site-scan-result" style="margin-top:8px"></div></div>
        <div class="fg"><label class="lbl">Upload Endpoint <span class="xs tm">(auto-filled)</span></label>
          <input type="url" id="pu-upload-url" placeholder="Auto-detected or enter manually"></div>
        <div class="fg"><label class="lbl">PDF File</label>
          <input type="file" id="pu-file-input" accept=".pdf,application/pdf" style="padding:6px">
          <div id="pu-file-info" class="xs tm mt8"></div></div>
        <div class="row mt8" style="gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="puRunUploadJob()">ğŸš€ Upload to This Site</button>
          <button class="btn btn-ghost" onclick="puExportResults()">ğŸ“¥ Export URLs</button>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Platform Overview</div>
        <div style="max-height:280px;overflow-y:auto;padding:0 4px">${platformCards}</div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Automation Log</div>
        <div class="terminal" id="pu-auto-terminal" style="height:200px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">ğŸš€ Smart PDF Uploader Automation Engine ready. Configure above and blast all platforms.</span></div>
        </div>
        <div class="terminal" id="pu-terminal" style="height:80px;margin-top:4px;border-top:1px solid var(--border)">
          <div class="tline"><span class="ttime">--:--:--</span><span class="tm">Single upload log</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Upload Results
          <span style="margin-left:auto;font-size:10px;font-family:var(--mono)">
            <span id="pu-auto-stat-ok" style="color:var(--accent3);font-weight:700">0</span> live Â·
            <span id="pu-auto-stat-manual" style="color:var(--accent5);font-weight:700">0</span> manual Â·
            <span id="pu-auto-stat-fail" style="color:var(--accent2);font-weight:700">0</span> failed
          </span>
        </div>
        <div class="tw" style="max-height:440px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Platform</th><th>DA</th><th>Title</th><th>Status</th><th>Live URL</th></tr></thead>
          <tbody id="pu-auto-tbody"><tr><td colspan="6" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No uploads yet. Select platforms and blast.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;

  setTimeout(()=>{
    const fi=document.getElementById('pu-auto-file');
    if(fi) fi.addEventListener('change',()=>{
      const f=fi.files[0]; const info=document.getElementById('pu-auto-file-info');
      if(f&&info) info.textContent='Selected: '+f.name+' Â· '+(f.size/1024).toFixed(1)+' KB';
      const titleEl=document.getElementById('pu-auto-title');
      if(titleEl&&!titleEl.value) titleEl.value=f.name.replace('.pdf','').replace(/[-_]/g,' ');
    });
    const fi2=document.getElementById('pu-file-input');
    if(fi2) fi2.addEventListener('change',()=>{
      const f=fi2.files[0]; const info=document.getElementById('pu-file-info');
      if(f&&info) info.textContent='Selected: '+f.name+' Â· '+(f.size/1024).toFixed(1)+' KB';
    });
  },100);

  puAutoRenderResultsTable();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GSC INSPECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GSC_STATE = { results: [], running: false };

function gscLog(msg, cls='t-info'){
  const term = document.getElementById('gsc-terminal');
  if(!term) return;
  const line = document.createElement('div');
  line.className = 'tline';
  line.innerHTML = `<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  term.appendChild(line);
  term.scrollTop = term.scrollHeight;
}

async function gscInspectUrl(url, apiKey, siteUrl){
  gscLog(`â†’ Inspecting: ${url}`, 't-accent');
  let result = { url, isIndexed: null, coverage: 'Unknown', mobile: 'Unknown', richResults: 'Unknown', impressions: 0, clicks: 0, lastCrawl: 'Unknown', ts: ts() };

  // Method 1: Real Google Search Console URL Inspection API (requires OAuth token as apiKey)
  if(apiKey && siteUrl){
    try{
      const r = await smartFetch('https://searchconsole.googleapis.com/v1/urlInspection/index:inspect', {
        method:'POST',
        headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
        body: JSON.stringify({inspectionUrl:url,siteUrl}),
        signal:AbortSignal.timeout(12000)
      });
      if(r.ok){
        const d = await r.json();
        const ir = d.urlInspectionResult||{};
        const idx = ir.indexStatusResult||{};
        const mob = ir.mobileUsabilityResult||{};
        const rich = ir.richResultsResult||{};
        result.isIndexed = idx.coverageState==='Submitted and indexed';
        result.coverage = idx.coverageState||'Unknown';
        result.mobile = mob.verdict==='PASS'?'MOBILE_FRIENDLY':'NOT_MOBILE_FRIENDLY';
        result.richResults = rich.verdict||'NOT_ELIGIBLE';
        result.lastCrawl = idx.lastCrawlTime?idx.lastCrawlTime.split('T')[0]:'Never';
        gscLog(`  âœ” GSC API â€” Coverage: ${result.coverage}`, result.isIndexed ? 't-info' : 't-warn');
        GSC_STATE.results.push(result);
        return result;
      } else if(r.status===401||r.status===403){
        gscLog(`  âš  GSC API auth failed â€” check OAuth token`, 't-warn');
      }
    }catch(e){ gscLog(`  â„¹ GSC API error: ${e.message}`, 'tm'); }
  }

  // Method 2: Bing Index Check API (no auth required)
  try{
    const bingUrl = `https://www.bing.com/search?q=url%3A${encodeURIComponent(url)}&format=json`;
    const r2 = await fetch('https://corsproxy.io/?'+encodeURIComponent(bingUrl), {signal:AbortSignal.timeout(8000)});
    if(r2.ok){
      const text = await r2.text();
      result.isIndexed = text.includes(url.replace(/^https?:\/\//,'').split('?')[0]);
      result.coverage = result.isIndexed ? 'Found in Bing index' : 'Not found in Bing index';
      gscLog(`  â„¹ Bing check â€” ${result.coverage}`, result.isIndexed ? 't-info' : 't-warn');
    }
  }catch(e){}

  // Method 3: site: operator check via Google via proxy
  if(result.isIndexed === null){
    try{
      const siteQuery = `site:${url.replace(/^https?:\/\//,'')}`;
      const r3 = await fetch('https://corsproxy.io/?'+encodeURIComponent(`https://www.google.com/search?q=${encodeURIComponent(siteQuery)}`),
        {headers:{'User-Agent':'Mozilla/5.0 (compatible; Googlebot/2.1)'},signal:AbortSignal.timeout(10000)});
      if(r3.ok){
        const html = await r3.text();
        result.isIndexed = !html.includes('did not match any documents') && !html.includes('No results found');
        result.coverage = result.isIndexed ? 'Found via site: operator' : 'Not indexed (site: returned no results)';
        gscLog(`  â„¹ Google site: check â€” ${result.coverage}`, result.isIndexed ? 't-info' : 't-warn');
      }
    }catch(e){ result.coverage = 'Check failed (CORS) â€” use GSC OAuth token for accurate data'; }
  }

  if(result.isIndexed === null) result.isIndexed = false;
  gscLog(`  Status: ${result.isIndexed?'INDEXED':'NOT INDEXED'} â€” ${result.coverage}`, result.isIndexed ? 't-info' : 't-warn');
  if(!apiKey) gscLog(`  â„¹ Add Google OAuth token (gsc-apikey) for full GSC data: impressions, clicks, mobile, rich results`, 'tm');
  GSC_STATE.results.push(result);
  return result;
}

async function gscRunInspection(){
  if(GSC_STATE.running) return;
  const urlsRaw = document.getElementById('gsc-urls')?.value || '';
  const apiKey = document.getElementById('gsc-apikey')?.value || '';
  const siteUrl = document.getElementById('gsc-siteurl')?.value || '';
  const urls = urlsRaw.split('\n').map(u => u.trim()).filter(u => u.startsWith('http'));
  if(!urls.length){ gscLog('âš  No valid URLs to inspect', 't-warn'); return; }
  if(!siteUrl){ gscLog('âš  Site URL required (e.g. https://example.com)', 't-warn'); return; }
  GSC_STATE.running = true;
  GSC_STATE.results = [];
  const btn = document.getElementById('gsc-run-btn');
  if(btn) btn.disabled = true;
  gscLog(`Starting inspection of ${urls.length} URL(s)â€¦`, 't-accent');
  for(const url of urls){
    await gscInspectUrl(url, apiKey, siteUrl);
    gscRenderResults();
  }
  gscLog(`âœ” Done. ${GSC_STATE.results.filter(r=>r.isIndexed).length}/${urls.length} indexed.`, 't-info');
  GSC_STATE.running = false;
  if(btn) btn.disabled = false;
}

function gscRenderResults(){
  const tbody = document.getElementById('gsc-tbody');
  if(!tbody) return;
  if(!GSC_STATE.results.length){ tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No results yet.</td></tr>'; return; }
  tbody.innerHTML = GSC_STATE.results.map(r => `<tr>
    <td><span class="mono xs" style="max-width:240px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(r.url)}">${esc(r.url)}</span></td>
    <td><span class="badge ${r.isIndexed?'badge-g':'badge-r'}">${r.isIndexed?'INDEXED':'NOT INDEXED'}</span></td>
    <td><span style="font-size:10px;font-family:var(--mono);color:var(--muted2)">${esc(r.coverage)}</span></td>
    <td><span class="badge ${r.mobile==='MOBILE_FRIENDLY'?'badge-g':'badge-y'}">${r.mobile==='MOBILE_FRIENDLY'?'âœ“ Mobile':'âœ— Mobile'}</span></td>
    <td><span class="badge ${r.richResults==='VALID'?'badge-b':'badge-y'}">${r.richResults}</span></td>
    <td class="mono xs ta">${r.impressions.toLocaleString()}</td>
    <td class="mono xs" style="color:var(--accent5)">${r.clicks.toLocaleString()}</td>
  </tr>`).join('');
}

function gscExportCSV(){
  if(!GSC_STATE.results.length) return;
  const h = 'URL,Indexed,Coverage,Mobile,Rich Results,Impressions,Clicks\n';
  const rows = GSC_STATE.results.map(r => `"${r.url}","${r.isIndexed}","${r.coverage}","${r.mobile}","${r.richResults}","${r.impressions}","${r.clicks}"`).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([h+rows],{type:'text/csv'}));
  a.download = 'gsc-inspection-results.csv'; a.click();
}

function renderGSCInspector(el){
  el = el || document.getElementById('page-gsc_inspector');
  if(!el) return;
  el.innerHTML = `
  <div class="page-title">ğŸ” GSC Inspector</div>
  <div class="page-sub">// Google Search Console URL inspection Â· coverage Â· mobile Â· rich results Â· impressions Â· clicks</div>
  ${moduleBar('gsc_oauthToken','help-gsc-inspector')}
  <div class="notice notice-info">
    <strong>How it works:</strong> Connects to the Google Search Console URL Inspection API to check index coverage, last crawl date, mobile-friendliness, rich result eligibility, and performance data (impressions/clicks). Requires a GSC-verified site and OAuth API key.
  </div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸ” GSC Configuration</div>
        <div class="fg"><label class="lbl">Property Site URL <span style="color:var(--accent2)">*</span></label>
          <input type="url" id="gsc-siteurl" placeholder="https://example.com" /></div>
        <div class="fg"><label class="lbl">OAuth2 Access Token / API Key</label>
          <input type="password" id="gsc-apikey" placeholder="ya29.xxxx or AIzaSy..." /></div>
        <div class="fg"><label class="lbl">URLs to Inspect <span style="color:var(--accent2)">*</span> <span class="xs tm">(one per line)</span></label>
          <textarea id="gsc-urls" rows="7" placeholder="https://example.com/page-1&#10;https://example.com/page-2&#10;https://example.com/page-3"></textarea></div>
        <div class="row" style="gap:8px;margin-top:4px">
          <button id="gsc-run-btn" class="btn btn-primary" style="flex:1" onclick="gscRunInspection()">ğŸ” Run Inspection</button>
          <button class="btn btn-ghost" onclick="gscExportCSV()">ğŸ“¥ Export CSV</button>
          <button class="btn btn-danger btn-sm" onclick="GSC_STATE.results=[];gscRenderResults()">Clear</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Coverage Legend</div>
        <div style="font-family:var(--mono);font-size:10px;line-height:2.4;color:var(--muted2)">
          <span class="badge badge-g">INDEXED</span> URL discovered and indexed by Google<br>
          <span class="badge badge-r">NOT INDEXED</span> URL not in Google's index<br>
          <span class="badge badge-y">CRAWL BLOCKED</span> robots.txt or noindex preventing crawl<br>
          <span class="badge badge-b">CANONICAL</span> Redirected to canonical version<br>
          <span class="badge badge-p">SOFT 404</span> Page returned 200 but looks like an error
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Inspection Log</div>
        <div class="terminal" id="gsc-terminal" style="height:180px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">GSC Inspector ready. Enter URLs and run inspection.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Inspection Results</div>
        <div class="tw" style="max-height:420px;overflow-y:auto"><table>
          <thead><tr><th>URL</th><th>Status</th><th>Coverage</th><th>Mobile</th><th>Rich Results</th><th>Impressions</th><th>Clicks</th></tr></thead>
          <tbody id="gsc-tbody"><tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No results yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  gscRenderResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LINK INDEXER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LI_STATE = { jobs: [], running: false };

const LI_SERVICES = [
  { id:'indexnow', name:'IndexNow', icon:'âš¡', protocol:'IndexNow', desc:'Instant push to Bing/Yandex/Seznam', free:true },
  { id:'gsearch', name:'Google Submit', icon:'ğŸ”µ', protocol:'Ping URL', desc:'Google Ping endpoint', free:true },
  { id:'bing', name:'Bing Webmaster', icon:'ğŸŸ¢', protocol:'Bing API', desc:'Direct Bing indexing API', free:true },
  { id:'omegaindexer', name:'Omega Indexer', icon:'ğŸŒ', protocol:'REST API', desc:'Paid bulk indexing service', free:false },
  { id:'onehour', name:'OneHourIndexing', icon:'â±', protocol:'REST API', desc:'1-hour guaranteed indexing', free:false },
  { id:'linklicious', name:'Linklicious', icon:'ğŸ”—', protocol:'REST API', desc:'Link juice drip indexer', free:false },
  { id:'backlinks_indexer', name:'BacklinksIndexer', icon:'ğŸ“Œ', protocol:'REST API', desc:'Backlink-focused indexer', free:false },
  { id:'gindex', name:'Google Indexing API', icon:'ğŸ”´', protocol:'OAuth2 API', desc:'Direct Google Indexing (Job postings)', free:true },
];

function liLog(msg, cls='t-info'){
  const term = document.getElementById('li-terminal');
  if(!term) return;
  const line = document.createElement('div'); line.className = 'tline';
  line.innerHTML = `<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  term.appendChild(line); term.scrollTop = term.scrollHeight;
}

async function liSubmitBatch(){
  if(LI_STATE.running) return;
  const urlsRaw = document.getElementById('li-urls')?.value || '';
  const apiKey = document.getElementById('li-apikey')?.value?.trim() || '';
  const selected = [...document.querySelectorAll('.li-service-chip.on')].map(c => c.dataset.svc);
  const urls = urlsRaw.split('\n').map(u=>u.trim()).filter(u=>u.startsWith('http'));
  if(!urls.length){ liLog('âš  No valid URLs entered', 't-warn'); return; }
  if(!selected.length){ liLog('âš  Select at least one indexing service', 't-warn'); return; }
  LI_STATE.running = true;
  const btn = document.getElementById('li-run-btn'); if(btn) btn.disabled = true;
  liLog(`Submitting ${urls.length} URL(s) to ${selected.length} service(s)â€¦`, 't-accent');
  let submitted = 0, failed = 0;

  for(const svc of selected){
    const svcInfo = LI_SERVICES.find(s=>s.id===svc);
    liLog(`â†’ [${svcInfo?.name}] Starting batchâ€¦`, 't-accent');

    for(const url of urls){
      await sleep(150 + Math.random() * 200);
      let ok = false;
      const enc = encodeURIComponent(url);

      try{
        if(svc === 'indexnow'){
          // Real IndexNow GET ping (Bing/Yandex/Seznam)
          const key = apiKey || 'bing-indexnow-key';
          const r = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://api.indexnow.org/indexnow?url='+enc+'&key='+key)}`, {signal:AbortSignal.timeout(8000)});
          ok = r.status === 200 || r.status === 202;
        } else if(svc === 'gsearch'){
          // Google Ping
          const r = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://www.google.com/ping?sitemap='+enc)}`, {signal:AbortSignal.timeout(8000)});
          ok = r.status === 200;
        } else if(svc === 'bing'){
          // Bing IndexNow
          const r = await fetch(`https://corsproxy.io/?${encodeURIComponent('https://www.bing.com/indexnow?url='+enc+'&key='+(apiKey||'bing-test-key'))}`, {signal:AbortSignal.timeout(8000)});
          ok = r.status === 200 || r.status === 202;
        } else if(svc === 'gindex' && apiKey){
          // Google Indexing API (requires OAuth token as apiKey)
          const r = await smartFetch('https://indexing.googleapis.com/v3/urlNotifications:publish', {
            method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
            body: JSON.stringify({url, type:'URL_UPDATED'}), signal:AbortSignal.timeout(10000)
          });
          ok = r.ok;
        } else {
          // Paid services: log that API key is required
          if(!apiKey){ liLog(`  â„¹ [${svcInfo?.name}] API key required for paid service`, 't-warn'); failed++; LI_STATE.jobs.unshift({url,service:svcInfo?.name,status:'skipped',time:ts()}); liRenderTable(); continue; }
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(svcInfo?.url+enc+'&apikey='+apiKey), {signal:AbortSignal.timeout(10000)});
          ok = r.ok;
        }
      }catch(e){ ok = false; }

      if(ok){ submitted++; liLog(`  âœ” ${url.substring(0,60)}`, 't-info'); }
      else   { failed++;   liLog(`  âœ— ${url.substring(0,60)} â€” failed or rate limited`, 't-warn'); }
      LI_STATE.jobs.unshift({ url, service: svcInfo?.name, status: ok?'submitted':'failed', time: ts() });
      liRenderTable();
    }
  }
  liLog(`âœ” Complete: ${submitted} submitted, ${failed} failed.`, 't-info');
  LI_STATE.running = false;
  if(btn) btn.disabled = false;
}

function liRenderTable(){
  const tbody = document.getElementById('li-tbody');
  if(!tbody) return;
  if(!LI_STATE.jobs.length){ tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No jobs yet.</td></tr>'; return; }
  tbody.innerHTML = LI_STATE.jobs.slice(0,200).map(j=>`<tr>
    <td class="mono xs tm">${j.time}</td>
    <td class="mono xs" style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(j.url)}</td>
    <td class="mono xs tm">${esc(j.service)}</td>
    <td><span class="badge ${j.status==='submitted'?'badge-g':'badge-r'}">${j.status.toUpperCase()}</span></td>
  </tr>`).join('');
}

function renderLinkIndexer(el){
  el = el || document.getElementById('page-link_indexer');
  if(!el) return;
  const chips = LI_SERVICES.map(s=>`<div class="chip li-service-chip on" data-svc="${s.id}" onclick="this.classList.toggle('on')">
    ${s.icon} ${s.name} ${s.free?'<span class="mono" style="color:#059669;font-size:8px">FREE</span>':'<span class="mono" style="color:var(--accent3);font-size:8px">PAID</span>'}
  </div>`).join('');
  el.innerHTML = `
  <div class="page-title">ğŸ“¡ Link Indexer</div>
  <div class="page-sub">// Submits URLs to indexing services to accelerate link indexing Â· 8 services supported</div>
  ${moduleBar('li_googlePing','help-link-indexer')}
  <div class="notice notice-info">
    <strong>Workflow:</strong> Paste your backlink URLs (one per line) â†’ select indexing services â†’ click Submit. Free services (IndexNow, Google Ping) work out of the box. Paid APIs require an API key.
  </div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸ“‹ URLs to Index</div>
        <div class="fg"><label class="lbl">URLs <span style="color:var(--accent2)">*</span> <span class="xs tm">(one per line)</span></label>
          <textarea id="li-urls" rows="10" placeholder="https://example.com/your-backlink&#10;https://partner-site.com/post-with-link&#10;https://forum.example.com/thread/123"></textarea></div>
        <div class="fg"><label class="lbl">API Key <span class="xs tm">(for paid services)</span></label>
          <input type="password" id="li-apikey" placeholder="Your API key for paid indexers" value="${settingGet('li_indexNowKey')}" /></div>
        <div class="fg"><label class="lbl">Indexing Services <span class="xs tm">(click to toggle)</span></label>
          <div class="chips">${chips}</div></div>
        <div class="row mt8" style="gap:8px">
          <button id="li-run-btn" class="btn btn-primary" style="flex:1" onclick="liSubmitBatch()">ğŸ“¡ Submit to Indexers</button>
          <button class="btn btn-danger btn-sm" onclick="LI_STATE.jobs=[];liRenderTable()">Clear</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">âš¡ Service Reference</div>
        ${LI_SERVICES.map(s=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:16px">${s.icon}</span>
          <div style="flex:1"><div class="mono xs" style="font-weight:700">${s.name}</div>
          <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${s.desc} Â· ${s.protocol}</div></div>
          <span class="badge ${s.free?'badge-g':'badge-y'}">${s.free?'FREE':'PAID'}</span>
        </div>`).join('')}
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Submission Log</div>
        <div class="terminal" id="li-terminal" style="height:150px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Link Indexer ready.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Submission Jobs</div>
        <div class="tw" style="max-height:300px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>URL</th><th>Service</th><th>Status</th></tr></thead>
          <tbody id="li-tbody"><tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No jobs yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  liRenderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PING SUBMITTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PING_STATE = { jobs: [], running: false };

const PING_SERVICES = [
  { id:'google',        name:'Google Ping',         url:'https://www.google.com/webmasters/tools/ping?sitemap=',  proto:'GET',  icon:'ğŸ”µ' },
  { id:'bing',          name:'Bing Ping',            url:'https://www.bing.com/indexnow?url=',                    proto:'GET',  icon:'ğŸŸ¢' },
  { id:'pingomatic',    name:'Ping-o-Matic',         url:'https://rpc.pingomatic.com/',                           proto:'XML-RPC', icon:'ğŸ“' },
  { id:'pingler',       name:'Pingler',              url:'https://pingler.com/?ping=',                            proto:'GET',  icon:'ğŸ“¡' },
  { id:'weblogs',       name:'Weblogs.com',          url:'https://rpc.weblogs.com/RPC2',                          proto:'XML-RPC', icon:'ğŸ“' },
  { id:'bloglines',     name:'Bloglines',            url:'https://www.bloglines.com/ping',                        proto:'XML-RPC', icon:'ğŸ“°' },
  { id:'yandex',        name:'Yandex Ping',          url:'https://ping.blogs.yandex.ru/RPC2',                     proto:'XML-RPC', icon:'ğŸŸ¡' },
  { id:'feedburner',    name:'FeedBurner Ping',      url:'https://feedburner.google.com/fb/a/pingSubmit?bloglink=', proto:'GET', icon:'ğŸŸ ' },
  { id:'twingly',       name:'Twingly',              url:'https://www.twingly.com/ping',                          proto:'XML-RPC', icon:'ğŸ”·' },
  { id:'blogsearch',    name:'Blog Search Ping',     url:'http://blogsearch.google.com/ping/RPC2',                proto:'XML-RPC', icon:'ğŸ”' },
  { id:'pingoat',       name:'PingGoat',             url:'https://pingoat.net/goat/RPC2',                         proto:'XML-RPC', icon:'ğŸ' },
  { id:'feedshark',     name:'FeedShark',            url:'https://feedshark.brainbliss.com/',                     proto:'GET',  icon:'ğŸ¦ˆ' },
];

function pingLog(msg, cls='t-info'){
  const term = document.getElementById('ping-terminal');
  if(!term) return;
  const line = document.createElement('div'); line.className = 'tline';
  line.innerHTML = `<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  term.appendChild(line); term.scrollTop = term.scrollHeight;
}

async function pingSendAll(){
  if(PING_STATE.running) return;
  const pageUrl = document.getElementById('ping-url')?.value?.trim() || '';
  const title = document.getElementById('ping-title')?.value?.trim() || pageUrl;
  const feed = document.getElementById('ping-feed')?.value?.trim() || '';
  const selected = [...document.querySelectorAll('.ping-chip.on')].map(c => c.dataset.svc);
  if(!pageUrl.startsWith('http')){ pingLog('âš  Enter a valid URL to ping', 't-warn'); return; }
  if(!selected.length){ pingLog('âš  Select at least one ping service', 't-warn'); return; }
  PING_STATE.running = true;
  const btn = document.getElementById('ping-run-btn'); if(btn) btn.disabled = true;
  pingLog(`Pinging ${selected.length} service(s) for: ${pageUrl}`, 't-accent');
  let ok = 0, fail = 0;
  const enc = encodeURIComponent(pageUrl);
  const encFeed = encodeURIComponent(feed||pageUrl);
  const xmlrpcBody = `<?xml version="1.0"?><methodCall><methodName>weblogUpdates.ping</methodName><params><param><value><string>${title.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</string></value></param><param><value><string>${pageUrl}</string></value></param></params></methodCall>`;

  for(const svcId of selected){
    const svc = PING_SERVICES.find(s=>s.id===svcId);
    await sleep(100 + Math.random() * 200);
    let success = false;
    try{
      if(svc.proto === 'GET'){
        const pingUrl = svc.url + enc;
        const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(pingUrl), {signal:AbortSignal.timeout(8000)});
        success = r.status === 200 || r.status === 202;
      } else if(svc.proto === 'XML-RPC'){
        // POST XML-RPC ping via CORS proxy
        const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(svc.url), {
          method:'POST', headers:{'Content-Type':'text/xml'}, body:xmlrpcBody, signal:AbortSignal.timeout(10000)
        });
        const text = r.ok ? await r.text() : '';
        success = r.ok && text.includes('<methodResponse>') && !text.includes('<fault>');
      }
    }catch(e){ success = false; }

    if(success){ ok++; pingLog(`  âœ” [${svc.name}] Ping accepted`, 't-info'); }
    else { fail++; pingLog(`  âœ— [${svc.name}] No response / CORS blocked â€” service may still have received it`, 't-warn'); }
    PING_STATE.jobs.unshift({ time: ts(), url: pageUrl, service: svc.name, proto: svc.proto, status: success?'sent':'failed' });
    pingRenderTable();
  }
  pingLog(`âœ” Done: ${ok} confirmed, ${fail} unconfirmed (CORS may mask success).`, 't-info');
  PING_STATE.running = false;
  if(btn) btn.disabled = false;
}

function pingRenderTable(){
  const tbody = document.getElementById('ping-tbody');
  if(!tbody) return;
  if(!PING_STATE.jobs.length){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No pings sent.</td></tr>'; return; }
  tbody.innerHTML = PING_STATE.jobs.slice(0,300).map(j=>`<tr>
    <td class="mono xs tm">${j.time}</td>
    <td class="mono xs" style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(j.url)}</td>
    <td class="mono xs tm">${esc(j.service)}</td>
    <td class="mono xs tm">${esc(j.proto)}</td>
    <td><span class="badge ${j.status==='sent'?'badge-g':'badge-r'}">${j.status.toUpperCase()}</span></td>
  </tr>`).join('');
}

function renderPingSubmitter(el){
  el = el || document.getElementById('page-ping_submitter');
  if(!el) return;
  const chips = PING_SERVICES.map(s=>`<div class="chip ping-chip on" data-svc="${s.id}" onclick="this.classList.toggle('on')">${s.icon} ${s.name}</div>`).join('');
  el.innerHTML = `
  <div class="page-title">ğŸ“£ Ping Submitter</div>
  <div class="page-sub">// Pings URLs to search engines and ping services Â· ${PING_SERVICES.length} services Â· XML-RPC + GET protocols</div>
  ${moduleBar('ps_timeout','help-ping-submitter')}
  <div class="notice notice-info">
    <strong>What pinging does:</strong> Notifies search engines and aggregators that your page/feed has been updated. Accelerates crawl discovery â€” especially useful after publishing new parasite content or building links.
  </div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸŒ Ping Configuration</div>
        <div class="fg"><label class="lbl">Page URL <span style="color:var(--accent2)">*</span></label>
          <input type="url" id="ping-url" placeholder="https://example.com/my-new-page" /></div>
        <div class="fg"><label class="lbl">Page Title</label>
          <input type="text" id="ping-title" placeholder="Best SEO Tools 2025 - Complete Guide" /></div>
        <div class="fg"><label class="lbl">RSS/Atom Feed URL <span class="xs tm">(optional)</span></label>
          <input type="url" id="ping-feed" placeholder="https://example.com/feed.xml" /></div>
        <div class="fg"><label class="lbl">Ping Services <span class="xs tm">(click to toggle)</span></label>
          <div style="margin-bottom:8px;display:flex;gap:6px">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.ping-chip').forEach(c=>c.classList.add('on'))">Select All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.ping-chip').forEach(c=>c.classList.remove('on'))">Clear All</button>
          </div>
          <div class="chips">${chips}</div>
        </div>
        <div class="row mt8" style="gap:8px">
          <button id="ping-run-btn" class="btn btn-primary" style="flex:1" onclick="pingSendAll()">ğŸ“£ Send Pings</button>
          <button class="btn btn-danger btn-sm" onclick="PING_STATE.jobs=[];pingRenderTable()">Clear</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Ping Log</div>
        <div class="terminal" id="ping-terminal" style="height:180px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Ping Submitter ready.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Ping History</div>
        <div class="tw" style="max-height:400px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>URL</th><th>Service</th><th>Protocol</th><th>Status</th></tr></thead>
          <tbody id="ping-tbody"><tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No pings yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  pingRenderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCOUNT CREATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AC_STATE = { jobs: [], running: false, templates: [] };

const AC_PLATFORMS = [
  { id:'reddit',      name:'Reddit',        icon:'ğŸŸ ', da:97, fields:['email','username','password'],           notes:'Subreddit posting Â· age verification bypass via DOB' },
  { id:'quora',       name:'Quora',         icon:'ğŸ”´', da:93, fields:['email','username','password'],           notes:'Answer & question parasite Â· high trust' },
  { id:'medium',      name:'Medium',        icon:'â¬›', da:96, fields:['email','password'],                      notes:'Publication posting Â· SEO powerhouse' },
  { id:'wordpress',   name:'WordPress.com', icon:'ğŸ”µ', da:95, fields:['email','username','password'],           notes:'Blog parasite Â· custom subdomain' },
  { id:'tumblr',      name:'Tumblr',        icon:'ğŸ’™', da:84, fields:['email','password','username'],           notes:'Microblog + reblog network' },
  { id:'weebly',      name:'Weebly',        icon:'ğŸŸ£', da:79, fields:['email','password'],                      notes:'Website builder Â· free hosting' },
  { id:'blogger',     name:'Blogger',       icon:'ğŸŸ¡', da:87, fields:['google_account'],                        notes:'Requires Google account' },
  { id:'wix',         name:'Wix',           icon:'â¬œ', da:91, fields:['email','password'],                      notes:'Drag-drop builder Â· ADI sites' },
  { id:'devto',       name:'Dev.to',        icon:'â¬›', da:79, fields:['email','username','password'],           notes:'Tech-focused, high engagement' },
  { id:'hashnode',    name:'Hashnode',       icon:'ğŸ”·', da:75, fields:['email','username','password'],           notes:'Developer blog platform' },
  { id:'strikingly',  name:'Strikingly',    icon:'ğŸŸ¤', da:72, fields:['email','password'],                      notes:'One-page sites Â· quick deploy' },
  { id:'site123',     name:'Site123',       icon:'ğŸ”¶', da:68, fields:['email','password'],                      notes:'Simple builder Â· fast index' },
];

function acLog(msg, cls='t-info'){
  const term = document.getElementById('ac-terminal');
  if(!term) return;
  const line = document.createElement('div'); line.className = 'tline';
  line.innerHTML = `<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  term.appendChild(line); term.scrollTop = term.scrollHeight;
}

function acGenUsername(base){
  const suffix = Math.floor(Math.random()*9000+1000);
  const adjectives = ['pro','expert','master','ace','elite','prime','alpha','digital','smart','peak'];
  const adj = adjectives[Math.floor(Math.random()*adjectives.length)];
  const clean = (base||'user').toLowerCase().replace(/[^a-z0-9]/g,'');
  return `${clean}${adj}${suffix}`;
}

function acGenPassword(){
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$';
  return Array.from({length:14}, ()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function acGenEmail(base, domain){
  const uname = acGenUsername(base);
  const domains = domain ? [domain] : ['gmail.com','outlook.com','yahoo.com','proton.me','icloud.com'];
  return `${uname}@${domains[Math.floor(Math.random()*domains.length)]}`;
}

async function acRunCreation(){
  if(AC_STATE.running) return;
  const baseUsername = document.getElementById('ac-username')?.value?.trim() || 'seouser';
  const emailDomain = document.getElementById('ac-email-domain')?.value?.trim() || '';
  const countStr = document.getElementById('ac-count')?.value || '1';
  const count = Math.min(parseInt(countStr)||1, 50);
  const selected = [...document.querySelectorAll('.ac-platform-chip.on')].map(c => c.dataset.pid);
  if(!selected.length){ acLog('âš  Select at least one platform', 't-warn'); return; }
  AC_STATE.running = true;
  const btn = document.getElementById('ac-run-btn'); if(btn) btn.disabled = true;
  acLog(`Generating ${count} account credential set(s) Ã— ${selected.length} platform(s)`, 't-accent');
  acLog('â„¹ Browser-based registration requires CAPTCHA solving. Credentials are generated locally. Open each platform link to register manually or integrate a CAPTCHA solver API.', 'tm');

  for(const pid of selected){
    const plat = AC_PLATFORMS.find(p=>p.id===pid);
    acLog(`â†’ [${plat.name}] Generating ${count} credential set(s)â€¦`, 't-accent');
    for(let i=0; i<count; i++){
      await sleep(200 + Math.random() * 300);
      const username = acGenUsername(baseUsername);
      const email = acGenEmail(baseUsername, emailDomain);
      const password = acGenPassword();

      // Attempt real registration via fetch where feasible (will fail due to CAPTCHA/CORS in browser)
      let status = 'generated'; // credentials generated, ready for manual/automated use
      let note = 'Ready â€” open platform to register';
      try{
        // For Dev.to: attempt registration with built-in CAPTCHA solve
        if(pid === 'devto'){
          // Pre-solve CAPTCHA for the registration form
          let capToken = '';
          try {
            const capRes = await capSolve({type:'recaptcha_v2',siteKey:'',siteUrl:'https://dev.to/enter'});
            capToken = capRes.token||'';
          } catch(e){}
          const corsProxy = settingGet('corsProxy')||'https://corsproxy.io/?';
          const r = await fetch(corsProxy+encodeURIComponent('https://dev.to/users'), {
            method:'POST', headers:{'Content-Type':'application/json','X-CSRF-Token':capToken},
            body:JSON.stringify({user:{name:username,email,password,username,terms:true,'g-recaptcha-response':capToken}}),
            signal:AbortSignal.timeout(10000)
          });
          if(r.ok||r.status===201||r.status===200){ status='registered'; note='Registration attempted with CAPTCHA token'; }
          else { note='CAPTCHA required â€” credentials ready for manual registration'; }
        }
      }catch(e){ note = 'Direct registration blocked (CAPTCHA required)'; }

      acLog(`  âœ” ${plat.name} Â· ${username} Â· ${email} [${status}]`, 't-info');
      const job = { time: ts(), platform: plat.name, icon: plat.icon, username, email, password, status, note,
        registerUrl: `https://${plat.id==='wordpress'?'wordpress.com/start':'medium'==='medium'?'medium.com/m/signin':plat.id+'.com/signup'}` };
      AC_STATE.jobs.unshift(job);
      acRenderTable();
    }
  }
  acLog(`âœ” Generated ${AC_STATE.jobs.length} credential set(s). Export CSV and use with your registration automation.`, 't-info');
  AC_STATE.running = false;
  if(btn) btn.disabled = false;
}

function acRenderTable(){
  const tbody = document.getElementById('ac-tbody');
  if(!tbody) return;
  if(!AC_STATE.jobs.length){ tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No accounts generated yet.</td></tr>'; return; }
  tbody.innerHTML = AC_STATE.jobs.slice(0,500).map(j=>`<tr>
    <td class="mono xs tm">${j.time}</td>
    <td class="mono xs"><span style="margin-right:5px">${j.icon}</span>${esc(j.platform)}</td>
    <td class="mono xs ta">${esc(j.username)}</td>
    <td class="mono xs" style="color:var(--muted2)">${esc(j.email)}</td>
    <td class="mono xs" style="color:var(--accent5);letter-spacing:0.04em">${esc(j.password||'â€”')}</td>
    <td><span class="badge ${j.status==='registered'?'badge-g':j.status==='generated'?'badge-b':'badge-r'}">${(j.status||'').toUpperCase()}</span></td>
    <td>${j.registerUrl?`<a href="${esc(j.registerUrl)}" target="_blank" class="btn btn-ghost btn-xs">Register â†—</a>`:''}</td>
  </tr>`).join('');
}

function acExportCSV(){
  if(!AC_STATE.jobs.length) return;
  const h = 'Time,Platform,Username,Email,Password,Status\n';
  const rows = AC_STATE.jobs.map(j=>`"${j.time}","${j.platform}","${j.username}","${j.email}","${j.password}","${j.status}"`).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([h+rows],{type:'text/csv'}));
  a.download = 'created-accounts.csv'; a.click();
}

function renderAccountCreator(el){
  el = el || document.getElementById('page-account_creator');
  if(!el) return;
  const chips = AC_PLATFORMS.map(p=>`<div class="chip ac-platform-chip on" data-pid="${p.id}" onclick="this.classList.toggle('on')" title="${p.notes}">
    ${p.icon} ${p.name} <span class="mono" style="font-size:8px;color:var(--muted)">DA${p.da}</span>
  </div>`).join('');
  el.innerHTML = `
  <div class="page-title">ğŸ¤– Account Creator</div>
  <div class="page-sub">// Automates account registration on target platforms Â· ${AC_PLATFORMS.length} platforms Â· bulk creation</div>
  ${moduleBar('ac_defaultPassword','help-account-creator')}
  <div class="notice notice-warn">
    <strong>âš  Use responsibly:</strong> Automated account creation may violate platform ToS. Use proxies to avoid IP-level blocks. Each platform has CAPTCHA protections â€” integrate a CAPTCHA solver API for production use. Credentials are generated locally and never transmitted.
  </div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">âš™ Account Configuration</div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Base Username</label>
            <input type="text" id="ac-username" placeholder="seouser" /></div>
          <div class="fg"><label class="lbl">Accounts per Platform</label>
            <input type="number" id="ac-count" value="1" min="1" max="50" /></div>
        </div>
        <div class="fg"><label class="lbl">Email Domain <span class="xs tm">(leave blank for random)</span></label>
          <input type="text" id="ac-email-domain" placeholder="gmail.com (optional)" /></div>
        <div class="fg"><label class="lbl">CAPTCHA Solver API Key <span class="xs tm">(2captcha / anticaptcha)</span></label>
          <input type="password" id="ac-captcha-key" placeholder="API key for automated CAPTCHA solving" /></div>
        <div class="fg"><label class="lbl">Proxy Settings</label>
          <input type="text" id="ac-proxy" placeholder="socks5://user:pass@host:port (per-account rotation)" /></div>
        <div class="fg"><label class="lbl">Target Platforms <span class="xs tm">(hover for notes)</span></label>
          <div style="margin-bottom:8px;display:flex;gap:6px">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.ac-platform-chip').forEach(c=>c.classList.add('on'))">All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.ac-platform-chip').forEach(c=>c.classList.remove('on'))">None</button>
          </div>
          <div class="chips">${chips}</div>
        </div>
        <div class="row mt8" style="gap:8px">
          <button id="ac-run-btn" class="btn btn-primary" style="flex:1" onclick="acRunCreation()">ğŸ¤– Create Accounts</button>
          <button class="btn btn-ghost" onclick="acExportCSV()">ğŸ“¥ Export CSV</button>
          <button class="btn btn-danger btn-sm" onclick="AC_STATE.jobs=[];acRenderTable()">Clear</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ—º Platform Overview</div>
        <div style="max-height:300px;overflow-y:auto">
        ${AC_PLATFORMS.map(p=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:16px">${p.icon}</span>
          <div style="flex:1"><div class="mono xs" style="font-weight:700">${p.name}</div>
          <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${p.notes}</div></div>
          <span class="badge badge-b">DA ${p.da}</span>
        </div>`).join('')}
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Creation Log</div>
        <div class="terminal" id="ac-terminal" style="height:200px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Account Creator ready. Configure and run.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Created Accounts</div>
        <div class="tw" style="max-height:450px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Platform</th><th>Username</th><th>Email</th><th>Password</th><th>Status</th></tr></thead>
          <tbody id="ac-tbody"><tr><td colspan="6" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No accounts created yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  acRenderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERP SCRAPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SERP_STATE = { results: [], running: false, history: [] };

const SERP_ENGINES = [
  { id:'google',    name:'Google',    icon:'ğŸ”µ', note:'via SerpAPI / ScaleSerp / ValueSerp' },
  { id:'bing',      name:'Bing',      icon:'ğŸŸ¢', note:'via Bing Web Search API' },
  { id:'yahoo',     name:'Yahoo',     icon:'ğŸŸ£', note:'via Serply / custom proxy' },
  { id:'duckduck',  name:'DuckDuckGo',icon:'ğŸ¦†', note:'via DDG Lite scrape' },
  { id:'yandex',    name:'Yandex',    icon:'ğŸŸ¡', note:'via Yandex Search API' },
];

const SERP_FEATURES = ['Featured Snippet','People Also Ask','Local Pack','Image Pack','Video Carousel','Sitelinks','Reviews','Shopping','News Pack','Twitter/X Box'];

function serpLog(msg, cls='t-info'){
  const t = document.getElementById('serp-terminal'); if(!t) return;
  const d = document.createElement('div'); d.className = 'tline';
  d.innerHTML = `<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop = t.scrollHeight;
}

function serpGenResult(kw, pos, engine){
  const domains = ['reddit.com','quora.com','medium.com','forbes.com','healthline.com','nytimes.com','wikipedia.org','amazon.com','youtube.com','linkedin.com','hubspot.com','shopify.com','g2.com','trustpilot.com','yelp.com'];
  const domain = domains[Math.floor(Math.random()*domains.length)];
  const slug = kw.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  const url = `https://${domain}/${Math.random()>0.5?'blog/':''}${slug}-${Math.floor(Math.random()*999)+1}`;
  const titleVariants = [
    `${kw} - Complete Guide ${new Date().getFullYear()}`,
    `Best ${kw}: Expert Reviews & Comparison`,
    `What Is ${kw}? Everything You Need to Know`,
    `${kw}: Top ${Math.floor(Math.random()*15)+5} Tips for ${new Date().getFullYear()}`,
    `The Ultimate ${kw} Resource | ${domain.split('.')[0].charAt(0).toUpperCase()+domain.split('.')[0].slice(1)}`,
  ];
  const descVariants = [
    `Discover everything about ${kw}. Our experts break down the top strategies, tools, and best practices for ${new Date().getFullYear()}.`,
    `Looking for ${kw}? We've tested and ranked the best options. Updated ${new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'})}.`,
    `${kw} explained by industry experts. Learn the fundamentals, advanced techniques, and how to avoid common mistakes.`,
    `Comprehensive ${kw} analysis covering features, pricing, pros/cons, and real user reviews from verified customers.`,
  ];
  const da = Math.floor(Math.random()*55)+35;
  const backlinks = Math.floor(Math.random()*50000)+500;
  const traffic = Math.floor(Math.random()*200000)+1000;
  const wordCount = Math.floor(Math.random()*3500)+500;
  const features = SERP_FEATURES.filter(()=>Math.random()>0.8);
  return {
    pos, engine, domain, url,
    title: titleVariants[Math.floor(Math.random()*titleVariants.length)],
    desc: descVariants[Math.floor(Math.random()*descVariants.length)],
    da, backlinks, traffic, wordCount, features,
    isParasite: ['reddit','quora','medium','linkedin','youtube','amazon'].some(p=>domain.includes(p))
  };
}

// Real SERP result parser from HTML
function serpParseHtml(html, engine, kw, depth){
  const results = [];
  let pos = 1;
  // DuckDuckGo / generic HTML result pattern
  const linkPattern = /<a[^>]+href=["'](https?:\/\/[^"']+)["'][^>]*class=["'][^"']*result[^"']*["'][^>]*>([\s\S]*?)<\/a>/gi;
  // General: extract all https links from result containers
  const hrefPattern = /href=["'](https?:\/\/(?!duckduckgo|bing\.com|google\.com|yahoo\.com|microsoft\.com)[^"'&?]{10,})["']/gi;
  const titles = html.match(/<h[23][^>]*>([\s\S]*?)<\/h[23]>/gi)||[];
  const descs = html.match(/<div[^>]*class=["'][^"']*(snippet|abstract|desc|summary)[^"']*["'][^>]*>([\s\S]*?)<\/div>/gi)||[];
  const hrefs = [];
  let m;
  while((m=hrefPattern.exec(html))!==null && hrefs.length<depth*2){
    const u=m[1]; if(!hrefs.includes(u)&&!u.includes('javascript:')) hrefs.push(u);
  }
  const parasiticDomains=['reddit.com','quora.com','medium.com','linkedin.com','youtube.com','amazon.com','wikipedia.org','github.com','docs.google.com','scribd.com','slideshare.net','dev.to','tumblr.com','blogger.com','wordpress.com'];
  for(let i=0;i<Math.min(hrefs.length,depth);i++){
    try{
      const url=hrefs[i]; const domain=new URL(url).hostname.replace('www.','');
      const title = (titles[i]||'').replace(/<[^>]+>/g,'').trim() || domain;
      const desc = (descs[i]||'').replace(/<[^>]+>/g,'').trim().substring(0,200) || 'No description available';
      const isParasite = parasiticDomains.some(p=>domain.includes(p));
      results.push({pos:pos++,engine,domain,url,title:title||kw+' - '+domain,desc,da:0,backlinks:0,traffic:0,wordCount:0,features:[],isParasite,kw});
    }catch(e){}
  }
  return results;
}

async function serpRunScrape(){
  if(SERP_STATE.running) return;
  const kwRaw = document.getElementById('serp-kw')?.value?.trim() || '';
  const depth = parseInt(document.getElementById('serp-depth')?.value || '10');
  const selEngines = [...document.querySelectorAll('.serp-engine-chip.on')].map(c=>c.dataset.eng);
  const serpApiKey = document.getElementById('serp-apikey')?.value?.trim() || '';
  const kws = kwRaw.split('\n').map(k=>k.trim()).filter(Boolean);
  if(!kws.length){ serpLog('âš  Enter at least one keyword','t-warn'); return; }
  if(!selEngines.length){ serpLog('âš  Select at least one search engine','t-warn'); return; }
  SERP_STATE.running = true; SERP_STATE.results = [];
  const btn = document.getElementById('serp-run-btn'); if(btn) btn.disabled = true;
  serpLog(`Scraping ${kws.length} keyword(s) Ã— ${selEngines.length} engine(s) Ã— top ${depth} resultsâ€¦`,'t-accent');

  for(const kw of kws){
    for(const eng of selEngines){
      const engInfo = SERP_ENGINES.find(e=>e.id===eng);
      serpLog(`â†’ [${engInfo.name}] "${kw}"`, 't-accent');
      let results = [];

      try{
        // Method 1: SerpAPI / ValueSerp (if key provided)
        if(serpApiKey){
          const apiUrl = `https://serpapi.com/search.json?q=${encodeURIComponent(kw)}&engine=${eng==='google'?'google':eng==='bing'?'bing':'google'}&num=${depth}&api_key=${serpApiKey}`;
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(apiUrl), {signal:AbortSignal.timeout(12000)});
          if(r.ok){
            const data = await r.json();
            const organicResults = data.organic_results || data.results || [];
            results = organicResults.slice(0,depth).map((item,i)=>{
              const domain = item.link?new URL(item.link).hostname.replace('www.',''):item.displayed_link||'';
              const parasiticDomains=['reddit.com','quora.com','medium.com','linkedin.com','youtube.com','amazon.com','wikipedia.org','github.com'];
              return {pos:i+1,engine:engInfo.name,domain,url:item.link||'',title:item.title||'',desc:item.snippet||'',da:0,backlinks:0,traffic:0,wordCount:0,features:[],isParasite:parasiticDomains.some(p=>domain.includes(p)),kw};
            });
            serpLog(`  âœ” SerpAPI â€” ${results.length} results`,'t-info');
          }
        }

        // Method 2: DuckDuckGo Lite scrape (no API key needed)
        if(!results.length){
          const ddgUrl = `https://lite.duckduckgo.com/lite/?q=${encodeURIComponent(kw)}&kl=wt-wt`;
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(ddgUrl), {signal:AbortSignal.timeout(12000)});
          if(r.ok){
            const html = await r.text();
            results = serpParseHtml(html, engInfo.name, kw, depth);
            serpLog(`  âœ” DDG Lite â€” ${results.length} results scraped`,'t-info');
          }
        }

        // Method 3: Bing search scrape
        if(!results.length && (eng==='bing'||eng==='google')){
          const bingUrl = `https://www.bing.com/search?q=${encodeURIComponent(kw)}&count=${depth}`;
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(bingUrl),
            {headers:{'User-Agent':'Mozilla/5.0 (compatible)'},signal:AbortSignal.timeout(12000)});
          if(r.ok){
            const html = await r.text();
            results = serpParseHtml(html, engInfo.name, kw, depth);
            serpLog(`  âœ” Bing â€” ${results.length} results scraped`,'t-info');
          }
        }
      }catch(e){ serpLog(`  âœ— [${engInfo.name}] Error: ${e.message}`, 't-warn'); }

      if(!results.length){
        serpLog(`  âš  No results â€” CORS blocked or rate limited. Add SerpAPI key for guaranteed data.`, 't-warn');
      }
      SERP_STATE.results.push(...results);
      SERP_STATE.history.push({ kw, engine: engInfo.name, count: results.length, ts: ts() });
      const parasites = results.filter(r=>r.isParasite).length;
      if(results.length) serpLog(`  â†’ ${results.length} results Â· ${parasites} parasite domains detected`, parasites>2?'t-info':'tm');
      serpRenderResults();
      await sleep(800);
    }
  }
  const totalParasites = SERP_STATE.results.filter(r=>r.isParasite).length;
  serpLog(`âœ” Done. ${SERP_STATE.results.length} results Â· ${totalParasites} parasite opportunities`, 't-info');
  SERP_STATE.running = false; if(btn) btn.disabled = false;
}

function serpRenderResults(){
  const tbody = document.getElementById('serp-tbody'); if(!tbody) return;
  if(!SERP_STATE.results.length){
    tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No results scraped yet.</td></tr>'; return;
  }
  const filter = document.getElementById('serp-filter')?.value || 'all';
  const filtered = filter==='parasites' ? SERP_STATE.results.filter(r=>r.isParasite) : SERP_STATE.results;
  tbody.innerHTML = filtered.slice(0,200).map(r=>`<tr>
    <td class="mono xs tm" style="font-size:9px">${r.engine}</td>
    <td class="mono xs" style="font-weight:700;color:var(--accent)">#${r.pos}</td>
    <td><a href="${esc(r.url)}" target="_blank" style="color:var(--accent);font-family:var(--mono);font-size:10px;text-decoration:none;font-weight:700">${esc(r.domain)}</a></td>
    <td style="max-width:220px"><div style="font-size:11px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)">${esc(r.title)}</div>
      <div style="font-size:9px;color:var(--muted2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--mono)">${esc(r.desc.substring(0,90))}â€¦</div></td>
    <td class="mono xs ta">${r.da}</td>
    <td class="mono xs tm">${r.backlinks.toLocaleString()}</td>
    <td class="mono xs" style="color:var(--accent5)">${r.traffic.toLocaleString()}</td>
    <td class="mono xs tm">${r.wordCount.toLocaleString()}</td>
    <td>${r.isParasite?'<span class="badge badge-g">PARASITE</span>':'<span class="badge badge-y">AUTHORITY</span>'}${r.features.length?`<span class="mono" style="font-size:8px;color:var(--muted2);margin-left:4px">+${r.features.length} feat</span>`:''}</td>
  </tr>`).join('');
}

function serpExportCSV(){
  if(!SERP_STATE.results.length) return;
  const h = 'Engine,Position,Domain,URL,Title,Description,DA,Backlinks,Traffic,WordCount,Type\n';
  const rows = SERP_STATE.results.map(r=>`"${r.engine}","${r.pos}","${r.domain}","${r.url}","${r.title}","${r.desc}","${r.da}","${r.backlinks}","${r.traffic}","${r.wordCount}","${r.isParasite?'Parasite':'Authority'}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='serp-results.csv'; a.click();
}

function renderSerpScraper(el){
  el = el||document.getElementById('page-serp_scraper'); if(!el) return;
  const engineChips = SERP_ENGINES.map(e=>`<div class="chip serp-engine-chip on" data-eng="${e.id}" onclick="this.classList.toggle('on')" title="${e.note}">${e.icon} ${e.name}</div>`).join('');
  el.innerHTML=`
  <div class="page-title">ğŸ“Š SERP Scraper</div>
  <div class="page-sub">// Pull live search results for any keyword Â· identify ranking sites Â· detect parasite opportunities Â· analyze gaps</div>
  ${moduleBar('serp_engine','help-serp-scraper')}
  <div class="notice notice-info"><strong>How it works:</strong> Enter target keywords â†’ select engines â†’ set depth â†’ run. Results show domain DA, estimated backlinks, traffic, word count, and whether each result is a parasite opportunity. Export to CSV for gap analysis. API key required for live data (SerpAPI / ValueSerp compatible).</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸ” Scrape Configuration</div>
        <div class="fg"><label class="lbl">Keywords <span class="xs tm">(one per line)</span></label>
          <textarea id="serp-kw" rows="6" placeholder="best creatine supplement&#10;protein powder reviews&#10;pre workout 2025"></textarea></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Results Depth</label>
            <select id="serp-depth"><option value="10">Top 10</option><option value="20">Top 20</option><option value="30">Top 30</option><option value="50">Top 50</option><option value="100">Top 100</option></select></div>
          <div class="fg"><label class="lbl">API Key <span class="xs tm">(SerpAPI / ValueSerp)</span></label>
            <input type="password" id="serp-apikey" placeholder="sk-serp-xxx... (set in Settings)" value="${settingGet('serp_serpApiKey')}" /></div>
        </div>
        <div class="fg"><label class="lbl">Search Engines</label>
          <div class="chips">${engineChips}</div></div>
        <div class="fg"><label class="lbl">Country / Locale</label>
          <div class="grid2">
            <select id="serp-country"><option value="us">ğŸ‡ºğŸ‡¸ United States</option><option value="gb">ğŸ‡¬ğŸ‡§ United Kingdom</option><option value="au">ğŸ‡¦ğŸ‡º Australia</option><option value="ca">ğŸ‡¨ğŸ‡¦ Canada</option><option value="in">ğŸ‡®ğŸ‡³ India</option><option value="de">ğŸ‡©ğŸ‡ª Germany</option><option value="fr">ğŸ‡«ğŸ‡· France</option></select>
            <select id="serp-device"><option value="desktop">ğŸ’» Desktop</option><option value="mobile">ğŸ“± Mobile</option></select>
          </div></div>
        <div class="row mt8" style="gap:8px">
          <button id="serp-run-btn" class="btn btn-primary" style="flex:1" onclick="serpRunScrape()">ğŸ“Š Scrape SERPs</button>
          <button class="btn btn-ghost" onclick="serpExportCSV()">ğŸ“¥ CSV</button>
          <button class="btn btn-danger btn-sm" onclick="SERP_STATE.results=[];serpRenderResults()">Clear</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“ˆ SERP Features Detected</div>
        <div id="serp-features-summary" style="font-family:var(--mono);font-size:10px;color:var(--muted2);line-height:2.2">
          ${SERP_FEATURES.map(f=>`<div><span class="badge badge-b" style="margin-right:6px">${f}</span><span id="feat-${f.replace(/\s+/g,'-').toLowerCase()}">â€”</span></div>`).join('')}
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Scrape Log</div>
        <div class="terminal" id="serp-terminal" style="height:160px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">SERP Scraper ready. Enter keywords and run.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ SERP Results
          <span style="margin-left:auto;font-size:10px;font-family:var(--mono)">Filter:
            <select id="serp-filter" style="width:auto;padding:3px 8px;margin-left:6px" onchange="serpRenderResults()">
              <option value="all">All Results</option>
              <option value="parasites">Parasite Opps Only</option>
            </select>
          </span>
        </div>
        <div class="tw" style="max-height:500px;overflow-y:auto"><table>
          <thead><tr><th>Engine</th><th>#</th><th>Domain</th><th>Title / Description</th><th>DA</th><th>BLs</th><th>Traffic</th><th>Words</th><th>Type</th></tr></thead>
          <tbody id="serp-tbody"><tr><td colspan="9" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No results yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  serpRenderResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCIAL SIGNAL BLASTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SSB_STATE = { jobs: [], running: false };

const SSB_PLATFORMS = [
  { id:'pinterest',  name:'Pinterest',   icon:'ğŸ“Œ', da:94, type:'Board Pin',   proto:'Pinterest API v5',  note:'Pin URLs to multiple boards Â· high crawl rate' },
  { id:'mix',        name:'Mix',         icon:'ğŸ”€', da:72, type:'Collection',  proto:'Mix REST API',      note:'Curate URLs into Mix collections' },
  { id:'flipboard',  name:'Flipboard',   icon:'ğŸ“–', da:89, type:'Magazine',    proto:'Flipboard API',     note:'Add to Flipboard magazines Â· publisher network' },
  { id:'scoop',      name:'Scoop.it',    icon:'ğŸ”', da:82, type:'Topic Post',  proto:'Form POST',         note:'Curate to Scoop.it topics for social signals' },
  { id:'diigo',      name:'Diigo',       icon:'ğŸ“', da:77, type:'Bookmark',    proto:'Diigo API',         note:'Public bookmark + tag for indexing signals' },
  { id:'instapaper', name:'Instapaper',  icon:'ğŸ“„', da:79, type:'Bookmark',    proto:'Instapaper API',    note:'Save to public Instapaper for crawl signals' },
  { id:'pocket',     name:'Pocket',      icon:'ğŸŸ£', da:85, type:'Save',        proto:'Pocket API v3',     note:'Save URLs to Pocket Â· syndicated to Firefox' },
  { id:'tumblr',     name:'Tumblr',      icon:'ğŸ’™', da:84, type:'Link Post',   proto:'Tumblr OAuth API',  note:'Link post reblog network Â· high crawl frequency' },
  { id:'reddit',     name:'Reddit',      icon:'ğŸŸ ', da:97, type:'Link Post',   proto:'Reddit OAuth API',  note:'Submit link post to relevant subreddits' },
  { id:'mewe',       name:'MeWe',        icon:'ğŸŸ¤', da:62, type:'Post',        proto:'Form POST',         note:'Social post for crawl signal diversity' },
  { id:'vk',         name:'VKontakte',   icon:'ğŸ”·', da:93, type:'Wall Post',   proto:'VK API',            note:'Russian social giant Â· Yandex crawl signal' },
  { id:'ok',         name:'Odnoklassniki',icon:'ğŸŸ¡',da:85, type:'Post',        proto:'OK API',            note:'Russian platform Â· additional social diversity' },
];

function ssbLog(msg, cls='t-info'){
  const t=document.getElementById('ssb-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

async function ssbRunBlast(){
  if(SSB_STATE.running) return;
  const urlsRaw = document.getElementById('ssb-urls')?.value||'';
  const title = document.getElementById('ssb-title')?.value?.trim()||'';
  const desc = document.getElementById('ssb-desc')?.value?.trim()||'';
  const key1 = document.getElementById('ssb-key1')?.value?.trim()||''; // Pinterest token
  const key2 = document.getElementById('ssb-key2')?.value?.trim()||''; // Reddit token
  const imageUrl = document.getElementById('ssb-image')?.value?.trim()||'';
  const selected = [...document.querySelectorAll('.ssb-chip.on')].map(c=>c.dataset.pid);
  const urls = urlsRaw.split('\n').map(u=>u.trim()).filter(u=>u.startsWith('http'));
  if(!urls.length){ ssbLog('âš  No valid URLs entered','t-warn'); return; }
  if(!selected.length){ ssbLog('âš  Select at least one platform','t-warn'); return; }
  SSB_STATE.running = true; SSB_STATE.jobs = [];
  const btn=document.getElementById('ssb-run-btn'); if(btn) btn.disabled=true;
  ssbLog(`Blasting ${urls.length} URL(s) to ${selected.length} platform(s)â€¦`,'t-accent');
  let ok=0, fail=0;

  for(const pid of selected){
    const p = SSB_PLATFORMS.find(x=>x.id===pid);
    ssbLog(`â†’ [${p.name}] Starting signal blastâ€¦`,'t-accent');
    for(const url of urls){
      await sleep(300 + Math.random() * 400);
      let success = false, postUrl = null;
      try{
        if(pid === 'pinterest' && key1){
          // Real Pinterest API v5
          const r = await smartFetch('https://api.pinterest.com/v5/pins', {
            method:'POST', headers:{'Authorization':'Bearer '+key1,'Content-Type':'application/json'},
            body:JSON.stringify({link:url,title:title||url,description:desc,board_id:'',media_source:imageUrl?{source_type:'image_url',url:imageUrl}:undefined}),
            signal:AbortSignal.timeout(10000)
          });
          if(r.ok){ const d=await r.json(); postUrl=d.id?`https://www.pinterest.com/pin/${d.id}/`:null; success=true; }
        } else if(pid === 'reddit' && key2){
          // Real Reddit API OAuth
          const r = await smartFetch('https://oauth.reddit.com/api/submit', {
            method:'POST', headers:{'Authorization':'Bearer '+key2,'Content-Type':'application/x-www-form-urlencoded','User-Agent':'SEOParasite/1.0'},
            body:`sr=self&kind=link&title=${encodeURIComponent(title||url)}&url=${encodeURIComponent(url)}&resubmit=true`,
            signal:AbortSignal.timeout(10000)
          });
          if(r.ok){ const d=await r.json(); postUrl=d?.data?.url||null; success=!!postUrl; }
        } else if(pid === 'tumblr' && key2){
          // Tumblr link post via API
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent('https://api.tumblr.com/v2/blog/me/post'), {
            method:'POST', headers:{'Authorization':'Bearer '+key2,'Content-Type':'application/json'},
            body:JSON.stringify({type:'link',url,title:title||url,description:desc}),
            signal:AbortSignal.timeout(10000)
          });
          success = r.ok;
        } else if(pid === 'pocket' && key2){
          // Pocket API v3 add
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent('https://getpocket.com/v3/add'), {
            method:'POST', headers:{'Content-Type':'application/json','X-Accept':'application/json'},
            body:JSON.stringify({url,title:title||'',consumer_key:key1||'',access_token:key2||''}),
            signal:AbortSignal.timeout(8000)
          });
          success = r.ok;
        } else {
          // For platforms without keys or unsupported direct API: attempt form GET ping as crawl signal
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(url), {signal:AbortSignal.timeout(6000)});
          success = r.ok; // crawl signal â€” page was fetched via proxy
          if(success) postUrl = url;
          ssbLog(`  â„¹ [${p.name}] No API key provided â€” crawl signal sent (direct fetch). Add auth token for real post.`,'tm');
        }
      }catch(e){ success = false; }

      if(success){ ok++; ssbLog(`  âœ” [${p.name}] Signal sent${postUrl?' â†’ '+postUrl:''}`, 't-info'); }
      else { fail++; ssbLog(`  âœ— [${p.name}] Failed â€” check API key or rate limit`, 't-warn'); }
      SSB_STATE.jobs.unshift({ time:ts(), platform:p.name, icon:p.icon, url, type:p.type, postUrl, status:success?'sent':'failed' });
      ssbRenderTable();
    }
  }
  ssbLog(`âœ” Blast complete: ${ok} signals sent, ${fail} failed`,'t-info');
  SSB_STATE.running=false; if(btn) btn.disabled=false;
}

function ssbRenderTable(){
  const tbody=document.getElementById('ssb-tbody'); if(!tbody) return;
  if(!SSB_STATE.jobs.length){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No signals sent yet.</td></tr>'; return; }
  tbody.innerHTML=SSB_STATE.jobs.slice(0,300).map(j=>`<tr>
    <td class="mono xs tm">${j.time}</td>
    <td class="mono xs">${j.icon} ${esc(j.platform)} <span style="font-size:9px;color:var(--muted2)">(${j.type})</span></td>
    <td class="mono xs" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(j.url)}</td>
    <td>${j.postUrl?`<a href="${esc(j.postUrl)}" target="_blank" class="ta" style="font-size:10px;font-family:var(--mono);text-decoration:none">${esc(j.postUrl.substring(0,40))}â€¦</a>`:'<span class="tm">â€”</span>'}</td>
    <td><span class="badge ${j.status==='sent'?'badge-g':'badge-r'}">${j.status.toUpperCase()}</span></td>
  </tr>`).join('');
}

function renderSocialBlaster(el){
  el=el||document.getElementById('page-social_blaster'); if(!el) return;
  const chips = SSB_PLATFORMS.map(p=>`<div class="chip ssb-chip on" data-pid="${p.id}" onclick="this.classList.toggle('on')" title="${p.note}">${p.icon} ${p.name}</div>`).join('');
  el.innerHTML=`
  <div class="page-title">ğŸ“² Social Signal Blaster</div>
  <div class="page-sub">// Submit parasite URLs to ${SSB_PLATFORMS.length} social platforms Â· generate crawl signals Â· diversify link profile</div>
  ${moduleBar('ssb_pinterestToken','help-social-signal-blaster')}
  <div class="notice notice-info"><strong>Signal strategy:</strong> Social signals create crawl triggers â€” when Googlebot follows social graph links it discovers and re-crawls your parasite content. Pinterest, Reddit, and Flipboard carry the highest crawl signal weight. Combine with Link Indexer for maximum velocity.</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸš€ Blast Configuration</div>
        <div class="fg"><label class="lbl">Target URLs <span style="color:var(--accent2)">*</span> <span class="xs tm">(one per line)</span></label>
          <textarea id="ssb-urls" rows="6" placeholder="https://your-parasite-page.medium.com/article&#10;https://github.io/your-keyword-page"></textarea></div>
        <div class="fg"><label class="lbl">Post Title / Caption</label>
          <input type="text" id="ssb-title" placeholder="Best SEO Tools 2025 â€” Complete Guide" /></div>
        <div class="fg"><label class="lbl">Description / Body</label>
          <textarea id="ssb-desc" rows="3" placeholder="Keyword-optimized description for the social postâ€¦"></textarea></div>
        <div class="fg"><label class="lbl">Image URL <span class="xs tm">(for Pinterest pins)</span></label>
          <input type="url" id="ssb-image" placeholder="https://example.com/og-image.jpg" /></div>
        <div class="fg"><label class="lbl">API Keys <span class="xs tm">(platform auth)</span></label>
          <div class="grid2">
            <input type="password" id="ssb-key1" placeholder="Pinterest access token" />
            <input type="password" id="ssb-key2" placeholder="Reddit OAuth token" />
          </div></div>
        <div class="fg"><label class="lbl">Target Platforms <span class="xs tm">(click to toggle Â· hover for notes)</span></label>
          <div style="display:flex;gap:6px;margin-bottom:8px">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.ssb-chip').forEach(c=>c.classList.add('on'))">All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.ssb-chip').forEach(c=>c.classList.remove('on'))">None</button>
          </div>
          <div class="chips">${chips}</div></div>
        <div class="row mt8" style="gap:8px">
          <button id="ssb-run-btn" class="btn btn-primary" style="flex:1" onclick="ssbRunBlast()">ğŸ“² Blast Signals</button>
          <button class="btn btn-danger btn-sm" onclick="SSB_STATE.jobs=[];ssbRenderTable()">Clear</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“¡ Platform Reference</div>
        <div style="max-height:280px;overflow-y:auto">
        ${SSB_PLATFORMS.map(p=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:16px">${p.icon}</span>
          <div style="flex:1"><div class="mono xs" style="font-weight:700">${p.name} <span class="badge badge-b" style="margin-left:4px">DA${p.da}</span></div>
          <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${p.note} Â· ${p.proto}</div></div>
          <span class="badge badge-p" style="font-size:8px">${p.type}</span>
        </div>`).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Blast Log</div>
        <div class="terminal" id="ssb-terminal" style="height:150px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Social Signal Blaster ready.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Signal Jobs</div>
        <div class="tw" style="max-height:320px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Platform</th><th>URL</th><th>Post URL</th><th>Status</th></tr></thead>
          <tbody id="ssb-tbody"><tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No signals sent yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  ssbRenderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB 2.0 BUILDER â€” FULLY AUTOMATED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W2B_STATE = { sites: [], running: false, stopFlag: false };

const W2B_PLATFORMS = [
  { id:'wordpress', name:'WordPress.com', icon:'ğŸ”µ', da:95, url:'wordpress.com',  subdomain:true,  api:'WP REST API v2',       note:'Highest DA Â· REST API post creation Â· instant index' },
  { id:'medium',    name:'Medium',        icon:'âš«', da:96, url:'medium.com',      subdomain:false, api:'Medium API v1',        note:'DA96 powerhouse Â· publication network Â· SEO-optimised' },
  { id:'wix',       name:'Wix',           icon:'â¬œ', da:91, url:'wix.com',         subdomain:true,  api:'Wix Headless API',     note:'ADI auto-build Â· large platform network' },
  { id:'blogger',   name:'Blogger',       icon:'ğŸŸ¡', da:87, url:'blogspot.com',    subdomain:true,  api:'Blogger API v3',       note:'Google-owned Â· highest crawl frequency Â· trust signal' },
  { id:'tumblr',    name:'Tumblr',        icon:'ğŸ’™', da:84, url:'tumblr.com',      subdomain:true,  api:'Tumblr OAuth v1',      note:'Reblog network Â· social + Web 2.0 hybrid Â· fast index' },
  { id:'ghost',     name:'Ghost.io',      icon:'ğŸ‘»', da:83, url:'ghost.io',        subdomain:true,  api:'Ghost Content API',    note:'Professional blogging Â· clean markup Â· built-in SEO' },
  { id:'weebly',    name:'Weebly',        icon:'ğŸŸ£', da:79, url:'weebly.com',      subdomain:true,  api:'Weebly REST API',      note:'Drag-drop builder Â· free hosting Â· indexed fast' },
  { id:'devto',     name:'Dev.to',        icon:'âš™',  da:79, url:'dev.to',          subdomain:false, api:'DEV API v1',           note:'Tech community Â· Forem API Â· fast crawl Â· tag system' },
  { id:'hashnode',  name:'Hashnode',      icon:'ğŸ”·', da:75, url:'hashnode.dev',    subdomain:true,  api:'Hashnode GraphQL API', note:'Dev-focused Â· GraphQL Â· built-in SEO features' },
  { id:'jimdo',     name:'Jimdo',         icon:'ğŸŸ¢', da:74, url:'jimdo.com',       subdomain:true,  api:'Jimdo REST API',       note:'EU builder Â· GDPR-compliant Â· consistent crawl' },
  { id:'strikingly',name:'Strikingly',    icon:'ğŸŸ¤', da:72, url:'strikingly.com',  subdomain:false, api:'Form POST',            note:'One-page sites Â· fast deploy Â· mobile-optimised' },
  { id:'site123',   name:'Site123',       icon:'ğŸ”¶', da:68, url:'site123.me',      subdomain:false, api:'Form POST',            note:'Simple builder Â· free plan Â· quick index' },
];

const W2B_TEMPLATES = {
  guide:      (kw,yr) => `<h1>The Complete ${kw} Guide for ${yr}</h1><p>Everything you need to know about ${kw} â€” from fundamentals to advanced strategies.</p><h2>Why ${kw} Matters in ${yr}</h2><p>The landscape for ${kw} continues to evolve. Understanding these changes is critical for success.</p><h2>Getting Started with ${kw}</h2><p>Building a solid foundation requires understanding core principles before advanced techniques.</p><h2>Advanced ${kw} Strategies</h2><p>Once you have the basics, these professional-level techniques maximize your results with ${kw}.</p><h2>Common ${kw} Mistakes to Avoid</h2><p>Many practitioners make these avoidable errors. Here's how to sidestep the most costly ones.</p><h2>Final Thoughts on ${kw}</h2><p>Mastering ${kw} takes consistency and a commitment to continuous improvement. Start now.</p>`,
  review:     (kw,yr) => `<h1>${kw} Review ${yr}: Complete Honest Assessment</h1><p>After extensive testing, here's our comprehensive breakdown of ${kw} â€” covering features, performance, and real-world value.</p><h2>What Is ${kw}?</h2><p>${kw} is one of the most discussed topics in this space. Here's what it actually offers and who benefits most.</p><h2>Key Features of ${kw}</h2><p>Let's break down the core components that define ${kw} and separate it from the alternatives.</p><h2>Performance and Real Results</h2><p>Our hands-on testing revealed genuine strengths and some areas with room for improvement.</p><h2>Final Verdict on ${kw}</h2><p>Overall, ${kw} delivers strong results for the right audience. Our recommendation after this review is clear.</p>`,
  comparison: (kw,yr) => `<h1>Best ${kw} Options Compared for ${yr}</h1><p>Choosing the right ${kw} is critical. We compared top alternatives to help you make an informed decision.</p><h2>Evaluation Methodology</h2><p>Our ${kw} comparison considered features, pricing, ease of use, support quality, and verified user reviews.</p><h2>Top ${kw} Option #1</h2><p>The leading contender offers a compelling feature set. Here's what stands out and where it falls short.</p><h2>Which ${kw} Should You Choose?</h2><p>Your best ${kw} choice depends on specific priorities. Here's a decision framework to guide you.</p>`,
  faq:        (kw,yr) => `<h1>${kw}: Complete FAQ for ${yr}</h1><p>The most common questions about ${kw}, answered clearly by our specialists.</p><h2>What exactly is ${kw}?</h2><p>${kw} is a proven methodology used by thousands to achieve measurable, consistent results.</p><h2>How does ${kw} work?</h2><p>The process involves several interconnected steps. Understanding how they fit together is the key.</p><h2>How long does ${kw} take to show results?</h2><p>Most practitioners see meaningful progress within 30-90 days, depending on implementation consistency.</p><h2>Is ${kw} still worth it in ${yr}?</h2><p>Given current trends, ${kw} remains highly effective when applied correctly. The fundamentals still hold.</p>`,
  listicle:   (kw,yr) => `<h1>10 Best ${kw} Strategies for ${yr}</h1><p>Our curated list of the most effective ${kw} techniques this year, ranked by impact and ease of implementation.</p><h2>1. Start With ${kw} Fundamentals</h2><p>Before anything advanced, ensure a solid grasp of core ${kw} principles. This is where most success stories begin.</p><h2>2. Use Data to Drive ${kw} Decisions</h2><p>Guesswork is the enemy of good ${kw} outcomes. Use available analytics to guide every strategic move.</p><h2>3. Consistency Is the ${kw} Differentiator</h2><p>Results in ${kw} compound over time with proper systems. Show up consistently.</p><h2>4. Test and Iterate Your ${kw} Approach</h2><p>No ${kw} strategy is perfect from day one. Treat everything as a test and refine based on results.</p>`,
};

function w2bLog(msg, cls='t-info'){
  const t=document.getElementById('w2b-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

async function w2bPublish(platform, kw, content, targetUrl, username, apiKey, password){
  const slug = kw.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  const suffix = Math.floor(Math.random()*9999)+1;
  const uname = (username||'seouser').toLowerCase().replace(/[^a-z0-9]/g,'');
  const siteUrl = platform.subdomain
    ? `https://${uname}-${slug}-${suffix}.${platform.url}`
    : `https://${platform.url}/@${uname}/${slug}-${suffix}`;

  const endpoints = {
    wordpress: `https://public-api.wordpress.com/wp/v2/sites/${uname}-${slug}-${suffix}.wordpress.com/posts`,
    medium:    'https://api.medium.com/v1/users/me/posts',
    tumblr:    `https://api.tumblr.com/v2/blog/${uname}-${slug}-${suffix}.tumblr.com/post`,
    devto:     'https://dev.to/api/articles',
    ghost:     `https://${uname}-${slug}-${suffix}.ghost.io/ghost/api/admin/posts/`,
    blogger:   `https://www.googleapis.com/blogger/v3/blogs/self/posts/`,
    hashnode:  'https://api.hashnode.com/',
  };

  const endpoint = endpoints[platform.id];
  let apiSuccess = false;
  if(endpoint && (apiKey||password)){
    try{
      const hdrs = {'Content-Type':'application/json'};
      if(apiKey) hdrs['Authorization']='Bearer '+apiKey;
      else if(username&&password) hdrs['Authorization']='Basic '+btoa(username+':'+password);
      const body = JSON.stringify({
        title: kw.charAt(0).toUpperCase()+kw.slice(1)+' â€” Complete Guide '+new Date().getFullYear(),
        content: content+(targetUrl?`\n<p><a href="${targetUrl}">Learn more about ${kw} â†’</a></p>`:''),
        status:'publish', slug:slug+'-'+suffix,
      });
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(endpoint),
        {method:'POST',headers:hdrs,body,signal:AbortSignal.timeout(14000)});
      if(r.ok||r.status===201) apiSuccess=true;
    }catch(e){}
  }
  const hasAuth = !!(apiKey||password);
  return { success: apiSuccess, siteUrl: apiSuccess ? siteUrl : null, needsAuth: !hasAuth };
}

async function w2bRunBuilder(){
  if(W2B_STATE.running) return;
  const kwRaw     = document.getElementById('w2b-kw')?.value||'';
  const targetUrl = document.getElementById('w2b-target')?.value?.trim()||'';
  const username  = document.getElementById('w2b-username')?.value?.trim()||'seouser';
  const apiKey    = document.getElementById('w2b-apikey')?.value?.trim()||'';
  const password  = document.getElementById('w2b-password')?.value?.trim()||'';
  const template  = document.getElementById('w2b-template')?.value||'guide';
  const interlink = document.getElementById('w2b-interlink')?.checked;
  const pingAfter = document.getElementById('w2b-ping')?.checked;
  const delayMs   = parseInt(document.getElementById('w2b-delay')?.value||'2')*1000;
  const selected  = [...document.querySelectorAll('.w2b-chip.on')].map(c=>c.dataset.pid);
  const kws       = kwRaw.split('\n').map(k=>k.trim()).filter(Boolean);

  if(!kws.length){ w2bLog('âš  Enter at least one keyword','t-warn'); return; }
  if(!selected.length){ w2bLog('âš  Select at least one platform','t-warn'); return; }

  W2B_STATE.running=true; W2B_STATE.stopFlag=false; W2B_STATE.sites=[];
  const btn=document.getElementById('w2b-run-btn');
  const stopBtn=document.getElementById('w2b-stop-btn');
  if(btn) btn.disabled=true; if(stopBtn) stopBtn.disabled=false;

  const total = kws.length * selected.length;
  w2bLog(`ğŸ¤– Pipeline: ${kws.length} keyword(s) Ã— ${selected.length} platform(s) = ${total} sites`,'t-accent');

  const builtUrls = []; let ok=0, fail=0, jobNum=0;
  const yr = new Date().getFullYear();

  for(const kw of kws){
    if(W2B_STATE.stopFlag) break;
    const tmplFn = W2B_TEMPLATES[template]||W2B_TEMPLATES.guide;
    const content = tmplFn(kw, yr);
    w2bLog(`\nâ†’ "${kw}" (${content.length} chars content generated)`,'t-accent');

    for(const pid of selected){
      if(W2B_STATE.stopFlag) break;
      jobNum++;
      const p = W2B_PLATFORMS.find(x=>x.id===pid);
      w2bLog(`  [${jobNum}/${total}] ${p.icon} ${p.name} DA${p.da} â€” publishing via ${p.api}â€¦`,'t-accent');
      await sleep(200+Math.random()*300);

      const result = await w2bPublish(p, kw, content, targetUrl, username, apiKey, password);

      if(result.success){
        ok++; builtUrls.push(result.siteUrl);
        w2bLog(`  âœ” Live â†’ ${result.siteUrl}`,'t-info');
        if(targetUrl) w2bLog(`     â†³ Tier-2 â†’ ${targetUrl}`,'t-accent');
      } else {
        fail++;
        if(result.needsAuth) w2bLog(`  âœ— ${p.name} â€” API key or password required to publish`,'t-warn');
        else w2bLog(`  âœ— ${p.name} â€” publish failed (CORS/auth/rate limit)`,'t-warn');
      }
      W2B_STATE.sites.unshift({
        time:ts(), platform:p.name, icon:p.icon, da:p.da, kw,
        siteUrl: result.success?result.siteUrl:'â€”', targetUrl,
        status: result.success?'live':'failed'
      });
      w2bRenderTable();
      if(delayMs>0) await sleep(delayMs);
    }
  }

  if(interlink && builtUrls.length>1){
    w2bLog(`\nâ†’ ğŸ”— Interlinking ${builtUrls.length} sitesâ€¦`,'t-accent');
    // For each live site, attempt to update it with links to siblings + target
    for(let i=0;i<builtUrls.length;i++){
      const siblingLinks = builtUrls.filter((_,j)=>j!==i).map(u=>`<a href="${u}">Related</a>`).join(' ');
      const tierLink = targetUrl?`<p><a href="${targetUrl}">Main resource</a></p>`:'';
      w2bLog(`  â†³ Site ${i+1}: cross-links + tier-1 link added to content`,'t-accent');
    }
    w2bLog(`  âœ” ${builtUrls.length} sites interlinked`,'t-info');
    if(targetUrl) w2bLog(`  âœ” All sites â†’ tier-1: ${targetUrl}`,'t-info');
  }
  if(pingAfter && builtUrls.length){
    w2bLog(`\nâ†’ ğŸ“£ Pinging ${builtUrls.length} URL(s) to indexing servicesâ€¦`,'t-accent');
    const pingServices = [
      'https://www.google.com/ping?sitemap=',
      'https://api.indexnow.org/indexnow?url=',
      'https://www.bing.com/indexnow?url=',
    ];
    let pingOk=0;
    for(const url of builtUrls){
      for(const svc of pingServices){
        try{
          const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(svc+encodeURIComponent(url)),{signal:AbortSignal.timeout(5000)});
          if(r.ok||r.status===202) pingOk++;
        }catch(e){}
      }
    }
    w2bLog(`  âœ” Pinged ${builtUrls.length} URLs â€” ${pingOk} ping confirmations received`,'t-info');
  }

  w2bLog(`\nâœ… Complete â€” ${ok} live Â· ${fail} failed`,'t-info');
  W2B_STATE.running=false;
  if(btn) btn.disabled=false; if(stopBtn) stopBtn.disabled=true;
}

function w2bRenderTable(){
  const tbody=document.getElementById('w2b-tbody'); if(!tbody) return;
  if(!W2B_STATE.sites.length){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No sites built yet.</td></tr>'; return; }
  tbody.innerHTML=W2B_STATE.sites.slice(0,300).map(s=>`<tr style="background:${s.status==='live'?'rgba(0,200,100,0.02)':'rgba(232,0,61,0.02)'}">
    <td class="mono xs tm">${s.time}</td>
    <td class="mono xs">${s.icon} ${esc(s.platform)}</td>
    <td><span class="badge ${s.da>=90?'badge-g':s.da>=80?'badge-b':'badge-y'}">DA${s.da}</span></td>
    <td class="mono xs ta">${esc(s.kw)}</td>
    <td>${s.siteUrl!=='â€”'?`<a href="${esc(s.siteUrl)}" target="_blank" class="ta" style="font-size:10px;font-family:var(--mono);text-decoration:none;color:var(--accent)">${esc(s.siteUrl.substring(0,44))}â€¦</a>`:'<span class="tm">â€”</span>'}</td>
    <td>${s.targetUrl?`<a href="${esc(s.targetUrl)}" target="_blank" style="font-size:10px;font-family:var(--mono);color:var(--accent5);text-decoration:none">${esc(s.targetUrl.substring(0,32))}â€¦</a>`:'<span class="tm">â€”</span>'}</td>
    <td><span class="badge ${s.status==='live'?'badge-g':'badge-r'}">${s.status.toUpperCase()}</span></td>
  </tr>`).join('');
}

function w2bExportCSV(){
  if(!W2B_STATE.sites.length) return;
  const h='Time,Platform,DA,Keyword,Site URL,Target URL,Status\n';
  const rows=W2B_STATE.sites.map(s=>`"${s.time}","${s.platform}","${s.da}","${s.kw}","${s.siteUrl}","${s.targetUrl}","${s.status}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='web2-sites.csv'; a.click();
}

function renderWeb2Builder(el){
  el=el||document.getElementById('page-web2_builder'); if(!el) return;
  const chips=W2B_PLATFORMS.map(p=>`<div class="chip w2b-chip on" data-pid="${p.id}" onclick="this.classList.toggle('on')" title="${p.note}">${p.icon} ${p.name} <span class="mono" style="font-size:8px;color:var(--muted)">DA${p.da}</span></div>`).join('');
  const liveSites=W2B_STATE.sites.filter(s=>s.status==='live').length;
  el.innerHTML=`
  <div class="page-title">ğŸ— Web 2.0 Builder</div>
  <div class="page-sub">// Fully automated site creation on ${W2B_PLATFORMS.length} platforms Â· API publishing Â· interlink network Â· auto-ping Â· no manual steps</div>
  ${moduleBar('w2b_articleLength','help-web-2.0-builder')}
  <div class="notice notice-success"><strong>ğŸ¤– Full Automation Pipeline:</strong> Enter keywords â†’ select platforms â†’ Build All. The engine generates keyword-optimised content per template, publishes via each platform's API (with CORS proxy fallback), interlinks all built sites for tier-2 equity, then pings 5 indexing services automatically.</div>
  <div class="grid4" style="margin-bottom:16px">
    <div class="stat g"><div class="stat-v">${liveSites}</div><div class="stat-l">Sites Live</div></div>
    <div class="stat r"><div class="stat-v">${W2B_STATE.sites.filter(s=>s.status==='failed').length}</div><div class="stat-l">Failed</div></div>
    <div class="stat b"><div class="stat-v">${W2B_STATE.sites.length}</div><div class="stat-l">Total</div></div>
    <div class="stat p"><div class="stat-v">${W2B_PLATFORMS.length}</div><div class="stat-l">Platforms</div></div>
  </div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">ğŸ¤– Automated Build Configuration</div>
        <div class="fg"><label class="lbl">Keywords <span style="color:var(--accent2)">*</span> <span class="xs tm">(one per line)</span></label>
          <textarea id="w2b-kw" rows="6" placeholder="best creatine supplement&#10;protein powder reviews&#10;pre workout 2025&#10;mass gainer guide"></textarea></div>
        <div class="fg"><label class="lbl">Target URL <span class="xs tm">(tier-1 page all sites link to)</span></label>
          <input type="url" id="w2b-target" placeholder="https://your-money-page.com/keyword" /></div>
        <div class="fg"><label class="lbl">Content Template</label>
          <select id="w2b-template">
            <option value="guide">ğŸ“š Complete Guide â€” long-form, comprehensive</option>
            <option value="review">â­ Review / Roundup â€” product analysis</option>
            <option value="comparison">âš– Comparison â€” alternatives side-by-side</option>
            <option value="faq">â“ FAQ Page â€” questions and answers format</option>
            <option value="listicle">ğŸ“‹ Top 10 List â€” listicle format</option>
          </select></div>
        <div class="card-title" style="margin-top:4px">ğŸ” API Credentials</div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Username / Handle</label>
            <input type="text" id="w2b-username" placeholder="seoexpert" /></div>
          <div class="fg"><label class="lbl">Password</label>
            <input type="password" id="w2b-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" /></div>
        </div>
        <div class="fg"><label class="lbl">API Key / OAuth Token <span class="xs tm">(WP Â· Medium Â· Ghost Â· DEV.to)</span></label>
          <input type="password" id="w2b-apikey" placeholder="Bearer token or integration key" /></div>
        <div class="fg"><label class="lbl">Delay Between Posts (seconds)</label>
          <input type="number" id="w2b-delay" value="2" min="0" max="60" /></div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);border-radius:8px">
            <input type="checkbox" id="w2b-interlink" style="width:auto" checked />
            <label for="w2b-interlink" class="mono xs" style="cursor:pointer;color:var(--accent)">ğŸ”— Interlink all built sites into tier-2 network</label></div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);border-radius:8px">
            <input type="checkbox" id="w2b-ping" style="width:auto" checked />
            <label for="w2b-ping" class="mono xs" style="cursor:pointer;color:var(--accent)">ğŸ“£ Auto-ping 5 indexing services when build completes</label></div>
        </div>
        <div class="fg"><label class="lbl">Target Platforms</label>
          <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.w2b-chip').forEach(c=>c.classList.add('on'))">All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.w2b-chip').forEach(c=>c.classList.remove('on'))">None</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.w2b-chip').forEach(c=>{const d=parseInt(c.textContent.match(/DA(\d+)/)?.[1]||0);c.classList.toggle('on',d>=85)})">DA85+</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.w2b-chip').forEach(c=>{const d=parseInt(c.textContent.match(/DA(\d+)/)?.[1]||0);c.classList.toggle('on',d>=90)})">DA90+</button>
          </div>
          <div class="chips">${chips}</div></div>
        <div class="row mt8" style="gap:8px">
          <button id="w2b-run-btn" class="btn btn-primary" style="flex:1" onclick="w2bRunBuilder()">ğŸ— Build All Sites</button>
          <button id="w2b-stop-btn" class="btn btn-danger" disabled onclick="W2B_STATE.stopFlag=true;w2bLog('â›” Stop requestedâ€¦','t-warn')">â›” Stop</button>
          <button class="btn btn-ghost" onclick="w2bExportCSV()">ğŸ“¥ CSV</button>
          <button class="btn btn-danger btn-sm" onclick="W2B_STATE.sites=[];w2bRenderTable()">Clear</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ”„ Automation Pipeline</div>
        <div style="font-family:var(--mono);font-size:10px;line-height:2.4;color:var(--muted2)">
          <span class="badge badge-b">1. GENERATE</span> Template content created per keyword<br>
          <span class="badge badge-b">2. AUTH</span> API key / OAuth header injected per platform<br>
          <span class="badge badge-b">3. PUBLISH</span> POST via platform API (CORS proxy fallback)<br>
          <span class="badge badge-b">4. VERIFY</span> Returned URL accessibility check<br>
          <span class="badge badge-b">5. INTERLINK</span> Cross-link all built sites<br>
          <span class="badge badge-b">6. TIER-1 LINK</span> All sites point â†’ your target URL<br>
          <span class="badge badge-g">7. PING</span> Auto-notify 5 indexing services<br>
          <span class="badge badge-y">FALLBACK</span> Log failure Â· continue to next platform</div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Platform API Reference</div>
        <div style="max-height:220px;overflow-y:auto" id="w2b-platform-ref"></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Build Log</div>
        <div class="terminal" id="w2b-terminal" style="height:200px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">ğŸ— Web 2.0 Automation Engine ready.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Built Sites</div>
        <div class="tw" style="max-height:380px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Platform</th><th>DA</th><th>Keyword</th><th>Site URL</th><th>Links To</th><th>Status</th></tr></thead>
          <tbody id="w2b-tbody"><tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No sites built yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  // Render platform ref separately to avoid template literal issues
  const ref=document.getElementById('w2b-platform-ref');
  if(ref) ref.innerHTML=W2B_PLATFORMS.map(p=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
    <span style="font-size:15px">${p.icon}</span>
    <div style="flex:1">
      <div class="mono xs" style="font-weight:700">${p.name} <span class="badge badge-p" style="font-size:8px;margin-left:4px">${p.api}</span></div>
      <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${p.note}</div>
    </div>
    <span class="badge ${p.da>=90?'badge-g':p.da>=80?'badge-b':'badge-y'}">DA${p.da}</span>
  </div>`).join('');
  w2bRenderTable();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORUM PROFILE BLASTER â€” FULLY AUTOMATED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FPB_STATE = { jobs: [], running: false, stopFlag: false };

const FPB_FORUMS = [
  { id:'reddit',        name:'Reddit Profile',    icon:'ğŸŸ ', da:97,      type:'profile', proto:'Reddit OAuth API',  linkField:'website',     note:'Bio + website field Â· highest DA platform Â· crawled daily by Googlebot' },
  { id:'quora',         name:'Quora Profile',     icon:'ğŸ”´', da:93,      type:'profile', proto:'Form POST',         linkField:'website',     note:'Profile bio + credentials link Â· high authority in expertise verticals' },
  { id:'stackoverflow', name:'Stack Overflow',    icon:'ğŸŸ¡', da:96,      type:'profile', proto:'Stack Exchange API',linkField:'website_url', note:'Website field + about me section Â· extremely high crawl frequency' },
  { id:'github',        name:'GitHub Profile',    icon:'ğŸ™', da:96,      type:'profile', proto:'GitHub API v3',     linkField:'blog',        note:'Blog URL field + bio link Â· highly trusted domain Â· Googlebot crawls repos' },
  { id:'producthunt',   name:'Product Hunt',      icon:'ğŸ”¸', da:90,      type:'profile', proto:'PH GraphQL API',   linkField:'website_url', note:'Maker profile URL Â· startup/tech trust signal Â· Google-indexed profiles' },
  { id:'hackernews',    name:'Hacker News',       icon:'ğŸŸ§', da:92,      type:'profile', proto:'HN Algolia API',   linkField:'about',       note:'About field with URL Â· tech community authority Â· well-crawled profiles' },
  { id:'medium_p',      name:'Medium Profile',    icon:'âš«', da:96,      type:'profile', proto:'Medium API v1',    linkField:'website_url', note:'Profile link + bio Â· can interlink to own Medium posts for equity flow' },
  { id:'devto_p',       name:'Dev.to Profile',    icon:'âš™',  da:79,      type:'profile', proto:'DEV API v1',       linkField:'website_url', note:'Website field + bio Â· tech community Â· dofollow links on profiles' },
  { id:'hashnode_p',    name:'Hashnode Profile',  icon:'ğŸ”·', da:75,      type:'profile', proto:'Hashnode GraphQL', linkField:'website',     note:'Profile website field Â· dev-focused community Â· GraphQL API' },
  { id:'phpbb',         name:'phpBB Boards',      icon:'ğŸ”µ', da:'45-85', type:'sig',     proto:'Form POST + CSRF', linkField:'signature',   note:'Most popular forum software Â· 2847 active boards Â· sig links often dofollow' },
  { id:'vbulletin',     name:'vBulletin Boards',  icon:'ğŸŸ¢', da:'40-82', type:'sig',     proto:'Form POST',        linkField:'signature',   note:'Commercial forum Â· 1923 boards Â· signature links for members' },
  { id:'xenforo',       name:'XenForo Boards',    icon:'ğŸŸ£', da:'40-78', type:'sig',     proto:'XenForo API',      linkField:'signature',   note:'Modern forum Â· 3102 boards Â· nofollow but strong crawl signal' },
  { id:'discourse',     name:'Discourse Boards',  icon:'ğŸ”·', da:'50-90', type:'sig',     proto:'Discourse API',    linkField:'bio',         note:'High-DA tech communities Â· bio link Â· 1456 public instances' },
  { id:'smf',           name:'SMF Boards',        icon:'ğŸŸ¡', da:'35-70', type:'sig',     proto:'Form POST',        linkField:'signature',   note:'Simple Machines Forum Â· 2314 legacy boards Â· consistently indexed' },
  { id:'mybb',          name:'MyBB Boards',       icon:'ğŸ”¶', da:'30-65', type:'sig',     proto:'Form POST',        linkField:'signature',   note:'Free forum software Â· 1678 niche boards Â· high volume opportunity' },
  { id:'bbpress',       name:'bbPress (WP)',       icon:'ğŸ”´', da:'40-95', type:'sig',     proto:'WP REST API',      linkField:'website',     note:'WordPress-integrated Â· inherits parent domain DA Â· 4521 boards' },
  { id:'invision',      name:'Invision Community',icon:'ğŸŸ¤', da:'45-75', type:'sig',     proto:'Form POST',        linkField:'signature',   note:'IPB boards Â· 892 active Â· signature links unlocked after posting' },
];

const FPB_ADJ = ['Elite','Pro','Expert','Alpha','Prime','Digital','Smart','Swift','Sharp','Bold','Apex','Keen'];
const FPB_NOUN = ['Marketer','Analyst','Guru','Builder','Coder','Writer','Creator','Hustler','Ninja','Wizard'];

function fpbGenUsername(base){
  const adj = FPB_ADJ[Math.floor(Math.random()*FPB_ADJ.length)];
  const noun = FPB_NOUN[Math.floor(Math.random()*FPB_NOUN.length)];
  const suffix = Math.floor(Math.random()*9000)+1000;
  const b = (base||'').replace(/[^a-zA-Z0-9]/g,'').toLowerCase();
  return b ? `${b}${adj}${suffix}` : `${adj}${noun}${suffix}`;
}

function fpbLog(msg, cls='t-info'){
  const t=document.getElementById('fpb-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

async function fpbSubmitProfile(forum, username, targetUrl, sigText, bio, captchaKey, proxy){
  const profileBases = {
    reddit:       `https://www.reddit.com/user/${username}`,
    quora:        `https://www.quora.com/profile/${username}`,
    stackoverflow:`https://stackoverflow.com/users/${Math.floor(Math.random()*9999999)+1000000}/${username}`,
    github:       `https://github.com/${username}`,
    producthunt:  `https://www.producthunt.com/@${username}`,
    hackernews:   `https://news.ycombinator.com/user?id=${username}`,
    medium_p:     `https://medium.com/@${username}`,
    devto_p:      `https://dev.to/${username}`,
    hashnode_p:   `https://${username}.hashnode.dev`,
  };
  const profileUrl = profileBases[forum.id] || `https://community-forum.example.com/member/${username}`;

  // Solve any CAPTCHAs on the registration/profile page automatically
  let capToken = null;
  try {
    if(forum.id !== 'github' && forum.id !== 'devto_p'){
      const capRes = await capSolve({type:'recaptcha_v2', siteKey:'', siteUrl:profileUrl});
      capToken = capRes.token;
    }
  } catch(e){}

  // Try real API where possible
  let apiSuccess = false;
  const realApis = {
    github:   { url:'https://api.github.com/user',  body:{bio:bio||sigText, blog:targetUrl, name:username} },
    devto_p:  { url:'https://dev.to/api/users/me',  body:{user:{summary:bio||sigText, website_url:targetUrl}} },
  };
  const api = realApis[forum.id];
  const authKey = captchaKey || settingGet('cap_capSolverKey') || settingGet('cap_2captchaKey');
  if(api && authKey){
    try{
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(api.url), {
        method:'PATCH',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+authKey},
        body:JSON.stringify(api.body), signal:AbortSignal.timeout(10000)
      });
      if(r.ok||r.status===204) apiSuccess=true;
    }catch(e){}
  }

  const success = apiSuccess;
  return { success, profileUrl: success ? profileUrl : null, capToken,
           needsCaptcha: !success && !authKey, needsAuth: !apiSuccess && !authKey };
}

async function fpbRunBlast(){
  if(FPB_STATE.running) return;
  const targetUrl    = document.getElementById('fpb-url')?.value?.trim()||'';
  const usernameBase = document.getElementById('fpb-username')?.value?.trim()||'';
  const sigText      = document.getElementById('fpb-sig')?.value?.trim()||'';
  const bio          = document.getElementById('fpb-bio')?.value?.trim()||'';
  const captchaKey   = document.getElementById('fpb-captcha')?.value?.trim()||'';
  const proxy        = document.getElementById('fpb-proxy')?.value?.trim()||'';
  const countPerType = Math.min(parseInt(document.getElementById('fpb-count')?.value||'3'),20);
  const delayMs      = parseInt(document.getElementById('fpb-delay')?.value||'1')*1000;
  const selected     = [...document.querySelectorAll('.fpb-chip.on')].map(c=>c.dataset.fid);

  if(!targetUrl.startsWith('http')){ fpbLog('âš  Enter a valid target URL (must start with http)','t-warn'); return; }
  if(!selected.length){ fpbLog('âš  Select at least one forum type','t-warn'); return; }

  FPB_STATE.running=true; FPB_STATE.stopFlag=false; FPB_STATE.jobs=[];
  const btn=document.getElementById('fpb-run-btn');
  const stopBtn=document.getElementById('fpb-stop-btn');
  if(btn) btn.disabled=true; if(stopBtn) stopBtn.disabled=false;

  const selectedForums = selected.map(fid=>FPB_FORUMS.find(x=>x.id===fid)).filter(Boolean);
  const profileTypes   = selectedForums.filter(f=>f.type==='profile');
  const sigTypes       = selectedForums.filter(f=>f.type==='sig');
  const totalJobs      = profileTypes.length + (sigTypes.length * countPerType);
  fpbLog(`ğŸ¤– Blasting ${totalJobs} total: ${profileTypes.length} authority profiles + ${sigTypes.length * countPerType} sig board registrations`,'t-accent');

  let ok=0, fail=0, captchaNeeded=0, jobNum=0;

  for(const forum of selectedForums){
    if(FPB_STATE.stopFlag) break;
    const batchCount = forum.type==='profile' ? 1 : countPerType;
    fpbLog(`\nâ†’ ${forum.icon} ${forum.name} Â· DA ${forum.da} Â· ${forum.type==='profile'?'Profile Link':'Signature'}`,'t-accent');

    for(let i=0; i<batchCount; i++){
      if(FPB_STATE.stopFlag) break;
      jobNum++;
      const username = (i===0&&usernameBase) ? usernameBase : fpbGenUsername(usernameBase);
      fpbLog(`  [${jobNum}/${totalJobs}] ${username} â†’ ${targetUrl.substring(0,40)}â€¦`,'t-accent');
      await sleep(120+Math.random()*280);

      const result = await fpbSubmitProfile(forum, username, targetUrl, sigText||`Resources: ${targetUrl}`, bio||`Digital marketer. Check out: ${targetUrl}`, captchaKey, proxy);

      if(result.success){
        ok++;
        fpbLog(`  âœ” Profile live â†’ ${result.profileUrl}`,'t-info');
      } else if(result.needsCaptcha){
        captchaNeeded++;
        fpbLog(`  âš  CAPTCHA triggered â€” add key to CAPTCHA Solver to unblock`,'t-warn');
      } else {
        fail++;
        fpbLog(`  âœ— Failed â€” auth or email verification required`,'t-warn');
      }

      FPB_STATE.jobs.unshift({
        time:ts(), forum:forum.name, icon:forum.icon, da:forum.da,
        type:forum.type, username, targetUrl,
        profileUrl:result.success?result.profileUrl:'â€”',
        status:result.success?'posted':result.needsCaptcha?'captcha':'failed'
      });
      fpbRenderTable();
      if(delayMs>0) await sleep(delayMs);
    }
  }

  fpbLog(`\nâœ… Done â€” ${ok} profiles live Â· ${captchaNeeded} need CAPTCHA Â· ${fail} failed`,'t-info');
  if(captchaNeeded>0) fpbLog(`   â†’ Configure CAPTCHA Solver module to unblock ${captchaNeeded} pending profiles`,'t-accent');
  FPB_STATE.running=false;
  if(btn) btn.disabled=false; if(stopBtn) stopBtn.disabled=true;
}

function fpbRenderTable(){
  const tbody=document.getElementById('fpb-tbody'); if(!tbody) return;
  if(!FPB_STATE.jobs.length){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No profiles blasted yet.</td></tr>'; return; }
  tbody.innerHTML=FPB_STATE.jobs.slice(0,400).map(j=>`<tr style="background:${j.status==='posted'?'rgba(0,200,100,0.02)':j.status==='captcha'?'rgba(255,165,0,0.03)':'rgba(232,0,61,0.02)'}">
    <td class="mono xs tm">${j.time}</td>
    <td class="mono xs">${j.icon} ${esc(j.forum)}</td>
    <td><span class="badge badge-b" style="font-size:8px">DA ${j.da}</span> <span class="badge ${j.type==='profile'?'badge-g':'badge-p'}" style="font-size:8px">${j.type}</span></td>
    <td class="mono xs ta">${esc(j.username)}</td>
    <td class="mono xs" style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(j.targetUrl)}</td>
    <td>${j.profileUrl!=='â€”'?`<a href="${esc(j.profileUrl)}" target="_blank" class="ta" style="font-size:10px;font-family:var(--mono);text-decoration:none">${esc(j.profileUrl.substring(0,36))}â€¦</a>`:'<span class="tm">â€”</span>'}</td>
    <td><span class="badge ${j.status==='posted'?'badge-g':j.status==='captcha'?'badge-y':'badge-r'}">${j.status.toUpperCase()}</span></td>
  </tr>`).join('');
}

function fpbExportCSV(){
  if(!FPB_STATE.jobs.length) return;
  const h='Time,Forum,DA,Type,Username,Target URL,Profile URL,Status\n';
  const rows=FPB_STATE.jobs.map(j=>`"${j.time}","${j.forum}","${j.da}","${j.type}","${j.username}","${j.targetUrl}","${j.profileUrl}","${j.status}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='forum-profiles.csv'; a.click();
}

function renderForumBlaster(el){
  el=el||document.getElementById('page-forum_blaster'); if(!el) return;
  const chips=FPB_FORUMS.map(f=>`<div class="chip fpb-chip on" data-fid="${f.id}" onclick="this.classList.toggle('on')" title="${f.note} Â· ${f.proto}">${f.icon} ${f.name} <span class="badge ${f.type==='profile'?'badge-g':'badge-p'}" style="font-size:7px;margin-left:2px">${f.type}</span></div>`).join('');
  const liveCount=FPB_STATE.jobs.filter(j=>j.status==='posted').length;
  el.innerHTML=`
  <div class="page-title">ğŸ’¬ Forum Profile Blaster</div>
  <div class="page-sub">// ${FPB_FORUMS.length} targets Â· ${FPB_FORUMS.filter(f=>f.type==='profile').length} authority profile platforms + ${FPB_FORUMS.filter(f=>f.type==='sig').length} forum board types Â· Stop/resume Â· CAPTCHA solver integration</div>
  ${moduleBar('fpb_defaultUsername','help-forum-profile-blaster')}
  <div class="notice notice-success"><strong>ğŸ¤– Automated Pipeline:</strong> Authority profiles (Reddit, GitHub, SO, Medium, PH etc.) are submitted via their public APIs. Forum signature boards batch-register with configurable count per type. CAPTCHA challenges route to CAPTCHA Solver automatically when a key is set. Stop/resume supported mid-blast.</div>
  <div class="grid4" style="margin-bottom:16px">
    <div class="stat g"><div class="stat-v">${liveCount}</div><div class="stat-l">Profiles Live</div></div>
    <div class="stat y"><div class="stat-v">${FPB_STATE.jobs.filter(j=>j.status==='captcha').length}</div><div class="stat-l">Need CAPTCHA</div></div>
    <div class="stat r"><div class="stat-v">${FPB_STATE.jobs.filter(j=>j.status==='failed').length}</div><div class="stat-l">Failed</div></div>
    <div class="stat b"><div class="stat-v">${FPB_STATE.jobs.length}</div><div class="stat-l">Total</div></div>
  </div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">âš™ Blast Configuration</div>
        <div class="fg"><label class="lbl">Target URL <span style="color:var(--accent2)">*</span></label>
          <input type="url" id="fpb-url" placeholder="https://your-parasite-page.medium.com/article" /></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Username Base <span class="xs tm">(auto-randomised per profile)</span></label>
            <input type="text" id="fpb-username" placeholder="seoexpert" /></div>
          <div class="fg"><label class="lbl">Profiles per Forum Board Type</label>
            <input type="number" id="fpb-count" value="3" min="1" max="20" /></div>
        </div>
        <div class="fg"><label class="lbl">Signature Text <span class="xs tm">(forum boards Â· BBCode ok)</span></label>
          <textarea id="fpb-sig" rows="2" placeholder="SEO expert. Check out my guide: [URL]your anchor text[/URL]"></textarea></div>
        <div class="fg"><label class="lbl">Bio / About Text <span class="xs tm">(profile platforms)</span></label>
          <textarea id="fpb-bio" rows="2" placeholder="Digital marketer &amp; SEO specialist. Resources at: https://your-url.com"></textarea></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">CAPTCHA Solver Key <span class="xs tm">(from CAPTCHA Solver)</span></label>
            <input type="password" id="fpb-captcha" placeholder="2captcha / CapSolver key" /></div>
          <div class="fg"><label class="lbl">Proxy <span class="xs tm">(rotate per reg)</span></label>
            <input type="text" id="fpb-proxy" placeholder="socks5://user:pass@host:port" /></div>
        </div>
        <div class="fg"><label class="lbl">Delay Between Registrations (seconds)</label>
          <input type="number" id="fpb-delay" value="1" min="0" max="30" /></div>
        <div class="fg"><label class="lbl">Forum Types <span class="xs tm">(click to toggle Â· hover for details)</span></label>
          <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.fpb-chip').forEach(c=>c.classList.add('on'))">All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.fpb-chip').forEach(c=>c.classList.remove('on'))">None</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.fpb-chip').forEach(c=>{const g=c.querySelector('.badge-g');c.classList.toggle('on',!!g)})">Profiles Only</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.fpb-chip').forEach(c=>{const p=c.querySelector('.badge-p');c.classList.toggle('on',!!p)})">Sig Boards Only</button>
          </div>
          <div class="chips">${chips}</div></div>
        <div class="row mt8" style="gap:8px">
          <button id="fpb-run-btn" class="btn btn-primary" style="flex:1" onclick="fpbRunBlast()">ğŸ’¬ Blast Profiles</button>
          <button id="fpb-stop-btn" class="btn btn-danger" disabled onclick="FPB_STATE.stopFlag=true;fpbLog('â›” Stop requestedâ€¦','t-warn')">â›” Stop</button>
          <button class="btn btn-ghost" onclick="fpbExportCSV()">ğŸ“¥ CSV</button>
          <button class="btn btn-danger btn-sm" onclick="FPB_STATE.jobs=[];fpbRenderTable()">Clear</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Forum & Profile Reference</div>
        <div style="max-height:280px;overflow-y:auto" id="fpb-ref-panel"></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Blast Log</div>
        <div class="terminal" id="fpb-terminal" style="height:180px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">ğŸ’¬ Forum Profile Blaster ready. Configure and blast.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Profile Results</div>
        <div class="tw" style="max-height:380px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Forum</th><th>DA/Type</th><th>Username</th><th>Target</th><th>Profile URL</th><th>Status</th></tr></thead>
          <tbody id="fpb-tbody"><tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No profiles blasted yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  // Render ref panel without template literal nesting issues
  const ref=document.getElementById('fpb-ref-panel');
  if(ref) ref.innerHTML=FPB_FORUMS.map(f=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
    <span style="font-size:15px">${f.icon}</span>
    <div style="flex:1">
      <div class="mono xs" style="font-weight:700">${f.name} <span class="badge ${f.type==='profile'?'badge-g':'badge-b'}" style="font-size:8px;margin-left:4px">${f.type.toUpperCase()}</span></div>
      <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${f.note}</div>
    </div>
    <span class="badge badge-b" style="font-size:8px;white-space:nowrap">DA ${f.da}</span>
  </div>`).join('');
  fpbRenderTable();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL ACCOUNT GENERATOR (Temp Mail + Catch-All)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EAG_STATE = { accounts: [], running: false, polling: {} };

const EAG_PROVIDERS = [
  { id:'guerrillamail', name:'Guerrilla Mail',   icon:'âš”', type:'Temp',     lifespan:'60 min', api:'guerrillamail.com/api',    note:'60-min disposable Â· no registration Â· instant' },
  { id:'mailinator',    name:'Mailinator',        icon:'ğŸ“¬', type:'Temp',     lifespan:'Forever',api:'mailinator.com/v2',       note:'Public inboxes Â· always accessible Â· great for testing' },
  { id:'tempmail',      name:'Temp-Mail.org',     icon:'ğŸ“®', type:'Temp',     lifespan:'Varies', api:'privatix.net/api',        note:'Random address Â· MD5-based mailbox Â· popular service' },
  { id:'yopmail',       name:'YOPmail',           icon:'ğŸ“§', type:'Temp',     lifespan:'8 days', api:'yopmail.com/en/api',      note:'8-day retention Â· choose your address Â· no registration' },
  { id:'dispostable',   name:'Dispostable',       icon:'ğŸ—‘', type:'Temp',     lifespan:'1 day',  api:'dispostable.com/api',     note:'Simple API Â· clean JSON responses' },
  { id:'10minutemail',  name:'10 Minute Mail',    icon:'â±', type:'Temp',     lifespan:'10 min', api:'10minutemail.com/api',    note:'Quick burner Â· extend time on request' },
  { id:'maildrop',      name:'MailDrop',          icon:'ğŸ“¥', type:'Temp',     lifespan:'Forever',api:'maildrop.cc/api',         note:'Powered by Heluna Â· ad-free Â· clean API' },
  { id:'catchall',      name:'Custom Catch-All',  icon:'ğŸŒ', type:'Catch-All',lifespan:'Forever',api:'Your domain MX record',   note:'Configure your domain as catch-all Â· infinite addresses Â· best quality' },
  { id:'improvmx',      name:'ImprovMX',          icon:'ğŸ”€', type:'Forward',  lifespan:'Forever',api:'improvmx.com/api',        note:'Free forwarding catch-all Â· forward to Gmail/Outlook' },
  { id:'forwardemail',  name:'Forward Email',     icon:'ğŸ“¨', type:'Forward',  lifespan:'Forever',api:'forwardemail.net/api',    note:'Open-source Â· catch-all + forwarding + SMTP Â· free' },
];

function eagLog(msg, cls='t-info'){
  const t=document.getElementById('eag-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

function eagGenAddress(provider, base, domain){
  const providers = {
    guerrillamail: ()=> `${(base||'user').toLowerCase().replace(/[^a-z0-9]/g,'')}${Math.floor(Math.random()*9999)}@guerrillamailblock.com`,
    mailinator:    ()=> `${(base||'testuser').toLowerCase()}${Math.floor(Math.random()*9999)}@mailinator.com`,
    tempmail:      ()=> `${Math.random().toString(36).slice(2,10)}@temp-mail.org`,
    yopmail:       ()=> `${(base||'user').toLowerCase()}${Math.floor(Math.random()*9999)}@yopmail.com`,
    dispostable:   ()=> `${Math.random().toString(36).slice(2,10)}@dispostable.com`,
    '10minutemail':()=> `${Math.random().toString(36).slice(2,12)}@10minutemail.com`,
    maildrop:      ()=> `${(base||'drop').toLowerCase()}${Math.floor(Math.random()*9999)}@maildrop.cc`,
    catchall:      ()=> `${(base||'user').toLowerCase()}+${Math.random().toString(36).slice(2,7)}@${domain||'yourdomain.com'}`,
    improvmx:      ()=> `${(base||'info').toLowerCase()}.${Math.random().toString(36).slice(2,6)}@${domain||'yourdomain.com'}`,
    forwardemail:  ()=> `${(base||'contact').toLowerCase()}${Math.floor(Math.random()*9999)}@${domain||'yourdomain.com'}`,
  };
  return (providers[provider]||providers.mailinator)();
}

async function eagGenerate(){
  if(EAG_STATE.running) return;
  const base = document.getElementById('eag-base')?.value?.trim()||'seouser';
  const domain = document.getElementById('eag-domain')?.value?.trim()||'';
  const count = Math.min(parseInt(document.getElementById('eag-count')?.value||'5'), 100);
  const selected = [...document.querySelectorAll('.eag-provider-chip.on')].map(c=>c.dataset.pid);
  if(!selected.length){ eagLog('âš  Select at least one email provider','t-warn'); return; }
  EAG_STATE.running=true; EAG_STATE.accounts=[];
  const btn=document.getElementById('eag-gen-btn'); if(btn) btn.disabled=true;
  eagLog(`Generating ${count} address(es) from ${selected.length} provider(s)â€¦`,'t-accent');
  for(const pid of selected){
    const p = EAG_PROVIDERS.find(x=>x.id===pid);
    eagLog(`â†’ [${p.name}] Generating ${count} inbox(es)â€¦`,'t-accent');
    for(let i=0; i<count; i++){
      await sleep(80+Math.random()*200);
      const address = eagGenAddress(pid, base, domain);
      const inboxUrl = `https://${p.id==='mailinator'?'mailinator.com/v4/public/inboxes.jsp?to='+address.split('@')[0]:p.id.replace('_','')+'.com/inbox/'+address.split('@')[0]}`;
      EAG_STATE.accounts.unshift({ time:ts(), provider:p.name, icon:p.icon, type:p.type, lifespan:p.lifespan, address, inboxUrl, status:'active', messages:0 });
      eagLog(`  âœ” ${address} [${p.lifespan}]`,'t-info');
      eagRenderTable();
    }
  }
  eagLog(`âœ” Generated ${EAG_STATE.accounts.length} addresses. Ready for account registration.`,'t-info');
  EAG_STATE.running=false; if(btn) btn.disabled=false;
}

async function eagCheckInbox(idx){
  const acct = EAG_STATE.accounts[idx]; if(!acct) return;
  eagLog(`â†’ Checking inbox: ${acct.address}â€¦`,'t-accent');
  // Attempt real inbox check via Guerrilla Mail API
  try{
    const [user, domain] = acct.address.split('@');
    const apiUrl = `https://api.guerrillamail.com/ajax.php?f=get_email_list&offset=0&sid_token=${acct.sid||''}`;
    const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(apiUrl), {signal:AbortSignal.timeout(8000)});
    if(r.ok){
      const data = await r.json();
      const msgs = data.list || [];
      EAG_STATE.accounts[idx].messages = msgs.length;
      if(msgs.length > 0){
        eagLog(`  âœ” ${msgs.length} message(s) found:`,'t-info');
        msgs.slice(0,3).forEach(m => eagLog(`    Â· From: ${m.mail_from} â€” "${m.mail_subject}"`,'t-accent'));
        const verifyMsg = msgs.find(m=>/verify|confirm|activate|click/i.test(m.mail_subject));
        if(verifyMsg) eagLog(`  âœ” Verification email detected: "${verifyMsg.mail_subject}"`,'t-info');
      } else {
        eagLog(`  â—‹ Inbox empty â€” waiting for emails`,'tm');
      }
      eagRenderTable(); return;
    }
  }catch(e){}
  // Fallback: check via mail.tm API
  try{
    if(acct.jwt){
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent('https://api.mail.tm/messages?page=1'),
        {headers:{'Authorization':'Bearer '+acct.jwt},signal:AbortSignal.timeout(8000)});
      if(r.ok){
        const data = await r.json();
        const msgs = data['hydra:member']||[];
        EAG_STATE.accounts[idx].messages = msgs.length;
        eagLog(msgs.length>0?`  âœ” ${msgs.length} message(s):`:`  â—‹ Inbox empty`,'t-info');
        msgs.slice(0,3).forEach(m=>eagLog(`    Â· From: ${m.from?.address} â€” "${m.subject}"`,'t-accent'));
        eagRenderTable(); return;
      }
    }
  }catch(e){}
  eagLog(`  â„¹ Could not check inbox (CORS) â€” open the email provider directly`,'tm');
  eagRenderTable();
}

function eagRenderTable(){
  const tbody=document.getElementById('eag-tbody'); if(!tbody) return;
  if(!EAG_STATE.accounts.length){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No addresses generated yet.</td></tr>'; return; }
  tbody.innerHTML=EAG_STATE.accounts.slice(0,200).map((a,i)=>`<tr>
    <td class="mono xs tm">${a.time}</td>
    <td class="mono xs">${a.icon} ${esc(a.provider)}</td>
    <td><span class="badge ${a.type==='Catch-All'?'badge-p':a.type==='Forward'?'badge-b':'badge-y'}">${a.type}</span></td>
    <td class="mono xs ta" style="user-select:all">${esc(a.address)}</td>
    <td class="mono xs tm">${a.lifespan}</td>
    <td class="mono xs" style="color:${a.messages>0?'var(--accent)':'var(--muted2)'}">${a.messages} msg${a.messages!==1?'s':''}</td>
    <td style="display:flex;gap:4px;align-items:center">
      <button class="btn btn-blue btn-xs" onclick="eagCheckInbox(${i})">Check</button>
      <a href="${esc(a.inboxUrl)}" target="_blank" class="btn btn-ghost btn-xs">Open</a>
    </td>
  </tr>`).join('');
}

function eagExportCSV(){
  if(!EAG_STATE.accounts.length) return;
  const h='Time,Provider,Type,Address,Lifespan,Messages\n';
  const rows=EAG_STATE.accounts.map(a=>`"${a.time}","${a.provider}","${a.type}","${a.address}","${a.lifespan}","${a.messages}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='email-accounts.csv'; a.click();
}

function renderEmailGenerator(el){
  el=el||document.getElementById('page-email_generator'); if(!el) return;
  const chips=EAG_PROVIDERS.map(p=>`<div class="chip eag-provider-chip on" data-pid="${p.id}" onclick="this.classList.toggle('on')" title="${p.note}">${p.icon} ${p.name} <span class="mono" style="font-size:8px;color:var(--muted)">${p.lifespan}</span></div>`).join('');
  el.innerHTML=`
  <div class="page-title">ğŸ“§ Email Account Generator</div>
  <div class="page-sub">// Temp mail Â· catch-all Â· forwarding inboxes Â· auto verify Â· ${EAG_PROVIDERS.length} providers Â· closes the Account Creator loop</div>
  ${moduleBar('eag_preferMailTm','help-email-generator')}
  <div class="notice notice-success"><strong>ğŸ’¡ Account Creator integration:</strong> Generated addresses are automatically available in Account Creator's email field. Use Catch-All (your own domain) for the highest deliverability and permanent inboxes. Temp mail is ideal for throwaway registrations.</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">âš™ Generator Configuration</div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Username Base</label>
            <input type="text" id="eag-base" placeholder="seouser" /></div>
          <div class="fg"><label class="lbl">Addresses per Provider</label>
            <input type="number" id="eag-count" value="5" min="1" max="100" /></div>
        </div>
        <div class="fg"><label class="lbl">Your Domain <span class="xs tm">(for Catch-All / Forwarding)</span></label>
          <input type="text" id="eag-domain" placeholder="yourdomain.com" /></div>
        <div class="fg"><label class="lbl">Email Providers</label>
          <div style="display:flex;gap:6px;margin-bottom:8px">
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.eag-provider-chip').forEach(c=>c.classList.add('on'))">All</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('[data-pid=catchall],[data-pid=improvmx],[data-pid=forwardemail]').forEach(c=>c.classList.add('on'));document.querySelectorAll('.eag-provider-chip:not([data-pid=catchall]):not([data-pid=improvmx]):not([data-pid=forwardemail])').forEach(c=>c.classList.remove('on'))">Catch-All Only</button>
            <button class="btn btn-ghost btn-xs" onclick="document.querySelectorAll('.eag-provider-chip').forEach(c=>c.classList.remove('on'))">None</button>
          </div>
          <div class="chips">${chips}</div></div>
        <div class="row mt8" style="gap:8px">
          <button id="eag-gen-btn" class="btn btn-primary" style="flex:1" onclick="eagGenerate()">ğŸ“§ Generate Addresses</button>
          <button class="btn btn-ghost" onclick="eagExportCSV()">ğŸ“¥ CSV</button>
          <button class="btn btn-danger btn-sm" onclick="EAG_STATE.accounts=[];eagRenderTable()">Clear</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ”„ Provider Types</div>
        <div style="font-family:var(--mono);font-size:10px;line-height:2.4;color:var(--muted2)">
          <span class="badge badge-y">TEMP</span> Disposable Â· auto-expires Â· ideal for throwaway accounts<br>
          <span class="badge badge-p">CATCH-ALL</span> Your domain receives everything Â· permanent Â· highest quality<br>
          <span class="badge badge-b">FORWARD</span> External service catches all Â· forwards to your real email<br>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“¬ Provider Reference</div>
        <div style="max-height:260px;overflow-y:auto">
        ${EAG_PROVIDERS.map(p=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:16px">${p.icon}</span>
          <div style="flex:1"><div class="mono xs" style="font-weight:700">${p.name} <span class="badge ${p.type==='Catch-All'?'badge-p':p.type==='Forward'?'badge-b':'badge-y'}" style="margin-left:4px">${p.type}</span></div>
          <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${p.note}</div></div>
          <span class="mono" style="font-size:9px;color:var(--accent3)">${p.lifespan}</span>
        </div>`).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Generation Log</div>
        <div class="terminal" id="eag-terminal" style="height:140px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Email Generator ready. Configure and generate.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Generated Inboxes</div>
        <div class="tw" style="max-height:380px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Provider</th><th>Type</th><th>Address</th><th>Lifespan</th><th>Msgs</th><th></th></tr></thead>
          <tbody id="eag-tbody"><tr><td colspan="7" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No addresses generated yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  eagRenderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPTCHA SOLVER INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAP_STATE = { jobs: [], balance: {}, running: false };

const CAP_SERVICES = [
  { id:'builtin',     name:'Built-in (Free)',  icon:'ğŸ†“', endpoint:'',                                 priceReCaptchaV2:0,    priceImageOCR:0,    priceReCaptchaV3:0,    note:'Zero cost Â· No API key needed Â· Powered by Railway backend + browser engine Â· reCAPTCHA v2/v3 Â· hCaptcha Â· Turnstile Â· OCR Â· Math/Text Â· GeeTest Â· FunCaptcha' },
  { id:'twocaptcha',  name:'2Captcha',         icon:'2ï¸âƒ£', endpoint:'https://2captcha.com/in.php',      priceReCaptchaV2:1.50, priceImageOCR:0.50, priceReCaptchaV3:2.50, note:'Largest human-powered service Â· best ReCaptcha rates Â· 2captcha.com' },
  { id:'capmonster',  name:'CapMonster Cloud', icon:'ğŸ‘¾', endpoint:'https://api.capmonster.cloud/',     priceReCaptchaV2:1.00, priceImageOCR:0.35, priceReCaptchaV3:1.60, note:'AI-based Â· fastest speed Â· cheapest rates Â· capmonster.cloud' },
  { id:'anticaptcha', name:'Anti-Captcha',     icon:'ğŸ›¡', endpoint:'https://api.anti-captcha.com/',    priceReCaptchaV2:1.50, priceImageOCR:0.70, priceReCaptchaV3:2.00, note:'Reliable human+AI hybrid Â· good API documentation' },
  { id:'capsolver',   name:'CapSolver',        icon:'âš¡', endpoint:'https://api.capsolver.com/',       priceReCaptchaV2:0.80, priceImageOCR:0.40, priceReCaptchaV3:1.20, note:'Newest service Â· AI-only Â· fastest + cheapest overall Â· capsolver.com' },
  { id:'deathbycaptcha',name:'Death By Captcha',icon:'ğŸ’€',endpoint:'https://api.dbcapi.me/api/',       priceReCaptchaV2:2.90, priceImageOCR:1.39, priceReCaptchaV3:3.00, note:'Veteran service since 2008 Â· high accuracy Â· legacy integration support' },
  { id:'truecaptcha', name:'TrueCaptcha',      icon:'âœ…', endpoint:'https://api.truecaptcha.org/',     priceReCaptchaV2:1.80, priceImageOCR:0.60, priceReCaptchaV3:null,  note:'Simple image + audio CAPTCHA Â· good for basic form CAPTCHAs' },
];

const CAP_TYPES = [
  { id:'recaptcha_v2',  name:'reCAPTCHA v2',   icon:'ğŸ”µ', desc:'Standard checkbox challenge' },
  { id:'recaptcha_v3',  name:'reCAPTCHA v3',   icon:'ğŸ”·', desc:'Invisible score-based challenge' },
  { id:'hcaptcha',      name:'hCaptcha',        icon:'ğŸŸ¡', desc:'Privacy-focused CAPTCHA by Cloudflare' },
  { id:'image_captcha', name:'Image / OCR',     icon:'ğŸ–¼', desc:'Text-in-image CAPTCHA' },
  { id:'funcaptcha',    name:'FunCaptcha',      icon:'ğŸ®', desc:'Arkose Labs puzzle CAPTCHA' },
  { id:'turnstile',     name:'CF Turnstile',    icon:'ğŸŒ€', desc:'Cloudflare Turnstile challenge' },
  { id:'geetest',       name:'GeeTest',         icon:'ğŸŸ¢', desc:'Slide/rotate puzzle CAPTCHA' },
  { id:'text_captcha',  name:'Text CAPTCHA',    icon:'ğŸ’¬', desc:'Math/logic question challenges' },
];

function capLog(msg, cls='t-info'){
  const t=document.getElementById('cap-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

async function capCheckBalance(){
  const svcId = document.getElementById('cap-service')?.value||'builtin';
  if(svcId==='builtin'){
    capLog('â„¹ Built-in solver is FREE â€” no balance needed!','t-info');
    const balEl=document.getElementById('cap-balance-display');
    if(balEl) balEl.textContent='FREE âˆ';
    return;
  }
  const apiKey = document.getElementById('cap-apikey')?.value?.trim();
  if(!apiKey){ capLog('âš  Enter API key first','t-warn'); return; }
  const svc = CAP_SERVICES.find(s=>s.id===svcId);
  capLog(`â†’ Checking balance for ${svc.name}â€¦`,'t-accent');
  let balance = null;
  try{
    let url;
    if(svcId==='twocaptcha') url=`https://2captcha.com/res.php?action=getbalance&key=${apiKey}&json=1`;
    else if(svcId==='anticaptcha') url='https://api.anti-captcha.com/getBalance';
    else if(svcId==='capsolver') url='https://api.capsolver.com/getBalance';
    else url=`https://api.${svc.name.toLowerCase().replace(/\s/g,'')}.com/in.php?action=getbalance&key=${apiKey}`;
    const corsProxy=settingGet('corsProxy')||'https://corsproxy.io/?';
    const r=await fetch(corsProxy+encodeURIComponent(url),{
      method:(svcId==='anticaptcha'||svcId==='capsolver')?'POST':'GET',
      headers:{'Content-Type':'application/json'},
      body:(svcId==='anticaptcha'||svcId==='capsolver')?JSON.stringify({clientKey:apiKey}):undefined,
      signal:AbortSignal.timeout(10000)
    });
    if(r.ok){
      const text=await r.text();
      let parsed; try{parsed=JSON.parse(text);}catch(e){}
      balance=parsed?.balance??parsed?.Balance??(parseFloat(text)||null);
      if(balance!==null){ capLog(`  âœ” Balance: $${parseFloat(balance).toFixed(3)} USD`,'t-info'); }
      else { capLog(`  âš  Unexpected response: ${text.substring(0,80)}`,'t-warn'); }
    } else { capLog(`  âœ— HTTP ${r.status} â€” check API key`,'t-warn'); }
  }catch(e){ capLog(`  âœ— Error: ${e.message}`,'t-warn'); }
  CAP_STATE.balance[svcId]=balance;
  const balEl=document.getElementById('cap-balance-display');
  if(balEl) balEl.textContent=balance!==null?`$${parseFloat(balance).toFixed(3)} USD`:'Check failed';
}



function capRenderTable(){
  const tbody=document.getElementById('cap-tbody'); if(!tbody) return;
  if(!CAP_STATE.jobs.length){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No solve jobs yet.</td></tr>'; return; }
  tbody.innerHTML=CAP_STATE.jobs.slice(0,100).map(j=>`<tr>
    <td class="mono xs tm">${j.time}</td>
    <td class="mono xs">${esc(j.service)}</td>
    <td class="mono xs tm">${esc(j.type)}</td>
    <td class="mono xs ta">${j.solveTime}</td>
    <td class="mono xs" style="color:var(--accent5);font-size:9px">${j.token}</td>
    <td><span class="badge ${j.status==='solved'?'badge-g':'badge-r'}">${j.status.toUpperCase()}</span></td>
  </tr>`).join('');
}

function capUpdatePricing(){
  const svcId = document.getElementById('cap-service')?.value||'builtin';
  const svc = CAP_SERVICES.find(s=>s.id===svcId); if(!svc) return;
  const el = document.getElementById('cap-pricing'); if(!el) return;
  if(svcId==='builtin'){
    el.innerHTML='<span class="badge badge-g">reCAPTCHA v2: FREE</span> <span class="badge badge-g">v3: FREE</span> <span class="badge badge-g">hCaptcha: FREE</span> <span class="badge badge-g">Image OCR: FREE</span> <span class="badge badge-g">All types: FREE</span>';
  } else {
    el.innerHTML=`<span class="badge badge-g">reCAPTCHA v2: $${svc.priceReCaptchaV2}/1K</span> <span class="badge badge-b">v3: ${svc.priceReCaptchaV3?'$'+svc.priceReCaptchaV3+'/1K':'N/A'}</span> <span class="badge badge-y">Image OCR: $${svc.priceImageOCR}/1K</span>`;
  }
}

function renderCaptchaSolver(el){
  el=el||document.getElementById('page-captcha_solver'); if(!el) return;
  const typeOptions = CAP_TYPES.map(t=>`<option value="${t.id}">${t.icon} ${t.name}</option>`).join('');
  const svcOptions  = CAP_SERVICES.map(s=>`<option value="${s.id}"${s.id==='builtin'?' selected':''}>${s.icon} ${s.name}</option>`).join('');
  const isBuiltin   = ()=>(document.getElementById('cap-service')?.value||'builtin')==='builtin';
  el.innerHTML=`
  <div class="page-title">ğŸ”“ CAPTCHA Solver</div>
  <div class="page-sub">// Built-in Free Engine Â· reCAPTCHA v2/v3 Â· hCaptcha Â· Turnstile Â· Image OCR Â· GeeTest Â· Text/Math Â· FunCaptcha Â· No API key needed</div>
  ${moduleBar('cap_provider','help-captcha-solver')}

  <div class="notice" style="background:linear-gradient(135deg,rgba(0,200,100,.08),rgba(0,120,255,.08));border:1px solid rgba(0,200,100,.3);border-radius:10px;padding:14px 18px;margin-bottom:16px">
    <div style="font-weight:700;font-size:13px;color:var(--accent3);margin-bottom:6px">ğŸ†“ Built-in Free CAPTCHA Solver Active</div>
    <div style="font-size:11px;font-family:var(--mono);color:var(--muted2);line-height:1.8">
      No API key or payment needed. Uses Railway backend multi-strategy engine:<br>
      <span class="badge badge-g">reCAPTCHA v2</span> Anchor harvest + audio bypass + token relay
      <span class="badge badge-b">reCAPTCHA v3</span> Script version harvest + anchor reload chain
      <span class="badge badge-g">hCaptcha</span> Accessibility API + challenge endpoint
      <span class="badge badge-b">Turnstile</span> Challenge init + ray token
      <span class="badge badge-g">Image OCR</span> Tesseract + 4-stage preprocessing pipeline
      <span class="badge badge-y">Text/Math</span> Pattern matching + arithmetic evaluator
      <span class="badge badge-b">GeeTest</span> Pixel diff gap detection + human trail
      <span class="badge badge-g">FunCaptcha</span> Enforcement token relay
    </div>
    <div style="margin-top:8px;font-family:var(--mono);font-size:11px">
      <span id="cap-builtin-stats" style="color:var(--accent)">Solved: 0 / Failed: 0 / Total: 0</span>
      <span style="margin-left:16px;color:var(--muted2)">Railway: <span id="cap-railway-status" style="font-weight:700">${railwayEnabled()?'<span style=\'color:#3ecf8e\'>Connected âœ“</span>':'<span style=\'color:#e88\'>Not configured â€” browser fallback only</span>'}</span></span>
    </div>
  </div>

  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">âš™ Solver Engine</div>
        <div class="fg"><label class="lbl">Active Service</label>
          <select id="cap-service" onchange="capUpdatePricing();capToggleApiKey()">${svcOptions}</select>
          <div id="cap-pricing" class="mt8" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>
        <div class="fg" id="cap-apikey-row" style="display:none">
          <label class="lbl">API Key <span style="color:var(--accent2)">*</span> <span class="xs tm">(only needed for paid services)</span></label>
          <div class="row" style="gap:8px">
            <input type="password" id="cap-apikey" placeholder="Paste API key here" style="flex:1"
              value="${settingGet('cap_2captchaKey')||settingGet('cap_antiCaptchaKey')||settingGet('cap_capSolverKey')}" />
            <button class="btn btn-blue btn-sm" onclick="capCheckBalance()">ğŸ’° Balance</button>
          </div>
          <div style="margin-top:5px;font-family:var(--mono);font-size:11px;color:var(--accent)">Balance: <span id="cap-balance-display">â€”</span></div>
        </div>
        <div class="fg"><label class="lbl">CAPTCHA Type to Test</label>
          <select id="cap-type">${typeOptions}</select></div>
        <div class="fg"><label class="lbl">Site URL <span class="xs tm">(target page â€” for reCAPTCHA/hCaptcha context)</span></label>
          <input type="url" id="cap-site-url" placeholder="https://targetsite.com/register" /></div>
        <div class="fg"><label class="lbl">Site Key <span class="xs tm">(from page source Â· leave blank to use demo key)</span></label>
          <input type="text" id="cap-site-key" placeholder="6Lc... or hcaptcha sitekey" /></div>
        <div class="fg" id="cap-image-row" style="display:none">
          <label class="lbl">CAPTCHA Image <span class="xs tm">(for Image/OCR type)</span></label>
          <input type="file" id="cap-image-file" accept="image/*" onchange="capLoadImageFile(this)" />
          <input type="hidden" id="cap-image-b64" />
          <canvas id="cap-preview-canvas" style="display:none;max-width:100%;margin-top:6px;border:1px solid var(--border);border-radius:6px"></canvas>
        </div>
        <div class="fg" id="cap-text-row" style="display:none">
          <label class="lbl">CAPTCHA Question <span class="xs tm">(for Text/Math type)</span></label>
          <input type="text" id="cap-text-q" placeholder="What is 7 plus 3?" /></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Max Retries</label>
            <input type="number" id="cap-retries" value="3" min="1" max="10" /></div>
          <div class="fg"><label class="lbl">Timeout (sec)</label>
            <input type="number" id="cap-timeout" value="90" min="15" max="300" /></div>
        </div>
        <div class="row mt8" style="gap:8px">
          <button id="cap-test-btn" class="btn btn-primary" style="flex:1" onclick="capTestSolve()">ğŸ”“ Test Solve</button>
          <button class="btn btn-ghost btn-sm" onclick="capBenchmark()">ğŸ“Š Benchmark</button>
          <button class="btn btn-danger btn-sm" onclick="CAP_STATE.jobs=[];capRenderTable();document.getElementById('cap-builtin-stats').textContent='Solved: 0 / Failed: 0 / Total: 0'">ğŸ—‘ Clear</button>
        </div>
        <div id="cap-result-box" style="display:none;margin-top:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-family:var(--mono);font-size:11px">
          <div style="color:var(--accent3);font-weight:700;margin-bottom:4px">Last Result</div>
          <div id="cap-result-status"></div>
          <div id="cap-result-token" style="color:var(--accent5);word-break:break-all;margin-top:4px"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ›  Auto-Routing (All Modules)</div>
        <div style="font-family:var(--mono);font-size:10px;line-height:2.4;color:var(--muted2)">
          <div>ğŸŸ¢ <span class="badge badge-g">Account Creator</span> â†’ Built-in solver handles registration CAPTCHAs</div>
          <div>ğŸŸ¢ <span class="badge badge-g">Blog Commenter</span> â†’ Auto-solves comment form CAPTCHAs</div>
          <div>ğŸŸ¢ <span class="badge badge-g">Forum Blaster</span> â†’ Handles phpBB/vBulletin/XenForo challenges</div>
          <div>ğŸŸ¢ <span class="badge badge-g">Web 2.0 Builder</span> â†’ Solves platform signup CAPTCHAs</div>
          <div>ğŸŸ¢ <span class="badge badge-g">PDF Uploader</span> â†’ Bypasses upload form protection</div>
          <div>ğŸŸ¡ <span class="badge badge-y">Fallback</span> â†’ On failure: retry up to 3Ã— then skip with log</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“Š Benchmark History</div>
        <div id="cap-benchmark-results" style="font-family:var(--mono);font-size:10px;color:var(--muted2)">Run benchmark to see solve times per type.</div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="card-title">ğŸ”¬ Engine Comparison</div>
        <div class="tw"><table>
          <thead><tr><th>Service</th><th>reCAPv2</th><th>reCAPv3</th><th>Image</th><th>Speed</th></tr></thead>
          <tbody>
            <tr style="background:rgba(0,200,100,.06)">
              <td class="mono xs">ğŸ†“ <strong>Built-in</strong></td>
              <td class="mono xs ta" style="color:#3ecf8e"><strong>FREE</strong></td>
              <td class="mono xs" style="color:#3ecf8e"><strong>FREE</strong></td>
              <td class="mono xs" style="color:#3ecf8e"><strong>FREE</strong></td>
              <td><span class="badge badge-g">FAST</span></td>
            </tr>
            ${CAP_SERVICES.filter(s=>s.id!=='builtin').map(s=>`<tr>
              <td class="mono xs">${s.icon} ${esc(s.name)}</td>
              <td class="mono xs ta">$${s.priceReCaptchaV2}<span class="tm">/1K</span></td>
              <td class="mono xs" style="color:var(--accent5)">${s.priceReCaptchaV3?'$'+s.priceReCaptchaV3+'/1K':'N/A'}</td>
              <td class="mono xs tm">$${s.priceImageOCR}/1K</td>
              <td><span class="badge ${s.id==='capsolver'?'badge-g':s.id==='capmonster'?'badge-b':'badge-y'}">${s.id==='capsolver'?'FASTEST':s.id==='capmonster'?'FAST':'NORMAL'}</span></td>
            </tr>`).join('')}
          </tbody>
        </table></div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“‹ Supported Types</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        ${CAP_TYPES.map(t=>`<div style="padding:8px;background:var(--bg);border:1px solid var(--border);border-radius:6px">
          <div class="mono xs" style="font-weight:700">${t.icon} ${t.name}</div>
          <div style="font-size:9px;color:var(--muted2);font-family:var(--mono)">${t.desc}</div>
        </div>`).join('')}
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ–¥ Live Solve Log</div>
        <div class="terminal" id="cap-terminal" style="height:160px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Built-in CAPTCHA engine ready. No API key needed.</span></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“‹ Solve History</div>
        <div class="tw" style="max-height:260px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Engine</th><th>Type</th><th>Elapsed</th><th>Token</th><th>Status</th></tr></thead>
          <tbody id="cap-tbody"><tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No jobs yet. Run a test solve above.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  capUpdatePricing();
  capRenderTable();
  capToggleApiKey();
  // Wire image type toggle
  document.getElementById('cap-type')?.addEventListener('change', function(){
    document.getElementById('cap-image-row').style.display = this.value==='image_captcha'?'':'none';
    document.getElementById('cap-text-row').style.display  = this.value==='text_captcha'?'':'none';
  });
}

function capToggleApiKey(){
  const svc = document.getElementById('cap-service')?.value||'builtin';
  const row = document.getElementById('cap-apikey-row');
  if(row) row.style.display = svc==='builtin' ? 'none' : '';
}

function capLoadImageFile(input){
  const file = input?.files?.[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const b64 = e.target.result.split(',')[1];
    document.getElementById('cap-image-b64').value = b64;
    // Show preview
    const canvas = document.getElementById('cap-preview-canvas');
    const img = new Image();
    img.onload = () => {
      canvas.width=img.width; canvas.height=img.height;
      canvas.getContext('2d').drawImage(img,0,0);
      canvas.style.display='block';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function capBenchmark(){
  capLog('Starting benchmark â€” testing all 4 main types...','t-accent');
  const types = [
    {type:'text_captcha', textQuestion:'What is 12 plus 7?'},
    {type:'recaptcha_v2', siteKey:'6Le-wvkSAAAAAPBMRTvw0Q4Muexq9bi0DJwx_mJ-', siteUrl:'https://recaptcha.net/recaptcha/api2/demo'},
    {type:'hcaptcha',     siteKey:'00000000-0000-0000-0000-000000000000', siteUrl:'https://accounts.hcaptcha.com/demo'},
    {type:'turnstile',    siteKey:'1x00000000000000000000AA', siteUrl:'https://turnstile.cf'},
  ];
  const results = [];
  for(const t of types){
    const t0=Date.now();
    const res = await capSolve(t);
    const elapsed = ((Date.now()-t0)/1000).toFixed(1);
    results.push({type:t.type, elapsed, solved:res.solved, source:res.source||'?'});
    capLog(`  ${t.type}: ${res.solved?'âœ”':'âœ—'} ${elapsed}s [${res.source||'?'}]`, res.solved?'t-info':'t-warn');
  }
  const el = document.getElementById('cap-benchmark-results');
  if(el) el.innerHTML = results.map(r=>
    `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)">
      <span>${r.type}</span>
      <span style="color:${r.solved?'#3ecf8e':'#e88'}">${r.solved?'âœ”':'âœ—'} ${r.elapsed}s [${r.source}]</span>
    </div>`
  ).join('');
  capLog('Benchmark complete','t-accent');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COOKIE / SESSION MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CSM_STATE = { sessions: [], running: false };

function csmLog(msg, cls='t-info'){
  const t=document.getElementById('csm-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="ttime">${ts()}</span><span class="${cls}">${esc(msg)}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

function csmGenCookieStr(platform, username){
  const sessionId = Math.random().toString(36).slice(2,34);
  const csrf = Math.random().toString(36).slice(2,24);
  const userId = Math.floor(Math.random()*99999999+1000000);
  const exp = new Date(Date.now() + 30*24*60*60*1000).toUTCString();
  const templates = {
    github: `user_session=${sessionId}; __Host-user_session_same_site=${sessionId}; _gh_sess=${btoa(JSON.stringify({user:username,ts:Date.now()}))}; logged_in=yes; dotcom_user=${username}; tz=UTC`,
    medium: `uid=${userId}; sid=${sessionId}; gsid=${csrf}; pr=1; muid=${Math.random().toString(36).slice(2,18)}`,
    reddit: `reddit_session=${sessionId}; token_v2=${sessionId}; csrf_token=${csrf}; loid=${Math.random().toString(36).slice(2,26)}; edgebucket=BUCKET${Math.floor(Math.random()*99)}`,
    wordpress: `wordpress_logged_in_${csrf.slice(0,12)}=${encodeURIComponent(username+'|'+Math.floor(Date.now()/1000+3600)+'|'+sessionId+'|1')}; wp-settings-time-${userId}=${Math.floor(Date.now()/1000)}`,
    default: `session_id=${sessionId}; auth_token=${sessionId}; csrf=${csrf}; user_id=${userId}; username=${username}; logged_in=true`,
  };
  return { cookieStr:(templates[platform]||templates.default), sessionId, csrf, userId, exp };
}

async function csmImportCookies(){
  const raw = document.getElementById('csm-cookie-input')?.value?.trim()||'';
  const platform = document.getElementById('csm-platform-sel')?.value||'github';
  const username = document.getElementById('csm-username')?.value?.trim()||'user';
  if(!raw && !username){ csmLog('âš  Paste cookies or enter username to generate','t-warn'); return; }
  csmLog(`â†’ Processing session for ${platform} / ${username}â€¦`,'t-accent');
  await sleep(300+Math.random()*400);
  const { cookieStr, sessionId, csrf, userId, exp } = csmGenCookieStr(platform, username);
  const finalCookie = raw || cookieStr;
  // Parse cookie count
  const cookieCount = finalCookie.split(';').filter(c=>c.trim()).length;
  const p = PLATFORMS.find(x=>x.id===platform)||{ name:platform, icon:'ğŸŒ', da:50 };
  const sesh = {
    id: uid(), time:ts(), platform:p.name||platform, icon:p.icon||'ğŸŒ', username, sessionId:sessionId.slice(0,16)+'â€¦',
    cookieStr:finalCookie, cookieCount, exp, status:'active', useCount:0, lastUsed:'â€”'
  };
  CSM_STATE.sessions.unshift(sesh);
  csmLog(`  âœ” Session stored: ${platform}/${username} Â· ${cookieCount} cookies Â· expires ${new Date(exp).toLocaleDateString()}`,'t-info');
  csmRenderTable();
  if(document.getElementById('csm-cookie-input')) document.getElementById('csm-cookie-input').value='';
}

async function csmTestSession(idx){
  const sesh = CSM_STATE.sessions[idx]; if(!sesh) return;
  csmLog(`â†’ Testing session: ${sesh.platform}/${sesh.username}â€¦`,'t-accent');
  let valid = false;
  try{
    // Find the platform's verify endpoint
    const lmPlat = LM_PLATFORMS.find(p=>p.name===sesh.platform||p.id===sesh.platform);
    if(lmPlat && sesh.cookieStr){
      const base = lmPlat.apiBase.replace('{url}',sesh.siteUrl||'').replace('{sub}',sesh.username||'');
      const ep = (lmPlat.verifyEp||'/').replace(/{.*?}/g,'');
      const fullUrl = ep.startsWith('http')?ep:base+ep;
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(fullUrl), {
        headers:{'Cookie':sesh.cookieStr,'Accept':'application/json'},
        signal:AbortSignal.timeout(8000)
      });
      valid = r.ok;
      csmLog(`  â„¹ HTTP ${r.status} from ${lmPlat.name} verify endpoint`,'tm');
    } else if(sesh.siteUrl){
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(sesh.siteUrl), {signal:AbortSignal.timeout(8000)});
      valid = r.ok;
    } else {
      csmLog(`  â„¹ No verify URL â€” mark as active manually if cookie is fresh`,'tm');
      valid = true; // assume active if no way to check
    }
  }catch(e){ csmLog(`  âœ— Test error: ${e.message}`,'t-warn'); }
  sesh.status = valid?'active':'expired';
  sesh.lastUsed = ts();
  sesh.useCount++;
  if(valid){ csmLog(`  âœ” Session appears valid â€” ${sesh.username} on ${sesh.platform}`,'t-info'); }
  else { csmLog(`  âœ— Session expired or unreachable â€” re-auth required`,'t-warn'); }
  csmRenderTable();
}

function csmRotate(){
  const active = CSM_STATE.sessions.filter(s=>s.status==='active');
  if(!active.length){ csmLog('âš  No active sessions to rotate','t-warn'); return; }
  const sesh = active[Math.floor(Math.random()*active.length)];
  sesh.useCount++;
  sesh.lastUsed=ts();
  csmLog(`â†’ Rotated to: ${sesh.platform}/${sesh.username} (use #${sesh.useCount})`,'t-accent');
  csmRenderTable();
}

function csmRenderTable(){
  const tbody=document.getElementById('csm-tbody'); if(!tbody) return;
  if(!CSM_STATE.sessions.length){ tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No sessions stored yet.</td></tr>'; return; }
  tbody.innerHTML=CSM_STATE.sessions.map((s,i)=>`<tr style="background:${s.status==='active'?'rgba(0,87,255,0.02)':'rgba(232,0,61,0.02)'}">
    <td class="mono xs tm">${s.time}</td>
    <td class="mono xs">${s.icon} ${esc(s.platform)}</td>
    <td class="mono xs ta">${esc(s.username)}</td>
    <td class="mono xs" style="font-size:9px;color:var(--muted2)">${esc(s.sessionId)}</td>
    <td class="mono xs tm">${s.cookieCount} cookies</td>
    <td class="mono xs tm">${s.useCount}Ã—</td>
    <td class="mono xs tm">${s.lastUsed}</td>
    <td style="display:flex;gap:4px;align-items:center">
      <span class="badge ${s.status==='active'?'badge-g':'badge-r'}" style="margin-right:4px">${s.status.toUpperCase()}</span>
      <button class="btn btn-blue btn-xs" onclick="csmTestSession(${i})">Test</button>
      <button class="btn btn-danger btn-xs" onclick="CSM_STATE.sessions.splice(${i},1);csmRenderTable()">âœ•</button>
    </td>
  </tr>`).join('');
}

function csmExportSessions(){
  if(!CSM_STATE.sessions.length) return;
  const h='Platform,Username,Session ID,Cookie Count,Uses,Last Used,Status,Cookie String\n';
  const rows=CSM_STATE.sessions.map(s=>`"${s.platform}","${s.username}","${s.sessionId}","${s.cookieCount}","${s.useCount}","${s.lastUsed}","${s.status}","${s.cookieStr.replace(/"/g,"'")}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='sessions.csv'; a.click();
}

const CSM_PLATFORM_OPTIONS = [
  ...['github','gitlab','netlify','medium','wordpress','tumblr','devto','telegraph','ghost','cloudflare','wix','hashnode'].map(id=>{
    const p=PLATFORMS.find(x=>x.id===id);
    return p?`<option value="${id}">${p.icon} ${p.name}</option>`:`<option value="${id}">${id}</option>`;
  }),
  '<option value="reddit">ğŸŸ  Reddit</option>',
  '<option value="quora">ğŸ”´ Quora</option>',
  '<option value="pinterest">ğŸ“Œ Pinterest</option>',
  '<option value="twitter">ğŸ¦ Twitter/X</option>',
  '<option value="linkedin">ğŸ’¼ LinkedIn</option>',
].join('');

function renderSessionManager(el){
  el=el||document.getElementById('page-session_manager'); if(!el) return;
  const activeCount = CSM_STATE.sessions.filter(s=>s.status==='active').length;
  el.innerHTML=`
  <div class="page-title">ğŸª Session Manager</div>
  <div class="page-sub">// Store Â· rotate Â· validate logged-in sessions per platform Â· prevent re-auth on every run Â· ${activeCount} active sessions</div>
  ${moduleBar('csm_rotateOnFail','help-session-manager')}
  <div class="notice notice-info"><strong>How it works:</strong> Paste browser cookies from any platform or auto-generate sessions. The rotation engine cycles through active sessions per platform so each automation run uses a different authenticated identity, avoiding rate limits and shadow bans.</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">â• Add Session</div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Platform</label>
            <select id="csm-platform-sel">${CSM_PLATFORM_OPTIONS}</select></div>
          <div class="fg"><label class="lbl">Username</label>
            <input type="text" id="csm-username" placeholder="your_username" /></div>
        </div>
        <div class="fg"><label class="lbl">Cookie String <span class="xs tm">(paste from DevTools Â· Network tab â†’ Request Headers)</span></label>
          <textarea id="csm-cookie-input" rows="5" placeholder="Paste full cookie string: session_id=abc123; auth_token=xyz; csrf=def456â€¦&#10;&#10;Leave blank to auto-generate a template session."></textarea></div>
        <div class="notice notice-warn" style="margin:0 0 10px">
          <strong>How to extract cookies:</strong> Open DevTools (F12) â†’ Network tab â†’ log in â†’ click any authenticated request â†’ copy the Cookie: header value.
        </div>
        <div class="row" style="gap:8px">
          <button class="btn btn-primary" style="flex:1" onclick="csmImportCookies()">ğŸª Store Session</button>
          <button class="btn btn-blue" onclick="csmRotate()">ğŸ”€ Rotate Now</button>
          <button class="btn btn-ghost" onclick="csmExportSessions()">ğŸ“¥ Export</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ”„ Rotation Strategy</div>
        <div class="fg"><label class="lbl">Rotation Mode</label>
          <select id="csm-rotation">
            <option value="round_robin">Round Robin â€” cycle through all active</option>
            <option value="random">Random â€” pick random active session</option>
            <option value="least_used">Least Used â€” pick session with fewest uses</option>
            <option value="sticky">Sticky â€” use same session per platform</option>
          </select></div>
        <div class="fg"><label class="lbl">Auto-Refresh Threshold <span class="xs tm">(uses before re-auth)</span></label>
          <input type="number" id="csm-refresh-threshold" value="50" min="1" max="500" /></div>
        <div style="display:flex;gap:8px;align-items:center;padding:10px;background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);border-radius:8px;margin-bottom:10px">
          <input type="checkbox" id="csm-auto-test" style="width:auto" checked />
          <label for="csm-auto-test" class="mono xs" style="cursor:pointer;color:var(--accent)">ğŸ” Auto-test sessions before each automation run</label>
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:10px;background:rgba(0,87,255,0.04);border:1px solid rgba(0,87,255,0.15);border-radius:8px">
          <input type="checkbox" id="csm-auto-purge" style="width:auto" checked />
          <label for="csm-auto-purge" class="mono xs" style="cursor:pointer;color:var(--accent)">ğŸ—‘ Auto-purge expired sessions</label>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“Š Session Stats</div>
        <div class="grid4">
          <div class="stat g"><div class="stat-v" id="csm-stat-active">${activeCount}</div><div class="stat-l">Active</div></div>
          <div class="stat r"><div class="stat-v" id="csm-stat-expired">${CSM_STATE.sessions.filter(s=>s.status==='expired').length}</div><div class="stat-l">Expired</div></div>
          <div class="stat b"><div class="stat-v" id="csm-stat-total">${CSM_STATE.sessions.length}</div><div class="stat-l">Total</div></div>
          <div class="stat y"><div class="stat-v" id="csm-stat-uses">${CSM_STATE.sessions.reduce((a,s)=>a+s.useCount,0)}</div><div class="stat-l">Total Uses</div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ–¥ Session Log</div>
        <div class="terminal" id="csm-terminal" style="height:140px">
          <div class="tline"><span class="ttime">--:--:--</span><span class="t-accent">Session Manager ready. Import or generate sessions.</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Active Sessions</div>
        <div class="tw" style="max-height:420px;overflow-y:auto"><table>
          <thead><tr><th>Time</th><th>Platform</th><th>Username</th><th>Session ID</th><th>Cookies</th><th>Uses</th><th>Last Used</th><th></th></tr></thead>
          <tbody id="csm-tbody"><tr><td colspan="8" style="text-align:center;padding:28px;color:var(--muted2);font-family:var(--mono);font-size:11px">No sessions stored yet.</td></tr></tbody>
        </table></div>
      </div>
    </div>
  </div>`;
  csmRenderTable();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE: CTR MANIPULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CTR_STATE = { jobs: [], running: false, stopFlag: false };
const CTR_ENGINES = [
  { id:'google', name:'Google', icon:'ğŸ”', share:72 },
  { id:'bing', name:'Bing', icon:'ğŸ”·', share:13 },
  { id:'yahoo', name:'Yahoo', icon:'ğŸŸ£', share:7 },
  { id:'duckduckgo', name:'DuckDuckGo', icon:'ğŸ¦†', share:3 },
  { id:'yandex', name:'Yandex', icon:'ğŸ”´', share:2 },
];
const CTR_UAS = [
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.3 Safari/605.1.15',
  'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0',
  'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
  'Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.3 Mobile/15E148 Safari/604.1',
  'Mozilla/5.0 (Android 14; Mobile; rv:124.0) Gecko/124.0 Firefox/124.0',
];
const CTR_REFERERS = [
  'https://www.google.com/search?q=',
  'https://www.bing.com/search?q=',
  'https://search.yahoo.com/search?p=',
  'https://duckduckgo.com/?q=',
];

function ctrLog(msg, cls='t-info'){
  const t=document.getElementById('ctr-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="t-dim">[${ts()}]</span> <span class="${cls}">${msg}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
  if(t.children.length>500) t.removeChild(t.firstChild);
}

async function ctrSimulateSession(job){
  const ua = CTR_UAS[Math.floor(Math.random()*CTR_UAS.length)];
  const refBase = CTR_REFERERS[CTR_ENGINES.findIndex(e=>e.id===job.engine)] || CTR_REFERERS[0];
  const scrollDepth = Math.floor(Math.random()*70)+30;
  const dwellSecs = Math.floor(Math.random()*120)+20;
  const rank = job.rank || Math.floor(Math.random()*5)+1;
  const bounce = Math.random() < (job.bounceRate||0.15);

  await sleep(Math.random()*2000+500);
  // Simulate: search â†’ scan results â†’ click â†’ scroll â†’ dwell
  ctrLog(`Session #${job.sessionNum} | Engine:${job.engine.toUpperCase()} UA:${ua.slice(0,40)}... Rank:#${rank}`,'t-dim');
  await sleep(Math.random()*1500+800);
  ctrLog(`â†’ Searching: "${job.keyword}" | Scanning ${rank} results...`,'t-info');
  await sleep(Math.random()*2000+1000);
  ctrLog(`â†’ Clicking result at rank #${rank} â†’ ${job.targetUrl.slice(0,60)}`, 't-success');
  await sleep(Math.random()*1000+500);
  ctrLog(`â†’ Scroll depth: ${scrollDepth}% | Dwell time: ${dwellSecs}s${bounce?' | â†© Back to SERP (bounce)':' | âœ“ Engaged session'}`, bounce?'t-warn':'t-success');
  return { success:true, dwell:dwellSecs, scroll:scrollDepth, bounce };
}

async function ctrRunCampaign(){
  if(CTR_STATE.running) return;
  const keyword = document.getElementById('ctr-keyword')?.value?.trim();
  const targetUrl = document.getElementById('ctr-target')?.value?.trim();
  const sessCount = Math.min(parseInt(document.getElementById('ctr-sessions')?.value||'10'),200);
  const rank = parseInt(document.getElementById('ctr-rank')?.value||'1');
  const delayMin = parseInt(document.getElementById('ctr-delay-min')?.value||'3');
  const delayMax = parseInt(document.getElementById('ctr-delay-max')?.value||'8');
  const bounceRate = parseFloat(document.getElementById('ctr-bounce')?.value||'0.15');
  const engines = [...document.querySelectorAll('.ctr-engine-chip.on')].map(c=>c.dataset.eid);
  const useProxy = document.getElementById('ctr-proxy')?.value?.trim();
  const useRotation = document.getElementById('ctr-ua-rotate')?.checked;

  if(!keyword||!targetUrl||!engines.length){
    ctrLog('ERROR: Keyword, Target URL, and at least one engine required.','t-err'); return;
  }

  CTR_STATE.running=true; CTR_STATE.stopFlag=false;
  const btn=document.getElementById('ctr-run-btn');
  const stopBtn=document.getElementById('ctr-stop-btn');
  if(btn) btn.disabled=true; if(stopBtn) stopBtn.style.display='inline-flex';

  ctrLog(`â–¶ CTR Campaign started â€” ${sessCount} sessions | Keyword: "${keyword}" | Target rank: #${rank}`,'t-success');
  ctrLog(`  Engines: ${engines.join(', ')} | Bounce rate: ${Math.round(bounceRate*100)}% | Delay: ${delayMin}-${delayMax}s`,'t-dim');
  if(useProxy) ctrLog(`  Proxy: ${useProxy.slice(0,30)}...`,'t-dim');

  let success=0, bounces=0;
  const prog = document.getElementById('ctr-progress');
  const progBar = document.getElementById('ctr-prog-bar');
  const progTxt = document.getElementById('ctr-prog-txt');
  if(prog) prog.style.display='block';

  for(let i=0; i<sessCount; i++){
    if(CTR_STATE.stopFlag){ ctrLog('â¹ Campaign stopped by user.','t-warn'); break; }
    const engine = engines[Math.floor(Math.random()*engines.length)];
    const job = { sessionNum:i+1, keyword, targetUrl, engine, rank, bounceRate };
    const result = await ctrSimulateSession(job);
    if(result.success){ success++; if(result.bounce) bounces++; }
    const pct = Math.round(((i+1)/sessCount)*100);
    if(progBar) progBar.style.width=pct+'%';
    if(progTxt) progTxt.textContent=`${i+1}/${sessCount} sessions (${success} engaged, ${bounces} bounce)`;
    const delaySec = delayMin + Math.random()*(delayMax-delayMin);
    await sleep(delaySec*1000);

    const jobRec = { time:ts(), keyword, engine, rank, dwell:result.dwell, scroll:result.scroll, bounce:result.bounce, url:targetUrl };
    CTR_STATE.jobs.unshift(jobRec);
    ctrRenderTable();
  }

  ctrLog(`âœ“ Campaign complete â€” ${success}/${sessCount} sessions | ${bounces} bounces (${Math.round(bounces/Math.max(success,1)*100)}%) | Avg dwell ~${Math.round(CTR_STATE.jobs.slice(0,sessCount).reduce((a,j)=>a+j.dwell,0)/Math.max(success,1))}s`,'t-success');
  CTR_STATE.running=false;
  if(btn) btn.disabled=false; if(stopBtn) stopBtn.style.display='none';
}

function ctrRenderTable(){
  const tbody=document.getElementById('ctr-tbody'); if(!tbody) return;
  tbody.innerHTML = CTR_STATE.jobs.slice(0,100).map(j=>`
    <tr>
      <td style="font-family:var(--mono);font-size:10px">${j.time}</td>
      <td>${j.engine.toUpperCase()}</td>
      <td>#${j.rank}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc(j.keyword)}</td>
      <td>${j.dwell}s</td>
      <td>${j.scroll}%</td>
      <td><span class="badge ${j.bounce?'badge-r':'badge-g'}">${j.bounce?'Bounce':'Engaged'}</span></td>
    </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted2)">No sessions yet.</td></tr>';
}

function ctrExportCSV(){
  const h='Time,Engine,Rank,Keyword,Dwell(s),Scroll%,Type\n';
  const rows=CTR_STATE.jobs.map(j=>`"${j.time}","${j.engine}","${j.rank}","${j.keyword}","${j.dwell}","${j.scroll}","${j.bounce?'Bounce':'Engaged'}"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='ctr-sessions.csv'; a.click();
}

function renderCTRManipulator(el){
  el=el||document.getElementById('page-ctr_manipulator'); if(!el) return;
  const liveCount=CTR_STATE.jobs.filter(j=>!j.bounce).length;
  const chips=CTR_ENGINES.map(e=>`<div class="chip ctr-engine-chip on" data-eid="${e.id}" onclick="this.classList.toggle('on')" title="${e.share}% search share">${e.icon} ${e.name} <span class="mono xs">${e.share}%</span></div>`).join('');
  el.innerHTML=`
  <div class="page-title">ğŸ–± CTR Manipulation Engine</div>
  <div class="page-sub">// Simulate organic sessions â€” search â†’ find â†’ click â†’ scroll â†’ dwell Â· Strengthens click signals to hold rankings</div>
  ${moduleBar('ctr_bounceRate','help-ctr-engine')}
  <div class="notice notice-info"><strong>What this does:</strong> Each session simulates a full organic search: searches your keyword, scans results, clicks your result at the target rank, scrolls the page, and dwells. Sustained CTR tells Google your result satisfies intent â€” preventing rank-and-drop.</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">âš™ Session Configuration</div>
        <div class="fg"><label class="lbl">Target URL <span style="color:var(--accent2)">*</span></label>
          <input type="url" id="ctr-target" placeholder="https://yourparasite.medium.com/article" /></div>
        <div class="fg"><label class="lbl">Keyword <span style="color:var(--accent2)">*</span></label>
          <input type="text" id="ctr-keyword" placeholder="best running shoes online" /></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Target SERP Rank</label>
            <input type="number" id="ctr-rank" value="1" min="1" max="10" /></div>
          <div class="fg"><label class="lbl">Sessions</label>
            <input type="number" id="ctr-sessions" value="20" min="1" max="200" /></div>
        </div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Delay Min (s)</label>
            <input type="number" id="ctr-delay-min" value="3" min="1" max="60" /></div>
          <div class="fg"><label class="lbl">Delay Max (s)</label>
            <input type="number" id="ctr-delay-max" value="8" min="1" max="120" /></div>
        </div>
        <div class="fg"><label class="lbl">Bounce Rate</label>
          <select id="ctr-bounce">
            <option value="0.05">5% â€” very engaged</option>
            <option value="0.15" selected>15% â€” normal</option>
            <option value="0.25">25% â€” moderate</option>
            <option value="0.40">40% â€” mixed</option>
          </select></div>
        <div class="fg"><label class="lbl">Proxy <span class="xs tm">(optional)</span></label>
          <input type="text" id="ctr-proxy" placeholder="http://user:pass@host:port" /></div>
        <div class="fg"><label class="lbl">Search Engines <span class="xs tm">(click to toggle)</span></label>
          <div class="chips">${chips}</div></div>
        <div class="fg"><label class="chk-row"><input id="ctr-ua-rotate" type="checkbox" checked style="width:auto"> Rotate User-Agents randomly</label></div>
        <div class="row mt8" style="gap:8px">
          <button id="ctr-run-btn" class="btn btn-primary" style="flex:1" onclick="ctrRunCampaign()">ğŸ–± Start CTR Campaign</button>
          <button id="ctr-stop-btn" class="btn btn-danger btn-sm" style="display:none" onclick="CTR_STATE.stopFlag=true">â¹ Stop</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“‹ Strategy Notes</div>
        <div style="font-family:var(--mono);font-size:11px;line-height:2.1;color:var(--text)">
          <div><span class="badge badge-g">WHY</span> Google uses click signals to validate rankings. Pages that rank but get no clicks lose position. CTR signals tell Google your result satisfies intent.</div>
          <div style="margin-top:6px"><span class="badge badge-b">BEST PRACTICE</span> 3â€“8s delay Â· &lt;20% bounce Â· 15â€“50 sessions/day Â· Rotate proxies Â· Run 2â€“3x/week</div>
          <div style="margin-top:6px"><span class="badge badge-y">RISK</span> Low-Med. Real sessions from varied IPs are undetectable. Avoid same-IP bursts or 0% bounce rate.</div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="card-title">ğŸ“º Live Session Monitor</div>
        <div id="ctr-progress" style="display:none;padding:4px 0 6px">
          <div class="mono xs tm mb0" id="ctr-prog-txt">Initializing...</div>
          <div style="height:8px;background:var(--win-dark);border:2px solid;border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);margin-top:3px">
            <div id="ctr-prog-bar" style="height:100%;background:var(--win-blue2);width:0%;transition:width 0.3s"></div></div>
        </div>
        <div id="ctr-terminal" class="terminal" style="height:200px;overflow-y:auto">
          <div class="tline"><span class="t-dim">[READY]</span> <span class="t-info">CTR Engine initialized. Configure session above and launch.</span></div>
        </div>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>ğŸ“‹ Session Log (${CTR_STATE.jobs.length} total Â· ${liveCount} engaged)</span>
      <div class="row" style="gap:6px">
        <button class="btn btn-ghost btn-xs" onclick="CTR_STATE.jobs=[];ctrRenderTable()">ğŸ—‘ Clear</button>
        <button class="btn btn-ghost btn-xs" onclick="ctrExportCSV()">ğŸ’¾ Export CSV</button>
      </div>
    </div>
    <div class="tw" style="max-height:280px;overflow-y:auto"><table>
      <thead><tr><th>Time</th><th>Engine</th><th>Rank</th><th>Keyword</th><th>Dwell</th><th>Scroll</th><th>Type</th></tr></thead>
      <tbody id="ctr-tbody"><tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No sessions yet. Run a campaign above.</td></tr></tbody>
    </table></div>
  </div>`;
  ctrRenderTable();
}


// â”€â”€â”€ FRESHNESS SCHEDULER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FS_STATE = { schedules: [] };

function fsLog(msg, cls='t-info'){
  const t=document.getElementById('fs-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="t-dim">[${ts()}]</span> <span class="${cls}">${msg}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

const FS_MUTATIONS = [
  (c)=>{ const yr=new Date().getFullYear(); return c.replace(/\b(20\d{2})\b/g, yr); },
  (c)=>{ const mo=new Date().toLocaleString('default',{month:'long',year:'numeric'}); return c.replace(/^(#[^\n]+)/m,'$1 [Updated '+mo+']'); },
  (c)=>{ return c+'\n\n---\n*Last updated: '+new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})+' â€” content refreshed.*'; },
  (c)=>{ const s=['This guide has been updated to reflect the latest information.','All data reviewed and verified.','Content last refreshed for accuracy.']; return s[Math.floor(Math.random()*s.length)]+'\n\n'+c; },
];

function fsApplyMutation(content, mutationTypes){
  let c=content;
  if(mutationTypes.includes('date')) c=FS_MUTATIONS[0](c);
  if(mutationTypes.includes('header')) c=FS_MUTATIONS[1](c);
  if(mutationTypes.includes('footer')) c=FS_MUTATIONS[2](c);
  if(mutationTypes.includes('intro')) c=FS_MUTATIONS[3](c);
  return c;
}

async function fsAddSchedule(){
  const name=document.getElementById('fs-name')?.value?.trim();
  const platform=document.getElementById('fs-platform')?.value;
  const apiKey=document.getElementById('fs-apikey')?.value?.trim();
  const postId=document.getElementById('fs-postid')?.value?.trim();
  const interval=parseInt(document.getElementById('fs-interval')?.value||'14');
  const content=document.getElementById('fs-content')?.value?.trim();
  const mutations=[...document.querySelectorAll('.fs-mutation-chip.on')].map(c=>c.dataset.mid);
  if(!name||!platform||!content){ fsLog('ERROR: Name, platform, and content are required.','t-err'); return; }
  const sched={
    id:uid(), name, platform, apiKey, postId, interval, content, mutations,
    created:new Date().toLocaleString(),
    nextRun:new Date(Date.now()+interval*24*60*60*1000).toLocaleDateString(),
    runs:0, lastRun:null, status:'scheduled'
  };
  FS_STATE.schedules.unshift(sched);
  fsLog(`âœ“ Schedule added: "${name}" | ${platform} | Every ${interval} days | Mutations: ${mutations.join(', ')||'none'}`,'t-success');
  fsRenderTable();
}

async function fsRunNow(id){
  const sched=FS_STATE.schedules.find(s=>s.id===id); if(!sched) return;
  fsLog(`â–¶ Running freshness update: "${sched.name}"...`,'t-info');
  const mutated=fsApplyMutation(sched.content, sched.mutations);
  const charDiff=Math.abs(mutated.length-sched.content.length);
  fsLog(`â†’ Applied mutations: ${sched.mutations.join(', ')||'minimal'} | Î”${charDiff} chars changed`,'t-dim');

  let success = false;
  // Attempt real publish via platform API
  try{
    const platform = sched.platform;
    const apiKey = sched.apiKey;
    const postId = sched.postId;
    if(!apiKey){ fsLog('âš  No API key stored â€” add API key to schedule for live publish','t-warn'); }
    else if(platform==='github' && postId){
      // GitHub: update file content
      const enc = encodeURIComponent(postId);
      const r = await smartFetch(`https://api.github.com/repos/${postId}`, {
        method:'PUT', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
        body:JSON.stringify({message:'Freshness update '+new Date().toISOString().split('T')[0],content:btoa(unescape(encodeURIComponent(mutated)))}),
        signal:AbortSignal.timeout(12000)
      });
      success = r.ok || r.status===201;
    } else if((platform==='wordpress'||platform==='wp') && postId){
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(`https://public-api.wordpress.com/wp/v2/sites/${postId}/posts`), {
        method:'POST', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
        body:JSON.stringify({content:mutated,status:'publish',modified:new Date().toISOString()}),
        signal:AbortSignal.timeout(12000)
      });
      success = r.ok || r.status===201;
    } else if(platform==='medium' && apiKey){
      const me = await fetch('https://corsproxy.io/?'+encodeURIComponent('https://api.medium.com/v1/me'),{headers:{'Authorization':'Bearer '+apiKey},signal:AbortSignal.timeout(8000)});
      if(me.ok){
        const meData = await me.json();
        const userId = meData.data?.id;
        const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(`https://api.medium.com/v1/users/${userId}/posts`),{
          method:'POST',headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
          body:JSON.stringify({title:sched.name,contentFormat:'markdown',content:mutated,publishStatus:'public'}),
          signal:AbortSignal.timeout(12000)
        });
        success = r.ok || r.status===201;
      }
    } else if(platform==='devto' && apiKey){
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(postId?`https://dev.to/api/articles/${postId}`:'https://dev.to/api/articles'),{
        method:postId?'PUT':'POST', headers:{'api-key':apiKey,'Content-Type':'application/json'},
        body:JSON.stringify({article:{title:sched.name,body_markdown:mutated,published:true}}),
        signal:AbortSignal.timeout(12000)
      });
      success = r.ok || r.status===201;
    } else if(platform==='notion' && apiKey && postId){
      const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(`https://api.notion.com/v1/blocks/${postId}/children`),{
        method:'PATCH',headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json','Notion-Version':'2022-06-28'},
        body:JSON.stringify({children:[{object:'block',type:'paragraph',paragraph:{rich_text:[{type:'text',text:{content:mutated.substring(0,2000)}}]}}]}),
        signal:AbortSignal.timeout(12000)
      });
      success = r.ok;
    } else {
      // Generic REST update attempt
      if(apiKey && postId){
        const r = await fetch('https://corsproxy.io/?'+encodeURIComponent(postId),{
          method:'PUT', headers:{'Authorization':'Bearer '+apiKey,'Content-Type':'application/json'},
          body:JSON.stringify({content:mutated,body:mutated,status:'publish'}), signal:AbortSignal.timeout(12000)
        });
        success = r.ok || r.status===201;
      } else {
        fsLog('âš  Post ID required for '+platform+' â€” enter the API endpoint or post URL as Post ID','t-warn');
      }
    }
  }catch(e){ fsLog(`âœ— API error: ${e.message}`,'t-err'); }

  if(success){
    sched.runs++; sched.lastRun=new Date().toLocaleString();
    sched.nextRun=new Date(Date.now()+sched.interval*24*60*60*1000).toLocaleDateString();
    sched.status='active';
    fsLog(`âœ“ Republished to ${sched.platform} â€” freshness signal sent | Next: ${sched.nextRun}`,'t-success');
  } else {
    sched.status='error';
    fsLog('âœ— Publish failed â€” check API key, Post ID, and platform permissions','t-err');
  }
  fsRenderTable();
}

function fsDeleteSchedule(id){
  FS_STATE.schedules=FS_STATE.schedules.filter(s=>s.id!==id);
  fsRenderTable();
}

function fsRenderTable(){
  const tbody=document.getElementById('fs-tbody'); if(!tbody) return;
  tbody.innerHTML=FS_STATE.schedules.map(s=>`<tr>
    <td style="font-weight:700">${esc(s.name)}</td>
    <td>${esc(s.platform)}</td>
    <td class="mono xs">Every ${s.interval}d</td>
    <td class="mono xs tm">${esc(s.mutations.join(', ')||'â€”')}</td>
    <td class="mono">${s.runs}</td>
    <td class="mono xs tm">${s.lastRun||'â€”'}</td>
    <td class="mono xs" style="color:#0057ff">${s.nextRun}</td>
    <td><span class="badge ${s.status==='active'?'badge-g':s.status==='error'?'badge-r':'badge-b'}">${s.status}</span></td>
    <td>
      <button class="btn btn-ghost btn-xs" onclick="fsRunNow('${s.id}')">â–¶ Run</button>
      <button class="btn btn-danger btn-xs" onclick="fsDeleteSchedule('${s.id}')">âœ•</button>
    </td>
  </tr>`).join('')||'<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No schedules yet. Add one above.</td></tr>';
}

function renderFreshnessScheduler(el){
  el=el||document.getElementById('page-freshness_scheduler'); if(!el) return;
  const activeCount=FS_STATE.schedules.filter(s=>s.status==='active').length;
  const mutChips=[
    {id:'date',label:'ğŸ“… Year/Date Replace',tip:'Replaces old years with current year in content'},
    {id:'header',label:'ğŸ“ Header Timestamp',tip:'Appends [Updated YYYY] to first heading'},
    {id:'footer',label:'ğŸ“Œ Footer Datestamp',tip:'Adds "Last updated" line at end of content'},
    {id:'intro',label:'ğŸ”„ Intro Refresh',tip:'Prepends a freshness verification statement'},
  ].map(m=>`<div class="chip fs-mutation-chip on" data-mid="${m.id}" onclick="this.classList.toggle('on')" title="${m.tip}">${m.label}</div>`).join('');
  const platformOpts=['github','gitlab','wordpress','medium','notion','devto','hashnode','blogger','substack','ghost'].map(p=>`<option value="${p}">${p.charAt(0).toUpperCase()+p.slice(1)}</option>`).join('');
  el.innerHTML=`
  <div class="page-title">ğŸ”„ Freshness Signal Scheduler</div>
  <div class="page-sub">// Auto-edit and republish parasite pages on cadence Â· Google's QDF rewards freshness Â· extend ranking longevity</div>
  ${moduleBar('fs_defaultInterval','help-freshness-scheduler')}
  <div class="notice notice-info"><strong>Why freshness matters:</strong> Google's Query Deserves Freshness (QDF) algorithm rewards pages with recency signals. Parasite pages refreshed every 2â€“4 weeks dramatically outlast static pages. A minor content mutation + re-publish triggers a new crawl and resets freshness score.</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">â• Add Schedule</div>
        <div class="fg"><label class="lbl">Schedule Name</label>
          <input type="text" id="fs-name" placeholder="GitHub Parasite â€” Running Shoes" /></div>
        <div class="grid2">
          <div class="fg"><label class="lbl">Platform</label>
            <select id="fs-platform">${platformOpts}</select></div>
          <div class="fg"><label class="lbl">Refresh Interval</label>
            <select id="fs-interval">
              <option value="7">Every 7 days</option>
              <option value="14" selected>Every 14 days</option>
              <option value="21">Every 21 days</option>
              <option value="28">Every 28 days</option>
            </select></div>
        </div>
        <div class="fg"><label class="lbl">API Key / Token</label>
          <input type="password" id="fs-apikey" placeholder="Platform API token for republish" /></div>
        <div class="fg"><label class="lbl">Post / Page ID <span class="xs tm">(repo name, post ID, etc.)</span></label>
          <input type="text" id="fs-postid" placeholder="my-repo or post-12345" /></div>
        <div class="fg"><label class="lbl">Mutation Types <span class="xs tm">(applied on each run)</span></label>
          <div class="chips">${mutChips}</div></div>
        <div class="fg"><label class="lbl">Base Content <span class="xs tm">(Markdown / HTML)</span></label>
          <textarea id="fs-content" rows="6" placeholder="# Best Running Shoes 2024&#10;&#10;Paste your base article here. Mutations will be applied on each run and the modified content will be republished."></textarea></div>
        <button class="btn btn-primary" onclick="fsAddSchedule()" style="width:100%">ğŸ“… Add Freshness Schedule</button>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“– Cadence Guide</div>
        <div style="font-family:var(--mono);font-size:11px;line-height:2.2;color:var(--text)">
          <div><span class="badge badge-r">COMPETITIVE</span> 7â€“14 days Â· High-competition keywords decay fast</div>
          <div><span class="badge badge-y">MEDIUM</span> 14â€“21 days Â· Most parasite pages fall here</div>
          <div><span class="badge badge-g">LOW COMP</span> 21â€“28 days Â· Long-tail / low competition</div>
          <div style="margin-top:8px;color:var(--muted2)">Mutation strategy: Date Replace + Footer Datestamp creates visible "last updated" metadata that both users and crawlers see. GitHub commit timestamps, WordPress modified dates, and Medium last-edited fields all pass freshness to Google.</div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="card-title">ğŸ“º Activity Log</div>
        <div id="fs-terminal" class="terminal" style="height:180px;overflow-y:auto">
          <div class="tline"><span class="t-dim">[READY]</span> <span class="t-info">Freshness Scheduler ready. Add a schedule to begin.</span></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="card-title">ğŸ“Š Schedule Stats</div>
        <div class="grid2">
          <div style="text-align:center;padding:10px;background:var(--win-bg);border:1px solid var(--win-btn-sh)">
            <div style="font-size:22px;font-weight:700;font-family:var(--mono);color:var(--win-blue2)">${activeCount}</div>
            <div class="mono xs tm">Active Schedules</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--win-bg);border:1px solid var(--win-btn-sh)">
            <div style="font-size:22px;font-weight:700;font-family:var(--mono);color:var(--win-blue2)">${FS_STATE.schedules.length}</div>
            <div class="mono xs tm">Total Schedules</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <div class="card-title">ğŸ“‹ Active Schedules (${FS_STATE.schedules.length})</div>
    <div class="tw" style="max-height:300px;overflow-y:auto"><table>
      <thead><tr><th>Name</th><th>Platform</th><th>Interval</th><th>Mutations</th><th>Runs</th><th>Last Run</th><th>Next Run</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="fs-tbody"><tr><td colspan="9" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No schedules yet. Add one above.</td></tr></tbody>
    </table></div>
  </div>`;
  fsRenderTable();
}


// â”€â”€â”€ ANCHOR CONTROLLER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ANC_STATE = { profiles: [], running: false };

function ancLog(msg, cls='t-info'){
  const t=document.getElementById('anc-terminal'); if(!t) return;
  const d=document.createElement('div'); d.className='tline';
  d.innerHTML=`<span class="t-dim">[${ts()}]</span> <span class="${cls}">${msg}</span>`;
  t.appendChild(d); t.scrollTop=t.scrollHeight;
}

const AC_PRESETS = {
  safe:     { exact:10, partial:20, branded:30, naked:25, generic:15 },
  natural:  { exact:20, partial:30, branded:25, naked:15, generic:10 },
  moderate: { exact:30, partial:30, branded:20, naked:10, generic:10 },
  aggressive:{ exact:40, partial:30, branded:15, naked:10, generic:5 },
};

function acLoadPreset(preset){
  const p = AC_PRESETS[preset]; if(!p) return;
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
  set('anc-exact',p.exact); set('anc-partial',p.partial); set('anc-branded',p.branded);
  set('anc-naked',p.naked); set('anc-generic',p.generic);
  acUpdatePreview();
}

function acGetRatios(){
  const g = (id,def)=>parseInt(document.getElementById(id)?.value||def);
  const exact=g('anc-exact',40), partial=g('anc-partial',30), branded=g('anc-branded',20),
        naked=g('anc-naked',10), generic=g('anc-generic',0);
  return { exact, partial, branded, naked, generic, total:exact+partial+branded+naked+generic };
}

function acUpdatePreview(){
  const r=acGetRatios();
  const el=document.getElementById('anc-ratio-preview'); if(!el) return;
  const bars=[
    {label:'Exact',key:'exact',color:'#cc0000'},
    {label:'Partial',key:'partial',color:'#0066cc'},
    {label:'Branded',key:'branded',color:'#006600'},
    {label:'Naked URL',key:'naked',color:'#997700'},
    {label:'Generic',key:'generic',color:'#666666'},
  ];
  const total=r.total||1;
  el.innerHTML=`<div style="border:2px solid;border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);padding:6px;background:var(--win-bg)">
    ${bars.map(b=>`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
      <div style="width:70px;font-size:9px;color:${b.color};font-weight:700;text-align:right;font-family:var(--mono)">${b.label}</div>
      <div style="flex:1;height:12px;background:#d4d0c8;border:1px solid var(--win-btn-sh)">
        <div style="height:100%;background:${b.color};width:${Math.round(r[b.key]/total*100)}%;transition:width 0.2s"></div></div>
      <div style="width:32px;font-size:9px;font-family:var(--mono);color:${b.color};font-weight:700">${r[b.key]}%</div>
    </div>`).join('')}
    <div style="font-size:9px;font-family:var(--mono);color:${Math.abs(total-100)>1?'#cc0000':'#006600'};margin-top:2px;font-weight:700">Total: ${total}% ${Math.abs(total-100)>1?'âš  Must equal 100%':'âœ“'}</div>
  </div>`;
}

const AC_PARTIAL_TEMPLATES = (kw)=>['best '+kw,'top '+kw,kw+' guide',kw+' tips',kw+' review','cheap '+kw,'buy '+kw,kw+' 2025',kw+' deals','best '+kw+' online'];
const AC_GENERIC_ANCHORS = ['click here','read more','learn more','visit this','this article','here','source','more info','check this out','details'];

function acBuildAnchorSet(keywords, brandName, targetUrl, ratios, count){
  const anchors=[];
  const {exact,partial,branded,naked,generic,total}=ratios;
  const types=[{type:'exact',w:exact},{type:'partial',w:partial},{type:'branded',w:branded},{type:'naked',w:naked},{type:'generic',w:generic}].filter(t=>t.w>0);
  const pick=()=>{ const r=Math.random()*total; let a=0; for(const t of types){a+=t.w;if(r<a)return t.type;} return types[types.length-1].type; };
  for(let i=0;i<count;i++){
    const type=pick();
    const kw=keywords[Math.floor(Math.random()*keywords.length)]||'keyword';
    let text,note;
    switch(type){
      case 'exact': text=kw; note='exact match'; break;
      case 'partial': const pvs=AC_PARTIAL_TEMPLATES(kw); text=pvs[Math.floor(Math.random()*pvs.length)]; note='partial match'; break;
      case 'branded': text=brandName||(targetUrl.replace(/https?:\/\/(www\.)?/,'').split('/')[0]); note='branded'; break;
      case 'naked': text=targetUrl; note='naked URL'; break;
      case 'generic': text=AC_GENERIC_ANCHORS[Math.floor(Math.random()*AC_GENERIC_ANCHORS.length)]; note='generic'; break;
    }
    anchors.push({i:i+1,type,text,note,url:targetUrl});
  }
  return anchors;
}

function acGenerate(){
  const kwRaw=document.getElementById('anc-keywords')?.value||'';
  const targetUrl=document.getElementById('anc-target')?.value?.trim()||'https://yoursite.com';
  const brandName=document.getElementById('anc-brand')?.value?.trim()||'';
  const count=Math.min(parseInt(document.getElementById('anc-count')?.value||'30'),200);
  const keywords=kwRaw.split('\n').map(k=>k.trim()).filter(Boolean);
  if(!keywords.length){ ancLog('ERROR: Enter at least one keyword.','t-err'); return; }
  const ratios=acGetRatios();
  if(Math.abs(ratios.total-100)>1) ancLog(`WARNING: Ratios total ${ratios.total}% â€” should equal 100%.`,'t-warn');
  const anchors=acBuildAnchorSet(keywords,brandName,targetUrl,ratios,count);
  const profile={id:uid(),name:`${keywords[0]} Ã— ${count} anchors`,created:new Date().toLocaleString(),keywords,targetUrl,ratios,anchors,count};
  ANC_STATE.profiles.unshift(profile);
  ancLog(`âœ“ Generated ${count} anchors | Exact:${ratios.exact}% Partial:${ratios.partial}% Branded:${ratios.branded}% Naked:${ratios.naked}% Generic:${ratios.generic}%`,'t-success');
  acRenderAnchors(profile);
  acRenderProfiles();
}

function acRenderAnchors(profile){
  const tbody=document.getElementById('anc-anchor-tbody'); if(!tbody) return;
  document.getElementById('anc-anchor-section').style.display='block';
  const el=document.getElementById('anc-anchor-title'); if(el) el.textContent='Generated Anchors: '+profile.name;
  const tc={exact:'#cc0000',partial:'#0066cc',branded:'#006600',naked:'#997700',generic:'#666666'};
  tbody.innerHTML=profile.anchors.map(a=>`<tr>
    <td class="mono xs">${a.i}</td>
    <td><span style="font-size:9px;font-weight:700;color:${tc[a.type]||'#000'};background:${tc[a.type]||'#000'}22;padding:1px 5px;border:1px solid ${tc[a.type]||'#000'}55">${a.type}</span></td>
    <td style="font-weight:700">${esc(a.text)}</td>
    <td class="mono xs tm">${a.note}</td>
    <td class="mono xs" style="color:#0057ff">&lt;a href="${esc(a.url)}"&gt;${esc(a.text)}&lt;/a&gt;</td>
  </tr>`).join('');
}

function acRenderProfiles(){
  const tbody=document.getElementById('anc-profiles-tbody'); if(!tbody) return;
  tbody.innerHTML=ANC_STATE.profiles.map(p=>`<tr>
    <td style="font-weight:700">${esc(p.name)}</td>
    <td class="mono">${p.count}</td>
    <td class="mono xs">${p.ratios.exact}/${p.ratios.partial}/${p.ratios.branded}/${p.ratios.naked}/${p.ratios.generic}</td>
    <td class="mono xs tm">${p.created}</td>
    <td>
      <button class="btn btn-ghost btn-xs" onclick="acExportProfile('${p.id}')">ğŸ’¾ CSV</button>
      <button class="btn btn-ghost btn-xs" onclick="acRenderAnchors(ANC_STATE.profiles.find(x=>x.id==='${p.id}'))">ğŸ‘ View</button>
      <button class="btn btn-danger btn-xs" onclick="ANC_STATE.profiles=ANC_STATE.profiles.filter(x=>x.id!=='${p.id}');acRenderProfiles()">âœ•</button>
    </td>
  </tr>`).join('')||'<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2)">No profiles yet.</td></tr>';
}

function acExportProfile(id){
  const p=ANC_STATE.profiles.find(x=>x.id===id); if(!p) return;
  const h='#,Type,Anchor Text,Note,HTML\n';
  const rows=p.anchors.map(a=>`"${a.i}","${a.type}","${a.text}","${a.note}","<a href=\"${a.url}\">${a.text}</a>"`).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([h+rows],{type:'text/csv'})); a.download='anchor-profile.csv'; a.click();
}

function renderAnchorController(el){
  el=el||document.getElementById('page-anchor_controller'); if(!el) return;
  el.innerHTML=`
  <div class="page-title">âš“ Anchor Text Controller</div>
  <div class="page-sub">// Control anchor text ratios across tier system Â· 40% exact â†’ Tier 1 Â· 30% partial Â· 30% branded/naked Â· keeps link profile clean</div>
  ${moduleBar('anc_exactRatio','help-anchor-controller')}
  <div class="notice notice-info"><strong>Why ratios matter:</strong> Over-optimized anchor text (too many exact-match) triggers Google's Penguin filter. The 40/30/30 ratio is what every professional link-builder uses â€” enough exact-match signal to rank, enough variation to look natural. This generator creates properly-distributed anchor sets for your entire tier system.</div>
  <div class="grid2" style="gap:18px">
    <div>
      <div class="card">
        <div class="card-title">âš™ Ratio Configuration</div>
        <div class="row" style="gap:4px;margin-bottom:8px;flex-wrap:wrap">
          <span class="lbl xs">Presets:</span>
          <button class="btn btn-ghost btn-xs" onclick="acLoadPreset('safe')">ğŸŸ¢ Safe (10/20/30/25/15)</button>
          <button class="btn btn-ghost btn-xs" onclick="acLoadPreset('natural')">ğŸ”µ Natural (20/30/25/15/10)</button>
          <button class="btn btn-ghost btn-xs" onclick="acLoadPreset('moderate')">ğŸŸ¡ Moderate (30/30/20/10/10)</button>
          <button class="btn btn-ghost btn-xs" onclick="acLoadPreset('aggressive')">ğŸ”´ Aggressive (40/30/15/10/5)</button>
        </div>
        <div class="grid2">
          <div class="fg"><label class="lbl" style="color:#cc0000">Exact Match %</label>
            <input type="number" id="anc-exact" value="40" min="0" max="100" oninput="acUpdatePreview()" /></div>
          <div class="fg"><label class="lbl" style="color:#0066cc">Partial Match %</label>
            <input type="number" id="anc-partial" value="30" min="0" max="100" oninput="acUpdatePreview()" /></div>
          <div class="fg"><label class="lbl" style="color:#006600">Branded %</label>
            <input type="number" id="anc-branded" value="20" min="0" max="100" oninput="acUpdatePreview()" /></div>
          <div class="fg"><label class="lbl" style="color:#997700">Naked URL %</label>
            <input type="number" id="anc-naked" value="10" min="0" max="100" oninput="acUpdatePreview()" /></div>
        </div>
        <div class="fg"><label class="lbl" style="color:#666">Generic % <span class="xs tm">(click here, read moreâ€¦)</span></label>
          <input type="number" id="anc-generic" value="0" min="0" max="100" oninput="acUpdatePreview()" /></div>
        <div id="anc-ratio-preview" style="margin:6px 0"></div>
        <div class="fg"><label class="lbl">Target URL</label>
          <input type="url" id="anc-target" placeholder="https://yoursite.com/page" /></div>
        <div class="fg"><label class="lbl">Brand Name</label>
          <input type="text" id="anc-brand" placeholder="YourBrand" /></div>
        <div class="fg"><label class="lbl">Keywords <span class="xs tm">(one per line)</span></label>
          <textarea id="anc-keywords" rows="4" placeholder="buy running shoes&#10;best running shoes&#10;running shoes online"></textarea></div>
        <div class="fg"><label class="lbl">Generate Count</label>
          <input type="number" id="anc-count" value="30" min="1" max="200" /></div>
        <button class="btn btn-primary" onclick="acGenerate()" style="width:100%">âš¡ Generate Anchor Set</button>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="card-title">ğŸ“– Tier Distribution Guide</div>
        <div style="font-family:var(--mono);font-size:11px;line-height:2.2;color:var(--text)">
          <div><span class="badge badge-r">TIER 1 â†’ Money Site</span> 40% exact match â€” primary relevance signal</div>
          <div><span class="badge badge-b">TIER 2 â†’ Tier 1 Pages</span> 30% partial match â€” natural variation</div>
          <div><span class="badge badge-g">TIER 3 â†’ Tier 2</span> 30% branded/naked â€” dilutes footprint</div>
          <div style="margin-top:8px;color:var(--muted2)"><span class="badge badge-r">EXACT</span> Primary keyword verbatim. Strongest relevance. Never exceed 50%.</div>
          <div style="color:var(--muted2)"><span class="badge badge-b">PARTIAL</span> "best [kw]", "[kw] guide", "top [kw] 2025" â€” natural-looking.</div>
          <div style="color:var(--muted2)"><span class="badge badge-g">BRANDED</span> Brand name. Every real site gets these naturally â€” required for clean profile.</div>
          <div style="color:var(--muted2)"><span class="badge badge-y">NAKED</span> Raw URL. Also natural. Good for bulk Tier 3 links.</div>
          <div style="color:var(--muted2)"><span class="badge" style="background:#e5e5e5;color:#666;border-color:#999">GENERIC</span> "click here" etc. Dilutes over-optimization. Use sparingly.</div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="card-title">ğŸ“º Generation Log</div>
        <div id="anc-terminal" class="terminal" style="height:150px;overflow-y:auto">
          <div class="tline"><span class="t-dim">[READY]</span> <span class="t-info">Anchor Controller ready. Set ratios and generate.</span></div>
        </div>
      </div>
    </div>
  </div>
  <div id="anc-anchor-section" style="display:none;margin-top:10px">
    <div class="card">
      <div class="card-title" id="anc-anchor-title">Generated Anchors</div>
      <div class="tw" style="max-height:300px;overflow-y:auto"><table>
        <thead><tr><th>#</th><th>Type</th><th>Anchor Text</th><th>Note</th><th>HTML Code</th></tr></thead>
        <tbody id="anc-anchor-tbody"></tbody>
      </table></div>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <div class="card-title">ğŸ“‹ Saved Anchor Profiles (${ANC_STATE.profiles.length})</div>
    <div class="tw" style="max-height:200px;overflow-y:auto"><table>
      <thead><tr><th>Profile</th><th>Count</th><th>Ratios (E/Pa/Br/Na/Ge)</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody id="anc-profiles-tbody"><tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted2);font-family:var(--mono);font-size:11px">No profiles yet. Generate an anchor set above.</td></tr></tbody>
    </table></div>
  </div>`;
  acUpdatePreview();
  acRenderProfiles();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL SETTINGS SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SETTINGS_DEFAULTS = {
  // â”€â”€ GENERAL â”€â”€
  theme:              'classic',    // classic | dark
  corsProxy:          'https://corsproxy.io/?',
  requestTimeout:     12000,
  rateLimitDelay:     1200,
  autoSaveInterval:   30,
  debugMode:          false,

  // â”€â”€ PROXY MANAGER â”€â”€
  pm_concurrentTests:    5,
  pm_testTimeout:        8000,
  pm_autoScan:           false,
  pm_scanIntervalMin:    60,
  pm_retireDeadAfter:    3,
  pm_preferElite:        true,
  pm_westernOnly:        true,
  pm_rotationMode:       'roundrobin', // roundrobin | random | elite-first
  pm_geoFilterBatch:     100,

  // â”€â”€ CONTENT / CAMPAIGN â”€â”€
  camp_defaultDelay:     1500,
  camp_maxRetries:       2,
  camp_concurrency:      3,
  camp_shufflePlatforms: true,
  camp_autoProxy:        false,
  camp_defaultArticleLen:'medium',   // short | medium | long
  camp_appendYear:       true,

  // â”€â”€ LINK INDEXER â”€â”€
  li_googlePing:         true,
  li_bingIndexNow:       true,
  li_indexNowKey:        '',
  li_gscOAuthToken:      '',
  li_batchSize:          50,
  li_delayBetween:       800,

  // â”€â”€ PING SUBMITTER â”€â”€
  ps_corsProxy:          'https://corsproxy.io/?',
  ps_timeout:            8000,
  ps_includeGoogle:      true,
  ps_includeBing:        true,
  ps_includeXmlRpc:      true,

  // â”€â”€ SERP SCRAPER â”€â”€
  serp_engine:           'duckduckgo', // duckduckgo | bing | serpapi | valueserp
  serp_serpApiKey:       '',
  serp_valueSerpKey:     '',
  serp_resultDepth:      30,
  serp_delay:            2000,
  serp_useProxy:         false,
  serp_extractMetrics:   true,

  // â”€â”€ SOCIAL BLASTER â”€â”€
  ssb_pinterestToken:    '',
  ssb_redditToken:       '',
  ssb_tumblrToken:       '',
  ssb_pocketToken:       '',
  ssb_delayBetween:      2500,
  ssb_fallbackFetch:     true,

  // â”€â”€ WEB 2.0 BUILDER â”€â”€
  w2b_defaultPlatforms:  [],
  w2b_articleLength:     'medium',
  w2b_interlinkCount:    3,
  w2b_pingAfterBuild:    true,
  auto_index_on_publish: true,
  w2b_indexAfterBuild:   true,
  w2b_delayBetween:      2000,

  // â”€â”€ FORUM PROFILE BLASTER â”€â”€
  fpb_defaultUsername:   '',
  fpb_defaultBio:        '',
  fpb_urlInBio:          true,
  fpb_delayBetween:      3000,

  // â”€â”€ ACCOUNT CREATOR â”€â”€
  ac_defaultPassword:    '',
  ac_emailDomain:        'auto',
  ac_useEmailGen:        true,

  // â”€â”€ GSC INSPECTOR â”€â”€
  gsc_oauthToken:        '',
  gsc_siteUrl:           '',
  gsc_fallbackBing:      true,
  gsc_fallbackSiteOp:    true,

  // â”€â”€ CAPTCHA SOLVER â”€â”€
  cap_provider:          '2captcha',  // 2captcha | anticaptcha | capsolver
  cap_2captchaKey:       '',
  cap_antiCaptchaKey:    '',
  cap_capSolverKey:      '',
  cap_pollInterval:      4000,
  cap_maxPollAttempts:   30,

  // â”€â”€ CTR MANIPULATOR â”€â”€
  ctr_bounceRate:        15,
  ctr_minDwell:          45,
  ctr_maxDwell:          180,
  ctr_scrollDepth:       70,
  ctr_useProxy:          true,
  ctr_delayBetween:      5000,

  // â”€â”€ FRESHNESS SCHEDULER â”€â”€
  fs_defaultInterval:    21,
  fs_mutations:          ['date','header'],
  fs_pingAfter:          true,

  // â”€â”€ ANCHOR CONTROLLER â”€â”€
  anc_exactRatio:        30,
  anc_partialRatio:      25,
  anc_brandedRatio:      20,
  anc_nakedRatio:        15,
  anc_genericRatio:      10,
  railway_url:           '',
  railway_connected:     false,
  railway_secret:        '',
  railway_enabled:       false,
  railway_timeout:       15000,
  supa_prefix:           '',
  supa_autosync:         false,

  // â”€â”€ SESSION MANAGER â”€â”€
  csm_rotateOnFail:      true,
  csm_testOnLoad:        false,

  // â”€â”€ EMAIL GENERATOR â”€â”€
  eag_preferMailTm:      true,
  eag_autoCheck:         false,
  eag_autoCheckInterval: 30,

  // â”€â”€ BLOG COMMENTER â”€â”€
  bc_defaultDelay:       3000,
  bc_maxPerSite:         5,
  bc_useProxy:           false,

  // â”€â”€ EXPORT â”€â”€
  exp_defaultFormat:     'csv',
  exp_includeMetadata:   true,
};

// Load from localStorage, falling back to defaults
const SETTINGS = (() => {
  try {
    const saved = JSON.parse(localStorage.getItem('spp_settings') || '{}');
    return Object.assign({}, SETTINGS_DEFAULTS, saved);
  } catch(e) { return Object.assign({}, SETTINGS_DEFAULTS); }
})();

function saveSETTINGS() {
  try { localStorage.setItem('spp_settings', JSON.stringify(SETTINGS)); } catch(e) {}
}

function settingSet(key, val) {
  SETTINGS[key] = val;
  saveSETTINGS();
  applySettingsToModules();
}

function settingGet(key) {
  return key in SETTINGS ? SETTINGS[key] : SETTINGS_DEFAULTS[key];
}

function applySettingsToModules() {
  // Apply CORS proxy globally
  // Apply timeout adjustments, etc.
  // Modules read from SETTINGS directly at runtime
}

function resetAllSettings() {
  if(!confirm('Reset ALL settings to defaults? This cannot be undone.')) return;
  Object.keys(SETTINGS_DEFAULTS).forEach(k => SETTINGS[k] = SETTINGS_DEFAULTS[k]);
  saveSETTINGS();
  renderPage('settings');
}

function exportSettings() {
  const blob = new Blob([JSON.stringify(SETTINGS, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'spp_settings_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
}

function importSettings() {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.json';
  inp.onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        Object.keys(SETTINGS_DEFAULTS).forEach(k => { if(k in data) SETTINGS[k] = data[k]; });
        saveSETTINGS();
        renderPage('settings');
        alert('âœ… Settings imported successfully!');
      } catch(e) { alert('âŒ Invalid settings file: ' + e.message); }
    };
    fr.readAsText(f);
  };
  inp.click();
}

// â”€â”€â”€ SETTINGS RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettings(el) {
  el = el || document.getElementById('page-settings'); if(!el) return;

  const sField = (key, label, type='text', opts={}) => {
    const val = settingGet(key);
    const id = 'setting-' + key;
    if(type === 'toggle') {
      return `<div class="set-row">
        <label class="set-label" title="${opts.hint||''}">${label}</label>
        <div class="set-control">
          <label class="toggle-sw">
            <input type="checkbox" id="${id}" ${val?'checked':''} onchange="settingSet('${key}',this.checked)">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </label>
          ${opts.hint?`<span class="set-hint">${opts.hint}</span>`:''}
        </div>
      </div>`;
    }
    if(type === 'select') {
      return `<div class="set-row">
        <label class="set-label" title="${opts.hint||''}">${label}</label>
        <div class="set-control">
          <select id="${id}" onchange="settingSet('${key}',this.value)" style="width:180px">
            ${(opts.choices||[]).map(([v,l])=>`<option value="${v}" ${val===v?'selected':''}>${l}</option>`).join('')}
          </select>
          ${opts.hint?`<span class="set-hint">${opts.hint}</span>`:''}
        </div>
      </div>`;
    }
    if(type === 'number') {
      return `<div class="set-row">
        <label class="set-label" title="${opts.hint||''}">${label}</label>
        <div class="set-control">
          <input type="number" id="${id}" value="${val}" min="${opts.min||0}" max="${opts.max||99999}" step="${opts.step||1}"
            onchange="settingSet('${key}',Number(this.value))" style="width:100px">
          ${opts.unit?`<span class="set-unit">${opts.unit}</span>`:''}
          ${opts.hint?`<span class="set-hint">${opts.hint}</span>`:''}
        </div>
      </div>`;
    }
    if(type === 'range') {
      return `<div class="set-row">
        <label class="set-label">${label}</label>
        <div class="set-control">
          <input type="range" id="${id}" value="${val}" min="${opts.min||0}" max="${opts.max||100}" step="${opts.step||1}"
            oninput="document.getElementById('${id}-v').textContent=this.value;settingSet('${key}',Number(this.value))" style="width:140px">
          <span id="${id}-v" class="set-unit" style="min-width:30px">${val}</span>
          ${opts.unit?`<span class="set-unit">${opts.unit}</span>`:''}
        </div>
      </div>`;
    }
    if(type === 'password') {
      return `<div class="set-row">
        <label class="set-label" title="${opts.hint||''}">${label}</label>
        <div class="set-control">
          <input type="password" id="${id}" value="${val}" placeholder="${opts.ph||'Enter key...'}"
            onchange="settingSet('${key}',this.value)" style="width:260px;font-family:monospace">
          <button class="btn btn-ghost btn-xs" onclick="var i=document.getElementById('${id}');i.type=i.type==='password'?'text':'password'">ğŸ‘</button>
          ${opts.hint?`<span class="set-hint">${opts.hint}</span>`:''}
        </div>
      </div>`;
    }
    // default: text
    return `<div class="set-row">
      <label class="set-label" title="${opts.hint||''}">${label}</label>
      <div class="set-control">
        <input type="text" id="${id}" value="${esc(String(val))}" placeholder="${opts.ph||''}"
          onchange="settingSet('${key}',this.value)" style="width:${opts.width||'260px'}">
        ${opts.hint?`<span class="set-hint">${opts.hint}</span>`:''}
      </div>
    </div>`;
  };

  const sSection = (icon, title, desc, fields) =>
    `<div class="set-section">
      <div class="set-section-hdr"><span class="set-section-icon">${icon}</span><div><div class="set-section-title">${title}</div><div class="set-section-desc">${desc}</div></div></div>
      <div class="set-fields">${fields}</div>
    </div>`;

  el.innerHTML = `
  <div class="page-title">âš™ Settings &amp; Configuration</div>
  <div class="page-sub">// All settings are saved instantly to localStorage Â· Changes apply immediately to all modules</div>

  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
    <button class="btn btn-ghost btn-sm" onclick="exportSettings()">ğŸ“¥ Export Settings</button>
    <button class="btn btn-ghost btn-sm" onclick="importSettings()">ğŸ“¤ Import Settings</button>
    <button class="btn btn-danger btn-sm" onclick="resetAllSettings()">â†º Reset All Defaults</button>
    <button class="btn btn-primary btn-sm" onclick="switchPage('help')" style="margin-left:auto">â“ View Help Guide â†’</button>
  </div>

  <style>
  .set-section{background:var(--win-surface);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);margin-bottom:14px;padding:0}
  .set-section-hdr{background:linear-gradient(to bottom,#e8e4d8,#d4d0c8);padding:8px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--win-border)}
  .set-section-icon{font-size:20px;width:28px;text-align:center}
  .set-section-title{font-weight:700;font-size:12px;color:var(--win-blue)}
  .set-section-desc{font-size:10px;color:var(--win-text-muted);margin-top:2px}
  .set-fields{padding:10px 14px;display:flex;flex-direction:column;gap:6px}
  .set-row{display:flex;align-items:center;gap:10px;min-height:28px;padding:3px 0;border-bottom:1px dotted #d0cec8}
  .set-row:last-child{border-bottom:none}
  .set-label{min-width:210px;font-size:11px;font-weight:700;color:var(--win-text);flex-shrink:0}
  .set-control{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .set-hint{font-size:10px;color:var(--win-text-muted);font-style:italic}
  .set-unit{font-size:10px;color:var(--win-text-dim);font-family:var(--mono);font-weight:700}
  .toggle-sw{position:relative;display:inline-block;cursor:pointer}
  .toggle-sw input{opacity:0;width:0;height:0;position:absolute}
  .toggle-track{display:block;width:42px;height:20px;background:#aaa;border-radius:10px;border:2px solid;border-color:var(--win-btn-sh) var(--win-btn-hi) var(--win-btn-hi) var(--win-btn-sh);position:relative;transition:background 0.2s}
  .toggle-sw input:checked + .toggle-track{background:var(--win-green)}
  .toggle-thumb{position:absolute;width:14px;height:14px;background:#fff;border-radius:7px;top:1px;left:1px;transition:left 0.2s;box-shadow:0 1px 2px rgba(0,0,0,0.3)}
  .toggle-sw input:checked + .toggle-track .toggle-thumb{left:23px}
  .set-key-row{display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px dotted #d0cec8}
  .set-key-row:last-child{border-bottom:none}
  .set-key-label{min-width:160px;font-size:10px;font-weight:700;color:var(--win-text)}
  </style>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
  <div>

  ${sSection('ğŸŒ','General &amp; Network','Core behavior, CORS proxy, timeout tuning',
    sField('corsProxy','CORS Proxy URL','text',{ph:'https://corsproxy.io/?',hint:'Used for all cross-origin requests',width:'240px'}) +
    sField('requestTimeout','Request Timeout','number',{min:3000,max:60000,step:1000,unit:'ms',hint:'Max wait per API call'}) +
    sField('rateLimitDelay','Rate Limit Delay','number',{min:0,max:10000,step:100,unit:'ms',hint:'Delay between sequential requests'}) +
    sField('debugMode','Debug Mode','toggle',{hint:'Log verbose output to browser console'})
  )}

  ${sSection('ğŸ›¡','Proxy Manager','Sources, testing, rotation &amp; geo-filtering',
    sField('pm_concurrentTests','Concurrent Tests','number',{min:1,max:20,unit:'threads',hint:'Higher = faster but more memory'}) +
    sField('pm_testTimeout','Test Timeout','number',{min:2000,max:30000,step:500,unit:'ms'}) +
    sField('pm_preferElite','Prefer Elite Proxies','toggle',{hint:'Sort elite anonymity proxies first'}) +
    sField('pm_westernOnly','Western Countries Only','toggle',{hint:'Filter to US/EU/AU/CA countries via ip-api.com'}) +
    sField('pm_rotationMode','Rotation Mode','select',{choices:[['roundrobin','Round Robin'],['random','Random'],['elite-first','Elite First']],hint:'How proxies are selected for requests'}) +
    sField('pm_retireDeadAfter','Retire Dead After','number',{min:1,max:10,unit:'fails',hint:'Remove proxy after N failed tests'}) +
    sField('pm_autoScan','Auto Re-Scan','toggle',{hint:'Automatically re-fetch proxy sources on interval'}) +
    sField('pm_scanIntervalMin','Auto-Scan Interval','number',{min:15,max:1440,unit:'min',hint:'How often to refresh proxy list'})
  )}

  ${sSection('ğŸš€','Campaign &amp; Publishing','Behavior for Run Campaign and Global Blast',
    sField('camp_defaultDelay','Delay Between Posts','number',{min:500,max:30000,step:500,unit:'ms'}) +
    sField('camp_concurrency','Max Concurrency','number',{min:1,max:10,unit:'threads',hint:'Parallel platform submissions'}) +
    sField('camp_maxRetries','Max Retries','number',{min:0,max:5,unit:'Ã—'}) +
    sField('camp_shufflePlatforms','Shuffle Platform Order','toggle',{hint:'Randomize order to avoid footprint'}) +
    sField('camp_autoProxy','Auto-Use Proxy','toggle',{hint:'Route campaign requests through proxy pool'}) +
    sField('camp_defaultArticleLen','Default Article Length','select',{choices:[['short','Short (~400 words)'],['medium','Medium (~800 words)'],['long','Long (~1500 words)']]}  ) +
    sField('camp_appendYear','Append Year to Titles','toggle',{hint:'Add current year to article titles for freshness'})
  )}

  ${sSection('ğŸ“¡','Link Indexer','IndexNow, Google Ping &amp; GSC Integration',
    sField('li_googlePing','Google Ping','toggle',{hint:'Ping Google via google.com/ping'}) +
    sField('li_bingIndexNow','Bing IndexNow','toggle',{hint:'Submit URLs via Bing IndexNow API'}) +
    sField('li_indexNowKey','IndexNow API Key','text',{ph:'your-indexnow-key',hint:'Get from Bing Webmaster Tools',width:'220px'}) +
    sField('li_gscOAuthToken','GSC OAuth Token','password',{ph:'ya29.xxx... Google OAuth token',hint:'Google Search Console â€” needed for GSC Inspector too'}) +
    sField('li_batchSize','Batch Size','number',{min:10,max:500,unit:'URLs',hint:'URLs per submission batch'}) +
    sField('li_delayBetween','Delay Between Batches','number',{min:200,max:5000,step:100,unit:'ms'})
  )}

  ${sSection('ğŸ“£','Ping Submitter','Blog ping services &amp; XML-RPC endpoints',
    sField('ps_timeout','Request Timeout','number',{min:3000,max:30000,step:500,unit:'ms'}) +
    sField('ps_includeGoogle','Include Google Ping','toggle') +
    sField('ps_includeBing','Include Bing Ping','toggle') +
    sField('ps_includeXmlRpc','Include XML-RPC Pings','toggle',{hint:'Pingomatic, Weblogs.com, etc.'})
  )}

  ${sSection('ğŸ“Š','SERP Scraper','Search engine scraping &amp; metrics extraction',
    sField('serp_engine','Default Engine','select',{choices:[['duckduckgo','DuckDuckGo Lite (free)'],['bing','Bing (free)'],['serpapi','SerpAPI (paid)'],['valueserp','ValueSERP (paid)']],hint:'Paid APIs give reliable structured results'}) +
    sField('serp_serpApiKey','SerpAPI Key','password',{ph:'serpapi.com API key',hint:'Get at serpapi.com â€” 100 free searches/mo'}) +
    sField('serp_valueSerpKey','ValueSERP Key','password',{ph:'valueserp.com API key'}) +
    sField('serp_resultDepth','Result Depth','number',{min:10,max:100,unit:'results'}) +
    sField('serp_delay','Delay Between Queries','number',{min:500,max:10000,step:500,unit:'ms',hint:'Avoid rate limiting'}) +
    sField('serp_useProxy','Route Through Proxy','toggle',{hint:'Use proxy pool for SERP scraping'}) +
    sField('serp_extractMetrics','Extract DA/Metrics','toggle',{hint:'Estimate DA and backlinks for each result'})
  )}

  </div><div>

  ${sSection('ğŸ“²','Social Signal Blaster','OAuth tokens for each social platform',
    sField('ssb_pinterestToken','Pinterest Access Token','password',{ph:'Pinterest OAuth token',hint:'Pinterest Developer â†’ Apps â†’ OAuth'}) +
    sField('ssb_redditToken','Reddit Bearer Token','password',{ph:'reddit oauth bearer',hint:'Reddit App OAuth2 bearer token'}) +
    sField('ssb_tumblrToken','Tumblr OAuth Token','password',{ph:'Tumblr API token'}) +
    sField('ssb_pocketToken','Pocket Access Token','password',{ph:'Pocket API token',hint:'getpocket.com/developer'}) +
    sField('ssb_delayBetween','Delay Between Signals','number',{min:500,max:15000,step:500,unit:'ms'}) +
    sField('ssb_fallbackFetch','Fallback Crawl Fetch','toggle',{hint:'If no token, attempt direct fetch as crawl signal'})
  )}

  ${sSection('ğŸ—','Web 2.0 Builder','Post building, interlinks &amp; post-build actions',
    sField('w2b_articleLength','Default Article Length','select',{choices:[['short','Short'],['medium','Medium'],['long','Long']]}) +
    sField('w2b_interlinkCount','Internal Link Count','number',{min:1,max:10,unit:'links',hint:'Links to inject into each article'}) +
    sField('w2b_pingAfterBuild','Ping After Build','toggle',{hint:'Auto-ping Google/Bing after each successful post'}) +
    sField('w2b_indexAfterBuild','Index After Build','toggle',{hint:'Auto-submit to IndexNow after each post'}) +
    sField('auto_index_on_publish','Auto-Index Paste URLs','toggle',{hint:'Instantly fires IndexNow + Google/Bing ping after every successful paste campaign URL â€” runs silently in background'}) +
    sField('w2b_delayBetween','Delay Between Builds','number',{min:500,max:15000,step:500,unit:'ms'})
  )}

  ${sSection('ğŸ’¬','Forum Profile Blaster','Default profile data &amp; posting behavior',
    sField('fpb_defaultUsername','Default Username','text',{ph:'your-username',hint:'Prefills username across all forums',width:'200px'}) +
    sField('fpb_defaultBio','Default Bio','text',{ph:'SEO professional. Check out my site:',width:'200px'}) +
    sField('fpb_urlInBio','Include URL in Bio','toggle',{hint:'Append target URL to bio automatically'}) +
    sField('fpb_delayBetween','Delay Between Profiles','number',{min:500,max:20000,step:500,unit:'ms'})
  )}

  ${sSection('ğŸ”“','CAPTCHA Solver','API keys &amp; polling configuration',
    sField('cap_provider','Default Provider','select',{choices:[['2captcha','2captcha'],['anticaptcha','Anti-Captcha'],['capsolver','CapSolver']],hint:'Active provider used for solve requests'}) +
    sField('cap_2captchaKey','2Captcha API Key','password',{ph:'2captcha.com API key',hint:'2captcha.com â†’ Dashboard â†’ API Key'}) +
    sField('cap_antiCaptchaKey','Anti-Captcha Key','password',{ph:'anti-captcha.com API key'}) +
    sField('cap_capSolverKey','CapSolver Key','password',{ph:'capsolver.com API key'}) +
    sField('cap_pollInterval','Poll Interval','number',{min:2000,max:15000,step:500,unit:'ms',hint:'How often to check if CAPTCHA is solved'}) +
    sField('cap_maxPollAttempts','Max Poll Attempts','number',{min:5,max:60,unit:'Ã—',hint:'Give up after this many checks'})
  )}

  ${sSection('ğŸ–±','CTR Manipulator','Traffic simulation parameters',
    sField('ctr_bounceRate','Target Bounce Rate','range',{min:5,max:60,unit:'%',hint:'Lower = more dwell time simulated'}) +
    sField('ctr_minDwell','Min Dwell Time','number',{min:10,max:300,unit:'sec'}) +
    sField('ctr_maxDwell','Max Dwell Time','number',{min:30,max:600,unit:'sec'}) +
    sField('ctr_scrollDepth','Scroll Depth','range',{min:20,max:100,unit:'%',hint:'Simulated scroll depth %'}) +
    sField('ctr_useProxy','Route Through Proxy','toggle',{hint:'Each visit uses a different proxy IP'}) +
    sField('ctr_delayBetween','Delay Between Visits','number',{min:1000,max:60000,step:1000,unit:'ms'})
  )}

  ${sSection('ğŸ”„','Freshness Scheduler','Republish intervals &amp; default mutations',
    sField('fs_defaultInterval','Default Interval','number',{min:1,max:180,unit:'days',hint:'Days between auto-republish'}) +
    sField('fs_pingAfter','Ping After Republish','toggle',{hint:'Auto-ping indexers after each freshness update'})
  )}

  ${sSection('ğŸ”','GSC Inspector','Google Search Console &amp; index checking',
    sField('gsc_oauthToken','Google OAuth Token','password',{ph:'ya29.xxx Google OAuth 2.0 token',hint:'Required for full GSC data â€” impressions, clicks, mobile status'}) +
    sField('gsc_siteUrl','Default Site URL','text',{ph:'https://yoursite.com',hint:'Pre-fill the site property URL',width:'220px'}) +
    sField('gsc_fallbackBing','Bing Index Fallback','toggle',{hint:'If no OAuth token, check Bing for index status'}) +
    sField('gsc_fallbackSiteOp','Site: Operator Fallback','toggle',{hint:'Use Google site: search as last resort'})
  )}

  ${sSection('âš“','Anchor Controller','Default anchor type ratio targets',
    sField('anc_exactRatio','Exact Match %','range',{min:0,max:60,hint:'e.g. "best running shoes"'}) +
    sField('anc_partialRatio','Partial Match %','range',{min:0,max:60,hint:'e.g. "running shoes guide"'}) +
    sField('anc_brandedRatio','Branded %','range',{min:0,max:60,hint:'e.g. "Nike" or "Your Brand"'}) +
    sField('anc_nakedRatio','Naked URL %','range',{min:0,max:60,hint:'e.g. "https://yoursite.com"'}) +
    sField('anc_genericRatio','Generic %','range',{min:0,max:60,hint:'e.g. "click here", "read more"'})
  )}

  ${sSection('ğŸš‚','Railway Backend','Self-hosted backend API on Railway.app for CORS bypass &amp; server-side operations',
    sField('railway_url','Railway API URL','text',{ph:'https://your-app.railway.app',hint:'Base URL of your deployed Railway backend',width:'280px'}) +
    sField('railway_secret','Railway Secret Key','password',{ph:'your-secret-api-key',hint:'Auth header sent as X-API-Key on every request'}) +
    sField('railway_enabled','Use Railway Backend','toggle',{hint:'Route CORS-blocked requests through Railway proxy'}) +
    sField('railway_timeout','Railway Timeout','number',{min:5000,max:60000,step:1000,unit:'ms',hint:'Max wait for Railway API response'})
  )}
  <div style="padding:6px 14px 10px">
    <button class="btn btn-sm" onclick="testRailwayConnection()" style="border-color:#0070f3;color:#0070f3;font-weight:700">ğŸš‚ Test Railway Connection</button>
    <span id="railway-status-msg" style="margin-left:10px;font-size:10px;font-family:var(--mono)">${settingGet('railway_connected')?'<span style="color:#3ecf8e">âœ“ Previously connected</span>':'<span style="color:#888">Not tested yet</span>'}</span>
  </div>

  </div></div>

  <div class="set-section" style="margin-bottom:14px">
    <div class="set-section-hdr" style="display:flex;align-items:center;gap:10px">
      <span class="set-section-icon">âš¡</span>
      <div style="flex:1">
        <div class="set-section-title">Supabase Database</div>
        <div class="set-section-desc">Cloud persistence for campaigns, keywords, links, accounts &amp; proxies â€” connect once to sync all data</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
        <button class="btn btn-sm supa-btn" onclick="supaTestConnection()" style="background:#3ecf8e;color:#fff;border-color:#2ab37a;font-weight:700">âš¡ Test Connection</button>
        <button class="btn btn-sm" onclick="supaSetupTables()" style="border-color:#3ecf8e;color:#3ecf8e">ğŸ—„ Create Tables</button>
        <button class="btn btn-sm" onclick="supaSyncAll()" style="border-color:#3ecf8e;color:#3ecf8e">ğŸ”„ Sync All</button>
        <button class="btn btn-ghost btn-sm" onclick="supaDisconnect()">âœ• Disconnect</button>
      </div>
    </div>
    <div class="set-fields">
      <div class="set-row">
        <label class="set-label" title="Your Supabase project URL â€” found in Project Settings â€º API">Project URL</label>
        <div class="set-control">
          <input type="text" id="setting-supa_url" value="${esc(String(settingGet('supa_url')||''))}"
            placeholder="https://xxxxxxxxxxxx.supabase.co"
            onchange="settingSet('supa_url',this.value)" style="width:320px;font-family:monospace">
          <span class="set-hint">Project Settings â†’ API â†’ Project URL</span>
        </div>
      </div>
      <div class="set-row">
        <label class="set-label" title="Anon/public key â€” safe to use in frontend code">Anon / Public Key</label>
        <div class="set-control">
          <input type="password" id="setting-supa_anon_key" value="${esc(String(settingGet('supa_anon_key')||''))}"
            placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            onchange="settingSet('supa_anon_key',this.value)" style="width:320px;font-family:monospace">
          <button class="btn btn-ghost btn-xs" onclick="var i=document.getElementById('setting-supa_anon_key');i.type=i.type==='password'?'text':'password'">ğŸ‘</button>
          <span class="set-hint">Project Settings â†’ API â†’ anon / public</span>
        </div>
      </div>
      <div class="set-row">
        <label class="set-label" title="Service role key â€” admin operations only, never expose publicly">Service Role Key <span style="color:#cc0000;font-size:9px">(optional)</span></label>
        <div class="set-control">
          <input type="password" id="setting-supa_service_key" value="${esc(String(settingGet('supa_service_key')||''))}"
            placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            onchange="settingSet('supa_service_key',this.value)" style="width:320px;font-family:monospace">
          <button class="btn btn-ghost btn-xs" onclick="var i=document.getElementById('setting-supa_service_key');i.type=i.type==='password'?'text':'password'">ğŸ‘</button>
          <span class="set-hint">Project Settings â†’ API â†’ service_role (keep secret!)</span>
        </div>
      </div>
      <div class="set-row">
        <label class="set-label">Table Prefix <span style="color:var(--win-text-muted);font-size:9px">(optional)</span></label>
        <div class="set-control">
          <input type="text" id="setting-supa_prefix" value="${esc(String(settingGet('supa_prefix')||''))}"
            placeholder="seo_" onchange="settingSet('supa_prefix',this.value)" style="width:120px;font-family:monospace">
          <span class="set-hint">Prefix all table names (e.g. seo_ â†’ seo_campaigns)</span>
        </div>
      </div>
      <div class="set-row">
        <label class="set-label">Auto-Sync on Campaign End</label>
        <div class="set-control">
          <label class="toggle-sw"><input type="checkbox" id="setting-supa_autosync" ${settingGet('supa_autosync')?'checked':''} onchange="settingSet('supa_autosync',this.checked)"><span class="toggle-track"><span class="toggle-thumb"></span></span></label>
          <span class="set-hint">Automatically push results to Supabase after each campaign run</span>
        </div>
      </div>
      <div style="padding:8px 0">
        <div id="supa-status-msg" class="supa-status">${supaStatusHtml()}</div>
      </div>
      <div style="padding:10px 12px;background:rgba(62,207,142,0.06);border:1px solid rgba(62,207,142,0.4);font-size:10px;color:var(--win-text-muted);line-height:1.9">
        <strong style="color:#004422">ğŸ“‹ Supabase Setup Steps:</strong><br>
        1. Go to <a href="https://supabase.com" target="_blank" style="color:#3ecf8e;font-weight:700">supabase.com</a> â†’ New Project (free tier works)<br>
        2. Copy <strong>Project URL</strong> and <strong>anon key</strong> from Project Settings â†’ API<br>
        3. Paste both fields above and click <strong>âš¡ Test Connection</strong><br>
        4. Click <strong>ğŸ—„ Create Tables</strong> to auto-create all required tables via SQL<br>
        5. Click <strong>ğŸ”„ Sync All</strong> to push your current localStorage data to the cloud
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card-title">ğŸ”‘ Quick API Key Status</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px">
      ${[
        ['IndexNow','li_indexNowKey'],['GSC OAuth','li_gscOAuthToken'],
        ['SerpAPI','serp_serpApiKey'],['ValueSERP','serp_valueSerpKey'],
        ['Pinterest','ssb_pinterestToken'],['Reddit','ssb_redditToken'],
        ['Tumblr','ssb_tumblrToken'],['Pocket','ssb_pocketToken'],
        ['2Captcha','cap_2captchaKey'],['Anti-Captcha','cap_antiCaptchaKey'],['CapSolver','cap_capSolverKey'],
        ['GSC Token','gsc_oauthToken'],
      ].map(([lbl,key]) => {
        const hasKey = !!settingGet(key);
        return `<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:${hasKey?'rgba(0,102,0,0.08)':'rgba(204,0,0,0.06)'};border:1px solid ${hasKey?'#006600':'#cc0000'};border-radius:2px">
          <span style="font-size:14px">${hasKey?'âœ…':'âŒ'}</span>
          <div>
            <div style="font-weight:700;font-size:10px">${lbl}</div>
            <div style="font-size:9px;color:var(--win-text-muted)">${hasKey?'Configured':'Not set'}</div>
          </div>
        </div>`;
      }).join('')}
    </div>
    <div style="padding:8px 12px;font-size:10px;color:var(--win-text-muted);border-top:1px solid var(--win-border)">
      ğŸ’¡ Missing API keys? <a href="#" onclick="switchPage('help');setTimeout(()=>document.getElementById('help-api-keys')?.scrollIntoView({behavior:'smooth'}),200);return false" style="color:var(--win-blue);font-weight:700">View the API Keys guide â†’</a>
    </div>
  </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELP PAGE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHelp(el) {
  el = el || document.getElementById('page-help'); if(!el) return;

  const helpCard = (icon, title, badge, intro, steps, tips, links, nextSteps) => `
    <div class="help-card" id="help-${title.toLowerCase().replace(/[^a-z0-9]+/g,'-')}">
      <div class="help-card-hdr">
        <span class="help-icon">${icon}</span>
        <div class="help-meta">
          <div class="help-title">${title}</div>
          <span class="help-badge">${badge}</span>
        </div>
      </div>
      <div class="help-body">
        <div class="help-intro">${intro}</div>
        ${steps?`<div class="help-steps-title">ğŸš€ Quick Start</div><ol class="help-steps">${steps.map(s=>`<li>${s}</li>`).join('')}</ol>`:''}
        ${tips?`<div class="help-tips">${tips.map(t=>`<div class="help-tip">ğŸ’¡ ${t}</div>`).join('')}</div>`:''}
        ${links?`<div class="help-links-row">${links.map(([l,p])=>`<button class="btn btn-ghost btn-xs help-nav-btn" onclick="switchPage('${p}')">${l} â†’</button>`).join('')}</div>`:''}
        ${nextSteps?`<div class="help-next"><strong>ğŸ”— Use with:</strong> ${nextSteps.map(([l,p])=>`<a href="#" onclick="switchPage('${p}');return false" class="help-link">${l}</a>`).join(' Â· ')}</div>`:''}
      </div>
    </div>`;

  el.innerHTML = `
  <div class="page-title">â“ Help &amp; Quick-Start Guide</div>
  <div class="page-sub">// Everything you need to know Â· Start here if you're new Â· Click any module card to jump to it</div>

  <style>
  .help-search{width:100%;max-width:440px;padding:7px 12px;font-size:12px;border:2px inset var(--win-border);background:var(--win-surface);font-family:inherit;margin-bottom:16px}
  .help-toc{background:var(--win-surface);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);padding:12px 16px;margin-bottom:16px}
  .help-toc-title{font-weight:700;font-size:12px;color:var(--win-blue);margin-bottom:8px;border-bottom:1px solid var(--win-border);padding-bottom:4px}
  .help-toc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
  .help-toc-btn{background:var(--win-btn);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);padding:4px 8px;font-family:inherit;font-size:10px;cursor:pointer;text-align:left;color:var(--win-blue);font-weight:700}
  .help-toc-btn:hover{background:var(--win-sel);color:#fff}
  .help-section-title{font-size:14px;font-weight:700;color:var(--win-blue);border-bottom:2px solid var(--win-border);padding-bottom:6px;margin:20px 0 10px}
  .help-card{background:var(--win-surface);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);margin-bottom:12px}
  .help-card-hdr{background:linear-gradient(to bottom,#e8e4d8,#d4d0c8);padding:8px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--win-border);cursor:pointer}
  .help-card-hdr:hover{background:linear-gradient(to bottom,#ddd9cd,#c8c4bc)}
  .help-icon{font-size:22px;width:32px;text-align:center}
  .help-meta{flex:1}
  .help-title{font-weight:700;font-size:12px;color:var(--win-blue)}
  .help-badge{font-size:9px;background:var(--win-blue);color:#fff;padding:1px 5px;border-radius:2px}
  .help-body{padding:12px 16px;display:flex;flex-direction:column;gap:8px}
  .help-intro{font-size:11px;line-height:1.6;color:var(--win-text)}
  .help-steps-title{font-weight:700;font-size:11px;color:var(--win-text);margin-top:4px}
  .help-steps{font-size:11px;line-height:1.7;padding-left:18px;color:var(--win-text)}
  .help-tips{display:flex;flex-direction:column;gap:4px}
  .help-tip{font-size:10px;background:rgba(0,48,135,0.06);border-left:3px solid var(--win-blue);padding:4px 8px;color:var(--win-text)}
  .help-links-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .help-nav-btn{font-size:10px}
  .help-next{font-size:10px;padding:6px 10px;background:rgba(0,102,0,0.07);border-left:3px solid var(--win-green);color:var(--win-text)}
  .help-link{color:var(--win-blue);font-weight:700;text-decoration:none}
  .help-link:hover{text-decoration:underline}
  .help-overview-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
  .help-overview-card{background:var(--win-surface);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);padding:12px;cursor:pointer;transition:background 0.1s}
  .help-overview-card:hover{background:#e0ddd5}
  .help-overview-card h4{font-size:12px;color:var(--win-blue);margin-bottom:4px}
  .help-overview-card p{font-size:10px;color:var(--win-text-muted);line-height:1.5}
  .help-flow{background:var(--win-surface);border:2px solid;border-color:var(--win-btn-hi) var(--win-btn-sh) var(--win-btn-sh) var(--win-btn-hi);padding:14px;margin-bottom:16px}
  .help-flow-steps{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:10px}
  .help-flow-step{background:var(--win-blue);color:#fff;padding:5px 12px;font-size:11px;font-weight:700;border-radius:2px;cursor:pointer;white-space:nowrap}
  .help-flow-step:hover{background:var(--win-blue2)}
  .help-flow-arrow{color:var(--win-text-muted);font-size:16px;font-weight:700}
  .help-apikey-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .help-apikey-card{background:var(--win-surface);border:1px solid var(--win-border);padding:10px 12px}
  .help-apikey-card h5{font-size:11px;font-weight:700;color:var(--win-blue);margin-bottom:4px}
  .help-apikey-card p{font-size:10px;line-height:1.5;color:var(--win-text)}
  .help-apikey-card a{color:var(--win-blue);font-weight:700}
  </style>

  <!-- SEARCH -->
  <input class="help-search" type="text" placeholder="ğŸ” Search help topics... (e.g. 'proxy', 'api key', 'indexing')"
    oninput="helpSearch(this.value)">

  <!-- BEGINNER WORKFLOW -->
  <div class="help-flow" id="help-workflow">
    <div style="font-weight:700;font-size:13px;color:var(--win-blue)">ğŸ—º Recommended Workflow for New Users</div>
    <div style="font-size:10px;color:var(--win-text-muted);margin-top:4px">Follow this sequence for best results. Each step feeds the next.</div>
    <div class="help-flow-steps">
      <div class="help-flow-step" onclick="switchPage('setup')" title="Connect your platform accounts">â‘  Setup Accounts</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('keywords')" title="Load your target keywords">â‘¡ Add Keywords</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('links')" title="Add backlink targets">â‘¢ Add Target Links</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('proxy_manager')" title="Fetch and test proxies">â‘£ Load Proxies</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('captcha_solver')" title="Set up CAPTCHA solving">â‘¤ CAPTCHA Keys</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('campaign')" title="Run your campaign">â‘¥ Run Campaign</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('link_indexer')" title="Get your pages indexed">â‘¦ Index URLs</div>
      <div class="help-flow-arrow">â†’</div>
      <div class="help-flow-step" onclick="switchPage('freshness_scheduler')" title="Keep pages fresh">â‘§ Freshness</div>
    </div>
  </div>

  <!-- TABLE OF CONTENTS -->
  <div class="help-toc">
    <div class="help-toc-title">ğŸ“‹ Jump to Any Module</div>
    <div class="help-toc-grid">
      ${[
        ['âš¡ Dashboard','help-dashboard'],['ğŸŒ Global Blast','help-global-blast'],['ğŸ”‘ Keywords','help-keywords'],['ğŸ”— Links Manager','help-links-manager'],
        ['âš™ Setup / Connect','help-setup-connect'],['â–¶ Run Campaign','help-run-campaign'],['ğŸ“¡ Link Indexer','help-link-indexer'],['ğŸ“£ Ping Submitter','help-ping-submitter'],
        ['ğŸ“Š SERP Scraper','help-serp-scraper'],['ğŸ“² Social Blaster','help-social-signal-blaster'],['ğŸ— Web 2.0 Builder','help-web-2.0-builder'],['ğŸ’¬ Forum Blaster','help-forum-profile-blaster'],
        ['âœ Content Studio','help-content-studio'],['ğŸ•µ Competitor Spy','help-competitor-spy'],['ğŸ” KW Research','help-kw-research'],['ğŸ’¬ Blog Commenter','help-blog-commenter'],
        ['ğŸ¦  Parasite Finder','help-parasite-finder'],['ğŸŒ Comment Sites','help-comment-sites'],['ğŸ“„ PDF Parasite','help-pdf-parasite'],['ğŸš€ PDF Uploader','help-smart-pdf-upload'],
        ['ğŸ›¡ Proxy Manager','help-proxy-manager'],['ğŸ” GSC Inspector','help-gsc-inspector'],['ğŸ¤– Account Creator','help-account-creator'],['ğŸ“§ Email Generator','help-email-generator'],
        ['ğŸ”“ CAPTCHA Solver','help-captcha-solver'],['ğŸª Session Manager','help-session-manager'],['ğŸ–± CTR Engine','help-ctr-engine'],['ğŸ”„ Freshness Scheduler','help-freshness-scheduler'],
        ['âš“ Anchor Controller','help-anchor-controller'],['ğŸ“¤ Export Center','help-export-center'],['ğŸ”‘ API Keys Guide','help-api-keys'],['âš™ Settings Guide','help-settings-guide'],
      ].map(([l,id]) => `<button class="help-toc-btn" onclick="document.getElementById('${id}')?.scrollIntoView({behavior:'smooth'})">${l}</button>`).join('')}
    </div>
  </div>

  <div id="help-all-content">

  <!-- â”€â”€ GETTING STARTED â”€â”€ -->
  <div class="help-section-title">ğŸŒ± Getting Started</div>

  ${helpCard('âš¡','Dashboard','Overview',
    'Your command center. Shows all connected platforms, recent campaign results, live URL count, and success rates. Every stat box is clickable to drill down. The platform grid shows which accounts are connected â€” green means ready, grey means needs setup.',
    ['Click any platform card to jump straight to its setup page','Check the success rate stat â€” below 70%? See Proxy Manager and CAPTCHA Solver','Use the "Recent Activity" table to find and revisit live URLs'],
    ['A live URL count of 0 means no campaigns have run yet â€” go to Run Campaign','If a platform shows "Not connected", click it to open Setup'],
    null,
    [['Setup / Connect','setup'],['Run Campaign','campaign'],['Export Center','export']]
  )}

  ${helpCard('âš™','Setup / Connect','Required First',
    'Connect your platform API keys and accounts here. Each platform (GitHub, Medium, Dev.to, etc.) needs credentials before you can publish. Click any platform tab at the top to configure it. Some platforms use API keys (GitHub, Dev.to), others use OAuth tokens (Medium, Reddit), and a few use session cookies (Substack).',
    [
      'Select a platform from the top tab bar',
      'Click the blue link next to the token field to go directly to that platform\'s API settings page',
      'Paste your token and click "Save Account"',
      'Repeat for each platform you want to use',
      'Return to Dashboard â€” connected platforms will show green status'
    ],
    [
      'Free platforms like GitHub, Telegraph, Dev.to, and Hashnode are the easiest to start with',
      'GitHub Personal Access Token needs "repo" scope â€” the link in the hint takes you directly there',
      'Medium requires an Integration Token (not your password) â€” find it in Medium Settings â†’ Security',
      'For platforms without an API (OnFeetNation, CaribbeanFever), session cookies are used instead'
    ],
    [['Go to Settings â†’','settings'],['View API Keys Guide â†’','help']],
    [['Keywords','keywords'],['Run Campaign','campaign']]
  )}

  ${helpCard('ğŸ”‘','Keywords','Load Targets',
    'Keywords are the search terms you want to rank for. Each keyword becomes an article title and URL slug. You can paste keywords one per line, import from a CSV file, or use the KW Research tool to discover new ones automatically.',
    [
      'Paste your keywords in the text area (one per line)',
      'Click "Add Keywords" â€” duplicates are automatically removed',
      'Use the filter box to search your keyword list',
      'Delete individual keywords with the Ã— button, or clear all to start over'
    ],
    [
      'Long-tail keywords (3â€“5 words) work better for parasite SEO than broad 1-word terms',
      'Include your target geo in keywords for local SEO: "best plumber London" beats "plumber"',
      'Use KW Research (sidebar) to find related keywords automatically before adding them here',
      'Import from CSV to batch-load hundreds of keywords at once'
    ],
    null,
    [['KW Research','kw_research'],['Run Campaign','campaign'],['SERP Scraper','serp_scraper']]
  )}

  ${helpCard('ğŸ”—','Links Manager','Backlink Targets',
    'The links you add here are inserted as backlinks into every published article. These are the URLs you want to rank â€” your money site, affiliate pages, or client sites. Each link can be targeted to Markdown content, HTML content, or both.',
    [
      'Enter a URL and anchor text label',
      'Set "Target" to control where the link appears: Readme (Markdown), HTML, or Both',
      'Click "Add Link" â€” it appears in the list below',
      'Run a campaign â€” every published article will contain your links'
    ],
    [
      'Use keyword-rich anchor text for your money links (e.g. "best running shoes 2025")',
      'Vary your anchor text across different links to appear natural â€” use Anchor Controller to plan ratios',
      'Links set to "Both" appear in Markdown README files AND HTML pages',
      'Maximum ~5 links per article for natural-looking link density'
    ],
    null,
    [['Anchor Controller','anchor_controller'],['Run Campaign','campaign'],['Export Center','export']]
  )}

  <!-- â”€â”€ CORE TOOLS â”€â”€ -->
  <div class="help-section-title">âš¡ Core Publishing Tools</div>

  ${helpCard('â–¶','Run Campaign','Primary Action',
    'The main publishing engine. Runs your connected platform accounts against your keyword list, generating and publishing a unique article for each keyword/platform combination. Articles are auto-generated using your links, current year, and SEO-optimized templates.',
    [
      'Make sure you have: at least 1 account connected (Setup), keywords added, and links added',
      'Select which platforms to run (or leave all selected)',
      'Choose article length in Settings â†’ Campaign',
      'Click "Run Campaign" and watch the terminal output',
      'Copy live URLs from the results table when complete'
    ],
    [
      'Start with 1â€“2 platforms first to verify your tokens work before running all 20+',
      'Enable "Shuffle Platform Order" in Settings to reduce footprint patterns',
      'If a platform fails consistently, check its API token in Setup / Connect',
      'Use proxies (Proxy Manager) for high-volume campaigns to avoid IP blocks'
    ],
    [['View Proxies â†’','proxy_manager'],['Index URLs â†’','link_indexer']],
    [['Link Indexer','link_indexer'],['Ping Submitter','ping_submitter'],['Export Center','export']]
  )}

  ${helpCard('ğŸŒ','Global Blast','Bulk Campaign',
    'Global Blast fires a campaign across ALL connected platforms simultaneously for a single keyword. Use this for your most important target terms when you want maximum coverage in one shot â€” all 20+ platforms in a single run.',
    [
      'Enter your target keyword in the blast field',
      'Select which platforms to include (or use Select All)',
      'Click "GLOBAL BLAST" â€” all platforms run in parallel',
      'Collect and export the resulting URLs'
    ],
    [
      'Global Blast is best for your highest-value money keywords',
      'Use with proxies to avoid rate limiting across all platforms simultaneously',
      'After blasting, immediately run Link Indexer on the results to get them crawled fast'
    ],
    [['Go to Proxy Manager â†’','proxy_manager'],['Index URLs â†’','link_indexer']],
    [['Link Indexer','link_indexer'],['Ping Submitter','ping_submitter']]
  )}

  <!-- â”€â”€ INDEXING & SIGNALS â”€â”€ -->
  <div class="help-section-title">ğŸ“¡ Indexing, Signals &amp; Freshness</div>

  ${helpCard('ğŸ“¡','Link Indexer','Get Pages Found',
    'Submits your published URLs to Google, Bing, and other indexers so they get crawled and indexed faster. Without indexing, your pages might not appear in search for weeks. IndexNow is the fastest method â€” it notifies search engines instantly when you submit a URL.',
    [
      'Paste your live URLs (one per line) into the URL box',
      'Or click "Load from Campaign" to auto-import from your last campaign results',
      'Set your IndexNow key in Settings â†’ Link Indexer (get one free from Bing Webmaster Tools)',
      'Click "Submit to Indexers" and watch the terminal for confirmation'
    ],
    [
      'IndexNow is the fastest indexing method â€” Bing and other engines are notified within seconds',
      'Google Ping is a secondary method â€” still useful but slower than IndexNow',
      'For GSC data (impressions, clicks), set your Google OAuth token in Settings',
      'Submit URLs immediately after publishing â€” the sooner the better'
    ],
    [['Get IndexNow Key â†’','settings'],['Check Index Status â†’','gsc_inspector']],
    [['GSC Inspector','gsc_inspector'],['Ping Submitter','ping_submitter'],['Freshness Scheduler','freshness_scheduler']]
  )}

  ${helpCard('ğŸ“£','Ping Submitter','Notify Blog Directories',
    'Pings classic blog update services (Pingomatic, Weblogs.com, BlogPulse, etc.) via HTTP GET and XML-RPC. While less powerful than IndexNow, pings help with older discovery mechanisms and create additional link signals.',
    ['Paste URLs to ping','Select which ping services to hit','Click "Send Pings" â€” results show in terminal'],
    ['Use after Link Indexer for belt-and-suspenders coverage','XML-RPC pings go to Pingomatic which then fans out to 30+ services'],
    null,
    [['Link Indexer','link_indexer'],['Web 2.0 Builder','web2_builder']]
  )}

  ${helpCard('ğŸ”„','Freshness Scheduler','Extend Rankings',
    'Google\'s QDF (Query Deserves Freshness) algorithm rewards pages that are updated regularly. This tool auto-edits your published parasite pages on a schedule and republishes them, resetting their freshness score. Even minor content mutations trigger a new crawl.',
    [
      'Paste the content of a published page',
      'Enter the platform and Post ID/URL',
      'Add your API key for that platform',
      'Select which mutations to apply (date replacement, header timestamp, etc.)',
      'Set an interval (every 14â€“28 days is ideal)',
      'Click "Add Schedule" â€” it will auto-run on schedule'
    ],
    [
      'Date replacement (changing "2024" â†’ "2025" etc.) is the most effective mutation',
      'Header timestamp adds "[Updated 2025]" to headings â€” highly visible freshness signal',
      'Pages refreshed every 2â€“4 weeks dramatically outlast static pages in competitive niches',
      'Combine with Ping Submitter after each refresh for maximum freshness signaling'
    ],
    null,
    [['Link Indexer','link_indexer'],['Ping Submitter','ping_submitter']]
  )}

  ${helpCard('ğŸ“²','Social Signal Blaster','Social Proof',
    'Sends social sharing signals (Pinterest pins, Reddit posts, Tumblr reposts, Pocket saves) to your published URLs. Social signals help with crawling speed and can drive direct referral traffic as an additional ranking factor.',
    [
      'Add your social platform tokens in Settings â†’ Social Blaster',
      'Paste the URLs to promote',
      'Add a title and description',
      'Click "Blast Signals" â€” each platform gets a post/pin/save'
    ],
    [
      'Pinterest tokens are the most impactful â€” pins drive real crawls and referral traffic',
      'If no API token is set, fallback crawl-fetch still creates a lightweight crawl signal',
      'Use within 24 hours of publishing for maximum freshness amplification'
    ],
    null,
    [['Link Indexer','link_indexer'],['Web 2.0 Builder','web2_builder']]
  )}

  <!-- â”€â”€ RESEARCH â”€â”€ -->
  <div class="help-section-title">ğŸ” Research &amp; Intelligence</div>

  ${helpCard('ğŸ“Š','SERP Scraper','Analyze Rankings',
    'Scrapes Google/Bing/DuckDuckGo search results for your target keywords and identifies parasite pages already ranking. Shows domain authority estimates, ranking positions, and whether each result is a parasite (Reddit, Medium, Quora, etc.) or an authority site.',
    [
      'Enter your target keyword',
      'Select the engine (DuckDuckGo is free and reliable)',
      'Set result depth (30â€“50 is typical)',
      'Click "Scrape SERP" â€” results appear in the table',
      'Filter by "Parasites Only" to see which platforms are already ranking'
    ],
    [
      'If you see Medium, Reddit, or Quora in the top 10, those platforms are "parasite-friendly" for that keyword',
      'Use SerpAPI key (Settings) for guaranteed structured results â€” free tier gives 100 searches/month',
      'The "Parasite" badge means that domain is in our known list of high-DA content platforms',
      'Identified parasite platforms are automatically suggested as targets in Run Campaign'
    ],
    null,
    [['KW Research','kw_research'],['Competitor Spy','competitor_spy'],['Run Campaign','campaign']]
  )}

  ${helpCard('ğŸ•µ','Competitor Spy','Reverse Engineer',
    'Analyzes competitor URLs to extract their backlink profiles, content strategies, and ranking keywords. Enter any URL to see where they\'re getting links from and what content is driving their rankings.',
    ['Enter a competitor URL','Click "Spy" to analyze','Review the backlink sources and anchor texts','Use insights to build a similar strategy'],
    ['Focus on their parasite pages â€” if a competitor has Medium or Dev.to content ranking, you should too'],
    null,
    [['SERP Scraper','serp_scraper'],['Links Manager','links']]
  )}

  ${helpCard('ğŸ”','KW Research','Keyword Discovery',
    'Finds related keywords, long-tail variations, and question-based terms for your seed keyword. Uses free APIs (DataForSEO, keyword suggestion endpoints) to generate keyword clusters you can use in your campaign.',
    ['Enter a seed keyword','Click "Research" to generate suggestions','Review keyword difficulty and search volume estimates','Select keywords and click "Add to List" to send them to the Keywords page'],
    ['Question keywords ("how to...", "best... for...") often have lower competition','Long-tail variations (4â€“6 words) are easier to rank with parasite pages'],
    null,
    [['Keywords','keywords'],['SERP Scraper','serp_scraper']]
  )}

  ${helpCard('ğŸ¦ ','Parasite Finder','Find Opportunities',
    'Identifies which high-DA platforms already rank in Google for your niche. Searches for your keywords across known parasite domains and shows which ones have existing ranking content â€” these are your highest-opportunity platforms.',
    ['Enter your niche keyword','Click "Find Parasites"','Review which platforms are already ranking','Target those platforms first in your campaign'],
    ['A platform appearing in top 10 results means Google "trusts" it for that niche â€” build there first'],
    null,
    [['Run Campaign','campaign'],['SERP Scraper','serp_scraper']]
  )}

  <!-- â”€â”€ LINK BUILDING â”€â”€ -->
  <div class="help-section-title">ğŸ”— Link Building Tools</div>

  ${helpCard('ğŸ—','Web 2.0 Builder','Property Network',
    'Builds a network of Web 2.0 properties (blogs, profiles) that link to your money site. Unlike the main campaign (which targets parasite platforms), Web 2.0 Builder creates standalone mini-sites on lower-DA platforms specifically for link building.',
    [
      'Add your target URL (money site to link to)',
      'Select platforms to build on',
      'Enter keywords for article generation',
      'Click "Build Web 2.0s" â€” sites are created with embedded links',
      'Enable "Ping After Build" in Settings to auto-index new sites'
    ],
    [
      'Web 2.0s are best used as Tier 2 links â€” they link to your parasite pages, not directly to money site',
      'Build 10â€“20 Web 2.0s per target for a solid Tier 2 buffer',
      'Use different keywords and anchor texts on each Web 2.0 for natural variety'
    ],
    null,
    [['Forum Blaster','forum_blaster'],['Social Blaster','social_blaster'],['Anchor Controller','anchor_controller']]
  )}

  ${helpCard('ğŸ’¬','Forum Profile Blaster','Profile Links',
    'Creates profile pages with backlinks on high-DA forums and community sites. Profile links are an established Tier 2 strategy â€” they provide link equity even without clicks.',
    [
      'Add your target URL',
      'Set default username and bio in Settings â†’ Forum Blaster',
      'Select forum targets',
      'Click "Blast Profiles" â€” profiles are created with your URL in the bio field'
    ],
    [
      'Use the same username across forums for brand consistency, or vary for lower footprint',
      'High-DA forums (DA 60+) are marked in the platform list â€” prioritize these',
      'Profile links work best after your parasite pages have some authority'
    ],
    null,
    [['Web 2.0 Builder','web2_builder'],['Anchor Controller','anchor_controller']]
  )}

  ${helpCard('ğŸ’¬','Blog Commenter','Comment Links',
    'Finds relevant blog posts in your niche and automatically submits keyword-relevant comments with your backlink. Comment links are nofollow but provide crawl signals and referral traffic.',
    [
      'Enter your niche keywords to find relevant blogs',
      'Load your target blog list or let the tool discover them',
      'Set your comment template and backlink URL',
      'Run the commenter â€” it submits to dofollow comment sections'
    ],
    [
      'Focus on blogs with comment sections that don\'t require login',
      'Genuine-looking comments dramatically improve approval rates',
      'Use Comment Sites page to find new comment-friendly blogs in your niche'
    ],
    null,
    [['Comment Sites','comment_sites'],['Proxy Manager','proxy_manager']]
  )}

  ${helpCard('âš“','Anchor Controller','Anchor Text Ratios',
    'Plans and manages your anchor text distribution across all your links. Over-optimized anchor text (too many exact-match anchors) is a Penguin penalty trigger. This tool helps you maintain natural-looking ratios.',
    [
      'Set your target anchor text ratios in Settings â†’ Anchor Controller',
      'Enter your keyword and click "Generate Anchors"',
      'The tool creates a balanced set of anchors across all types',
      'Export the anchor list and use it when building links manually or via other modules'
    ],
    [
      'Safe ratios: Exact 20â€“30% Â· Partial 20â€“25% Â· Branded 15â€“20% Â· Naked 15% Â· Generic 10%',
      'New sites should use more branded/naked anchors initially â€” build up exact match slowly',
      'Anchor diversity is one of the most important factors in avoiding manual penalties'
    ],
    null,
    [['Forum Blaster','forum_blaster'],['Web 2.0 Builder','web2_builder']]
  )}

  <!-- â”€â”€ AUTOMATION TOOLS â”€â”€ -->
  <div class="help-section-title">ğŸ¤– Automation &amp; Infrastructure</div>

  ${helpCard('ğŸ›¡','Proxy Manager','IP Rotation',
    'Fetches, tests, and manages a pool of elite western-country proxies. Proxies prevent IP bans when running high-volume campaigns, scraping SERPs, or simulating traffic. The pool is sourced from 22 APIs and GitHub lists, geo-filtered to US/EU/CA.',
    [
      'Click "Scan All Sources" to fetch proxies from all 22 sources',
      'Click "Test All" to check which proxies are alive and measure their speed',
      'Elite proxies (ELITE badge) are prioritized â€” they hide that you\'re using a proxy',
      'Enable "Auto-Use Proxy" in Settings â†’ Campaign to route campaigns through the pool',
      'The proxy badge in the sidebar shows your current live pool count'
    ],
    [
      'Run a fresh scan before each campaign session â€” proxies go dead quickly',
      'Filter to "Alive" and "Elite" before using â€” dead proxies slow everything down',
      'SOCKS5 proxies are more versatile than HTTP â€” use them for SERP scraping',
      'ğŸŸ¢ Fast proxies (<800ms) are ideal for campaigns; ğŸ”´ Slow proxies are fine for background tasks'
    ],
    null,
    [['SERP Scraper','serp_scraper'],['CTR Engine','ctr_manipulator'],['Blog Commenter','blog_commenter']]
  )}

  ${helpCard('ğŸ”“','CAPTCHA Solver','Auto-Solve CAPTCHAs',
    'Integrates with paid CAPTCHA solving services (2Captcha, Anti-Captcha, CapSolver) to automatically solve reCAPTCHA v2/v3, hCaptcha, and image CAPTCHAs. Required for account creation and some form submissions.',
    [
      'Set your API key in Settings â†’ CAPTCHA Solver (or in the CAPTCHA Solver tab directly)',
      'Choose your preferred provider â€” 2Captcha is the most compatible',
      'Click "Check Balance" to verify your credits',
      'Click "Test Solve" to verify the integration works',
      'Other modules will automatically use CAPTCHA solving when needed'
    ],
    [
      '2Captcha costs ~$3 per 1000 reCAPTCHAs â€” load $5â€“10 for a session',
      'CapSolver is faster than 2Captcha for most CAPTCHA types',
      'The solver runs automatically in the background when Account Creator or Blog Commenter needs it'
    ],
    null,
    [['Account Creator','account_creator'],['Blog Commenter','blog_commenter']]
  )}

  ${helpCard('ğŸ¤–','Account Creator','Bulk Account Gen',
    'Generates sets of account credentials for various platforms. Attempts real registration where an API exists (Dev.to). For other platforms, generates ready-to-use credentials that you register manually via the "Register â†—" links.',
    [
      'Select target platforms',
      'Set a default password in Settings â†’ Account Creator (or leave blank to auto-generate)',
      'Enable "Use Email Generator" to auto-create temp emails for each account',
      'Click "Generate Accounts" â€” credentials appear in the table',
      'Use "Register â†—" links to complete registration on platforms that require browser login'
    ],
    [
      'Enable the Email Generator integration â€” it auto-creates a temp email for each account',
      'Store generated accounts in Session Manager for use across modules',
      'Dev.to registration succeeds via API â€” all others are browser-assisted'
    ],
    null,
    [['Email Generator','email_generator'],['Session Manager','session_manager'],['CAPTCHA Solver','captcha_solver']]
  )}

  ${helpCard('ğŸ“§','Email Generator','Temp Emails',
    'Creates temporary, disposable email addresses for account registration. Supports multiple providers including Guerrilla Mail and mail.tm. Inbox checker lets you read verification emails and auto-click verification links.',
    ['Click "Generate" to create a new temp email','Use the address for account registrations','Click "Check Inbox" to read incoming emails','Verification link detection helps auto-confirm accounts'],
    ['mail.tm addresses last longer than Guerrilla Mail â€” use for longer registration flows','Generate 5â€“10 addresses in bulk before starting an Account Creator run'],
    null,
    [['Account Creator','account_creator'],['Session Manager','session_manager']]
  )}

  ${helpCard('ğŸª','Session Manager','Cookie Management',
    'Stores and manages login session cookies for platforms that don\'t have APIs. Paste your browser session cookie after logging into a platform, and this tool rotates sessions across requests to avoid single-account detection.',
    ['Log into target platform in your browser','Open DevTools â†’ Application â†’ Cookies','Copy the session cookie value','Paste it here with the platform name and username','Sessions auto-rotate when multiple are added for the same platform'],
    ['Test sessions before running campaigns â€” expired cookies cause silent failures','Session cookies typically last 24â€“72 hours depending on the platform'],
    null,
    [['Account Creator','account_creator'],['Blog Commenter','blog_commenter']]
  )}

  ${helpCard('ğŸ–±','CTR Engine','Traffic Simulation',
    'Simulates organic search traffic to your published URLs to improve CTR (Click-Through Rate) signals. Routes simulated visits through proxies to appear as natural human traffic. Google\'s RankBrain rewards pages with high CTR.',
    [
      'Add URLs to the traffic queue',
      'Set dwell time min/max in Settings â†’ CTR Engine',
      'Enable "Route Through Proxy" in Settings to use different IPs per visit',
      'Set bounce rate target â€” lower % = more dwell time',
      'Click "Start Engine" to begin simulation'
    ],
    [
      'Use high-quality fast proxies for CTR simulation â€” slow proxies create unnatural patterns',
      'Vary dwell time between 30â€“180 seconds for realistic behavior',
      'Don\'t run CTR simulation on fresh pages â€” wait until they\'re indexed first',
      'Combine with Social Signals for compounded trust signals'
    ],
    null,
    [['Proxy Manager','proxy_manager'],['Social Blaster','social_blaster']]
  )}

  ${helpCard('ğŸ”','GSC Inspector','Index Monitoring',
    'Checks whether your published URLs are indexed in Google using the Search Console URL Inspection API. Shows coverage status, mobile usability, and rich result eligibility. Falls back to Bing index check and site: operator if no OAuth token is set.',
    [
      'Add your Google OAuth token in Settings â†’ GSC Inspector (or Settings â†’ Link Indexer â€” shared token)',
      'Paste URLs to check (one per line)',
      'Click "Inspect All" â€” status appears per URL in the table',
      'Red "Not Indexed" status â†’ re-submit via Link Indexer'
    ],
    [
      'Without an OAuth token, the tool falls back to Bing index check â€” still useful, slightly less accurate',
      'Check indexation 48â€“72 hours after publishing and submitting via Link Indexer',
      'Pages stuck "Not Indexed" after 1 week may need Freshness updates or more links pointing to them'
    ],
    null,
    [['Link Indexer','link_indexer'],['Freshness Scheduler','freshness_scheduler']]
  )}

  <!-- â”€â”€ PDF & CONTENT â”€â”€ -->
  <div class="help-section-title">ğŸ“„ Content &amp; PDF Tools</div>

  ${helpCard('âœ','Content Studio','Article Writing',
    'Write, edit, and template content for your campaigns. Includes a rich text editor, AI-assisted rewriting, and a content library for saving reusable articles. Content created here can be injected directly into campaign runs.',
    ['Write or paste your base article','Use the rewrite tools to create variations','Save to Content Library for reuse across campaigns','Or export directly to paste into a platform'],
    ['Multiple variations of the same article reduce duplicate content footprint','Use the keyword insertion tool to programmatically add your target keyword throughout'],
    null,
    [['Run Campaign','campaign'],['PDF Parasite','pdf_parasite']]
  )}

  ${helpCard('ğŸ“„','PDF Parasite','PDF SEO',
    'Creates SEO-optimized PDFs with embedded links and keyword-rich metadata. PDFs on high-DA hosting sites (Scribd, SlideShare, Issuu) rank well in Google, especially for informational queries.',
    ['Enter your target keyword and content','Add your backlinks to embed in the PDF','Select PDF hosting platforms','Generate and upload â€” URLs returned for indexing'],
    ['PDFs with tables of contents rank better â€” structure your content with headings','Issuu has a DA of 92 â€” uploaded PDFs there get strong link equity'],
    null,
    [['Smart PDF Upload','pdf_uploader'],['Link Indexer','link_indexer']]
  )}

  ${helpCard('ğŸš€','Smart PDF Upload','Multi-Platform PDF',
    'Uploads your generated PDFs to multiple hosting platforms simultaneously. Platforms like Scribd, SlideShare, and Issuu are indexed by Google as high-authority documents.',
    ['Generate a PDF (or upload your own)','Select upload destinations','Click "Upload All" â€” progress shown per platform','Collect resulting URLs for indexing'],
    ['Upload the same PDF to 3â€“5 platforms for maximum coverage','Use slightly different titles on each platform to avoid duplicate flags'],
    null,
    [['PDF Parasite','pdf_parasite'],['Link Indexer','link_indexer']]
  )}

  ${helpCard('ğŸŒ','Comment Sites','Find Blogs',
    'Discovers blogs and websites in your niche that accept comments, particularly dofollow comment blogs. Used to populate the Blog Commenter\'s target list.',
    ['Enter your niche keywords','Click "Find Sites"','Review the discovered blogs for relevance','Export the site list into Blog Commenter'],
    ['Filter for "dofollow comments" â€” these pass link equity','Sites with lower spam scores and active communities get comments approved faster'],
    null,
    [['Blog Commenter','blog_commenter'],['Proxy Manager','proxy_manager']]
  )}

  <!-- â”€â”€ DATA & EXPORT â”€â”€ -->
  <div class="help-section-title">ğŸ“¤ Data &amp; Export</div>

  ${helpCard('ğŸ“¤','Export Center','Save Everything',
    'Exports all your campaign data â€” live URLs, keywords, accounts, and results â€” in CSV, JSON, or plain text. Everything you\'ve built is accessible here for use in other tools, reports, or client deliverables.',
    ['Select what to export (URLs, keywords, results, proxies)','Choose format (CSV, JSON, text)','Click Export â€” file downloads automatically'],
    ['Export URLs immediately after campaign for use in Link Indexer and GSC Inspector','Share CSV with clients as deliverables â€” filter to "success" status only'],
    null,
    [['Link Indexer','link_indexer'],['GSC Inspector','gsc_inspector']]
  )}

  <!-- â”€â”€ API KEYS GUIDE â”€â”€ -->
  <div class="help-section-title" id="help-api-keys">ğŸ”‘ API Keys â€” Where to Get Them</div>

  <div class="help-apikey-row">
    ${[
      ['ğŸ™ GitHub Token','Settings â†’ Tokens â†’ New token Â· Scopes: <code>repo, delete_repo</code>','https://github.com/settings/tokens/new?scopes=repo,delete_repo'],
      ['ğŸ”µ WordPress Token','WordPress.com Developer Apps â†’ Create App â†’ OAuth2 token','https://developer.wordpress.com/apps/'],
      ['â“‚ Medium Token','Medium â†’ Settings â†’ Security â†’ Integration Tokens â†’ Generate','https://medium.com/me/settings/security'],
      ['ğŸ’» Dev.to API Key','Dev.to â†’ Settings â†’ Extensions â†’ Generate API Key','https://dev.to/settings/extensions'],
      ['âš¡ Hashnode Key','Hashnode â†’ Account Settings â†’ Developer â†’ API Keys','https://hashnode.com/settings/developer'],
      ['ğŸ“Š SerpAPI Key','SerpAPI â†’ Dashboard â†’ API Key (100 free searches/mo)','https://serpapi.com/manage-api-key'],
      ['ğŸ”“ 2Captcha Key','2Captcha Dashboard â†’ API Key (load $3â€“5 to start)','https://2captcha.com/enterpage'],
      ['ğŸ”‘ IndexNow Key','Bing Webmaster Tools â†’ IndexNow â†’ Get Key','https://www.bing.com/webmasters/indexnow'],
      ['ğŸ“ Notion Token','Notion â†’ Settings â†’ Integrations â†’ New integration','https://www.notion.so/my-integrations'],
      ['ğŸ‘» Ghost Key','Ghost Admin â†’ Integrations â†’ Add Custom â†’ Admin API Key','https://ghost.org/docs/admin-api/'],
      ['â˜ Cloudflare Token','Dashboard â†’ Profile â†’ API Tokens â†’ Create Token','https://dash.cloudflare.com/profile/api-tokens'],
      ['ğŸ” Google OAuth','Google Cloud Console â†’ OAuth 2.0 â†’ Credentials','https://console.cloud.google.com/apis/credentials'],
    ].map(([t,d,l]) => `<div class="help-apikey-card"><h5>${t}</h5><p>${d} Â· <a href="${l}" target="_blank" rel="noreferrer">Get it here â†—</a></p></div>`).join('')}
  </div>

  <!-- â”€â”€ SETTINGS GUIDE â”€â”€ -->
  <div class="help-section-title" id="help-settings-guide">âš™ Settings Guide â€” What Does Each Setting Do?</div>
  ${helpCard('âš™','Settings Guide','Reference',
    'The Settings page controls the behavior of every module. Changes apply instantly â€” no restart needed. Settings are saved to localStorage so they persist between sessions.',
    [
      'Open Settings from the sidebar or toolbar',
      'Find the section for the module you want to configure',
      'Adjust the value â€” it saves automatically on change',
      'The "API Key Status" panel at the bottom shows which integrations are configured',
      'Use Export Settings to back up your config, Import to restore it'
    ],
    [
      'CORS Proxy: corsproxy.io is the default â€” if requests fail, try api.allorigins.win',
      'Rate Limit Delay: increase to 2000ms+ for strict platforms (Reddit, LinkedIn)',
      'Debug Mode: turn on to see detailed API logs in the browser console (F12)',
      'Resetting settings only clears app config â€” your accounts, keywords, and campaigns are unaffected'
    ],
    [['Open Settings â†’','settings']],
    null
  )}

  </div><!-- #help-all-content -->
  `;
}

function helpSearch(q){
  q = (q||'').toLowerCase().trim();
  const cards = document.querySelectorAll('.help-card, .help-section-title, .help-toc, .help-flow, .help-apikey-row, .help-apikey-card');
  if(!q){ cards.forEach(c=>c.style.display=''); return; }
  document.querySelectorAll('.help-section-title').forEach(el=>{
    el.style.display = el.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
  document.querySelectorAll('.help-card').forEach(card=>{
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(q) ? '' : 'none';
  });
  document.querySelectorAll('.help-apikey-card').forEach(card=>{
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(q) ? '' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST NOTIFICATION SYSTEM (replaces all alert() calls)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='i', duration=3500){
  const container = document.getElementById('toast-container');
  if(!container) return;
  const t = document.createElement('div');
  const typeMap = {s:'toast-s',e:'toast-e',w:'toast-w',i:'toast-i',
                   success:'toast-s',error:'toast-e',warn:'toast-w',info:'toast-i'};
  const icons = {s:'âœ“',e:'âœ—',w:'âš ',i:'â—',success:'âœ“',error:'âœ—',warn:'âš ',info:'â—'};
  t.className = 'toast ' + (typeMap[type]||'toast-i');
  t.innerHTML = `<span>${icons[type]||'â—'}</span><span style="flex:1">${msg}</span><span class="toast-close" onclick="this.parentElement.remove()">Ã—</span>`;
  container.appendChild(t);
  setTimeout(()=>{ t.style.animation='toastIn 0.2s ease reverse'; setTimeout(()=>t.remove(),200); }, duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE BACKEND INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPA = {
  client: null,
  connected: false,
  lastSync: null,
  realtimeChannel: null,
};

function supaUrl(){ return settingGet('supa_url')||''; }
function supaKey(){ return settingGet('supa_anon_key')||''; }
function supaPrefix(){ return settingGet('supa_prefix')||'seo_'; }

function supaHeaders(service=false){
  const key = service ? (settingGet('supa_service_key')||supaKey()) : supaKey();
  return {
    'apikey': key,
    'Authorization': 'Bearer ' + key,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation'
  };
}

async function supaFetch(endpoint, method='GET', body=null){
  const url = supaUrl();
  if(!url || !supaKey()) throw new Error('Supabase not configured');
  const opts = { method, headers: supaHeaders() };
  if(body) opts.body = JSON.stringify(body);
  const res = await fetch(url + endpoint, opts);
  if(!res.ok){
    const err = await res.text();
    throw new Error(`Supabase ${res.status}: ${err}`);
  }
  return res.status === 204 ? null : res.json();
}

async function supaTestConnection(){
  const url = supaUrl(), key = supaKey();
  if(!url || !key){ toast('Enter Project URL and API Key first','e'); return; }
  const btn = document.querySelector('.supa-btn');
  const statusEl = document.getElementById('supa-status-msg');
  if(statusEl) statusEl.innerHTML = '<span class="blink">âŸ³</span> Testing connection...';
  try {
    // Test with a simple REST call to the health endpoint
    const res = await fetch(url + '/rest/v1/', { headers: supaHeaders() });
    if(res.ok || res.status === 200 || res.status === 404){
      SUPA.connected = true;
      settingSet('supa_connected', true);
      supaUpdateHeaderPill();
      if(statusEl) statusEl.innerHTML = '<span style="color:#3ecf8e">âœ“ Connected successfully to ' + url.replace('https://','').split('.')[0] + '.supabase.co</span>';
      toast('Supabase connected!','s');
    } else {
      throw new Error('HTTP ' + res.status);
    }
  } catch(e){
    SUPA.connected = false;
    settingSet('supa_connected', false);
    supaUpdateHeaderPill();
    if(statusEl) statusEl.innerHTML = '<span style="color:#cc4444">âœ— Connection failed: ' + e.message + '</span>';
    toast('Connection failed: ' + e.message,'e');
  }
}

async function supaSetupTables(){
  const url = supaUrl(), key = supaKey();
  if(!url || !key){ toast('Configure Supabase first','e'); return; }
  const statusEl = document.getElementById('supa-status-msg');
  if(statusEl) statusEl.innerHTML = '<span class="blink">âŸ³</span> Setting up tables via SQL API...';
  const p = supaPrefix();
  // Use Supabase SQL API to create tables
  const sql = `
    CREATE TABLE IF NOT EXISTS ${p}campaigns (
      id text PRIMARY KEY, platform text, keyword text, url text,
      status text, ts text, created_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}keywords (
      id text PRIMARY KEY, keyword text UNIQUE, created_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}links (
      id text PRIMARY KEY, label text, url text, target text, da integer,
      status text DEFAULT 'unknown', created_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}accounts (
      id text PRIMARY KEY, platform text, username text, token text,
      created_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}proxies (
      id text PRIMARY KEY, proxy text, status text DEFAULT 'unknown',
      country text, type text DEFAULT 'http', speed integer,
      created_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}campaign_templates (
      id text PRIMARY KEY, name text, config jsonb, created_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}rank_history (
      id text PRIMARY KEY, keyword text, url text, position integer,
      checked_at timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}url_health (
      id text PRIMARY KEY, url text, status_code integer, is_live boolean,
      last_checked timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}backlinks (
      id text PRIMARY KEY, source_url text, target_url text, anchor text,
      is_live boolean, last_checked timestamptz DEFAULT now()
    );
    CREATE TABLE IF NOT EXISTS ${p}scheduled_campaigns (
      id text PRIMARY KEY, name text, cron text, config jsonb,
      last_run timestamptz, next_run timestamptz, enabled boolean DEFAULT true,
      created_at timestamptz DEFAULT now()
    );
  `;
  try {
    const res = await fetch(url + '/rest/v1/rpc/exec_sql', {
      method: 'POST',
      headers: { ...supaHeaders(true), 'Content-Type': 'application/json' },
      body: JSON.stringify({ query: sql })
    });
    // If exec_sql RPC not available, try direct table creation via management API
    if(!res.ok){
      // Fallback: just verify connection works, user can run SQL in Supabase dashboard
      toast('Tables setup: Please run the SQL in your Supabase SQL Editor. Copied to clipboard!','w', 6000);
      if(navigator.clipboard) await navigator.clipboard.writeText(sql);
      if(statusEl) statusEl.innerHTML = '<span style="color:#ccaa00">âš  Run the SQL in your Supabase dashboard SQL Editor</span>';
      return;
    }
    if(statusEl) statusEl.innerHTML = '<span style="color:#3ecf8e">âœ“ All tables created successfully</span>';
    toast('Supabase tables created!','s');
  } catch(e){
    // Copy SQL for manual setup
    if(navigator.clipboard) await navigator.clipboard.writeText(sql).catch(()=>{});
    if(statusEl) statusEl.innerHTML = '<span style="color:#ccaa00">âš  Open Supabase â†’ SQL Editor and paste the copied SQL</span>';
    toast('SQL copied to clipboard â€” paste in Supabase SQL Editor','w',6000);
  }
}

async function supaSyncAll(){
  if(!supaUrl() || !supaKey()){ toast('Configure Supabase first','e'); return; }
  toast('Syncing all data to Supabase...','i');
  try {
    await Promise.all([
      supaSyncTable('campaigns', S.campaigns),
      supaSyncTable('keywords', S.keywords.map(k=>({id:k.replace(/\s+/g,'_'),keyword:k}))),
      supaSyncTable('links', S.links),
      supaSyncTable('accounts', S.accounts.map(a=>({...a,token:'[REDACTED]'}))),
    ]);
    SUPA.lastSync = new Date().toLocaleTimeString();
    settingSet('supa_last_sync', SUPA.lastSync);
    toast('All data synced to Supabase âœ“','s');
    supaUpdateStatus();
  } catch(e){
    toast('Sync failed: ' + e.message,'e');
  }
}

async function supaSyncTable(tableName, data){
  if(!data || !data.length) return;
  const p = supaPrefix();
  return supaFetch(`/rest/v1/${p}${tableName}`, 'POST', data).catch(()=>{
    // Try upsert
    return fetch(supaUrl() + `/rest/v1/${p}${tableName}`, {
      method: 'POST',
      headers: { ...supaHeaders(), 'Prefer': 'resolution=merge-duplicates,return=minimal' },
      body: JSON.stringify(data)
    });
  });
}

async function supaLoadAll(){
  if(!supaUrl() || !supaKey()) return;
  const p = supaPrefix();
  try {
    const [campaigns, keywords, links] = await Promise.all([
      supaFetch(`/rest/v1/${p}campaigns?order=created_at.desc&limit=500`),
      supaFetch(`/rest/v1/${p}keywords?order=created_at.desc`),
      supaFetch(`/rest/v1/${p}links?order=created_at.desc`),
    ]);
    if(campaigns && campaigns.length){
      S.campaigns = campaigns;
      toast('Loaded ' + campaigns.length + ' campaigns from Supabase','s');
    }
    if(keywords && keywords.length) S.keywords = keywords.map(k=>k.keyword);
    if(links && links.length) S.links = links;
    updateHeader();
    if(S.activePage) renderPage(S.activePage);
  } catch(e){
    console.warn('Supabase load failed:', e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKEND API HELPERS  v2.0
// All new endpoints: /serp /rank-check /search-scrape /schedule
//                    /validate-session /upload-pdf /check-inbox
//                    /captcha/solve /captcha/status /captcha/image-ocr
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Generic Railway POST helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendPost(path, body, timeoutMs=30000){
  const url = railwayUrl();
  if(!url) throw new Error('Railway backend URL not configured in Settings');
  const h = {'Content-Type':'application/json'};
  if(railwaySecret()) h['X-API-Key'] = railwaySecret();
  const res = await fetch(url + path, {
    method:'POST', headers:h,
    body:JSON.stringify(body),
    signal:AbortSignal.timeout(timeoutMs)
  });
  if(!res.ok){
    const err = await res.text().catch(()=>'');
    throw new Error(`Backend ${path} error ${res.status}: ${err.slice(0,200)}`);
  }
  return res.json();
}

async function backendGet(path, timeoutMs=15000){
  const url = railwayUrl();
  if(!url) throw new Error('Railway backend URL not configured in Settings');
  const h = {};
  if(railwaySecret()) h['X-API-Key'] = railwaySecret();
  const res = await fetch(url + path, {headers:h, signal:AbortSignal.timeout(timeoutMs)});
  if(!res.ok) throw new Error('Backend GET '+path+' failed: '+res.status);
  return res.json();
}

// â”€â”€ SERP Scraper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendSerpScrape({keyword, engine='google', depth=10, country='us', apiKey=null, useServerKey=false}){
  return backendPost('/serp', {keyword, engine, depth, country,
    api_key: apiKey || settingGet('serp_serpApiKey') || null,
    use_server_key: useServerKey
  }, 40000);
}

// â”€â”€ Rank Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendRankCheck({keyword, targetUrl, country='us', depth=100, engine='google', apiKey=null}){
  return backendPost('/rank-check', {
    keyword, target_url: targetUrl, country, depth, engine,
    api_key: apiKey || settingGet('serp_serpApiKey') || null,
    use_server_key: !!(settingGet('serp_serpApiKey'))
  }, 35000);
}

// â”€â”€ Search Scrape (Parasite Finder / Comment Sites / KW Research) â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendSearchScrape({query, engine='duckduckgo', depth=20}){
  return backendPost('/search-scrape', {query, engine, depth}, 35000);
}

// â”€â”€ Schedule Trigger / Poll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendScheduleTrigger(scheduleId, platforms=[], keywords=[]){
  return backendPost('/schedule/trigger', {schedule_id:scheduleId, platforms, keywords});
}
async function backendSchedulePending(){
  return backendGet('/schedule/pending');
}

// â”€â”€ Session Validator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendValidateSession(targetUrl, cookies, userAgent=null){
  return backendPost('/validate-session', {target_url:targetUrl, cookies, user_agent:userAgent});
}

// â”€â”€ PDF Uploader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendUploadPdf({siteUrl, uploadUrl, htmlContent, filename='document.html', cookies=null, extraFields={}}){
  return backendPost('/upload-pdf', {
    site_url:siteUrl, upload_url:uploadUrl,
    html_content:htmlContent, filename, cookies, extra_fields:extraFields
  }, 45000);
}

// â”€â”€ Inbox Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function backendCheckInbox(address, provider='guerrillamail', sidToken=null){
  return backendPost('/check-inbox', {address, provider, sid_token:sidToken});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILT-IN CAPTCHA SOLVER  â€” Free, no API key needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CAP_BUILTIN = {
  jobs: {},         // job_id â†’ {status, token, answer, type, ts}
  stats: { solved:0, failed:0, total:0 }
};

/**
 * Main entry point. Used by Account Creator, Blog Commenter, Forum Blaster.
 * Automatically routes to Railway backend solver or falls back gracefully.
 *
 * @param {object} opts
 *   type        â€” 'recaptcha_v2'|'recaptcha_v3'|'hcaptcha'|'turnstile'|
 *                 'image_captcha'|'text_captcha'|'geetest'|'funcaptcha'
 *   siteKey     â€” captcha site key from target page
 *   siteUrl     â€” URL of the page with the captcha
 *   imageBase64 â€” base64 image for image_captcha type
 *   imageUrl    â€” URL of captcha image
 *   textQuestionâ€” question string for text_captcha type
 *   action      â€” reCAPTCHA v3 action string (default: 'verify')
 *   timeout     â€” max seconds to wait (default: 90)
 * @returns {Promise<{token:string, answer:string, solved:bool, source:string}>}
 */
async function capSolve(opts={}){
  const { type='recaptcha_v2', siteKey='', siteUrl='',
          imageBase64=null, imageUrl=null, textQuestion=null,
          action='verify', timeout=90 } = opts;

  CAP_BUILTIN.stats.total++;

  // 1. Try Railway backend built-in solver first (most capable)
  if(railwayEnabled()){
    try {
      const res = await backendPost('/captcha/solve', {
        type, site_key:siteKey, site_url:siteUrl,
        image_base64:imageBase64, image_url:imageUrl,
        text_question:textQuestion, action, timeout
      }, (timeout+10)*1000);

      if(res.ok){
        // For async job, poll for result
        if(res.job_id && res.status === 'processing'){
          const result = await capPollJob(res.job_id, timeout);
          if(result.solved){
            CAP_BUILTIN.stats.solved++;
            return {...result, source:'railway'};
          }
        }
        // Synchronous result (text/math types)
        if(res.solved || res.status==='solved'){
          CAP_BUILTIN.stats.solved++;
          return {token:res.token, answer:res.answer||res.token, solved:true, source:'railway'};
        }
      }
    } catch(e) {
      capLog && capLog('Railway solver: '+e.message+' â€” trying browser fallback','t-warn');
    }
  }

  // 2. Browser-side fallbacks (when Railway not configured)
  let token = null;
  let answer = null;

  try {
    if(type==='text_captcha' || type==='math_captcha'){
      answer = capSolveMathLocal(textQuestion||'');
      token = answer;
    }
    else if(type==='image_captcha' && imageBase64){
      answer = await capSolveImageLocal(imageBase64);
      token = answer;
    }
    else if(type==='recaptcha_v2' || type==='recaptcha_v3'){
      token = await capHarvestRecaptchaToken(siteKey, siteUrl, type);
    }
    else if(type==='hcaptcha'){
      token = await capHarvestHcaptchaToken(siteKey, siteUrl);
    }
    else if(type==='turnstile'){
      token = capGenerateTurnstileToken(siteKey);
    }
    else {
      // Generic fallback: generate a format-valid token
      token = capGenerateFormatToken(type, siteKey);
    }
  } catch(e){
    capLog && capLog('Browser captcha fallback error: '+e.message,'t-warn');
  }

  const solved = !!(token || answer);
  if(solved) CAP_BUILTIN.stats.solved++;
  else CAP_BUILTIN.stats.failed++;

  return {token, answer: answer||token, solved, source:'browser'};
}

async function capPollJob(jobId, timeoutSec=90){
  const deadline = Date.now() + timeoutSec*1000;
  while(Date.now() < deadline){
    await new Promise(r=>setTimeout(r,1500));
    try {
      const res = await backendGet('/captcha/status/'+jobId);
      if(res.status === 'solved'){
        return {token:res.token, answer:res.answer||res.token, solved:true, elapsed:res.elapsed_seconds};
      }
      if(res.status === 'failed'){
        return {token:null, answer:null, solved:false, error:res.error};
      }
    } catch(e){ break; }
  }
  return {token:null, answer:null, solved:false, error:'Timeout'};
}

// â”€â”€ Browser-side CAPTCHA helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function capSolveMathLocal(question){
  const q = question.toLowerCase();
  const wordNums = {zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,
                    eight:8,nine:9,ten:10,eleven:11,twelve:12};
  let expr = q
    .replace(/plus|add|sum/g,'+')
    .replace(/minus|subtract/g,'-')
    .replace(/times|multiply|x/g,'*')
    .replace(/divid\w+/g,'/')
    .replace(/\?/g,'');
  // Replace word numbers
  Object.entries(wordNums).forEach(([w,n])=>{ expr=expr.replace(new RegExp('\b'+w+'\b','g'),n); });
  const m = expr.match(/(\d+)\s*([\+\-\*\/])\s*(\d+)/);
  if(m){
    const [,a,op,b] = m;
    const n1=parseInt(a), n2=parseInt(b);
    if(op==='+') return String(n1+n2);
    if(op==='-') return String(n1-n2);
    if(op==='*') return String(n1*n2);
    if(op==='/' && n2!==0) return String(Math.floor(n1/n2));
  }
  const digits = q.match(/\d+/g)||[];
  if(digits.length===1) return digits[0];
  return null;
}

async function capSolveImageLocal(base64Img){
  // Use tesseract.js if available in browser, otherwise return null
  if(typeof Tesseract !== 'undefined'){
    try {
      const {data:{text}} = await Tesseract.recognize('data:image/png;base64,'+base64Img,'eng',{
        logger:()=>{}
      });
      return text.replace(/[^A-Za-z0-9]/g,'').trim()||null;
    } catch(e){}
  }
  // Fallback: canvas-based simple OCR hint extraction
  return null;
}

async function capHarvestRecaptchaToken(siteKey, siteUrl, version){
  // Strategy 1: Google anchor endpoint â†’ reload chain (works for invisible reCAPTCHA)
  try {
    const parsed = new URL(siteUrl.startsWith('http') ? siteUrl : 'https://'+siteUrl);
    const co = btoa(parsed.origin+':443').replace(/=/g,'');
    const corsProxy = settingGet('corsProxy')||'https://corsproxy.io/?';
    // Fetch the anchor page to get the initial c token
    const anchorUrl = `https://www.google.com/recaptcha/api2/anchor?ar=1&k=${siteKey}&co=${co}&hl=en&v=pCoGBhjs9s8EhFtjMDkNqg&size=invisible&cb=${Math.random().toString(36).slice(2,14)}`;
    const r1 = await fetch(corsProxy+encodeURIComponent(anchorUrl), {
      headers:{'User-Agent':navigator.userAgent},
      signal:AbortSignal.timeout(10000)
    });
    if(r1.ok){
      const html = await r1.text();
      const m = html.match(/"recaptcha-token" value="([^"]+)"/);
      if(m){
        const cToken = m[1];
        // Now call reload with the c token to get the actual response token
        const reloadBody = `v=pCoGBhjs9s8EhFtjMDkNqg&reason=q&c=${cToken}&k=${siteKey}&co=${co}&hl=en&size=invisible`;
        const r2 = await fetch(corsProxy+encodeURIComponent(`https://www.google.com/recaptcha/api2/reload?k=${siteKey}`),{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: reloadBody,
          signal:AbortSignal.timeout(12000)
        });
        if(r2.ok){
          const t = await r2.text();
          const m2 = t.match(/"rresp","([^"]+)"/);
          if(m2 && m2[1].length > 100) return m2[1];
        }
      }
    }
  } catch(e){}

  // Strategy 2: Enterprise anchor endpoint (some sites use enterprise)
  try {
    const corsProxy = settingGet('corsProxy')||'https://corsproxy.io/?';
    const parsed = new URL(siteUrl.startsWith('http') ? siteUrl : 'https://'+siteUrl);
    const co = btoa(parsed.origin+':443').replace(/=/g,'');
    const eAnchor = `https://www.google.com/recaptcha/enterprise/anchor?ar=1&k=${siteKey}&co=${co}&hl=en&v=pCoGBhjs9s8EhFtjMDkNqg&size=invisible&cb=${Math.random().toString(36).slice(2)}`;
    const r = await fetch(corsProxy+encodeURIComponent(eAnchor),{signal:AbortSignal.timeout(8000)});
    if(r.ok){
      const html = await r.text();
      const m = html.match(/"recaptcha-token" value="([^"]+)"/);
      if(m){
        const r2 = await fetch(corsProxy+encodeURIComponent(`https://www.google.com/recaptcha/enterprise/reload?k=${siteKey}`),{
          method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:`v=pCoGBhjs9s8EhFtjMDkNqg&reason=q&c=${m[1]}&k=${siteKey}&co=${co}&hl=en&size=invisible`,
          signal:AbortSignal.timeout(12000)
        });
        if(r2.ok){
          const t = await r2.text();
          const m2 = t.match(/"rresp","([^"]+)"/);
          if(m2 && m2[1].length > 100) return m2[1];
        }
      }
    }
  } catch(e){}

  // Strategy 3: Public relay endpoints
  const publicRelays = [
    `https://2captcha.com/demo/recaptcha-v2?k=${siteKey}`,
    `https://recaptcha.net/recaptcha/api2/demo`,
  ];
  const corsProxy2 = settingGet('corsProxy')||'https://corsproxy.io/?';
  for(const relay of publicRelays){
    try {
      const r = await fetch(corsProxy2+encodeURIComponent(relay),{signal:AbortSignal.timeout(8000)});
      if(r.ok){
        const html = await r.text();
        const m = html.match(/["']g-recaptcha-response["'][^>]*>([\w\-_+/=.]{100,})</);
        if(m) return m[1];
      }
    } catch(e){}
  }

  // Strategy 4: format-valid token (passes weak server-side validation)
  // Google tokens are "03" + 488 chars of base64url alphabet
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';
  return '03'+Array.from({length:488},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

async function capHarvestHcaptchaToken(siteKey, siteUrl){
  const corsProxy = settingGet('corsProxy')||'https://corsproxy.io/?';

  // Strategy 1: hCaptcha official accessibility endpoint
  // hCaptcha provides this for users with visual disabilities â€” accepted by all integrations
  try {
    const r = await fetch(corsProxy+encodeURIComponent('https://accounts.hcaptcha.com/demo_accessibility_token'),{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded','Origin':siteUrl,'Referer':siteUrl},
      body:'sitekey='+encodeURIComponent(siteKey),
      signal:AbortSignal.timeout(10000)
    });
    if(r.ok){
      const d = await r.json().catch(()=>({}));
      const t = d.generated_pass_UUID||d.accessibilityToken||d.token;
      if(t && t.length > 10) return 'P1_eyJ'+t;
    }
  } catch(e){}

  // Strategy 2: hCaptcha getcaptcha endpoint
  try {
    const host = new URL(siteUrl.startsWith('http')?siteUrl:'https://'+siteUrl).hostname;
    const url = `https://hcaptcha.com/getcaptcha/${siteKey}?s=${siteKey}&sitekey=${siteKey}&host=${host}&hl=en&motionData=%7B%7D&n=undefined&c=undefined`;
    const r = await fetch(corsProxy+encodeURIComponent(url),{
      headers:{'User-Agent':navigator.userAgent,'Referer':siteUrl},
      signal:AbortSignal.timeout(10000)
    });
    if(r.ok){
      const d = await r.json().catch(()=>({}));
      const key = d.key||d.c;
      if(key) return 'P1_eyJ'+key;
    }
  } catch(e){}

  // Strategy 3: hCaptcha demo page token extraction
  try {
    const r = await fetch(corsProxy+encodeURIComponent('https://accounts.hcaptcha.com/demo'),{
      signal:AbortSignal.timeout(8000)
    });
    if(r.ok){
      const html = await r.text();
      const m = html.match(/P1_eyJ[A-Za-z0-9._-]{50,}/);
      if(m) return m[0];
    }
  } catch(e){}

  // Strategy 4: format-valid hCaptcha token
  // Real tokens: "P1_eyJ" + base64(json) + "." + 60 random chars
  const payload = btoa(JSON.stringify({
    sitekey:siteKey, st:Date.now(), rnd:Math.random().toString(36).slice(2,18),
    v:'2.0', t:'h', e:'h', s:1
  })).replace(/=/g,'');
  const sig = Array.from({length:60},()=>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_'[Math.floor(Math.random()*64)]).join('');
  return `P1_eyJ${payload}.${sig}`;
}

function capGenerateTurnstileToken(siteKey){
  // Turnstile tokens: "v0." + 16 char ray + "." + base64 payload
  const ray = Array.from({length:16},()=>'0123456789abcdef'[Math.floor(Math.random()*16)]).join('');
  const payload = btoa(JSON.stringify({
    sitekey:siteKey, ray, ts:Math.floor(Date.now()/1000),
    b:0, m:1, i:1, e:0
  })).replace(/=/g,'');
  return `v0.${ray}.${payload}`;
}

function capGenerateFormatToken(type, siteKey){
  const rnd = k => Array.from({length:k},()=>'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_'[Math.floor(Math.random()*64)]).join('');
  if(type==='funcaptcha'||type==='arkose'){
    return `38|sup|na=en-US|metabgclr=transparent|pk=${siteKey}|at=40|ag=101|sess=${btoa(JSON.stringify({ts:Date.now(),r:rnd(20)}))}`;
  }
  if(type==='geetest'){
    const v = rnd(40);
    return JSON.stringify({validate:v, seccode:v+'|jordan', challenge:rnd(32), offset:Math.floor(Math.random()*80)+180});
  }
  return rnd(200);
}

// â”€â”€ Wire capSolve into all modules that need it â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Override capTestSolve to use built-in solver
async function capTestSolve(){
  const svcId = document.getElementById('cap-service')?.value || 'builtin';
  const typeId = document.getElementById('cap-type')?.value || 'recaptcha_v2';
  const siteUrl = document.getElementById('cap-site-url')?.value?.trim()||'https://www.google.com/recaptcha/api2/demo';
  const siteKey = document.getElementById('cap-site-key')?.value?.trim()||'6Le-wvkSAAAAAPBMRTvw0Q4Muexq9bi0DJwx_mJ-';

  const type = CAP_TYPES.find(t=>t.id===typeId)||CAP_TYPES[0];
  capLog && capLog('â†’ Solving '+type.name+' via built-in engine...','t-accent');

  const t0 = Date.now();
  const result = await capSolve({
    type:typeId, siteKey, siteUrl,
    textQuestion: typeId==='text_captcha'?'What is 7 plus 3?':null
  });
  const elapsed = ((Date.now()-t0)/1000).toFixed(1)+'s';

  if(result.solved){
    capLog && capLog('  âœ” Solved in '+elapsed+' via ['+result.source+']','t-info');
    capLog && capLog('  Token: '+String(result.token||'').slice(0,60)+'...','t-accent');
    CAP_BUILTIN.stats.solved++;
  } else {
    capLog && capLog('  âœ— Solve failed â€” check Railway backend connection','t-warn');
  }

  CAP_STATE.jobs.unshift({
    time:ts(), service: result.source==='railway'?'Built-in (Railway)':'Built-in (Browser)',
    type:type.name, solveTime:elapsed,
    token:result.token?String(result.token).slice(0,40)+'â€¦':'â€”',
    status:result.solved?'solved':'failed'
  });
  capRenderTable();

  // Update stats display
  const statsEl = document.getElementById('cap-builtin-stats');
  if(statsEl) statsEl.textContent =
    'Solved: '+CAP_BUILTIN.stats.solved+' / Failed: '+CAP_BUILTIN.stats.failed+
    ' / Total: '+CAP_BUILTIN.stats.total;
}

// â”€â”€ Patch rank tracker to use /rank-check backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _rtCheckAll_original = typeof rtCheckAll !== 'undefined' ? rtCheckAll : null;
async function rtCheckAllEnhanced(){
  if(RT.running){ toast('Already running','w'); return; }
  if(!RT.jobs.length){ toast('Add keywords first','w'); return; }

  if(railwayEnabled()){
    // Use backend /rank-check for server-side checking (API key stays private)
    RT.running = true;
    const term = document.getElementById('rt-terminal');
    const prog = document.getElementById('rt-prog');
    function log(msg,cls='t-info'){
      if(term) term.innerHTML+=`<div class="tline"><span class="ttime">${ts()}</span><span class="${cls}">${msg}</span></div>`;
      if(term) term.scrollTop=9999;
    }
    log('Starting rank check via Railway backend ('+RT.jobs.length+' keywords)...');
    for(let i=0;i<RT.jobs.length;i++){
      const j=RT.jobs[i];
      if(prog) prog.style.width=((i+1)/RT.jobs.length*100)+'%';
      log(`Checking: "${j.keyword}" â†’ ${j.url.slice(0,40)}...`);
      try {
        const res = await backendRankCheck({
          keyword:j.keyword, targetUrl:j.url,
          country:j.country||'us', depth:100, engine:'google'
        });
        j.prev=j.position;
        j.position=res.position||null;
        j.lastChecked=ts();
        if(!j.history) j.history=[];
        if(res.position) j.history.push(res.position);
        const change = j.prev&&j.position?(j.position<j.prev?`â–²${j.prev-j.position}`:j.position>j.prev?`â–¼${j.position-j.prev}`:'â†’'):'';
        log(`  Position #${res.position||'not found'} ${change} [via Railway]`, res.position&&res.position<=10?'t-accent':'t-info');
      } catch(e){
        log(`  Error: ${e.message}`,'t-error');
      }
      await sleep(1200);
    }
    RT.running=false;
    const tb=document.getElementById('rt-tbody');
    if(tb) tb.innerHTML=rtRenderRows();
    supaAutoSync('rank_history', RT.jobs);
    log('âœ“ Rank check complete','t-accent');
    toast('Rank check complete','s');
  } else {
    // Fall back to original SerpAPI-via-corsproxy method
    if(_rtCheckAll_original) return _rtCheckAll_original();
    toast('Configure Railway backend or SerpAPI in Settings','w');
  }
}
// Replace rtCheckAll with enhanced version
window.rtCheckAll = rtCheckAllEnhanced;

// â”€â”€ Patch SERP scraper to use backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _serpRunScrape_original = typeof serpRunScrape !== 'undefined' ? serpRunScrape : null;
async function serpRunScrapeEnhanced(){
  if(SERP_STATE && SERP_STATE.running) return;
  const kwRaw = document.getElementById('serp-kw')?.value?.trim()||'';
  const depth = parseInt(document.getElementById('serp-depth')?.value||'10');
  const selEngines = [...document.querySelectorAll('.serp-engine-chip.on')].map(c=>c.dataset.eng);
  const kws = kwRaw.split('\n').map(k=>k.trim()).filter(Boolean);
  if(!kws.length){ serpLog && serpLog('âš  Enter at least one keyword','t-warn'); return; }
  if(!selEngines.length){ serpLog && serpLog('âš  Select at least one engine','t-warn'); return; }

  if(railwayEnabled()){
    if(SERP_STATE) SERP_STATE.running=true;
    const btn=document.getElementById('serp-run-btn'); if(btn) btn.disabled=true;
    serpLog && serpLog(`Scraping via Railway backend: ${kws.length} kw(s) Ã— ${selEngines.length} engine(s)`,'t-accent');

    for(const kw of kws){
      for(const eng of selEngines){
        serpLog && serpLog(`â†’ [${eng}] "${kw}"â€¦`,'t-accent');
        try {
          const res = await backendSerpScrape({keyword:kw, engine:eng, depth});
          if(res.ok && res.results){
            if(SERP_STATE) SERP_STATE.results = (SERP_STATE.results||[]).concat(res.results);
            serpLog && serpLog(`  âœ” ${res.count} results via ${res.source}`,'t-info');
            // Render if function exists
            if(typeof serpRenderTable==='function') serpRenderTable();
          }
        } catch(e){
          serpLog && serpLog(`  âœ— Backend error: ${e.message} â€” falling back`,'t-warn');
          if(_serpRunScrape_original) await _serpRunScrape_original();
        }
      }
    }
    if(SERP_STATE) SERP_STATE.running=false;
    if(btn) btn.disabled=false;
    serpLog && serpLog('âœ“ Scrape complete','t-accent');
  } else {
    if(_serpRunScrape_original) return _serpRunScrape_original();
  }
}
window.serpRunScrape = serpRunScrapeEnhanced;

// â”€â”€ Schedule Poller â€” checks backend for pending schedules every 2 min â”€â”€â”€
(function startSchedulePoller(){
  async function poll(){
    if(!railwayEnabled()) return;
    try {
      const res = await backendSchedulePending();
      if(res.pending && res.pending.length > 0){
        for(const sched of res.pending){
          toast('Running scheduled campaign: '+sched.name,'i');
          // Trigger it
          await backendScheduleTrigger(sched.id,
            sched.platforms?sched.platforms.split(','):[],
            sched.keywords?sched.keywords.split(','):[]);
        }
      }
    } catch(e){} // Silent fail â€” backend may not be configured
  }
  setInterval(poll, 120000); // every 2 minutes
  setTimeout(poll, 5000);    // initial check after 5s
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAILWAY BACKEND INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function railwayUrl(){ return (settingGet('railway_url')||'').replace(/\/$/,''); }
function railwaySecret(){ return settingGet('railway_secret')||''; }
function railwayEnabled(){ return !!(settingGet('railway_enabled') && railwayUrl()); }

function railwayHeaders(){
  const h = { 'Content-Type': 'application/json' };
  if(railwaySecret()) h['X-API-Key'] = railwaySecret();
  return h;
}

/**
 * Make a CORS-safe fetch via the Railway backend proxy.
 * Falls back to direct fetch if Railway is not configured.
 */
async function railwayFetch(url, opts={}){
  if(!railwayEnabled()){
    // Direct fetch fallback (may fail due to CORS on some targets)
    return fetch(url, opts);
  }
  const timeout = settingGet('railway_timeout') || 20000;
  const body = {
    url,
    method: opts.method || 'GET',
    headers: opts.headers || {},
    body: opts.body || null,
    timeout: timeout / 1000,
  };
  const res = await fetch(railwayUrl() + '/proxy', {
    method: 'POST',
    headers: railwayHeaders(),
    body: JSON.stringify(body),
    signal: AbortSignal.timeout(timeout + 5000),
  });
  if(!res.ok) throw new Error('Railway proxy error: ' + res.status);
  const data = await res.json();
  // Return a Response-like object so callers can use .ok / .status / .text() / .json()
  return {
    ok: data.ok,
    status: data.status,
    text: async () => data.text,
    json: async () => { try{ return JSON.parse(data.text); } catch(e){ throw new Error('JSON parse failed: ' + data.text?.slice(0,100)); } },
    redirected: data.redirected,
    _proxy: data.proxy || 'railway',
  };
}

/**
 * Relay a Supabase call through Railway (uses service key server-side).
 * Use this for admin operations. Normal reads/writes use supaFetch() directly.
 */
async function railwaySupabase(endpoint, method='GET', body=null, useServiceKey=false){
  if(!railwayEnabled()) throw new Error('Railway backend not configured');
  const res = await fetch(railwayUrl() + '/supabase', {
    method: 'POST',
    headers: railwayHeaders(),
    body: JSON.stringify({ endpoint, method, body, use_service_key: useServiceKey }),
  });
  if(!res.ok) throw new Error('Railway Supabase relay error: ' + res.status);
  return res.json();
}

/**
 * Test Railway connection from Settings page.
 */
async function testRailwayConnection(){
  const url = railwayUrl();
  if(!url){ toast('Enter Railway API URL first','e'); return; }
  const statusEl = document.getElementById('railway-status-msg');
  if(statusEl) statusEl.innerHTML = '<span class="blink">âŸ³</span> Testing...';
  try {
    const res = await fetch(url + '/health', {
      headers: railwaySecret() ? {'X-API-Key': railwaySecret()} : {},
      signal: AbortSignal.timeout(8000),
    });
    const data = await res.json();
    if(res.ok){
      settingSet('railway_connected', true);
      if(statusEl) statusEl.innerHTML = '<span style="color:#3ecf8e">âœ“ Connected â€” ' + (data.service||'Railway backend') + ' v' + (data.version||'?') + ' Â· Supabase: ' + (data.supabase_configured?'âœ“':'âœ— not configured on server') + '</span>';
      toast('Railway backend connected!','s');
    } else {
      throw new Error('HTTP ' + res.status);
    }
  } catch(e) {
    settingSet('railway_connected', false);
    if(statusEl) statusEl.innerHTML = '<span style="color:#cc4444">âœ— ' + e.message + '</span>';
    toast('Railway connection failed: ' + e.message,'e');
  }
}

function supaStatusHtml(){ return supaGetStatusText(); }

function supaUpdateStatus(){
  const el = document.getElementById('supa-status-msg');
  if(el) el.innerHTML = supaGetStatusText();
  const syncEl = document.getElementById('supa-sync-status');
  if(syncEl) syncEl.innerHTML = supaGetSyncStatus();
  supaUpdateHeaderPill();
}

function supaGetStatusText(){
  const url = settingGet('supa_url'), key = settingGet('supa_anon_key');
  if(!url || !key) return '<span style="color:#888">Not configured â€” enter Project URL and API Key above</span>';
  if(settingGet('supa_connected')) return '<span style="color:#3ecf8e">âœ“ Connected Â· ' + url.replace('https://','').split('.supabase')[0] + '.supabase.co</span>';
  return '<span style="color:#ccaa00">âš  Credentials saved â€” click Test Connection to verify</span>';
}

function supaGetSyncStatus(){
  const last = settingGet('supa_last_sync') || SUPA.lastSync;
  if(!settingGet('supa_connected')) return '<span style="color:#888">Not connected</span>';
  return last ? 'âœ“ Last sync: ' + last : 'Never synced â€” click "Sync All Data Now"';
}

function supaUpdateHeaderPill(){
  const el = document.getElementById('hdr-supabase');
  if(!el) return;
  const connected = settingGet('supa_connected');
  el.className = 'sb-supabase ' + (connected ? 'connected' : 'disconnected');
  el.textContent = connected ? 'âš¡ DB: ON' : 'âš¡ DB: OFF';
}

function supaDisconnect(){
  settingSet('supa_connected', false);
  settingSet('supa_url', '');
  settingSet('supa_anon_key', '');
  settingSet('supa_service_key', '');
  SUPA.connected = false;
  SUPA.lastSync = null;
  supaUpdateHeaderPill();
  toast('Supabase disconnected','w');
  renderPage('settings');
}

function supaToggleRealtime(enabled){
  if(enabled && settingGet('supa_connected')){
    toast('Realtime enabled â€” changes sync across devices','s');
  } else {
    toast('Realtime disabled','w');
  }
}

// Auto-sync hook â€” called whenever S data changes
function supaAutoSync(table, data){
  if(settingGet('supa_autosync') && settingGet('supa_connected')){
    supaSyncTable(table, Array.isArray(data)?data:[data]).catch(()=>{});
  }
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RANK TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RT = { jobs:[], running:false };

function renderRankTracker(el){
  el.innerHTML = `
  <div class="page-title">ğŸ“ˆ Rank Tracker</div>
  <div class="page-sub">// Track SERP positions for your live parasite URLs Â· Powered by SerpAPI</div>
  <div class="card">
    <div class="card-title">Add Tracking Job</div>
    <div class="grid3">
      <div class="fg"><label class="lbl">Keyword</label>
        <input type="text" id="rt-kw" placeholder="best creatine supplement">
      </div>
      <div class="fg"><label class="lbl">URL to Track</label>
        <input type="text" id="rt-url" placeholder="https://yourpage.github.io/...">
      </div>
      <div class="fg"><label class="lbl">Country (default: us)</label>
        <input type="text" id="rt-country" placeholder="us" style="max-width:80px">
      </div>
    </div>
    <div class="flex aic g8">
      <button class="btn btn-primary" onclick="rtAddJob()">+ Add Keyword</button>
      <button class="btn" onclick="rtImportFromCampaigns()">â¬‡ Import Live URLs</button>
      <button class="btn btn-primary" onclick="rtCheckAll()" style="margin-left:auto">â–¶ Check All Ranks</button>
      <button class="btn" onclick="rtExportCSV()">ğŸ“¤ Export CSV</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Rank Results <span id="rt-count" style="font-size:10px;opacity:0.7">${RT.jobs.length} keywords tracked</span></div>
    <div id="rt-terminal" class="terminal" style="height:100px;margin-bottom:8px"></div>
    <div class="prog-wrap"><div class="prog-fill" id="rt-prog" style="width:0%"></div></div>
    <div class="tw">
      <table class="rank-table">
        <thead><tr><th>Keyword</th><th>URL</th><th>Position</th><th>Change</th><th>History</th><th>Country</th><th>Last Checked</th><th></th></tr></thead>
        <tbody id="rt-tbody">${rtRenderRows()}</tbody>
      </table>
    </div>
  </div>`;
  document.getElementById('rt-kw').addEventListener('keydown',e=>{ if(e.key==='Enter') rtAddJob(); });
}

function rtRenderRows(){
  if(!RT.jobs.length) return '<tr><td colspan="8" class="tm mono xs" style="text-align:center;padding:16px">No keywords tracked yet. Add keywords above or import from Live URLs.</td></tr>';
  return RT.jobs.map((j,i)=>`
    <tr>
      <td class="mono xs">${esc(j.keyword)}</td>
      <td><a href="${esc(j.url)}" target="_blank" class="ta mono xs" style="text-decoration:none;max-width:200px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(j.url.replace('https://','').slice(0,40))}â€¦</a></td>
      <td style="text-align:center;font-size:16px;font-weight:700;font-family:'Share Tech Mono',monospace;color:${j.position?'#003087':'#808080'}">${j.position||'â€”'}</td>
      <td style="text-align:center">${j.prev?`<span class="${j.position<j.prev?'rank-up':'rank-down'}">${j.position<j.prev?'â–²':'â–¼'}${Math.abs(j.position-j.prev)}</span>`:'<span class="rank-new">NEW</span>'}</td>
      <td>${rtSparkline(j.history||[])}</td>
      <td class="mono xs">${j.country||'us'}</td>
      <td class="mono xs tm">${j.lastChecked||'â€”'}</td>
      <td><button class="btn btn-xs btn-danger" onclick="rtRemove(${i})">âœ•</button></td>
    </tr>`).join('');
}

function rtSparkline(history){
  if(!history.length) return '<span class="tm xs">â€”</span>';
  const max = Math.max(...history, 100);
  return '<span class="rank-sparkline">' + history.slice(-10).map(v=>`<span class="rank-bar" style="height:${Math.round((1-v/max)*16)+2}px;background:${v<=3?'#006600':v<=10?'#0a4dc4':'#808080'}"></span>`).join('') + '</span>';
}

function rtAddJob(){
  const kw = document.getElementById('rt-kw').value.trim();
  const url = document.getElementById('rt-url').value.trim();
  const country = document.getElementById('rt-country').value.trim()||'us';
  if(!kw || !url){ toast('Enter keyword and URL','w'); return; }
  if(RT.jobs.find(j=>j.keyword===kw&&j.url===url)){ toast('Already tracking this keyword+URL combo','w'); return; }
  RT.jobs.push({keyword:kw,url,country,position:null,prev:null,history:[],lastChecked:null});
  document.getElementById('rt-kw').value='';
  document.getElementById('rt-url').value='';
  toast('Added: ' + kw,'s');
  supaAutoSync('rank_history', RT.jobs);
  renderRankTracker(el||document.getElementById('page-rank_tracker'));
}
function rtRemove(i){ RT.jobs.splice(i,1); renderRankTracker(document.getElementById('page-rank_tracker')); }

function rtImportFromCampaigns(){
  const live = S.campaigns.filter(c=>c.status==='success'&&c.url);
  if(!live.length){ toast('No live campaign URLs found','w'); return; }
  let added=0;
  live.forEach(c=>{ if(!RT.jobs.find(j=>j.keyword===c.keyword&&j.url===c.url)){ RT.jobs.push({keyword:c.keyword,url:c.url,country:'us',position:null,prev:null,history:[],lastChecked:null}); added++; }});
  toast(`Imported ${added} keywords from campaigns`,'s');
  renderRankTracker(document.getElementById('page-rank_tracker'));
}

async function rtCheckAll(){
  if(RT.running){ toast('Already running','w'); return; }
  const apiKey = settingGet('serp_serpApiKey');
  if(!apiKey){ toast('Add SerpAPI key in Settings first','e'); return; }
  if(!RT.jobs.length){ toast('Add keywords first','w'); return; }
  RT.running=true;
  const tb = document.getElementById('rt-tbody');
  const term = document.getElementById('rt-terminal');
  const prog = document.getElementById('rt-prog');
  function log(msg,cls='t-info'){ if(term) term.innerHTML+=`<div class="tline"><span class="ttime">${ts()}</span><span class="${cls}">${msg}</span></div>`; if(term) term.scrollTop=9999; }
  log('Starting rank check for '+RT.jobs.length+' keywords...');
  for(let i=0;i<RT.jobs.length;i++){
    const j=RT.jobs[i];
    if(prog) prog.style.width=((i+1)/RT.jobs.length*100)+'%';
    log(`Checking: "${j.keyword}" â†’ ${j.url.slice(0,40)}...`);
    try {
      const serpUrl = `https://serpapi.com/search.json?q=${encodeURIComponent(j.keyword)}&gl=${j.country||'us'}&api_key=${apiKey}&num=100`;
      const corsProxy = settingGet('corsProxy')||'https://corsproxy.io/?';
      const res = await fetch(corsProxy + encodeURIComponent(serpUrl));
      const data = await res.json();
      const results = data.organic_results||[];
      const pos = results.findIndex(r=> r.link && (r.link.includes(j.url)||j.url.includes(r.link.split('/')[2])))+1;
      j.prev = j.position;
      j.position = pos||null;
      j.lastChecked = ts();
      if(!j.history) j.history=[];
      if(pos) j.history.push(pos);
      const change = j.prev && j.position ? (j.position < j.prev ? `â–²${j.prev-j.position}` : j.position > j.prev ? `â–¼${j.position-j.prev}` : 'â†’') : '';
      log(`  Position #${pos||'not found'} ${change}`, pos&&pos<=10?'t-accent':'t-info');
    } catch(e){ log(`  Error: ${e.message}`,'t-error'); }
    await sleep(1500);
  }
  RT.running=false;
  if(tb) tb.innerHTML=rtRenderRows();
  supaAutoSync('rank_history', RT.jobs);
  log('âœ“ Rank check complete','t-accent');
  toast('Rank check complete','s');
}

function rtExportCSV(){
  if(!RT.jobs.length){ toast('Nothing to export','w'); return; }
  const csv = 'Keyword,URL,Position,Previous,Change,Country,Last Checked\n' +
    RT.jobs.map(j=>`"${j.keyword}","${j.url}",${j.position||''},${j.prev||''},${j.prev&&j.position?j.position-j.prev:''},"${j.country}","${j.lastChecked||''}"`).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='rank_tracker.csv'; a.click(); toast('CSV exported','s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKLINK MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BLM = { items:[], running:false };

function renderBacklinkMonitor(el){
  el.innerHTML=`
  <div class="page-title">ğŸ” Backlink Monitor</div>
  <div class="page-sub">// Monitor your live parasite URLs â€” detect when pages go 404, get de-indexed, or change anchor text</div>
  <div class="card">
    <div class="card-title">Add URLs to Monitor</div>
    <div class="row">
      <div class="f1 fg mb0">
        <textarea id="blm-input" rows="3" placeholder="Add URLs to monitor (one per line) â€” or click Import to pull from campaigns"></textarea>
      </div>
    </div>
    <div class="flex aic g8 mt8">
      <button class="btn btn-primary" onclick="blmAddUrls()">+ Add URLs</button>
      <button class="btn" onclick="blmImport()">â¬‡ Import from Campaigns</button>
      <button class="btn btn-primary" style="margin-left:auto" onclick="blmCheckAll()">â–¶ Check All</button>
      <button class="btn" onclick="blmExportCSV()">ğŸ“¤ Export</button>
      <button class="btn btn-danger btn-sm" onclick="blmClearDead()">âœ• Remove Dead</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Monitor Status <span id="blm-stats" style="font-size:10px;opacity:.7">${blmStats()}</span></div>
    <div id="blm-terminal" class="terminal" style="height:80px;margin-bottom:8px"></div>
    <div class="prog-wrap"><div class="prog-fill" id="blm-prog" style="width:0%"></div></div>
    <div class="tw">
      <table>
        <thead><tr><th>URL</th><th>Status</th><th>HTTP</th><th>Anchor</th><th>Platform</th><th>Last Checked</th><th></th></tr></thead>
        <tbody id="blm-tbody">${blmRenderRows()}</tbody>
      </table>
    </div>
  </div>`;
}

function blmStats(){
  const live=BLM.items.filter(b=>b.status==='live').length;
  const dead=BLM.items.filter(b=>b.status==='dead').length;
  const unk=BLM.items.filter(b=>!b.status||b.status==='unknown').length;
  return `${BLM.items.length} total Â· ${live} live Â· ${dead} dead Â· ${unk} unchecked`;
}

function blmRenderRows(){
  if(!BLM.items.length) return '<tr><td colspan="7" class="tm mono xs" style="text-align:center;padding:16px">No URLs monitored yet. Add URLs or import from campaigns.</td></tr>';
  return BLM.items.map((b,i)=>`
    <tr>
      <td><a href="${esc(b.url)}" target="_blank" class="ta mono xs" style="text-decoration:none;max-width:220px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(b.url.replace('https://','').slice(0,50))}</a></td>
      <td><span class="bl-status-${b.status||'unknown'}">${b.status==='live'?'âœ“ LIVE':b.status==='dead'?'âœ— DEAD':b.status==='changed'?'âš  CHANGED':'? UNKNOWN'}</span></td>
      <td class="mono xs" style="color:${b.httpCode>=400?'#cc0000':b.httpCode>=300?'#997700':'#006600'}">${b.httpCode||'â€”'}</td>
      <td class="mono xs">${esc(b.anchor||'â€”')}</td>
      <td class="mono xs">${esc(b.platform||'â€”')}</td>
      <td class="mono xs tm">${b.lastChecked||'â€”'}</td>
      <td><button class="btn btn-xs btn-danger" onclick="blmRemove(${i})">âœ•</button></td>
    </tr>`).join('');
}

function blmAddUrls(){
  const lines=(document.getElementById('blm-input').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  let added=0;
  lines.forEach(url=>{ if(url.startsWith('http')&&!BLM.items.find(b=>b.url===url)){ BLM.items.push({url,status:'unknown',httpCode:null,anchor:null,platform:null,lastChecked:null}); added++; }});
  document.getElementById('blm-input').value='';
  toast(added+' URLs added','s');
  renderBacklinkMonitor(document.getElementById('page-backlink_monitor'));
}

function blmImport(){
  const live=S.campaigns.filter(c=>c.status==='success'&&c.url);
  let added=0;
  live.forEach(c=>{ if(!BLM.items.find(b=>b.url===c.url)){ BLM.items.push({url:c.url,status:'unknown',httpCode:null,anchor:c.keyword,platform:c.platform,lastChecked:null}); added++; }});
  toast(added+' URLs imported from campaigns','s');
  renderBacklinkMonitor(document.getElementById('page-backlink_monitor'));
}

function blmRemove(i){ BLM.items.splice(i,1); renderBacklinkMonitor(document.getElementById('page-backlink_monitor')); }
function blmClearDead(){ BLM.items=BLM.items.filter(b=>b.status!=='dead'); renderBacklinkMonitor(document.getElementById('page-backlink_monitor')); toast('Dead URLs removed','s'); }

async function blmCheckAll(){
  if(BLM.running){ toast('Already running','w'); return; }
  if(!BLM.items.length){ toast('Add URLs first','w'); return; }
  BLM.running=true;
  const term=document.getElementById('blm-terminal');
  const prog=document.getElementById('blm-prog');
  function log(msg,cls='t-info'){ if(term) term.innerHTML+=`<div class="tline"><span class="ttime">${ts()}</span><span class="${cls}">${msg}</span></div>`; if(term) term.scrollTop=9999; }
  log('Checking '+BLM.items.length+' URLs...');
  const corsProxy=settingGet('corsProxy')||'https://corsproxy.io/?';
  for(let i=0;i<BLM.items.length;i++){
    const b=BLM.items[i];
    if(prog) prog.style.width=((i+1)/BLM.items.length*100)+'%';
    try {
      const res=await fetch(corsProxy+encodeURIComponent(b.url),{method:'HEAD'});
      b.httpCode=res.status;
      b.status=res.ok?'live':res.status>=400?'dead':'changed';
      b.lastChecked=ts();
      log(`  ${b.url.slice(0,50)} â†’ ${res.status} ${b.status}`,b.status==='live'?'t-success':'t-error');
    } catch(e){
      b.httpCode=0; b.status='dead'; b.lastChecked=ts();
      log(`  ${b.url.slice(0,50)} â†’ FAILED`,'t-error');
    }
    await sleep(800);
  }
  BLM.running=false;
  const dead=BLM.items.filter(b=>b.status==='dead').length;
  if(dead>0) toast(dead+' dead URLs found!','e');
  else toast('All URLs live âœ“','s');
  supaAutoSync('backlinks', BLM.items);
  renderBacklinkMonitor(document.getElementById('page-backlink_monitor'));
}

function blmExportCSV(){
  if(!BLM.items.length){ toast('Nothing to export','w'); return; }
  const csv='URL,Status,HTTP Code,Anchor,Platform,Last Checked\n'+BLM.items.map(b=>`"${b.url}","${b.status||''}",${b.httpCode||''},"${b.anchor||''}","${b.platform||''}","${b.lastChecked||''}"`).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='backlink_monitor.csv'; a.click(); toast('Exported','s');
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT SPINNER / REWRITER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPINNER = { variations:[], selected:0 };

function renderContentSpinner(el){
  el.innerHTML=`
  <div class="page-title">ğŸ”„ Content Spinner</div>
  <div class="page-sub">// Generate unique variations of your content to avoid duplicate detection Â· ${SPINNER.variations.length} variations ready</div>
  <div class="grid2" style="gap:10px">
    <div class="card">
      <div class="card-title">Source Content</div>
      <div class="fg"><label class="lbl">Paste your article / content</label>
        <textarea id="spin-input" rows="12" placeholder="Paste your article here. The spinner will generate unique variations by restructuring sentences, swapping synonyms, and varying paragraph order.">${SPINNER.source||''}</textarea>
      </div>
      <div class="fg"><label class="lbl">Keyword (for density check)</label>
        <input type="text" id="spin-kw" placeholder="target keyword" value="${SPINNER.keyword||''}">
      </div>
      <div class="fg"><label class="lbl">Variations to generate</label>
        <select id="spin-count"><option>3</option><option selected>5</option><option>10</option><option>20</option></select>
      </div>
      <div class="flex aic g8">
        <button class="btn btn-primary" onclick="spinGenerate()">âš¡ Generate Variations</button>
        <button class="btn" onclick="spinImportFromStudio()">â¬‡ Import from Content Studio</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Variations <span style="font-size:10px;opacity:.7">${SPINNER.variations.length} generated</span></div>
      <div id="spin-list">
        ${SPINNER.variations.length?SPINNER.variations.map((v,i)=>`
          <div class="spin-variation ${i===SPINNER.selected?'selected':''}" onclick="spinSelect(${i})">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span class="badge badge-b">Variation ${i+1}</span>
              <span class="tm xs">${v.words} words Â· ${v.similarity}% unique</span>
            </div>
            <div style="max-height:80px;overflow:hidden;font-size:10px;line-height:1.5">${esc(v.text.slice(0,200))}...</div>
          </div>`).join('')
          :'<div class="notice notice-info">Generate variations from your source content on the left.</div>'}
      </div>
      ${SPINNER.variations.length?`
      <div class="flex aic g8 mt8">
        <button class="btn btn-primary" onclick="spinCopySelected()">ğŸ“‹ Copy Selected</button>
        <button class="btn" onclick="spinSendToStudio()">â†’ Content Studio</button>
        <button class="btn" onclick="spinSendToCampaign()">â†’ Campaign</button>
        <button class="btn" onclick="spinExportAll()">ğŸ“¤ Export All</button>
      </div>`:''}
    </div>
  </div>
  <div class="card" id="spin-preview-card" style="${SPINNER.variations.length?'':'display:none'}">
    <div class="card-title">Preview â€” Variation ${SPINNER.selected+1}</div>
    <div id="spin-preview" style="white-space:pre-wrap;font-size:11px;line-height:1.7;font-family:'Share Tech Mono',monospace;padding:4px;max-height:300px;overflow-y:auto">${SPINNER.variations[SPINNER.selected]?.text||''}</div>
  </div>`;
}

function spinSelect(i){
  SPINNER.selected=i;
  renderContentSpinner(document.getElementById('page-content_spinner'));
}

function spinGenerate(){
  const src=document.getElementById('spin-input')?.value.trim();
  const kw=document.getElementById('spin-kw')?.value.trim();
  const count=parseInt(document.getElementById('spin-count')?.value)||5;
  if(!src||src.length<100){ toast('Paste at least 100 characters of content','w'); return; }
  SPINNER.source=src; SPINNER.keyword=kw; SPINNER.variations=[];
  const syns={
    'important':['crucial','essential','critical','vital','key'],
    'good':['excellent','outstanding','effective','superior','beneficial'],
    'use':['utilize','employ','apply','leverage','implement'],
    'show':['demonstrate','reveal','indicate','illustrate','display'],
    'help':['assist','support','enable','facilitate','aid'],
    'find':['discover','locate','identify','determine','uncover'],
    'make':['create','build','develop','produce','generate'],
    'get':['obtain','acquire','achieve','gain','receive'],
    'need':['require','demand','necessitate','call for'],
    'provide':['offer','deliver','supply','give','furnish'],
    'different':['distinct','varied','diverse','unique','alternative'],
    'many':['numerous','multiple','various','several','countless'],
    'also':['additionally','furthermore','moreover','likewise','as well'],
    'because':['since','as','given that','due to the fact that'],
    'however':['nevertheless','nonetheless','yet','but','on the other hand'],
    'therefore':['thus','consequently','as a result','hence','accordingly'],
  };
  const sentences=src.match(/[^.!?]+[.!?]+/g)||[src];
  for(let v=0;v<count;v++){
    let variation=sentences.map(s=>{
      // Random synonym replacement
      let mod=s;
      Object.entries(syns).forEach(([word,alts])=>{
        const re=new RegExp('\\b'+word+'\\b','gi');
        if(re.test(mod)&&Math.random()>0.4) mod=mod.replace(re,alts[Math.floor(Math.random()*alts.length)]);
      });
      // Occasional sentence restructuring
      if(Math.random()>0.7&&mod.includes(',')){
        const parts=mod.split(',');
        if(parts.length===2) mod=parts[1].trim()+', '+parts[0].trim().toLowerCase();
      }
      return mod;
    });
    // Shuffle paragraph order for longer content
    if(variation.length>6&&Math.random()>0.5){
      const mid=variation.slice(1,-1);
      for(let i=mid.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [mid[i],mid[j]]=[mid[j],mid[i]]; }
      variation=[variation[0],...mid,variation[variation.length-1]];
    }
    const text=variation.join(' ').replace(/\s+/g,' ').trim();
    // Calculate rough similarity
    const origWords=new Set(src.toLowerCase().split(/\W+/));
    const newWords=new Set(text.toLowerCase().split(/\W+/));
    const common=[...origWords].filter(w=>newWords.has(w)).length;
    const similarity=Math.max(60,100-Math.round((1-common/origWords.size)*100*0.4+(v*3)));
    SPINNER.variations.push({text,words:text.split(/\s+/).length,similarity:Math.min(similarity,98)});
  }
  SPINNER.selected=0;
  toast(count+' variations generated','s');
  renderContentSpinner(document.getElementById('page-content_spinner'));
}

function spinImportFromStudio(){
  // Import from Content Studio library
  const lib=JSON.parse(localStorage.getItem('cs_library')||'[]');
  if(!lib.length){ toast('No content in Content Studio library','w'); return; }
  const latest=lib[lib.length-1];
  const inp=document.getElementById('spin-input');
  if(inp){ inp.value=latest.content||latest.text||''; toast('Imported from Content Studio','s'); }
}

function spinCopySelected(){
  const v=SPINNER.variations[SPINNER.selected];
  if(!v){ toast('No variation selected','w'); return; }
  navigator.clipboard.writeText(v.text).then(()=>toast('Variation '+( SPINNER.selected+1)+' copied','s')).catch(()=>toast('Copy failed','e'));
}

function spinSendToStudio(){
  const v=SPINNER.variations[SPINNER.selected];
  if(!v){ toast('No variation selected','w'); return; }
  localStorage.setItem('cs_spinner_content', v.text);
  toast('Sent to Content Studio â€” open Content Studio to use it','s');
  switchPage('content_studio');
}

function spinSendToCampaign(){
  const v=SPINNER.variations[SPINNER.selected];
  if(!v){ toast('No variation selected','w'); return; }
  localStorage.setItem('cs_spinner_content', v.text);
  toast('Variation ready â€” open Run Campaign and it will use this content','s');
  switchPage('campaign');
}

function spinExportAll(){
  if(!SPINNER.variations.length){ toast('Generate variations first','w'); return; }
  const txt=SPINNER.variations.map((v,i)=>`=== VARIATION ${i+1} (${v.words} words, ${v.similarity}% unique) ===\n\n${v.text}`).join('\n\n'+'-'.repeat(60)+'\n\n');
  const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(txt); a.download='content_variations.txt'; a.click(); toast('Exported all variations','s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HEALTH DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderApiHealth(el){
  el.innerHTML=`
  <div class="page-title">ğŸ’Š API Health Dashboard</div>
  <div class="page-sub">// Real-time status of all connected APIs and services Â· Click any card to configure</div>
  <div class="flex aic g8" style="margin-bottom:12px">
    <button class="btn btn-primary" onclick="ahCheckAll()">â–¶ Check All APIs</button>
    <button class="btn" onclick="renderApiHealth(document.getElementById('page-api_health'))">â†º Refresh</button>
    <span id="ah-last" class="tm mono xs" style="margin-left:auto">Last check: never</span>
  </div>
  <div id="ah-grid" class="health-grid">${ahRenderCards()}</div>
  <div class="card" style="margin-top:12px">
    <div class="card-title">API Activity Log</div>
    <div id="ah-terminal" class="terminal" style="height:120px"></div>
  </div>`;
}

function ahGetServices(){
  return [
    {id:'github',    name:'GitHub API',      icon:'ğŸ™', test:()=>ahTestGitHub(),      page:'setup',           key:settingGet('githubToken')||getAccount('github')?.token},
    {id:'medium',    name:'Medium API',      icon:'â“‚',  test:()=>ahTestMedium(),      page:'setup',           key:getAccount('medium')?.token},
    {id:'devto',     name:'Dev.to API',      icon:'ğŸ’»', test:()=>ahTestDevTo(),       page:'setup',           key:getAccount('devto')?.token},
    {id:'serpapi',   name:'SerpAPI',         icon:'ğŸ“Š', test:()=>ahTestSerpApi(),     page:'settings',        key:settingGet('serp_serpApiKey')},
    {id:'2captcha',  name:'2Captcha',        icon:'ğŸ”“', test:()=>ahTest2Captcha(),    page:'captcha_solver',  key:settingGet('cap_2captchaKey')},
    {id:'anticaptcha',name:'Anti-Captcha',   icon:'ğŸ”“', test:()=>ahTestAntiCaptcha(), page:'captcha_solver',  key:settingGet('cap_antiCaptchaKey')},
    {id:'indexnow',  name:'IndexNow',        icon:'ğŸ“¡', test:()=>ahTestIndexNow(),    page:'link_indexer',    key:settingGet('li_indexNowKey')},
    {id:'supabase',  name:'Supabase',        icon:'âš¡', test:()=>ahTestSupabase(),    page:'settings',        key:settingGet('supa_anon_key')},
    {id:'wordpress', name:'WordPress.com',   icon:'ğŸ”µ', test:()=>ahTestWordpress(),   page:'setup',           key:getAccount('wordpress')?.token},
    {id:'notion',    name:'Notion API',      icon:'ğŸ“', test:()=>ahTestNotion(),      page:'setup',           key:getAccount('notion')?.token},
    {id:'hashnode',  name:'Hashnode',        icon:'âš¡', test:()=>ahTestHashnode(),    page:'setup',           key:getAccount('hashnode')?.token},
    {id:'netlify',   name:'Netlify',         icon:'ğŸŒ', test:()=>ahTestNetlify(),     page:'setup',           key:getAccount('netlify')?.token},
    {id:'ghost',     name:'Ghost Admin',     icon:'ğŸ‘»', test:()=>ahTestGhost(),       page:'setup',           key:getAccount('ghost')?.token},
    {id:'reddit',    name:'Reddit OAuth',    icon:'ğŸ¤–', test:()=>ahTestReddit(),      page:'setup',           key:getAccount('reddit')?.token},
    {id:'corsproxy', name:'CORS Proxy',      icon:'ğŸŒ', test:()=>ahTestCorsProxy(),   page:'settings',        key:settingGet('corsProxy')||'corsproxy.io'},
  ];
}

const AH_STATUS = {};

function ahRenderCards(){
  const services=ahGetServices();
  return services.map(s=>{
    const st=AH_STATUS[s.id];
    const hasKey=!!(s.key);
    const statusClass=!hasKey?'unknown':st==='ok'?'ok':st==='fail'?'fail':st==='warn'?'warn':'unknown';
    const dot=!hasKey?'â¬œ':st==='ok'?'ğŸŸ¢':st==='fail'?'ğŸ”´':st==='warn'?'ğŸŸ¡':'â¬œ';
    const val=st==='ok'?'âœ“ Online':st==='fail'?'âœ— Failed':st==='warn'?'âš  Warning':hasKey?'Not tested':'Not configured';
    return `<div class="health-card ${statusClass}" onclick="switchPage('${s.page}')" style="cursor:pointer" title="Click to configure">
      <span class="health-dot">${dot}</span>
      <div style="font-size:14px">${s.icon}</div>
      <div class="health-name">${s.name}</div>
      <div class="health-val">${val}</div>
    </div>`;
  }).join('');
}

async function ahCheckAll(){
  const term=document.getElementById('ah-terminal');
  function log(msg,cls='t-info'){ if(term) term.innerHTML+=`<div class="tline"><span class="ttime">${ts()}</span><span class="${cls}">${msg}</span></div>`; if(term) term.scrollTop=9999; }
  const services=ahGetServices();
  log('Checking '+services.length+' services...');
  for(const s of services){
    if(!s.key){ AH_STATUS[s.id]='unknown'; log(`  ${s.name}: not configured`,'t-dim'); continue; }
    try {
      const result=await s.test();
      AH_STATUS[s.id]=result?'ok':'fail';
      log(`  ${s.name}: ${result?'âœ“ online':'âœ— failed'}`,result?'t-success':'t-error');
    } catch(e){ AH_STATUS[s.id]='fail'; log(`  ${s.name}: âœ— ${e.message}`,'t-error'); }
    await sleep(300);
  }
  document.getElementById('ah-grid').innerHTML=ahRenderCards();
  document.getElementById('ah-last').textContent='Last check: '+ts();
  toast('API health check complete','s');
}

// Individual API test functions
async function ahTestGitHub(){ const token=getAccount('github')?.token; if(!token) return false; const r=await smartFetch('https://api.github.com/user',{method:'GET',headers:{Authorization:'token '+token}}); return r.ok; }
async function ahTestMedium(){ const token=getAccount('medium')?.token; if(!token) return false; const r=await smartFetch('https://api.medium.com/v1/me',{method:'GET',headers:{Authorization:'Bearer '+token}}); return r.ok; }
async function ahTestDevTo(){ const key=getAccount('devto')?.token; if(!key) return false; const r=await smartFetch('https://dev.to/api/users/me',{method:'GET',headers:{'api-key':key}}); return r.ok; }
async function ahTestSerpApi(){ const key=settingGet('serp_serpApiKey'); if(!key) return false; const r=await smartFetch(`https://serpapi.com/account.json?api_key=${key}`,{method:'GET'}); return r.ok; }
async function ahTest2Captcha(){ const key=settingGet('cap_2captchaKey'); if(!key) return false; const r=await smartFetch(`https://2captcha.com/res.php?action=getbalance&key=${key}&json=1`,{method:'GET'}); if(!r.ok) return false; const d=await r.json(); return d.status===1&&parseFloat(d.request)>0; }
async function ahTestAntiCaptcha(){ const key=settingGet('cap_antiCaptchaKey'); if(!key) return false; const r=await smartFetch('https://api.anti-captcha.com/getBalance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clientKey:key})}); if(!r.ok) return false; const d=await r.json(); return d.errorId===0; }
async function ahTestIndexNow(){ return !!(settingGet('li_indexNowKey')); }
async function ahTestSupabase(){ return !!(settingGet('supa_connected')); }
async function ahTestWordpress(){ const token=getAccount('wordpress')?.token; if(!token) return false; const r=await smartFetch('https://public-api.wordpress.com/rest/v1/me/',{method:'GET',headers:{Authorization:'Bearer '+token}}); return r.ok; }
async function ahTestNotion(){ const token=getAccount('notion')?.token; if(!token) return false; const r=await smartFetch('https://api.notion.com/v1/users/me',{method:'GET',headers:{Authorization:'Bearer '+token,'Notion-Version':'2022-06-28'}}); return r.ok; }
async function ahTestHashnode(){ const token=getAccount('hashnode')?.token; if(!token) return false; const r=await smartFetch('https://gql.hashnode.com/',{method:'POST',headers:{Authorization:token,'Content-Type':'application/json'},body:'{"query":"{me{id}}"}'}); return r.ok; }
async function ahTestNetlify(){ const token=getAccount('netlify')?.token; if(!token) return false; const r=await smartFetch('https://api.netlify.com/api/v1/user',{method:'GET',headers:{Authorization:'Bearer '+token}}); return r.ok; }
async function ahTestGhost(){ return !!(getAccount('ghost')?.token); }
async function ahTestReddit(){ const token=getAccount('reddit')?.token; if(!token) return false; const r=await smartFetch('https://oauth.reddit.com/api/v1/me',{method:'GET',headers:{Authorization:'Bearer '+token,'User-Agent':'SEOParasite/1.0'}}); return r.ok; }
async function ahTestCorsProxy(){ try{ const r=await fetch('https://corsproxy.io/?'+encodeURIComponent('https://api.github.com'),{signal:AbortSignal.timeout(5000)}); return r.ok; }catch(e){ return false; } }



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMPAIGN TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CT = { templates:JSON.parse(localStorage.getItem('campaign_templates')||'[]') };

function ctSave(){ localStorage.setItem('campaign_templates', JSON.stringify(CT.templates)); supaAutoSync('campaign_templates', CT.templates); }

function renderCampaignTemplates(el){
  el.innerHTML=`
  <div class="page-title">ğŸ“‹ Campaign Templates</div>
  <div class="page-sub">// Save and load campaign configurations as reusable presets</div>
  <div class="grid2" style="gap:10px">
    <div class="card">
      <div class="card-title">Save Current Configuration as Template</div>
      <div class="fg"><label class="lbl">Template Name</label>
        <input type="text" id="tpl-name" placeholder="e.g. GitHub Blast â€” Health Niche">
      </div>
      <div class="fg"><label class="lbl">Description</label>
        <input type="text" id="tpl-desc" placeholder="e.g. 5 platforms, dofollow links only, 10 keywords">
      </div>
      <div class="fg"><label class="lbl">Platforms to save</label>
        <div class="chips" id="tpl-platform-chips">
          ${['github','medium','devto','notion','wordpress','hashnode','telegraph','reddit','tumblr'].map(p=>{
            const pl=getPlatform(p); return `<div class="chip on" data-p="${p}" onclick="this.classList.toggle('on')">${pl.icon} ${pl.name.split(' ')[0]}</div>`;
          }).join('')}
        </div>
      </div>
      <div class="flex aic g8">
        <button class="btn btn-primary" onclick="ctSaveTemplate()">ğŸ’¾ Save Template</button>
        <button class="btn" onclick="ctSaveFromCurrentCampaign()">â¬‡ Capture from Campaign Settings</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Built-in Quick Templates</div>
      ${[
        {name:'ğŸš€ Max Authority Blast',desc:'Top 5 highest-DA platforms',platforms:['github','medium','blogger','reddit','wordpress']},
        {name:'ğŸ‘¨â€ğŸ’» Dev Focus',desc:'Developer-oriented platforms',platforms:['github','devto','hashnode','gitlab','codepen']},
        {name:'âš¡ Quick Parasite',desc:'Fast no-auth platforms',platforms:['telegraph','devto','hashnode','notion','codepen']},
        {name:'ğŸŒ Maximum Spread',desc:'All 20 core platforms',platforms:['github','medium','devto','notion','wordpress','hashnode','telegraph','reddit','tumblr','blogger','ghost','wix','netlify','vercel','cloudflare','codepen','substack','gitlab','replit','issuu']},
      ].map(t=>`
        <div class="tpl-card" onclick="ctLoadBuiltin(${JSON.stringify(t).replace(/"/g,'&quot;')})">
          <div><div class="tpl-name">${t.name}</div><div class="tpl-meta">${t.desc} Â· ${t.platforms.length} platforms</div></div>
          <button class="btn btn-primary btn-sm">Load â†’</button>
        </div>`).join('')}
    </div>
  </div>
  <div class="card">
    <div class="card-title">Saved Templates <span style="font-size:10px;opacity:.7">${CT.templates.length} saved</span></div>
    ${!CT.templates.length?'<div class="notice notice-info">No saved templates yet. Create one above.</div>':
    CT.templates.map((t,i)=>`
      <div class="tpl-card">
        <div>
          <div class="tpl-name">${esc(t.name)}</div>
          <div class="tpl-meta">${esc(t.desc||'')} Â· ${(t.platforms||[]).length} platforms Â· Saved ${t.saved||'â€”'}</div>
        </div>
        <div class="flex g8">
          <button class="btn btn-primary btn-sm" onclick="ctLoadTemplate(${i})">Load â†’</button>
          <button class="btn btn-danger btn-sm" onclick="ctDeleteTemplate(${i})">âœ•</button>
        </div>
      </div>`).join('')}
  </div>`;
}

function ctSaveTemplate(){
  const name=document.getElementById('tpl-name')?.value.trim();
  if(!name){ toast('Enter a template name','w'); return; }
  const platforms=[...document.querySelectorAll('#tpl-platform-chips .chip.on')].map(c=>c.dataset.p);
  const desc=document.getElementById('tpl-desc')?.value.trim();
  CT.templates.push({name,desc,platforms,saved:new Date().toLocaleDateString(),config:{platforms,keywords:S.keywords.slice(0,5)}});
  ctSave();
  toast('Template saved: '+name,'s');
  renderCampaignTemplates(document.getElementById('page-campaign_templates'));
}

function ctSaveFromCurrentCampaign(){
  const name=document.getElementById('tpl-name')?.value.trim()||(S.keywords[0]||'Campaign')+' Template';
  const platforms=S.accounts.map(a=>a.platform).filter((v,i,a)=>a.indexOf(v)===i);
  CT.templates.push({name,desc:'Captured from current session',platforms,saved:new Date().toLocaleDateString(),config:{platforms,keywords:S.keywords}});
  ctSave(); toast('Template captured from current campaign','s');
  renderCampaignTemplates(document.getElementById('page-campaign_templates'));
}

function ctLoadTemplate(i){
  const t=CT.templates[i]; if(!t) return;
  toast('Loaded template: '+t.name+' â€” go to Run Campaign','s');
  localStorage.setItem('active_campaign_template', JSON.stringify(t));
  switchPage('campaign');
}

function ctLoadBuiltin(t){
  localStorage.setItem('active_campaign_template', JSON.stringify(t));
  toast('Template loaded: '+t.name+' â€” go to Run Campaign','s');
  switchPage('campaign');
}

function ctDeleteTemplate(i){ CT.templates.splice(i,1); ctSave(); renderCampaignTemplates(document.getElementById('page-campaign_templates')); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCHEMA GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSchemaGenerator(el){
  el.innerHTML=`
  <div class="page-title">ğŸ— Schema Markup Generator</div>
  <div class="page-sub">// Generate JSON-LD structured data for your parasite pages to improve Google rich results eligibility</div>
  <div class="grid2" style="gap:10px">
    <div class="card">
      <div class="card-title">Schema Configuration</div>
      <div class="fg"><label class="lbl">Schema Type</label>
        <select id="schema-type" onchange="schemaPreview()">
          <option value="Article">Article</option>
          <option value="FAQPage">FAQPage</option>
          <option value="HowTo">HowTo</option>
          <option value="Review">Review</option>
          <option value="Product">Product</option>
          <option value="BreadcrumbList">BreadcrumbList</option>
          <option value="WebPage">WebPage</option>
          <option value="BlogPosting">BlogPosting</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Page Title / Headline</label>
        <input type="text" id="schema-title" placeholder="Best Creatine Supplement Guide 2025" oninput="schemaPreview()">
      </div>
      <div class="fg"><label class="lbl">URL</label>
        <input type="text" id="schema-url" placeholder="https://yourpage.github.io/creatine/" oninput="schemaPreview()">
      </div>
      <div class="fg"><label class="lbl">Description</label>
        <textarea id="schema-desc" rows="3" placeholder="Comprehensive guide to..." oninput="schemaPreview()"></textarea>
      </div>
      <div class="fg"><label class="lbl">Author Name</label>
        <input type="text" id="schema-author" placeholder="John Smith" oninput="schemaPreview()">
      </div>
      <div class="fg"><label class="lbl">Date Published</label>
        <input type="date" id="schema-date" value="${new Date().toISOString().split('T')[0]}" oninput="schemaPreview()">
      </div>
      <div id="schema-faq-section" style="display:none">
        <label class="lbl">FAQ Items (one Q|A per line)</label>
        <textarea id="schema-faq" rows="6" placeholder="What is creatine?|Creatine is a natural compound...&#10;How to take creatine?|Take 5g daily..." oninput="schemaPreview()"></textarea>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Generated Schema JSON-LD</div>
      <pre id="schema-output" style="background:#0a0f0a;color:#00cc44;font-family:'Share Tech Mono',monospace;font-size:10px;padding:10px;overflow:auto;max-height:380px;white-space:pre-wrap;border:1px solid #224422">Select type and fill fields to generate schema...</pre>
      <div class="flex aic g8 mt8">
        <button class="btn btn-primary" onclick="schemaCopy()">ğŸ“‹ Copy JSON-LD</button>
        <button class="btn" onclick="schemaDownload()">ğŸ“¥ Download</button>
        <button class="btn" onclick="schemaValidate()">âœ“ Validate</button>
      </div>
    </div>
  </div>`;
  document.getElementById('schema-type').addEventListener('change',()=>{
    document.getElementById('schema-faq-section').style.display=
      document.getElementById('schema-type').value==='FAQPage'?'':'none';
  });
  schemaPreview();
}

function schemaPreview(){
  const type=document.getElementById('schema-type')?.value||'Article';
  const title=document.getElementById('schema-title')?.value||'Page Title';
  const url=document.getElementById('schema-url')?.value||'https://example.com/page/';
  const desc=document.getElementById('schema-desc')?.value||'Page description';
  const author=document.getElementById('schema-author')?.value||'Author Name';
  const date=document.getElementById('schema-date')?.value||new Date().toISOString().split('T')[0];
  let schema={};
  if(type==='Article'||type==='BlogPosting'){
    schema={"@context":"https://schema.org","@type":type,"headline":title,"description":desc,"url":url,
      "author":{"@type":"Person","name":author},"datePublished":date,"dateModified":date,
      "publisher":{"@type":"Organization","name":author,"logo":{"@type":"ImageObject","url":url+'favicon.ico'}}};
  } else if(type==='FAQPage'){
    const faqLines=(document.getElementById('schema-faq')?.value||'Question?|Answer.').split('\n').filter(l=>l.includes('|'));
    schema={"@context":"https://schema.org","@type":"FAQPage","mainEntity":faqLines.map(l=>{
      const[q,a]=l.split('|'); return {"@type":"Question","name":q.trim(),"acceptedAnswer":{"@type":"Answer","text":a.trim()}};
    })};
  } else if(type==='HowTo'){
    schema={"@context":"https://schema.org","@type":"HowTo","name":title,"description":desc,"url":url,
      "step":[{"@type":"HowToStep","text":"Step 1: Research your topic"},{"@type":"HowToStep","text":"Step 2: Implement your strategy"},{"@type":"HowToStep","text":"Step 3: Monitor and optimize results"}]};
  } else if(type==='BreadcrumbList'){
    schema={"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://example.com/"},
      {"@type":"ListItem","position":2,"name":title,"item":url}]};
  } else if(type==='WebPage'){
    schema={"@context":"https://schema.org","@type":"WebPage","name":title,"description":desc,"url":url,"author":{"@type":"Person","name":author}};
  } else {
    schema={"@context":"https://schema.org","@type":type,"name":title,"description":desc,"url":url};
  }
  const out=document.getElementById('schema-output');
  if(out) out.textContent=JSON.stringify(schema,null,2);
}

function schemaCopy(){
  const out=document.getElementById('schema-output')?.textContent;
  if(!out||out.includes('Select type')) return;
  const wrapped=`<script type="application/ld+json">\n${out}\n<\/script>`;
  navigator.clipboard.writeText(wrapped).then(()=>toast('Schema JSON-LD copied with script tags','s')).catch(()=>toast('Copy failed','e'));
}

function schemaDownload(){
  const out=document.getElementById('schema-output')?.textContent;
  if(!out) return;
  const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(out); a.download='schema.json'; a.click(); toast('Downloaded','s');
}

function schemaValidate(){
  const url='https://validator.schema.org/';
  toast('Opening Schema.org validator...','i');
  window.open(url,'_blank');
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SITEMAP GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSitemapGenerator(el){
  const liveUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  el.innerHTML=`
  <div class="page-title">ğŸ—º Sitemap Generator</div>
  <div class="page-sub">// Generate XML sitemaps for your published parasite pages and submit to Google & Bing</div>
  <div class="grid2" style="gap:10px">
    <div class="card">
      <div class="card-title">Sitemap Configuration</div>
      <div class="fg"><label class="lbl">Base URL (optional â€” for grouped sitemaps)</label>
        <input type="text" id="sm-base" placeholder="https://username.github.io">
      </div>
      <div class="fg"><label class="lbl">Change Frequency</label>
        <select id="sm-freq">
          <option value="weekly">Weekly</option>
          <option value="daily">Daily</option>
          <option value="monthly">Monthly</option>
          <option value="always">Always</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Priority</label>
        <select id="sm-priority">
          <option value="0.8">0.8 (High)</option>
          <option value="1.0">1.0 (Maximum)</option>
          <option value="0.5">0.5 (Normal)</option>
          <option value="0.3">0.3 (Low)</option>
        </select>
      </div>
      <div class="notice notice-info">${liveUrls.length} live campaign URLs available Â· <a href="#" onclick="switchPage('campaign');return false" class="ta">Run Campaign</a> to generate more</div>
      <div class="flex g8">
        <button class="btn btn-primary" onclick="smGenerate()">âš¡ Generate Sitemap</button>
        <button class="btn" onclick="smSubmit()">ğŸ“¡ Submit to Google</button>
        <button class="btn" onclick="smSubmitBing()">ğŸ“¡ Submit to Bing</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Generated Sitemap XML</div>
      <pre id="sm-output" style="background:#0a0f0a;color:#00cc44;font-family:'Share Tech Mono',monospace;font-size:9px;padding:8px;overflow:auto;max-height:360px;border:1px solid #224422;white-space:pre-wrap">Generate sitemap from your live URLs...</pre>
      <div class="flex g8 mt8">
        <button class="btn btn-primary" onclick="smCopy()">ğŸ“‹ Copy XML</button>
        <button class="btn" onclick="smDownload()">ğŸ“¥ Download sitemap.xml</button>
        <button class="btn" onclick="smDownloadIndex()">ğŸ“¥ Sitemap Index</button>
      </div>
    </div>
  </div>`;
}

function smGenerate(){
  const liveUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  if(!liveUrls.length){ toast('No live URLs found â€” run a campaign first','w'); return; }
  const freq=document.getElementById('sm-freq')?.value||'weekly';
  const priority=document.getElementById('sm-priority')?.value||'0.8';
  const today=new Date().toISOString().split('T')[0];
  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:news="http://www.google.com/schemas/sitemap-news/0.9">
${liveUrls.map(c=>`  <url>
    <loc>${esc(c.url)}</loc>
    <lastmod>${today}</lastmod>
    <changefreq>${freq}</changefreq>
    <priority>${priority}</priority>
  </url>`).join('\n')}
</urlset>`;
  const out=document.getElementById('sm-output');
  if(out) out.textContent=xml;
  toast('Sitemap generated with '+liveUrls.length+' URLs','s');
}

function smCopy(){ const out=document.getElementById('sm-output')?.textContent; if(out&&!out.includes('Generate')) { navigator.clipboard.writeText(out).then(()=>toast('Copied','s')).catch(()=>toast('Copy failed','e')); } }
function smDownload(){ const out=document.getElementById('sm-output')?.textContent; if(!out||out.includes('Generate')) return; const a=document.createElement('a'); a.href='data:application/xml;charset=utf-8,'+encodeURIComponent(out); a.download='sitemap.xml'; a.click(); toast('Downloaded sitemap.xml','s'); }
function smDownloadIndex(){
  const liveUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  const today=new Date().toISOString().split('T')[0];
  const xml=`<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <sitemap><loc>sitemap.xml</loc><lastmod>${today}</lastmod></sitemap>
</sitemapindex>`;
  const a=document.createElement('a'); a.href='data:application/xml;charset=utf-8,'+encodeURIComponent(xml); a.download='sitemap_index.xml'; a.click(); toast('Downloaded','s');
}
function smSubmit(){ toast('Opening Google Search Console â€” paste your sitemap URL there','i'); window.open('https://search.google.com/search-console/sitemaps','_blank'); }
function smSubmitBing(){ toast('Opening Bing Webmaster Tools','i'); window.open('https://www.bing.com/webmasters/sitemaps','_blank'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERNAL LINK BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInternalLinks(el){
  const liveUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  el.innerHTML=`
  <div class="page-title">ğŸ”— Internal Link Builder</div>
  <div class="page-sub">// Build topical clusters by cross-linking your parasite pages to each other</div>
  <div class="card">
    <div class="card-title">Live URL Cluster <span style="font-size:10px;opacity:.7">${liveUrls.length} live URLs available</span></div>
    ${!liveUrls.length?'<div class="notice notice-info">No live URLs found. Run a campaign to generate parasite pages first.</div>':''}
    <div class="grid2" style="gap:10px">
      <div>
        <label class="lbl">Linking Strategy</label>
        <select id="il-strategy">
          <option value="hub">Hub & Spoke â€” all link to #1 URL</option>
          <option value="cluster">Full Cluster â€” each links to 3 related</option>
          <option value="chain">Chain â€” sequential linking</option>
          <option value="star">Star â€” all link to all</option>
        </select>
        <div class="mt8">
          <label class="lbl">Anchor Text Source</label>
          <select id="il-anchor">
            <option value="keyword">Use keyword as anchor</option>
            <option value="url">Use URL slug</option>
            <option value="mixed">Mix: 50% keyword, 50% branded</option>
          </select>
        </div>
        <button class="btn btn-primary mt8" onclick="ilGenerate()">âš¡ Generate Link Plan</button>
      </div>
      <div>
        <label class="lbl">URL Cluster Preview</label>
        <div style="max-height:140px;overflow-y:auto">
          ${liveUrls.slice(0,20).map(c=>`<div class="mono xs" style="padding:2px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
            <span class="badge badge-g" style="font-size:8px">${getPlatform(c.platform).icon}</span> ${esc(c.url.replace('https://','').slice(0,60))}
          </div>`).join('')}
        </div>
      </div>
    </div>
  </div>
  <div class="card" id="il-results-card" style="display:none">
    <div class="card-title">Generated Link Plan</div>
    <div id="il-plan" style="font-family:'Share Tech Mono',monospace;font-size:10px;line-height:1.7"></div>
    <div class="flex g8 mt8">
      <button class="btn btn-primary" onclick="ilCopyMarkdown()">ğŸ“‹ Copy as Markdown</button>
      <button class="btn" onclick="ilCopyHTML()">ğŸ“‹ Copy as HTML</button>
      <button class="btn" onclick="ilExportCSV()">ğŸ“¤ Export CSV</button>
    </div>
  </div>`;
}

let IL_PLAN=[];
function ilGenerate(){
  const liveUrls=S.campaigns.filter(c=>c.status==='success'&&c.url);
  if(liveUrls.length<2){ toast('Need at least 2 live URLs to build internal links','w'); return; }
  const strategy=document.getElementById('il-strategy')?.value||'hub';
  const anchorMode=document.getElementById('il-anchor')?.value||'keyword';
  IL_PLAN=[];
  function getAnchor(c){ return anchorMode==='keyword'?c.keyword:anchorMode==='url'?c.url.split('/').filter(Boolean).pop():Math.random()>0.5?c.keyword:getPlatform(c.platform).name; }
  if(strategy==='hub'){
    const hub=liveUrls[0];
    liveUrls.slice(1).forEach(c=>{ IL_PLAN.push({from:c.url,to:hub.url,anchor:getAnchor(hub),fromKw:c.keyword,toKw:hub.keyword}); });
  } else if(strategy==='chain'){
    for(let i=0;i<liveUrls.length-1;i++) IL_PLAN.push({from:liveUrls[i].url,to:liveUrls[i+1].url,anchor:getAnchor(liveUrls[i+1]),fromKw:liveUrls[i].keyword,toKw:liveUrls[i+1].keyword});
  } else if(strategy==='cluster'){
    liveUrls.forEach((c,i)=>{ const targets=liveUrls.filter((_,j)=>j!==i).slice(0,3); targets.forEach(t=>IL_PLAN.push({from:c.url,to:t.url,anchor:getAnchor(t),fromKw:c.keyword,toKw:t.keyword})); });
  } else {
    liveUrls.forEach((c,i)=>{ liveUrls.forEach((t,j)=>{ if(i!==j) IL_PLAN.push({from:c.url,to:t.url,anchor:getAnchor(t),fromKw:c.keyword,toKw:t.keyword}); }); });
  }
  const card=document.getElementById('il-results-card');
  const plan=document.getElementById('il-plan');
  if(card) card.style.display='';
  if(plan) plan.innerHTML=IL_PLAN.slice(0,50).map(lk=>`
    <div style="border-left:3px solid var(--win-blue);padding:4px 8px;margin-bottom:4px;background:#fff">
      <span class="tm">FROM:</span> <span style="color:#003087">${esc(lk.from.replace('https://','').slice(0,50))}</span><br>
      <span class="tm">ADD LINK:</span> <code style="background:#e8f0ff;padding:1px 4px">&lt;a href="${esc(lk.to)}"&gt;${esc(lk.anchor)}&lt;/a&gt;</code>
    </div>`).join('')+(IL_PLAN.length>50?`<div class="tm xs">... and ${IL_PLAN.length-50} more</div>`:'');
  toast(IL_PLAN.length+' internal links planned Â· '+liveUrls.length+' URLs cross-linked','s');
}

function ilCopyMarkdown(){
  if(!IL_PLAN.length){ toast('Generate a plan first','w'); return; }
  const md=IL_PLAN.map(lk=>`- [${lk.anchor}](${lk.to}) â†’ Add to: ${lk.from}`).join('\n');
  navigator.clipboard.writeText(md).then(()=>toast('Markdown copied','s')).catch(()=>toast('Copy failed','e'));
}

function ilCopyHTML(){
  if(!IL_PLAN.length){ toast('Generate a plan first','w'); return; }
  const h=IL_PLAN.map(lk=>`<!-- Add to: ${lk.from} -->\n<a href="${lk.to}" rel="noopener">${lk.anchor}</a>`).join('\n\n');
  navigator.clipboard.writeText(h).then(()=>toast('HTML links copied','s')).catch(()=>toast('Copy failed','e'));
}

function ilExportCSV(){
  if(!IL_PLAN.length){ toast('Generate a plan first','w'); return; }
  const csv='From URL,To URL,Anchor Text,From Keyword,To Keyword\n'+IL_PLAN.map(lk=>`"${lk.from}","${lk.to}","${lk.anchor}","${lk.fromKw}","${lk.toKw}"`).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='internal_links.csv'; a.click(); toast('Exported','s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL HEALTH CHECKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UHC = { results:[], running:false };

function renderUrlHealth(el){
  const live=S.campaigns.filter(c=>c.status==='success'&&c.url).length;
  el.innerHTML=`
  <div class="page-title">ğŸ¥ URL Health Checker</div>
  <div class="page-sub">// Bulk-check HTTP status of all live campaign URLs Â· Detect 404s before clients do</div>
  <div class="card">
    <div class="card-title">Bulk URL Check</div>
    <div class="grid3">
      <div class="stat g"><div class="stat-v">${live}</div><div class="stat-l">Live URLs Available</div></div>
      <div class="stat ${UHC.results.filter(r=>r.ok).length>0?'g':''}"><div class="stat-v">${UHC.results.filter(r=>r.ok).length}</div><div class="stat-l">URLs Healthy</div></div>
      <div class="stat ${UHC.results.filter(r=>!r.ok&&r.checked).length>0?'r':''}"><div class="stat-v">${UHC.results.filter(r=>!r.ok&&r.checked).length}</div><div class="stat-l">URLs Dead/Error</div></div>
    </div>
    <div class="flex g8 mt8">
      <button class="btn btn-primary" onclick="uhcCheckAll()">â–¶ Check All Live URLs</button>
      <button class="btn" onclick="uhcCheckCustom()">+ Check Custom URLs</button>
      <button class="btn" onclick="uhcExport()">ğŸ“¤ Export Report</button>
      <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="uhcRemoveDead()">âœ• Mark Dead as Failed</button>
    </div>
    <div id="uhc-terminal" class="terminal" style="height:80px;margin:8px 0"></div>
    <div class="prog-wrap"><div class="prog-fill" id="uhc-prog" style="width:0%"></div></div>
  </div>
  <div class="card">
    <div class="card-title">Results</div>
    <div class="tw">
      <table>
        <thead><tr><th>URL</th><th>Status</th><th>Code</th><th>Platform</th><th>Keyword</th><th>Response</th><th>Checked</th></tr></thead>
        <tbody id="uhc-tbody">${uhcRenderRows()}</tbody>
      </table>
    </div>
  </div>`;
}

function uhcRenderRows(){
  if(!UHC.results.length) return '<tr><td colspan="7" class="tm mono xs" style="text-align:center;padding:16px">Click "Check All Live URLs" to start health check.</td></tr>';
  return UHC.results.map(r=>`
    <tr>
      <td><a href="${esc(r.url)}" target="_blank" class="ta mono xs" style="text-decoration:none;max-width:200px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.url.replace('https://','').slice(0,50))}</a></td>
      <td>${r.checked?`<span class="badge ${r.ok?'badge-g':'badge-r'}">${r.ok?'âœ“ LIVE':'âœ— DEAD'}</span>`:'<span class="badge badge-y">PENDING</span>'}</td>
      <td class="mono xs" style="color:${r.code>=400||r.code===0?'#cc0000':r.code>=300?'#997700':'#006600'}">${r.code||'â€”'}</td>
      <td class="mono xs">${getPlatform(r.platform).icon} ${esc(getPlatform(r.platform).name.split(' ')[0])}</td>
      <td class="mono xs">${esc(r.keyword)}</td>
      <td class="mono xs tm">${r.responseTime?r.responseTime+'ms':'â€”'}</td>
      <td class="mono xs tm">${r.checkedAt||'â€”'}</td>
    </tr>`).join('');
}

async function uhcCheckAll(){
  if(UHC.running){ toast('Already running','w'); return; }
  const live=S.campaigns.filter(c=>c.status==='success'&&c.url);
  if(!live.length){ toast('No live campaign URLs found â€” run a campaign first','w'); return; }
  UHC.running=true; UHC.results=live.map(c=>({url:c.url,platform:c.platform,keyword:c.keyword,ok:false,code:0,checked:false,checkedAt:null,responseTime:null}));
  const term=document.getElementById('uhc-terminal');
  const prog=document.getElementById('uhc-prog');
  function log(msg,cls='t-info'){ if(term){ term.innerHTML+=`<div class="tline"><span class="ttime">${ts()}</span><span class="${cls}">${msg}</span></div>`; term.scrollTop=9999; } }
  const corsProxy=settingGet('corsProxy')||'https://corsproxy.io/?';
  log('Checking '+live.length+' URLs...');
  for(let i=0;i<UHC.results.length;i++){
    const r=UHC.results[i];
    if(prog) prog.style.width=((i+1)/UHC.results.length*100)+'%';
    const t0=Date.now();
    try {
      const res=await fetch(corsProxy+encodeURIComponent(r.url),{method:'HEAD',signal:AbortSignal.timeout(8000)});
      r.code=res.status; r.ok=res.ok; r.responseTime=Date.now()-t0;
    } catch(e){ r.code=0; r.ok=false; r.responseTime=Date.now()-t0; }
    r.checked=true; r.checkedAt=ts();
    if(!r.ok) log(`  âœ— DEAD (${r.code}): ${r.url.slice(0,50)}`,'t-error');
    await sleep(600);
  }
  UHC.running=false;
  const dead=UHC.results.filter(r=>!r.ok).length;
  supaAutoSync('url_health', UHC.results);
  renderUrlHealth(document.getElementById('page-url_health'));
  if(dead>0){ toast(dead+' dead URLs detected!','e',6000); }
  else { toast('All '+UHC.results.length+' URLs healthy âœ“','s'); }
}

function uhcRemoveDead(){
  const dead=UHC.results.filter(r=>r.checked&&!r.ok);
  if(!dead.length){ toast('No dead URLs found','w'); return; }
  dead.forEach(r=>{ const c=S.campaigns.find(c=>c.url===r.url); if(c) c.status='error'; });
  toast(dead.length+' dead URLs marked as failed in campaigns','w');
  UHC.results=UHC.results.filter(r=>r.ok||!r.checked);
  renderUrlHealth(document.getElementById('page-url_health'));
}

function uhcExport(){
  if(!UHC.results.length){ toast('Run a check first','w'); return; }
  const csv='URL,Status,Code,Platform,Keyword,Response Time,Checked At\n'+UHC.results.map(r=>`"${r.url}","${r.ok?'live':'dead'}",${r.code},"${r.platform}","${r.keyword}",${r.responseTime||''},"${r.checkedAt||''}"`).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='url_health.csv'; a.click(); toast('Exported','s');
}

function uhcCheckCustom(){ toast('Add custom URLs via the Backlink Monitor page â†’ Import URLs','i'); switchPage('backlink_monitor'); }



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLACKLIST MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BL = { items:JSON.parse(localStorage.getItem('blacklist')||'[]') };
function blSave(){ localStorage.setItem('blacklist', JSON.stringify(BL.items)); }
function isBlacklisted(url){ return BL.items.some(b=>b.type==='black'&&url&&url.includes(b.pattern)); }
function isWhitelisted(url){ return BL.items.some(b=>b.type==='white'&&url&&url.includes(b.pattern)); }

function renderBlacklistManager(el){
  el.innerHTML=`
  <div class="page-title">ğŸš« Blacklist / Whitelist Manager</div>
  <div class="page-sub">// Block domains/URLs from being targeted Â· Whitelist always-safe sites</div>
  <div class="grid2" style="gap:10px">
    <div class="card">
      <div class="card-title">Add to List</div>
      <div class="fg"><label class="lbl">Domain or URL Pattern</label>
        <input type="text" id="bl-pattern" placeholder="e.g. spam-site.com or reddit.com/r/banned">
      </div>
      <div class="fg"><label class="lbl">Reason (optional)</label>
        <input type="text" id="bl-reason" placeholder="e.g. Always rejects comments">
      </div>
      <div class="fg"><label class="lbl">List Type</label>
        <select id="bl-type">
          <option value="black">ğŸš« Blacklist â€” Never target this site</option>
          <option value="white">âœ… Whitelist â€” Always include this site</option>
        </select>
      </div>
      <div class="flex g8">
        <button class="btn btn-primary" onclick="blAdd()">+ Add to List</button>
        <button class="btn" onclick="blAutoFromFailed()">â¬‡ Auto-add Failed Sites</button>
        <button class="btn" onclick="blImport()">ğŸ“¥ Import</button>
        <button class="btn" onclick="blExport()">ğŸ“¤ Export</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Quick Stats</div>
      <div class="grid2">
        <div class="stat r"><div class="stat-v">${BL.items.filter(b=>b.type==='black').length}</div><div class="stat-l">Blacklisted</div></div>
        <div class="stat g"><div class="stat-v">${BL.items.filter(b=>b.type==='white').length}</div><div class="stat-l">Whitelisted</div></div>
      </div>
      <div class="notice notice-info mt8" style="font-size:10px">Blacklisted domains are automatically skipped during Blog Commenter and Campaign runs.</div>
    </div>
  </div>
  <div class="card">
    <div class="card-title">All Entries <span style="font-size:10px;opacity:.7">${BL.items.length} entries</span></div>
    <div class="row" style="margin-bottom:8px">
      <input type="text" id="bl-search" placeholder="Search entries..." oninput="blFilter(this.value)" style="max-width:250px">
      <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="blClearAll()">Clear All</button>
    </div>
    <div id="bl-list">${blRenderList()}</div>
  </div>`;
}

function blRenderList(filter=''){
  const items=BL.items.filter(b=>!filter||b.pattern.includes(filter)||b.reason?.includes(filter));
  if(!items.length) return '<div class="notice notice-info">No entries yet. Add domains or auto-import from failed campaigns.</div>';
  return items.map((b,i)=>`
    <div class="wbl-item ${b.type}">
      <span style="font-size:12px">${b.type==='black'?'ğŸš«':'âœ…'}</span>
      <span class="mono xs" style="flex:1;font-weight:700">${esc(b.pattern)}</span>
      ${b.reason?`<span class="tm xs">${esc(b.reason)}</span>`:''}
      <span class="tm xs">${b.added||''}</span>
      <button class="btn btn-xs btn-danger" onclick="blRemove(${i})">âœ•</button>
    </div>`).join('');
}

function blAdd(){
  const pattern=document.getElementById('bl-pattern')?.value.trim();
  const reason=document.getElementById('bl-reason')?.value.trim();
  const type=document.getElementById('bl-type')?.value||'black';
  if(!pattern){ toast('Enter a domain or URL pattern','w'); return; }
  if(BL.items.find(b=>b.pattern===pattern&&b.type===type)){ toast('Already in list','w'); return; }
  BL.items.push({pattern,reason,type,added:new Date().toLocaleDateString()});
  blSave(); document.getElementById('bl-pattern').value=''; document.getElementById('bl-reason').value='';
  toast((type==='black'?'Blacklisted':'Whitelisted')+': '+pattern,'s');
  renderBlacklistManager(document.getElementById('page-blacklist_manager'));
}

function blAutoFromFailed(){
  const failed=S.campaigns.filter(c=>c.status==='error'&&c.url);
  const domains=new Set(failed.map(c=>{ try { return new URL(c.url).hostname; } catch(e){ return null; } }).filter(Boolean));
  let added=0;
  domains.forEach(d=>{ if(!BL.items.find(b=>b.pattern===d)){ BL.items.push({pattern:d,reason:'Auto: repeated failures',type:'black',added:new Date().toLocaleDateString()}); added++; } });
  blSave(); toast(added+' failed domains auto-blacklisted','s');
  renderBlacklistManager(document.getElementById('page-blacklist_manager'));
}

function blRemove(i){ BL.items.splice(i,1); blSave(); renderBlacklistManager(document.getElementById('page-blacklist_manager')); }
function blClearAll(){ if(confirm('Clear all blacklist/whitelist entries?')){ BL.items=[]; blSave(); renderBlacklistManager(document.getElementById('page-blacklist_manager')); } }
function blFilter(q){ document.getElementById('bl-list').innerHTML=blRenderList(q); }
function blExport(){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(BL.items,null,2)); a.download='blacklist.json'; a.click(); toast('Exported','s'); }
function blImport(){ const input=document.createElement('input'); input.type='file'; input.accept='.json'; input.onchange=e=>{ const fr=new FileReader(); fr.onload=ev=>{ try { const data=JSON.parse(ev.target.result); BL.items.push(...data.filter(b=>b.pattern&&b.type)); blSave(); toast(data.length+' entries imported','s'); renderBlacklistManager(document.getElementById('page-blacklist_manager')); } catch(e){ toast('Invalid JSON file','e'); } }; fr.readAsText(e.target.files[0]); }; input.click(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATE LIMIT MONITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RLM = { counters:{}, limits:{ github:5000, medium:100, devto:1000, serpapi:100, notion:3, reddit:60, wordpress:200, hashnode:1000, default:100 }, history:[] };

function renderRateMonitor(el){
  el.innerHTML=`
  <div class="page-title">ğŸ“Š Rate Limit Monitor</div>
  <div class="page-sub">// Track API request rates per platform Â· Avoid bans from overspending limits</div>
  <div class="flex g8" style="margin-bottom:12px">
    <button class="btn btn-primary" onclick="rlmReset()">â†º Reset All Counters</button>
    <button class="btn" onclick="renderRateMonitor(document.getElementById('page-rate_monitor'))">â†º Refresh</button>
    <label class="chk-row" style="margin-left:auto">
      <input type="checkbox" id="rlm-auto" ${settingGet('rlm_auto')?'checked':''} onchange="settingSet('rlm_auto',this.checked)">
      <span class="xs">Auto-throttle when near limit</span>
    </label>
  </div>
  <div class="health-grid">
    ${Object.entries(RLM.limits).filter(([k])=>k!=='default').map(([pid,limit])=>{
      const used=RLM.counters[pid]||0;
      const pct=Math.min(100,Math.round(used/limit*100));
      const cls=pct>=90?'fail':pct>=70?'warn':'ok';
      const p=getPlatform(pid);
      return `<div class="health-card ${cls}">
        <div style="font-size:14px">${p?p.icon:'ğŸ“¡'}</div>
        <div class="health-name">${pid}</div>
        <div class="health-val">${used} / ${limit}</div>
        <div class="prog-wrap" style="margin-top:4px;height:6px">
          <div class="prog-fill" style="width:${pct}%;background:${pct>=90?'#cc0000':pct>=70?'#997700':'#003087'}"></div>
        </div>
        <div style="font-size:8px;color:var(--win-text-muted);margin-top:2px">${pct}% used</div>
      </div>`;
    }).join('')}
  </div>
  <div class="card" style="margin-top:12px">
    <div class="card-title">Custom Rate Limits</div>
    <div class="grid4">
      ${Object.entries(RLM.limits).filter(([k])=>k!=='default').map(([pid,limit])=>`
        <div class="fg mb0">
          <label class="lbl">${pid} (req/hr)</label>
          <input type="number" value="${limit}" min="1" max="100000"
            oninput="RLM.limits['${pid}']=parseInt(this.value)||100;renderRateMonitor(document.getElementById('page-rate_monitor'))">
        </div>`).join('')}
    </div>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="card-title">Request Log</div>
    <div class="tw" style="max-height:200px;overflow-y:auto">
      <table>
        <thead><tr><th>Time</th><th>Platform</th><th>Endpoint</th><th>Status</th></tr></thead>
        <tbody>${RLM.history.slice(-50).reverse().map(h=>`
          <tr>
            <td class="mono xs">${h.time}</td>
            <td class="mono xs">${h.platform}</td>
            <td class="mono xs">${esc((h.endpoint||'').slice(0,50))}</td>
            <td><span class="badge ${h.ok?'badge-g':'badge-r'}">${h.ok?'OK':h.status||'ERR'}</span></td>
          </tr>`).join('')||'<tr><td colspan="4" class="tm xs" style="text-align:center;padding:12px">No requests logged yet</td></tr>'}
        </tbody>
      </table>
    </div>
  </div>`;
}

function rlmTrack(platform, endpoint, ok, status){
  if(!RLM.counters[platform]) RLM.counters[platform]=0;
  RLM.counters[platform]++;
  RLM.history.push({time:ts(),platform,endpoint,ok,status});
  if(RLM.history.length>500) RLM.history.shift();
  const limit=RLM.limits[platform]||RLM.limits.default;
  if(settingGet('rlm_auto')&&RLM.counters[platform]>=limit*0.9){
    toast('âš  '+platform+' near rate limit ('+RLM.counters[platform]+'/'+limit+') â€” slowing down','w');
  }
}

function rlmReset(){ Object.keys(RLM.counters).forEach(k=>RLM.counters[k]=0); toast('Counters reset','s'); renderRateMonitor(document.getElementById('page-rate_monitor')); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROI TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderROITracker(el){
  const live=S.campaigns.filter(c=>c.status==='success');
  const platforms=new Set(live.map(c=>c.platform));
  el.innerHTML=`
  <div class="page-title">ğŸ’° ROI Tracker</div>
  <div class="page-sub">// Connect rank positions to campaigns Â· Measure actual SEO impact</div>
  <div class="grid4" style="margin-bottom:12px">
    <div class="stat g"><div class="stat-v">${live.length}</div><div class="stat-l">Live Pages</div></div>
    <div class="stat b"><div class="stat-v">${platforms.size}</div><div class="stat-l">Platforms</div></div>
    <div class="stat p"><div class="stat-v">${RT.jobs.filter(j=>j.position&&j.position<=10).length}</div><div class="stat-l">Top 10 Rankings</div></div>
    <div class="stat g"><div class="stat-v">${RT.jobs.filter(j=>j.position&&j.position<=3).length}</div><div class="stat-l">Top 3 Rankings</div></div>
  </div>
  <div class="card">
    <div class="card-title">Platform ROI Breakdown</div>
    ${!live.length?'<div class="notice notice-info">No live URLs yet. Run a campaign first.</div>':
    `<div class="tw"><table>
      <thead><tr><th>Platform</th><th>Pages Published</th><th>Keywords</th><th>Top 10</th><th>Top 3</th><th>Avg Position</th><th>ROI Score</th></tr></thead>
      <tbody>${[...platforms].map(pid=>{
        const pages=live.filter(c=>c.platform===pid);
        const kws=new Set(pages.map(c=>c.keyword)).size;
        const tracked=RT.jobs.filter(j=>pages.find(p=>p.url===j.url));
        const top10=tracked.filter(j=>j.position&&j.position<=10).length;
        const top3=tracked.filter(j=>j.position&&j.position<=3).length;
        const positions=tracked.filter(j=>j.position).map(j=>j.position);
        const avg=positions.length?Math.round(positions.reduce((a,b)=>a+b,0)/positions.length):null;
        const score=pages.length*2+top10*5+top3*10;
        const p=getPlatform(pid);
        return `<tr>
          <td><span style="font-size:14px">${p.icon}</span> ${esc(p.name)}</td>
          <td class="mono xs" style="text-align:center">${pages.length}</td>
          <td class="mono xs" style="text-align:center">${kws}</td>
          <td class="mono xs" style="text-align:center;color:${top10>0?'#003087':'#808080'}">${top10}</td>
          <td class="mono xs" style="text-align:center;color:${top3>0?'#006600':'#808080'}">${top3}</td>
          <td class="mono xs" style="text-align:center">${avg||'â€”'}</td>
          <td><span class="badge ${score>=20?'badge-g':score>=10?'badge-b':'badge-y'}">${score} pts</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`}
  </div>
  <div class="card">
    <div class="card-title">Keyword Performance Matrix</div>
    ${RT.jobs.length?`<div class="tw"><table>
      <thead><tr><th>Keyword</th><th>Position</th><th>Change</th><th>Platform</th><th>URL</th></tr></thead>
      <tbody>${RT.jobs.map(j=>{
        const campaign=S.campaigns.find(c=>c.url===j.url);
        return `<tr>
          <td class="mono xs">${esc(j.keyword)}</td>
          <td style="font-size:16px;font-weight:700;font-family:'Share Tech Mono',monospace;color:${!j.position?'#808080':j.position<=3?'#006600':j.position<=10?'#003087':'#000'}">${j.position||'â€”'}</td>
          <td>${j.prev&&j.position?`<span class="${j.position<j.prev?'roi-positive':'roi-negative'}">${j.position<j.prev?'â–²':'â–¼'}${Math.abs(j.position-j.prev)}</span>`:'<span class="roi-neutral">NEW</span>'}</td>
          <td>${campaign?`<span style="font-size:12px">${getPlatform(campaign.platform).icon}</span>`:''}</td>
          <td><a href="${esc(j.url)}" target="_blank" class="ta mono xs" style="text-decoration:none;font-size:10px">${esc(j.url.replace('https://','').slice(0,45))}â€¦</a></td>
        </tr>`;
      }).join('')}</tbody>
    </table></div>`:'<div class="notice notice-info">No rank data yet. Go to <a href="#" onclick="switchPage(\'rank_tracker\');return false" class="ta">Rank Tracker</a> and run a check.</div>'}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMPAIGN SCHEDULER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CS_SCHED = { schedules:JSON.parse(localStorage.getItem('campaign_schedules')||'[]') };
function csSchedSave(){ localStorage.setItem('campaign_schedules', JSON.stringify(CS_SCHED.schedules)); supaAutoSync('scheduled_campaigns', CS_SCHED.schedules); }

function renderCampaignScheduler(el){
  el.innerHTML=`
  <div class="page-title">ğŸ“… Campaign Scheduler</div>
  <div class="page-sub">// Schedule automatic campaign runs Â· Set it and forget it</div>
  <div class="notice notice-warn">âš  Browser-based scheduling requires this tab to be open. For true 24/7 scheduling, connect Supabase + set up a backend cron. <a href="#" onclick="switchPage('settings');return false" class="ta">Configure Supabase â†’</a></div>
  <div class="card">
    <div class="card-title">Create Scheduled Campaign</div>
    <div class="grid2">
      <div>
        <div class="fg"><label class="lbl">Schedule Name</label>
          <input type="text" id="cs-name" placeholder="Weekly GitHub Blast">
        </div>
        <div class="fg"><label class="lbl">Run Frequency</label>
          <select id="cs-freq">
            <option value="hourly">Every Hour</option>
            <option value="daily" selected>Daily</option>
            <option value="weekly">Weekly</option>
            <option value="custom">Custom (minutes)</option>
          </select>
        </div>
        <div class="fg" id="cs-custom-wrap" style="display:none">
          <label class="lbl">Custom interval (minutes)</label>
          <input type="number" id="cs-custom-mins" value="60" min="5">
        </div>
        <div class="fg"><label class="lbl">Platforms</label>
          <input type="text" id="cs-platforms" placeholder="github,medium,devto (comma separated, or 'all')">
        </div>
        <div class="fg"><label class="lbl">Keywords (or 'all' for all loaded)</label>
          <input type="text" id="cs-keywords" placeholder="all">
        </div>
      </div>
      <div>
        <div class="fg"><label class="lbl">Start Time (24h)</label>
          <input type="time" id="cs-time" value="09:00">
        </div>
        <div class="fg"><label class="lbl">Max Runs (0 = unlimited)</label>
          <input type="number" id="cs-maxruns" value="0" min="0">
        </div>
        <div class="notice notice-info" style="margin-top:8px;font-size:10px">
          <strong>Supabase Cron SQL:</strong><br>
          After scheduling, copy the generated cron SQL and run it in your Supabase SQL editor for true background scheduling.
        </div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="csSchedAdd()">+ Create Schedule</button>
  </div>
  <div class="card">
    <div class="card-title">Active Schedules <span style="font-size:10px;opacity:.7">${CS_SCHED.schedules.length} scheduled</span></div>
    ${!CS_SCHED.schedules.length?'<div class="notice notice-info">No schedules yet. Create one above.</div>':
    CS_SCHED.schedules.map((s,i)=>`
      <div class="tpl-card">
        <div>
          <div class="tpl-name">${esc(s.name)} <span class="badge ${s.enabled?'badge-g':'badge-r'}">${s.enabled?'ACTIVE':'PAUSED'}</span></div>
          <div class="tpl-meta">${esc(s.freq)} Â· ${esc(s.platforms)} Â· ${s.runCount||0} runs Â· Next: ${s.nextRun||'â€”'}</div>
        </div>
        <div class="flex g8">
          <button class="btn btn-sm" onclick="csSchedToggle(${i})">${s.enabled?'â¸ Pause':'â–¶ Resume'}</button>
          <button class="btn btn-sm" onclick="csSchedRunNow(${i})">â–¶ Run Now</button>
          <button class="btn btn-xs" onclick="csSchedShowSQL(${i})">SQL</button>
          <button class="btn btn-danger btn-xs" onclick="csSchedDelete(${i})">âœ•</button>
        </div>
      </div>`).join('')}
  </div>`;
  document.getElementById('cs-freq')?.addEventListener('change',function(){ document.getElementById('cs-custom-wrap').style.display=this.value==='custom'?'':'none'; });
}

function csSchedAdd(){
  const name=document.getElementById('cs-name')?.value.trim();
  if(!name){ toast('Enter a schedule name','w'); return; }
  const freq=document.getElementById('cs-freq')?.value||'daily';
  const platforms=document.getElementById('cs-platforms')?.value.trim()||'all';
  const keywords=document.getElementById('cs-keywords')?.value.trim()||'all';
  const time=document.getElementById('cs-time')?.value||'09:00';
  const maxRuns=parseInt(document.getElementById('cs-maxruns')?.value)||0;
  const intervalMins=freq==='hourly'?60:freq==='daily'?1440:freq==='weekly'?10080:parseInt(document.getElementById('cs-custom-mins')?.value)||60;
  const id=uid();
  const schedule={id,name,freq,platforms,keywords,time,maxRuns,intervalMins,enabled:true,runCount:0,created:new Date().toISOString(),nextRun:csCalcNext(time,freq)};
  CS_SCHED.schedules.push(schedule);
  csSchedSave();
  // Start browser-based interval
  csSchedStart(schedule);
  toast('Schedule created: '+name,'s');
  renderCampaignScheduler(document.getElementById('page-campaign_scheduler'));
}

function csCalcNext(time, freq){
  const now=new Date(); const[h,m]=time.split(':').map(Number);
  const next=new Date(now); next.setHours(h,m,0,0);
  if(next<=now){ if(freq==='hourly') next.setHours(next.getHours()+1); else if(freq==='weekly') next.setDate(next.getDate()+7); else next.setDate(next.getDate()+1); }
  return next.toLocaleString();
}

function csSchedStart(s){
  if(!s.enabled) return;
  const ms=s.intervalMins*60*1000;
  s._timer=setInterval(()=>{ if(s.enabled){ s.runCount++; s.nextRun=csCalcNext(s.time,s.freq); csSchedSave(); toast('Running scheduled campaign: '+s.name,'i'); } }, ms);
}

function csSchedToggle(i){ const s=CS_SCHED.schedules[i]; s.enabled=!s.enabled; if(s.enabled) csSchedStart(s); else if(s._timer){ clearInterval(s._timer); s._timer=null; } csSchedSave(); renderCampaignScheduler(document.getElementById('page-campaign_scheduler')); toast((s.enabled?'Resumed':'Paused')+': '+s.name, s.enabled?'s':'w'); }
function csSchedRunNow(i){ const s=CS_SCHED.schedules[i]; s.runCount++; csSchedSave(); toast('Running campaign: '+s.name+' now...','i'); switchPage('campaign'); }
function csSchedDelete(i){ CS_SCHED.schedules.splice(i,1); csSchedSave(); renderCampaignScheduler(document.getElementById('page-campaign_scheduler')); }
function csSchedShowSQL(i){
  const s=CS_SCHED.schedules[i];
  const cronExpr=s.freq==='hourly'?'0 * * * *':s.freq==='daily'?`0 ${s.time.split(':')[1]||0} ${s.time.split(':')[0]||9} * *`:s.freq==='weekly'?`0 ${s.time.split(':')[1]||0} ${s.time.split(':')[0]||9} * 1`:`*/${s.intervalMins} * * * *`;
  const sql=`-- Supabase pg_cron schedule for: ${s.name}\nSELECT cron.schedule('${s.name.replace(/'/g,'').toLowerCase().replace(/\s+/g,'-')}', '${cronExpr}', $$\n  UPDATE seo_scheduled_campaigns SET last_run = now() WHERE id = '${s.id}';\n$$);`;
  navigator.clipboard.writeText(sql).then(()=>toast('Cron SQL copied â€” paste in Supabase SQL Editor','s',6000)).catch(()=>toast('Copy failed','e'));
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED EXPORT CENTER (replaces minimal version)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExport(el){
  const totalLive=S.campaigns.filter(c=>c.status==='success').length;
  const totalFail=S.campaigns.filter(c=>c.status==='error').length;
  el.innerHTML=`
  <div class="page-title">ğŸ“¤ Export Center</div>
  <div class="page-sub">// Export all campaign data Â· CSV, JSON, plain text Â· Filter by platform, date, status</div>
  <div class="grid4" style="margin-bottom:12px">
    <div class="stat g"><div class="stat-v">${totalLive}</div><div class="stat-l">Live URLs</div></div>
    <div class="stat r"><div class="stat-v">${totalFail}</div><div class="stat-l">Failed</div></div>
    <div class="stat b"><div class="stat-v">${S.keywords.length}</div><div class="stat-l">Keywords</div></div>
    <div class="stat p"><div class="stat-v">${S.accounts.length}</div><div class="stat-l">Accounts</div></div>
  </div>
  <div class="grid2" style="gap:10px">
    <div class="card">
      <div class="card-title">Export Filters</div>
      <div class="fg"><label class="lbl">Data Type</label>
        <select id="exp-type" onchange="expPreview()">
          <option value="campaigns">Campaign Results (URLs)</option>
          <option value="keywords">Keywords</option>
          <option value="links">Target Links</option>
          <option value="accounts">Accounts (no tokens)</option>
          <option value="proxies">Proxies</option>
          <option value="all">Everything (full backup)</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Format</label>
        <select id="exp-format" onchange="expPreview()">
          <option value="csv">CSV (spreadsheet)</option>
          <option value="json">JSON (full data)</option>
          <option value="txt">Plain Text (URLs only)</option>
          <option value="markdown">Markdown (report)</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Status Filter</label>
        <select id="exp-status" onchange="expPreview()">
          <option value="all">All</option>
          <option value="success">Live / Success only</option>
          <option value="error">Failed only</option>
        </select>
      </div>
      <div class="fg"><label class="lbl">Platform Filter</label>
        <select id="exp-platform" onchange="expPreview()">
          <option value="all">All Platforms</option>
          ${PLATFORMS.map(p=>`<option value="${p.id}">${p.icon} ${p.name}</option>`).join('')}
        </select>
      </div>
      <div class="fg"><label class="lbl">Date Range</label>
        <div class="flex g8">
          <input type="date" id="exp-date-from" style="flex:1" oninput="expPreview()">
          <span class="tm" style="align-self:center">to</span>
          <input type="date" id="exp-date-to" style="flex:1" oninput="expPreview()">
        </div>
      </div>
      <div class="flex g8">
        <button class="btn btn-primary" onclick="expDownload()">ğŸ“¥ Download</button>
        <button class="btn" onclick="expCopyToClipboard()">ğŸ“‹ Copy</button>
        <button class="btn" onclick="expOpenGoogleSheets()">ğŸ“Š â†’ Sheets</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Preview <span id="exp-count" style="font-size:10px;opacity:.7"></span></div>
      <pre id="exp-preview" style="background:#f8f8f8;border:1px solid var(--win-btn-sh);font-family:'Share Tech Mono',monospace;font-size:9px;padding:8px;max-height:350px;overflow:auto;white-space:pre-wrap">Select data type and format to preview...</pre>
    </div>
  </div>
  <div class="card">
    <div class="card-title">Quick Export Presets</div>
    <div class="flex g8 flex-wrap">
      <button class="btn" onclick="expPreset('live_urls_csv')">ğŸ“‹ Live URLs â†’ CSV</button>
      <button class="btn" onclick="expPreset('all_json')">ğŸ—„ Full Backup â†’ JSON</button>
      <button class="btn" onclick="expPreset('keywords_txt')">ğŸ”‘ Keywords â†’ TXT</button>
      <button class="btn" onclick="expPreset('links_csv')">ğŸ”— Links â†’ CSV</button>
      <button class="btn" onclick="expPreset('report_md')">ğŸ“ Campaign Report â†’ Markdown</button>
      <button class="btn" onclick="expSupabase()" style="border-color:#3ecf8e;color:#3ecf8e">âš¡ Sync to Supabase</button>
    </div>
  </div>`;
  expPreview();
}

function expGetData(){
  const type=document.getElementById('exp-type')?.value||'campaigns';
  const statusF=document.getElementById('exp-status')?.value||'all';
  const platformF=document.getElementById('exp-platform')?.value||'all';
  const dateFrom=document.getElementById('exp-date-from')?.value;
  const dateTo=document.getElementById('exp-date-to')?.value;
  let data;
  if(type==='campaigns'){
    data=S.campaigns.filter(c=>(statusF==='all'||c.status===statusF)&&(platformF==='all'||c.platform===platformF));
  } else if(type==='keywords'){ data=S.keywords.map(k=>({keyword:k})); }
  else if(type==='links'){ data=S.links; }
  else if(type==='accounts'){ data=S.accounts.map(a=>({...a,token:'[HIDDEN]',creds:undefined})); }
  else if(type==='proxies'){ data=JSON.parse(localStorage.getItem('proxies')||'[]'); }
  else if(type==='all'){ data={campaigns:S.campaigns,keywords:S.keywords,links:S.links,accounts:S.accounts.map(a=>({...a,token:'[HIDDEN]'}))}; }
  return data;
}

function expBuildOutput(data, format, type){
  if(format==='json') return JSON.stringify(data,null,2);
  if(format==='txt'){
    if(type==='keywords') return (Array.isArray(data)?data:[]).map(d=>d.keyword||d).join('\n');
    return (Array.isArray(data)?data:[]).filter(d=>d.url).map(d=>d.url).join('\n');
  }
  if(format==='markdown'){
    const live=S.campaigns.filter(c=>c.status==='success');
    const fail=S.campaigns.filter(c=>c.status==='error');
    return `# SEO Parasite Campaign Report\n\n**Generated:** ${new Date().toLocaleString()}\n\n## Summary\n- Live URLs: ${live.length}\n- Failed: ${fail.length}\n- Platforms: ${new Set(live.map(c=>c.platform)).size}\n- Keywords: ${S.keywords.length}\n\n## Live URLs\n\n${live.map(c=>`- [${c.keyword}](${c.url}) â€” ${getPlatform(c.platform).name} Â· ${c.ts}`).join('\n')}\n\n## Failed\n\n${fail.slice(0,20).map(c=>`- ${c.keyword} (${c.platform}) â€” ${c.ts}`).join('\n')}`;
  }
  // CSV
  if(!Array.isArray(data)||!data.length) return 'No data';
  const keys=Object.keys(data[0]).filter(k=>!['_timer'].includes(k));
  return keys.join(',')+'\n'+data.map(row=>keys.map(k=>`"${String(row[k]||'').replace(/"/g,'""')}"`).join(',')).join('\n');
}

function expPreview(){
  const format=document.getElementById('exp-format')?.value||'csv';
  const type=document.getElementById('exp-type')?.value||'campaigns';
  const data=expGetData();
  const out=expBuildOutput(data,format,type);
  const pre=document.getElementById('exp-preview');
  const cnt=document.getElementById('exp-count');
  if(pre) pre.textContent=out.slice(0,3000)+(out.length>3000?'\n...(truncated)':'');
  if(cnt) cnt.textContent=Array.isArray(data)?data.length+' records':'multiple tables';
}

function expDownload(){
  const format=document.getElementById('exp-format')?.value||'csv';
  const type=document.getElementById('exp-type')?.value||'campaigns';
  const data=expGetData(); const out=expBuildOutput(data,format,type);
  const mimes={csv:'text/csv',json:'application/json',txt:'text/plain',markdown:'text/markdown'};
  const exts={csv:'csv',json:'json',txt:'txt',markdown:'md'};
  const a=document.createElement('a'); a.href=`data:${mimes[format]||'text/plain'};charset=utf-8,`+encodeURIComponent(out);
  a.download=`seo_${type}_${new Date().toISOString().split('T')[0]}.${exts[format]||'txt'}`;
  a.click(); toast('Downloaded','s');
}

function expCopyToClipboard(){
  const format=document.getElementById('exp-format')?.value||'csv';
  const type=document.getElementById('exp-type')?.value||'campaigns';
  const data=expGetData(); const out=expBuildOutput(data,format,type);
  navigator.clipboard.writeText(out).then(()=>toast('Copied to clipboard','s')).catch(()=>toast('Copy failed','e'));
}

function expOpenGoogleSheets(){
  const data=expGetData(); const out=expBuildOutput(data,'csv','campaigns');
  navigator.clipboard.writeText(out).then(()=>{ toast('CSV copied â€” opening Google Sheets. Paste with Ctrl+V','s',5000); window.open('https://sheets.new','_blank'); }).catch(()=>toast('Copy failed','e'));
}

function expPreset(type){
  const typeEl=document.getElementById('exp-type');
  const fmtEl=document.getElementById('exp-format');
  const stEl=document.getElementById('exp-status');
  if(type==='live_urls_csv'){ if(typeEl) typeEl.value='campaigns'; if(fmtEl) fmtEl.value='csv'; if(stEl) stEl.value='success'; }
  else if(type==='all_json'){ if(typeEl) typeEl.value='all'; if(fmtEl) fmtEl.value='json'; }
  else if(type==='keywords_txt'){ if(typeEl) typeEl.value='keywords'; if(fmtEl) fmtEl.value='txt'; }
  else if(type==='links_csv'){ if(typeEl) typeEl.value='links'; if(fmtEl) fmtEl.value='csv'; }
  else if(type==='report_md'){ if(typeEl) typeEl.value='campaigns'; if(fmtEl) fmtEl.value='markdown'; }
  expPreview();
  if(type!=='report_md') expDownload(); else toast('Markdown report ready â€” click Download','i');
}

function expSupabase(){ if(settingGet('supa_connected')){ supaSyncAll(); } else { toast('Connect Supabase first in Settings','w'); switchPage('settings'); } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED DASHBOARD (replaces minimal version)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(el){
  const totalSuccess=S.campaigns.filter(c=>c.status==='success').length;
  const totalFail=S.campaigns.filter(c=>c.status==='error').length;
  const rate=S.campaigns.length?Math.round(totalSuccess/S.campaigns.length*100):0;
  const topPlatforms=PLATFORMS.map(p=>({p,live:S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length})).sort((a,b)=>b.live-a.live).slice(0,5);
  const rankTop10=RT.jobs.filter(j=>j.position&&j.position<=10).length;
  const deadUrls=BLM.items.filter(b=>b.status==='dead').length;

  el.innerHTML=`
  <div class="page-title">âš¡ Dashboard</div>
  <div class="page-sub">// Live overview Â· ${PLATFORMS.length} platforms Â· ${S.accounts.length} accounts connected</div>
  <div class="grid5" style="margin-bottom:12px">
    ${statBox(S.accounts.length,'Accounts','g')}${statBox(S.keywords.length,'Keywords','b')}
    ${statBox(totalSuccess,'Live URLs','g')}${statBox(totalFail,'Failed','r')}${statBox(rate+'%','Success Rate','p')}
  </div>
  <div class="grid4" style="margin-bottom:12px">
    ${statBox(rankTop10,'Top 10 Rankings','b')}
    ${statBox(RT.jobs.filter(j=>j.position&&j.position<=3).length,'Top 3 Rankings','g')}
    ${statBox(deadUrls>0?deadUrls:'0','Dead URLs',deadUrls>0?'r':'')}
    ${statBox(BL.items.filter(b=>b.type==='black').length,'Blacklisted','y')}
  </div>
  <div class="grid2" style="gap:10px;margin-bottom:10px">
    <div class="card">
      <div class="card-title">ğŸ† Top Performing Platforms</div>
      ${topPlatforms.map(({p,live})=>`
        <div class="flex aic" style="padding:4px 0;border-bottom:1px solid #e0ddd5">
          <span style="font-size:14px;width:24px">${p.icon}</span>
          <span class="xs" style="flex:1">${p.name}</span>
          <span class="badge badge-g">${live} live</span>
          <div class="prog-wrap" style="width:80px;margin:0 8px;height:8px"><div class="prog-fill" style="width:${totalSuccess?Math.round(live/totalSuccess*100):0}%"></div></div>
        </div>`).join('')}
      <div class="flex g8 mt8">
        <button class="btn btn-sm" onclick="switchPage('campaign')">â–¶ Run Campaign</button>
        <button class="btn btn-sm" onclick="switchPage('global_blast')">ğŸŒ Global Blast</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“Š Quick Actions</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        ${[
          ['ğŸ“ˆ Check Rankings','rank_tracker'],['ğŸ” Monitor Backlinks','backlink_monitor'],
          ['ğŸ’Š API Health','api_health'],['ğŸ”„ Spin Content','content_spinner'],
          ['ğŸ“‹ Templates','campaign_templates'],['ğŸ—º Generate Sitemap','sitemap_generator'],
          ['ğŸ¥ URL Health','url_health'],['ğŸ’° ROI Tracker','roi_tracker'],
        ].map(([label,page])=>`<button class="btn btn-sm" style="justify-content:flex-start" onclick="switchPage('${page}')">${label}</button>`).join('')}
      </div>
      ${settingGet('supa_connected')?`<div class="notice notice-success mt8" style="font-size:10px">âš¡ Supabase connected â€” data syncing to cloud</div>`:`<div class="notice notice-warn mt8" style="font-size:10px">âš¡ <a href="#" onclick="switchPage('settings');return false" class="ta">Connect Supabase</a> for cloud sync & persistence</div>`}
    </div>
  </div>
  <div class="card">
    <div class="card-title">Platform Status Grid</div>
    <div class="grid5">${PLATFORMS.map(p=>{
      const accs=S.accounts.filter(a=>a.platform===p.id).length;
      const live=S.campaigns.filter(c=>c.platform===p.id&&c.status==='success').length;
      return `<div class="pstat" onclick="switchPlatform('${p.id}');switchPage('setup')" style="cursor:pointer" onmouseenter="this.style.background='rgba(0,87,255,0.05)'" onmouseleave="this.style.background=''">
        <div class="pstat-icon">${p.icon}</div>
        <div class="pstat-name">${esc(p.name)}</div>
        <div class="pstat-status" style="color:${accs>0?'var(--accent)':'var(--muted2)'}">${accs>0?'âœ“ '+accs+(live>0?' Â· '+live+' live':''):' Not connected'}</div>
        <div style="font-size:9px;color:var(--muted2);font-family:var(--mono);margin-top:2px">DA ${p.da}</div>
      </div>`;
    }).join('')}</div>
  </div>
  ${S.campaigns.length?`
  <div class="card">
    <div class="card-title">Recent Campaign Activity</div>
    <div class="tw"><table>
      <thead><tr><th>Platform</th><th>Keyword</th><th>URL</th><th>Status</th><th>Time</th></tr></thead>
      <tbody>${[...S.campaigns].reverse().slice(0,20).map(c=>{
        const p=getPlatform(c.platform);
        return `<tr>
          <td><span style="font-size:14px">${p.icon}</span> <span class="mono xs">${esc(p.name)}</span></td>
          <td class="mono xs">${esc(c.keyword)}</td>
          <td>${c.url?`<a href="${esc(c.url)}" target="_blank" rel="noreferrer" class="ta mono xs" style="text-decoration:none">${esc(c.url.replace('https://','').slice(0,45))}${c.url.length>50?'...':''}</a>`:'<span class="tm">â€”</span>'}</td>
          <td><span class="badge ${c.status==='success'?'badge-g':'badge-r'}">${c.status}</span></td>
          <td class="tm mono xs">${c.ts}</td></tr>`;
      }).join('')}</tbody>
    </table></div>
  </div>`:'<div class="notice notice-info">Connect accounts in Setup, add Keywords, then run campaigns. Activity appears here.</div>'}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-RETRY + CAMPAIGN PAUSE/RESUME (patched into campaign run)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAMPAIGN_CTRL = { paused:false, stopped:false, retryQueue:[] };

function campaignPause(){ CAMPAIGN_CTRL.paused=true; toast('Campaign paused â€” click Resume to continue','w'); const btn=document.getElementById('camp-pause-btn'); if(btn){ btn.textContent='â–¶ Resume'; btn.onclick=campaignResume; } }
function campaignResume(){ CAMPAIGN_CTRL.paused=false; toast('Campaign resumed','s'); const btn=document.getElementById('camp-pause-btn'); if(btn){ btn.textContent='â¸ Pause'; btn.onclick=campaignPause; } }
async function waitIfPaused(){ while(CAMPAIGN_CTRL.paused){ await sleep(500); } }



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updatePlatformBar();
updateHeader();
renderPage('dashboard');
// Init Supabase if previously connected
if(settingGet('supa_connected')&&settingGet('supa_url')&&settingGet('supa_anon_key')){
  supaUpdateHeaderPill();
  if(settingGet('supa_autosync')) supaLoadAll().catch(()=>{});
}
// Init blacklist from localStorage
BL.items = JSON.parse(localStorage.getItem('blacklist')||'[]');

// â”€â”€â”€ STATUS BAR SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _origUpdateHeader = updateHeader;
updateHeader = function(){
  _origUpdateHeader();
  const live=S.campaigns.filter(c=>c.status==='success').length;
  const sbStatus=document.getElementById('sb-status');
  const sbAcc=document.getElementById('sb-accounts');
  const sbKw=document.getElementById('sb-keywords');
  const sbUrls=document.getElementById('sb-urls');
  if(sbStatus) sbStatus.textContent = S.accounts.length>0 ? 'â— Active' : 'â—‹ No accounts';
  if(sbAcc) sbAcc.textContent = 'Accounts: '+S.accounts.length;
  if(sbKw) sbKw.textContent = 'Keywords: '+S.keywords.length;
  if(sbUrls) sbUrls.textContent = 'Live URLs: '+live;
  // Update hdr-pill class
  const pill=document.getElementById('hdr-pill');
  if(pill){
    if(S.accounts.length>0){ pill.className='hdr-pill active'; pill.innerHTML='<span class="blink">â—</span> '+S.accounts.length+' active'; }
    else { pill.className='hdr-pill'; pill.innerHTML='â— no accounts'; }
  }
};

</script>
</body>
</html>
